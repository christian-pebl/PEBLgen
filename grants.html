<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grants Budget Parser - PEBLGen</title>
    <!-- Google Fonts - PEBL Brand Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400&display=swap" rel="stylesheet">
    <!-- SheetJS library for Excel file support -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Navigation Banner - PEBL Brand Colors */
        .nav-banner { position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); padding: 15px 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 30px; margin-bottom: 0; z-index: 100; }
        .nav-banner h1 { color: white; font-size: 28px; font-weight: 700; margin: 0; font-family: 'Roboto', sans-serif; letter-spacing: 0.5px; }
        .nav-buttons { display: flex; gap: 15px; }
        .nav-btn { background-color: rgba(255, 255, 255, 0.2); color: white; border: 2px solid rgba(255, 255, 255, 0.3); padding: 10px 25px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500; text-decoration: none; transition: all 0.3s ease; display: inline-block; font-family: 'Roboto', sans-serif; }
        .nav-btn:hover { background-color: rgba(255, 255, 255, 0.3); border-color: rgba(255, 255, 255, 0.5); transform: translateY(-2px); }
        .nav-btn.active { background-color: white; color: #2B7A78; border-color: white; }

        body {
            font-family: 'Roboto', sans-serif;
            font-weight: 300;
            background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%);
            min-height: 100vh;
            padding: 0;
            padding-top: 90px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px 25px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px 15px;
            }
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        #detailedBudgetResults.show {
            display: block !important;
        }

        .card.compact {
            padding: 10px 20px;
            margin-bottom: 8px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
            user-select: none;
        }

        .card-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        h2 {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .subtitle {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 12px;
        }

        .badge {
            background: #e0e7ff;
            color: #4338ca;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
        }

        .chevron {
            transition: transform 0.3s;
        }

        .chevron.open {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.open {
            max-height: 600px;
        }

        .log-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 500px;
            overflow-y: auto;
            overflow-x: hidden;
            color: #475569;
        }

        .log-entry {
            margin-bottom: 4px;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .log-empty {
            color: #94a3b8;
            font-style: italic;
        }

        textarea {
            width: 100%;
            min-height: 100px;
            max-height: 400px;
            height: 130px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            resize: vertical;
            overflow-y: auto;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #3AAFA9;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3AAFA9;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-fullscreen {
            padding: 8px 12px;
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2em;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .btn-fullscreen:hover {
            background: #3AAFA9;
            color: white;
            border-color: #3AAFA9;
            transform: scale(1.05);
        }

        .btn-danger {
            background: transparent;
            color: #ef4444;
            padding: 6px;
        }

        .btn-danger:hover {
            background: #fee2e2;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #3AAFA9;
        }

        .summary-card.total {
            background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%);
            color: white;
            border-left: none;
        }

        .summary-category {
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #334155;
        }

        .summary-card.total .summary-category {
            color: white;
        }

        .summary-amount {
            font-size: 2em;
            font-weight: 700;
            color: #1e293b;
        }

        .summary-card.total .summary-amount {
            color: white;
        }

        .summary-count {
            font-size: 0.8em;
            color: #64748b;
            margin-top: 4px;
        }

        .summary-card.total .summary-count {
            color: rgba(255, 255, 255, 0.9);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
            font-size: 0.9em;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #f1f5f9;
        }

        tr:hover {
            background: #f8fafc;
        }

        input[type="text"],
        input[type="number"],
        input[type="password"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #3AAFA9;
        }

        .category-section {
            margin-bottom: 30px;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .category-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.95em;
        }

        .category-total {
            color: #64748b;
            font-size: 0.9em;
        }

        .badge-labour { background: #dbeafe; color: #1e40af; }
        .badge-overheads { background: #e9d5ff; color: #6b21a8; }
        .badge-materials { background: #d1fae5; color: #065f46; }
        .badge-subcontracting { background: #fed7aa; color: #9a3412; }
        .badge-capital { background: #fecaca; color: #991b1b; }
        .badge-capitaluse { background: #fecaca; color: #991b1b; }
        .badge-travel { background: #fef3c7; color: #92400e; }
        .badge-other { background: #f1f5f9; color: #475569; }

        .api-key-section {
            background: #fef3c7;
            border: 2px solid #fcd34d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .api-key-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #fcd34d;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            margin-top: 8px;
        }

        .api-key-label {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 5px;
            display: block;
        }

        .api-key-help {
            font-size: 0.85em;
            color: #78350f;
            margin-top: 5px;
        }

        .api-key-help a {
            color: #92400e;
            text-decoration: underline;
        }

        #results {
            display: none;
        }

        #results.show {
            display: block;
        }

        .hidden {
            display: none;
        }

        .drop-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .drop-zone:hover {
            border-color: #3AAFA9;
            background: #f1f5f9;
        }

        .drop-zone.dragover {
            border-color: #3AAFA9;
            background: #e0e7ff;
            border-style: solid;
            transform: scale(1.02);
        }

        .drop-zone-content {
            pointer-events: none;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-dialog {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #94a3b8;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f1f5f9;
            color: #64748b;
        }

        .modal-body {
            padding: 20px 25px;
            overflow-y: auto;
        }

        .project-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .project-item {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-item:hover {
            border-color: #3AAFA9;
            background: #f8fafc;
            transform: translateX(5px);
        }

        .project-info {
            flex: 1;
        }

        .project-name {
            font-weight: 600;
            font-size: 1.1em;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .project-meta {
            font-size: 0.85em;
            color: #64748b;
        }

        .project-arrow {
            font-size: 1.5em;
            color: #cbd5e1;
        }

        .project-item:hover .project-arrow {
            color: #3AAFA9;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .project-delete-btn {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fca5a5;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            margin-right: 10px;
        }

        .project-delete-btn:hover {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .delete-confirm-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #dc2626;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            z-index: 99999;
            min-width: 300px;
            max-width: 500px;
            display: none;
        }

        .delete-confirm-popup.show {
            display: block;
        }

        .delete-confirm-popup.show::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }

        .delete-confirm-title {
            font-weight: 600;
            color: #dc2626;
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .delete-confirm-text {
            color: #64748b;
            margin-bottom: 15px;
            font-size: 0.95em;
        }

        .delete-confirm-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .delete-confirm-btn {
            padding: 6px 16px;
            border-radius: 6px;
            border: none;
            font-size: 0.9em;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .delete-confirm-btn.cancel {
            background: #f1f5f9;
            color: #64748b;
        }

        .delete-confirm-btn.cancel:hover {
            background: #e2e8f0;
        }

        .delete-confirm-btn.confirm {
            background: #dc2626;
            color: white;
        }

        .delete-confirm-btn.confirm:hover {
            background: #b91c1c;
        }

        /* Saved Projects Dropdown */
        .projects-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 600px;
            max-width: 700px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
        }

        .projects-dropdown-content {
            padding: 10px;
        }

        .dropdown-project-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .dropdown-project-item:hover {
            border-color: #3AAFA9;
            background: #f8fafc;
            transform: translateX(3px);
        }

        .dropdown-project-info {
            flex: 1;
            min-width: 0;
        }

        .dropdown-project-name {
            font-weight: 600;
            font-size: 0.95em;
            color: #1e293b;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .dropdown-project-meta {
            font-size: 0.8em;
            color: #64748b;
            margin-top: 2px;
        }

        .dropdown-delete-btn {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 500;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .dropdown-delete-btn:hover {
            background: #fecaca;
        }

        .dropdown-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }
    </style>

    <!-- Automatic Cloud Backup System -->
    <script src="supabase-client.js"></script>
    <script src="auto-sync-manager.js"></script>
    <script src="sync-status-indicator.js"></script>
</head>
<body>
    <!-- Navigation Banner -->
    <div class="nav-banner">
        <h1>PEBLGen</h1>
        <div class="nav-buttons">
            <a href="grants.html" class="nav-btn active">Grants</a>
            <a href="spend.html" class="nav-btn">Spend</a>
            <a href="gantt.html" class="nav-btn">Gantt</a>
            <a href="timesheet.html" class="nav-btn">Timesheet</a>
            <a href="index.html" class="nav-btn">Sketcher</a>
            <button onclick="resetBackupAuth()" class="nav-btn" style="background-color: rgba(255, 255, 255, 0.15); margin-left: auto;" title="Reset cloud backup authentication">üîÑ Reset Backup</button>
            <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="nav-btn" style="background-color: rgba(255, 255, 255, 0.15);" title="Scroll to top">‚Üë Top</button>
        </div>
    </div>

    <div class="container">
        <!-- Input Section with System Log -->
        <div class="card compact">
            <!-- Top toolbar with flexible wrapping -->
            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
                <!-- Row 1: Title and Project Selection -->
                <span style="font-weight: 600; font-size: 0.95em; white-space: nowrap;">üí∞ Grants Budget Parser</span>

                <!-- Saved Projects Dropdown Selector -->
                <div style="position: relative;">
                    <button class="btn-secondary" onclick="toggleSavedProjectsDropdown()" id="savedProjectsBtn" style="padding: 8px 16px; font-size: 0.9em; white-space: nowrap; display: flex; align-items: center; gap: 6px;">
                        <span>üìö</span>
                        <span id="currentProjectName">Select Project</span>
                        <span style="font-size: 0.7em;">‚ñº</span>
                    </button>
                    <div id="savedProjectsDropdown" class="projects-dropdown" style="display: none;">
                        <div class="projects-dropdown-content" id="projectsDropdownList">
                            <!-- Projects will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Compact Funding Body Selector -->
                <div style="position: relative;">
                    <button id="fundingBodyBtn" onclick="toggleFundingBodyDropdown()"
                            style="padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 1.2em; background: white; cursor: pointer; display: flex; align-items: center;"
                            title="Funding Body Format">
                        <span id="fundingBodyIcon">üîç</span>
                    </button>
                    <div id="fundingBodyDropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 5px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 100; min-width: 150px;">
                        <div onclick="selectFundingBody('auto', 'üîç', 'Auto-Detect')" style="padding: 8px 12px; cursor: pointer; font-size: 0.9em;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">üîç Auto-Detect</div>
                        <div onclick="selectFundingBody('iuk', 'üá¨üáß', 'Innovate UK')" style="padding: 8px 12px; cursor: pointer; font-size: 0.9em; border-top: 1px solid #f1f5f9;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">üá¨üáß Innovate UK</div>
                        <div onclick="selectFundingBody('welshgov', 'üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø', 'Welsh Gov')" style="padding: 8px 12px; cursor: pointer; font-size: 0.9em; border-top: 1px solid #f1f5f9;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø Welsh Gov</div>
                        <div onclick="selectFundingBody('simple_summary', 'üìã', 'Simple Summary (WWF)')" style="padding: 8px 12px; cursor: pointer; font-size: 0.9em; border-top: 1px solid #f1f5f9;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">üìã Simple Summary (WWF)</div>
                    </div>
                </div>

                <!-- Parse Budget Toggle Button -->
                <button class="btn-secondary" onclick="toggleParseBudgetSection()" style="padding: 8px 16px; font-size: 0.9em; white-space: nowrap; display: flex; align-items: center; gap: 6px;">
                    <span>üìä</span>
                    <span>Parse Budget</span>
                    <span class="chevron" id="parseSectionChevron" style="font-size: 0.7em;">‚ñº</span>
                </button>

                <button class="btn-secondary" onclick="clearAll()" style="padding: 8px 16px; font-size: 0.9em; white-space: nowrap;">Clear</button>
                <button class="btn-secondary" onclick="document.getElementById('loadProjectInputTop').click()" style="padding: 8px 16px; font-size: 0.9em; white-space: nowrap;">
                    <span>üìÇ</span>
                    Load from JSON
                </button>
                <input type="file" id="loadProjectInputTop" accept=".json" style="display: none;" onchange="loadProjectJSON(event)">

                <!-- Spacer to push System Log to the right -->
                <div style="flex: 1; min-width: 20px;"></div>

                <!-- System Log Toggle (anchored right) -->
                <div onclick="toggleLog()" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f8fafc; border-radius: 6px; cursor: pointer; border: 1px solid #e2e8f0; white-space: nowrap;">
                    <span style="font-weight: 600; font-size: 0.85em; color: #475569;">System Log</span>
                    <span class="badge" id="logCount" style="padding: 2px 8px; font-size: 0.7em;">0 entries</span>
                    <span class="chevron" id="logChevron" style="font-size: 0.8em;">‚ñº</span>
                </div>
            </div>
        </div>

        <!-- Parse Budget Section (Collapsible) -->
        <div class="collapsible-content" id="parseBudgetSection" style="margin-bottom: 12px;">
            <div class="card compact">
                <!-- Text input row with fullscreen button -->
                <div style="display: flex; gap: 8px; align-items: flex-start;">
                    <textarea id="budgetInput" style="flex: 1; min-height: 60px; height: 60px; max-height: 800px; resize: vertical; padding: 8px 12px; font-size: 0.85em; font-family: 'Courier New', monospace; line-height: 1.4; overflow-y: auto; border: 1px solid #cbd5e1; border-radius: 6px;" placeholder="Paste your FULL PROJECT BUDGET text here... The AI will automatically detect the format (Labour, Overheads, Materials, etc.)"></textarea>
                    <button class="btn-fullscreen" onclick="toggleFullscreenTextarea()" title="Expand to fullscreen (ESC to exit)">
                        ‚õ∂
                    </button>
                </div>
                <!-- Parse Button -->
                <div style="margin-top: 10px;">
                    <button class="btn-primary" id="parseBtn" onclick="parseBudget()" style="padding: 8px 20px; font-size: 0.9em; white-space: nowrap;">
                        <span>üìä</span>
                        <span id="parseBtnText">Parse Budget</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- System Log Content (Collapsible) -->
        <div class="collapsible-content" id="logContent" style="margin-bottom: 12px;">
            <div class="card compact">
                <div class="log-container" id="logContainer" style="max-height: 300px;">
                    <div class="log-empty">No logs yet...</div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="card" id="results">
            <div class="card-header">
                <h2 class="card-title">Budget Breakdown</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-secondary" onclick="saveBudgetProfile()">
                        <span>üíæ</span>
                        Save Profile
                    </button>
                    <button class="btn-secondary" onclick="document.getElementById('loadProfileInput').click()">
                        <span>üìÇ</span>
                        Load Profile
                    </button>
                    <button class="btn-secondary" onclick="exportCSV()">
                        <span>üìä</span>
                        Export CSV
                    </button>
                </div>
                <input type="file" id="loadProfileInput" accept=".json" style="display: none;" onchange="loadBudgetProfile(event)">
            </div>

            <!-- Summary Cards -->
            
let activeQuarter = 2; // Default to Q2 as current claiming period
            <!-- Active Quarter Selector -->
            <div style="margin-bottom: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 2px solid #ff9800;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-weight: 600; color: #e65100;">üìÖ Active Claiming Period:</span>
                    <div style="display: flex; gap: 10px;">
                        <button class="quarter-btn" data-quarter="1" onclick="setActiveQuarter(1)" style="padding: 8px 16px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-weight: 500;">Q1</button>
                        <button class="quarter-btn active-quarter" data-quarter="2" onclick="setActiveQuarter(2)" style="padding: 8px 16px; border: 2px solid #ff9800; border-radius: 6px; background: #ff9800; color: white; cursor: pointer; font-weight: 500;">Q2</button>
                        <button class="quarter-btn" data-quarter="3" onclick="setActiveQuarter(3)" style="padding: 8px 16px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-weight: 500;">Q3</button>
                        <button class="quarter-btn" data-quarter="4" onclick="setActiveQuarter(4)" style="padding: 8px 16px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-weight: 500;">Q4</button>
                    </div>
                    <span id="activeQuarterLabel" style="color: #e65100; font-weight: 600;">‚Üê Currently claiming for Q2</span>
                </div>
            </div>

            <div class="summary-grid" id="summaryGrid"></div>

            <!-- Detailed Tables -->
            <div id="tablesContainer"></div>
        </div>

        <!-- Detailed Project Budget Display -->
        <div class="card" id="detailedBudgetResults" style="display: none;">
            <div class="card-header" style="flex-direction: column; align-items: stretch;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 class="card-title" style="margin: 0;">üìã Project Budget</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-secondary" onclick="exportProjectJSON()">
                            <span>üì•</span>
                            Download JSON
                        </button>
                        <button class="btn-secondary" onclick="document.getElementById('loadProjectInput').click()">
                            <span>üìÇ</span>
                            Load Project
                        </button>
                    </div>
                    <input type="file" id="loadProjectInput" accept=".json" style="display: none;" onchange="loadProjectJSON(event)">
                </div>

                <!-- Project Name Input -->
                <div style="display: flex; gap: 15px; align-items: center; padding: 12px 15px; background: #f8fafc; border-radius: 8px; border: 2px solid #e2e8f0;">
                    <label for="projectNameInput" style="font-weight: 600; color: #64748b; white-space: nowrap; font-size: 0.95em;">üìù Project Name:</label>
                    <input
                        type="text"
                        id="projectNameInput"
                        placeholder="Enter project name..."
                        style="flex: 1; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em;"
                        onchange="updateProjectName(this.value)"
                    >
                    <label for="projectNumberInput" style="font-weight: 600; color: #64748b; white-space: nowrap; font-size: 0.95em;">üî¢ Project #:</label>
                    <input
                        type="text"
                        id="projectNumberInput"
                        placeholder="Project number..."
                        style="width: 180px; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em;"
                        onchange="updateProjectNumber(this.value)"
                    >
                    <button class="btn-primary" onclick="saveCurrentProject()" style="padding: 8px 20px; font-size: 0.9em; white-space: nowrap;">
                        üíæ Save
                    </button>
                </div>
            </div>

            <!-- Finance Summary Section -->
            <div id="financeSummarySection"></div>

            <!-- Quarter Controls Section -->
            <div id="quarterControlsSection"></div>

            <!-- Budget Summary Overview Section -->
            <div id="budgetSummaryOverview" style="display: none;"></div>

            <!-- Labour Section -->
            <div id="labourSection"></div>

            <!-- Overheads & Materials Section -->
            <div id="overheadsMaterialsSection"></div>

            <!-- Capital & Subcontracting Section -->
            <div id="capitalSubcontractingSection"></div>

            <!-- Travel & Other Costs Section -->
            <div id="travelOtherSection"></div>
        </div>
    </div>

    <script>
        console.log('=== GRANTS.HTML SCRIPT LOADING ===');

        // Get API key from localStorage (user must set it via UI)
        function getAPIKey() {
            const key = localStorage.getItem('openai_api_key');
            if (!key) {
                console.warn('‚ö†Ô∏è No OpenAI API key found in localStorage. Please set it via the settings menu.');
            }
            return key;
        }

        // Reset cloud backup authentication
        function resetBackupAuth() {
            if (confirm('üîÑ Reset Cloud Backup Authentication?\n\nThis will:\n‚úì Clear your current backup credentials\n‚úì Create a new backup account\n‚úì Re-enable automatic backup\n\nYour data will NOT be deleted.\n\nContinue?')) {
                console.log('üîÑ Resetting backup authentication...');

                // Clear old credentials
                localStorage.removeItem('peblgen_device_id');
                localStorage.removeItem('peblgen_device_password');

                // Show success message
                alert('‚úÖ Backup credentials cleared!\n\nPage will reload with fresh authentication.');
                console.log('‚úÖ Backup credentials cleared, reloading...');

                // Force hard reload (bypass cache) with timestamp
                window.location.href = window.location.pathname + '?nocache=' + Date.now();
            }
        }

        let budgetData = [];
        let logs = [];
        console.log('Variables initialized');

        // Project Budget Data Model (for detailed parsing)
        let projectBudget = {
            projectId: null,
            projectName: '',
            projectNumber: '',
            lastModified: null,

            // Finance Summary
            financeSummary: {
                projectDuration: '',
                projectStartMonth: null, // 1-12
                projectStartYear: null, // e.g., 2024
                projectDurationMonths: null, // number of months
                totalCosts: 0,
                fundingLevel: 0,
                fundingSought: 0,
                otherPublicFunding: 0,
                contribution: 0
            },

            // Labour
            labour: {
                workingDaysPerYear: 232,
                staff: [], // {role, grossCost, ratePerDay, days, totalCost}
                totalCost: 0,
                hasPAYE: true
            },

            // Overheads
            overheads: {
                percentage: 20,
                labourCosts: 0,
                totalCost: 0
            },

            // Materials
            materials: {
                items: [], // {item, quantity, costPerItem, total}
                totalCost: 0
            },

            // Capital Usage
            capitalUsage: {
                items: [], // {description, newOrExisting, depreciationPeriod, netPresentValue, residualValue, utilisation, netCost}
                totalCost: 0
            },

            // Subcontracting
            subcontracting: {
                contractors: [], // {name, country, role, cost}
                totalCost: 0
            },

            // Travel
            travel: {
                trips: [], // {purpose, numberOfTimes, costEach, total}
                totalCost: 0
            },

            // Other Costs
            otherCosts: {
                items: [], // {description, estimatedCost}
                totalCost: 0
            }
        };
        console.log('Project budget data model initialized');

        // IndexedDB Setup
        let db;
        const DB_NAME = 'PEBLGrantsBudgets';
        const DB_VERSION = 6; // Updated to version 6 to match current browser database
        const STORE_NAME = 'projects';
        const CSV_STORE_NAME = 'csvFiles'; // Added by spend.html
        const INVOICES_STORE_NAME = 'invoices'; // Added for spend.html invoice storage

        async function initIndexedDB() {
            console.log(`üîç [DB INIT] Starting IndexedDB initialization...`);
            console.log(`üîç [DB INIT] Database: ${DB_NAME}, Target Version: ${DB_VERSION}`);

            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                // Add timeout to detect hanging requests
                const timeout = setTimeout(() => {
                    console.warn('‚ö†Ô∏è [DB INIT] Database initialization timeout (10s) - continuing without DB');
                    if (!db) {
                        addLog('‚ö†Ô∏è Database initialization timeout - features may be limited');
                        resolve(null);
                    }
                }, 10000); // 10 second timeout

                request.onerror = (event) => {
                    clearTimeout(timeout);
                    console.error('‚ùå [DB INIT] IndexedDB error:', request.error);
                    console.error('‚ùå [DB INIT] Error name:', request.error?.name);
                    console.error('‚ùå [DB INIT] Error message:', request.error?.message);
                    console.error('‚ùå [DB INIT] Error event:', event);
                    console.error('‚ùå [DB INIT] Request state:', request.readyState);
                    // Don't reject - continue without DB to allow app to load
                    db = null;
                    addLog('‚ùå Database initialization failed - features may be limited');
                    resolve(null);
                };

                request.onsuccess = () => {
                    clearTimeout(timeout);
                    db = request.result;
                    console.log('‚úÖ [DB INIT] IndexedDB opened successfully');
                    console.log(`‚úÖ [DB INIT] Current version: ${db.version}`);
                    console.log(`‚úÖ [DB INIT] Object stores: ${Array.from(db.objectStoreNames).join(', ')}`);
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    console.log(`üîß [DB UPGRADE] Upgrading IndexedDB from v${event.oldVersion} to v${event.newVersion}`);
                    const database = event.target.result;

                    // Create projects object store if it doesn't exist
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = database.createObjectStore(STORE_NAME, { keyPath: 'projectId', autoIncrement: true });
                        objectStore.createIndex('projectName', 'projectName', { unique: false });
                        objectStore.createIndex('projectNumber', 'projectNumber', { unique: false });
                        objectStore.createIndex('lastModified', 'lastModified', { unique: false });
                        console.log('‚úÖ Created projects object store');
                    } else {
                        console.log('‚úì Projects store already exists');
                    }

                    // Create CSV files object store if it doesn't exist (for spend.html compatibility)
                    if (!database.objectStoreNames.contains(CSV_STORE_NAME)) {
                        const csvStore = database.createObjectStore(CSV_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        csvStore.createIndex('fileName', 'fileName', { unique: false });
                        csvStore.createIndex('uploadDate', 'uploadDate', { unique: false });
                        console.log('‚úÖ Created CSV files object store');
                    } else {
                        console.log('‚úì CSV files store already exists');
                    }

                    // Create invoices object store if it doesn't exist (for spend.html compatibility)
                    if (!database.objectStoreNames.contains(INVOICES_STORE_NAME)) {
                        const invoicesStore = database.createObjectStore(INVOICES_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        invoicesStore.createIndex('transactionIndex', 'transactionIndex', { unique: false });
                        invoicesStore.createIndex('filename', 'filename', { unique: false });
                        invoicesStore.createIndex('uploadDate', 'uploadDate', { unique: false });
                        console.log('‚úÖ Created invoices object store');
                    } else {
                        console.log('‚úì Invoices store already exists');
                    }
                };

                request.onblocked = () => {
                    console.warn('‚ö†Ô∏è IndexedDB upgrade blocked - close other tabs using this database');
                };
            });
        }

        // Transaction and Invoice Loading (for Spend integration)
        let cachedTransactions = null;
        let cachedInvoices = null;

        // Load all transactions from csvFiles store
        async function loadAllTransactions() {
            if (!db) await initIndexedDB();
            if (!db) return [];

            try {
                // Check if csvFiles store exists
                if (!db.objectStoreNames.contains(CSV_STORE_NAME)) {
                    console.log('üìä [TRANSACTIONS] CSV files store not found');
                    return [];
                }

                const transaction = db.transaction([CSV_STORE_NAME], 'readonly');
                const store = transaction.objectStore(CSV_STORE_NAME);
                const allFiles = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                // Flatten all transactions from all CSV files
                const allTransactions = [];
                allFiles.forEach(file => {
                    if (file.transactions && Array.isArray(file.transactions)) {
                        allTransactions.push(...file.transactions);
                    }
                });

                console.log(`üìä [TRANSACTIONS] Loaded ${allTransactions.length} transactions from ${allFiles.length} CSV files`);
                return allTransactions;
            } catch (error) {
                console.error('‚ùå [TRANSACTIONS] Failed to load transactions:', error);
                return [];
            }
        }

        // Load all invoice attachments
        async function loadInvoiceAttachments() {
            if (!db) await initIndexedDB();
            if (!db) return [];

            try {
                // Check if invoices store exists
                if (!db.objectStoreNames.contains(INVOICES_STORE_NAME)) {
                    console.log('üìé [INVOICES] Invoices store not found');
                    return [];
                }

                const transaction = db.transaction([INVOICES_STORE_NAME], 'readonly');
                const store = transaction.objectStore(INVOICES_STORE_NAME);
                const allInvoices = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                console.log(`üìé [INVOICES] Loaded ${allInvoices.length} invoice attachments`);
                return allInvoices;
            } catch (error) {
                console.error('‚ùå [INVOICES] Failed to load invoices:', error);
                return [];
            }
        }

        // Get transactions for a specific item and quarter
        function getTransactionsForItem(allTransactions, projectId, category, itemKey, quarter = null) {
            const filtered = allTransactions.filter(transaction => {
                if (!transaction.assignments || !Array.isArray(transaction.assignments)) return false;

                return transaction.assignments.some(assignment =>
                    assignment.projectId === projectId &&
                    assignment.category === category &&
                    assignment.itemKey === itemKey &&
                    (quarter === null || assignment.quarter === quarter)
                );
            });

            console.log(`üîç [FILTER] Found ${filtered.length} transactions for project ${projectId}, ${category}, ${itemKey}, Q${quarter || 'all'}`);
            return filtered;
        }

        // Find invoice for a transaction
        function getInvoiceForTransaction(transaction, invoices) {
            if (!invoices || invoices.length === 0) return null;

            // Try to match by date and description substring
            return invoices.find(inv => {
                if (!inv.transactionDate || !transaction.date) return false;

                const dateMatch = inv.transactionDate === transaction.date;
                const descMatch = inv.description &&
                    transaction.description &&
                    (inv.description.includes(transaction.description.substring(0, 20)) ||
                     transaction.description.includes(inv.description.substring(0, 20)));

                return dateMatch && descMatch;
            });
        }

        // Render transaction details table
        function renderTransactionDetails(transactions, projectId, category, itemKey, quarter, invoices) {
            if (!transactions || transactions.length === 0) {
                return '<p style="color: #94a3b8; font-style: italic; padding: 10px;">No transactions assigned yet</p>';
            }

            const rows = transactions.map(transaction => {
                const date = transaction.date || '-';
                const description = transaction.description || '-';
                const spentAmount = parseAmount(transaction.spent);
                const valueExTax = spentAmount > 0 ? (spentAmount / 1.2).toFixed(2) : '0.00';

                // Combine manual description and voice notes for Detail column
                const detailParts = [];
                if (transaction.manualDescription) detailParts.push(transaction.manualDescription);
                if (transaction.voiceNotes) detailParts.push(`üé§ ${transaction.voiceNotes}`);
                const detail = detailParts.length > 0 ? detailParts.join(' | ') : '-';

                // Find the specific assignment for this item
                const assignment = transaction.assignments.find(a =>
                    a.projectId === projectId &&
                    a.category === category &&
                    a.itemKey === itemKey &&
                    (quarter === null || a.quarter === quarter)
                );

                const assignedAmount = assignment ? assignment.amount.toFixed(2) : '0.00';
                const assignedQuarter = assignment ? assignment.quarter : '-';

                // Check for PDF attachment
                const invoice = getInvoiceForTransaction(transaction, invoices);
                const pdfCell = invoice
                    ? `<button class="view-pdf-btn" data-invoice-id="${invoice.id}" onclick="viewInvoicePDF(${invoice.id})" style="background: #4caf50; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">üìé View PDF</button>`
                    : '<span style="color: #94a3b8;">-</span>';

                return `
                    <tr>
                        <td style="padding: 6px 10px;">${escapeHtml(date)}</td>
                        <td style="padding: 6px 10px;">${escapeHtml(description)}</td>
                        <td style="padding: 6px 10px; text-align: right;">¬£${valueExTax}</td>
                        <td style="padding: 6px 10px; max-width: 250px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(detail)}</td>
                        <td style="padding: 6px 10px; text-align: center;">${pdfCell}</td>
                        <td style="padding: 6px 10px; text-align: center;">Q${assignedQuarter}</td>
                        <td style="padding: 6px 10px; text-align: right; font-weight: 600;">¬£${assignedAmount}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                    <h5 style="margin: 0 0 10px 0; color: #3b82f6; font-size: 0.95em;">üí≥ Assigned Transactions</h5>
                    <table class="transaction-details-table" style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead>
                            <tr style="background: #f1f5f9;">
                                <th style="padding: 8px 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1;">Date</th>
                                <th style="padding: 8px 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1;">Description</th>
                                <th style="padding: 8px 10px; text-align: right; font-weight: 600; border-bottom: 2px solid #cbd5e1;">Value ex Tax</th>
                                <th style="padding: 8px 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1;">Detail</th>
                                <th style="padding: 8px 10px; text-align: center; font-weight: 600; border-bottom: 2px solid #cbd5e1;">PDF</th>
                                <th style="padding: 8px 10px; text-align: center; font-weight: 600; border-bottom: 2px solid #cbd5e1;">Qtr</th>
                                <th style="padding: 8px 10px; text-align: right; font-weight: 600; border-bottom: 2px solid #cbd5e1;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // HTML escape utility
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Parse amount from string (removes currency symbols and commas)
        function parseAmount(amountStr) {
            if (!amountStr) return 0;
            // Remove currency symbols and commas
            const cleaned = amountStr.replace(/[¬£$,]/g, '');
            return parseFloat(cleaned) || 0;
        }

        // View invoice PDF in modal
        async function viewInvoicePDF(invoiceId) {
            if (!db) await initIndexedDB();
            if (!db) {
                alert('Database not available');
                return;
            }

            try {
                const transaction = db.transaction([INVOICES_STORE_NAME], 'readonly');
                const store = transaction.objectStore(INVOICES_STORE_NAME);
                const invoice = await new Promise((resolve, reject) => {
                    const request = store.get(invoiceId);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                if (!invoice || !invoice.pdfBlob) {
                    alert('PDF not found');
                    return;
                }

                // Create blob URL and open in modal
                const blobUrl = URL.createObjectURL(invoice.pdfBlob);
                showPDFModal(blobUrl, invoice.filename || 'invoice.pdf');
            } catch (error) {
                console.error('Failed to load PDF:', error);
                alert('Failed to load PDF');
            }
        }

        // Show PDF in modal
        function showPDFModal(pdfUrl, filename) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.id = 'pdfModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; width: 90%; max-width: 900px; height: 90vh; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <div style="padding: 15px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 1.1em; color: #333;">üìé ${escapeHtml(filename)}</h3>
                        <button onclick="closePDFModal()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úï Close</button>
                    </div>
                    <div style="flex: 1; overflow: hidden;">
                        <iframe src="${pdfUrl}" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePDFModal();
                }
            });

            // Clean up blob URL when modal closes
            modal.dataset.blobUrl = pdfUrl;
        }

        // Close PDF modal
        function closePDFModal() {
            const modal = document.getElementById('pdfModal');
            if (modal) {
                // Revoke blob URL to free memory
                if (modal.dataset.blobUrl) {
                    URL.revokeObjectURL(modal.dataset.blobUrl);
                }
                modal.remove();
            }
        }

        // Pre-load transactions and invoices on page load
        async function preloadTransactionData() {
            console.log('üìä [PRELOAD] Loading transaction data...');
            cachedTransactions = await loadAllTransactions();
            cachedInvoices = await loadInvoiceAttachments();
            console.log(`‚úÖ [PRELOAD] Cached ${cachedTransactions.length} transactions and ${cachedInvoices.length} invoices`);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ [STARTUP] DOM Content Loaded - starting initialization...');

            // Initialize IndexedDB
            initIndexedDB()
                .then((database) => {
                    console.log('üîÑ [STARTUP] IndexedDB initialization promise resolved');
                    console.log('üîç [STARTUP] Database object:', database ? 'Present' : 'NULL');

                    if (database) {
                        addLog('üíæ IndexedDB initialized successfully');
                        console.log('‚úÖ [STARTUP] Ready to save/load projects');
                        console.log('üîÑ [STARTUP] Calling loadProjectsOnStartup()...');

                        // Auto-load projects to check for existing data
                        loadProjectsOnStartup();

                        // Pre-load transactions and invoices from Spend tab
                        preloadTransactionData();
                    } else {
                        addLog('‚ö†Ô∏è IndexedDB unavailable - project saving disabled');
                        console.warn('‚ö†Ô∏è [STARTUP] App running without database support');
                    }
                })
                .catch((error) => {
                    console.error('‚ùå [STARTUP] Failed to initialize IndexedDB:', error);
                    addLog('‚ö†Ô∏è IndexedDB initialization failed - project saving disabled');
                });
        });

        function handleFile(file) {
            console.log('File selected:', file.name, 'Type:', file.type);
            addLog(`üìÅ Loading file: ${file.name}`);

            const fileName = file.name.toLowerCase();
            const reader = new FileReader();

            if (fileName.endsWith('.csv')) {
                reader.onload = (e) => parseCSV(e.target.result, file.name);
                reader.readAsText(file);
            } else if (fileName.endsWith('.xlsx')) {
                reader.onload = (e) => parseExcel(e.target.result, file.name);
                reader.readAsArrayBuffer(file);
            } else {
                addLog('‚ùå Unsupported file format. Please use CSV or XLSX files.');
                alert('Unsupported file format. Please use CSV or XLSX files.');
            }
        }

        function parseCSV(csvText, fileName) {
            console.log('Parsing CSV file:', fileName);
            addLog('üìä Parsing CSV file...');

            try {
                const lines = csvText.trim().split('\n');
                const rows = lines.map(line => {
                    // Simple CSV parsing (handles basic cases)
                    const result = [];
                    let current = '';
                    let inQuotes = false;

                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            result.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current.trim());
                    return result;
                });

                // Skip header rows (first 4 rows based on the example)
                const dataRows = rows.slice(4);

                // Parse each category row
                budgetData = [];
                for (const row of dataRows) {
                    const category = row[0];

                    // Skip Total row and empty rows
                    if (!category || category.toLowerCase() === 'total' || category === '') continue;

                    // Map category names
                    let mappedCategory = category;
                    if (category.toLowerCase() === 'capital usage') mappedCategory = 'Capital Use';
                    if (category.toLowerCase() === 'travel and subsistence') mappedCategory = 'Travel';
                    if (category.toLowerCase() === 'other costs') mappedCategory = 'Other';

                    const item = {
                        id: Date.now() + budgetData.length,
                        category: mappedCategory,
                        description: mappedCategory,
                        quantity: null,
                        unit: null,
                        unitCost: null,
                        totalCost: 0,
                        q1: parseFloat(row[1]) || 0,
                        q2: parseFloat(row[2]) || 0,
                        q3: parseFloat(row[3]) || 0,
                        q4: parseFloat(row[4]) || 0,
                        totalSpent: parseFloat(row[5]) || 0,
                        totalEligible: parseFloat(row[6]) || 0,
                        difference: parseFloat(row[6] || 0) - parseFloat(row[5] || 0),
                        forecast: parseFloat(row[6]) || 0,
                        notes: ''
                    };

                    budgetData.push(item);
                }

                addLog(`‚úÖ Successfully loaded ${budgetData.length} categories from CSV`);
                console.log('Parsed budget data:', budgetData);

                displayResults();
                document.getElementById('results').classList.add('show');

            } catch (error) {
                console.error('CSV parsing error:', error);
                addLog(`‚ùå Error parsing CSV: ${error.message}`);
                alert(`Error parsing CSV file: ${error.message}`);
            }
        }

        function parseExcel(arrayBuffer, fileName) {
            console.log('Parsing Excel file:', fileName);
            addLog('üìä Parsing Excel file...');

            try {
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                console.log('Excel data:', jsonData);

                // Skip header rows (first 4 rows)
                const dataRows = jsonData.slice(4);

                budgetData = [];
                for (const row of dataRows) {
                    const category = row[0];

                    // Skip Total row and empty rows
                    if (!category || category.toLowerCase() === 'total' || category === '') continue;

                    // Map category names
                    let mappedCategory = category;
                    if (category.toLowerCase() === 'capital usage') mappedCategory = 'Capital Use';
                    if (category.toLowerCase() === 'travel and subsistence') mappedCategory = 'Travel';
                    if (category.toLowerCase() === 'other costs') mappedCategory = 'Other';

                    const item = {
                        id: Date.now() + budgetData.length,
                        category: mappedCategory,
                        description: mappedCategory,
                        quantity: null,
                        unit: null,
                        unitCost: null,
                        totalCost: 0,
                        q1: parseFloat(row[1]) || 0,
                        q2: parseFloat(row[2]) || 0,
                        q3: parseFloat(row[3]) || 0,
                        q4: parseFloat(row[4]) || 0,
                        totalSpent: parseFloat(row[5]) || 0,
                        totalEligible: parseFloat(row[6]) || 0,
                        difference: parseFloat(row[6] || 0) - parseFloat(row[5] || 0),
                        forecast: parseFloat(row[6]) || 0,
                        notes: ''
                    };

                    budgetData.push(item);
                }

                addLog(`‚úÖ Successfully loaded ${budgetData.length} categories from Excel`);
                console.log('Parsed budget data:', budgetData);

                displayResults();
                document.getElementById('results').classList.add('show');

            } catch (error) {
                console.error('Excel parsing error:', error);
                addLog(`‚ùå Error parsing Excel: ${error.message}`);
                alert(`Error parsing Excel file: ${error.message}`);
            }
        }

        // IndexedDB Save/Load Functions
        async function saveToIndexedDB() {
            if (!db) {
                addLog('‚ö†Ô∏è Database not initialized');
                return false;
            }

            try {
                projectBudget.lastModified = new Date().toISOString();

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);

                let request;
                if (projectBudget.projectId && projectBudget.projectId > 0) {
                    // Update existing record
                    request = objectStore.put(projectBudget);
                } else {
                    // Create new record - remove null projectId before adding
                    const dataToSave = { ...projectBudget };
                    delete dataToSave.projectId;
                    request = objectStore.add(dataToSave);
                }

                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        if (!projectBudget.projectId || projectBudget.projectId === null) {
                            projectBudget.projectId = request.result;
                        }
                        const projectName = projectBudget.projectName || projectBudget.projectNumber || 'Unnamed Project';
                        addLog(`üíæ Auto-saved: ${projectName} (ID: ${projectBudget.projectId})`);
                        console.log('Project saved with ID:', projectBudget.projectId);

                        // Update the dropdown button to show current project name
                        const currentProjectNameElement = document.getElementById('currentProjectName');
                        if (currentProjectNameElement) {
                            currentProjectNameElement.textContent = projectName;
                        }

                        resolve(true);
                    };

                    request.onerror = () => {
                        console.error('IndexedDB save error:', request.error);
                        addLog(`‚ùå Save failed: ${request.error}`);
                        reject(request.error);
                    };
                });
            } catch (error) {
                console.error('Save error:', error);
                addLog(`‚ùå Save error: ${error.message}`);
                return false;
            }
        }

        async function loadProjectFromDB(projectId) {
            if (!db) {
                addLog('‚ö†Ô∏è Database not initialized');
                return null;
            }

            try {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.get(projectId);

                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        if (request.result) {
                            projectBudget = request.result;
                            addLog(`üìÇ Loaded: ${projectBudget.projectName || projectBudget.projectNumber}`);
                            resolve(projectBudget);
                        } else {
                            addLog('‚ùå Project not found');
                            resolve(null);
                        }
                    };

                    request.onerror = () => {
                        addLog(`‚ùå Load failed: ${request.error}`);
                        reject(request.error);
                    };
                });
            } catch (error) {
                console.error('Load error:', error);
                addLog(`‚ùå Load error: ${error.message}`);
                return null;
            }
        }

        async function listSavedProjects() {
            if (!db) {
                alert('Database not initialized');
                return;
            }

            try {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.getAll();

                request.onsuccess = () => {
                    const projects = request.result;
                    const dropdownList = document.getElementById('projectsDropdownList');
                    const dropdown = document.getElementById('savedProjectsDropdown');

                    if (projects.length === 0) {
                        dropdownList.innerHTML = `
                            <div class="dropdown-empty-state">
                                <div style="font-size: 2em; margin-bottom: 10px;">üìÇ</div>
                                <p style="font-size: 0.95em; margin-bottom: 5px;">No saved projects yet</p>
                                <p style="font-size: 0.85em; color: #94a3b8;">Parse a budget and click "Save" to create your first project</p>
                            </div>
                        `;
                    } else {
                        // Sort by last modified (most recent first)
                        projects.sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified));

                        dropdownList.innerHTML = projects.map(project => {
                            const name = project.projectName || project.projectNumber || `Project ${project.projectId}`;
                            const duration = project.financeSummary?.projectDuration || 'N/A';
                            const fundingLevel = project.financeSummary?.fundingLevel || 0;
                            const total = project.financeSummary?.totalCosts || 0;
                            const formattedTotal = new Intl.NumberFormat('en-GB', {
                                style: 'currency',
                                currency: 'GBP',
                                minimumFractionDigits: 0
                            }).format(total);

                            return `
                                <div class="dropdown-project-item" onclick="handleProjectSelection(${project.projectId})">
                                    <div class="dropdown-project-info">
                                        <div class="dropdown-project-name">${name}</div>
                                        <div class="dropdown-project-meta">
                                            üí∞ ${formattedTotal} &nbsp;‚Ä¢&nbsp; üìä ${fundingLevel}% Funding &nbsp;‚Ä¢&nbsp; ‚è±Ô∏è ${duration} &nbsp;‚Ä¢&nbsp; ID: ${project.projectId}
                                        </div>
                                    </div>
                                    <button class="dropdown-delete-btn" onclick="event.stopPropagation(); deleteProjectImmediately(${project.projectId}, '${name.replace(/'/g, "\\'")}')">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            `;
                        }).join('');
                    }

                    dropdown.style.display = 'block';
                };

                request.onerror = () => {
                    alert('Failed to list projects: ' + request.error);
                };
            } catch (error) {
                alert('Error listing projects: ' + error.message);
            }
        }

        function toggleSavedProjectsDropdown() {
            const dropdown = document.getElementById('savedProjectsDropdown');
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                listSavedProjects(); // This will set display to 'block'
            } else {
                dropdown.style.display = 'none';
            }
        }

        // Load projects on startup to verify database has existing data
        async function loadProjectsOnStartup() {
            console.log('üìÇ [LOAD STARTUP] loadProjectsOnStartup() called');
            console.log('üìÇ [LOAD STARTUP] db object:', db ? 'Present' : 'NULL');

            if (!db) {
                console.log('‚ö†Ô∏è [LOAD STARTUP] Database not ready for startup load');
                addLog('‚ö†Ô∏è Database not ready');
                return;
            }

            try {
                console.log('üìÇ [LOAD STARTUP] Creating transaction...');
                const transaction = db.transaction(['projects'], 'readonly');
                const objectStore = transaction.objectStore('projects');
                console.log('üìÇ [LOAD STARTUP] Getting all projects...');
                const request = objectStore.getAll();

                request.onsuccess = () => {
                    const projects = request.result;
                    console.log(`üìÇ [LOAD STARTUP] getAll() success - retrieved ${projects.length} projects`);
                    console.log('üìÇ [LOAD STARTUP] Projects:', projects);

                    const btnText = document.getElementById('currentProjectName');

                    if (projects.length > 0) {
                        console.log(`‚úÖ [LOAD STARTUP] Found ${projects.length} existing project(s) in database`);
                        addLog(`üìö Found ${projects.length} saved project(s)`);

                        // List project names for debugging
                        projects.forEach((p, i) => {
                            console.log(`  ${i + 1}. ${p.projectName} (ID: ${p.id || p.projectId})`);
                        });

                        // Update button to show project count
                        if (btnText) {
                            btnText.textContent = `${projects.length} Project${projects.length > 1 ? 's' : ''} Available`;
                            console.log(`‚úÖ [LOAD STARTUP] Updated button text to: ${btnText.textContent}`);
                        }

                        // Check localStorage for last selected project
                        const lastSelectedId = localStorage.getItem('lastSelectedProjectId');
                        let projectToLoad = null;

                        if (lastSelectedId) {
                            // Try to find the last selected project
                            projectToLoad = projects.find(p => String(p.id || p.projectId) === String(lastSelectedId));
                            if (projectToLoad) {
                                console.log(`üîÑ [LOAD STARTUP] Restoring last selected project from localStorage: ${projectToLoad.projectName} (ID: ${lastSelectedId})`);
                                addLog(`üîÑ Restoring: ${projectToLoad.projectName}`);
                            } else {
                                console.log(`‚ö†Ô∏è [LOAD STARTUP] Last selected project (ID: ${lastSelectedId}) not found, falling back to most recent`);
                            }
                        }

                        // Fall back to most recent if no saved selection or project not found
                        if (!projectToLoad) {
                            const mostRecent = projects.sort((a, b) => (b.id || b.projectId) - (a.id || a.projectId))[0];
                            if (mostRecent) {
                                projectToLoad = mostRecent;
                                console.log(`üîÑ [LOAD STARTUP] Auto-loading most recent project: ${mostRecent.projectName} (ID: ${mostRecent.id || mostRecent.projectId})`);
                                addLog(`üîÑ Auto-loading: ${mostRecent.projectName}`);
                            }
                        }

                        // Load the selected project
                        if (projectToLoad) {
                            const projectId = projectToLoad.id || projectToLoad.projectId;
                            handleProjectSelection(projectId);
                        }
                    } else {
                        console.log('‚ÑπÔ∏è [LOAD STARTUP] No existing projects found in database');
                        addLog('‚ÑπÔ∏è No saved projects yet');
                        if (btnText) {
                            btnText.textContent = 'No Saved Projects';
                            console.log('‚úÖ [LOAD STARTUP] Updated button text to: No Saved Projects');
                        }
                    }
                };

                request.onerror = () => {
                    console.error('‚ùå [LOAD STARTUP] Failed to load projects on startup:', request.error);
                    addLog('‚ö†Ô∏è Failed to check for saved projects');
                };
            } catch (error) {
                console.error('‚ùå [LOAD STARTUP] Error during startup project load:', error);
                console.error('‚ùå [LOAD STARTUP] Error stack:', error.stack);
                addLog('‚ö†Ô∏è Error checking for saved projects');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('savedProjectsDropdown');
            const btn = document.getElementById('savedProjectsBtn');
            if (dropdown && btn && !dropdown.contains(event.target) && !btn.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        function saveCurrentProject() {
            saveToIndexedDB();
        }

        function closeProjectsModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('projectsModal').classList.remove('show');
        }

        async function handleProjectSelection(projectId) {
            console.log(`üìÇ [LOAD] Loading project ID: ${projectId}`);

            // Close dropdown instead of modal
            const dropdown = document.getElementById('savedProjectsDropdown');
            if (dropdown) dropdown.style.display = 'none';

            // Clear all display sections first to prevent mixing IUK/Welsh Gov
            console.log(`üßπ [LOAD] Clearing all display sections...`);
            const sectionsToClear = ['financeSummarySection', 'labourSection', 'overheadsMaterialsSection',
                                     'capitalSubcontractingSection', 'travelOtherSection'];
            sectionsToClear.forEach(sectionId => {
                const element = document.getElementById(sectionId);
                if (element) element.innerHTML = '';
            });

            const project = await loadProjectFromDB(projectId);
            if (project) {
                console.log(`‚úÖ [LOAD] Project loaded, funding body: ${project.fundingBody}`);

                // Save selected project to localStorage for persistence across page navigation
                localStorage.setItem('lastSelectedProjectId', projectId);
                console.log(`üíæ [LOAD] Saved project ID ${projectId} to localStorage for persistence`);

                // Update the dropdown button to show current project name
                const currentProjectNameElement = document.getElementById('currentProjectName');
                if (currentProjectNameElement) {
                    const projectDisplayName = project.projectName || project.projectNumber || `Project ${projectId}`;
                    currentProjectNameElement.textContent = projectDisplayName;
                    console.log(`üìå [LOAD] Updated dropdown to show: ${projectDisplayName}`);
                }

                displayDetailedBudget();
                document.getElementById('detailedBudgetResults').classList.add('show');
                addLog(`‚úÖ Loaded project: ${project.projectName || project.projectNumber || 'Unnamed'}`);
            } else {
                console.error(`‚ùå [LOAD] Failed to load project ${projectId}`);
            }
        }

        function exportProjectJSON() {
            console.log('üîç exportProjectJSON() called');
            console.log('projectBudget.projectName:', projectBudget.projectName);
            console.log('projectBudget.projectNumber:', projectBudget.projectNumber);
            console.log('Full projectBudget:', projectBudget);

            if (!projectBudget.projectName && !projectBudget.projectNumber) {
                console.error('‚ùå Export failed: No project name or number');
                addLog('‚ùå Export failed: No project name or number found');
                alert('No project data to export. Please parse a budget first.');
                return;
            }

            addLog(`üì• Exporting project: ${projectBudget.projectName || projectBudget.projectNumber}`);
            const json = JSON.stringify(projectBudget, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fileName = projectBudget.projectNumber || projectBudget.projectName || 'project-budget';
            a.download = `${fileName.replace(/[^a-z0-9]/gi, '_')}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            addLog(`üì• Exported project: ${fileName}`);
        }

        function loadProjectJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedProject = JSON.parse(e.target.result);

                    // Validate structure
                    if (!loadedProject.financeSummary || !loadedProject.labour) {
                        throw new Error('Invalid project budget file format');
                    }

                    // Remove projectId so it gets a new one when saved
                    loadedProject.projectId = null;
                    projectBudget = loadedProject;

                    addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    addLog('üìÇ Loaded project budget from JSON file');
                    addLog(`Project: ${projectBudget.projectName || projectBudget.projectNumber || 'Unnamed'}`);
                    addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                    displayDetailedBudget();
                    document.getElementById('detailedBudgetResults').classList.add('show');

                    // Auto-save to IndexedDB
                    saveToIndexedDB();
                } catch (error) {
                    addLog(`‚ùå Failed to load project: ${error.message}`);
                    alert('Failed to load project budget. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        function toggleLog() {
            const content = document.getElementById('logContent');
            const chevron = document.getElementById('logChevron');
            content.classList.toggle('open');
            chevron.classList.toggle('open');
        }

        // Parse Budget Section Toggle
        function toggleParseBudgetSection() {
            const content = document.getElementById('parseBudgetSection');
            const chevron = document.getElementById('parseSectionChevron');
            content.classList.toggle('open');
            chevron.classList.toggle('open');
        }

        // Funding Body Selector Functions
        let selectedFundingBody = 'auto'; // Default to auto-detect

        function toggleFundingBodyDropdown() {
            const dropdown = document.getElementById('fundingBodyDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        function selectFundingBody(value, icon, label) {
            selectedFundingBody = value;
            document.getElementById('fundingBodyIcon').textContent = icon;
            document.getElementById('fundingBodyBtn').setAttribute('title', label);
            document.getElementById('fundingBodyDropdown').style.display = 'none';
            console.log(`Selected funding body: ${label} (${value})`);
        }

        // Close funding body dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const fundingDropdown = document.getElementById('fundingBodyDropdown');
            const fundingBtn = document.getElementById('fundingBodyBtn');
            if (fundingDropdown && fundingBtn && !fundingDropdown.contains(event.target) && !fundingBtn.contains(event.target)) {
                fundingDropdown.style.display = 'none';
            }
        });

        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logs.push(logMessage);

            // Also log to console for debugging
            console.log(logMessage);

            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = logs.map(log =>
                `<div class="log-entry">${log}</div>`
            ).join('');

            document.getElementById('logCount').textContent = `${logs.length} entries`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // AI Prompts for Parallel Section Parsing
        const AI_PROMPTS = {
            financeSummary: `Extract ONLY the Finance Summary section from the grant budget text.

Return a JSON object with these exact fields:
{
    "projectDuration": "12 months",
    "totalCosts": 91621,
    "fundingLevel": 100,
    "fundingSought": 91621,
    "otherPublicFunding": 0,
    "contribution": 0
}

Rules:
- Extract all numbers as numeric values (not strings)
- Remove all currency symbols and commas
- If a field is not found, use 0 or empty string
- Return ONLY valid JSON, no markdown`,

            labour: `Extract ONLY the Labour section from the grant budget text.

Return a JSON object with these exact fields:
{
    "workingDaysPerYear": 232,
    "hasPAYE": true,
    "staff": [
        {
            "role": "Project Manager",
            "grossCost": 40000,
            "ratePerDay": 172,
            "days": 60,
            "totalCost": 10345
        }
    ],
    "totalCost": 39612
}

Rules:
- Extract each staff member with their role, costs, rates, and days
- Remove all currency symbols and commas
- Calculate totalCost as sum of all staff costs
- Return ONLY valid JSON, no markdown`,

            overheads: `Extract ONLY the Overhead costs section from the grant budget text.

Return a JSON object with these exact fields:
{
    "percentage": 20,
    "labourCosts": 39612,
    "totalCost": 7922
}

Rules:
- Extract the percentage (typically 20%)
- Extract base labour costs and total overhead costs
- Return ONLY valid JSON, no markdown`,

            materials: `Extract ONLY the Materials section from the grant budget text.

Return a JSON object with these exact fields:
{
    "items": [
        {
            "item": "Acoustic imaging probes",
            "quantity": 2,
            "costPerItem": 2000,
            "total": 4000
        }
    ],
    "totalCost": 8050
}

Rules:
- Extract each material item with quantity and costs
- Remove all currency symbols and commas
- Calculate totalCost as sum of all items
- Return ONLY valid JSON, no markdown`,

            capitalSubcontracting: `Extract Capital Usage AND Subcontracting sections from the grant budget text.

Return a JSON object with these exact fields:
{
    "capitalUsage": {
        "items": [
            {
                "description": "Item name",
                "newOrExisting": "New",
                "depreciationPeriod": 12,
                "netPresentValue": 0,
                "residualValue": 0,
                "utilisation": 100,
                "netCost": 0
            }
        ],
        "totalCost": 0
    },
    "subcontracting": {
        "contractors": [
            {
                "name": "Oxalid Design Ltd",
                "country": "UK",
                "role": "Design of custom PCB...",
                "cost": 16000
            }
        ],
        "totalCost": 30400
    }
}

Rules:
- Extract both sections in one response
- Remove all currency symbols and commas
- Preserve full role descriptions for subcontractors
- Return ONLY valid JSON, no markdown`,

            travelOther: `Extract Travel/Subsistence AND Other Costs sections from the grant budget text.

Return a JSON object with these exact fields:
{
    "travel": {
        "trips": [
            {
                "purpose": "Travel to visit subcontractor Ecodetect",
                "numberOfTimes": 4,
                "costEach": 250,
                "total": 1000
            }
        ],
        "totalCost": 3000
    },
    "otherCosts": {
        "items": [
            {
                "description": "Cloud compute for training model",
                "estimatedCost": 500
            }
        ],
        "totalCost": 2637
    }
}

Rules:
- Extract both sections in one response
- Remove all currency symbols and commas
- Preserve full descriptions
- Return ONLY valid JSON, no markdown`
        };

        // Parse individual section using AI
        async function parseSection(sectionName, inputText) {
            addLog(`üîÑ Parsing ${sectionName}...`);
            console.log(`Parsing section: ${sectionName}`);

            try {
                const apiKey = getAPIKey();
                if (!apiKey) {
                    throw new Error('OpenAI API key not configured. Please set it in the settings.');
                }

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [{
                            role: 'system',
                            content: 'You are a budget parsing expert. Extract data into clean JSON format with precise field extraction.'
                        }, {
                            role: 'user',
                            content: AI_PROMPTS[sectionName] + '\n\n' + inputText
                        }],
                        temperature: 0.1,
                        max_tokens: 2048
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API request failed: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                let responseText = data.choices[0].message.content.trim();

                // Clean markdown formatting if present
                if (responseText.startsWith('```json')) {
                    responseText = responseText.replace(/^```json\n?/, '').replace(/\n?```$/, '');
                } else if (responseText.startsWith('```')) {
                    responseText = responseText.replace(/^```\n?/, '').replace(/\n?```$/, '');
                }

                const parsed = JSON.parse(responseText);
                addLog(`‚úÖ ${sectionName} parsed successfully`);
                console.log(`${sectionName} result:`, parsed);

                return { section: sectionName, data: parsed };
            } catch (error) {
                console.error(`Error parsing ${sectionName}:`, error);
                addLog(`‚ùå ${sectionName} parsing failed: ${error.message}`);
                throw error;
            }
        }

        // Display Welsh Gov Budget
        function displayWelshGovBudget(welshGovData) {
            console.log('displayWelshGovBudget called with:', welshGovData);
            const { sections, financeSummary } = welshGovData;
            console.log('sections:', sections);
            console.log('financeSummary:', financeSummary);

            // Clear ALL previous IUK budget sections (with null checks)
            const iukSections = ['labourSection', 'overheadsSection', 'materialsSection', 'capitalSection', 'subcontractingSection', 'travelSection', 'otherCostsSection', 'overheadsMaterialsSection', 'capitalSubcontractingSection', 'travelOtherSection'];
            iukSections.forEach(sectionId => {
                const element = document.getElementById(sectionId);
                if (element) element.innerHTML = '';
            });

            // Update project name inputs
            const projectNameInput = document.getElementById('projectNameInput');
            const projectNumberInput = document.getElementById('projectNumberInput');
            if (projectNameInput) projectNameInput.value = projectBudget.projectName || 'Welsh Gov Grant';
            if (projectNumberInput) projectNumberInput.value = projectBudget.projectNumber || '';

            // Calculate quarters once for all sections
            const quarters = calculateQuarters();
            const hasQuarters = quarters.length > 0;
            const currentQuarter = getCurrentQuarter();

            // Build finance summary section with compact design
            const fs = projectBudget.financeSummary;
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
            const monthOptions = months.map((m, i) =>
                `<option value="${i+1}" ${fs.projectStartMonth === i+1 ? 'selected' : ''}>${m}</option>`
            ).join('');

            const currentYear = new Date().getFullYear();
            const yearOptions = [];
            for (let y = currentYear - 5; y <= currentYear + 5; y++) {
                yearOptions.push(`<option value="${y}" ${fs.projectStartYear === y ? 'selected' : ''}>${y}</option>`);
            }

            let financeHTML = `
                <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 15px 0; font-size: 1.1em; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.2em;">üí∞</span>
                        Finance Summary - Welsh Gov
                    </h3>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px;">
                        <div style="background: #f0fdfa; padding: 12px; border-radius: 6px; border-left: 3px solid #14b8a6;">
                            <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Total Grant Approved</div>
                            <div style="font-size: 1.1em; font-weight: 600; color: #1e293b;">¬£${financeSummary.totalCosts.toLocaleString()}</div>
                        </div>

                        <div style="background: #f0fdfa; padding: 12px; border-radius: 6px; border-left: 3px solid #06b6d4;">
                            <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Total Project Costs</div>
                            <div style="font-size: 1.1em; font-weight: 600; color: #1e293b;">¬£${financeSummary.totalProjectCosts.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        </div>

                        <div style="background: #f0fdfa; padding: 12px; border-radius: 6px; border-left: 3px solid #0891b2;">
                            <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Capital Total</div>
                            <div style="font-size: 1.1em; font-weight: 600; color: #1e293b;">¬£${financeSummary.capitalTotal.toLocaleString()}</div>
                        </div>

                        <div style="background: #f0fdfa; padding: 12px; border-radius: 6px; border-left: 3px solid #0e7490;">
                            <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Revenue Total</div>
                            <div style="font-size: 1.1em; font-weight: 600; color: #1e293b;">¬£${financeSummary.revenueTotal.toLocaleString()}</div>
                        </div>

                        <div style="background: #f0fdfa; padding: 12px; border-radius: 6px; border-left: 3px solid #155e75;">
                            <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Grant Rate</div>
                            <div style="font-size: 1.1em; font-weight: 600; color: #1e293b;">${financeSummary.fundingLevel}%</div>
                            <div style="font-size: 0.7em; color: #94a3b8; margin-top: 2px;">No overhead calculations</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 12px; align-items: center; padding: 12px; background: #f8fafc; border-radius: 6px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.85em; color: #64748b; font-weight: 500; white-space: nowrap;">Project Start:</label>
                            <select id="projectStartMonth" onchange="updateProjectStartDate()" style="padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.9em; background: white;">
                                <option value="">Month</option>
                                ${monthOptions}
                            </select>
                            <select id="projectStartYear" onchange="updateProjectStartDate()" style="padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.9em; background: white;">
                                <option value="">Year</option>
                                ${yearOptions.join('')}
                            </select>
                        </div>

                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.85em; color: #64748b; font-weight: 500; white-space: nowrap;">Duration:</label>
                            <input type="number" id="projectDurationMonths" value="${fs.projectDurationMonths || ''}"
                                   min="1" max="120" onchange="updateProjectDuration()"
                                   style="width: 70px; padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.9em;"
                                   placeholder="12">
                            <span style="font-size: 0.85em;">months</span>
                            ${fs.projectStartMonth && fs.projectDurationMonths ?
                                `<span style="color: #64748b; font-size: 0.85em;">(Ends: ${calculateEndDate(fs.projectStartMonth, fs.projectStartYear, fs.projectDurationMonths)})</span>` :
                                ''}
                        </div>
                    </div>
                </div>
            `;

            // Add Quarterly Budget Tracking Controls
            if (hasQuarters) {
                financeHTML += `
                    <div style="background: linear-gradient(135deg, #14b8a6 0%, #0891b2 100%); border-radius: 8px; padding: 16px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="color: white; margin: 0; font-size: 1em; display: flex; align-items: center; gap: 8px;">
                                <span>üìÖ</span>
                                Quarterly Budget Tracking
                            </h3>
                            ${currentQuarter ? `
                                <span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 0.8em; color: white; font-weight: 500;">
                                    üîî Current: Q${currentQuarter}
                                </span>
                            ` : ''}
                        </div>

                        <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 12px;">
                            <span style="font-size: 0.85em; color: white; font-weight: 500; opacity: 0.9;">Activate Quarter:</span>
                `;

                quarters.forEach(quarter => {
                    const isCurrentQuarter = currentQuarter === quarter.index;
                    const isActive = activeQuarterIndex === quarter.index;

                    financeHTML += `
                        <button
                            class="quarter-activate-btn"
                            data-quarter="${quarter.index}"
                            onclick="setActiveQuarter(${quarter.index})"
                            style="
                                padding: 6px 14px;
                                border-radius: 6px;
                                border: ${isActive ? '2px solid #ff9800' : (isCurrentQuarter ? '2px solid #4caf50' : '1px solid rgba(255,255,255,0.3)')};
                                background: ${isActive ? '#ff9800' : (isCurrentQuarter ? '#4caf50' : 'rgba(255,255,255,0.15)')};
                                color: white;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.2s;
                                font-size: 0.85em;
                                backdrop-filter: blur(10px);
                            "
                            onmouseover="if(${!isActive}) this.style.background='rgba(255,255,255,0.25)'"
                            onmouseout="if(${!isActive}) this.style.background='${isCurrentQuarter ? '#4caf50' : 'rgba(255,255,255,0.15)'}'"
                        >
                            ${quarter.label}${isCurrentQuarter && !isActive ? ' üîî' : ''}
                        </button>
                    `;
                });

                financeHTML += `
                        </div>

                        <button
                            onclick="toggleBudgetSummaryOverview()"
                            style="
                                width: 100%;
                                padding: 10px 16px;
                                background: white;
                                color: #14b8a6;
                                border: none;
                                border-radius: 6px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.2s;
                                font-size: 0.9em;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 8px;
                            "
                            onmouseover="this.style.background='#f8fafc'"
                            onmouseout="this.style.background='white'"
                        >
                            <span>üìä</span>
                            <span>Show Budget Summary Overview</span>
                        </button>
                    </div>
                `;
            } else {
                financeHTML += `
                    <div style="background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 16px; margin-bottom: 15px; text-align: center;">
                        <p style="margin: 0; color: #64748b; font-size: 0.9em;">
                            ‚ÑπÔ∏è Set Project Start Date and Duration in Finance Summary to enable quarterly tracking
                        </p>
                    </div>
                `;
            }

            // Build Capital Non-Standard Costs table
            if (sections.capital.nonStandard.length > 0) {
                financeHTML += `
                    <div class="card">
                        <h3>üèóÔ∏è Capital - Non Standard Costs</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Item Code</th>
                                    <th>Item Description</th>
                                    <th>Total Cost</th>
                                    <th>Grant Rate</th>
                                    <th>Maximum Grant Value ¬£</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${sections.capital.nonStandard.map((item, index) => {
                                    if (!item.totalCost && item.maxGrantValue) item.totalCost = item.maxGrantValue;
                                    initializeQuarterlyCosts(item);
                                    const costsClaimed = getTotalCostsClaimed(item);
                                    const remaining = getRemainingBudget(item);
                                    const difference = getDifferencePercentage(item);
                                    const isOverBudget = costsClaimed > item.maxGrantValue;

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('wg-capital-ns-${index}')" style="cursor: pointer; ${isOverBudget && hasQuarters ? 'background: #fee;' : ''}">
                                            <td>${item.itemCode}</td>
                                            <td>${item.description}</td>
                                            <td>¬£${item.totalCost.toLocaleString()}</td>
                                            <td>${item.grantRate}%</td>
                                            <td>¬£${item.maxGrantValue.toLocaleString()}</td>
                                            ${hasQuarters ? `
                                                <td ${isOverBudget ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${costsClaimed.toLocaleString()}</td>
                                                <td ${remaining < 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${remaining.toLocaleString()}</td>
                                                <td ${difference > 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>${difference.toFixed(1)}%</td>
                                            ` : ''}
                                        </tr>
                                        ${hasQuarters ? `
                                        <tr id="wg-capital-ns-${index}-breakdown" style="display: none;">
                                            <td colspan="${hasQuarters ? '8' : '5'}" style="padding: 0; background: #f8f9fa;">
                                                <div style="padding: 15px;">
                                                    <h4 style="margin: 0 0 10px 0; color: #64748b; font-size: 0.95em;">üìä Quarterly Breakdown - ${item.description}</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #e2e8f0;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => `
                                                                    <td data-quarter="${q.index}">
                                                                        <input
                                                                            type="number"
                                                                            value="${item.quarterlyCosts['q' + q.index] || 0}"
                                                                            onchange="updateQuarterlyCost(projectBudget.welshGovData.sections.capital.nonStandard[${index}], ${q.index}, this.value); displayWelshGovBudget(projectBudget.welshGovData);"
                                                                            onclick="event.stopPropagation()"
                                                                            style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                                        />
                                                                    </td>
                                                                `).join('')}
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${remaining.toLocaleString()}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    ${(() => {
                                                        // Render transaction details for this Capital Non-Standard item
                                                        if (cachedTransactions && cachedTransactions.length > 0) {
                                                            const itemTransactions = getTransactionsForItem(
                                                                cachedTransactions,
                                                                projectBudget.projectId,
                                                                'Capital Non-Standard',
                                                                'capitalNonStandard-' + index,
                                                                null
                                                            );
                                                            return renderTransactionDetails(
                                                                itemTransactions,
                                                                projectBudget.projectId,
                                                                'Capital Non-Standard',
                                                                'capitalNonStandard-' + index,
                                                                null,
                                                                cachedInvoices || []
                                                            );
                                                        }
                                                        return '';
                                                    })()}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    `;
                                }).join('')}

                                ${hasQuarters && sections.capital.nonStandard.length > 0 ? (() => {
                                    const summary = getCategorySummary(sections.capital.nonStandard);
                                    const isSummaryOverBudget = summary.totalClaimed > summary.totalCosts;

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('wg-capital-ns-summary')" style="cursor: pointer; background: #dbeafe; font-weight: 600; border-top: 3px solid #3b82f6; ${isSummaryOverBudget ? 'background: #ffebee;' : ''}">
                                            <td colspan="4" style="text-align: right; padding-right: 15px;">üìä CATEGORY TOTAL:</td>
                                            <td>¬£${summary.totalCosts.toLocaleString()}</td>
                                            <td ${isSummaryOverBudget ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.totalClaimed.toLocaleString()}</td>
                                            <td ${summary.remaining < 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.remaining.toLocaleString()}</td>
                                            <td ${summary.difference > 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>${summary.difference.toFixed(1)}%</td>
                                        </tr>
                                        <tr id="wg-capital-ns-summary-breakdown" style="display: none;">
                                            <td colspan="8" style="padding: 0; background: #f1f5f9;">
                                                <div style="padding: 15px;">
                                                    <h4 style="margin: 0 0 10px 0; color: #3b82f6; font-size: 1em;">üìä Capital Non-Standard - Quarterly Breakdown</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #bfdbfe;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                <th>Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => {
                                                                    const qClaimed = summary.quarterlyTotals['q' + q.index] || 0;
                                                                    return `<td data-quarter="${q.index}" style="font-weight: 600;">¬£${qClaimed.toLocaleString()}</td>`;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #dbeafe;">¬£${summary.totalClaimed.toLocaleString()}</td>
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 700; color: ${summary.remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${summary.remaining.toLocaleString()}
                                                                </td>
                                                                <td style="font-weight: 700; background: #dbeafe; color: ${summary.remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${summary.remaining.toLocaleString()}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                })() : ''}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Build Revenue Non-Standard Costs table
            if (sections.revenue.nonStandard.length > 0) {
                financeHTML += `
                    <div class="card">
                        <h3>üìä Revenue - Non Standard Costs</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Item Code</th>
                                    <th>Item Description</th>
                                    <th>Total Cost</th>
                                    <th>Grant Rate</th>
                                    <th>Maximum Grant Value ¬£</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${sections.revenue.nonStandard.map((item, index) => {
                                    if (!item.totalCost && item.maxGrantValue) item.totalCost = item.maxGrantValue;
                                    initializeQuarterlyCosts(item);
                                    const costsClaimed = getTotalCostsClaimed(item);
                                    const remaining = getRemainingBudget(item);
                                    const difference = getDifferencePercentage(item);
                                    const isOverBudget = costsClaimed > item.maxGrantValue;

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('wg-revenue-ns-${index}')" style="cursor: pointer; ${isOverBudget && hasQuarters ? 'background: #fee;' : ''}">
                                            <td>${item.itemCode}</td>
                                            <td>${item.description}</td>
                                            <td>¬£${item.totalCost.toLocaleString()}</td>
                                            <td>${item.grantRate}%</td>
                                            <td>¬£${item.maxGrantValue.toLocaleString()}</td>
                                            ${hasQuarters ? `
                                                <td ${isOverBudget ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${costsClaimed.toLocaleString()}</td>
                                                <td ${remaining < 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${remaining.toLocaleString()}</td>
                                                <td ${difference > 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>${difference.toFixed(1)}%</td>
                                            ` : ''}
                                        </tr>
                                        ${hasQuarters ? `
                                        <tr id="wg-revenue-ns-${index}-breakdown" style="display: none;">
                                            <td colspan="8" style="padding: 0; background: #f8f9fa;">
                                                <div style="padding: 15px;">
                                                    <h4 style="margin: 0 0 10px 0; color: #64748b; font-size: 0.95em;">üìä Quarterly Breakdown - ${item.description}</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #e2e8f0;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => `
                                                                    <td data-quarter="${q.index}">
                                                                        <input
                                                                            type="number"
                                                                            value="${item.quarterlyCosts['q' + q.index] || 0}"
                                                                            onchange="updateQuarterlyCost(projectBudget.welshGovData.sections.revenue.nonStandard[${index}], ${q.index}, this.value); displayWelshGovBudget(projectBudget.welshGovData);"
                                                                            onclick="event.stopPropagation()"
                                                                            style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                                        />
                                                                    </td>
                                                                `).join('')}
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${remaining.toLocaleString()}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    ${(() => {
                                                        // Render transaction details for this Revenue Non-Standard item
                                                        if (cachedTransactions && cachedTransactions.length > 0) {
                                                            const itemTransactions = getTransactionsForItem(
                                                                cachedTransactions,
                                                                projectBudget.projectId,
                                                                'Revenue Non-Standard',
                                                                'revenueNonStandard-' + index,
                                                                null
                                                            );
                                                            return renderTransactionDetails(
                                                                itemTransactions,
                                                                projectBudget.projectId,
                                                                'Revenue Non-Standard',
                                                                'revenueNonStandard-' + index,
                                                                null,
                                                                cachedInvoices || []
                                                            );
                                                        }
                                                        return '';
                                                    })()}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    `;
                                }).join('')}

                                ${hasQuarters && sections.revenue.nonStandard.length > 0 ? (() => {
                                    const summary = getCategorySummary(sections.revenue.nonStandard);
                                    const isSummaryOverBudget = summary.totalClaimed > summary.totalCosts;

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('wg-revenue-ns-summary')" style="cursor: pointer; background: #dcfce7; font-weight: 600; border-top: 3px solid #22c55e; ${isSummaryOverBudget ? 'background: #ffebee;' : ''}">
                                            <td colspan="4" style="text-align: right; padding-right: 15px;">üìä CATEGORY TOTAL:</td>
                                            <td>¬£${summary.totalCosts.toLocaleString()}</td>
                                            <td ${isSummaryOverBudget ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.totalClaimed.toLocaleString()}</td>
                                            <td ${summary.remaining < 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.remaining.toLocaleString()}</td>
                                            <td ${summary.difference > 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>${summary.difference.toFixed(1)}%</td>
                                        </tr>
                                        <tr id="wg-revenue-ns-summary-breakdown" style="display: none;">
                                            <td colspan="8" style="padding: 0; background: #f1f5f9;">
                                                <div style="padding: 15px;">
                                                    <h4 style="margin: 0 0 10px 0; color: #22c55e; font-size: 1em;">üìä Revenue Non-Standard - Quarterly Breakdown</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #bbf7d0;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                <th>Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => {
                                                                    const qClaimed = summary.quarterlyTotals['q' + q.index] || 0;
                                                                    return `<td data-quarter="${q.index}" style="font-weight: 600;">¬£${qClaimed.toLocaleString()}</td>`;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #dcfce7;">¬£${summary.totalClaimed.toLocaleString()}</td>
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 700; color: ${summary.remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${summary.remaining.toLocaleString()}
                                                                </td>
                                                                <td style="font-weight: 700; background: #dcfce7; color: ${summary.remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${summary.remaining.toLocaleString()}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                })() : ''}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Build Revenue Standard Costs table
            if (sections.revenue.standardCosts.length > 0) {
                financeHTML += `
                    <div class="card">
                        <h3>üë• Revenue - Standard Costs</h3>
                        <table>
                            <tr>
                                <th>Item Code</th>
                                <th>Item Description</th>
                                <th>Item Details</th>
                                <th>Quantity</th>
                                <th>Grant Rate</th>
                                <th>Maximum Grant Value ¬£</th>
                            </tr>
                            ${sections.revenue.standardCosts.map(item => `
                                <tr>
                                    <td>${item.itemCode}</td>
                                    <td>${item.description}</td>
                                    <td>${item.itemDetails}</td>
                                    <td>${item.quantity} Hours</td>
                                    <td>¬£${item.grantRate}/Hour</td>
                                    <td>¬£${item.maxGrantValue.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                            <tr style="background: #f1f5f9; font-weight: 600;">
                                <td colspan="5" style="text-align: right;">Total Maximum Revenue Grant Value (Standard Costs)</td>
                                <td>¬£${sections.totals.totalRevenueStandard.toLocaleString()}</td>
                            </tr>
                        </table>
                    </div>
                `;
            }

            // Build Item Breakdown - Capital
            if (sections.itemBreakdown.capital.length > 0) {
                financeHTML += `
                    <div class="card">
                        <h3>üìã Item Breakdown - Capital</h3>
                        <table>
                            <tr>
                                <th>Item Code</th>
                                <th>Item Description</th>
                                <th>Item Details</th>
                                <th>Total Cost</th>
                                <th>Grant Rate</th>
                                <th>Maximum Grant Approved ¬£</th>
                                <th>*Claimable</th>
                            </tr>
                            ${sections.itemBreakdown.capital.map(item => `
                                <tr>
                                    <td>${item.itemCode}</td>
                                    <td>${item.description}</td>
                                    <td>${item.itemDetails}</td>
                                    <td>¬£${item.totalCost.toLocaleString()}</td>
                                    <td>${item.grantRate}%</td>
                                    <td>¬£${item.maxGrantApproved.toLocaleString()}</td>
                                    <td>${item.claimable ? 'Yes' : 'No'}</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                `;
            }

            // Build Item Breakdown - Revenue
            if (sections.itemBreakdown.revenue.length > 0) {
                financeHTML += `
                    <div class="card">
                        <h3>üìã Item Breakdown - Revenue</h3>
                        <table>
                            <tr>
                                <th>Item Code</th>
                                <th>Item Description</th>
                                <th>Item Details</th>
                                <th>Total Cost</th>
                                <th>Grant Rate</th>
                                <th>Maximum Grant Approved ¬£</th>
                                <th>*Claimable</th>
                            </tr>
                            ${sections.itemBreakdown.revenue.map(item => `
                                <tr>
                                    <td>${item.itemCode}</td>
                                    <td>${item.description}</td>
                                    <td>${item.itemDetails}</td>
                                    <td>¬£${item.totalCost.toLocaleString()}</td>
                                    <td>${item.grantRate}%</td>
                                    <td>¬£${item.maxGrantApproved.toLocaleString()}</td>
                                    <td>${item.claimable ? 'Yes' : 'No'}</td>
                                </tr>
                            `).join('')}
                        </table>
                        <p style="font-size: 0.85em; color: #64748b; margin-top: 10px; font-style: italic;">
                            * Claimable means quotes have been received and verified and/or field parcels have been provided, where applicable, for those items.
                        </p>
                    </div>
                `;
            }

            // Insert the built HTML (with null check)
            const financeSummarySection = document.getElementById('financeSummarySection');
            if (financeSummarySection) {
                financeSummarySection.innerHTML = financeHTML;
            } else {
                console.error('financeSummarySection element not found in DOM');
                addLog('‚ùå Error: Could not find financeSummarySection in page - check HTML structure');
            }
        }

        // Welsh Gov Budget Parser
        async function parseWelshGovBudget(inputText, parseBtn) {
            addLog('üìã Parsing Welsh Gov budget format...');
            addLog('‚ö†Ô∏è Note: Welsh Gov format does not include overhead calculations');

            try {
                // Parse the Welsh Gov format
                const welshGovData = await parseWelshGovFormat(inputText);

                // Store ONLY Welsh Gov data - clear all IUK category data
                projectBudget.fundingBody = 'Welsh Gov';
                projectBudget.welshGovData = welshGovData;
                projectBudget.financeSummary = welshGovData.financeSummary;
                projectBudget.lastModified = new Date().toISOString();

                // Clear ALL IUK-specific category data to prevent mixing
                projectBudget.labour = { staff: [], workingDaysPerYear: 0, totalCost: 0 };
                projectBudget.overheads = { items: [], totalCost: 0 };
                projectBudget.materials = { items: [], totalCost: 0 };
                projectBudget.capitalUsage = { items: [], totalCost: 0 };
                projectBudget.subcontracting = { contractors: [], totalCost: 0 };
                projectBudget.travel = { trips: [], totalCost: 0 };
                projectBudget.otherCosts = { items: [], totalCost: 0 };

                addLog('üßπ Cleared all IUK category data');
                addLog('üì¶ Welsh Gov categories: Capital, Revenue (Standard/Non-Standard), Item Breakdown');

                // Auto-save to IndexedDB
                addLog('üíæ Auto-saving to IndexedDB...');
                await saveToIndexedDB();

                addLog('üé® Rendering Welsh Gov budget view...');
                displayWelshGovBudget(welshGovData);

                document.getElementById('detailedBudgetResults').classList.add('show');
                addLog('‚úÖ Welsh Gov budget parsing complete!');

            } catch (error) {
                console.error('Welsh Gov parsing error:', error);
                addLog(`‚ùå Parsing failed: ${error.message}`);
                alert(`Failed to parse budget: ${error.message}`);
            } finally {
                parseBtn.disabled = false;
                parseBtn.innerHTML = '<span>üìä</span> <span id="parseBtnText">Parse Budget</span>';
            }
        }

        // Parse Welsh Gov format structure - REWRITTEN for flexibility
        async function parseWelshGovFormat(inputText) {
            addLog('üîç Extracting Welsh Gov sections...');
            console.log('Welsh Gov input text length:', inputText.length);

            const sections = {
                capital: { nonStandard: [], standardCosts: [] },
                revenue: { nonStandard: [], standardCosts: [] },
                itemBreakdown: { capital: [], revenue: [] },
                totals: {}
            };

            // Extract totals
            const totalCapitalMatch = inputText.match(/Total Maximum Capital Grant Value[^\d]+([\d,]+\.\d{2})/i);
            const totalRevenueNonStdMatch = inputText.match(/Total Maximum Revenue Grant Value \(Non Standard Costs\)[^\d]+([\d,]+\.\d{2})/i);
            const totalRevenueStdMatch = inputText.match(/Total Maximum Revenue Grant Value \(Standard Costs\)[^\d]+([\d,]+\.\d{2})/i);
            const totalRevenueMatch = inputText.match(/Total Maximum Revenue Grant Approved[^\d]+([\d,]+\.\d{2})/i);
            const totalGrantMatch = inputText.match(/Total Maximum Grant Approved[^\d]+([\d,]+\.\d{2})/i);

            sections.totals = {
                totalCapital: totalCapitalMatch ? parseFloat(totalCapitalMatch[1].replace(/,/g, '')) : 0,
                totalRevenueNonStandard: totalRevenueNonStdMatch ? parseFloat(totalRevenueNonStdMatch[1].replace(/,/g, '')) : 0,
                totalRevenueStandard: totalRevenueStdMatch ? parseFloat(totalRevenueStdMatch[1].replace(/,/g, '')) : 0,
                totalRevenueApproved: totalRevenueMatch ? parseFloat(totalRevenueMatch[1].replace(/,/g, '')) : 0,
                totalGrantApproved: totalGrantMatch ? parseFloat(totalGrantMatch[1].replace(/,/g, '')) : 0
            };

            console.log('Totals extracted:', sections.totals);

            // Track context - which section are we in?
            let inItemBreakdown = false;
            let inStandardCosts = false;
            let currentMainSection = 'revenue'; // default
            let currentBreakdownSection = '';

            const lines = inputText.split('\n');

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // Detect section headers
                if (/^Item Breakdown/i.test(line)) {
                    inItemBreakdown = true;
                    inStandardCosts = false;
                    continue;
                }
                if (/^Standard Costs/i.test(line)) {
                    inStandardCosts = true;
                    inItemBreakdown = false;
                    continue;
                }
                if (/^Non Standard Costs/i.test(line)) {
                    inStandardCosts = false;
                    inItemBreakdown = false;
                    continue;
                }

                // Track main sections (Capital/Revenue) within Item Breakdown
                if (inItemBreakdown) {
                    if (/^Capital\s*$/i.test(line)) {
                        currentBreakdownSection = 'capital';
                        continue;
                    }
                    if (/^Revenue\s*$/i.test(line)) {
                        currentBreakdownSection = 'revenue';
                        continue;
                    }
                }

                // Update main section tracking
                if (/capital/i.test(line) && !inItemBreakdown) currentMainSection = 'capital';
                if (/revenue/i.test(line) && !inItemBreakdown) currentMainSection = 'revenue';

                // Parse GF### items (Non-Standard and Standard Costs)
                if (line.match(/^GF\d{3}/)) {
                    const itemCode = line.match(/^(GF\d{3})/)[1];

                    // Gather all lines for this item until next item code or total
                    let itemText = line;
                    let j = i + 1;
                    while (j < lines.length) {
                        const nextLine = lines[j].trim();
                        if (/^GF\d{3}|^Total|^Item Code|^\d{3}aa/i.test(nextLine)) break;
                        itemText += ' ' + nextLine;
                        j++;
                    }

                    // Parse based on whether it's Standard Costs or Non-Standard
                    if (inStandardCosts) {
                        // Standard Costs format: Code | Description | Details | Quantity Hours | ¬£rate/Hour | ¬£maxGrant
                        const match = itemText.match(/GF\d{3}\s+(.+?)\s+(.+?)\s+(\d+)\s+Hours?\s+([\d,]+(?:\.\d+)?)\s*Hours?\s+¬£([\d.]+)\s*\/?\s*Hou[r]?\s+([\d,]+\.\d{2})/i);
                        if (match) {
                            sections.revenue.standardCosts.push({
                                itemCode: itemCode,
                                description: match[1].trim(),
                                itemDetails: match[2].trim(),
                                quantity: parseFloat(match[3]),
                                grantRate: parseFloat(match[5]),
                                maxGrantValue: parseFloat(match[6].replace(/,/g, ''))
                            });
                            console.log(`‚úÖ Parsed standard cost: ${itemCode}`);
                        }
                    } else {
                        // Non-Standard Costs format: Code | Description | ¬£cost | rate% | ¬£maxGrant
                        const match = itemText.match(/GF\d{3}\s+(.+?)\s+¬£([\d,]+\.\d{2})\s+([\d.]+)\s*%\s+([\d,]+\.\d{2})/);
                        if (match) {
                            const item = {
                                itemCode: itemCode,
                                description: match[1].trim(),
                                totalCost: parseFloat(match[2].replace(/,/g, '')),
                                grantRate: parseFloat(match[3]),
                                maxGrantValue: parseFloat(match[4].replace(/,/g, ''))
                            };

                            if (currentMainSection === 'capital') {
                                sections.capital.nonStandard.push(item);
                            } else {
                                sections.revenue.nonStandard.push(item);
                            }
                            console.log(`‚úÖ Parsed non-standard: ${itemCode} (${currentMainSection})`);
                        }
                    }

                    i = j - 1; // Skip processed lines
                    continue;
                }

                // Parse ###aa items (Item Breakdown)
                if (line.match(/^\d{3}aa\b/)) {
                    const itemCode = line.match(/^(\d{3}aa)/)[1];

                    // Gather all lines for this item
                    let itemText = line;
                    let j = i + 1;
                    while (j < lines.length) {
                        const nextLine = lines[j].trim();
                        if (/^\d{3}aa|^Item Code|^\*\s*Claimable|^CRN:/i.test(nextLine)) break;
                        itemText += ' ' + nextLine;
                        j++;
                    }

                    // Item Breakdown format: Code | Description | Details | ¬£cost | rate% | ¬£approved | Yes/No
                    const match = itemText.match(/\d{3}aa\s+(.+?)\s+(.+?)\s+¬£([\d,]+\.\d{2})\s+([\d.]+)\s*%\s+([\d,]+\.\d{2})\s+(Yes|No)/i);
                    if (match) {
                        const item = {
                            itemCode: itemCode,
                            description: match[1].trim(),
                            itemDetails: match[2].trim(),
                            totalCost: parseFloat(match[3].replace(/,/g, '')),
                            grantRate: parseFloat(match[4]),
                            maxGrantApproved: parseFloat(match[5].replace(/,/g, '')),
                            claimable: match[6] === 'Yes'
                        };

                        if (currentBreakdownSection === 'capital' || /capital/i.test(item.description)) {
                            sections.itemBreakdown.capital.push(item);
                            console.log(`‚úÖ Parsed capital breakdown: ${itemCode}`);
                        } else {
                            sections.itemBreakdown.revenue.push(item);
                            console.log(`‚úÖ Parsed revenue breakdown: ${itemCode}`);
                        }
                    } else {
                        console.log(`‚ö†Ô∏è Could not parse ${itemCode}:`, itemText.substring(0, 150));
                    }

                    i = j - 1; // Skip processed lines
                    continue;
                }
            }

            // Calculate finance summary - Welsh Gov specific (no 20% overhead rule)
            // Extract the actual grant rate from the first item (they're typically all the same)
            let avgGrantRate = 80; // Default
            if (sections.capital.nonStandard.length > 0) {
                avgGrantRate = sections.capital.nonStandard[0].grantRate;
            } else if (sections.revenue.nonStandard.length > 0) {
                avgGrantRate = sections.revenue.nonStandard[0].grantRate;
            } else if (sections.itemBreakdown.capital.length > 0) {
                avgGrantRate = sections.itemBreakdown.capital[0].grantRate;
            } else if (sections.itemBreakdown.revenue.length > 0) {
                avgGrantRate = sections.itemBreakdown.revenue[0].grantRate;
            }

            // If capital total wasn't found in totals, calculate from item breakdown
            if (sections.totals.totalCapital === 0 && sections.itemBreakdown.capital.length > 0) {
                sections.totals.totalCapital = sections.itemBreakdown.capital.reduce((sum, item) => sum + item.maxGrantApproved, 0);
                console.log('Calculated capital total from item breakdown:', sections.totals.totalCapital);
            }

            // Calculate total project costs from grant approved amount
            const totalProjectCosts = sections.totals.totalGrantApproved / (avgGrantRate / 100);

            const financeSummary = {
                fundingBody: 'Welsh Gov',
                totalCosts: sections.totals.totalGrantApproved,
                totalProjectCosts: totalProjectCosts,
                fundingLevel: avgGrantRate, // Use actual grant rate from data, not calculated
                projectDuration: 'See grant documentation',
                capitalTotal: sections.totals.totalCapital,
                revenueTotal: sections.totals.totalRevenueApproved
            };

            addLog(`‚úÖ Extracted ${sections.capital.nonStandard.length} capital items`);
            addLog(`‚úÖ Extracted ${sections.revenue.nonStandard.length} revenue non-standard items`);
            addLog(`‚úÖ Extracted ${sections.revenue.standardCosts.length} revenue standard cost items`);
            addLog(`‚úÖ Extracted ${sections.itemBreakdown.capital.length} capital breakdown items`);
            addLog(`‚úÖ Extracted ${sections.itemBreakdown.revenue.length} revenue breakdown items`);
            addLog(`‚úÖ Total grant approved: ¬£${sections.totals.totalGrantApproved.toLocaleString()}`);

            console.log('Final sections:', sections);

            return {
                sections,
                financeSummary
            };
        }

        // Auto-detect funding body format
        function detectFundingBodyFormat(inputText) {
            const lowerText = inputText.toLowerCase();

            // Welsh Gov indicators
            const hasItemCode = /item code/i.test(inputText);
            const hasGFCodes = /GF\d{3}/g.test(inputText);
            const hasNonStandardCosts = /non standard costs/i.test(inputText);
            const hasSchedule1a = /schedule 1a/i.test(inputText);
            const hasClaimable = /\*claimable/i.test(inputText);

            // Count Welsh Gov indicators
            const welshGovScore = [hasItemCode, hasGFCodes, hasNonStandardCosts, hasSchedule1a, hasClaimable].filter(Boolean).length;

            // IUK indicators
            const hasLabour = lowerText.includes('labour');
            const hasFinanceSummary = lowerText.includes('finance summary') || lowerText.includes('project duration');

            // Simple Summary format indicators (e.g., WWF grant)
            const hasSimpleCategories = (
                (lowerText.includes('labour') || lowerText.includes('labor')) &&
                (lowerText.includes('materials') || lowerText.includes('capuse') || lowerText.includes('subcon'))
            );
            const hasNoDetailedBreakdown = !lowerText.includes('finance summary') &&
                                          !lowerText.includes('project duration') &&
                                          !lowerText.includes('staff') &&
                                          !lowerText.includes('gross cost');
            const linesCount = inputText.split('\n').filter(line => line.trim()).length;
            const isSimpleSummary = hasSimpleCategories && hasNoDetailedBreakdown && linesCount <= 15;

            if (welshGovScore >= 3) {
                return 'welshgov';
            } else if (isSimpleSummary) {
                return 'simple_summary';
            } else if (hasLabour && hasFinanceSummary) {
                return 'iuk';
            }

            return 'unknown';
        }

        // Parse simple summary budget format (e.g., WWF grant)
        async function parseSimpleSummaryBudget(inputText, parseBtn) {
            addLog('üìã Detected: SIMPLE SUMMARY BUDGET FORMAT');
            addLog('üîç Parsing category totals...');

            try {
                // RESET projectBudget to default state
                projectBudget = {
                    projectNumber: '',
                    projectName: '',
                    fundingBody: '',
                    financeSummary: {
                        fundingBody: '',
                        projectStartMonth: null,
                        projectStartYear: null,
                        projectDurationMonths: null,
                        totalCosts: 0,
                        fundingLevel: 0,
                        fundingSought: 0,
                        otherPublicFunding: 0,
                        contribution: 0
                    },
                    labour: {
                        workingDaysPerYear: 232,
                        staff: [],
                        totalCost: 0,
                        hasPAYE: true
                    },
                    overheads: {
                        percentage: 20,
                        labourCosts: 0,
                        totalCost: 0
                    },
                    materials: {
                        items: [],
                        totalCost: 0
                    },
                    capitalUsage: {
                        items: [],
                        totalCost: 0
                    },
                    subcontracting: {
                        contractors: [],
                        totalCost: 0
                    },
                    travel: {
                        trips: [],
                        totalCost: 0
                    },
                    otherCosts: {
                        items: [],
                        totalCost: 0
                    }
                };
                addLog('‚úì Reset project budget structure');

                // Initialize totals
                let totalCosts = 0;
                const categories = {
                    labour: 0,
                    materials: 0,
                    capUse: 0,
                    subcon: 0,
                    travel: 0,
                    overheads: 0,
                    other: 0
                };

                // Parse each line
                const lines = inputText.split('\n').filter(line => line.trim());

                addLog(`üìù Processing ${lines.length} lines...`);

                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) continue;

                    // Try to extract category name and amount
                    // Format: "Category Name    Amount" (tabs or spaces)
                    // More flexible regex: handles tabs, multiple spaces, or even single space before number
                    const match = trimmedLine.match(/^(.+?)\s+(\d[\d,]*(?:\.\d{1,2})?)$/);

                    if (match) {
                        const categoryName = match[1].trim();
                        const category = categoryName.toLowerCase();
                        const amountStr = match[2].replace(/,/g, '');
                        const amount = parseFloat(amountStr);

                        addLog(`  ‚úì ${categoryName}: ¬£${amount.toLocaleString()}`);

                        // Map to correct category
                        if (category.includes('labour') || category.includes('labor')) {
                            categories.labour = amount;
                        } else if (category.includes('material')) {
                            categories.materials = amount;
                        } else if (category.includes('capuse') || category.includes('capital')) {
                            categories.capUse = amount;
                        } else if (category.includes('subcon')) {
                            categories.subcon = amount;
                        } else if (category.includes('travel') || category.includes('subs')) {
                            categories.travel = amount;
                        } else if (category.includes('indir') || category.includes('overh')) {
                            categories.overheads = amount;
                        } else if (category.includes('other')) {
                            categories.other = amount;
                        }

                        totalCosts += amount;
                    } else {
                        addLog(`  ‚ö†Ô∏è Could not parse line: "${trimmedLine}"`);
                    }
                }

                // Update projectBudget structure
                projectBudget.projectNumber = 'WWF-' + Date.now();
                projectBudget.projectName = 'WWF Grant';
                projectBudget.fundingBody = 'WWF';

                // Finance Summary
                projectBudget.financeSummary = {
                    fundingBody: 'WWF',
                    projectStartMonth: null,
                    projectStartYear: null,
                    projectDurationMonths: null,
                    totalCosts: totalCosts,
                    fundingLevel: 0,
                    fundingSought: 0,
                    otherPublicFunding: 0,
                    contribution: 0
                };

                // Labour
                projectBudget.labour = {
                    workingDaysPerYear: 232,
                    staff: [],
                    totalCost: categories.labour,
                    hasPAYE: true
                };

                // Overheads
                projectBudget.overheads = {
                    percentage: categories.labour > 0 ? (categories.overheads / categories.labour * 100) : 0,
                    labourCosts: categories.labour,
                    totalCost: categories.overheads
                };

                // Materials
                projectBudget.materials = {
                    items: [],
                    totalCost: categories.materials
                };

                // Capital Usage
                projectBudget.capitalUsage = {
                    items: [],
                    totalCost: categories.capUse
                };

                // Subcontracting
                projectBudget.subcontracting = {
                    contractors: [],
                    totalCost: categories.subcon
                };

                // Travel
                projectBudget.travel = {
                    trips: [],
                    totalCost: categories.travel
                };

                // Other Costs
                projectBudget.otherCosts = {
                    items: [],
                    totalCost: categories.other
                };

                // Clear any Welsh Gov data
                if (projectBudget.welshGovData) {
                    delete projectBudget.welshGovData;
                }

                addLog('‚úÖ Simple summary budget parsed successfully!');
                addLog(`üìä Total Costs: ¬£${totalCosts.toLocaleString()}`);
                addLog(`   ‚Ä¢ Labour: ¬£${categories.labour.toLocaleString()}`);
                addLog(`   ‚Ä¢ Materials: ¬£${categories.materials.toLocaleString()}`);
                addLog(`   ‚Ä¢ Capital: ¬£${categories.capUse.toLocaleString()}`);
                addLog(`   ‚Ä¢ Subcontracting: ¬£${categories.subcon.toLocaleString()}`);
                addLog(`   ‚Ä¢ Travel: ¬£${categories.travel.toLocaleString()}`);
                addLog(`   ‚Ä¢ Overheads: ¬£${categories.overheads.toLocaleString()}`);
                addLog(`   ‚Ä¢ Other: ¬£${categories.other.toLocaleString()}`);

                addLog('üíæ Auto-saving to IndexedDB...');
                await saveToIndexedDB();

                addLog('üé® Rendering detailed budget view...');
                displayDetailedBudget();

            } catch (error) {
                console.error('Error parsing simple summary budget:', error);
                addLog(`‚ùå Error: ${error.message}`);
                alert('Failed to parse simple summary budget. Please check the format and try again.');
            } finally {
                // Re-enable button
                parseBtn.disabled = false;
                parseBtn.innerHTML = 'ü§ñ Parse Budget with AI';
            }
        }

        async function parseBudget() {
            console.log('üöÄ parseBudget() function called');

            const inputText = document.getElementById('budgetInput').value.trim();
            console.log('Input text length:', inputText.length);

            if (!inputText) {
                console.log('No input text provided');
                alert('Please paste some budget text to parse.');
                return;
            }

            // Reset
            logs = [];
            document.getElementById('results').classList.remove('show');
            console.log('Reset complete');

            // Note: System Log stays collapsed by default - user can click to expand if needed
            console.log('System log available (click to expand)');

            // Disable button
            const parseBtn = document.getElementById('parseBtn');
            parseBtn.disabled = true;
            parseBtn.innerHTML = '<div class="spinner"></div> Processing...';

            addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            addLog('üöÄ Starting budget parsing process...');
            addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            // Determine funding body format
            let fundingBodyFormat = selectedFundingBody;

            if (selectedFundingBody === 'auto') {
                fundingBodyFormat = detectFundingBodyFormat(inputText);
                addLog(`üîç Auto-detected format: ${fundingBodyFormat.toUpperCase()}`);
            } else {
                addLog(`üìã Using selected format: ${fundingBodyFormat.toUpperCase()}`);
            }

            // Route to appropriate parser
            if (fundingBodyFormat === 'welshgov') {
                await parseWelshGovBudget(inputText, parseBtn);
                return;
            }

            if (fundingBodyFormat === 'simple_summary') {
                await parseSimpleSummaryBudget(inputText, parseBtn);
                return;
            }

            // Detect input type for IUK format
            const isDetailedBudget = inputText.toLowerCase().includes('labour') &&
                                    (inputText.toLowerCase().includes('finance summary') ||
                                     inputText.toLowerCase().includes('project duration'));

            try {
                if (isDetailedBudget) {
                    // DETAILED BUDGET PARSING (Parallel AI requests)
                    addLog('üìã Detected: DETAILED PROJECT BUDGET');
                    addLog('üîÑ Launching 6 parallel AI parsing requests...');

                    // Extract project info from first line if available
                    const firstLine = inputText.split('\n')[0];
                    console.log('First line of input:', firstLine);
                    addLog(`üìù First line: ${firstLine.substring(0, 100)}...`);

                    if (firstLine.includes(':')) {
                        const parts = firstLine.split(':');
                        projectBudget.projectNumber = parts[0].trim();
                        projectBudget.projectName = parts[1] ? parts[1].trim() : '';
                        console.log('Extracted projectNumber:', projectBudget.projectNumber);
                        console.log('Extracted projectName:', projectBudget.projectName);
                        addLog(`üìå Project Number: ${projectBudget.projectNumber}`);
                        addLog(`üìå Project Name: ${projectBudget.projectName}`);
                    } else {
                        console.log('First line does not contain ":", setting defaults');
                        projectBudget.projectNumber = 'PROJ-' + Date.now();
                        projectBudget.projectName = 'Unnamed Project';
                        addLog(`‚ö†Ô∏è No project identifier found in first line, using defaults`);
                        addLog(`üìå Default Project Number: ${projectBudget.projectNumber}`);
                    }

                    // Create 6 parallel AI requests
                    const promises = [
                        parseSection('financeSummary', inputText),
                        parseSection('labour', inputText),
                        parseSection('overheads', inputText),
                        parseSection('materials', inputText),
                        parseSection('capitalSubcontracting', inputText),
                        parseSection('travelOther', inputText)
                    ];

                    // Wait for all to complete
                    addLog('‚è≥ Waiting for all sections to parse...');
                    const results = await Promise.all(promises);
                    addLog('‚úÖ All sections parsed successfully!');

                    // Merge results into projectBudget
                    results.forEach(result => {
                        if (result.section === 'financeSummary') {
                            projectBudget.financeSummary = result.data;
                        } else if (result.section === 'labour') {
                            projectBudget.labour = result.data;
                        } else if (result.section === 'overheads') {
                            projectBudget.overheads = result.data;
                        } else if (result.section === 'materials') {
                            projectBudget.materials = result.data;
                        } else if (result.section === 'capitalSubcontracting') {
                            projectBudget.capitalUsage = result.data.capitalUsage;
                            projectBudget.subcontracting = result.data.subcontracting;
                        } else if (result.section === 'travelOther') {
                            projectBudget.travel = result.data.travel;
                            projectBudget.otherCosts = result.data.otherCosts;
                        }
                    });

                    // Set funding body for IUK projects
                    projectBudget.fundingBody = 'Innovate UK';

                    // Clear any Welsh Gov data to prevent mixing
                    if (projectBudget.welshGovData) {
                        delete projectBudget.welshGovData;
                    }

                    addLog('üìä Merged all data into project budget');
                    console.log('Project Budget after merge:', projectBudget);
                    console.log('projectBudget.projectName:', projectBudget.projectName);
                    console.log('projectBudget.projectNumber:', projectBudget.projectNumber);
                    console.log('projectBudget.financeSummary:', projectBudget.financeSummary);

                    addLog(`‚úÖ Project Budget Complete:`);
                    addLog(`   ‚Ä¢ Project: ${projectBudget.projectName || projectBudget.projectNumber || 'Unknown'}`);
                    addLog(`   ‚Ä¢ Total Cost: ¬£${projectBudget.financeSummary?.totalCosts || 0}`);
                    addLog(`   ‚Ä¢ Labour: ${projectBudget.labour?.staff?.length || 0} staff members`);
                    addLog(`   ‚Ä¢ Materials: ${projectBudget.materials?.items?.length || 0} items`);

                    addLog('üíæ Auto-saving to IndexedDB...');

                    // Auto-save to IndexedDB
                    await saveToIndexedDB();

                    addLog('üé® Rendering detailed budget view...');
                    // Display detailed budget
                    displayDetailedBudget();

                } else {
                    // SIMPLE QUARTERLY FORECAST PARSING (Old AI method)
                    addLog('üìã Detected: QUARTERLY FORECAST DATA');
                    addLog('ü§ñ Using standard AI parser...');

                    budgetData = [];

                    // Use the old AI parsing method (simplified version)
                    const apiKey = getAPIKey();
                    if (!apiKey) {
                        throw new Error('OpenAI API key not configured. Please set it in the settings.');
                    }

                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o',
                            messages: [{
                                role: 'system',
                                content: 'You are a budget parsing assistant. Parse budget text into JSON arrays with accurate categorization and cost extraction.'
                            }, {
                                role: 'user',
                                content: `Parse this budget text into JSON array format with Q1-Q4 quarterly data. Return ONLY valid JSON, no markdown.

Budget text:
${inputText}`
                            }],
                            temperature: 0.1,
                            max_tokens: 4096
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`API request failed: ${response.status}`);
                    }

                    const data = await response.json();
                    let responseText = data.choices[0].message.content.trim();

                    // Clean markdown
                    if (responseText.startsWith('```json')) {
                        responseText = responseText.replace(/^```json\n?/, '').replace(/\n?```$/, '');
                    } else if (responseText.startsWith('```')) {
                        responseText = responseText.replace(/^```\n?/, '').replace(/\n?```$/, '');
                    }

                    budgetData = JSON.parse(responseText);

                    // Add IDs
                    budgetData = budgetData.map((item, index) => ({
                        id: Date.now() + index,
                        ...item
                    }));

                    addLog(`‚úÖ Successfully parsed ${budgetData.length} budget items!`);

                    displayResults();
                    document.getElementById('results').classList.add('show');
                }

                addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                addLog('‚ú® Processing complete!');
                addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            } catch (error) {
                console.error('‚ùå PARSING ERROR:', error);
                addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                addLog(`‚ùå ERROR: ${error.message}`);
                addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                alert(`Parsing failed: ${error.message}`);
            } finally {
                console.log('Finally block: Re-enabling button');
                parseBtn.disabled = false;
                parseBtn.innerHTML = '<span>üìä</span> Parse Budget';
            }
        }

        function displayResults() {
            // Group by category
            const grouped = budgetData.reduce((acc, item) => {
                const cat = item.category || 'Other';
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(item);
                return acc;
            }, {});

            // Calculate totals
            const categoryTotals = {};
            let grandTotalEligible = 0;
            let grandTotalSpent = 0;
            let grandDifference = 0;

            for (const [category, items] of Object.entries(grouped)) {
                const totalEligible = items.reduce((sum, item) => sum + (item.totalEligible || item.forecast || 0), 0);
                const totalSpent = items.reduce((sum, item) => sum + (item.totalSpent || (item.q1 || 0) + (item.q2 || 0) + (item.q3 || 0) + (item.q4 || 0)), 0);
                const difference = totalEligible - totalSpent;
                
                categoryTotals[category] = { totalEligible, totalSpent, difference, count: items.length };
                grandTotalEligible += totalEligible;
                grandTotalSpent += totalSpent;
                grandDifference += difference;
            }

            // Display summary
            let summaryHTML = `
                <div class="summary-card total">
                    <div class="summary-category">üí∞ Total Eligible</div>
                    <div class="summary-amount">¬£${grandTotalEligible.toLocaleString()}</div>
                    <div class="summary-count">${budgetData.length} items</div>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                    <div class="summary-category" style="color: #1565c0;">üí≥ Total Spent</div>
                    <div class="summary-amount" style="color: #0d47a1;">¬£${grandTotalSpent.toLocaleString()}</div>
                    <div class="summary-count" style="color: #1976d2;">${((grandTotalSpent / grandTotalEligible) * 100).toFixed(1)}% of eligible</div>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, ${grandDifference < 0 ? '#ffebee 0%, #ffcdd2 100%' : '#e8f5e9 0%, #c8e6c9 100%'});">
                    <div class="summary-category" style="color: ${grandDifference < 0 ? '#c62828' : '#2e7d32'};">üíé Remaining</div>
                    <div class="summary-amount" style="color: ${grandDifference < 0 ? '#b71c1c' : '#1b5e20'};">¬£${grandDifference.toLocaleString()}</div>
                    <div class="summary-count" style="color: ${grandDifference < 0 ? '#d32f2f' : '#388e3c'};">${grandDifference < 0 ? 'OVER BUDGET!' : 'Within budget'}</div>
                </div>
            `;

            for (const [category, stats] of Object.entries(categoryTotals)) {
                const badgeClass = `badge-${category.toLowerCase().replace(' ', '')}`;
                const pct = stats.totalEligible > 0 ? ((stats.totalSpent / stats.totalEligible) * 100).toFixed(0) : 0;
                summaryHTML += `
                    <div class="summary-card">
                        <div class="category-badge ${badgeClass}">${category}</div>
                        <div class="summary-amount" style="font-size: 1.3em;">¬£${stats.totalEligible.toLocaleString()}</div>
                        <div class="summary-count">Eligible | ¬£${stats.totalSpent.toLocaleString()} spent (${pct}%)</div>
                    </div>
                `;
            }

            document.getElementById('summaryGrid').innerHTML = summaryHTML;

            // Display tables
            let tablesHTML = '';
            for (const [category, items] of Object.entries(grouped)) {
                const badgeClass = `badge-${category.toLowerCase().replace(' ', '')}`;
                const categoryStats = categoryTotals[category];
                const totalEligible = categoryStats.totalEligible;

                tablesHTML += `
                    <div class="category-section">
                        <div class="category-header">
                            <span class="category-badge ${badgeClass}">${category}</span>
                            <span class="category-total">¬£${totalEligible.toLocaleString()} eligible | ¬£${categoryStats.totalSpent.toLocaleString()} spent</span>
                        </div>
                        <table style="font-size: 0.85em;">
                            <thead>
                                <tr>
                                    <th style="width: 180px">Description</th>
                                    <th style="width: 60px">Qty</th>
                                    <th style="width: 50px">Unit</th>
                                    <th style="width: 80px">Unit ¬£</th>
                                    <th style="width: 90px; background: #e8f5e9;">Forecast</th>
                                    <th style="width: 75px; background: #fff3e0;">Q1</th>
                                    <th style="width: 75px; background: #fff3e0;">Q2</th>
                                    <th style="width: 75px; background: #fff3e0;">Q3</th>
                                    <th style="width: 75px; background: #fff3e0;">Q4</th>
                                    <th style="width: 100px; background: #e3f2fd; font-weight: 700;">Total Spent</th>
                                    <th style="width: 110px; background: #fff9c4; font-weight: 700;">Total Eligible</th>
                                    <th style="width: 100px; background: #fce4ec; font-weight: 700;">Difference</th>
                                    <th style="width: 120px">Notes</th>
                                    <th style="width: 35px"></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => {
                                    const forecast = item.forecast || item.totalCost || 0;
                                    const q1 = item.q1 || 0;
                                    const q2 = item.q2 || 0;
                                    const q3 = item.q3 || 0;
                                    const q4 = item.q4 || 0;
                                    const totalSpent = item.totalSpent || (q1 + q2 + q3 + q4);
                                    const totalEligible = item.totalEligible || forecast;
                                    const difference = item.difference !== undefined ? item.difference : (totalEligible - totalSpent);
                                    const rowStyle = difference < 0 ? 'background-color: #ffebee;' : '';

                                    return `
                                    <tr data-id="${item.id}" style="${rowStyle}">
                                        <td><input type="text" value="${item.description || ''}" onchange="updateItem(${item.id}, 'description', this.value)" style="font-size: 0.9em;"></td>
                                        <td><input type="number" value="${item.quantity || ''}" onchange="updateItem(${item.id}, 'quantity', parseFloat(this.value))" style="font-size: 0.9em;"></td>
                                        <td><input type="text" value="${item.unit || ''}" onchange="updateItem(${item.id}, 'unit', this.value)" style="font-size: 0.9em;"></td>
                                        <td><input type="number" value="${item.unitCost || ''}" onchange="updateItem(${item.id}, 'unitCost', parseFloat(this.value))" style="font-size: 0.9em;"></td>
                                        <td style="background: #f1f8e9;"><input type="number" value="${forecast}" onchange="updateItemAndRecalc(${item.id}, 'forecast', parseFloat(this.value))" style="font-weight: 600; background: #f1f8e9; font-size: 0.9em;"></td>
                                        <td style="background: #fff8e1;"><input type="number" value="${q1}" onchange="updateItemAndRecalc(${item.id}, 'q1', parseFloat(this.value) || 0)" style="font-size: 0.9em;"></td>
                                        <td style="background: #fff8e1;"><input type="number" value="${q2}" onchange="updateItemAndRecalc(${item.id}, 'q2', parseFloat(this.value) || 0)" style="font-size: 0.9em;"></td>
                                        <td style="background: #fff8e1;"><input type="number" value="${q3}" onchange="updateItemAndRecalc(${item.id}, 'q3', parseFloat(this.value) || 0)" style="font-size: 0.9em;"></td>
                                        <td style="background: #fff8e1;"><input type="number" value="${q4}" onchange="updateItemAndRecalc(${item.id}, 'q4', parseFloat(this.value) || 0)" style="font-size: 0.9em;"></td>
                                        <td style="background: #e1f5fe;"><input type="number" value="${totalSpent}" onchange="updateItemAndRecalc(${item.id}, \'totalSpent\', parseFloat(this.value) || 0)" style="font-weight: 600; background: #e1f5fe; font-size: 0.9em;"></td>
                                        <td style="background: #fff9e0;"><input type="number" value="${totalEligible}" onchange="updateItemAndRecalc(${item.id}, 'totalEligible', parseFloat(this.value) || 0)" style="font-weight: 600; background: #fff9e0; font-size: 0.9em;"></td>
                                        <td style="background: ${difference < 0 ? '#ffcdd2' : '#f3e5f5'}; font-weight: 600; color: ${difference < 0 ? '#c62828' : '#4a148c'}; text-align: right; padding-right: 8px; font-size: 0.9em;">¬£${difference.toLocaleString()}</td>
                                        <td><input type="text" value="${item.notes || ''}" onchange="updateItem(${item.id}, 'notes', this.value)" style="font-size: 0.9em;"></td>
                                        <td><button class="btn-danger" onclick="deleteItem(${item.id})" style="font-size: 0.8em; padding: 4px;">üóëÔ∏è</button></td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            document.getElementById('tablesContainer').innerHTML = tablesHTML;
            document.getElementById('results').classList.add('show');
        }

        function displayDetailedBudget() {
            console.log('üìä [DISPLAY] Displaying detailed budget');
            console.log('üìä [DISPLAY] Funding Body:', projectBudget.fundingBody);
            addLog('üé® Rendering detailed budget sections...');

            // Check if this is a Welsh Gov project
            const isWelshGov = projectBudget.fundingBody === 'Welsh Gov' || projectBudget.welshGovData;

            if (isWelshGov) {
                console.log('üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø [DISPLAY] Detected Welsh Gov project, using Welsh Gov renderer');

                if (projectBudget.welshGovData) {
                    displayWelshGovBudget(projectBudget.welshGovData);
                    document.getElementById('detailedBudgetResults').classList.add('show');
                    addLog('‚úÖ Welsh Gov budget displayed');
                } else {
                    console.warn('‚ö†Ô∏è [DISPLAY] Welsh Gov project but no welshGovData found');
                    addLog('‚ö†Ô∏è Welsh Gov data missing - may need to re-parse');
                }
                return;
            }

            // IUK project rendering
            console.log('üá¨üáß [DISPLAY] Detected IUK project, using IUK renderer');

            // Populate project name and number input fields
            const projectNameInput = document.getElementById('projectNameInput');
            const projectNumberInput = document.getElementById('projectNumberInput');
            if (projectNameInput) {
                projectNameInput.value = projectBudget.projectName || '';
            }
            if (projectNumberInput) {
                projectNumberInput.value = projectBudget.projectNumber || '';
            }

            // For now, create a simple display
            const detailedResults = document.getElementById('detailedBudgetResults');
            if (!detailedResults) {
                console.error('detailedBudgetResults element not found!');
                alert('Note: Detailed budget HTML structure not yet added. Data is parsed and saved successfully!\n\nCheck console for projectBudget object.');
                console.log('PROJECT BUDGET DATA:', projectBudget);
                return;
            }

            // Finance Summary with null checks for IUK
            const financeSummary = document.getElementById('financeSummarySection');
            if (financeSummary) {
                const fs = projectBudget.financeSummary || {};

                // Generate month options
                const months = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
                const monthOptions = months.map((m, i) =>
                    `<option value="${i+1}" ${fs.projectStartMonth === i+1 ? 'selected' : ''}>${m}</option>`
                ).join('');

                // Generate year options (current year - 5 to current year + 5)
                const currentYear = new Date().getFullYear();
                const yearOptions = [];
                for (let y = currentYear - 5; y <= currentYear + 5; y++) {
                    yearOptions.push(`<option value="${y}" ${fs.projectStartYear === y ? 'selected' : ''}>${y}</option>`);
                }

                financeSummary.innerHTML = `
                    <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.1em; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2em;">üí∞</span>
                            Finance Summary
                        </h3>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px;">
                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px; border-left: 3px solid #3b82f6;">
                                <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Duration</div>
                                <div style="font-size: 1.1em; font-weight: 600; color: #1e293b;">${fs.projectDuration || 'N/A'}</div>
                            </div>

                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px; border-left: 3px solid #10b981;">
                                <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Total Costs</div>
                                <div style="font-size: 1.1em; font-weight: 600; color: #1e293b;">¬£${(fs.totalCosts || 0).toLocaleString()}</div>
                            </div>

                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px; border-left: 3px solid #f59e0b;">
                                <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Funding Level</div>
                                <div style="font-size: 1.1em; font-weight: 600; color: #1e293b;">${fs.fundingLevel || 0}%</div>
                            </div>

                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px; border-left: 3px solid #8b5cf6;">
                                <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Funding Sought</div>
                                <div style="font-size: 1.1em; font-weight: 600; color: #1e293b;">¬£${(fs.fundingSought || 0).toLocaleString()}</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 12px; align-items: center; padding: 12px; background: #f8fafc; border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.85em; color: #64748b; font-weight: 500; white-space: nowrap;">Project Start:</label>
                                <select id="projectStartMonth" onchange="updateProjectStartDate()" style="padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.9em; background: white;">
                                    <option value="">Month</option>
                                    ${monthOptions}
                                </select>
                                <select id="projectStartYear" onchange="updateProjectStartDate()" style="padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.9em; background: white;">
                                    <option value="">Year</option>
                                    ${yearOptions.join('')}
                                </select>
                            </div>

                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.85em; color: #64748b; font-weight: 500; white-space: nowrap;">Duration:</label>
                                <input type="number" id="projectDurationMonths" value="${fs.projectDurationMonths || ''}"
                                       min="1" max="120" onchange="updateProjectDuration()"
                                       style="width: 70px; padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.9em;"
                                       placeholder="12">
                                <span style="font-size: 0.85em;">months</span>
                                ${fs.projectStartMonth && fs.projectDurationMonths ?
                                    `<span style="color: #64748b; font-size: 0.85em;">(Ends: ${calculateEndDate(fs.projectStartMonth, fs.projectStartYear, fs.projectDurationMonths)})</span>` :
                                    ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Calculate quarters once for all sections
            const quarters = calculateQuarters();
            const hasQuarters = quarters.length > 0;
            const currentQuarter = getCurrentQuarter();

            // Quarter Controls Section
            const quarterControlsSection = document.getElementById('quarterControlsSection');
            if (quarterControlsSection) {

                if (quarters.length > 0) {
                    let quarterControlsHTML = `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; padding: 16px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 style="color: white; margin: 0; font-size: 1em; display: flex; align-items: center; gap: 8px;">
                                    <span>üìÖ</span>
                                    Quarterly Budget Tracking
                                </h3>
                                ${currentQuarter ? `
                                    <span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 0.8em; color: white; font-weight: 500;">
                                        üîî Current: Q${currentQuarter}
                                    </span>
                                ` : ''}
                            </div>

                            <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 12px;">
                                <span style="font-size: 0.85em; color: white; font-weight: 500; opacity: 0.9;">Activate Quarter:</span>
                    `;

                    quarters.forEach(quarter => {
                        const isCurrentQuarter = currentQuarter === quarter.index;
                        const isActive = activeQuarterIndex === quarter.index;

                        quarterControlsHTML += `
                            <button
                                class="quarter-activate-btn"
                                data-quarter="${quarter.index}"
                                onclick="setActiveQuarter(${quarter.index})"
                                style="
                                    padding: 6px 14px;
                                    border-radius: 6px;
                                    border: ${isActive ? '2px solid #ff9800' : (isCurrentQuarter ? '2px solid #4caf50' : '1px solid rgba(255,255,255,0.3)')};
                                    background: ${isActive ? '#ff9800' : (isCurrentQuarter ? '#4caf50' : 'rgba(255,255,255,0.15)')};
                                    color: white;
                                    font-weight: 600;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                    font-size: 0.85em;
                                    backdrop-filter: blur(10px);
                                "
                                onmouseover="if(${!isActive}) this.style.background='rgba(255,255,255,0.25)'"
                                onmouseout="if(${!isActive}) this.style.background='${isCurrentQuarter ? '#4caf50' : 'rgba(255,255,255,0.15)'}'"
                            >
                                ${quarter.label}${isCurrentQuarter && !isActive ? ' üîî' : ''}
                            </button>
                        `;
                    });

                    quarterControlsHTML += `
                            </div>

                            <button
                                onclick="toggleBudgetSummaryOverview()"
                                style="
                                    width: 100%;
                                    padding: 10px 16px;
                                    background: white;
                                    color: #667eea;
                                    border: none;
                                    border-radius: 6px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                    font-size: 0.9em;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 8px;
                                "
                                onmouseover="this.style.background='#f8fafc'"
                                onmouseout="this.style.background='white'"
                            >
                                <span>üìä</span>
                                <span>Show Budget Summary Overview</span>
                            </button>
                        </div>
                    `;

                    quarterControlsSection.innerHTML = quarterControlsHTML;
                } else {
                    quarterControlsSection.innerHTML = `
                        <div style="background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 16px; margin-bottom: 15px; text-align: center;">
                            <p style="margin: 0; color: #64748b; font-size: 0.9em;">
                                ‚ÑπÔ∏è Set Project Start Date and Duration in Finance Summary to enable quarterly tracking
                            </p>
                        </div>
                    `;
                }
            }

            // Labour Section
            const labourSection = document.getElementById('labourSection');
            if (labourSection && projectBudget.labour.staff.length > 0) {
                let labourHTML = `
                    <div class="category-section">
                        <h3>üë• Labour (¬£${projectBudget.labour.totalCost.toLocaleString()})</h3>
                        <p>Working days per year: ${projectBudget.labour.workingDaysPerYear}</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Role</th>
                                    <th>Gross Cost</th>
                                    <th>Rate/Day</th>
                                    <th>Days</th>
                                    <th>Total</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                `;

                projectBudget.labour.staff.forEach((staff, index) => {
                    initializeQuarterlyCosts(staff);
                    const costsClaimed = getTotalCostsClaimed(staff);
                    const remaining = getRemainingBudget(staff);
                    const difference = getDifferencePercentage(staff);
                    const isOverBudget = costsClaimed > staff.totalCost;

                    labourHTML += `
                        <tr onclick="toggleQuarterlyBreakdown('labour-${index}')" style="cursor: pointer; ${isOverBudget && hasQuarters ? 'background: #fee;' : ''}">
                            <td>${staff.role}</td>
                            <td>¬£${staff.grossCost.toLocaleString()}</td>
                            <td>¬£${staff.ratePerDay}</td>
                            <td>${staff.days}</td>
                            <td>¬£${staff.totalCost.toLocaleString()}</td>
                            ${hasQuarters ? `
                                <td ${isOverBudget ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${costsClaimed.toLocaleString()}</td>
                                <td ${remaining < 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${remaining.toLocaleString()}</td>
                                <td ${difference > 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>${difference.toFixed(1)}%</td>
                            ` : ''}
                        </tr>
                        ${hasQuarters ? `
                        <tr id="labour-${index}-breakdown" style="display: none;">
                            <td colspan="${hasQuarters ? '8' : '5'}" style="padding: 0; background: #f8f9fa;">
                                <div style="padding: 15px;">
                                    <h4 style="margin: 0 0 10px 0; color: #64748b; font-size: 0.95em;">üìä Quarterly Breakdown - ${staff.role}</h4>
                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                        <thead>
                                            <tr style="background: #e2e8f0;">
                                                <th style="width: 150px;">Metric</th>
                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                ${quarters.map(q => `
                                                    <td data-quarter="${q.index}">
                                                        <input
                                                            type="number"
                                                            value="${staff.quarterlyCosts[`q${q.index}`] || 0}"
                                                            onchange="updateQuarterlyCost(projectBudget.labour.staff[${index}], ${q.index}, this.value); displayDetailedBudget();"
                                                            onclick="event.stopPropagation()"
                                                            style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                        />
                                                    </td>
                                                `).join('')}
                                            </tr>
                                            <tr style="background: #f1f5f9;">
                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                    ¬£${remaining.toLocaleString()}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 600;">Difference (%)</td>
                                                <td colspan="${quarters.length}" style="font-weight: 600; color: ${difference > 0 ? '#d32f2f' : '#2e7d32'};">
                                                    ${difference.toFixed(1)}%
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                        ` : ''}
                    `;
                });

                // Add category summary row
                if (hasQuarters) {
                    const summary = getCategorySummary(projectBudget.labour.staff);
                    const isSummaryOverBudget = summary.totalClaimed > summary.totalCosts;

                    labourHTML += `
                        <tr onclick="toggleQuarterlyBreakdown('labour-summary')" style="cursor: pointer; background: #e3f2fd; font-weight: 600; border-top: 3px solid #1976d2; ${isSummaryOverBudget ? 'background: #ffebee;' : ''}">
                            <td colspan="4" style="text-align: right; padding-right: 15px;">üìä LABOUR CATEGORY TOTAL:</td>
                            <td>¬£${summary.totalCosts.toLocaleString()}</td>
                            <td ${isSummaryOverBudget ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.totalClaimed.toLocaleString()}</td>
                            <td ${summary.remaining < 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.remaining.toLocaleString()}</td>
                            <td ${summary.difference > 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>${summary.difference.toFixed(1)}%</td>
                        </tr>
                        <tr id="labour-summary-breakdown" style="display: none;">
                            <td colspan="8" style="padding: 0; background: #f1f5f9;">
                                <div style="padding: 15px;">
                                    <h4 style="margin: 0 0 10px 0; color: #1976d2; font-size: 1em;">üìä Labour Category - Quarterly Breakdown</h4>
                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                        <thead>
                                            <tr style="background: #bbdefb;">
                                                <th style="width: 150px;">Metric</th>
                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                ${quarters.map(q => {
                                                    const qClaimed = summary.quarterlyTotals[`q${q.index}`] || 0;
                                                    return `<td data-quarter="${q.index}" style="font-weight: 600;">¬£${qClaimed.toLocaleString()}</td>`;
                                                }).join('')}
                                                <td style="font-weight: 700; background: #e3f2fd;">¬£${summary.totalClaimed.toLocaleString()}</td>
                                            </tr>
                                            <tr style="background: #f1f5f9;">
                                                <td style="font-weight: 600;">Total Budget</td>
                                                <td colspan="${quarters.length}" style="font-weight: 600;">
                                                    ¬£${summary.totalCosts.toLocaleString()}
                                                </td>
                                                <td style="font-weight: 700; background: #e3f2fd;">¬£${summary.totalCosts.toLocaleString()}</td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                <td colspan="${quarters.length}" style="font-weight: 700; color: ${summary.remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                    ¬£${summary.remaining.toLocaleString()}
                                                </td>
                                                <td style="font-weight: 700; background: #e3f2fd; color: ${summary.remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                    ¬£${summary.remaining.toLocaleString()}
                                                </td>
                                            </tr>
                                            <tr style="background: #f1f5f9;">
                                                <td style="font-weight: 600;">Difference (%)</td>
                                                <td colspan="${quarters.length}" style="font-weight: 700; color: ${summary.difference > 0 ? '#d32f2f' : '#2e7d32'};">
                                                    ${summary.difference.toFixed(1)}%
                                                </td>
                                                <td style="font-weight: 700; background: #e3f2fd; color: ${summary.difference > 0 ? '#d32f2f' : '#2e7d32'};">
                                                    ${summary.difference.toFixed(1)}%
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                    `;
                }

                labourHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                labourSection.innerHTML = labourHTML;
            }

            // Overheads & Materials Section
            const overheadsMaterialsSection = document.getElementById('overheadsMaterialsSection');
            if (overheadsMaterialsSection) {
                let overheadsMaterialsHTML = `
                    <div class="category-section">
                        <h3>üíº Overhead Costs (¬£${projectBudget.overheads.totalCost.toLocaleString()})</h3>
                        <table>
                            <tr>
                                <th>Description</th>
                                <td>${projectBudget.overheads.percentage}% of labour costs</td>
                            </tr>
                            <tr>
                                <th>Labour Costs</th>
                                <td>¬£${projectBudget.overheads.labourCosts.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <th>Total Overhead Costs</th>
                                <td>¬£${projectBudget.overheads.totalCost.toLocaleString()}</td>
                            </tr>
                        </table>
                    </div>

                    <div class="category-section" style="margin-top: 20px;">
                        <h3>üì¶ Materials (¬£${projectBudget.materials.totalCost.toLocaleString()})</h3>
                        ${projectBudget.materials.items.length > 0 ? `
                        <table>
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Cost Per Item</th>
                                    <th>Total</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${projectBudget.materials.items.map((item, index) => {
                                    initializeQuarterlyCosts(item);
                                    const costsClaimed = getTotalCostsClaimed(item);
                                    const remaining = getRemainingBudget(item);
                                    const difference = getDifferencePercentage(item);
                                    const isOverBudget = costsClaimed > item.total;

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('materials-${index}')" style="cursor: pointer; ${isOverBudget && hasQuarters ? 'background: #fee;' : ''}">
                                            <td>${item.item}</td>
                                            <td>${item.quantity}</td>
                                            <td>¬£${item.costPerItem.toLocaleString()}</td>
                                            <td>¬£${item.total.toLocaleString()}</td>
                                            ${hasQuarters ? `
                                                <td ${isOverBudget ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${costsClaimed.toLocaleString()}</td>
                                                <td ${remaining < 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${remaining.toLocaleString()}</td>
                                                <td ${difference > 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>${difference.toFixed(1)}%</td>
                                            ` : ''}
                                        </tr>
                                        ${hasQuarters ? `
                                        <tr id="materials-${index}-breakdown" style="display: none;">
                                            <td colspan="${hasQuarters ? '7' : '4'}" style="padding: 0; background: #f8f9fa;">
                                                <div style="padding: 15px;">
                                                    <h4 style="margin: 0 0 10px 0; color: #64748b; font-size: 0.95em;">üìä Quarterly Breakdown - ${item.item}</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #e2e8f0;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => `
                                                                    <td data-quarter="${q.index}">
                                                                        <input
                                                                            type="number"
                                                                            value="${item.quarterlyCosts['q' + q.index] || 0}"
                                                                            onchange="updateQuarterlyCost(projectBudget.materials.items[${index}], ${q.index}, this.value); displayDetailedBudget();"
                                                                            onclick="event.stopPropagation()"
                                                                            style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                                        />
                                                                    </td>
                                                                `).join('')}
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${remaining.toLocaleString()}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td style="font-weight: 600;">Difference (%)</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 600; color: ${difference > 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ${difference.toFixed(1)}%
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    ${(() => {
                                                        // Render transaction details for this Materials item
                                                        if (cachedTransactions && cachedTransactions.length > 0) {
                                                            const itemTransactions = getTransactionsForItem(
                                                                cachedTransactions,
                                                                projectBudget.projectId,
                                                                'Materials',
                                                                'materials-' + index,
                                                                null // null = show all quarters
                                                            );
                                                            return renderTransactionDetails(
                                                                itemTransactions,
                                                                projectBudget.projectId,
                                                                'Materials',
                                                                'materials-' + index,
                                                                null,
                                                                cachedInvoices || []
                                                            );
                                                        }
                                                        return '';
                                                    })()}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    `;
                                }).join('')}

                                ${hasQuarters && projectBudget.materials.items.length > 0 ? (() => {
                                    const summary = getCategorySummary(projectBudget.materials.items);
                                    const isSummaryOverBudget = summary.totalClaimed > summary.totalCosts;

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('materials-summary')" style="cursor: pointer; background: #e8f5e9; font-weight: 600; border-top: 3px solid #4caf50; ${isSummaryOverBudget ? 'background: #ffebee;' : ''}">
                                            <td colspan="3" style="text-align: right; padding-right: 15px;">üìä MATERIALS CATEGORY TOTAL:</td>
                                            <td>¬£${summary.totalCosts.toLocaleString()}</td>
                                            <td ${isSummaryOverBudget ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.totalClaimed.toLocaleString()}</td>
                                            <td ${summary.remaining < 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.remaining.toLocaleString()}</td>
                                            <td ${summary.difference > 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>${summary.difference.toFixed(1)}%</td>
                                        </tr>
                                        <tr id="materials-summary-breakdown" style="display: none;">
                                            <td colspan="7" style="padding: 0; background: #f1f5f9;">
                                                <div style="padding: 15px;">
                                                    <h4 style="margin: 0 0 10px 0; color: #4caf50; font-size: 1em;">üìä Materials Category - Quarterly Breakdown</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #c8e6c9;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                <th>Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => {
                                                                    const qClaimed = summary.quarterlyTotals['q' + q.index] || 0;
                                                                    return `<td data-quarter="${q.index}" style="font-weight: 600;">¬£${qClaimed.toLocaleString()}</td>`;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #e8f5e9;">¬£${summary.totalClaimed.toLocaleString()}</td>
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Total Budget</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 600;">
                                                                    ¬£${summary.totalCosts.toLocaleString()}
                                                                </td>
                                                                <td style="font-weight: 700; background: #e8f5e9;">¬£${summary.totalCosts.toLocaleString()}</td>
                                                            </tr>
                                                            <tr>
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 700; color: ${summary.remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${summary.remaining.toLocaleString()}
                                                                </td>
                                                                <td style="font-weight: 700; background: #e8f5e9; color: ${summary.remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${summary.remaining.toLocaleString()}
                                                                </td>
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Difference (%)</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 700; color: ${summary.difference > 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ${summary.difference.toFixed(1)}%
                                                                </td>
                                                                <td style="font-weight: 700; background: #e8f5e9; color: ${summary.difference > 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ${summary.difference.toFixed(1)}%
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                })() : ''}
                            </tbody>
                        </table>
                        ` : '<p style="color: #94a3b8; font-style: italic;">No materials items</p>'}
                    </div>
                `;
                overheadsMaterialsSection.innerHTML = overheadsMaterialsHTML;
            }

            // Capital & Subcontracting Section
            const capitalSubcontractingSection = document.getElementById('capitalSubcontractingSection');
            if (capitalSubcontractingSection) {
                let capitalSubHTML = `
                    <div class="category-section">
                        <h3>üè≠ Capital Usage (¬£${projectBudget.capitalUsage.totalCost.toLocaleString()})</h3>
                        ${projectBudget.capitalUsage.items && projectBudget.capitalUsage.items.length > 0 ? `
                        <table>
                            <thead>
                                <tr>
                                    <th>Item Description</th>
                                    <th>New or Existing</th>
                                    <th>Utilisation %</th>
                                    <th>Net Cost</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${projectBudget.capitalUsage.items.map((item, index) => {
                                    // Ensure netCost is treated as the total cost
                                    if (!item.totalCost && item.netCost) {
                                        item.totalCost = item.netCost;
                                    }
                                    initializeQuarterlyCosts(item);
                                    const costsClaimed = getTotalCostsClaimed(item);
                                    const remaining = getRemainingBudget(item);
                                    const difference = getDifferencePercentage(item);
                                    const isOverBudget = costsClaimed > item.netCost;

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('capital-${index}')" style="cursor: pointer; ${isOverBudget && hasQuarters ? 'background: #fee;' : ''}">
                                            <td>${item.description}</td>
                                            <td>${item.newOrExisting}</td>
                                            <td>${item.utilisation}%</td>
                                            <td>¬£${item.netCost.toLocaleString()}</td>
                                            ${hasQuarters ? `
                                                <td ${isOverBudget ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${costsClaimed.toLocaleString()}</td>
                                                <td ${remaining < 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${remaining.toLocaleString()}</td>
                                                <td ${difference > 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>${difference.toFixed(1)}%</td>
                                            ` : ''}
                                        </tr>
                                        ${hasQuarters ? `
                                        <tr id="capital-${index}-breakdown" style="display: none;">
                                            <td colspan="${hasQuarters ? '7' : '4'}" style="padding: 0; background: #f8f9fa;">
                                                <div style="padding: 15px;">
                                                    <h4 style="margin: 0 0 10px 0; color: #64748b; font-size: 0.95em;">üìä Quarterly Breakdown - ${item.description}</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #e2e8f0;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => `
                                                                    <td data-quarter="${q.index}">
                                                                        <input
                                                                            type="number"
                                                                            value="${item.quarterlyCosts['q' + q.index] || 0}"
                                                                            onchange="updateQuarterlyCost(projectBudget.capitalUsage.items[${index}], ${q.index}, this.value); displayDetailedBudget();"
                                                                            onclick="event.stopPropagation()"
                                                                            style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                                        />
                                                                    </td>
                                                                `).join('')}
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${remaining.toLocaleString()}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    ${(() => {
                                                        // Render transaction details for this Capital Usage item
                                                        if (cachedTransactions && cachedTransactions.length > 0) {
                                                            const itemTransactions = getTransactionsForItem(
                                                                cachedTransactions,
                                                                projectBudget.projectId,
                                                                'Capital Usage',
                                                                'capitalUsage-' + index,
                                                                null
                                                            );
                                                            return renderTransactionDetails(
                                                                itemTransactions,
                                                                projectBudget.projectId,
                                                                'Capital Usage',
                                                                'capitalUsage-' + index,
                                                                null,
                                                                cachedInvoices || []
                                                            );
                                                        }
                                                        return '';
                                                    })()}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    `;
                                }).join('')}

                                ${hasQuarters && projectBudget.capitalUsage.items.length > 0 ? (() => {
                                    const summary = getCategorySummary(projectBudget.capitalUsage.items);
                                    const isSummaryOverBudget = summary.totalClaimed > summary.totalCosts;

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('capital-summary')" style="cursor: pointer; background: #fff3e0; font-weight: 600; border-top: 3px solid #ff9800; ${isSummaryOverBudget ? 'background: #ffebee;' : ''}">
                                            <td colspan="3" style="text-align: right; padding-right: 15px;">üìä CAPITAL USAGE TOTAL:</td>
                                            <td>¬£${summary.totalCosts.toLocaleString()}</td>
                                            <td ${isSummaryOverBudget ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.totalClaimed.toLocaleString()}</td>
                                            <td ${summary.remaining < 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.remaining.toLocaleString()}</td>
                                            <td ${summary.difference > 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>${summary.difference.toFixed(1)}%</td>
                                        </tr>
                                        <tr id="capital-summary-breakdown" style="display: none;">
                                            <td colspan="7" style="padding: 0; background: #f1f5f9;">
                                                <div style="padding: 15px;">
                                                    <h4 style="margin: 0 0 10px 0; color: #ff9800; font-size: 1em;">üìä Capital Usage - Quarterly Breakdown</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #ffe0b2;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                <th>Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => {
                                                                    const qClaimed = summary.quarterlyTotals['q' + q.index] || 0;
                                                                    return `<td data-quarter="${q.index}" style="font-weight: 600;">¬£${qClaimed.toLocaleString()}</td>`;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #fff3e0;">¬£${summary.totalClaimed.toLocaleString()}</td>
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 700; color: ${summary.remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${summary.remaining.toLocaleString()}
                                                                </td>
                                                                <td style="font-weight: 700; background: #fff3e0; color: ${summary.remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${summary.remaining.toLocaleString()}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                })() : ''}
                            </tbody>
                        </table>
                        ` : '<p style="color: #94a3b8; font-style: italic;">No capital usage items</p>'}
                    </div>

                    <div class="category-section" style="margin-top: 20px;">
                        <h3>ü§ù Subcontracting (¬£${projectBudget.subcontracting.totalCost.toLocaleString()})</h3>
                        ${projectBudget.subcontracting.contractors && projectBudget.subcontracting.contractors.length > 0 ? `
                        <table>
                            <thead>
                                <tr>
                                    <th>Subcontractor Name</th>
                                    <th>Country</th>
                                    <th>Role</th>
                                    <th>Cost</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${projectBudget.subcontracting.contractors.map((contractor, index) => {
                                    // Ensure cost is treated as the total cost
                                    if (!contractor.totalCost && contractor.cost) {
                                        contractor.totalCost = contractor.cost;
                                    }
                                    initializeQuarterlyCosts(contractor);
                                    const costsClaimed = getTotalCostsClaimed(contractor);
                                    const remaining = getRemainingBudget(contractor);
                                    const difference = getDifferencePercentage(contractor);
                                    const isOverBudget = costsClaimed > contractor.cost;

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('subcontracting-${index}')" style="cursor: pointer; ${isOverBudget && hasQuarters ? 'background: #fee;' : ''}">
                                            <td>${contractor.name}</td>
                                            <td>${contractor.country}</td>
                                            <td>${contractor.role}</td>
                                            <td>¬£${contractor.cost.toLocaleString()}</td>
                                            ${hasQuarters ? `
                                                <td ${isOverBudget ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${costsClaimed.toLocaleString()}</td>
                                                <td ${remaining < 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${remaining.toLocaleString()}</td>
                                                <td ${difference > 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>${difference.toFixed(1)}%</td>
                                            ` : ''}
                                        </tr>
                                        ${hasQuarters ? `
                                        <tr id="subcontracting-${index}-breakdown" style="display: none;">
                                            <td colspan="${hasQuarters ? '7' : '4'}" style="padding: 0; background: #f8f9fa;">
                                                <div style="padding: 15px;">
                                                    <h4 style="margin: 0 0 10px 0; color: #64748b; font-size: 0.95em;">üìä Quarterly Breakdown - ${contractor.name}</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #e2e8f0;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => `
                                                                    <td data-quarter="${q.index}">
                                                                        <input
                                                                            type="number"
                                                                            value="${contractor.quarterlyCosts['q' + q.index] || 0}"
                                                                            onchange="updateQuarterlyCost(projectBudget.subcontracting.contractors[${index}], ${q.index}, this.value); displayDetailedBudget();"
                                                                            onclick="event.stopPropagation()"
                                                                            style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                                        />
                                                                    </td>
                                                                `).join('')}
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${remaining.toLocaleString()}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    ${(() => {
                                                        // Render transaction details for this Subcontracting item
                                                        if (cachedTransactions && cachedTransactions.length > 0) {
                                                            const itemTransactions = getTransactionsForItem(
                                                                cachedTransactions,
                                                                projectBudget.projectId,
                                                                'Subcontracting',
                                                                'subcontracting-' + index,
                                                                null
                                                            );
                                                            return renderTransactionDetails(
                                                                itemTransactions,
                                                                projectBudget.projectId,
                                                                'Subcontracting',
                                                                'subcontracting-' + index,
                                                                null,
                                                                cachedInvoices || []
                                                            );
                                                        }
                                                        return '';
                                                    })()}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    `;
                                }).join('')}

                                ${hasQuarters && projectBudget.subcontracting.contractors.length > 0 ? (() => {
                                    const summary = getCategorySummary(projectBudget.subcontracting.contractors);
                                    const isSummaryOverBudget = summary.totalClaimed > summary.totalCosts;

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('subcontracting-summary')" style="cursor: pointer; background: #fce4ec; font-weight: 600; border-top: 3px solid #e91e63; ${isSummaryOverBudget ? 'background: #ffebee;' : ''}">
                                            <td colspan="3" style="text-align: right; padding-right: 15px;">üìä SUBCONTRACTING TOTAL:</td>
                                            <td>¬£${summary.totalCosts.toLocaleString()}</td>
                                            <td ${isSummaryOverBudget ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.totalClaimed.toLocaleString()}</td>
                                            <td ${summary.remaining < 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.remaining.toLocaleString()}</td>
                                            <td ${summary.difference > 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>${summary.difference.toFixed(1)}%</td>
                                        </tr>
                                        <tr id="subcontracting-summary-breakdown" style="display: none;">
                                            <td colspan="7" style="padding: 0; background: #f1f5f9;">
                                                <div style="padding: 15px;">
                                                    <h4 style="margin: 0 0 10px 0; color: #e91e63; font-size: 1em;">üìä Subcontracting - Quarterly Breakdown</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #f8bbd0;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                <th>Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => {
                                                                    const qClaimed = summary.quarterlyTotals['q' + q.index] || 0;
                                                                    return `<td data-quarter="${q.index}" style="font-weight: 600;">¬£${qClaimed.toLocaleString()}</td>`;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #fce4ec;">¬£${summary.totalClaimed.toLocaleString()}</td>
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 700; color: ${summary.remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${summary.remaining.toLocaleString()}
                                                                </td>
                                                                <td style="font-weight: 700; background: #fce4ec; color: ${summary.remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${summary.remaining.toLocaleString()}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                })() : ''}
                            </tbody>
                        </table>
                        ` : '<p style="color: #94a3b8; font-style: italic;">No subcontracting items</p>'}
                    </div>
                `;
                capitalSubcontractingSection.innerHTML = capitalSubHTML;
            }

            // Travel & Other Costs Section
            const travelOtherSection = document.getElementById('travelOtherSection');
            if (travelOtherSection) {
                let travelOtherHTML = `
                    <div class="category-section">
                        <h3>‚úàÔ∏è Travel and Subsistence (¬£${projectBudget.travel.totalCost.toLocaleString()})</h3>
                        ${(projectBudget.travel.trips && projectBudget.travel.trips.length > 0) || (projectBudget.travel.totalCost > 0 && projectBudget.travel.quarterlyCosts) ? `
                        <table>
                            <thead>
                                <tr>
                                    <th>Purpose of Journey or Subsistence</th>
                                    <th>Number of Times</th>
                                    <th>Cost Each</th>
                                    <th>Total</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${(projectBudget.travel.trips && projectBudget.travel.trips.length > 0 ? projectBudget.travel.trips : (projectBudget.travel.quarterlyCosts ? [projectBudget.travel] : [])).map((trip, index) => {
                                    // Ensure total is treated as totalCost
                                    if (!trip.totalCost && trip.total) {
                                        trip.totalCost = trip.total;
                                    }
                                    initializeQuarterlyCosts(trip);
                                    const costsClaimed = getTotalCostsClaimed(trip);
                                    const remaining = getRemainingBudget(trip);
                                    const difference = getDifferencePercentage(trip);
                                    const isOverBudget = costsClaimed > (trip.total || trip.totalCost);

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('travel-${index}')" style="cursor: pointer; ${isOverBudget && hasQuarters ? 'background: #fee;' : ''}">
                                            <td>${trip.purpose || 'General Travel'}</td>
                                            <td>${trip.numberOfTimes || '-'}</td>
                                            <td>${trip.costEach ? '¬£' + trip.costEach.toLocaleString() : '-'}</td>
                                            <td>¬£${(trip.total || trip.totalCost).toLocaleString()}</td>
                                            ${hasQuarters ? `
                                                <td ${isOverBudget ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${costsClaimed.toLocaleString()}</td>
                                                <td ${remaining < 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${remaining.toLocaleString()}</td>
                                                <td ${difference > 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>${difference.toFixed(1)}%</td>
                                            ` : ''}
                                        </tr>
                                        ${hasQuarters ? `
                                        <tr id="travel-${index}-breakdown" style="display: none;">
                                            <td colspan="${hasQuarters ? '7' : '4'}" style="padding: 0; background: #f8f9fa;">
                                                <div style="padding: 15px;">
                                                    <h4 style="margin: 0 0 10px 0; color: #64748b; font-size: 0.95em;">üìä Quarterly Breakdown - ${trip.purpose || 'General Travel'}</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #e2e8f0;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => `
                                                                    <td data-quarter="${q.index}">
                                                                        <input
                                                                            type="number"
                                                                            value="${trip.quarterlyCosts['q' + q.index] || 0}"
                                                                            onchange="updateQuarterlyCost(${projectBudget.travel.trips && projectBudget.travel.trips.length > 0 ? `projectBudget.travel.trips[${index}]` : 'projectBudget.travel'}, ${q.index}, this.value); displayDetailedBudget();"
                                                                            onclick="event.stopPropagation()"
                                                                            style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                                        />
                                                                    </td>
                                                                `).join('')}
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${remaining.toLocaleString()}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    ${(() => {
                                                        // Render transaction details for this Travel item
                                                        if (cachedTransactions && cachedTransactions.length > 0) {
                                                            const itemTransactions = getTransactionsForItem(
                                                                cachedTransactions,
                                                                projectBudget.projectId,
                                                                'Travel',
                                                                'travel-' + index,
                                                                null
                                                            );
                                                            return renderTransactionDetails(
                                                                itemTransactions,
                                                                projectBudget.projectId,
                                                                'Travel',
                                                                'travel-' + index,
                                                                null,
                                                                cachedInvoices || []
                                                            );
                                                        }
                                                        return '';
                                                    })()}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    `;
                                }).join('')}

                                ${hasQuarters && ((projectBudget.travel.trips && projectBudget.travel.trips.length > 0) || projectBudget.travel.quarterlyCosts) ? (() => {
                                    const summary = getCategorySummary(projectBudget.travel.trips && projectBudget.travel.trips.length > 0 ? projectBudget.travel.trips : [projectBudget.travel]);
                                    const isSummaryOverBudget = summary.totalClaimed > summary.totalCosts;

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('travel-summary')" style="cursor: pointer; background: #e1f5fe; font-weight: 600; border-top: 3px solid #03a9f4; ${isSummaryOverBudget ? 'background: #ffebee;' : ''}">
                                            <td colspan="3" style="text-align: right; padding-right: 15px;">üìä TRAVEL TOTAL:</td>
                                            <td>¬£${summary.totalCosts.toLocaleString()}</td>
                                            <td ${isSummaryOverBudget ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.totalClaimed.toLocaleString()}</td>
                                            <td ${summary.remaining < 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.remaining.toLocaleString()}</td>
                                            <td ${summary.difference > 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>${summary.difference.toFixed(1)}%</td>
                                        </tr>
                                        <tr id="travel-summary-breakdown" style="display: none;">
                                            <td colspan="7" style="padding: 0; background: #f1f5f9;">
                                                <div style="padding: 15px;">
                                                    <h4 style="margin: 0 0 10px 0; color: #03a9f4; font-size: 1em;">üìä Travel - Quarterly Breakdown</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #b3e5fc;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                <th>Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => {
                                                                    const qClaimed = summary.quarterlyTotals['q' + q.index] || 0;
                                                                    return `<td data-quarter="${q.index}" style="font-weight: 600;">¬£${qClaimed.toLocaleString()}</td>`;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #e1f5fe;">¬£${summary.totalClaimed.toLocaleString()}</td>
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 700; color: ${summary.remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${summary.remaining.toLocaleString()}
                                                                </td>
                                                                <td style="font-weight: 700; background: #e1f5fe; color: ${summary.remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${summary.remaining.toLocaleString()}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                })() : ''}
                            </tbody>
                        </table>
                        ` : '<p style="color: #94a3b8; font-style: italic;">No travel items</p>'}
                    </div>

                    <div class="category-section" style="margin-top: 20px;">
                        <h3>üìã Other Costs (¬£${projectBudget.otherCosts.totalCost.toLocaleString()})</h3>
                        ${(projectBudget.otherCosts.items && projectBudget.otherCosts.items.length > 0) || (projectBudget.otherCosts.totalCost > 0 && projectBudget.otherCosts.quarterlyCosts) ? `
                        <table>
                            <thead>
                                <tr>
                                    <th>Description and Justification</th>
                                    <th>Estimated Cost</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${(projectBudget.otherCosts.items && projectBudget.otherCosts.items.length > 0 ? projectBudget.otherCosts.items : (projectBudget.otherCosts.quarterlyCosts ? [projectBudget.otherCosts] : [])).map((item, index) => {
                                    // Ensure estimatedCost is treated as totalCost
                                    if (!item.totalCost && item.estimatedCost) {
                                        item.totalCost = item.estimatedCost;
                                    }
                                    initializeQuarterlyCosts(item);
                                    const costsClaimed = getTotalCostsClaimed(item);
                                    const remaining = getRemainingBudget(item);
                                    const difference = getDifferencePercentage(item);
                                    const isOverBudget = costsClaimed > (item.estimatedCost || item.totalCost);

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('othercosts-${index}')" style="cursor: pointer; ${isOverBudget && hasQuarters ? 'background: #fee;' : ''}">
                                            <td>${item.description || 'General Other Costs'}</td>
                                            <td>¬£${(item.estimatedCost || item.totalCost).toLocaleString()}</td>
                                            ${hasQuarters ? `
                                                <td ${isOverBudget ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${costsClaimed.toLocaleString()}</td>
                                                <td ${remaining < 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${remaining.toLocaleString()}</td>
                                                <td ${difference > 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>${difference.toFixed(1)}%</td>
                                            ` : ''}
                                        </tr>
                                        ${hasQuarters ? `
                                        <tr id="othercosts-${index}-breakdown" style="display: none;">
                                            <td colspan="${hasQuarters ? '5' : '2'}" style="padding: 0; background: #f8f9fa;">
                                                <div style="padding: 15px;">
                                                    <h4 style="margin: 0 0 10px 0; color: #64748b; font-size: 0.95em;">üìä Quarterly Breakdown - ${item.description || 'General Other Costs'}</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #e2e8f0;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => `
                                                                    <td data-quarter="${q.index}">
                                                                        <input
                                                                            type="number"
                                                                            value="${item.quarterlyCosts['q' + q.index] || 0}"
                                                                            onchange="updateQuarterlyCost(${projectBudget.otherCosts.items && projectBudget.otherCosts.items.length > 0 ? `projectBudget.otherCosts.items[${index}]` : 'projectBudget.otherCosts'}, ${q.index}, this.value); displayDetailedBudget();"
                                                                            onclick="event.stopPropagation()"
                                                                            style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                                        />
                                                                    </td>
                                                                `).join('')}
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${remaining.toLocaleString()}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    ${(() => {
                                                        // Render transaction details for this Other Costs item
                                                        if (cachedTransactions && cachedTransactions.length > 0) {
                                                            const itemTransactions = getTransactionsForItem(
                                                                cachedTransactions,
                                                                projectBudget.projectId,
                                                                'Other Costs',
                                                                'otherCosts-' + index,
                                                                null
                                                            );
                                                            return renderTransactionDetails(
                                                                itemTransactions,
                                                                projectBudget.projectId,
                                                                'Other Costs',
                                                                'otherCosts-' + index,
                                                                null,
                                                                cachedInvoices || []
                                                            );
                                                        }
                                                        return '';
                                                    })()}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    `;
                                }).join('')}

                                ${hasQuarters && ((projectBudget.otherCosts.items && projectBudget.otherCosts.items.length > 0) || projectBudget.otherCosts.quarterlyCosts) ? (() => {
                                    const summary = getCategorySummary(projectBudget.otherCosts.items && projectBudget.otherCosts.items.length > 0 ? projectBudget.otherCosts.items : [projectBudget.otherCosts]);
                                    const isSummaryOverBudget = summary.totalClaimed > summary.totalCosts;

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('othercosts-summary')" style="cursor: pointer; background: #f3e5f5; font-weight: 600; border-top: 3px solid #9c27b0; ${isSummaryOverBudget ? 'background: #ffebee;' : ''}">
                                            <td style="text-align: right; padding-right: 15px;">üìä OTHER COSTS TOTAL:</td>
                                            <td>¬£${summary.totalCosts.toLocaleString()}</td>
                                            <td ${isSummaryOverBudget ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.totalClaimed.toLocaleString()}</td>
                                            <td ${summary.remaining < 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.remaining.toLocaleString()}</td>
                                            <td ${summary.difference > 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>${summary.difference.toFixed(1)}%</td>
                                        </tr>
                                        <tr id="othercosts-summary-breakdown" style="display: none;">
                                            <td colspan="5" style="padding: 0; background: #f1f5f9;">
                                                <div style="padding: 15px;">
                                                    <h4 style="margin: 0 0 10px 0; color: #9c27b0; font-size: 1em;">üìä Other Costs - Quarterly Breakdown</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #e1bee7;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                <th>Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => {
                                                                    const qClaimed = summary.quarterlyTotals['q' + q.index] || 0;
                                                                    return `<td data-quarter="${q.index}" style="font-weight: 600;">¬£${qClaimed.toLocaleString()}</td>`;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #f3e5f5;">¬£${summary.totalClaimed.toLocaleString()}</td>
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 700; color: ${summary.remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${summary.remaining.toLocaleString()}
                                                                </td>
                                                                <td style="font-weight: 700; background: #f3e5f5; color: ${summary.remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${summary.remaining.toLocaleString()}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                })() : ''}
                            </tbody>
                        </table>
                        ` : '<p style="color: #94a3b8; font-style: italic;">No other cost items</p>'}
                    </div>
                `;
                travelOtherSection.innerHTML = travelOtherHTML;
            }

            addLog('‚úÖ Detailed budget displayed');
            detailedResults.style.display = 'block';
        }

        function updateItem(id, field, value) {
            const item = budgetData.find(i => i.id === id);
            if (item) {
                item[field] = value;
                addLog(`Updated ${field} for item ${id}`);
            }
        }

        function deleteItem(id) {
            budgetData = budgetData.filter(i => i.id !== id);
            addLog(`Deleted item ${id}`);
            displayResults();
        }

        function exportCSV() {
            const headers = ['Category', 'Description', 'Quantity', 'Unit', 'Unit Cost', 'Total Cost', 'Notes'];
            const rows = budgetData.map(item => [
                item.category || '',
                item.description || '',
                item.quantity || '',
                item.unit || '',
                item.unitCost || '',
                item.totalCost || 0,
                item.notes || ''
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `budget-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            addLog('Exported budget to CSV');
        }

        function saveBudgetProfile() {
            if (budgetData.length === 0) {
                alert('No budget data to save. Please parse a budget first.');
                return;
            }

            const profile = {
                savedDate: new Date().toISOString(),
                budgetData: budgetData,
                metadata: {
                    itemCount: budgetData.length,
                    totalEligible: budgetData.reduce((sum, item) => sum + (item.totalEligible || 0), 0),
                    totalSpent: budgetData.reduce((sum, item) => sum + (item.totalSpent || 0), 0)
                }
            };

            const json = JSON.stringify(profile, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `budget-profile-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            addLog('Saved budget profile to JSON file');
            addLog(`Total items: ${budgetData.length}, Total Eligible: ¬£${profile.metadata.totalEligible.toLocaleString()}`);
        }

        function loadBudgetProfile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const profile = JSON.parse(e.target.result);

                    if (!profile.budgetData || !Array.isArray(profile.budgetData)) {
                        throw new Error('Invalid budget profile format');
                    }

                    budgetData = profile.budgetData;
                    addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    addLog('üìÇ Loaded budget profile successfully!');
                    addLog(`Saved on: ${new Date(profile.savedDate).toLocaleString()}`);
                    addLog(`Items loaded: ${budgetData.length}`);
                    addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                    displayResults();
                    document.getElementById('results').classList.add('show');
                } catch (error) {
                    addLog(`ERROR: Failed to load profile - ${error.message}`);
                    alert('Failed to load budget profile. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        function updateItemAndRecalc(id, field, value) {
            const item = budgetData.find(i => i.id === id);
            if (item) {
                item[field] = value;

                // Recalculate dependent values
                if (['q1', 'q2', 'q3', 'q4'].includes(field)) {
                    item.totalSpent = (item.q1 || 0) + (item.q2 || 0) + (item.q3 || 0) + (item.q4 || 0);
                    item.difference = (item.totalEligible || item.forecast || 0) - item.totalSpent;
                } else if (field === 'totalSpent' || field === 'totalEligible') {
                    item.difference = (item.totalEligible || item.forecast || 0) - (item.totalSpent || 0);
                }

                addLog(`Updated ${field} for item ${id} to ${value}`);
                displayResults();
            }
        }

        function setActiveQuarter(quarter) {
            activeQuarter = quarter;

            // Update button styles
            document.querySelectorAll('.quarter-btn').forEach(btn => {
                if (parseInt(btn.dataset.quarter) === quarter) {
                    btn.style.background = '#ff9800';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#ff9800';
                    btn.classList.add('active-quarter');
                } else {
                    btn.style.background = 'white';
                    btn.style.color = 'black';
                    btn.style.borderColor = '#ddd';
                    btn.classList.remove('active-quarter');
                }
            });

            // Update label
            document.getElementById('activeQuarterLabel').textContent = `‚Üê Currently claiming for Q${quarter}`;
            addLog(`Active claiming period changed to Q${quarter}`);
        }

        function updateProjectName(value) {
            projectBudget.projectName = value.trim();
            console.log('‚úèÔ∏è Project name updated:', projectBudget.projectName);
            addLog(`‚úèÔ∏è Project name set to: ${projectBudget.projectName}`);
        }

        function updateProjectNumber(value) {
            projectBudget.projectNumber = value.trim();
            console.log('‚úèÔ∏è Project number updated:', projectBudget.projectNumber);
            addLog(`‚úèÔ∏è Project number set to: ${projectBudget.projectNumber}`);
        }

        function updateProjectStartDate() {
            const monthSelect = document.getElementById('projectStartMonth');
            const yearSelect = document.getElementById('projectStartYear');

            if (monthSelect && yearSelect) {
                const month = parseInt(monthSelect.value);
                const year = parseInt(yearSelect.value);

                if (month && year) {
                    projectBudget.financeSummary.projectStartMonth = month;
                    projectBudget.financeSummary.projectStartYear = year;
                    console.log('‚úèÔ∏è Project start date updated:', month, year);
                    addLog(`‚úèÔ∏è Project start date set to: ${getMonthName(month)} ${year}`);

                    // Re-render to show updated end date
                    displayDetailedBudget();

                    // Auto-save
                    saveToIndexedDB();
                }
            }
        }

        function updateProjectDuration() {
            const durationInput = document.getElementById('projectDurationMonths');
            if (durationInput) {
                const duration = parseInt(durationInput.value);
                if (duration && duration > 0) {
                    projectBudget.financeSummary.projectDurationMonths = duration;
                    console.log('‚úèÔ∏è Project duration updated:', duration);
                    addLog(`‚úèÔ∏è Project duration set to: ${duration} months`);

                    // Re-render to show updated end date and quarters
                    displayDetailedBudget();

                    // Auto-save
                    saveToIndexedDB();
                }
            }
        }

        function calculateEndDate(startMonth, startYear, durationMonths) {
            if (!startMonth || !startYear || !durationMonths) return '';

            const startDate = new Date(startYear, startMonth - 1, 1); // First day of start month
            const endDate = new Date(startYear, startMonth - 1 + durationMonths, 0); // Last day of end month

            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${monthNames[endDate.getMonth()]} ${endDate.getFullYear()}`;
        }

        function getMonthName(monthNumber) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
            return months[monthNumber - 1] || '';
        }

        function calculateQuarters() {
            const fs = projectBudget.financeSummary;
            if (!fs.projectStartMonth || !fs.projectStartYear || !fs.projectDurationMonths) {
                return [];
            }

            const quarters = [];
            const startMonth = fs.projectStartMonth;
            const startYear = fs.projectStartYear;
            const durationMonths = fs.projectDurationMonths;

            let currentMonth = startMonth;
            let currentYear = startYear;
            let monthsRemaining = durationMonths;
            let quarterIndex = 1;

            while (monthsRemaining > 0) {
                const quarterMonths = Math.min(3, monthsRemaining);
                const endMonth = currentMonth + quarterMonths - 1;
                const endYear = currentYear + Math.floor(endMonth / 12);
                const adjustedEndMonth = ((endMonth - 1) % 12) + 1;

                const startYYMM = `${String(currentYear).slice(-2)}${String(currentMonth).padStart(2, '0')}`;
                const endYYMM = `${String(endYear).slice(-2)}${String(adjustedEndMonth).padStart(2, '0')}`;

                quarters.push({
                    index: quarterIndex,
                    label: `Q${quarterIndex} (${startYYMM}-${endYYMM})`,
                    startMonth: currentMonth,
                    startYear: currentYear,
                    endMonth: adjustedEndMonth,
                    endYear: endYear
                });

                currentMonth = adjustedEndMonth + 1;
                if (currentMonth > 12) {
                    currentMonth = 1;
                    currentYear++;
                }

                monthsRemaining -= quarterMonths;
                quarterIndex++;
            }

            return quarters;
        }

        function getCurrentQuarter() {
            const quarters = calculateQuarters();
            if (quarters.length === 0) return null;

            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            for (const quarter of quarters) {
                const startDate = new Date(quarter.startYear, quarter.startMonth - 1, 1);
                const endDate = new Date(quarter.endYear, quarter.endMonth, 0);
                const nowDate = new Date(currentYear, currentMonth - 1, now.getDate());

                if (nowDate >= startDate && nowDate <= endDate) {
                    return quarter.index;
                }
            }

            return null;
        }

        // Initialize quarterly costs for an item (ensures all quarters have cost entries)
        function initializeQuarterlyCosts(item) {
            if (!item.quarterlyCosts) {
                item.quarterlyCosts = {};
            }

            const quarters = calculateQuarters();
            quarters.forEach(q => {
                if (item.quarterlyCosts[`q${q.index}`] === undefined) {
                    item.quarterlyCosts[`q${q.index}`] = 0;
                }
            });

            return item;
        }

        // Calculate total costs claimed across all quarters for an item
        function getTotalCostsClaimed(item) {
            if (!item.quarterlyCosts) return 0;

            let total = 0;
            Object.values(item.quarterlyCosts).forEach(cost => {
                total += parseFloat(cost) || 0;
            });
            return total;
        }

        // Calculate remaining budget for an item
        function getRemainingBudget(item) {
            const totalBudget = parseFloat(item.totalCost || item.total || item.cost || 0);
            const costsClaimed = getTotalCostsClaimed(item);
            return totalBudget - costsClaimed;
        }

        // Calculate difference percentage for an item
        function getDifferencePercentage(item) {
            const totalBudget = parseFloat(item.totalCost || item.total || item.cost || 0);
            const costsClaimed = getTotalCostsClaimed(item);

            if (totalBudget === 0) return 0;

            return ((costsClaimed - totalBudget) / totalBudget) * 100;
        }

        // Calculate category-level summaries
        function getCategorySummary(items) {
            let totalCosts = 0;
            let totalClaimed = 0;
            const quarterlyTotals = {};

            items.forEach(item => {
                // Sum up total costs
                totalCosts += parseFloat(item.totalCost || item.total || item.cost || 0);

                // Initialize quarterly costs if needed
                initializeQuarterlyCosts(item);

                // Sum up claimed costs per quarter
                Object.keys(item.quarterlyCosts || {}).forEach(quarterKey => {
                    if (!quarterlyTotals[quarterKey]) {
                        quarterlyTotals[quarterKey] = 0;
                    }
                    quarterlyTotals[quarterKey] += parseFloat(item.quarterlyCosts[quarterKey]) || 0;
                });

                // Sum total claimed
                totalClaimed += getTotalCostsClaimed(item);
            });

            const remaining = totalCosts - totalClaimed;
            const difference = totalCosts === 0 ? 0 : ((totalClaimed - totalCosts) / totalCosts) * 100;

            return {
                totalCosts,
                totalClaimed,
                remaining,
                difference,
                quarterlyTotals
            };
        }

        // Update quarterly cost for an item
        function updateQuarterlyCost(item, quarter, value) {
            if (!item.quarterlyCosts) {
                item.quarterlyCosts = {};
            }

            item.quarterlyCosts[`q${quarter}`] = parseFloat(value) || 0;

            // Update budget summary overview if it's currently visible
            const summarySection = document.getElementById('budgetSummaryOverview');
            if (summarySection && summarySection.style.display !== 'none') {
                summarySection.innerHTML = generateBudgetSummaryOverview();
            }

            // Auto-save after update
            saveToIndexedDB();
        }

        // Toggle quarterly breakdown visibility
        function toggleQuarterlyBreakdown(rowId) {
            const breakdownRow = document.getElementById(`${rowId}-breakdown`);
            if (breakdownRow) {
                const isCurrentlyHidden = breakdownRow.style.display === 'none';
                breakdownRow.style.display = isCurrentlyHidden ? 'table-row' : 'none';
            }
        }

        // Toggle budget summary overview
        function toggleBudgetSummaryOverview() {
            const summarySection = document.getElementById('budgetSummaryOverview');
            if (!summarySection) return;

            const isCurrentlyHidden = summarySection.style.display === 'none';

            if (isCurrentlyHidden) {
                // Generate and show the summary
                summarySection.innerHTML = generateBudgetSummaryOverview();
                summarySection.style.display = 'block';

                // Update button text
                const button = event.target;
                button.textContent = 'üìä Hide Budget Summary Overview';
            } else {
                // Hide the summary
                summarySection.style.display = 'none';

                // Update button text
                const button = event.target;
                button.textContent = 'üìä Show Budget Summary Overview';
            }
        }

        // Generate budget summary overview HTML
        function generateBudgetSummaryOverview() {
            const quarters = calculateQuarters();
            if (quarters.length === 0) {
                return '<p style="color: #64748b; text-align: center; padding: 20px;">Set project dates to view budget summary</p>';
            }

            // Check if this is a Welsh Gov project
            const isWelshGov = projectBudget.fundingBody === 'Welsh Gov' || projectBudget.welshGovData;

            let categories = [];

            if (isWelshGov && projectBudget.welshGovData) {
                // Welsh Gov categories
                const sections = projectBudget.welshGovData.sections;
                categories = [
                    { key: 'capitalNonStandard', name: 'Capital - Non Standard Costs', items: sections?.capital?.nonStandard || [] },
                    { key: 'revenueNonStandard', name: 'Revenue - Non Standard Costs', items: sections?.revenue?.nonStandard || [] },
                    { key: 'revenueStandard', name: 'Revenue - Standard Costs', items: sections?.revenue?.standardCosts || [] },
                    { key: 'itemBreakdownCapital', name: 'Item Breakdown - Capital', items: sections?.itemBreakdown?.capital || [] },
                    { key: 'itemBreakdownRevenue', name: 'Item Breakdown - Revenue', items: sections?.itemBreakdown?.revenue || [] }
                ];
            } else {
                // IUK categories
                categories = [
                    { key: 'labour', name: 'Labour', items: projectBudget.labour?.staff || [] },
                    { key: 'overheads', name: 'Overheads', items: [], totalCost: projectBudget.overheads?.totalCost || 0 },
                    { key: 'materials', name: 'Materials', items: projectBudget.materials?.items || [] },
                    { key: 'capitalUsage', name: 'Capital usage', items: projectBudget.capitalUsage?.items || [] },
                    { key: 'subcontracting', name: 'Subcontracting', items: projectBudget.subcontracting?.contractors || [] },
                    { key: 'travel', name: 'Travel and subsistence', items: projectBudget.travel?.trips || [] },
                    { key: 'otherCosts', name: 'Other costs', items: projectBudget.otherCosts?.items || [] }
                ];
            }

            let grandTotalCosts = 0;
            let grandTotalClaimedThisPeriod = 0;
            let grandTotalRemaining = 0;

            let tableRows = '';

            categories.forEach(category => {
                let categoryTotal = 0;
                let categoryClaimedThisPeriod = 0;
                let categoryTotalClaimed = 0;

                // Special handling for overheads (has direct totalCost, no items)
                if (category.key === 'overheads') {
                    categoryTotal = category.totalCost;
                } else if (category.items.length > 0) {
                    // Calculate category totals from items
                    category.items.forEach(item => {
                        // Handle different cost field names for Welsh Gov vs IUK
                        let itemTotal = 0;
                        if (isWelshGov) {
                            // Welsh Gov items use maxGrantValue or maxGrantApproved
                            itemTotal = parseFloat(item.maxGrantValue || item.maxGrantApproved || item.totalCost || 0);
                        } else {
                            // IUK items use various field names
                            itemTotal = parseFloat(item.totalCost || item.total || item.cost || item.netCost || item.estimatedCost || 0);
                        }
                        categoryTotal += itemTotal;

                        // Initialize quarterly costs
                        initializeQuarterlyCosts(item);

                        // Calculate claimed this period (active quarter)
                        if (activeQuarterIndex) {
                            const claimedInActiveQuarter = parseFloat(item.quarterlyCosts[`q${activeQuarterIndex}`]) || 0;
                            categoryClaimedThisPeriod += claimedInActiveQuarter;
                        }

                        // Calculate total claimed across all quarters
                        categoryTotalClaimed += getTotalCostsClaimed(item);
                    });
                }

                // Only include categories that have costs
                if (categoryTotal > 0 || category.items.length > 0) {
                    const categoryRemaining = categoryTotal - categoryTotalClaimed;

                    grandTotalCosts += categoryTotal;
                    grandTotalClaimedThisPeriod += categoryClaimedThisPeriod;
                    grandTotalRemaining += categoryRemaining;

                    tableRows += `
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 12px; color: #667eea; font-weight: 500;">${category.name}</td>
                            <td style="padding: 12px; text-align: right;">¬£${categoryTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td style="padding: 12px; text-align: right; ${categoryClaimedThisPeriod > 0 ? 'font-weight: 600; color: #2563eb;' : ''}">¬£${categoryClaimedThisPeriod.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td style="padding: 12px; text-align: right; ${categoryRemaining < 0 ? 'color: #dc2626; font-weight: 600;' : ''}">¬£${categoryRemaining.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        </tr>
                    `;
                }
            });

            return `
                <div class="category-section" style="margin-top: 20px; background: white; border: 2px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìä Budget Summary Overview${activeQuarterIndex ? ` - Q${activeQuarterIndex} Active` : ''}</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Category</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600;">Total eligible costs</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600;">Costs claimed this period</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600;">Remaining eligible costs</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                            <tr style="background: #f8fafc; border-top: 3px solid #667eea; font-weight: 700; font-size: 1.05em;">
                                <td style="padding: 15px; color: #1e293b;">Total</td>
                                <td style="padding: 15px; text-align: right; color: #1e293b;">¬£${grandTotalCosts.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                <td style="padding: 15px; text-align: right; color: ${grandTotalClaimedThisPeriod > 0 ? '#2563eb' : '#1e293b'};">¬£${grandTotalClaimedThisPeriod.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                <td style="padding: 15px; text-align: right; color: ${grandTotalRemaining < 0 ? '#dc2626' : '#1e293b'};">¬£${grandTotalRemaining.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            </tr>
                        </tbody>
                    </table>
                    ${activeQuarterIndex ? `
                        <p style="margin-top: 12px; color: #64748b; font-size: 0.9em; font-style: italic;">
                            * "Costs claimed this period" shows costs claimed in Q${activeQuarterIndex}. Activate a different quarter to see its claimed costs.
                        </p>
                    ` : `
                        <p style="margin-top: 12px; color: #64748b; font-size: 0.9em; font-style: italic;">
                            * Click a quarter button above to see "Costs claimed this period" for that quarter.
                        </p>
                    `}
                </div>
            `;
        }

        // Track active quarter for highlighting
        let activeQuarterIndex = null;

        function setActiveQuarter(quarterIndex) {
            activeQuarterIndex = quarterIndex;

            // Refresh the entire budget display to update button states and summary
            displayDetailedBudget();

            addLog(`‚úÖ Active quarter set to Q${quarterIndex}`);

            // Scroll to the quarterly tracking section
            const quarterSection = document.getElementById('quarterControlsSection');
            if (quarterSection) {
                quarterSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Delete Project Functions - Immediate deletion without confirmation - v2.0 Updated
        async function deleteProjectImmediately(projectId, projectName) {
            console.log(`üóëÔ∏è [DELETE v2.0] Starting deletion for project ${projectId}: ${projectName}`);

            if (!db) {
                console.error('‚ùå [DELETE] Database not initialized');
                addLog('‚ùå Cannot delete: Database not initialized');
                alert('Database not initialized. Please refresh the page.');
                return;
            }

            console.log(`üóëÔ∏è [DELETE] Database OK, creating transaction...`);

            try {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.delete(projectId);

                console.log(`üóëÔ∏è [DELETE] Delete request sent for ID: ${projectId}`);

                request.onsuccess = () => {
                    console.log(`‚úÖ [DELETE] Project ${projectId} successfully deleted from IndexedDB`);
                    addLog(`üóëÔ∏è Deleted: ${projectName} (ID: ${projectId})`);

                    // If this was the current project, clear it
                    if (projectBudget.projectId === projectId) {
                        console.log(`üßπ [DELETE] Clearing current project data (was active project)`);
                        clearAll();
                    } else {
                        console.log(`‚ÑπÔ∏è [DELETE] Not active project, skipping clearAll()`);
                    }

                    // Reload the dropdown to reflect deletion
                    const dropdown = document.getElementById('savedProjectsDropdown');
                    if (dropdown) {
                        console.log(`üîÑ [DELETE] Dropdown exists, display state: ${dropdown.style.display}`);
                        if (dropdown.style.display === 'block') {
                            console.log(`üîÑ [DELETE] Refreshing projects dropdown...`);
                            listSavedProjects();
                        } else {
                            console.log(`‚ÑπÔ∏è [DELETE] Dropdown hidden, skipping refresh`);
                        }
                    } else {
                        console.warn(`‚ö†Ô∏è [DELETE] Dropdown element not found`);
                    }

                    console.log(`‚úÖ [DELETE] Deletion complete! NO updateProjectCount() call.`);
                };

                request.onerror = (event) => {
                    console.error('‚ùå [DELETE] Delete failed:', event.target.error);
                    addLog(`‚ùå Failed to delete project: ${event.target.error}`);
                    alert(`Failed to delete project: ${event.target.error}`);
                };

                transaction.oncomplete = () => {
                    console.log(`‚úÖ [DELETE] Transaction completed successfully`);
                };

                transaction.onerror = (event) => {
                    console.error('‚ùå [DELETE] Transaction error:', event.target.error);
                };

            } catch (error) {
                console.error('‚ùå [DELETE] Exception caught:', error);
                console.error('‚ùå [DELETE] Stack trace:', error.stack);
                addLog(`‚ùå Delete error: ${error.message}`);
                alert(`Error deleting project: ${error.message}`);
            }
        }

        function clearAll() {
            // Clear input
            document.getElementById('budgetInput').value = '';

            // Clear data arrays
            budgetData = [];
            logs = [];

            // Reset project budget (preserve structure but clear data)
            projectBudget.projectId = null;
            projectBudget.projectName = '';
            projectBudget.projectNumber = '';
            projectBudget.lastModified = null;

            // Clear logs display
            document.getElementById('logContainer').innerHTML = '<div class="log-empty">No logs yet...</div>';
            document.getElementById('logCount').textContent = '0 entries';

            // Hide results section
            const results = document.getElementById('results');
            if (results) results.classList.remove('show');

            const detailedResults = document.getElementById('detailedBudgetResults');
            if (detailedResults) detailedResults.classList.remove('show');

            // Reset project dropdown button
            const currentProjectNameElement = document.getElementById('currentProjectName');
            if (currentProjectNameElement) {
                currentProjectNameElement.textContent = 'Select Project';
            }

            console.log('‚úÖ All data cleared');
        }

        // Toggle fullscreen mode for textarea
        function toggleFullscreenTextarea() {
            const textarea = document.getElementById('budgetInput');

            if (!document.fullscreenElement) {
                // Enter fullscreen
                textarea.requestFullscreen().then(() => {
                    // Apply fullscreen styles
                    textarea.style.width = '100vw';
                    textarea.style.height = '100vh';
                    textarea.style.fontSize = '1em';
                    textarea.style.padding = '20px';
                    textarea.style.margin = '0';
                    textarea.style.border = 'none';
                    textarea.style.borderRadius = '0';
                }).catch(err => {
                    console.error('Failed to enter fullscreen:', err);
                    alert('Fullscreen not supported on this browser');
                });
            } else {
                // Exit fullscreen
                document.exitFullscreen();
            }
        }

        // Reset textarea styles when exiting fullscreen
        document.addEventListener('fullscreenchange', () => {
            const textarea = document.getElementById('budgetInput');
            if (!document.fullscreenElement) {
                // Reset to normal styles
                textarea.style.width = '';
                textarea.style.height = '60px';
                textarea.style.fontSize = '0.85em';
                textarea.style.padding = '8px 12px';
                textarea.style.border = '1px solid #cbd5e1';
                textarea.style.borderRadius = '6px';
            }
        });
    </script>

    <!-- Saved Projects Modal -->
    <div id="projectsModal" class="modal-overlay" onclick="closeProjectsModal(event)">
        <div class="modal-dialog" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">üìö Saved Projects</h2>
                <button class="modal-close" onclick="closeProjectsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <ul id="projectsList" class="project-list"></ul>

                <!-- Delete Confirmation Popup -->
                <div id="deleteConfirmPopup" class="delete-confirm-popup">
                    <div class="delete-confirm-title">‚ö†Ô∏è Delete Project?</div>
                    <div class="delete-confirm-text" id="deleteConfirmText">Are you sure you want to delete this project?</div>
                    <div class="delete-confirm-buttons">
                        <button class="delete-confirm-btn cancel" onclick="hideDeleteConfirmation()">Cancel</button>
                        <button class="delete-confirm-btn confirm" onclick="confirmDeleteProject()">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
