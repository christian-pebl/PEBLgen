<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grants Budget Parser - PEBLGen</title>
    <!-- Google Fonts - PEBL Brand Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400&display=swap" rel="stylesheet">
    <!-- SheetJS library for Excel file support -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- pdf-lib for PDF merging functionality -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Navigation Banner - PEBL Brand Colors */
        .nav-banner { position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); padding: 15px 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 30px; margin-bottom: 0; z-index: 100; }
        .nav-banner h1 { color: white; font-size: 28px; font-weight: 700; margin: 0; font-family: 'Roboto', sans-serif; letter-spacing: 0.5px; }
        .nav-buttons { display: flex; gap: 8px; }
        .nav-btn { background-color: rgba(255, 255, 255, 0.15); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; text-decoration: none; transition: all 0.2s ease; display: inline-block; font-family: 'Roboto', sans-serif; }
        .nav-btn:hover { background-color: rgba(255, 255, 255, 0.25); border-color: rgba(255, 255, 255, 0.5); }
        .nav-btn.active { background-color: rgba(255, 255, 255, 0.9); color: #2B7A78; border-color: rgba(255, 255, 255, 0.9); }

        body {
            font-family: 'Roboto', sans-serif;
            font-weight: 300;
            background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%);
            min-height: 100vh;
            padding: 0;
            padding-top: 90px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px 25px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px 15px;
            }
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            overflow-x: auto;
        }

        #detailedBudgetResults.show {
            display: block !important;
        }

        .card.compact {
            padding: 10px 20px;
            margin-bottom: 8px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
            user-select: none;
        }

        .card-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        h2 {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .subtitle {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 12px;
        }

        .badge {
            background: #e0e7ff;
            color: #4338ca;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
        }

        .chevron {
            transition: transform 0.3s;
        }

        .chevron.open {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.open {
            max-height: 600px;
        }

        .log-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 500px;
            overflow-y: auto;
            overflow-x: hidden;
            color: #475569;
        }

        .log-entry {
            margin-bottom: 4px;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .log-empty {
            color: #94a3b8;
            font-style: italic;
        }

        textarea {
            width: 100%;
            min-height: 100px;
            max-height: 400px;
            height: 130px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            resize: vertical;
            overflow-y: auto;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #3AAFA9;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3AAFA9;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-fullscreen {
            padding: 8px 12px;
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2em;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .btn-fullscreen:hover {
            background: #3AAFA9;
            color: white;
            border-color: #3AAFA9;
            transform: scale(1.05);
        }

        .btn-danger {
            background: transparent;
            color: #ef4444;
            padding: 6px;
        }

        .btn-danger:hover {
            background: #fee2e2;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Highlight animation for transaction rows */
        @keyframes highlightGlow {
            0% {
                background: #dbeafe;
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
            50% {
                background: #bfdbfe;
                box-shadow: 0 0 20px 10px rgba(59, 130, 246, 0.4);
            }
            100% {
                background: #dbeafe;
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
        }

        .transaction-highlight {
            animation: highlightGlow 2s ease-in-out 3;
            background: #dbeafe !important;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #3AAFA9;
        }

        .summary-card.total {
            background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%);
            color: white;
            border-left: none;
        }

        .summary-category {
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #334155;
        }

        .summary-card.total .summary-category {
            color: white;
        }

        .summary-amount {
            font-size: 2em;
            font-weight: 700;
            color: #1e293b;
        }

        .summary-card.total .summary-amount {
            color: white;
        }

        .summary-count {
            font-size: 0.8em;
            color: #64748b;
            margin-top: 4px;
        }

        .summary-card.total .summary-count {
            color: rgba(255, 255, 255, 0.9);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-family: 'Roboto', sans-serif;
        }

        .card > table {
            table-layout: fixed;
        }

        /* Column width distribution for budget tables */
        .card > table th:nth-child(1),
        .card > table td:nth-child(1) {
            width: 6.4%;
        }

        .card > table th:nth-child(2),
        .card > table td:nth-child(2) {
            width: 24%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card > table th:nth-child(3),
        .card > table td:nth-child(3) {
            width: 10%;
        }

        .card > table th:nth-child(4),
        .card > table td:nth-child(4) {
            width: 8%;
        }

        .card > table th:nth-child(5),
        .card > table td:nth-child(5) {
            width: 9.6%;
        }

        .card > table th:nth-child(6),
        .card > table td:nth-child(6) {
            width: 8%;
        }

        .card > table th:nth-child(7),
        .card > table td:nth-child(7) {
            width: 8%;
        }

        .card > table th:nth-child(8),
        .card > table td:nth-child(8) {
            width: 8%;
        }

        /* Ensure breakdown row doesn't affect column widths */
        .card > table tr[id$="-breakdown"] td {
            width: auto !important;
        }

        th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
            font-size: 0.9em;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #f1f5f9;
        }

        tr:hover {
            background: #f8fafc;
        }

        /* Modern Item Table Styling */
        .item-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.04);
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid #f1f5f9;
            max-width: 100%;
            overflow-x: auto;
            position: relative;
        }

        .item-table {
            margin-top: 0 !important;
            font-size: 0.95em;
            width: 100%;
            table-layout: fixed;
        }

        .item-table thead tr {
            border-bottom: 2px solid #e2e8f0;
        }

        .item-table th {
            background: transparent;
            padding: 14px 12px;
            font-weight: 600;
            color: #1e293b;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid #e2e8f0;
        }

        .item-table td {
            padding: 16px 12px;
            color: #475569;
            font-size: 0.9em;
            border-bottom: 1px solid #f8fafc;
        }

        .item-table tbody tr {
            transition: all 0.2s ease;
        }

        .item-table tbody tr:hover {
            background: #f8fafc;
            transform: translateX(2px);
        }

        .item-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Drag and Drop Styling */
        .drag-handle {
            cursor: grab;
            padding: 4px 8px;
            color: #9ca3af;
            font-size: 14px;
            user-select: none;
            transition: color 0.2s;
        }

        .drag-handle:hover {
            color: #6b7280;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .item-table tbody tr.dragging {
            opacity: 0.5;
            background: #dbeafe !important;
        }

        .item-table tbody tr.drag-over {
            border-top: 3px solid #3b82f6;
        }

        .item-table tbody tr.drag-over-bottom {
            border-bottom: 3px solid #3b82f6;
        }

        /* Quarterly Breakdown Table Styling */
        .breakdown-row-cell {
            padding: 0 !important;
            background: transparent !important;
            position: relative !important;
        }

        .quarterly-breakdown-container {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 0;
            padding: 20px;
            margin: 0;
            border: none;
            border-top: 2px solid #e2e8f0;
            box-shadow: none;
            width: 100%;
            box-sizing: border-box;
            overflow-x: auto;
            position: relative;
            left: 0;
        }

        .quarterly-breakdown-header {
            margin: 0 0 16px 0;
            padding: 0 0 12px 0;
            color: #475569;
            font-size: 0.95em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 2px solid #cbd5e1;
        }

        .quarterly-breakdown-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            margin: 0 !important;
            width: 100%;
        }

        .quarterly-breakdown-table thead tr {
            background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%);
        }

        .quarterly-breakdown-table th {
            background: transparent;
            color: white !important;
            padding: 12px;
            font-weight: 600;
            font-size: 0.85em;
            text-align: center;
            border-bottom: none;
        }

        .quarterly-breakdown-table th:first-child {
            text-align: left;
        }

        .quarterly-breakdown-table td {
            padding: 12px;
            text-align: center;
            background: white;
            border-bottom: 1px solid #f1f5f9;
            color: #475569;
            font-size: 0.9em;
        }

        .quarterly-breakdown-table td:first-child {
            text-align: left;
            font-weight: 600;
            color: #1e293b;
        }

        .quarterly-breakdown-table tbody tr:hover {
            background: #f8fafc;
        }

        .quarterly-breakdown-table tbody tr:last-child td {
            border-bottom: none;
            font-weight: 600;
            background: #f8fafc;
        }

        /* Category Summary Row Styling */
        .category-summary-row {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
            font-weight: 700 !important;
            border-top: 3px solid #1976d2 !important;
            cursor: pointer;
        }

        .category-summary-row:hover {
            background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%) !important;
        }

        .category-summary-row.over-budget {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%) !important;
        }

        .category-summary-row.over-budget:hover {
            background: linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%) !important;
        }

        input[type="text"],
        input[type="number"],
        input[type="password"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #3AAFA9;
        }

        .category-section {
            margin-bottom: 30px;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .category-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.95em;
        }

        .category-total {
            color: #64748b;
            font-size: 0.9em;
        }

        .badge-labour { background: #dbeafe; color: #1e40af; }
        .badge-overheads { background: #e9d5ff; color: #6b21a8; }
        .badge-materials { background: #d1fae5; color: #065f46; }
        .badge-subcontracting { background: #fed7aa; color: #9a3412; }
        .badge-capital { background: #fecaca; color: #991b1b; }
        .badge-capitaluse { background: #fecaca; color: #991b1b; }
        .badge-travel { background: #fef3c7; color: #92400e; }
        .badge-other { background: #f1f5f9; color: #475569; }

        .api-key-section {
            background: #fef3c7;
            border: 2px solid #fcd34d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .api-key-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #fcd34d;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            margin-top: 8px;
        }

        .api-key-label {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 5px;
            display: block;
        }

        .api-key-help {
            font-size: 0.85em;
            color: #78350f;
            margin-top: 5px;
        }

        .api-key-help a {
            color: #92400e;
            text-decoration: underline;
        }

        #results {
            display: none;
        }

        #results.show {
            display: block;
        }

        .hidden {
            display: none;
        }

        .drop-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .drop-zone:hover {
            border-color: #3AAFA9;
            background: #f1f5f9;
        }

        .drop-zone.dragover {
            border-color: #3AAFA9;
            background: #e0e7ff;
            border-style: solid;
            transform: scale(1.02);
        }

        .drop-zone-content {
            pointer-events: none;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-dialog {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #94a3b8;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f1f5f9;
            color: #64748b;
        }

        .modal-body {
            padding: 20px 25px;
            overflow-y: auto;
        }

        .project-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .project-item {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-item:hover {
            border-color: #3AAFA9;
            background: #f8fafc;
            transform: translateX(5px);
        }

        .project-info {
            flex: 1;
        }

        .project-name {
            font-weight: 600;
            font-size: 1.1em;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .project-meta {
            font-size: 0.85em;
            color: #64748b;
        }

        .project-arrow {
            font-size: 1.5em;
            color: #cbd5e1;
        }

        .project-item:hover .project-arrow {
            color: #3AAFA9;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .project-delete-btn {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fca5a5;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            margin-right: 10px;
        }

        .project-delete-btn:hover {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .delete-confirm-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #dc2626;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            z-index: 99999;
            min-width: 300px;
            max-width: 500px;
            display: none;
        }

        .delete-confirm-popup.show {
            display: block;
        }

        .delete-confirm-popup.show::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }

        .delete-confirm-title {
            font-weight: 600;
            color: #dc2626;
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .delete-confirm-text {
            color: #64748b;
            margin-bottom: 15px;
            font-size: 0.95em;
        }

        .delete-confirm-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .delete-confirm-btn {
            padding: 6px 16px;
            border-radius: 6px;
            border: none;
            font-size: 0.9em;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .delete-confirm-btn.cancel {
            background: #f1f5f9;
            color: #64748b;
        }

        .delete-confirm-btn.cancel:hover {
            background: #e2e8f0;
        }

        .delete-confirm-btn.confirm {
            background: #dc2626;
            color: white;
        }

        .delete-confirm-btn.confirm:hover {
            background: #b91c1c;
        }

        /* Saved Projects Dropdown */
        .projects-dropdown {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 600px;
            max-width: 700px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 10000;
        }

        .projects-dropdown-content {
            padding: 10px;
        }

        .dropdown-project-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .dropdown-project-item:hover {
            border-color: #3AAFA9;
            background: #f8fafc;
            transform: translateX(3px);
        }

        .dropdown-project-info {
            flex: 1;
            min-width: 0;
        }

        .dropdown-project-name {
            font-weight: 600;
            font-size: 0.95em;
            color: #1e293b;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .dropdown-project-meta {
            font-size: 0.8em;
            color: #64748b;
            margin-top: 2px;
        }

        .dropdown-delete-btn {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 500;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .dropdown-delete-btn:hover {
            background: #fecaca;
        }

        .dropdown-edit-btn {
            background: #dbeafe;
            color: #1e40af;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 500;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .dropdown-edit-btn:hover {
            background: #bfdbfe;
        }

        .dropdown-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal-dialog {
            background: white;
            border-radius: 12px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #94a3b8;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f1f5f9;
            color: #64748b;
        }

        .modal-body {
            padding: 24px;
        }

        .btn-delete {
            padding: 10px 20px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.95em;
        }

        .btn-delete:hover {
            background: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
        }
    </style>

    <!-- Automatic Cloud Backup System -->
    <script src="supabase-client.js"></script>
    <script src="auto-sync-manager.js"></script>
    <script src="sync-status-indicator.js"></script>
</head>
<body>
    <!-- Navigation Banner -->
    <div class="nav-banner">
        <h1>PEBLGen</h1>
        <div class="nav-buttons">
            <a href="grants.html" class="nav-btn active">Grants</a>
            <a href="spend.html" class="nav-btn">Spend</a>
            <a href="gantt.html" class="nav-btn">Gantt</a>
            <a href="timesheet.html" class="nav-btn">Labour</a>
            <a href="index.html" class="nav-btn">Sketcher</a>
            <a href="exploit.html" class="nav-btn">Exploit</a>
            <a href="risks.html" class="nav-btn">Risks</a>
            <a href="quote.html" class="nav-btn">Quote</a>
            <button onclick="refreshTransactionData()" class="nav-btn" style="background-color: rgba(76, 175, 80, 0.8); margin-left: auto;" title="Refresh transactions and PDFs from Spend page">üîÑ Sync Spend Data</button>
            <button onclick="resetBackupAuth()" class="nav-btn" style="background-color: rgba(255, 255, 255, 0.15);" title="Reset cloud backup authentication">üîÑ Reset Backup</button>
            <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="nav-btn" style="background-color: rgba(255, 255, 255, 0.15);" title="Scroll to top">‚Üë Top</button>
        </div>
    </div>

    <div class="container">
        <!-- Input Section with System Log -->
        <div class="card compact">
            <!-- Top toolbar with flexible wrapping -->
            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
                <!-- Row 1: Title and Project Selection -->
                <span style="font-weight: 600; font-size: 0.95em; white-space: nowrap;">üí∞ Budget Manager</span>

                <!-- Saved Projects Dropdown Selector -->
                <div style="position: relative;">
                    <button class="btn-secondary" onclick="toggleSavedProjectsDropdown()" id="savedProjectsBtn" style="padding: 8px 16px; font-size: 0.9em; white-space: nowrap; display: flex; align-items: center; gap: 6px;">
                        <span>üìö</span>
                        <span id="currentProjectName">Select Project</span>
                        <span style="font-size: 0.7em;">‚ñº</span>
                    </button>
                    <div id="savedProjectsDropdown" class="projects-dropdown" style="display: none;">
                        <div class="projects-dropdown-content" id="projectsDropdownList">
                            <!-- Projects will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Compact Funding Body Selector -->
                <div style="position: relative;">
                    <button id="fundingBodyBtn" onclick="toggleFundingBodyDropdown()"
                            style="padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 1.2em; background: white; cursor: pointer; display: flex; align-items: center;"
                            title="Funding Body Format">
                        <span id="fundingBodyIcon">üîç</span>
                    </button>
                    <div id="fundingBodyDropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 5px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 100; min-width: 150px;">
                        <div onclick="selectFundingBody('auto', 'üîç', 'Auto-Detect')" style="padding: 8px 12px; cursor: pointer; font-size: 0.9em;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">üîç Auto-Detect</div>
                        <div onclick="selectFundingBody('iuk', 'üá¨üáß', 'Innovate UK')" style="padding: 8px 12px; cursor: pointer; font-size: 0.9em; border-top: 1px solid #f1f5f9;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">üá¨üáß Innovate UK</div>
                        <div onclick="selectFundingBody('welshgov', 'üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø', 'Welsh Gov')" style="padding: 8px 12px; cursor: pointer; font-size: 0.9em; border-top: 1px solid #f1f5f9;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø Welsh Gov</div>
                        <div onclick="selectFundingBody('simple_summary', 'üìã', 'Simple Summary (WWF)')" style="padding: 8px 12px; cursor: pointer; font-size: 0.9em; border-top: 1px solid #f1f5f9;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">üìã Simple Summary (WWF)</div>
                    </div>
                </div>

                <!-- Parse Budget Toggle Button -->
                <button class="btn-secondary" onclick="toggleParseBudgetSection()" style="padding: 8px 16px; font-size: 0.9em; white-space: nowrap; display: flex; align-items: center; gap: 6px;">
                    <span>Parse Budget</span>
                    <span class="chevron" id="parseSectionChevron" style="font-size: 0.7em;">‚ñº</span>
                </button>

                <button class="btn-secondary" onclick="clearAll()" style="padding: 8px 16px; font-size: 0.9em; white-space: nowrap;">Clear</button>

                <!-- Download JSON Button -->
                <button class="btn-secondary" onclick="exportProjectJSON()" style="padding: 8px 16px; font-size: 0.9em; white-space: nowrap; display: flex; align-items: center; gap: 6px;">
                    <span>Download JSON</span>
                </button>

                <!-- Load Project Button -->
                <button class="btn-secondary" onclick="document.getElementById('loadProjectInput').click()" style="padding: 8px 16px; font-size: 0.9em; white-space: nowrap; display: flex; align-items: center; gap: 6px;">
                    <span>Load Project</span>
                </button>
                <input type="file" id="loadProjectInput" accept=".json" style="display: none;" onchange="loadProjectJSON(event)">

                <!-- Spacer to push System Log to the right -->
                <div style="flex: 1; min-width: 20px;"></div>

                <!-- System Log Toggle (anchored right) -->
                <div onclick="toggleLog()" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f8fafc; border-radius: 6px; cursor: pointer; border: 1px solid #e2e8f0; white-space: nowrap;">
                    <span style="font-weight: 600; font-size: 0.85em; color: #475569;">System Log</span>
                    <span class="badge" id="logCount" style="padding: 2px 8px; font-size: 0.7em;">0 entries</span>
                    <span class="chevron" id="logChevron" style="font-size: 0.8em;">‚ñº</span>
                </div>
            </div>
        </div>

        <!-- Parse Budget Section (Collapsible) -->
        <div class="collapsible-content" id="parseBudgetSection" style="margin-bottom: 12px;">
            <div class="card compact">
                <!-- Text input row with fullscreen button -->
                <div style="display: flex; gap: 8px; align-items: flex-start;">
                    <textarea id="budgetInput" style="flex: 1; min-height: 60px; height: 60px; max-height: 800px; resize: vertical; padding: 8px 12px; font-size: 0.85em; font-family: 'Courier New', monospace; line-height: 1.4; overflow-y: auto; border: 1px solid #cbd5e1; border-radius: 6px;" placeholder="Paste your FULL PROJECT BUDGET text here... The AI will automatically detect the format (Labour, Overheads, Materials, etc.)"></textarea>
                    <button class="btn-fullscreen" onclick="toggleFullscreenTextarea()" title="Expand to fullscreen (ESC to exit)">
                        ‚õ∂
                    </button>
                </div>
                <!-- Parse Button -->
                <div style="margin-top: 10px;">
                    <button class="btn-primary" id="parseBtn" onclick="parseBudget()" style="padding: 8px 20px; font-size: 0.9em; white-space: nowrap;">
                        <span>üìä</span>
                        <span id="parseBtnText">Parse Budget</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- System Log Content (Collapsible) -->
        <div class="collapsible-content" id="logContent" style="margin-bottom: 12px;">
            <div class="card compact">
                <div class="log-container" id="logContainer" style="max-height: 300px;">
                    <div class="log-empty">No logs yet...</div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="card" id="results">
            <div class="card-header">
                <h2 class="card-title">Budget Breakdown</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-secondary" onclick="saveBudgetProfile()">
                        <span>üíæ</span>
                        Save Profile
                    </button>
                    <button class="btn-secondary" onclick="document.getElementById('loadProfileInput').click()">
                        <span>üìÇ</span>
                        Load Profile
                    </button>
                    <button class="btn-secondary" onclick="exportCSV()">
                        <span>üìä</span>
                        Export CSV
                    </button>
                </div>
                <input type="file" id="loadProfileInput" accept=".json" style="display: none;" onchange="loadBudgetProfile(event)">
            </div>

            <!-- Summary Cards -->
            
let activeQuarter = 2; // Default to Q2 as current claiming period
            <!-- Active Quarter Selector -->
            <div style="margin-bottom: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 2px solid #ff9800;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-weight: 600; color: #e65100;">üìÖ Active Claiming Period:</span>
                    <div style="display: flex; gap: 10px;">
                        <button class="quarter-btn" data-quarter="1" onclick="setActiveQuarter(1)" style="padding: 8px 16px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-weight: 500;">Q1</button>
                        <button class="quarter-btn active-quarter" data-quarter="2" onclick="setActiveQuarter(2)" style="padding: 8px 16px; border: 2px solid #ff9800; border-radius: 6px; background: #ff9800; color: white; cursor: pointer; font-weight: 500;">Q2</button>
                        <button class="quarter-btn" data-quarter="3" onclick="setActiveQuarter(3)" style="padding: 8px 16px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-weight: 500;">Q3</button>
                        <button class="quarter-btn" data-quarter="4" onclick="setActiveQuarter(4)" style="padding: 8px 16px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-weight: 500;">Q4</button>
                    </div>
                    <span id="activeQuarterLabel" style="color: #e65100; font-weight: 600;">‚Üê Currently claiming for Q2</span>
                </div>
            </div>

            <div class="summary-grid" id="summaryGrid"></div>

            <!-- Detailed Tables -->
            <div id="tablesContainer"></div>
        </div>

        <!-- Detailed Project Budget Display -->
        <div class="card" id="detailedBudgetResults" style="display: block;">
            <!-- Finance Summary Section -->
            <div id="financeSummarySection"></div>

            <!-- Quarter Controls Section -->
            <div id="quarterControlsSection"></div>

            <!-- Budget Summary Overview Section -->
            <div id="budgetSummaryOverview" style="display: none;"></div>

            <!-- Labour Section -->
            <div id="labourSection"></div>

            <!-- Overheads & Materials Section -->
            <div id="overheadsMaterialsSection"></div>

            <!-- Capital & Subcontracting Section -->
            <div id="capitalSubcontractingSection"></div>

            <!-- Travel & Other Costs Section -->
            <div id="travelOtherSection"></div>

            <!-- Add Item Button and Undo Controls -->
            <div id="addItemButtonContainer" style="display: none; margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f0fdfa 0%, #e0f7f6 100%); border-radius: 8px; border: 2px dashed #3AAFA9;">
                <div style="display: flex; gap: 10px; align-items: stretch;">
                    <!-- Add Item Button -->
                    <button onclick="openAddItemModal()" style="flex: 1; padding: 15px 20px; background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(58,175,169,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <span style="font-size: 1.3em;">‚ûï</span>
                        <span>Add New Budget Item</span>
                    </button>

                    <!-- Undo Button -->
                    <button id="undoButton" onclick="undoLastAction()" disabled style="padding: 15px 20px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: not-allowed; font-size: 1em; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; min-width: 120px; transition: all 0.2s;" title="Undo last action (Ctrl+Z)">
                        <span style="font-size: 1.2em;">‚Ü∂</span>
                        <span>Undo</span>
                    </button>

                    <!-- History Button -->
                    <button onclick="toggleHistoryPanel()" style="padding: 15px 20px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; min-width: 120px; transition: all 0.2s;" onmouseover="this.style.background='#d97706'" onmouseout="this.style.background='#f59e0b'" title="View action history">
                        <span style="font-size: 1.2em;">üìú</span>
                        <span>History</span>
                        <span id="historyCount" style="background: white; color: #f59e0b; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 700;">0</span>
                    </button>
                </div>

                <!-- History Panel (collapsible) -->
                <div id="historyPanel" style="display: none; margin-top: 15px; background: white; border-radius: 8px; border: 1px solid #e2e8f0; max-height: 300px; overflow-y: auto;">
                    <div style="padding: 12px 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0;">
                        <span style="font-weight: 600; color: #334155;">üìú Action History</span>
                        <button onclick="clearHistory()" style="background: #ef4444; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: 500;" title="Clear all history">Clear All</button>
                    </div>
                    <div id="historyList" style="padding: 10px;">
                        <p style="color: #94a3b8; text-align: center; margin: 20px 0; font-style: italic;">No actions recorded yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="addItemModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <!-- Modal Header -->
            <div style="background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 1.2em;">‚ûï Add Budget Item</h3>
                <button onclick="closeAddItemModal()" style="background: transparent; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='transparent'">‚úï</button>
            </div>

            <!-- Modal Body -->
            <div style="padding: 20px;">
                <!-- Step 1: Select Category -->
                <div id="addItemStep1">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #334155;">Select Category:</label>
                    <select id="addItemCategory" onchange="showAddItemFields()" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; margin-bottom: 15px; cursor: pointer;">
                        <option value="">-- Choose a category --</option>
                        <option value="labour">üë∑ Labour (Staff)</option>
                        <option value="materials">üì¶ Materials</option>
                        <option value="capitalUsage">üè≠ Capital Usage</option>
                        <option value="subcontracting">ü§ù Subcontracting</option>
                        <option value="travel">‚úàÔ∏è Travel & Subsistence</option>
                        <option value="otherCosts">üìã Other Costs</option>
                    </select>
                </div>

                <!-- Step 2: Item Fields (shown based on category) -->
                <div id="addItemStep2" style="display: none;">
                    <!-- Labour Fields -->
                    <div id="labourFields" style="display: none;">
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #475569;">Role/Position:</label>
                            <input type="text" id="addLabourRole" placeholder="e.g., Project Manager" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #475569;">Gross Cost (¬£):</label>
                                <input type="number" id="addLabourGrossCost" placeholder="0" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #475569;">Days:</label>
                                <input type="number" id="addLabourDays" placeholder="0" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em;">
                            </div>
                        </div>
                    </div>

                    <!-- Materials / Capital / Subcontracting / Other Costs Fields -->
                    <div id="genericItemFields" style="display: none;">
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #475569;">Item Description:</label>
                            <input type="text" id="addItemDescription" placeholder="e.g., Lab Equipment" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #475569;">Quantity:</label>
                                <input type="number" id="addItemQuantity" value="1" min="1" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #475569;">Cost Per Item (¬£):</label>
                                <input type="number" id="addItemCostPerItem" placeholder="0" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em;">
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: #f8fafc; border-radius: 6px;">
                            <span style="color: #64748b; font-size: 0.9em;">Total: </span>
                            <span id="addItemTotal" style="font-weight: 600; color: #1e293b;">¬£0</span>
                        </div>
                    </div>

                    <!-- Travel Fields -->
                    <div id="travelFields" style="display: none;">
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #475569;">Description:</label>
                            <input type="text" id="addTravelDescription" placeholder="e.g., Conference in London" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #475569;">Trips:</label>
                                <input type="number" id="addTravelTrips" value="1" min="1" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #475569;">Cost/Trip (¬£):</label>
                                <input type="number" id="addTravelCostPerTrip" placeholder="0" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #475569;">S&S/Trip (¬£):</label>
                                <input type="number" id="addTravelSubsistence" placeholder="0" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em;">
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: #f8fafc; border-radius: 6px;">
                            <span style="color: #64748b; font-size: 0.9em;">Total: </span>
                            <span id="addTravelTotal" style="font-weight: 600; color: #1e293b;">¬£0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div style="padding: 15px 20px; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeAddItemModal()" style="padding: 10px 20px; background: #f1f5f9; color: #475569; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Cancel</button>
                <button onclick="saveNewItem()" id="saveNewItemBtn" style="padding: 10px 20px; background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: none;">
                    ‚úì Add Item
                </button>
            </div>
        </div>
    </div>

    <!-- Welsh Gov Add Item Modal -->
    <div id="addWelshGovItemModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <!-- Modal Header -->
            <div style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 1.2em;">‚ûï Add Welsh Gov Item</h3>
                <button onclick="closeAddWelshGovItemModal()" style="background: transparent; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='transparent'">‚úï</button>
            </div>

            <!-- Modal Body -->
            <div style="padding: 20px;">
                <!-- Select Category -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #334155;">Select Category:</label>
                    <select id="addWelshGovCategory" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; cursor: pointer;">
                        <option value="capital.nonStandard">üèóÔ∏è Capital - Non Standard Costs</option>
                        <option value="revenue.nonStandard">üìä Revenue - Non Standard Costs</option>
                        <option value="revenue.standardCosts">üìã Revenue - Standard Costs</option>
                    </select>
                </div>

                <!-- Item Fields -->
                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #475569;">Item Code:</label>
                    <input type="text" id="addWelshGovItemCode" placeholder="e.g., GF030" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em;">
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #475569;">Description:</label>
                    <textarea id="addWelshGovDescription" rows="3" placeholder="Enter item description" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em; resize: vertical;"></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div>
                        <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #475569;">Total Cost (¬£):</label>
                        <input type="number" id="addWelshGovTotalCost" placeholder="0" onchange="updateWelshGovMaxGrant()" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #475569;">Grant Rate (%):</label>
                        <input type="number" id="addWelshGovGrantRate" value="80" min="0" max="100" onchange="updateWelshGovMaxGrant()" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em;">
                    </div>
                </div>

                <div style="padding: 12px; background: #f0fdf4; border-radius: 6px; border-left: 3px solid #10b981;">
                    <span style="color: #64748b; font-size: 0.9em;">Maximum Grant Value: </span>
                    <span id="addWelshGovMaxGrant" style="font-weight: 600; color: #059669; font-size: 1.1em;">¬£0</span>
                </div>
            </div>

            <!-- Modal Footer -->
            <div style="padding: 15px 20px; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeAddWelshGovItemModal()" style="padding: 10px 20px; background: #f1f5f9; color: #475569; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Cancel</button>
                <button onclick="saveNewWelshGovItem()" style="padding: 10px 20px; background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    ‚úì Add Item
                </button>
            </div>
        </div>
    </div>

    <script>
        console.log('=== GRANTS.HTML SCRIPT LOADING ===');

        // Get API key from localStorage (user must set it via UI)
        function getAPIKey() {
            const key = localStorage.getItem('openai_api_key');
            if (!key) {
                console.warn('‚ö†Ô∏è No OpenAI API key found in localStorage. Please set it via the settings menu.');
            }
            return key;
        }

        // Reset cloud backup authentication
        function resetBackupAuth() {
            if (confirm('üîÑ Reset Cloud Backup Authentication?\n\nThis will:\n‚úì Clear your current backup credentials\n‚úì Create a new backup account\n‚úì Re-enable automatic backup\n\nYour data will NOT be deleted.\n\nContinue?')) {
                console.log('üîÑ Resetting backup authentication...');

                // Clear old credentials
                localStorage.removeItem('peblgen_device_id');
                localStorage.removeItem('peblgen_device_password');

                // Show success message
                alert('‚úÖ Backup credentials cleared!\n\nPage will reload with fresh authentication.');
                console.log('‚úÖ Backup credentials cleared, reloading...');

                // Force hard reload (bypass cache) with timestamp
                window.location.href = window.location.pathname + '?nocache=' + Date.now();
            }
        }

        let budgetData = [];
        let logs = [];
        console.log('Variables initialized');

        // Project Budget Data Model (for detailed parsing)
        let projectBudget = {
            projectId: null,
            projectName: '',
            projectNumber: '',
            lastModified: null,

            // Finance Summary
            financeSummary: {
                projectDuration: '',
                projectStartMonth: null, // 1-12
                projectStartYear: null, // e.g., 2024
                projectDurationMonths: null, // number of months
                totalCosts: 0,
                fundingLevel: 0,
                fundingSought: 0,
                otherPublicFunding: 0,
                contribution: 0
            },

            // Labour
            labour: {
                workingDaysPerYear: 232,
                staff: [], // {role, grossCost, ratePerDay, days, totalCost}
                totalCost: 0,
                hasPAYE: true
            },

            // Overheads
            overheads: {
                percentage: 20,
                labourCosts: 0,
                totalCost: 0
            },

            // Materials
            materials: {
                items: [], // {item, quantity, costPerItem, total}
                totalCost: 0
            },

            // Capital Usage
            capitalUsage: {
                items: [], // {description, newOrExisting, depreciationPeriod, netPresentValue, residualValue, utilisation, netCost}
                totalCost: 0
            },

            // Subcontracting
            subcontracting: {
                contractors: [], // {name, country, role, cost}
                totalCost: 0
            },

            // Travel
            travel: {
                trips: [], // {purpose, numberOfTimes, costEach, total}
                totalCost: 0
            },

            // Other Costs
            otherCosts: {
                items: [], // {description, estimatedCost}
                totalCost: 0
            }
        };
        console.log('Project budget data model initialized');

        // IndexedDB Setup
        let db;
        const DB_NAME = 'PEBLGrantsBudgets';
        const DB_VERSION = 6; // Updated to version 6 to match current browser database
        const STORE_NAME = 'projects';
        const CSV_STORE_NAME = 'csvFiles'; // Added by spend.html
        const INVOICES_STORE_NAME = 'invoices'; // Added for spend.html invoice storage

        async function initIndexedDB() {

            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                // Add timeout to detect hanging requests
                const timeout = setTimeout(() => {
                console.log('üóëÔ∏è [DELETE] Setting up click-outside listener with 100ms delay');
                    console.warn('‚ö†Ô∏è [DB INIT] Database initialization timeout (10s) - continuing without DB');
                    if (!db) {
                        addLog('‚ö†Ô∏è Database initialization timeout - features may be limited');
                        resolve(null);
                    }
                }, 10000); // 10 second timeout

                request.onerror = (event) => {
                    clearTimeout(timeout);
                    console.error('‚ùå [DB INIT] IndexedDB error:', request.error);
                    console.error('‚ùå [DB INIT] Error name:', request.error?.name);
                    console.error('‚ùå [DB INIT] Error message:', request.error?.message);
                    console.error('‚ùå [DB INIT] Error event:', event);
                    console.error('‚ùå [DB INIT] Request state:', request.readyState);
                    // Don't reject - continue without DB to allow app to load
                    db = null;
                    addLog('‚ùå Database initialization failed - features may be limited');
                    resolve(null);
                };

                request.onsuccess = () => {
                    clearTimeout(timeout);
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    console.log(`üîß [DB UPGRADE] Upgrading IndexedDB from v${event.oldVersion} to v${event.newVersion}`);
                    const database = event.target.result;

                    // Create projects object store if it doesn't exist
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = database.createObjectStore(STORE_NAME, { keyPath: 'projectId', autoIncrement: true });
                        objectStore.createIndex('projectName', 'projectName', { unique: false });
                        objectStore.createIndex('projectNumber', 'projectNumber', { unique: false });
                        objectStore.createIndex('lastModified', 'lastModified', { unique: false });
                        console.log('‚úÖ Created projects object store');
                    } else {
                        console.log('‚úì Projects store already exists');
                    }

                    // Create CSV files object store if it doesn't exist (for spend.html compatibility)
                    if (!database.objectStoreNames.contains(CSV_STORE_NAME)) {
                        const csvStore = database.createObjectStore(CSV_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        csvStore.createIndex('fileName', 'fileName', { unique: false });
                        csvStore.createIndex('uploadDate', 'uploadDate', { unique: false });
                        console.log('‚úÖ Created CSV files object store');
                    } else {
                        console.log('‚úì CSV files store already exists');
                    }

                    // Create invoices object store if it doesn't exist (for spend.html compatibility)
                    if (!database.objectStoreNames.contains(INVOICES_STORE_NAME)) {
                        const invoicesStore = database.createObjectStore(INVOICES_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        invoicesStore.createIndex('transactionIndex', 'transactionIndex', { unique: false });
                        invoicesStore.createIndex('filename', 'filename', { unique: false });
                        invoicesStore.createIndex('uploadDate', 'uploadDate', { unique: false });
                        console.log('‚úÖ Created invoices object store');
                    } else {
                        console.log('‚úì Invoices store already exists');
                    }
                };

                request.onblocked = () => {
                    console.warn('‚ö†Ô∏è IndexedDB upgrade blocked - close other tabs using this database');
                };
            });
        }

        // Transaction and Invoice Loading (for Spend integration)
        let cachedTransactions = null;
        let cachedInvoices = null;

        // Load all transactions from csvFiles store
        async function loadAllTransactions() {
            if (!db) await initIndexedDB();
            if (!db) return [];

            try {
                // Check if csvFiles store exists
                if (!db.objectStoreNames.contains(CSV_STORE_NAME)) {
                    console.log('[TRANSACTIONS] CSV files store not found');
                    return [];
                }

                const transaction = db.transaction([CSV_STORE_NAME], 'readonly');
                const store = transaction.objectStore(CSV_STORE_NAME);
                const allFiles = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                // Flatten all transactions from all CSV files
                const allTransactions = [];
                allFiles.forEach(file => {
                    if (file.transactions && Array.isArray(file.transactions)) {
                        allTransactions.push(...file.transactions);
                    }
                });

                return allTransactions;
            } catch (error) {
                console.error('‚ùå [TRANSACTIONS] Failed to load transactions:', error);
                return [];
            }
        }

        // Migrate transaction refs from transaction level to assignment level
        async function migrateTransactionRefs() {
            if (!db) await initIndexedDB();
            if (!db) return;

            try {
                const txn = db.transaction([CSV_STORE_NAME], 'readwrite');
                const store = txn.objectStore(CSV_STORE_NAME);
                const allFiles = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                let migratedCount = 0;
                let filesUpdated = 0;

                for (const file of allFiles) {
                    if (file.transactions && Array.isArray(file.transactions)) {
                        let fileModified = false;

                        for (const transaction of file.transactions) {
                            // If transaction has a transactionRef but assignments don't
                            if (transaction.transactionRef && transaction.assignments && Array.isArray(transaction.assignments)) {
                                for (const assignment of transaction.assignments) {
                                    // Only migrate if assignment doesn't already have a ref
                                    if (!assignment.transactionRef) {
                                        assignment.transactionRef = transaction.transactionRef;
                                        migratedCount++;
                                        fileModified = true;
                                        console.log(`‚úÖ [MIGRATION] Migrated ref "${transaction.transactionRef}" to assignment: ${assignment.category} - ${assignment.itemKey}`);
                                    }
                                }
                            }
                        }

                        // Save the file if we modified it
                        if (fileModified) {
                            await new Promise((resolve, reject) => {
                                const updateRequest = store.put(file);
                                updateRequest.onsuccess = () => resolve();
                                updateRequest.onerror = () => reject(updateRequest.error);
                            });
                            filesUpdated++;
                        }
                    }
                }

                if (migratedCount > 0) {
                    console.log(`‚úÖ [MIGRATION] Successfully migrated ${migratedCount} transaction refs across ${filesUpdated} files`);
                    addLog(`‚úÖ Restored ${migratedCount} transaction references`);

                    // Refresh cached transactions
                    cachedTransactions = await loadAllTransactions();
                }

            } catch (error) {
                console.error('‚ùå [MIGRATION] Failed to migrate transaction refs:', error);
            }
        }

        // Update transaction reference for a specific assignment in IndexedDB
        async function updateTransactionRef(transactionDate, transactionDescription, projectId, category, itemKey, newRef) {
            if (!db) await initIndexedDB();
            if (!db) {
                throw new Error('Database not initialized');
            }

            try {
                console.log(`üîç [TRANSACTION REF] Searching for assignment to update:`, {
                    transactionDate,
                    transactionDescription: transactionDescription?.substring(0, 50),
                    projectId,
                    category,
                    itemKey,
                    newRef
                });

                // Check if the new ref already exists in ANY assignment
                const allTransactions = await loadAllTransactions();
                for (const t of allTransactions) {
                    if (t.assignments && Array.isArray(t.assignments)) {
                        for (const assignment of t.assignments) {
                            if (assignment.transactionRef === newRef) {
                                // Skip if this is the same assignment we're updating
                                if (t.date === transactionDate &&
                                    t.description === transactionDescription &&
                                    assignment.projectId === projectId &&
                                    assignment.category === category &&
                                    assignment.itemKey === itemKey) {
                                    console.log(`‚ÑπÔ∏è [TRANSACTION REF] Same assignment - allowing update`);
                                    continue;
                                }
                                throw new Error(`Transaction reference "${newRef}" already exists for another assignment`);
                            }
                        }
                    }
                }

                // Get all CSV files
                const txn = db.transaction([CSV_STORE_NAME], 'readwrite');
                const store = txn.objectStore(CSV_STORE_NAME);
                const allFiles = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                // Find and update the specific assignment in the transaction
                let updated = false;
                for (const file of allFiles) {
                    if (file.transactions && Array.isArray(file.transactions)) {
                        const txIndex = file.transactions.findIndex(t =>
                            t.date === transactionDate && t.description === transactionDescription
                        );

                        if (txIndex !== -1) {
                            const transaction = file.transactions[txIndex];
                            console.log(`‚úÖ [TRANSACTION REF] Found transaction with ${transaction.assignments?.length || 0} assignments`);

                            if (transaction.assignments && Array.isArray(transaction.assignments)) {
                                // Try multiple matching strategies
                                let assignmentIndex = -1;

                                // Strategy 1: Exact match with all fields
                                assignmentIndex = transaction.assignments.findIndex(a =>
                                    a.projectId === projectId &&
                                    a.category === category &&
                                    a.itemKey === itemKey
                                );

                                // Strategy 2: Match with type conversion (projectId might be string vs number)
                                if (assignmentIndex === -1) {
                                    assignmentIndex = transaction.assignments.findIndex(a =>
                                        String(a.projectId) === String(projectId) &&
                                        a.category === category &&
                                        String(a.itemKey || '') === String(itemKey || '')
                                    );
                                }

                                // Strategy 3: If itemKey is null/undefined, match just category and project
                                if (assignmentIndex === -1 && (!itemKey || itemKey === 'null' || itemKey === 'undefined')) {
                                    console.log(`üîç [TRANSACTION REF] Trying category-only match (no itemKey)`);
                                    assignmentIndex = transaction.assignments.findIndex(a =>
                                        String(a.projectId) === String(projectId) &&
                                        a.category === category
                                    );
                                }

                                if (assignmentIndex !== -1) {
                                    console.log(`‚úÖ [TRANSACTION REF] Found assignment at index ${assignmentIndex}:`, transaction.assignments[assignmentIndex]);

                                    // Update the transactionRef for this specific assignment
                                    transaction.assignments[assignmentIndex].transactionRef = newRef;

                                    // Save the updated file back to IndexedDB
                                    await new Promise((resolve, reject) => {
                                        const updateRequest = store.put(file);
                                        updateRequest.onsuccess = () => resolve();
                                        updateRequest.onerror = () => reject(updateRequest.error);
                                    });

                                    updated = true;
                                    console.log(`‚úÖ [TRANSACTION REF] Updated reference to "${newRef}" for assignment: ${transactionDate} - ${category} - ${itemKey}`);
                                    break;
                                } else {
                                    console.error(`‚ùå [TRANSACTION REF] No matching assignment found. Available assignments:`,
                                        transaction.assignments.map(a => ({
                                            projectId: a.projectId,
                                            category: a.category,
                                            itemKey: a.itemKey,
                                            currentRef: a.transactionRef
                                        }))
                                    );
                                }
                            }
                        }
                    }
                }

                if (!updated) {
                    throw new Error('Assignment not found in database');
                }

                // Refresh cached transactions
                cachedTransactions = await loadAllTransactions();

                return true;
            } catch (error) {
                console.error('‚ùå [TRANSACTION REF] Failed to update transaction reference:', error);
                throw error;
            }
        }

        // Load all invoice attachments
        async function loadInvoiceAttachments() {
            if (!db) await initIndexedDB();
            if (!db) return [];

            try {
                // Check if invoices store exists
                if (!db.objectStoreNames.contains(INVOICES_STORE_NAME)) {
                    console.log('üìé [INVOICES] Invoices store not found');
                    return [];
                }

                const transaction = db.transaction([INVOICES_STORE_NAME], 'readonly');
                const store = transaction.objectStore(INVOICES_STORE_NAME);
                const allInvoices = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                return allInvoices;
            } catch (error) {
                console.error('‚ùå [INVOICES] Failed to load invoices:', error);
                return [];
            }
        }

        // Get transactions for a specific item and quarter
        function getTransactionsForItem(allTransactions, projectId, category, itemKey, quarter = null) {
            const filtered = allTransactions.filter(transaction => {
                if (!transaction.assignments || !Array.isArray(transaction.assignments)) return false;

                const matchingAssignment = transaction.assignments.find(assignment => {
                    const projectMatch = assignment.projectId === projectId || String(assignment.projectId) === String(projectId);
                    const categoryMatch = assignment.category === category;

                    // Check itemKey with backwards compatibility
                    let itemMatch = false;
                    if (itemKey === null || itemKey === undefined) {
                        itemMatch = true;
                    } else {
                        if (assignment.itemKey === itemKey) {
                            itemMatch = true;
                        } else if (!assignment.itemKey || assignment.itemKey === null || assignment.itemKey === undefined) {
                            itemMatch = true;
                        } else {
                            itemMatch = false;
                        }
                    }

                    const quarterMatch = quarter === null || assignment.quarter === quarter;
                    return projectMatch && categoryMatch && itemMatch && quarterMatch;
                });

                return !!matchingAssignment;
            });

            return filtered;
        }

        // Find invoice for a transaction
        function getInvoiceForTransaction(transaction, invoices) {
            if (!invoices || invoices.length === 0) return null;

            // Try to match by date and description substring
            return invoices.find(inv => {
                if (!inv.transactionDate || !transaction.date) return false;

                const dateMatch = inv.transactionDate === transaction.date;
                const descMatch = inv.description &&
                    transaction.description &&
                    (inv.description.includes(transaction.description.substring(0, 20)) ||
                     transaction.description.includes(inv.description.substring(0, 20)));

                return dateMatch && descMatch;
            });
        }

        // Helper function to find invoice for a transaction
        function getInvoiceForTransaction(transaction, invoices) {
            if (!transaction || !invoices || invoices.length === 0) {
                return null;
            }

            // Method 1: Check if transaction has invoiceId
            if (transaction.invoiceId) {
                const match = invoices.find(inv => inv.id === transaction.invoiceId);
                if (match) {
                    console.log('üìé [PDF MATCH] Found by invoiceId:', transaction.invoiceId);
                    return match;
                }
            }

            // Method 2: Try matching by transaction index
            if (transaction.originalIndex !== undefined) {
                const match = invoices.find(inv => inv.transactionIndex === transaction.originalIndex);
                if (match) {
                    console.log('üìé [PDF MATCH] Found by originalIndex:', transaction.originalIndex);
                    return match;
                }
            }

            // Method 3: Try matching by date and description (fuzzy match)
            const dateMatch = invoices.find(inv => {
                if (!inv.transactionDate || !transaction.date) return false;

                const dateMatches = inv.transactionDate === transaction.date;
                const descMatch = inv.description && transaction.description &&
                    (inv.description.toLowerCase().includes(transaction.description.toLowerCase().substring(0, 20)) ||
                     transaction.description.toLowerCase().includes(inv.description.toLowerCase().substring(0, 20)));

                return dateMatches && descMatch;
            });

            if (dateMatch) {
                console.log('üìé [PDF MATCH] Found by date+description fuzzy match');
                return dateMatch;
            }

            console.log('üìé [PDF MATCH] No match found for transaction:', {
                date: transaction.date,
                desc: transaction.description?.substring(0, 30),
                invoiceId: transaction.invoiceId,
                originalIndex: transaction.originalIndex,
                availableInvoices: invoices.length
            });

            return null;
        }

        // Generate transaction reference number: A + MMDD + sequential counter (01-99)
        // This creates unique references like A092301 for the first transaction on Sept 23
        function generateTransactionRef(transaction, allTransactions) {
            // If transaction already has a reference, return it
            if (transaction.transactionRef) {
                return transaction.transactionRef;
            }

            // Parse the date to get month and day
            const dateStr = transaction.date || '';
            const dateParts = dateStr.split('/'); // Assuming DD/MM/YYYY or similar format

            let month = '';
            let day = '';

            if (dateParts.length >= 2) {
                // Try DD/MM/YYYY format first
                if (dateParts[0].length <= 2 && dateParts[1].length <= 2) {
                    day = dateParts[0].padStart(2, '0');
                    month = dateParts[1].padStart(2, '0');
                }
                // Try YYYY-MM-DD format
                else if (dateStr.includes('-')) {
                    const isoDate = new Date(dateStr);
                    if (!isNaN(isoDate.getTime())) {
                        month = String(isoDate.getMonth() + 1).padStart(2, '0');
                        day = String(isoDate.getDate()).padStart(2, '0');
                    }
                }
            }

            // If we couldn't parse the date, use default
            if (!month || !day) {
                month = '00';
                day = '00';
            }

            // Find all transactions on the same date and count position
            const sameDateTransactions = allTransactions.filter(t => t.date === transaction.date);
            const positionInDate = sameDateTransactions.findIndex(t =>
                t.date === transaction.date &&
                t.description === transaction.description &&
                t.spent === transaction.spent
            );

            // Sequential counter (1-based, padded to 2 digits)
            const counter = String(Math.min(positionInDate >= 0 ? positionInDate + 1 : 1, 99)).padStart(2, '0');

            // Format: A + MMDD + counter
            const ref = `A${month}${day}${counter}`;

            return ref;
        }

        // Render transaction details table
        function renderTransactionDetails(transactions, projectId, category, itemKey, quarter, invoices) {
            console.log(`üé® [RENDER] renderTransactionDetails called: ${category}-${itemKey}, ${transactions?.length || 0} transactions`);

            if (!transactions || transactions.length === 0) {
                return '<p style="color: #94a3b8; font-style: italic; padding: 10px;">No transactions assigned yet</p>';
            }

            const rows = transactions.map(transaction => {
                const date = transaction.date || '-';
                const description = transaction.description || '-';

                // Always show GBP amounts, with note if currency-converted
                const spentAmount = parseAmount(transaction.spent);
                let valueExTax = '0.00';
                let valueIncTax = '0.00';
                let currencySymbol = '¬£';
                let currencyNote = '';

                // Check if 0% VAT is applied or if spent_ex_vat is manually set
                if (transaction.zeroVAT || transaction.spent_ex_vat) {
                    const exVatAmount = parseAmount(transaction.spent_ex_vat || transaction.spent);
                    valueExTax = exVatAmount > 0 ? exVatAmount.toFixed(2) : '0.00';
                } else {
                    // Default: calculate with 20% VAT
                    valueExTax = spentAmount > 0 ? (spentAmount / 1.2).toFixed(2) : '0.00';
                }

                // Value Inc Tax (original amount including tax)
                valueIncTax = spentAmount > 0 ? spentAmount.toFixed(2) : '0.00';

                // If transaction was currency-converted, add note showing USD amount
                if (transaction.convertedCurrency && transaction.convertedAmount) {
                    const usdAmount = transaction.convertedAmount;
                    const rate = transaction.conversionRate || 1;
                    currencyNote = `<div style="font-size: 0.75em; color: #10b981; margin-top: 3px;">üí± Converted from $${usdAmount.toFixed(2)} USD (rate: ${rate.toFixed(4)})</div>`;
                }

                // Detail column - prioritize detail field, then fall back to legacy fields
                let detail = '-';
                if (transaction.detail) {
                    detail = transaction.detail;
                } else {
                    // Legacy support: combine manual description and voice notes
                    const detailParts = [];
                    if (transaction.manualDescription) detailParts.push(transaction.manualDescription);
                    if (transaction.voiceNotes) detailParts.push(`üé§ ${transaction.voiceNotes}`);
                    if (detailParts.length > 0) {
                        detail = detailParts.join(' | ');
                    }
                }

                // Find the specific assignment for this item
                // Support both item-level and category-level assignments
                const assignment = transaction.assignments.find(a => {
                    const projectMatch = a.projectId === projectId;
                    const categoryMatch = a.category === category;

                    // Backwards compatible itemKey matching
                    let itemMatch = false;
                    if (itemKey === null || itemKey === undefined || itemKey.endsWith('-all')) {
                        // Category-level view: match any assignment in this category
                        itemMatch = true;
                    } else {
                        if (a.itemKey === itemKey) {
                            itemMatch = true;
                        } else if (!a.itemKey || a.itemKey === null || a.itemKey === undefined) {
                            itemMatch = true;
                        } else {
                            itemMatch = false;
                        }
                    }

                    const quarterMatch = quarter === null || a.quarter === quarter;
                    return projectMatch && categoryMatch && itemMatch && quarterMatch;
                });

                // Calculate amount dynamically: ex VAT value √ó (split percentage / 100)
                // This ensures accuracy regardless of what's stored in assignment.amount
                const percentage = assignment && assignment.percentage ? parseFloat(assignment.percentage) : 0;
                const assignedAmount = (parseFloat(valueExTax) * (percentage / 100)).toFixed(2);
                const assignedQuarter = assignment ? assignment.quarter : '-';
                const splitPercentage = assignment && assignment.percentage ? `${assignment.percentage}%` : '-';

                // Check for PDF attachment
                const invoice = getInvoiceForTransaction(transaction, invoices);

                const pdfCell = invoice
                    ? `<button class="view-pdf-btn" data-invoice-id="${invoice.id}" onclick="viewInvoicePDF(${invoice.id})" style="background: #4caf50; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">üìé View PDF</button>`
                    : '<span style="color: #94a3b8;">-</span>';

                // Create unique identifier for this transaction row
                const transactionId = `transaction-${transaction.date}-${transaction.description?.substring(0, 30).replace(/[^a-zA-Z0-9]/g, '')}`;

                // Create view in spend button
                const viewInSpendBtn = `<button onclick="viewInSpend('${escapeHtml(transaction.date)}', '${escapeHtml(transaction.description)}'); event.stopPropagation();" style="background: #3b82f6; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85em; white-space: nowrap;">üëÅÔ∏è View in Spend</button>`;

                // Create unassign button
                const unassignBtn = `<button onclick="unassignTransaction('${escapeHtml(transaction.date)}', '${escapeHtml(transaction.description)}', '${escapeHtml(projectId)}', '${escapeHtml(category)}', '${escapeHtml(itemKey)}'); event.stopPropagation();" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85em; white-space: nowrap; margin-left: 4px;" title="Remove this assignment">‚úï</button>`;

                // Get transaction reference from the assignment (each assignment has its own unique ref)
                const transactionRef = assignment?.transactionRef || '-';

                return `
                    <tr id="${transactionId}" data-transaction-date="${escapeHtml(transaction.date)}" data-transaction-description="${escapeHtml(transaction.description)}">
                        <td style="padding: 6px 10px; white-space: nowrap;">${escapeHtml(date)}</td>
                        <td
                            style="padding: 6px 10px; text-align: center; white-space: nowrap; font-weight: 600; color: #059669; font-family: monospace; cursor: pointer; transition: background-color 0.2s;"
                            ondblclick="makeTransactionRefEditable(this, '${escapeHtml(transaction.date)}', '${escapeHtml(transaction.description)}', '${escapeHtml(projectId)}', '${escapeHtml(category)}', '${escapeHtml(itemKey)}', '${escapeHtml(transactionRef)}'); event.stopPropagation();"
                            onmouseover="this.style.backgroundColor='#f0fdf4'; this.title='Double-click to edit';"
                            onmouseout="this.style.backgroundColor='transparent';"
                        >${escapeHtml(transactionRef)}</td>
                        <td style="padding: 6px 10px; max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(description)}${currencyNote}</td>
                        <td style="padding: 6px 10px; text-align: right; white-space: nowrap;">${currencySymbol}${valueExTax}</td>
                        <td style="padding: 6px 10px; text-align: right; white-space: nowrap;">${currencySymbol}${valueIncTax}</td>
                        <td style="padding: 6px 10px; text-align: center; white-space: nowrap;">${(percentage / 100).toFixed(2)}</td>
                        <td style="padding: 6px 10px; max-width: 250px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(detail)}</td>
                        <td style="padding: 6px 10px; text-align: center; white-space: nowrap;">${pdfCell}</td>
                        <td style="padding: 6px 10px; text-align: center; white-space: nowrap;">Q${assignedQuarter}</td>
                        <td style="padding: 6px 10px; text-align: center; white-space: nowrap;">${splitPercentage}</td>
                        <td style="padding: 6px 10px; text-align: right; font-weight: 600; white-space: nowrap;">${currencySymbol}${assignedAmount}</td>
                        <td style="padding: 6px 10px; text-align: right; white-space: nowrap;">${viewInSpendBtn}${unassignBtn}</td>
                    </tr>
                `;
            }).join('');

            const quarterlyTableId = `quarterly-table-${itemKey.replace(/[^a-zA-Z0-9]/g, '-')}`;

            return `
                <div style="margin: 20px 0 0 0; padding: 15px 0; background: white; border-radius: 0; border-top: 2px solid #e2e8f0; width: 100%; box-sizing: border-box;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 0 0 15px 0; flex-wrap: wrap; gap: 8px;">
                        <h5 style="margin: 0; color: #3b82f6; font-size: 0.95em;">üí≥ Assigned Transactions</h5>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="toggleQuarterlyTable('${quarterlyTableId}'); event.stopPropagation();" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; gap: 6px; font-weight: 600; box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(251, 191, 36, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(251, 191, 36, 0.3)';" title="Toggle quarterly breakdown table">
                                <span style="font-weight: 700;">Q</span>
                            </button>
                            <button onclick="refreshTransactionData(); event.stopPropagation();" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; gap: 6px; font-weight: 600; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)';" title="Reload transactions and PDFs from Spend page database">
                                <span>üîÑ</span>
                                <span>Sync PDFs</span>
                            </button>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="transaction-details-table" style="width: 100%; border-collapse: collapse; font-size: 0.9em; min-width: 1000px;">
                            <thead>
                                <tr style="background: #f1f5f9;">
                                    <th style="padding: 8px 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">Date</th>
                                    <th style="padding: 8px 10px; text-align: center; font-weight: 600; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">Transaction Ref</th>
                                    <th style="padding: 8px 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">Description</th>
                                    <th style="padding: 8px 10px; text-align: right; font-weight: 600; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">Value ex Tax</th>
                                    <th style="padding: 8px 10px; text-align: right; font-weight: 600; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">Value Inc Tax</th>
                                    <th style="padding: 8px 10px; text-align: center; font-weight: 600; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">% Allocation</th>
                                    <th style="padding: 8px 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">Detail</th>
                                    <th style="padding: 8px 10px; text-align: center; font-weight: 600; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">PDF</th>
                                    <th style="padding: 8px 10px; text-align: center; font-weight: 600; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">Qtr</th>
                                    <th style="padding: 8px 10px; text-align: center; font-weight: 600; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">Split %</th>
                                    <th style="padding: 8px 10px; text-align: right; font-weight: 600; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">Amount</th>
                                    <th style="padding: 8px 10px; text-align: right; font-weight: 600; border-bottom: 2px solid #cbd5e1; white-space: nowrap;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Render all transactions for active quarter, organized by category
        function renderActiveQuarterTransactions(quarterIndex, allTransactions, invoices) {
            if (!quarterIndex || !allTransactions || allTransactions.length === 0) {
                return '';
            }

            // Filter transactions assigned to this quarter in the current project
            console.log(`[renderActiveQuarterTransactions] Looking for Q${quarterIndex} in project ${projectBudget.projectId}`);
            console.log(`[renderActiveQuarterTransactions] Total transactions available: ${allTransactions.length}`);

            const quarterTransactions = allTransactions.filter(transaction => {
                if (!transaction.assignments || transaction.assignments.length === 0) return false;
                return transaction.assignments.some(assignment =>
                    assignment.projectId === projectBudget.projectId &&
                    assignment.quarter === quarterIndex
                );
            });

            console.log(`[renderActiveQuarterTransactions] Found ${quarterTransactions.length} transactions for Q${quarterIndex}`);

            // Group transactions by category
            const categorizedTransactions = {};
            quarterTransactions.forEach(transaction => {
                transaction.assignments.forEach(assignment => {
                    if (assignment.projectId === projectBudget.projectId && assignment.quarter === quarterIndex) {
                        const category = assignment.category || 'Other Costs';
                        console.log(`[renderActiveQuarterTransactions] Transaction: ${transaction.description?.substring(0, 30)} -> Category: ${category}, Quarter: ${assignment.quarter}, Amount: ¬£${assignment.amount}`);
                        if (!categorizedTransactions[category]) {
                            categorizedTransactions[category] = [];
                        }
                        // Store transaction with assignment info
                        categorizedTransactions[category].push({
                            transaction,
                            assignment
                        });
                    }
                });
            });

            console.log(`[renderActiveQuarterTransactions] Categories found:`, Object.keys(categorizedTransactions));

            // Define category order to match budget layout
            // Note: Category names must match exactly what's used in transaction assignments from Spend page
            const categoryOrder = [
                'Labour',
                'Overheads',
                'Materials',
                'Capital Usage',
                'Subcontracting',
                'Travel',  // Assignments use 'Travel', not 'Travel and Subsistence'
                'Other Costs'
            ];

            // Build HTML
            let html = `
                <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="margin: 0; color: #3b82f6; font-size: 1em;">
                            Q${quarterIndex} Transactions by Category
                        </h4>
                        <button onclick="openQuarterlyExportPreview(${quarterIndex}); event.stopPropagation();"
                                style="background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); color: white; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; gap: 6px; transition: all 0.2s; font-weight: 500;"
                                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                                title="Export quarterly breakdown to Excel">
                            <span>üìä</span>
                            <span>Export to Excel</span>
                        </button>
                    </div>
            `;

            let grandTotal = 0;

            // Render each category in order
            categoryOrder.forEach(category => {
                const items = categorizedTransactions[category] || [];
                // FIX: Calculate total dynamically from transaction ex-VAT and percentage
                const categoryTotal = items.reduce((sum, item) => {
                    const transaction = item.transaction;
                    const assignment = item.assignment;
                    const spentAmount = parseAmount(transaction.spent);
                    let valueExTax = 0;
                    if (transaction.zeroVAT || transaction.spent_ex_vat) {
                        valueExTax = parseAmount(transaction.spent_ex_vat || transaction.spent);
                    } else {
                        valueExTax = spentAmount / 1.2;
                    }
                    const percentage = parseFloat(assignment.percentage) || 0;
                    const assignedAmount = (valueExTax * percentage) / 100;

                    // CRITICAL FIX: Round to match display
                    const roundedAmount = Math.round(assignedAmount * 100) / 100;

                    return sum + roundedAmount;
                }, 0);
                grandTotal += categoryTotal;

                // Map internal category names to display names
                const displayName = category === 'Travel' ? 'Travel and Subsistence' : category;
                const categoryId = `q${quarterIndex}-category-${category.replace(/\s+/g, '-').toLowerCase()}`;

                // Auto-expand categories with transactions
                const defaultDisplay = items.length > 0 ? 'block' : 'none';
                const defaultArrow = items.length > 0 ? '‚ñº' : '‚ñ∂';

                html += `
                    <div style="margin-bottom: 20px;">
                        <div onclick="toggleQuarterlyBreakdown('${categoryId}')" style="background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); color: white; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;"
                             onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)'"
                             onmouseout="this.style.boxShadow='none'">
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span id="${categoryId}-arrow" style="font-size: 0.8em; width: 14px;">${defaultArrow}</span>
                                <span style="font-weight: 600; font-size: 0.95em;">${displayName}</span>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                ${items.length > 0 ? `
                                    <button onclick="exportCategoryToExcel('${category}', ${quarterIndex}); event.stopPropagation();"
                                            style="background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.4); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; gap: 5px; transition: all 0.2s;"
                                            onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'"
                                            onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'"
                                            title="Export this category to Excel">
                                        <span>üìä</span>
                                        <span>Export to Excel</span>
                                    </button>
                                    <button onclick="exportCategoryToPDF('${category}', ${quarterIndex}); event.stopPropagation();"
                                            style="background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.4); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; gap: 5px; transition: all 0.2s;"
                                            onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'"
                                            onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'"
                                            title="Export this category to PDF">
                                        <span>üìë</span>
                                        <span>Export to PDF</span>
                                    </button>
                                    <button onclick="mergeCategoryPDFs('${category}', ${quarterIndex}); event.stopPropagation();"
                                            style="background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.4); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; gap: 5px; transition: all 0.2s;"
                                            onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'"
                                            onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'"
                                            title="Merge all PDFs/images in this category">
                                        <span>üìÑ</span>
                                        <span>Merge PDFs</span>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div id="${categoryId}-breakdown" style="display: ${defaultDisplay};">
                `;

                if (items.length === 0) {
                    html += `
                        <p style="margin: 10px 0 15px 0; color: #94a3b8; font-style: italic; font-size: 0.9em; padding-left: 12px;">
                            No claims for this category in Q${quarterIndex}
                        </p>
                    `;
                } else {
                    html += `
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85em; margin-bottom: 10px;">
                            <thead>
                                <tr style="background: #f1f5f9;">
                                    <th style="padding: 6px 8px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1;">Date</th>
                                    <th style="padding: 6px 8px; text-align: center; font-weight: 600; border-bottom: 2px solid #cbd5e1;">Transaction Ref</th>
                                    <th style="padding: 6px 8px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1;">Description</th>
                                    <th style="padding: 6px 8px; text-align: right; font-weight: 600; border-bottom: 2px solid #cbd5e1;">Value ex Tax</th>
                                    <th style="padding: 6px 8px; text-align: right; font-weight: 600; border-bottom: 2px solid #cbd5e1;">Value Inc Tax</th>
                                    <th style="padding: 6px 8px; text-align: center; font-weight: 600; border-bottom: 2px solid #cbd5e1;">% Allocation</th>
                                    <th style="padding: 6px 8px; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e1;">Detail</th>
                                    <th style="padding: 6px 8px; text-align: center; font-weight: 600; border-bottom: 2px solid #cbd5e1;">PDF</th>
                                    <th style="padding: 6px 8px; text-align: right; font-weight: 600; border-bottom: 2px solid #cbd5e1;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    items.forEach(({transaction, assignment}) => {
                        const date = transaction.date || '-';
                        const description = transaction.description || '-';

                        // Always show GBP amounts (even if currency-converted)
                        const spentAmount = parseAmount(transaction.spent);
                        let valueExTax = '0.00';
                        let valueIncTax = '0.00';
                        let currencySymbol = '¬£';

                        // Calculate value ex tax
                        if (transaction.zeroVAT || transaction.spent_ex_vat) {
                            const exVatAmount = parseAmount(transaction.spent_ex_vat || transaction.spent);
                            valueExTax = exVatAmount > 0 ? exVatAmount.toFixed(2) : '0.00';
                        } else {
                            valueExTax = spentAmount > 0 ? (spentAmount / 1.2).toFixed(2) : '0.00';
                        }

                        valueIncTax = spentAmount > 0 ? spentAmount.toFixed(2) : '0.00';

                        // Detail column
                        let detail = '-';
                        if (transaction.detail) {
                            detail = transaction.detail;
                        } else {
                            const detailParts = [];
                            if (transaction.manualDescription) detailParts.push(transaction.manualDescription);
                            if (transaction.voiceNotes) detailParts.push(transaction.voiceNotes);
                            if (detailParts.length > 0) {
                                detail = detailParts.join(' | ');
                            }
                        }

                        // Check for PDF attachment
                        const invoice = getInvoiceForTransaction(transaction, invoices);
                        const pdfCell = invoice
                            ? `<button class="view-pdf-btn" data-invoice-id="${invoice.id}" onclick="viewInvoicePDF(${invoice.id}); event.stopPropagation();" style="background: #4caf50; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">PDF</button>`
                            : '<span style="color: #94a3b8;">-</span>';

                        // FIX: Calculate assigned amount dynamically (matches valueExTax already calculated above)
                        const percentage = parseFloat(assignment.percentage) || 0;
                        const assignedAmount = ((parseFloat(valueExTax) * percentage) / 100).toFixed(2);

                        // Get transaction reference from the assignment (each assignment has its own unique ref)
                        const transactionRef = assignment.transactionRef || '-';
                        const assignmentProjectId = assignment.projectId || projectBudget.projectId;
                        const assignmentCategory = assignment.category || 'Other Costs';
                        const assignmentItemKey = assignment.itemKey || '';

                        html += `
                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 6px 8px;">${escapeHtml(date)}</td>
                                <td
                                    style="padding: 6px 8px; text-align: center; font-weight: 600; color: #059669; font-family: monospace; cursor: pointer; transition: background-color 0.2s;"
                                    ondblclick="makeTransactionRefEditable(this, '${escapeHtml(transaction.date)}', '${escapeHtml(transaction.description)}', '${escapeHtml(assignmentProjectId)}', '${escapeHtml(assignmentCategory)}', '${escapeHtml(assignmentItemKey)}', '${escapeHtml(transactionRef)}'); event.stopPropagation();"
                                    onmouseover="this.style.backgroundColor='#f0fdf4'; this.title='Double-click to edit';"
                                    onmouseout="this.style.backgroundColor='transparent';"
                                >${escapeHtml(transactionRef)}</td>
                                <td style="padding: 6px 8px;">${escapeHtml(description)}</td>
                                <td style="padding: 6px 8px; text-align: right;">${currencySymbol}${valueExTax}</td>
                                <td style="padding: 6px 8px; text-align: right;">${currencySymbol}${valueIncTax}</td>
                                <td style="padding: 6px 8px; text-align: center;">${(percentage / 100).toFixed(2)}</td>
                                <td style="padding: 6px 8px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(detail)}</td>
                                <td style="padding: 6px 8px; text-align: center;">${pdfCell}</td>
                                <td style="padding: 6px 8px; text-align: right;">${currencySymbol}${assignedAmount}</td>
                            </tr>
                        `;
                    });

                    // Category total row with accounting-style formatting
                    html += `
                                <tr style="border-top: 2px solid #cbd5e1;">
                                    <td colspan="8" style="padding: 8px; text-align: right; font-weight: 700;">Total ${displayName}:</td>
                                    <td style="padding: 8px; text-align: right; font-weight: 700;">¬£${categoryTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
            });

            // Grand total
            html += `
                    <div style="background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); color: white; padding: 10px 12px; border-radius: 6px; font-weight: 700; font-size: 1em; text-align: right;">
                        Grand Total: ¬£${grandTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                </div>
            `;

            return html;
        }

        // HTML escape utility
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Parse amount from string (removes currency symbols and commas)
        function parseAmount(amountStr) {
            if (!amountStr) return 0;
            // Remove currency symbols and commas
            const cleaned = amountStr.replace(/[¬£$,]/g, '');
            return parseFloat(cleaned) || 0;
        }

        // View invoice PDF in modal
        async function viewInvoicePDF(invoiceId) {
            if (!db) await initIndexedDB();
            if (!db) {
                alert('Database not available');
                return;
            }

            try {
                const transaction = db.transaction([INVOICES_STORE_NAME], 'readonly');
                const store = transaction.objectStore(INVOICES_STORE_NAME);
                const invoice = await new Promise((resolve, reject) => {
                    const request = store.get(invoiceId);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                if (!invoice || !invoice.pdfBlob) {
                    alert('PDF not found');
                    return;
                }

                // Create blob URL and open in modal
                const blobUrl = URL.createObjectURL(invoice.pdfBlob);
                showPDFModal(blobUrl, invoice.filename || 'invoice.pdf');
            } catch (error) {
                console.error('Failed to load PDF:', error);
                alert('Failed to load PDF');
            }
        }

        // Show PDF in modal
        function showPDFModal(pdfUrl, filename) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.id = 'pdfModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; width: 90%; max-width: 900px; height: 90vh; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <div style="padding: 15px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                        <h3 style="margin: 0; font-size: 1.1em; color: #333; flex: 1;">üìé ${escapeHtml(filename)}</h3>
                        <a href="${pdfUrl}" download="${escapeHtml(filename)}" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; text-decoration: none; display: inline-block;">‚¨áÔ∏è Download</a>
                        <button onclick="closePDFModal()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úï Close</button>
                    </div>
                    <div style="flex: 1; overflow: hidden;">
                        <iframe src="${pdfUrl}" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePDFModal();
                }
            });

            // Clean up blob URL when modal closes
            modal.dataset.blobUrl = pdfUrl;
        }

        // Close PDF modal
        function closePDFModal() {
            const modal = document.getElementById('pdfModal');
            if (modal) {
                // Revoke blob URL to free memory
                if (modal.dataset.blobUrl) {
                    URL.revokeObjectURL(modal.dataset.blobUrl);
                }
                modal.remove();
            }
        }

        // ============================================================================
        // PDF MERGE FUNCTIONALITY
        // ============================================================================

        // Global variables for PDF merge
        let mergedPdfBlob = null;
        let mergedPdfFilename = '';

        // Entry point: Called when user clicks "Merge PDFs" button in category header
        async function mergeCategoryPDFs(category, quarterIndex) {
            console.log(`[mergeCategoryPDFs] Starting merge for category: ${category}, Q${quarterIndex}`);

            // Step 1: Collect all transactions in this category
            const categoryTransactions = getCategoryTransactions(category, quarterIndex);

            if (categoryTransactions.length === 0) {
                alert('No transactions found in this category');
                return;
            }

            // Step 2: Collect all invoices (PDFs/images) from these transactions
            const detectedDocuments = await collectCategoryDocuments(categoryTransactions);

            if (detectedDocuments.length === 0) {
                alert('No PDFs or images found for transactions in this category');
                return;
            }

            // Step 3: Show detection dialog with list of found documents
            showPdfDetectionDialog(category, quarterIndex, detectedDocuments);
        }

        // Get all transactions for a specific category and quarter
        function getCategoryTransactions(category, quarterIndex) {
            // Use cachedTransactions global variable
            if (!cachedTransactions || cachedTransactions.length === 0) {
                console.error('[getCategoryTransactions] No transactions loaded');
                return [];
            }

            // Filter transactions matching current project, quarter, and category
            const filtered = cachedTransactions.filter(transaction => {
                if (!transaction.assignments || transaction.assignments.length === 0) return false;

                return transaction.assignments.some(assignment =>
                    assignment.projectId === projectBudget.projectId &&
                    assignment.quarter === quarterIndex &&
                    assignment.category === category
                );
            });

            console.log(`[getCategoryTransactions] Found ${filtered.length} transactions for ${category} Q${quarterIndex}`);
            return filtered;
        }

        // Collect all documents (PDFs/images) from transaction list
        async function collectCategoryDocuments(transactions) {
            // Use cached invoices
            if (!cachedInvoices || cachedInvoices.length === 0) {
                console.warn('[collectCategoryDocuments] No invoices cached, loading from database...');
                cachedInvoices = await loadInvoiceAttachments();
            }

            const documents = [];

            for (const transaction of transactions) {
                // Check for invoices using the same matching logic as getInvoiceForTransaction
                const matchedInvoice = getInvoiceForTransaction(transaction, cachedInvoices);

                if (matchedInvoice) {
                    documents.push({
                        invoice: matchedInvoice,
                        transaction: transaction,
                        matchType: 'matched'
                    });
                }
            }

            console.log(`[collectCategoryDocuments] Collected ${documents.length} documents from ${transactions.length} transactions`);
            return documents;
        }

        // Show detection dialog with collected documents
        function showPdfDetectionDialog(category, quarterIndex, documents) {
            const displayName = category === 'Travel' ? 'Travel and Subsistence' : category;

            // Build file list HTML
            let fileListHtml = '';
            documents.forEach(({ invoice, transaction, matchType }, index) => {
                const fileType = invoice.filename.toLowerCase().endsWith('.pdf') ? 'PDF' : 'Image';
                const fileSize = formatFileSize(invoice.size);
                const transactionDesc = truncateString(transaction.description, 40);

                fileListHtml += `
                    <div class="file-item" style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px; transition: all 0.2s; background: white;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                        <input type="checkbox" checked data-invoice-id="${invoice.id}" data-index="${index}">
                        <div style="flex: 1;">
                            <strong style="color: #1e293b;">${escapeHtml(invoice.filename)}</strong><br>
                            <small style="color: #64748b;">
                                ${transaction.date} - ${escapeHtml(transactionDesc)}
                            </small>
                        </div>
                        <span class="badge" style="background: ${fileType === 'PDF' ? '#dbeafe' : '#fef3c7'}; color: ${fileType === 'PDF' ? '#1e40af' : '#92400e'}; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">${fileType}</span>
                        <span style="color: #64748b; font-size: 0.85em;">${fileSize}</span>
                    </div>
                `;
            });

            // Create modal HTML
            const modalHtml = `
                <div id="pdfDetectionModal" class="modal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; border-radius: 12px; padding: 0; max-width: 700px; width: 90%; max-height: 80vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
                        <div class="modal-header" style="background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-size: 1.3em;">üìÑ PDF Detection - ${displayName} Q${quarterIndex}</h3>
                            <button onclick="closePdfDetectionModal()" style="background: transparent; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='transparent'">‚úï</button>
                        </div>
                        <div class="modal-body" style="padding: 20px; overflow-y: auto; max-height: calc(80vh - 180px);">
                            <p style="margin-bottom: 15px; color: #475569;">
                                Found <strong style="color: #3AAFA9;">${documents.length}</strong> document(s) in ${displayName} category:
                            </p>

                            <div id="detectedFilesList">
                                ${fileListHtml}
                            </div>

                            <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 6px;">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; cursor: pointer;">
                                    <input type="checkbox" id="includeTransactionInfo" checked>
                                    <span style="color: #1e293b;">Include transaction details as cover pages</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="addPageNumbers" checked>
                                    <span style="color: #1e293b;">Add page numbers to merged PDF</span>
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer" style="padding: 15px 20px; background: #f8fafc; display: flex; justify-content: flex-end; gap: 10px;">
                            <button class="btn-secondary" onclick="closePdfDetectionModal()" style="padding: 10px 20px; border: none; border-radius: 6px; font-size: 0.95em; font-weight: 600; cursor: pointer; background: #f1f5f9; color: #475569;">Cancel</button>
                            <button class="btn-primary" onclick="startPdfMerge('${category}', ${quarterIndex})" style="padding: 10px 20px; border: none; border-radius: 6px; font-size: 0.95em; font-weight: 600; cursor: pointer; background: #3AAFA9; color: white; display: flex; align-items: center; gap: 8px;">
                                <span>Merge ${documents.length} Document(s)</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Store documents globally for merge
            window.selectedDocuments = documents;
            window.selectedCategory = category;
            window.selectedQuarter = quarterIndex;

            // Insert modal into DOM
            const existingModal = document.getElementById('pdfDetectionModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closePdfDetectionModal() {
            const modal = document.getElementById('pdfDetectionModal');
            if (modal) modal.remove();
        }

        // Helper: Format file size
        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Helper: Truncate string
        function truncateString(str, maxLength) {
            if (!str) return '-';
            return str.length > maxLength ? str.substring(0, maxLength) + '...' : str;
        }

        // Start the PDF merge process
        async function startPdfMerge(category, quarterIndex) {
            // Get selected documents from checkboxes
            const checkboxes = document.querySelectorAll('#detectedFilesList input[type="checkbox"]:checked');
            const selectedInvoiceIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.invoiceId));

            if (selectedInvoiceIds.length === 0) {
                alert('Please select at least one document to merge');
                return;
            }

            const selectedDocs = window.selectedDocuments.filter(doc =>
                selectedInvoiceIds.includes(doc.invoice.id)
            );

            const includeTransactionInfo = document.getElementById('includeTransactionInfo').checked;
            const addPageNumbers = document.getElementById('addPageNumbers').checked;

            // Close detection modal
            closePdfDetectionModal();

            // Show progress modal
            showProgressModal(selectedDocs.length);

            try {
                // Perform merge
                const mergedPdf = await performPdfMerge(selectedDocs, {
                    includeTransactionInfo,
                    addPageNumbers,
                    category,
                    quarterIndex
                });

                // Store globally for download
                mergedPdfBlob = mergedPdf.blob;
                mergedPdfFilename = mergedPdf.filename;

                // Close progress modal
                closeProgressModal();

                // Show preview modal
                showPreviewModal(mergedPdf);

            } catch (error) {
                console.error('[startPdfMerge] Error:', error);
                closeProgressModal();
                alert('Error merging PDFs: ' + error.message);
            }
        }

        // Show progress modal
        function showProgressModal(totalFiles) {
            const modalHtml = `
                <div id="pdfMergeProgressModal" class="modal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1001; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; border-radius: 12px; padding: 0; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
                        <div class="modal-header" style="background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); color: white; padding: 20px;">
                            <h3 style="margin: 0;">‚öôÔ∏è Merging PDFs...</h3>
                        </div>
                        <div class="modal-body" style="text-align: center; padding: 40px 30px;">
                            <p id="currentFileStatus" style="margin-bottom: 20px; color: #475569; font-size: 1em;">
                                Processing: <strong id="currentFileName" style="color: #3AAFA9;">Initializing...</strong>
                            </p>

                            <div style="width: 100%; background: #e2e8f0; border-radius: 10px; height: 30px; position: relative; overflow: hidden;">
                                <div id="mergeProgressBar" style="background: linear-gradient(90deg, #3AAFA9 0%, #2B7A78 100%); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.9em; position: relative;">
                                    <span id="progressPercentage" style="position: absolute;">0%</span>
                                </div>
                            </div>

                            <p id="stepDetails" style="margin-top: 15px; color: #64748b; font-size: 0.9em;">
                                Step 1 of 4: Loading documents...
                            </p>

                            <div style="margin-top: 20px; display: flex; justify-content: center; gap: 30px; font-size: 0.85em; color: #64748b;">
                                <span>üìÑ Processed: <strong id="processedCount" style="color: #3AAFA9;">0</strong>/<strong id="totalCount">${totalFiles}</strong></span>
                                <span>üì¶ Size: <strong id="totalSize" style="color: #3AAFA9;">0 MB</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const existingModal = document.getElementById('pdfMergeProgressModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeProgressModal() {
            const modal = document.getElementById('pdfMergeProgressModal');
            if (modal) modal.remove();
        }

        // Update progress UI
        function updateProgress(current, total, step, filename, percentage) {
            const currentFileElem = document.getElementById('currentFileName');
            const percentageElem = document.getElementById('progressPercentage');
            const progressBarElem = document.getElementById('mergeProgressBar');
            const stepDetailsElem = document.getElementById('stepDetails');
            const processedCountElem = document.getElementById('processedCount');
            const totalCountElem = document.getElementById('totalCount');

            if (currentFileElem) currentFileElem.textContent = filename;
            if (percentageElem) percentageElem.textContent = percentage + '%';
            if (progressBarElem) progressBarElem.style.width = percentage + '%';
            if (stepDetailsElem) stepDetailsElem.textContent = step;
            if (processedCountElem) processedCountElem.textContent = current;
            if (totalCountElem) totalCountElem.textContent = total;
        }

        // Perform PDF merge using pdf-lib
        async function performPdfMerge(documents, options) {
            const { PDFDocument, rgb, StandardFonts } = PDFLib;

            // Step 1: Create new PDF document
            updateProgress(0, documents.length, 'Step 1 of 4: Initializing PDF document...', 'Setting up...', 5);
            const mergedPdf = await PDFDocument.create();

            let totalSize = 0;
            let currentPage = 1;

            // Step 2: Process each document
            for (let i = 0; i < documents.length; i++) {
                const { invoice, transaction } = documents[i];
                const progress = Math.round(20 + (i / documents.length) * 70); // 20% to 90%

                updateProgress(i, documents.length, `Step 2 of 4: Processing ${invoice.filename}...`, invoice.filename, progress);

                // Add transaction info page if requested
                if (options.includeTransactionInfo) {
                    await createTransactionInfoPage(mergedPdf, transaction, invoice);
                    currentPage++;
                }

                // Determine file type
                const isImage = /\.(jpg|jpeg|png|gif|bmp)$/i.test(invoice.filename);
                const isPdf = /\.pdf$/i.test(invoice.filename);

                if (isPdf) {
                    // Load and merge PDF
                    try {
                        const pdfBytes = await invoice.pdfBlob.arrayBuffer();
                        const sourcePdf = await PDFDocument.load(pdfBytes);
                        const copiedPages = await mergedPdf.copyPages(sourcePdf, sourcePdf.getPageIndices());

                        copiedPages.forEach(page => {
                            mergedPdf.addPage(page);
                            if (options.addPageNumbers) {
                                addPageNumber(page, currentPage++);
                            } else {
                                currentPage++;
                            }
                        });

                        totalSize += invoice.size;
                    } catch (error) {
                        console.error(`Error loading PDF ${invoice.filename}:`, error);
                        // Add error page
                        await addErrorPage(mergedPdf, invoice.filename, error.message);
                        currentPage++;
                    }
                } else if (isImage) {
                    // Convert image to PDF page
                    try {
                        const imageBytes = await invoice.pdfBlob.arrayBuffer();
                        const image = await embedImage(mergedPdf, imageBytes, invoice.filename);

                        const page = mergedPdf.addPage([image.width, image.height]);
                        page.drawImage(image, {
                            x: 0,
                            y: 0,
                            width: image.width,
                            height: image.height
                        });

                        if (options.addPageNumbers) {
                            addPageNumber(page, currentPage++);
                        } else {
                            currentPage++;
                        }

                        totalSize += invoice.size;
                    } catch (error) {
                        console.error(`Error loading image ${invoice.filename}:`, error);
                        await addErrorPage(mergedPdf, invoice.filename, error.message);
                        currentPage++;
                    }
                }
            }

            // Step 3: Add metadata
            updateProgress(documents.length, documents.length, 'Step 3 of 4: Adding metadata...', 'Finalizing...', 92);

            const displayCategory = options.category === 'Travel' ? 'Travel and Subsistence' : options.category;
            mergedPdf.setTitle(`${displayCategory} - Q${options.quarterIndex} - ${projectBudget.projectName || 'Project'}`);
            mergedPdf.setAuthor('PEBL Grants Budget System');
            mergedPdf.setSubject(`Q${options.quarterIndex} ${displayCategory} Transaction Documents`);
            mergedPdf.setCreator('PEBLGen - grants.html');
            mergedPdf.setProducer('pdf-lib');
            mergedPdf.setCreationDate(new Date());

            // Step 4: Save PDF
            updateProgress(documents.length, documents.length, 'Step 4 of 4: Saving PDF...', 'Compressing...', 96);

            const pdfBytes = await mergedPdf.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });

            updateProgress(documents.length, documents.length, 'Complete!', 'Ready for preview', 100);

            // Update total size in UI
            const totalSizeElem = document.getElementById('totalSize');
            if (totalSizeElem) totalSizeElem.textContent = formatFileSize(totalSize);

            // Generate filename
            const dateStr = new Date().toISOString().split('T')[0];
            const categorySlug = options.category.replace(/\s+/g, '_');
            const filename = `${projectBudget.projectName || 'Project'}_Q${options.quarterIndex}_${categorySlug}_${dateStr}.pdf`;

            return {
                blob,
                filename,
                pageCount: mergedPdf.getPageCount(),
                size: blob.size,
                documentCount: documents.length
            };
        }

        // Helper: Embed image (handles PNG/JPG)
        async function embedImage(pdfDoc, imageBytes, filename) {
            const lowerFilename = filename.toLowerCase();

            if (lowerFilename.endsWith('.png')) {
                return await pdfDoc.embedPng(imageBytes);
            } else if (lowerFilename.endsWith('.jpg') || lowerFilename.endsWith('.jpeg')) {
                return await pdfDoc.embedJpg(imageBytes);
            } else {
                throw new Error(`Unsupported image format: ${filename}`);
            }
        }

        // Helper: Add page number to a page
        function addPageNumber(page, pageNum) {
            const { width, height } = page.getSize();
            const { rgb } = PDFLib;
            page.drawText(`Page ${pageNum}`, {
                x: width / 2 - 20,
                y: 20,
                size: 10,
                color: rgb(0.5, 0.5, 0.5)
            });
        }

        // Helper: Create transaction info page
        async function createTransactionInfoPage(pdfDoc, transaction, invoice) {
            const { StandardFonts, rgb } = PDFLib;
            const page = pdfDoc.addPage([595, 842]); // A4 size
            const { width, height } = page.getSize();
            const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

            // Title
            page.drawText('Transaction Details', {
                x: 50,
                y: height - 50,
                size: 20,
                font: fontBold,
                color: rgb(0.23, 0.69, 0.66) // PEBL teal
            });

            // Transaction info
            const info = [
                { label: 'Date:', value: transaction.date || '-' },
                { label: 'Description:', value: transaction.description || '-' },
                { label: 'Amount (GBP):', value: transaction.spent || '-' },
                { label: 'Detail:', value: transaction.detail || transaction.manualDescription || '-' },
                { label: 'Attached File:', value: invoice.filename }
            ];

            let yPos = height - 100;
            info.forEach(({ label, value }) => {
                page.drawText(label, {
                    x: 50,
                    y: yPos,
                    size: 12,
                    font: fontBold,
                    color: rgb(0.2, 0.2, 0.2)
                });

                const valueText = value.length > 80 ? value.substring(0, 80) + '...' : value;
                page.drawText(valueText, {
                    x: 180,
                    y: yPos,
                    size: 12,
                    font: font,
                    color: rgb(0.3, 0.3, 0.3)
                });

                yPos -= 25;
            });

            // Add currency conversion section if transaction was converted
            if (transaction.convertedCurrency && transaction.convertedAmount) {
                yPos -= 15; // Add spacing

                // Section header
                page.drawText('Currency Conversion Details', {
                    x: 50,
                    y: yPos,
                    size: 14,
                    font: fontBold,
                    color: rgb(0.09, 0.69, 0.57) // Green teal
                });

                yPos -= 30;

                // Conversion details
                const conversionInfo = [
                    { label: 'Original Amount (USD):', value: `$${transaction.convertedAmount.toFixed(2)}` },
                    { label: 'Exchange Rate:', value: transaction.conversionRate ? `${transaction.conversionRate.toFixed(4)} (GBP to USD)` : '-' },
                    { label: 'Converted Amount (GBP):', value: transaction.spent || '-' },
                    { label: 'Conversion Date:', value: transaction.conversionDate || transaction.date || '-' },
                    { label: 'Rate Source:', value: 'OpenExchangeRates API (https://openexchangerates.org)' }
                ];

                conversionInfo.forEach(({ label, value }) => {
                    page.drawText(label, {
                        x: 50,
                        y: yPos,
                        size: 10,
                        font: fontBold,
                        color: rgb(0.2, 0.2, 0.2)
                    });

                    const valueText = value.length > 70 ? value.substring(0, 70) + '...' : value;
                    page.drawText(valueText, {
                        x: 230,
                        y: yPos,
                        size: 10,
                        font: font,
                        color: rgb(0.3, 0.3, 0.3)
                    });

                    yPos -= 20;
                });

                // Add calculation explanation
                yPos -= 10;
                page.drawText('Conversion Calculation:', {
                    x: 50,
                    y: yPos,
                    size: 10,
                    font: fontBold,
                    color: rgb(0.2, 0.2, 0.2)
                });

                yPos -= 18;
                const gbpAmount = parseFloat(transaction.spent.replace(/[¬£,]/g, ''));
                const usdAmount = transaction.convertedAmount;
                const rate = transaction.conversionRate || 1;

                page.drawText(`${gbpAmount.toFixed(2)} GBP √ó ${rate.toFixed(4)} = ${usdAmount.toFixed(2)} USD`, {
                    x: 50,
                    y: yPos,
                    size: 10,
                    font: font,
                    color: rgb(0.09, 0.69, 0.57)
                });

                yPos -= 18;
                page.drawText('(The GBP amount shown is the original bank transaction amount)', {
                    x: 50,
                    y: yPos,
                    size: 9,
                    font: font,
                    color: rgb(0.5, 0.5, 0.5)
                });
            }

            return page;
        }

        // Helper: Add error page
        async function addErrorPage(pdfDoc, filename, errorMessage) {
            const { StandardFonts, rgb } = PDFLib;
            const page = pdfDoc.addPage([595, 842]);
            const { width, height } = page.getSize();
            const font = await pdfDoc.embedFont(StandardFonts.Helvetica);

            page.drawText('‚ö†Ô∏è Error Loading Document', {
                x: 50,
                y: height - 50,
                size: 16,
                font: font,
                color: rgb(0.8, 0.2, 0.2)
            });

            page.drawText(`File: ${filename}`, {
                x: 50,
                y: height - 100,
                size: 12,
                font: font
            });

            page.drawText(`Error: ${errorMessage}`, {
                x: 50,
                y: height - 130,
                size: 10,
                font: font,
                color: rgb(0.5, 0.5, 0.5)
            });
        }

        // Show preview modal with merged PDF
        function showPreviewModal(mergedPdf) {
            const modalHtml = `
                <div id="pdfPreviewModal" class="modal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; border-radius: 12px; padding: 0; max-width: 98vw; width: 98%; max-height: 98vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">üìÑ Preview Merged PDF</h3>
                            <button onclick="closePdfPreviewModal()" style="background: transparent; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='transparent'">‚úï</button>
                        </div>
                        <div class="modal-body" style="flex: 1; padding: 10px; overflow: hidden; display: flex; flex-direction: column; min-height: 0;">
                            <iframe id="mergedPdfPreview"
                                    style="width: 100%; flex: 1; min-height: 70vh; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 15px;">
                            </iframe>

                            <div style="padding: 12px; background: #f8fafc; border-radius: 6px; display: flex; justify-content: space-around; font-size: 0.9em;">
                                <span style="color: #475569;">üìÑ Pages: <strong style="color: #3AAFA9;">${mergedPdf.pageCount}</strong></span>
                                <span style="color: #475569;">üì¶ File Size: <strong style="color: #3AAFA9;">${formatFileSize(mergedPdf.size)}</strong></span>
                                <span style="color: #475569;">üìÅ Documents: <strong style="color: #3AAFA9;">${mergedPdf.documentCount}</strong></span>
                            </div>
                        </div>
                        <div class="modal-footer" style="padding: 10px 20px; background: #f8fafc; display: flex; justify-content: flex-end; gap: 10px;">
                            <button class="btn-secondary" onclick="closePdfPreviewModal()" style="padding: 10px 20px; border: none; border-radius: 6px; font-size: 0.95em; font-weight: 600; cursor: pointer; background: #f1f5f9; color: #475569;">Cancel</button>
                            <button class="btn-primary" onclick="downloadMergedPdf()" style="padding: 10px 20px; border: none; border-radius: 6px; font-size: 0.95em; font-weight: 600; cursor: pointer; background: #3AAFA9; color: white; display: flex; align-items: center; gap: 8px;">
                                <span>üíæ Download PDF</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const existingModal = document.getElementById('pdfPreviewModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Load PDF into iframe
            const pdfUrl = URL.createObjectURL(mergedPdf.blob);
            document.getElementById('mergedPdfPreview').src = pdfUrl;

            // Store URL for cleanup
            window.mergedPdfUrl = pdfUrl;
        }

        function closePdfPreviewModal() {
            // Cleanup blob URL
            if (window.mergedPdfUrl) {
                URL.revokeObjectURL(window.mergedPdfUrl);
                window.mergedPdfUrl = null;
            }

            const modal = document.getElementById('pdfPreviewModal');
            if (modal) modal.remove();
        }

        // Download merged PDF
        function downloadMergedPdf() {
            if (!mergedPdfBlob || !mergedPdfFilename) {
                alert('No PDF available to download');
                return;
            }

            // Create download link
            const url = URL.createObjectURL(mergedPdfBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = mergedPdfFilename;

            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Cleanup
            setTimeout(() => URL.revokeObjectURL(url), 100);

            // Show success message
            alert(`PDF downloaded: ${mergedPdfFilename}`);

            // Close preview modal
            closePdfPreviewModal();
        }

        // ========== QUARTERLY XLS EXPORT FUNCTIONALITY ==========

        // Global variables for XLS export
        let quarterlyExportData = null;
        let xlsPreviewWorkbook = null;
        let currentExportFormat = 'default'; // 'default' or 'alternative'

        // Open the quarterly export preview modal
        function openQuarterlyExportPreview(quarterIndex) {
            console.log(`[XLS Export] Opening preview for Q${quarterIndex}`);

            // Gather all quarterly breakdown data
            quarterlyExportData = gatherQuarterlyBreakdownData(quarterIndex);

            if (!quarterlyExportData || !quarterlyExportData.categories || quarterlyExportData.categories.length === 0) {
                alert('No data available to export for this quarter');
                return;
            }

            // Generate initial XLS preview with default format
            currentExportFormat = 'default';
            xlsPreviewWorkbook = generateQuarterlyXLS(quarterlyExportData, currentExportFormat);

            // Create and show modal
            showXLSPreviewModal(quarterIndex);
        }

        // Gather all quarterly breakdown data for export
        function gatherQuarterlyBreakdownData(quarterIndex) {
            console.log(`[XLS Export] Gathering data for Q${quarterIndex}`);

            if (!quarterIndex || !cachedTransactions || cachedTransactions.length === 0) {
                return null;
            }

            // Filter transactions for this quarter
            const quarterTransactions = cachedTransactions.filter(transaction => {
                if (!transaction.assignments || transaction.assignments.length === 0) return false;
                return transaction.assignments.some(assignment =>
                    assignment.projectId === projectBudget.projectId &&
                    assignment.quarter === quarterIndex
                );
            });

            // Group transactions by category
            const categorizedTransactions = {};
            quarterTransactions.forEach(transaction => {
                transaction.assignments.forEach(assignment => {
                    if (assignment.projectId === projectBudget.projectId && assignment.quarter === quarterIndex) {
                        const category = assignment.category || 'Other Costs';
                        if (!categorizedTransactions[category]) {
                            categorizedTransactions[category] = [];
                        }
                        categorizedTransactions[category].push({
                            transaction,
                            assignment
                        });
                    }
                });
            });

            // Define category order
            const categoryOrder = [
                'Labour',
                'Overheads',
                'Materials',
                'Capital Usage',
                'Subcontracting',
                'Travel',
                'Other Costs'
            ];

            // Build structured data for export
            const categories = [];
            let grandTotal = 0;

            categoryOrder.forEach(category => {
                const items = categorizedTransactions[category] || [];
                const categoryTotal = items.reduce((sum, item) => sum + item.assignment.amount, 0);
                grandTotal += categoryTotal;

                const displayName = category === 'Travel' ? 'Travel and Subsistence' : category;

                const transactions = items.map(({transaction, assignment}) => {
                    const spentAmount = parseAmount(transaction.spent);

                    // Calculate value ex tax
                    let valueExTax = 0;
                    if (transaction.zeroVAT || transaction.spent_ex_vat) {
                        valueExTax = parseAmount(transaction.spent_ex_vat || transaction.spent);
                    } else {
                        valueExTax = spentAmount / 1.2;
                    }

                    // Detail column
                    let detail = '';
                    if (transaction.detail) {
                        detail = transaction.detail;
                    } else {
                        const detailParts = [];
                        if (transaction.manualDescription) detailParts.push(transaction.manualDescription);
                        if (transaction.voiceNotes) detailParts.push(transaction.voiceNotes);
                        detail = detailParts.join(' | ');
                    }

                    return {
                        date: transaction.date || '',
                        description: transaction.description || '',
                        valueExTax: valueExTax,
                        valueIncTax: spentAmount,
                        allocationPercentage: assignment.percentage ? (assignment.percentage / 100) : 1,
                        detail: detail,
                        hasPDF: !!getInvoiceForTransaction(transaction, cachedInvoices),
                        amount: assignment.amount
                    };
                });

                categories.push({
                    name: displayName,
                    transactions: transactions,
                    total: categoryTotal,
                    hasTransactions: items.length > 0
                });
            });

            return {
                quarterIndex: quarterIndex,
                projectName: projectBudget.projectName || 'Project',
                projectNumber: projectBudget.projectNumber || '',
                categories: categories,
                grandTotal: grandTotal
            };
        }

        // Generate XLS workbook from quarterly data
        function generateQuarterlyXLS(data, format = 'default') {
            console.log(`[XLS Export] Generating workbook with format: ${format}`);

            const wb = XLSX.utils.book_new();

            if (format === 'default') {
                // Default format - matches the current UI display
                const wsData = [];

                // Title rows
                wsData.push([`Q${data.quarterIndex} Transactions by Category`]);
                wsData.push([]);

                // Add each category
                data.categories.forEach(category => {
                    // Category header
                    wsData.push([category.name]);

                    if (!category.hasTransactions) {
                        wsData.push([`No claims for this category in Q${data.quarterIndex}`]);
                        wsData.push([]);
                    } else {
                        // Column headers
                        wsData.push(['Date', 'Description', 'Value ex Tax', 'Value Inc Tax', '% Allocation', 'Detail', 'PDF', 'Amount']);

                        // Transaction rows
                        category.transactions.forEach(txn => {
                            wsData.push([
                    txn.date,
                    txn.description,
                    txn.valueExTax,
                    txn.valueIncTax,
                    txn.allocationPercentage || 0,
                    txn.detail,
                    txn.hasPDF ? 'PDF' : '',
                    txn.amount
                ]);
                        });

                        // Category total
                        wsData.push(['', '', '', '', '', `Total ${category.name}:`, category.total]);
                        wsData.push([]);
                    }
                });

                // Grand total
                wsData.push(['', '', '', '', '', 'Grand Total:', data.grandTotal]);

                const ws = XLSX.utils.aoa_to_sheet(wsData);

                // Set column widths
                ws['!cols'] = [
                    {wch: 12},  // Date
                    {wch: 35},  // Description
                    {wch: 15},  // Value ex Tax
                    {wch: 15},  // Value Inc Tax
                    {wch: 12},  // % Allocation
                    {wch: 40},  // Detail
                    {wch: 8},   // PDF
                    {wch: 15}   // Amount
                ];

                XLSX.utils.book_append_sheet(wb, ws, `Q${data.quarterIndex} Breakdown`);
            } else {
                // Alternative format - flat list with Excel formulas
                const wsData = [];

                // Title row
                wsData.push([`Q${data.quarterIndex} ${new Date().getFullYear()} (mm/dd/yyyy)`]);

                // Headers
                wsData.push([
                    'Date',
                    'Transaction Ref',
                    'Description of cost',
                    'Inc Vat',
                    'VAT',
                    'Ex Vat',
                    '%',
                    'Total Assigned (exc VAT)',
                    'Supplier Name',
                    'Cost Heading'
                ]);

                // Flatten all transactions into one list
                const allTransactions = [];
                data.categories.forEach(category => {
                    category.transactions.forEach(txn => {
                        allTransactions.push({
                            ...txn,
                            categoryName: category.name
                        });
                    });
                });

                // Sort by date (oldest first)
                allTransactions.sort((a, b) => {
                    const dateA = new Date(a.date.split('/').reverse().join('-')); // Convert dd/mm/yyyy to Date
                    const dateB = new Date(b.date.split('/').reverse().join('-'));
                    return dateA - dateB;
                });

                // Add transaction rows
                allTransactions.forEach(txn => {
                    const vatAmount = txn.valueIncTax - txn.valueExTax;

                    // Map category to abbreviated heading
                    let costHeading = txn.categoryName;
                    if (txn.categoryName === 'Travel and Subsistence') costHeading = 'Travel/Subs';
                    if (txn.categoryName === 'Capital Usage') costHeading = 'CapUse';
                    if (txn.categoryName === 'Subcontracting') costHeading = 'Subcon';

                    // Calculate Transaction Ref: yymmdd-Supplier(7chars)-Amount
                    const dateParts = txn.date.split('/');
                    let transactionRef = '';
                    if (dateParts.length === 3) {
                        const day = dateParts[0].padStart(2, '0');
                        const month = dateParts[1].padStart(2, '0');
                        const year = dateParts[2].slice(-2); // Last 2 digits of year
                        const yymmdd = year + month + day;

                        const supplier = txn.description || '';
                        const supplierPrefix = supplier.substring(0, 7); // First 7 characters

                        const amount = txn.valueIncTax; // Total amount inc VAT

                        transactionRef = `${yymmdd}-${supplierPrefix}-${amount}`;
                    }

                    // Calculate Total Assigned (exc VAT) = Ex Vat √ó %
                    // Always calculate from Ex VAT to ensure accuracy
                    const totalAssigned = txn.valueExTax * (txn.allocationPercentage || 1);

                    wsData.push([
                        txn.date, // Keep as date string for display
                        transactionRef,
                        txn.detail || txn.description,
                        txn.valueIncTax, // Inc Vat
                        vatAmount, // VAT
                        txn.valueExTax, // Ex Vat
                        txn.allocationPercentage || 1, // %
                        totalAssigned, // Total Assigned (exc VAT)
                        txn.description, // Supplier from description column
                        costHeading
                    ]);
                });

                // Add grand total row
                wsData.push([
                    '',
                    '',
                    'Grand Total:',
                    '',
                    '',
                    '',
                    '',
                    data.grandTotal,
                    '',
                    ''
                ]);

                const ws = XLSX.utils.aoa_to_sheet(wsData);

                // Format cells explicitly
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let R = 2; R < range.e.r; R++) { // Start from row 2 (skip title and header)
                    // Format date cells (column A) as date with mm/dd/yyyy display
                    const dateCell = XLSX.utils.encode_cell({r: R, c: 0});
                    if (ws[dateCell] && typeof ws[dateCell].v === 'number') {
                        ws[dateCell].t = 'n'; // Number type (Excel serial date)
                        ws[dateCell].z = 'mm/dd/yyyy'; // Display format
                    }

                    // Format numeric columns with 2 decimal places (Inc Vat, VAT, Ex Vat, Total Assigned)
                    [3, 4, 5, 7].forEach(col => {
                        const numCell = XLSX.utils.encode_cell({r: R, c: col});
                        if (ws[numCell] && typeof ws[numCell].v === 'number') {
                            ws[numCell].t = 'n';
                            ws[numCell].z = '0.00';
                        }
                    });

                    // Format % column with 2 decimal places
                    const pctCell = XLSX.utils.encode_cell({r: R, c: 6});
                    if (ws[pctCell] && typeof ws[pctCell].v === 'number') {
                        ws[pctCell].t = 'n';
                        ws[pctCell].z = '0.00';
                    }
                }

                // Set column widths
                ws['!cols'] = [
                    {wch: 12},  // Date
                    {wch: 30},  // Transaction Ref
                    {wch: 45},  // Description of cost
                    {wch: 12},  // Inc Vat
                    {wch: 12},  // VAT
                    {wch: 12},  // Ex Vat
                    {wch: 8},   // %
                    {wch: 20},  // Total Assigned (exc VAT)
                    {wch: 30},  // Supplier Name
                    {wch: 15}   // Cost Heading
                ];

                XLSX.utils.book_append_sheet(wb, ws, `Q${data.quarterIndex} Alt Format`);
            }

            return wb;
        }

        // Show the XLS preview modal
        function showXLSPreviewModal(quarterIndex) {
            // Generate HTML preview from workbook
            const htmlPreview = generateXLSHTMLPreview(xlsPreviewWorkbook, quarterIndex);

            const modalHtml = `
                <div id="xlsPreviewModal" class="modal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1002; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; border-radius: 12px; padding: 0; max-width: 1100px; width: 95%; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">üìä Excel Export Preview - Q${quarterIndex}</h3>
                            <button onclick="closeXLSPreviewModal()" style="background: transparent; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='transparent'">‚úï</button>
                        </div>

                        <div style="padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: #475569; font-weight: 600;">Format:</span>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px 12px; border-radius: 6px; background: ${currentExportFormat === 'default' ? '#e0f2f1' : 'white'}; border: 1px solid ${currentExportFormat === 'default' ? '#3AAFA9' : '#cbd5e1'}; transition: all 0.2s;">
                                    <input type="radio" name="xlsFormat" value="default" ${currentExportFormat === 'default' ? 'checked' : ''} onchange="toggleXLSFormat('default')" style="margin: 0;">
                                    <span style="font-size: 0.9em; color: #475569;">Default Format</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px 12px; border-radius: 6px; background: ${currentExportFormat === 'alternative' ? '#e0f2f1' : 'white'}; border: 1px solid ${currentExportFormat === 'alternative' ? '#3AAFA9' : '#cbd5e1'}; transition: all 0.2s;">
                                    <input type="radio" name="xlsFormat" value="alternative" ${currentExportFormat === 'alternative' ? 'checked' : ''} onchange="toggleXLSFormat('alternative')" style="margin: 0;">
                                    <span style="font-size: 0.9em; color: #475569;">Alternative Format</span>
                                </label>
                            </div>
                            <div style="color: #475569; font-size: 0.9em;">
                                <span>üì¶ Categories: <strong style="color: #3AAFA9;">${quarterlyExportData.categories.length}</strong></span>
                                <span style="margin-left: 15px;">üí∞ Total: <strong style="color: #3AAFA9;">¬£${quarterlyExportData.grandTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></span>
                            </div>
                        </div>

                        <div class="modal-body" style="flex: 1; padding: 20px; overflow-y: auto; background: #f8fafc;">
                            <div id="xlsPreviewContent" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; min-height: 400px;">
                                ${htmlPreview}
                            </div>
                        </div>

                        <div class="modal-footer" style="padding: 15px 20px; background: #f8fafc; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #e2e8f0;">
                            <button class="btn-secondary" onclick="closeXLSPreviewModal()" style="padding: 10px 20px; border: none; border-radius: 6px; font-size: 0.95em; font-weight: 600; cursor: pointer; background: #f1f5f9; color: #475569;">Cancel</button>
                            <button class="btn-primary" onclick="downloadQuarterlyXLS()" style="padding: 10px 20px; border: none; border-radius: 6px; font-size: 0.95em; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); color: white; display: flex; align-items: center; gap: 8px;">
                                <span>üíæ</span>
                                <span>Download Excel File</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('xlsPreviewModal');
            if (existingModal) existingModal.remove();

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Generate HTML preview of XLS content
        function generateXLSHTMLPreview(workbook, quarterIndex) {
            if (!workbook || !quarterlyExportData) return '<p>No preview available</p>';

            let html = '<div style="font-family: Arial, sans-serif; font-size: 0.9em;">';

            if (currentExportFormat === 'default') {
                // Default format - grouped by category
                html += `<h3 style="color: #3b82f6; margin: 0 0 20px 0;">Q${quarterIndex} Transactions by Category</h3>`;

                quarterlyExportData.categories.forEach(category => {
                    html += `
                        <div style="margin-bottom: 25px;">
                            <div style="background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); color: white; padding: 10px 15px; border-radius: 6px; font-weight: 600; margin-bottom: 10px;">
                                ${category.name}
                            </div>
                    `;

                    if (!category.hasTransactions) {
                        html += `<p style="color: #94a3b8; font-style: italic; margin: 10px 0 0 15px;">No claims for this category in Q${quarterIndex}</p>`;
                    } else {
                        html += `
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 0.85em;">
                                <thead>
                                    <tr style="background: #f1f5f9;">
                                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #cbd5e1; font-weight: 600;">Date</th>
                                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #cbd5e1; font-weight: 600;">Description</th>
                                        <th style="padding: 8px; text-align: right; border-bottom: 2px solid #cbd5e1; font-weight: 600;">Value ex Tax</th>
                                        <th style="padding: 8px; text-align: right; border-bottom: 2px solid #cbd5e1; font-weight: 600;">Value Inc Tax</th>
                                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #cbd5e1; font-weight: 600;">Detail</th>
                                        <th style="padding: 8px; text-align: center; border-bottom: 2px solid #cbd5e1; font-weight: 600;">PDF</th>
                                        <th style="padding: 8px; text-align: right; border-bottom: 2px solid #cbd5e1; font-weight: 600;">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        category.transactions.forEach(txn => {
                            html += `
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 8px;">${txn.date || '-'}</td>
                                    <td style="padding: 8px;">${txn.description || '-'}</td>
                                    <td style="padding: 8px; text-align: right;">¬£${txn.valueExTax.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right;">¬£${txn.valueIncTax.toFixed(2)}</td>
                                    <td style="padding: 8px; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${txn.detail || '-'}</td>
                                    <td style="padding: 8px; text-align: center;">${txn.hasPDF ? 'PDF' : '-'}</td>
                                    <td style="padding: 8px; text-align: right;">¬£${txn.amount.toFixed(2)}</td>
                                </tr>
                            `;
                        });

                        html += `
                                    <tr style="border-top: 2px solid #cbd5e1; background: #f8fafc;">
                                        <td colspan="6" style="padding: 10px; text-align: right; font-weight: 700;">Total ${category.name}:</td>
                                        <td style="padding: 10px; text-align: right; font-weight: 700;">¬£${category.total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    </tr>
                                </tbody>
                            </table>
                        `;
                    }

                    html += '</div>';
                });

                html += `
                    <div style="background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); color: white; padding: 12px 15px; border-radius: 6px; font-weight: 700; text-align: right; margin-top: 10px;">
                        Grand Total: ¬£${quarterlyExportData.grandTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                `;

            } else {
                // Alternative format - flat list
                html += `<h3 style="color: #3b82f6; margin: 0 0 15px 0;">Q${quarterIndex} ${new Date().getFullYear()} (mm/dd/yyyy)</h3>`;

                // Flatten and sort transactions
                const allTransactions = [];
                quarterlyExportData.categories.forEach(category => {
                    category.transactions.forEach(txn => {
                        let costHeading = category.name;
                        if (category.name === 'Travel and Subsistence') costHeading = 'Travel/Subs';
                        if (category.name === 'Capital Usage') costHeading = 'CapUse';
                        if (category.name === 'Subcontracting') costHeading = 'Subcon';

                        allTransactions.push({
                            ...txn,
                            costHeading: costHeading
                        });
                    });
                });

                // Sort by date
                allTransactions.sort((a, b) => {
                    const dateA = new Date(a.date.split('/').reverse().join('-'));
                    const dateB = new Date(b.date.split('/').reverse().join('-'));
                    return dateA - dateB;
                });

                html += `
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.8em;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); color: white;">
                                <th style="padding: 8px; text-align: left; font-weight: 600;">Date</th>
                                <th style="padding: 8px; text-align: left; font-weight: 600;">Transaction Ref</th>
                                <th style="padding: 8px; text-align: left; font-weight: 600;">Description</th>
                                <th style="padding: 8px; text-align: right; font-weight: 600;">Inc Vat</th>
                                <th style="padding: 8px; text-align: right; font-weight: 600;">VAT</th>
                                <th style="padding: 8px; text-align: right; font-weight: 600;">Ex Vat</th>
                                <th style="padding: 8px; text-align: center; font-weight: 600;">%</th>
                                <th style="padding: 8px; text-align: right; font-weight: 600;">Total Assigned (exc VAT)</th>
                                <th style="padding: 8px; text-align: left; font-weight: 600;">Supplier</th>
                                <th style="padding: 8px; text-align: left; font-weight: 600;">Heading</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                allTransactions.forEach(txn => {
                    const vatAmount = txn.valueIncTax - txn.valueExTax;

                    // Calculate Transaction Ref: yymmdd-Supplier(7chars)-Amount
                    const dateParts = txn.date.split('/');
                    let transactionRef = '';
                    if (dateParts.length === 3) {
                        const day = dateParts[0].padStart(2, '0');
                        const month = dateParts[1].padStart(2, '0');
                        const year = dateParts[2].slice(-2);
                        const yymmdd = year + month + day;

                        const supplier = txn.description || '';
                        const supplierPrefix = supplier.substring(0, 7);
                        const amount = txn.valueIncTax;

                        transactionRef = `${yymmdd}-${supplierPrefix}-${amount}`;
                    }

                    // Calculate Total Assigned (exc VAT) = Ex Vat √ó %
                    // Always calculate from Ex VAT to ensure accuracy
                    const allocationPct = txn.allocationPercentage || 1;
                    const totalAssigned = txn.valueExTax * allocationPct;

                    html += `
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 6px 8px;">${txn.date || '-'}</td>
                            <td style="padding: 6px 8px; font-family: monospace; font-size: 0.85em;">${transactionRef}</td>
                            <td style="padding: 6px 8px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${txn.detail || txn.description || '-'}</td>
                            <td style="padding: 6px 8px; text-align: right;">¬£${txn.valueIncTax.toFixed(2)}</td>
                            <td style="padding: 6px 8px; text-align: right;">¬£${vatAmount.toFixed(2)}</td>
                            <td style="padding: 6px 8px; text-align: right;">¬£${txn.valueExTax.toFixed(2)}</td>
                            <td style="padding: 6px 8px; text-align: center;">${allocationPct.toFixed(2)}</td>
                            <td style="padding: 6px 8px; text-align: right;">¬£${totalAssigned.toFixed(2)}</td>
                            <td style="padding: 6px 8px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${txn.description || '-'}</td>
                            <td style="padding: 6px 8px;">${txn.costHeading}</td>
                        </tr>
                    `;
                });

                html += `
                            <tr style="border-top: 2px solid #cbd5e1; background: #f8fafc;">
                                <td colspan="7" style="padding: 10px; text-align: right; font-weight: 700;">Grand Total:</td>
                                <td style="padding: 10px; text-align: right; font-weight: 700;">¬£${quarterlyExportData.grandTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                <td colspan="2"></td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }

            html += '</div>';
            return html;
        }

        // Toggle between default and alternative format
        function toggleXLSFormat(format) {
            console.log(`[XLS Export] Switching to ${format} format`);
            currentExportFormat = format;

            // Regenerate workbook with new format
            xlsPreviewWorkbook = generateQuarterlyXLS(quarterlyExportData, currentExportFormat);

            // Update preview
            const previewContent = document.getElementById('xlsPreviewContent');
            if (previewContent) {
                previewContent.innerHTML = generateXLSHTMLPreview(xlsPreviewWorkbook, quarterlyExportData.quarterIndex);
            }

            // Update format toggle UI
            updateFormatToggleUI();
        }

        // Update the format toggle UI styling
        function updateFormatToggleUI() {
            const modal = document.getElementById('xlsPreviewModal');
            if (!modal) return;

            const labels = modal.querySelectorAll('label');
            labels.forEach(label => {
                const radio = label.querySelector('input[type="radio"]');
                if (radio) {
                    if (radio.value === currentExportFormat) {
                        label.style.background = '#e0f2f1';
                        label.style.borderColor = '#3AAFA9';
                    } else {
                        label.style.background = 'white';
                        label.style.borderColor = '#cbd5e1';
                    }
                }
            });
        }

        // Download the quarterly XLS file
        function downloadQuarterlyXLS() {
            if (!xlsPreviewWorkbook || !quarterlyExportData) {
                alert('No data available to download');
                return;
            }

            try {
                // Generate filename
                const projectName = quarterlyExportData.projectName.replace(/[^a-z0-9]/gi, '_');
                const formatSuffix = currentExportFormat === 'alternative' ? '_Alt' : '';
                const filename = `Q${quarterlyExportData.quarterIndex}_${projectName}_Breakdown${formatSuffix}.xlsx`;

                // Write workbook to binary string
                const wbout = XLSX.write(xlsPreviewWorkbook, {bookType: 'xlsx', type: 'binary'});

                // Convert to blob
                function s2ab(s) {
                    const buf = new ArrayBuffer(s.length);
                    const view = new Uint8Array(buf);
                    for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                    return buf;
                }

                const blob = new Blob([s2ab(wbout)], {type: 'application/octet-stream'});

                // Create download link
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;

                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Cleanup
                setTimeout(() => URL.revokeObjectURL(url), 100);

                console.log(`[XLS Export] Downloaded: ${filename}`);

                // Close modal
                closeXLSPreviewModal();

                // Show success toast or message
                alert(`Excel file downloaded: ${filename}`);

            } catch (error) {
                console.error('[XLS Export] Download failed:', error);
                alert('Failed to download Excel file. See console for details.');
            }
        }

        // Close the XLS preview modal
        function closeXLSPreviewModal() {
            const modal = document.getElementById('xlsPreviewModal');
            if (modal) modal.remove();

            // Clear data
            quarterlyExportData = null;
            xlsPreviewWorkbook = null;
            currentExportFormat = 'default';
        }

        // ========== CATEGORY-SPECIFIC EXCEL EXPORT ==========

        // Export a single category to Excel (no preview modal)
        function exportCategoryToExcel(categoryName, quarterIndex) {
            console.log(`[Category Export] Exporting ${categoryName} for Q${quarterIndex}`);

            // Gather data for this specific category and quarter
            const categoryData = gatherCategoryExportData(categoryName, quarterIndex);

            if (!categoryData || !categoryData.transactions || categoryData.transactions.length === 0) {
                alert(`No transactions found for ${categoryName} in Q${quarterIndex}`);
                return;
            }

            try {
                // Generate XLS workbook
                const wb = generateCategoryXLS(categoryData);

                // Generate filename
                const projectName = (projectBudget.projectName || 'Project').replace(/[^a-z0-9]/gi, '_');
                const categoryNameSafe = categoryName.replace(/[^a-z0-9]/gi, '_');
                const filename = `Q${quarterIndex}_${projectName}_${categoryNameSafe}.xlsx`;

                // Write workbook to binary string
                const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'binary'});

                // Convert to blob
                function s2ab(s) {
                    const buf = new ArrayBuffer(s.length);
                    const view = new Uint8Array(buf);
                    for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                    return buf;
                }

                const blob = new Blob([s2ab(wbout)], {type: 'application/octet-stream'});

                // Create download link
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;

                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Cleanup
                setTimeout(() => URL.revokeObjectURL(url), 100);

                console.log(`[Category Export] Downloaded: ${filename}`);

                // Optional: Show toast instead of alert
                // For now, using subtle console confirmation
            } catch (error) {
                console.error('[Category Export] Export failed:', error);
                alert('Failed to export category to Excel. See console for details.');
            }
        }

        // Gather data for a specific category and quarter
        function gatherCategoryExportData(categoryName, quarterIndex) {
            console.log(`[Category Export] Gathering data for ${categoryName} in Q${quarterIndex}`);

            if (!quarterIndex || !cachedTransactions || cachedTransactions.length === 0) {
                return null;
            }

            // Filter transactions for this quarter and category
            const categoryTransactions = cachedTransactions.filter(transaction => {
                if (!transaction.assignments || transaction.assignments.length === 0) return false;
                return transaction.assignments.some(assignment =>
                    assignment.projectId === projectBudget.projectId &&
                    assignment.quarter === quarterIndex &&
                    (assignment.category || 'Other Costs') === categoryName
                );
            });

            // Build transaction data
            const transactions = [];
            let categoryTotal = 0;

            categoryTransactions.forEach(transaction => {
                const assignment = transaction.assignments.find(a =>
                    a.projectId === projectBudget.projectId &&
                    a.quarter === quarterIndex &&
                    (a.category || 'Other Costs') === categoryName
                );

                if (!assignment) return;

                const spentAmount = parseAmount(transaction.spent);

                // Calculate value ex tax
                let valueExTax = 0;
                if (transaction.zeroVAT || transaction.spent_ex_vat) {
                    valueExTax = parseAmount(transaction.spent_ex_vat || transaction.spent);
                } else {
                    valueExTax = spentAmount / 1.2;
                }

                // Detail column
                let detail = '';
                if (transaction.detail) {
                    detail = transaction.detail;
                } else {
                    const detailParts = [];
                    if (transaction.manualDescription) detailParts.push(transaction.manualDescription);
                    if (transaction.voiceNotes) detailParts.push(transaction.voiceNotes);
                    detail = detailParts.join(' | ');
                }

                categoryTotal += assignment.amount;

                transactions.push({
                    date: transaction.date || '',
                    description: transaction.description || '',
                    valueExTax: valueExTax,
                    valueIncTax: spentAmount,
                    allocationPercentage: assignment.percentage ? (assignment.percentage / 100) : 0,
                    detail: detail,
                    hasPDF: !!getInvoiceForTransaction(transaction, cachedInvoices),
                    amount: assignment.amount
                });
            });

            const displayName = categoryName === 'Travel' ? 'Travel and Subsistence' : categoryName;

            return {
                quarterIndex: quarterIndex,
                projectName: projectBudget.projectName || 'Project',
                projectNumber: projectBudget.projectNumber || '',
                categoryName: displayName,
                transactions: transactions,
                total: categoryTotal
            };
        }

        // Generate XLS workbook for a single category
        function generateCategoryXLS(data) {
            console.log(`[Category Export] Generating workbook for ${data.categoryName}`);

            const wb = XLSX.utils.book_new();
            const wsData = [];

            // Title rows
            wsData.push([`Q${data.quarterIndex} - ${data.categoryName} Transactions`]);
            wsData.push([`Project: ${data.projectName}`]);
            if (data.projectNumber) {
                wsData.push([`Project Number: ${data.projectNumber}`]);
            }
            wsData.push([]);

            // Column headers
            wsData.push(['Date', 'Description', 'Value ex Tax', 'Value Inc Tax', '% Allocation', 'Detail', 'PDF', 'Amount']);

            // Transaction rows
            data.transactions.forEach(txn => {
                wsData.push([
                    txn.date,
                    txn.description,
                    txn.valueExTax,
                    txn.valueIncTax,
                    txn.allocationPercentage || 0,
                    txn.detail,
                    txn.hasPDF ? 'PDF' : '',
                    txn.amount
                ]);
            });

            // Category total
            wsData.push(['', '', '', '', '', 'Total:', data.total]);

            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Set column widths
            ws['!cols'] = [
                    {wch: 12},  // Date
                    {wch: 35},  // Description
                    {wch: 15},  // Value ex Tax
                    {wch: 15},  // Value Inc Tax
                    {wch: 12},  // % Allocation
                    {wch: 40},  // Detail
                    {wch: 8},   // PDF
                    {wch: 15}   // Amount
                ];

            XLSX.utils.book_append_sheet(wb, ws, data.categoryName.substring(0, 31)); // Excel sheet name limit

            return wb;
        }

        // ========== CATEGORY-SPECIFIC PDF EXPORT ==========

        // Global variables for PDF preview
        let currentPDFPreviewData = null;
        let currentPDFBlob = null;

        // Export a single category to PDF (with preview modal)
        function exportCategoryToPDF(categoryName, quarterIndex) {
            console.log(`[Category PDF Export] Exporting ${categoryName} for Q${quarterIndex}`);

            // Gather data for this specific category and quarter
            const categoryData = gatherCategoryExportData(categoryName, quarterIndex);

            if (!categoryData || !categoryData.transactions || categoryData.transactions.length === 0) {
                alert(`No transactions found for ${categoryName} in Q${quarterIndex}`);
                return;
            }

            try {
                // Generate the PDF
                const pdfBlob = generateCategoryPDF(categoryData);

                // Store for later download
                currentPDFPreviewData = categoryData;
                currentPDFBlob = pdfBlob;

                // Show preview modal
                showPDFPreviewModal(categoryData);

            } catch (error) {
                console.error('[Category PDF Export] Export failed:', error);
                alert('Failed to export category to PDF. See console for details.');
            }
        }

        // Generate PDF and return as Blob
        function generateCategoryPDF(categoryData) {
            // Initialize jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // landscape orientation

            // PEBL brand colors
            const peblTeal = [58, 175, 169];
            const peblDarkTeal = [43, 122, 120];

            // Title section
            doc.setFillColor(...peblTeal);
            doc.rect(0, 0, 297, 30, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text(`Q${categoryData.quarterIndex} - ${categoryData.categoryName} Transactions`, 14, 12);

            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(`Project: ${categoryData.projectName}`, 14, 20);
            if (categoryData.projectNumber) {
                doc.text(`Project Number: ${categoryData.projectNumber}`, 14, 26);
            }

            // Prepare table data
            const tableData = categoryData.transactions.map(txn => [
                txn.date || '-',
                txn.description || '-',
                `¬£${txn.valueExTax.toFixed(2)}`,
                `¬£${txn.valueIncTax.toFixed(2)}`,
                (txn.allocationPercentage || 0).toFixed(2),
                txn.detail || '-',
                txn.hasPDF ? 'Yes' : 'No',
                `¬£${txn.amount.toFixed(2)}`
            ]);
            // Generate table
            doc.autoTable({
                startY: 35,
                head: [['Date', 'Description', 'Value ex Tax', 'Value Inc Tax', '% Allocation', 'Detail', 'PDF', 'Amount']],
                body: tableData,
                foot: [['', '', '', '', '', '', 'Total:', `¬£${categoryData.total.toFixed(2)}`]],
                theme: 'grid',
                headStyles: {
                    fillColor: peblTeal,
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 9,
                    halign: 'center'
                },
                footStyles: {
                    fillColor: [240, 240, 240],
                    textColor: [0, 0, 0],
                    fontStyle: 'bold',
                    fontSize: 10,
                    halign: 'right'
                },
                bodyStyles: {
                    fontSize: 8,
                    cellPadding: 3
                },
                columnStyles: {
                    0: { cellWidth: 25, halign: 'left' },    // Date
                    1: { cellWidth: 50, halign: 'left' },    // Description
                    2: { cellWidth: 26, halign: 'right' },   // Value ex Tax
                    3: { cellWidth: 26, halign: 'right' },   // Value Inc Tax
                    4: { cellWidth: 18, halign: 'center' },  // % Allocation
                    5: { cellWidth: 60, halign: 'left' },    // Detail
                    6: { cellWidth: 15, halign: 'center' },  // PDF
                    7: { cellWidth: 26, halign: 'right' }    // Amount
                },
                alternateRowStyles: {
                    fillColor: [248, 249, 250]
                },
                margin: { left: 14, right: 14 }
            });

            // Add footer with generation timestamp
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(
                    `Generated: ${new Date().toLocaleString()} | Page ${i} of ${pageCount}`,
                    14,
                    doc.internal.pageSize.height - 10
                );
            }

            // Return as Blob
            return doc.output('blob');
        }

        // Show PDF preview modal
        function showPDFPreviewModal(categoryData) {
            const pdfUrl = URL.createObjectURL(currentPDFBlob);

            const modalHtml = `
                <div id="pdfPreviewModal" class="modal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1002; align-items: center; justify-content: center; padding: 20px 0;">
                    <div class="modal-content" style="background: white; border-radius: 12px; padding: 0; max-width: 1400px; width: 95%; height: 95vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                            <h3 style="margin: 0;">üìë PDF Preview - Q${categoryData.quarterIndex} ${categoryData.categoryName}</h3>
                            <button onclick="closePDFPreviewModal()" style="background: transparent; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='transparent'">‚úï</button>
                        </div>

                        <div style="padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                            <div style="color: #475569; font-size: 0.9em;">
                                <span>üì¶ Transactions: <strong style="color: #3AAFA9;">${categoryData.transactions.length}</strong></span>
                                <span style="margin-left: 15px;">üí∞ Total: <strong style="color: #3AAFA9;">¬£${categoryData.total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></span>
                            </div>
                        </div>

                        <div class="modal-body" style="flex: 1; min-height: 0; padding: 0; overflow: hidden; background: #f8fafc; display: flex; justify-content: center; align-items: center;">
                            <iframe src="${pdfUrl}" style="width: 100%; height: 100%; border: none; background: white;"></iframe>
                        </div>

                        <div class="modal-footer" style="padding: 15px 20px; background: #f8fafc; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #e2e8f0; flex-shrink: 0;">
                            <button class="btn-secondary" onclick="closePDFPreviewModal()" style="padding: 10px 20px; border: none; border-radius: 6px; font-size: 0.95em; font-weight: 600; cursor: pointer; background: #f1f5f9; color: #475569;">Cancel</button>
                            <button class="btn-primary" onclick="downloadCategoryPDF()" style="padding: 10px 20px; border: none; border-radius: 6px; font-size: 0.95em; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); color: white; display: flex; align-items: center; gap: 8px;">
                                <span>üíæ</span>
                                <span>Download PDF</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('pdfPreviewModal');
            if (existingModal) existingModal.remove();

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Download the previewed PDF
        function downloadCategoryPDF() {
            if (!currentPDFBlob || !currentPDFPreviewData) {
                alert('No PDF available to download');
                return;
            }

            try {
                const projectName = (currentPDFPreviewData.projectName || 'Project').replace(/[^a-z0-9]/gi, '_');
                const categoryNameSafe = currentPDFPreviewData.categoryName.replace(/[^a-z0-9]/gi, '_');
                const filename = `Q${currentPDFPreviewData.quarterIndex}_${projectName}_${categoryNameSafe}.pdf`;

                // Create download link
                const url = URL.createObjectURL(currentPDFBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;

                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Cleanup
                setTimeout(() => URL.revokeObjectURL(url), 100);

                console.log(`[Category PDF Export] Downloaded: ${filename}`);

                // Close modal
                closePDFPreviewModal();

            } catch (error) {
                console.error('[Category PDF Export] Download failed:', error);
                alert('Failed to download PDF. See console for details.');
            }
        }

        // Close PDF preview modal
        function closePDFPreviewModal() {
            const modal = document.getElementById('pdfPreviewModal');
            if (modal) {
                // Revoke object URL from iframe
                const iframe = modal.querySelector('iframe');
                if (iframe && iframe.src) {
                    URL.revokeObjectURL(iframe.src);
                }
                modal.remove();
            }

            // Clear preview data
            if (currentPDFBlob) {
                URL.revokeObjectURL(URL.createObjectURL(currentPDFBlob));
            }
            currentPDFPreviewData = null;
            currentPDFBlob = null;
        }

        // ========== END CATEGORY-SPECIFIC PDF EXPORT ==========

        // ========== END CATEGORY-SPECIFIC EXCEL EXPORT ==========

        // ========== END QUARTERLY XLS EXPORT FUNCTIONALITY ==========

        // ============================================================================
        // END PDF MERGE FUNCTIONALITY
        // ============================================================================

        // Load all invoice attachments from IndexedDB
        async function loadInvoiceAttachments() {
            if (!db) await initIndexedDB();
            if (!db) return [];

            try {
                // Check if invoices store exists
                if (!db.objectStoreNames.contains(INVOICES_STORE_NAME)) {
                    console.log('üìé [INVOICES] Invoices store not found');
                    return [];
                }

                const transaction = db.transaction([INVOICES_STORE_NAME], 'readonly');
                const store = transaction.objectStore(INVOICES_STORE_NAME);

                const allInvoices = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                console.log(`üìé [INVOICES] Loaded ${allInvoices.length} invoices from database`);
                return allInvoices;
            } catch (error) {
                console.error('‚ùå [INVOICES] Failed to load invoices:', error);
                return [];
            }
        }

        // Pre-load transactions and invoices on page load
        async function preloadTransactionData() {
            console.log('[PRELOAD] Loading transaction data...');

            // Run migration first to restore any existing transaction refs
            await migrateTransactionRefs();

            cachedTransactions = await loadAllTransactions();
            cachedInvoices = await loadInvoiceAttachments();
        }

        // Refresh transaction and invoice data (call this when page becomes visible)
        async function refreshTransactionData() {
            const oldTxCount = cachedTransactions ? cachedTransactions.length : 0;
            const oldInvCount = cachedInvoices ? cachedInvoices.length : 0;

            // Show loading notification
            addLog('üîÑ Syncing spend data from database...');

            // Run migration to ensure any new transaction refs are preserved
            await migrateTransactionRefs();

            cachedTransactions = await loadAllTransactions();
            cachedInvoices = await loadInvoiceAttachments();

            const newTxCount = cachedTransactions.length;
            const newInvCount = cachedInvoices.length;

            // Re-render the results to show updated data
            if (window.budgetProjects && window.budgetProjects.length > 0) {
                console.log('üîÑ [REFRESH] Re-rendering budget display...');
                displayResults();
            }

            // Show success notification with details
            const txChanged = newTxCount !== oldTxCount;
            const invChanged = newInvCount !== oldInvCount;

            if (txChanged || invChanged) {
                addLog(`‚úÖ Synced! ${newTxCount} transactions, ${newInvCount} PDFs (${txChanged ? 'transactions updated' : ''}${txChanged && invChanged ? ', ' : ''}${invChanged ? 'PDFs updated' : ''})`);
            } else {
                addLog(`‚úÖ Synced! ${newTxCount} transactions, ${newInvCount} PDFs available (no changes)`);
            }
        }

        // Auto-refresh when page becomes visible (user switches back from spend.html)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('üëÅÔ∏è [VISIBILITY] Page became visible - refreshing data...');
                refreshTransactionData();
            }
        });

        // Also refresh on window focus (alternative to visibility change)
        window.addEventListener('focus', function() {
            console.log('üéØ [FOCUS] Window focused - refreshing data...');
            refreshTransactionData();
        });

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ [STARTUP] DOM Content Loaded - starting initialization...');

            // Initialize IndexedDB
            initIndexedDB()
                .then((database) => {
                    console.log('üîÑ [STARTUP] IndexedDB initialization promise resolved');
                    console.log('üîç [STARTUP] Database object:', database ? 'Present' : 'NULL');

                    if (database) {
                        addLog('üíæ IndexedDB initialized successfully');
                        console.log('‚úÖ [STARTUP] Ready to save/load projects');
                        console.log('üîÑ [STARTUP] Calling loadProjectsOnStartup()...');

                        // Auto-load projects to check for existing data
                        loadProjectsOnStartup();

                        // Migrate existing projects to Supabase (one-time background sync)
                        migrateProjectsToSupabase().catch(err => console.warn('‚òÅÔ∏è Migration failed:', err));

                        // Pre-load transactions and invoices from Spend tab
                        preloadTransactionData();
                    } else {
                        addLog('‚ö†Ô∏è IndexedDB unavailable - project saving disabled');
                        console.warn('‚ö†Ô∏è [STARTUP] App running without database support');
                    }
                })
                .catch((error) => {
                    console.error('‚ùå [STARTUP] Failed to initialize IndexedDB:', error);
                    addLog('‚ö†Ô∏è IndexedDB initialization failed - project saving disabled');
                });
        });

        function handleFile(file) {
            console.log('File selected:', file.name, 'Type:', file.type);
            addLog(`üìÅ Loading file: ${file.name}`);

            const fileName = file.name.toLowerCase();
            const reader = new FileReader();

            if (fileName.endsWith('.csv')) {
                reader.onload = (e) => parseCSV(e.target.result, file.name);
                reader.readAsText(file);
            } else if (fileName.endsWith('.xlsx')) {
                reader.onload = (e) => parseExcel(e.target.result, file.name);
                reader.readAsArrayBuffer(file);
            } else {
                addLog('‚ùå Unsupported file format. Please use CSV or XLSX files.');
                alert('Unsupported file format. Please use CSV or XLSX files.');
            }
        }

        function parseCSV(csvText, fileName) {
            console.log('Parsing CSV file:', fileName);
            addLog('Parsing CSV file...');

            try {
                const lines = csvText.trim().split('\n');
                const rows = lines.map(line => {
                    // Simple CSV parsing (handles basic cases)
                    const result = [];
                    let current = '';
                    let inQuotes = false;

                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            result.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current.trim());
                    return result;
                });

                // Skip header rows (first 4 rows based on the example)
                const dataRows = rows.slice(4);

                // Parse each category row
                budgetData = [];
                for (const row of dataRows) {
                    const category = row[0];

                    // Skip Total row and empty rows
                    if (!category || category.toLowerCase() === 'total' || category === '') continue;

                    // Map category names
                    let mappedCategory = category;
                    if (category.toLowerCase() === 'capital usage') mappedCategory = 'Capital Use';
                    if (category.toLowerCase() === 'travel and subsistence') mappedCategory = 'Travel';
                    if (category.toLowerCase() === 'other costs') mappedCategory = 'Other';

                    const item = {
                        id: Date.now() + budgetData.length,
                        category: mappedCategory,
                        description: mappedCategory,
                        quantity: null,
                        unit: null,
                        unitCost: null,
                        totalCost: 0,
                        q1: parseFloat(row[1]) || 0,
                        q2: parseFloat(row[2]) || 0,
                        q3: parseFloat(row[3]) || 0,
                        q4: parseFloat(row[4]) || 0,
                        totalSpent: parseFloat(row[5]) || 0,
                        totalEligible: parseFloat(row[6]) || 0,
                        difference: parseFloat(row[6] || 0) - parseFloat(row[5] || 0),
                        forecast: parseFloat(row[6]) || 0,
                        notes: ''
                    };

                    budgetData.push(item);
                }

                addLog(`‚úÖ Successfully loaded ${budgetData.length} categories from CSV`);
                console.log('Parsed budget data:', budgetData);

                displayResults();
                document.getElementById('results').classList.add('show');

            } catch (error) {
                console.error('CSV parsing error:', error);
                addLog(`‚ùå Error parsing CSV: ${error.message}`);
                alert(`Error parsing CSV file: ${error.message}`);
            }
        }

        function parseExcel(arrayBuffer, fileName) {
            console.log('Parsing Excel file:', fileName);
            addLog('Parsing Excel file...');

            try {
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                console.log('Excel data:', jsonData);

                // Skip header rows (first 4 rows)
                const dataRows = jsonData.slice(4);

                budgetData = [];
                for (const row of dataRows) {
                    const category = row[0];

                    // Skip Total row and empty rows
                    if (!category || category.toLowerCase() === 'total' || category === '') continue;

                    // Map category names
                    let mappedCategory = category;
                    if (category.toLowerCase() === 'capital usage') mappedCategory = 'Capital Use';
                    if (category.toLowerCase() === 'travel and subsistence') mappedCategory = 'Travel';
                    if (category.toLowerCase() === 'other costs') mappedCategory = 'Other';

                    const item = {
                        id: Date.now() + budgetData.length,
                        category: mappedCategory,
                        description: mappedCategory,
                        quantity: null,
                        unit: null,
                        unitCost: null,
                        totalCost: 0,
                        q1: parseFloat(row[1]) || 0,
                        q2: parseFloat(row[2]) || 0,
                        q3: parseFloat(row[3]) || 0,
                        q4: parseFloat(row[4]) || 0,
                        totalSpent: parseFloat(row[5]) || 0,
                        totalEligible: parseFloat(row[6]) || 0,
                        difference: parseFloat(row[6] || 0) - parseFloat(row[5] || 0),
                        forecast: parseFloat(row[6]) || 0,
                        notes: ''
                    };

                    budgetData.push(item);
                }

                addLog(`‚úÖ Successfully loaded ${budgetData.length} categories from Excel`);
                console.log('Parsed budget data:', budgetData);

                displayResults();
                document.getElementById('results').classList.add('show');

            } catch (error) {
                console.error('Excel parsing error:', error);
                addLog(`‚ùå Error parsing Excel: ${error.message}`);
                alert(`Error parsing Excel file: ${error.message}`);
            }
        }

        // IndexedDB Save/Load Functions
        // Migrate all existing projects from IndexedDB to Supabase (one-time)
        async function migrateProjectsToSupabase() {
            console.log('üîÑ [MIGRATION] Starting migration of projects to Supabase...');

            try {
                // Check if migration already done
                const migrationKey = 'grants_migration_completed';
                if (localStorage.getItem(migrationKey) === 'true') {
                    console.log('‚úÖ [MIGRATION] Already completed, skipping');
                    return;
                }

                // Ensure user is authenticated
                const { data: { user }, error: authError } = await supabaseClient.auth.getUser();

                if (authError || !user) {
                    console.warn('‚òÅÔ∏è [MIGRATION] User not authenticated, will retry later');
                    return;
                }

                if (!db) {
                    console.warn('‚òÅÔ∏è [MIGRATION] IndexedDB not ready');
                    return;
                }

                // Get all projects from IndexedDB
                const transaction = db.transaction(['projects'], 'readonly');
                const objectStore = transaction.objectStore('projects');
                const getAllRequest = objectStore.getAll();

                getAllRequest.onsuccess = async () => {
                    const projects = getAllRequest.result;

                    if (!projects || projects.length === 0) {
                        console.log('üì≠ [MIGRATION] No projects to migrate');
                        localStorage.setItem(migrationKey, 'true');
                        return;
                    }

                    console.log(`üîÑ [MIGRATION] Found ${projects.length} projects to migrate`);

                    // Upload each project to Supabase
                    let successCount = 0;
                    let failCount = 0;

                    for (const project of projects) {
                        try {
                            const { error } = await supabaseClient
                                .from('grants')
                                .upsert({
                                    user_id: user.id,
                                    project_id: String(project.projectId),
                                    project_data: project
                                }, {
                                    onConflict: 'user_id,project_id'
                                });

                            if (error) {
                                console.error(`‚ùå [MIGRATION] Failed to migrate project ${project.projectId}:`, error);
                                failCount++;
                            } else {
                                console.log(`‚úÖ [MIGRATION] Migrated project ${project.projectId}`);
                                successCount++;
                            }
                        } catch (err) {
                            console.error(`‚ùå [MIGRATION] Error migrating project ${project.projectId}:`, err);
                            failCount++;
                        }
                    }

                    console.log(`‚úÖ [MIGRATION] Complete: ${successCount} succeeded, ${failCount} failed`);

                    if (successCount > 0) {
                        addLog(`‚òÅÔ∏è Migrated ${successCount} project(s) to cloud`);
                    }

                    // Mark migration as complete (even if some failed)
                    localStorage.setItem(migrationKey, 'true');
                };

                getAllRequest.onerror = () => {
                    console.error('‚ùå [MIGRATION] Failed to read projects from IndexedDB:', getAllRequest.error);
                };

            } catch (error) {
                console.error('‚ùå [MIGRATION] Migration error:', error);
            }
        }

        // Save project to Supabase (cloud storage)
        async function saveToSupabase() {
            if (!projectBudget || !projectBudget.projectId) {
                console.warn('‚òÅÔ∏è [SUPABASE SYNC] No project to save');
                return false;
            }

            try {
                console.log(`‚òÅÔ∏è [SUPABASE SYNC] Saving project ${projectBudget.projectId} to cloud...`);

                // Ensure user is authenticated
                const { data: { user }, error: authError } = await supabaseClient.auth.getUser();

                if (authError || !user) {
                    console.warn('‚òÅÔ∏è [SUPABASE SYNC] User not authenticated, skipping cloud save');
                    return false;
                }

                // Upsert to Supabase grants table
                const { data, error } = await supabaseClient
                    .from('grants')
                    .upsert({
                        user_id: user.id,
                        project_id: String(projectBudget.projectId),
                        project_data: projectBudget
                    }, {
                        onConflict: 'user_id,project_id'
                    });

                if (error) {
                    console.error('‚òÅÔ∏è [SUPABASE SYNC] Save failed:', error);
                    addLog(`‚ö†Ô∏è Cloud sync failed: ${error.message}`);
                    return false;
                }

                console.log(`‚òÅÔ∏è [SUPABASE SYNC] ‚úÖ Project ${projectBudget.projectId} synced to cloud`);
                addLog(`‚òÅÔ∏è Synced to cloud: ${projectBudget.projectName || projectBudget.projectNumber || 'Project'}`);
                return true;

            } catch (error) {
                console.error('‚òÅÔ∏è [SUPABASE SYNC] Error:', error);
                return false;
            }
        }

        async function saveToIndexedDB() {
            if (!db) {
                addLog('‚ö†Ô∏è Database not initialized');
                return false;
            }

            try {
                projectBudget.lastModified = new Date().toISOString();

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);

                let request;
                if (projectBudget.projectId && projectBudget.projectId > 0) {
                    // Update existing record
                    request = objectStore.put(projectBudget);
                } else {
                    // Create new record - remove null projectId before adding
                    const dataToSave = { ...projectBudget };
                    delete dataToSave.projectId;
                    request = objectStore.add(dataToSave);
                }

                return new Promise((resolve, reject) => {
                    request.onsuccess = async () => {
                        if (!projectBudget.projectId || projectBudget.projectId === null) {
                            projectBudget.projectId = request.result;
                        }
                        const projectName = projectBudget.projectName || projectBudget.projectNumber || 'Unnamed Project';
                        addLog(`üíæ Auto-saved: ${projectName} (ID: ${projectBudget.projectId})`);
                        console.log('Project saved with ID:', projectBudget.projectId);

                        // Update the dropdown button to show current project name
                        const currentProjectNameElement = document.getElementById('currentProjectName');
                        if (currentProjectNameElement) {
                            currentProjectNameElement.textContent = projectName;
                        }

                        // Also save to Supabase (cloud sync)
                        saveToSupabase().catch(err => console.warn('‚òÅÔ∏è Cloud sync failed:', err));

                        resolve(true);
                    };

                    request.onerror = () => {
                        console.error('IndexedDB save error:', request.error);
                        addLog(`‚ùå Save failed: ${request.error}`);
                        reject(request.error);
                    };
                });
            } catch (error) {
                console.error('Save error:', error);
                addLog(`‚ùå Save error: ${error.message}`);
                return false;
            }
        }

        // Migrate old property names to new standardized names
        // Returns true if any migration was performed, false otherwise
        function migrateProjectProperties(project) {
            if (!project) return false;
            let migrated = false;

            // Migrate subcontracting.items ‚Üí subcontracting.contractors
            if (project.subcontracting) {
                if (project.subcontracting.items && Array.isArray(project.subcontracting.items)) {
                    console.log(`üîÑ [MIGRATION] Found ${project.subcontracting.items.length} items in subcontracting.items`);

                    // Initialize contractors array if it doesn't exist
                    if (!project.subcontracting.contractors) {
                        project.subcontracting.contractors = [];
                    }

                    // Merge items into contractors (avoid duplicates)
                    project.subcontracting.items.forEach(item => {
                        // Check if this item already exists in contractors
                        const exists = project.subcontracting.contractors.some(c =>
                            c.item === item.item && c.total === item.total
                        );
                        if (!exists) {
                            project.subcontracting.contractors.push(item);
                            console.log(`  ‚úÖ Migrated: ${item.item}`);
                        }
                    });

                    // Delete old property
                    delete project.subcontracting.items;
                    console.log('‚úÖ [MIGRATION] Migrated subcontracting.items ‚Üí subcontracting.contractors');
                    migrated = true;
                }
            }

            // Migrate travel.items ‚Üí travel.trips (if items exists)
            if (project.travel) {
                if (project.travel.items && Array.isArray(project.travel.items)) {
                    console.log(`üîÑ [MIGRATION] Found ${project.travel.items.length} items in travel.items`);

                    // Initialize trips array if it doesn't exist
                    if (!project.travel.trips) {
                        project.travel.trips = [];
                    }

                    // Merge items into trips (avoid duplicates)
                    project.travel.items.forEach(item => {
                        // Check if this item already exists in trips
                        const exists = project.travel.trips.some(t =>
                            t.destination === item.destination && t.total === item.total
                        );
                        if (!exists) {
                            project.travel.trips.push(item);
                            console.log(`  ‚úÖ Migrated: ${item.destination || item.purpose}`);
                        }
                    });

                    // Delete old property
                    delete project.travel.items;
                    console.log('‚úÖ [MIGRATION] Migrated travel.items ‚Üí travel.trips');
                    migrated = true;
                }
            }

            // DEBUG: Log the state after migration
            console.log('üîç [MIGRATION DEBUG] After migration:');
            console.log('  - subcontracting.contractors:', project.subcontracting?.contractors?.length || 0);
            console.log('  - subcontracting.items:', project.subcontracting?.items?.length || 'undefined');
            console.log('  - travel.trips:', project.travel?.trips?.length || 0);
            console.log('  - travel.items:', project.travel?.items?.length || 'undefined');
            console.log('  - otherCosts.items:', project.otherCosts?.items?.length || 0);

            console.log(`‚úÖ [MIGRATION] Property migration complete (${migrated ? 'changes made' : 'no changes needed'})`);
            return migrated;
        }

        // Emergency data recovery function - call this from console if data disappeared
        window.recoverProjectData = async function() {
            console.log('üö® [RECOVERY] Starting emergency data recovery...');

            if (!db) {
                console.error('‚ùå [RECOVERY] Database not initialized');
                return;
            }

            try {
                const transaction = db.transaction(['projects'], 'readonly');
                const objectStore = transaction.objectStore('projects');
                const request = objectStore.getAll();

                request.onsuccess = () => {
                    const projects = request.result;
                    console.log(`üìä [RECOVERY] Found ${projects.length} projects in database`);

                    projects.forEach((project, index) => {
                        console.log(`\nüìÅ [RECOVERY] Project ${index + 1}: ${project.projectName || project.projectNumber}`);
                        console.log('  Subcontracting:', {
                            contractors: project.subcontracting?.contractors?.length || 0,
                            items: project.subcontracting?.items?.length || 0,
                            data: project.subcontracting
                        });
                        console.log('  Travel:', {
                            trips: project.travel?.trips?.length || 0,
                            items: project.travel?.items?.length || 0,
                            data: project.travel
                        });
                        console.log('  Other Costs:', {
                            items: project.otherCosts?.items?.length || 0,
                            data: project.otherCosts
                        });
                    });
                };

                request.onerror = () => {
                    console.error('‚ùå [RECOVERY] Failed to load projects:', request.error);
                };
            } catch (error) {
                console.error('‚ùå [RECOVERY] Error:', error);
            }
        }

        async function loadProjectFromDB(projectId) {
            if (!db) {
                addLog('‚ö†Ô∏è Database not initialized');
                return null;
            }

            try {
                const transaction = db.transaction(['projects'], 'readonly');
                const objectStore = transaction.objectStore('projects');
                const request = objectStore.get(projectId);

                return new Promise((resolve, reject) => {
                    request.onsuccess = async () => {
                        if (request.result) {
                            projectBudget = request.result;

                            // Migrate old property names to new ones
                            const wasMigrated = migrateProjectProperties(projectBudget);

                            // If migration occurred, save the updated project back to DB
                            if (wasMigrated) {
                                console.log('üíæ [MIGRATION] Saving migrated project back to database...');
                                await saveToIndexedDB();
                            }

                            addLog(`üìÇ Loaded: ${projectBudget.projectName || projectBudget.projectNumber}`);
                            resolve(projectBudget);
                        } else {
                            addLog('‚ùå Project not found');
                            resolve(null);
                        }
                    };

                    request.onerror = () => {
                        addLog(`‚ùå Load failed: ${request.error}`);
                        reject(request.error);
                    };
                });
            } catch (error) {
                console.error('Load error:', error);
                addLog(`‚ùå Load error: ${error.message}`);
                return null;
            }
        }

        async function listSavedProjects() {
            console.log('üìã [LIST] listSavedProjects() called');

            if (!db) {
                console.error('‚ùå [LIST] Database not initialized');
                alert('Database not initialized');
                return;
            }

            try {
                const transaction = db.transaction(['projects'], 'readonly');
                const objectStore = transaction.objectStore('projects');
                const request = objectStore.getAll();

                request.onsuccess = () => {
                    const projects = request.result;
                    console.log(`üìã [LIST] Found ${projects.length} projects`);

                    const dropdownList = document.getElementById('projectsDropdownList');
                    const dropdown = document.getElementById('savedProjectsDropdown');

                    if (!dropdownList) {
                        console.error('‚ùå [LIST] projectsDropdownList element not found');
                        return;
                    }
                    if (!dropdown) {
                        console.error('‚ùå [LIST] savedProjectsDropdown element not found');
                        return;
                    }

                    if (projects.length === 0) {
                        console.log('‚ÑπÔ∏è [LIST] No projects found, showing empty state');
                        dropdownList.innerHTML = `
                            <div class="dropdown-empty-state">
                                <div style="font-size: 2em; margin-bottom: 10px;">üìÇ</div>
                                <p style="font-size: 0.95em; margin-bottom: 5px;">No saved projects yet</p>
                                <p style="font-size: 0.85em; color: #94a3b8;">Parse a budget and click "Save" to create your first project</p>
                            </div>
                        `;
                    } else {
                        // Sort by last modified (most recent first)
                        projects.sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified));
                        console.log(`üìã [LIST] Rendering ${projects.length} projects:`, projects.map(p => p.projectName || p.projectNumber));

                        dropdownList.innerHTML = projects.map(project => {
                            const projectId = project.id || project.projectId;
                            const name = project.projectName || project.projectNumber || `Project ${projectId}`;
                            const duration = project.financeSummary?.projectDuration || 'N/A';
                            const fundingLevel = project.financeSummary?.fundingLevel || 0;
                            const total = project.financeSummary?.totalCosts || 0;
                            const formattedTotal = new Intl.NumberFormat('en-GB', {
                                style: 'currency',
                                currency: 'GBP',
                                minimumFractionDigits: 0
                            }).format(total);

                            return `
                                <div class="dropdown-project-item" onclick="handleProjectSelection(${projectId})">
                                    <div class="dropdown-project-info">
                                        <div class="dropdown-project-name">${name}</div>
                                        <div class="dropdown-project-meta">
                                            üí∞ ${formattedTotal} &nbsp;‚Ä¢&nbsp; ${fundingLevel}% Funding &nbsp;‚Ä¢&nbsp; ‚è±Ô∏è ${duration} &nbsp;‚Ä¢&nbsp; ID: ${projectId}
                                        </div>
                                    </div>
                                    <button class="dropdown-edit-btn" onclick="event.stopPropagation(); openProjectEditModal(${projectId}, '${name.replace(/'/g, "\\'")}', '${project.projectNumber || ''}')">
                                        ‚úèÔ∏è
                                    </button>
                                </div>
                            `;
                        }).join('');
                    }

                    console.log('‚úÖ [LIST] Setting dropdown display to block');
                    dropdown.style.display = 'block';

                    // Position dropdown below the button (fixed positioning)
                    const btn = document.getElementById('savedProjectsBtn');
                    if (btn) {
                        const rect = btn.getBoundingClientRect();
                        dropdown.style.top = (rect.bottom + 10) + 'px';
                        dropdown.style.left = rect.left + 'px';
                        console.log('‚úÖ [LIST] Positioned dropdown at:', { top: dropdown.style.top, left: dropdown.style.left });
                    }

                    console.log('‚úÖ [LIST] Dropdown display is now:', dropdown.style.display);
                    console.log('‚úÖ [LIST] Dropdown element:', dropdown);
                };

                request.onerror = () => {
                    console.error('‚ùå [LIST] Failed to list projects:', request.error);
                    alert('Failed to list projects: ' + request.error);
                };
            } catch (error) {
                alert('Error listing projects: ' + error.message);
            }
        }

        function toggleSavedProjectsDropdown() {
            console.log('üîΩ [DROPDOWN] Toggle clicked');
            const dropdown = document.getElementById('savedProjectsDropdown');

            if (!dropdown) {
                console.error('‚ùå [DROPDOWN] Dropdown element not found');
                return;
            }

            console.log('üîΩ [DROPDOWN] Current display:', dropdown.style.display);

            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                console.log('üîΩ [DROPDOWN] Opening dropdown, calling listSavedProjects()');
                listSavedProjects(); // This will set display to 'block'
            } else {
                console.log('üîΩ [DROPDOWN] Closing dropdown');
                dropdown.style.display = 'none';
            }
        }

        // Load projects on startup to verify database has existing data
        async function loadProjectsOnStartup() {
            console.log('üìÇ [LOAD STARTUP] loadProjectsOnStartup() called');
            console.log('üìÇ [LOAD STARTUP] db object:', db ? 'Present' : 'NULL');

            if (!db) {
                console.log('‚ö†Ô∏è [LOAD STARTUP] Database not ready for startup load');
                addLog('‚ö†Ô∏è Database not ready');
                return;
            }

            try {
                console.log('üìÇ [LOAD STARTUP] Creating transaction...');
                const transaction = db.transaction(['projects'], 'readonly');
                const objectStore = transaction.objectStore('projects');
                console.log('üìÇ [LOAD STARTUP] Getting all projects...');
                const request = objectStore.getAll();

                request.onsuccess = () => {
                    const projects = request.result;
                    console.log(`üìÇ [LOAD STARTUP] getAll() success - retrieved ${projects.length} projects`);
                    console.log('üìÇ [LOAD STARTUP] Projects:', projects);

                    const btnText = document.getElementById('currentProjectName');

                    if (projects.length > 0) {
                        console.log(`‚úÖ [LOAD STARTUP] Found ${projects.length} existing project(s) in database`);
                        addLog(`üìö Found ${projects.length} saved project(s)`);

                        // List project names for debugging
                        projects.forEach((p, i) => {
                            console.log(`  ${i + 1}. ${p.projectName} (ID: ${p.id || p.projectId})`);
                        });

                        // Update button to show project count
                        if (btnText) {
                            btnText.textContent = `${projects.length} Project${projects.length > 1 ? 's' : ''} Available`;
                            console.log(`‚úÖ [LOAD STARTUP] Updated button text to: ${btnText.textContent}`);
                        }

                        // Check localStorage for last selected project
                        const lastSelectedId = localStorage.getItem('lastSelectedProjectId');
                        let projectToLoad = null;

                        if (lastSelectedId) {
                            // Try to find the last selected project
                            projectToLoad = projects.find(p => String(p.id || p.projectId) === String(lastSelectedId));
                            if (projectToLoad) {
                                console.log(`üîÑ [LOAD STARTUP] Restoring last selected project from localStorage: ${projectToLoad.projectName} (ID: ${lastSelectedId})`);
                                addLog(`üîÑ Restoring: ${projectToLoad.projectName}`);
                            } else {
                                console.log(`‚ö†Ô∏è [LOAD STARTUP] Last selected project (ID: ${lastSelectedId}) not found, falling back to most recent`);
                            }
                        }

                        // Fall back to most recent if no saved selection or project not found
                        if (!projectToLoad) {
                            const mostRecent = projects.sort((a, b) => (b.id || b.projectId) - (a.id || a.projectId))[0];
                            if (mostRecent) {
                                projectToLoad = mostRecent;
                                console.log(`üîÑ [LOAD STARTUP] Auto-loading most recent project: ${mostRecent.projectName} (ID: ${mostRecent.id || mostRecent.projectId})`);
                                addLog(`üîÑ Auto-loading: ${mostRecent.projectName}`);
                            }
                        }

                        // Load the selected project
                        if (projectToLoad) {
                            const projectId = projectToLoad.id || projectToLoad.projectId;
                            handleProjectSelection(projectId);
                        }
                    } else {
                        console.log('‚ÑπÔ∏è [LOAD STARTUP] No existing projects found in database');
                        addLog('‚ÑπÔ∏è No saved projects yet');
                        if (btnText) {
                            btnText.textContent = 'No Saved Projects';
                            console.log('‚úÖ [LOAD STARTUP] Updated button text to: No Saved Projects');
                        }
                    }
                };

                request.onerror = () => {
                    console.error('‚ùå [LOAD STARTUP] Failed to load projects on startup:', request.error);
                    addLog('‚ö†Ô∏è Failed to check for saved projects');
                };
            } catch (error) {
                console.error('‚ùå [LOAD STARTUP] Error during startup project load:', error);
                console.error('‚ùå [LOAD STARTUP] Error stack:', error.stack);
                addLog('‚ö†Ô∏è Error checking for saved projects');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('savedProjectsDropdown');
            const btn = document.getElementById('savedProjectsBtn');
            if (dropdown && btn && !dropdown.contains(event.target) && !btn.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        function saveCurrentProject() {
            saveToIndexedDB();
        }

        function closeProjectsModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('projectsModal').classList.remove('show');
        }

        async function handleProjectSelection(projectId) {
            console.log(`üìÇ [LOAD] ===== LOADING PROJECT ID: ${projectId} =====`);

            // Close dropdown instead of modal
            const dropdown = document.getElementById('savedProjectsDropdown');
            if (dropdown) {
                console.log('üìÇ [LOAD] Closing dropdown');
                dropdown.style.display = 'none';
            }

            // Clear all display sections first to prevent mixing IUK/Welsh Gov
            console.log(`üßπ [LOAD] Clearing all display sections...`);
            const sectionsToClear = ['financeSummarySection', 'labourSection', 'overheadsMaterialsSection',
                                     'capitalSubcontractingSection', 'travelOtherSection'];
            sectionsToClear.forEach(sectionId => {
                const element = document.getElementById(sectionId);
                if (element) element.innerHTML = '';
            });

            const project = await loadProjectFromDB(projectId);
            if (project) {
                console.log(`‚úÖ [LOAD] Project loaded, funding body: ${project.fundingBody}`);

                // Save selected project to localStorage for persistence across page navigation
                localStorage.setItem('lastSelectedProjectId', projectId);
                console.log(`üíæ [LOAD] Saved project ID ${projectId} to localStorage for persistence`);

                // Update the dropdown button to show current project name
                const currentProjectNameElement = document.getElementById('currentProjectName');
                if (currentProjectNameElement) {
                    const projectDisplayName = project.projectName || project.projectNumber || `Project ${projectId}`;
                    currentProjectNameElement.textContent = projectDisplayName;
                    console.log(`üìå [LOAD] Updated dropdown to show: ${projectDisplayName}`);
                }

                await displayDetailedBudget();
                document.getElementById('detailedBudgetResults').classList.add('show');
                addLog(`‚úÖ Loaded project: ${project.projectName || project.projectNumber || 'Unnamed'}`);
            } else {
                console.error(`‚ùå [LOAD] Failed to load project ${projectId}`);
            }
        }

        // Edit Modal Functions
        let currentEditProjectId = null;

        function openProjectEditModal(projectId, projectName, projectNumber) {
            currentEditProjectId = projectId;

            // Populate modal fields
            document.getElementById('editProjectName').value = projectName || '';
            document.getElementById('editProjectNumber').value = projectNumber || '';

            // Load and display categories
            loadProjectCategories(projectId);

            // Show modal
            document.getElementById('projectEditModal').style.display = 'flex';

            // Focus on first input
            setTimeout(() => {
                console.log('üóëÔ∏è [DELETE] Setting up click-outside listener with 100ms delay');
                document.getElementById('editProjectName').focus();
            }, 100);
        }

        function closeProjectEditModal(event) {
            if (event && event.target.classList.contains('modal-overlay')) {
                document.getElementById('projectEditModal').style.display = 'none';
                currentEditProjectId = null;
            } else if (!event) {
                document.getElementById('projectEditModal').style.display = 'none';
                currentEditProjectId = null;
            }
        }

        async function saveProjectEdit() {
            if (!currentEditProjectId || !db) {
                addLog('‚ùå Cannot save: Invalid project or database not initialized');
                return;
            }

            const newName = document.getElementById('editProjectName').value.trim();
            const newNumber = document.getElementById('editProjectNumber').value.trim();

            if (!newName && !newNumber) {
                alert('Please provide at least a project name or project number');
                return;
            }

            try {
                // Load the project from database
                const transaction = db.transaction(['projects'], 'readwrite');
                const objectStore = transaction.objectStore('projects');
                const getRequest = objectStore.get(currentEditProjectId);

                getRequest.onsuccess = () => {
                    const project = getRequest.result;
                    if (project) {
                        // Update the project
                        project.projectName = newName;
                        project.projectNumber = newNumber;
                        project.lastModified = new Date().toISOString();

                        // Save back to database
                        const updateRequest = objectStore.put(project);

                        updateRequest.onsuccess = () => {
                            addLog(`‚úèÔ∏è Updated: ${newName || newNumber}`);

                            // Update current project if it's the one being edited
                            if (projectBudget.projectId === currentEditProjectId) {
                                projectBudget.projectName = newName;
                                projectBudget.projectNumber = newNumber;

                                // Update dropdown button text
                                const currentProjectNameElement = document.getElementById('currentProjectName');
                                if (currentProjectNameElement) {
                                    currentProjectNameElement.textContent = newName || newNumber || `Project ${currentEditProjectId}`;
                                }
                            }

                            // Close modal
                            closeProjectEditModal();

                            // Refresh the dropdown list
                            listSavedProjects();
                        };

                        updateRequest.onerror = () => {
                            addLog(`‚ùå Update failed: ${updateRequest.error}`);
                            alert('Failed to update project: ' + updateRequest.error);
                        };
                    } else {
                        addLog('‚ùå Project not found');
                        alert('Project not found in database');
                    }
                };

                getRequest.onerror = () => {
                    addLog(`‚ùå Failed to load project: ${getRequest.error}`);
                    alert('Failed to load project: ' + getRequest.error);
                };
            } catch (error) {
                console.error('Error saving project edit:', error);
                addLog(`‚ùå Error: ${error.message}`);
                alert('Error saving project: ' + error.message);
            }
        }

        async function deleteProjectFromEdit() {
            if (!currentEditProjectId || !db) {
                addLog('‚ùå Cannot delete: Invalid project or database not initialized');
                return;
            }

            const projectName = document.getElementById('editProjectName').value.trim();
            const confirmMessage = `Are you sure you want to delete "${projectName || 'this project'}"?\n\nThis action cannot be undone.`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // Delete from IndexedDB
                const transaction = db.transaction(['projects'], 'readwrite');
                const objectStore = transaction.objectStore('projects');
                const deleteRequest = objectStore.delete(currentEditProjectId);

                deleteRequest.onsuccess = async () => {
                    addLog(`üóëÔ∏è Deleted from local: ${projectName || 'Project'}`);

                    // Also delete from Supabase (cloud)
                    try {
                        if (typeof supabaseClient !== 'undefined') {
                            const { data: { user } } = await supabaseClient.auth.getUser();
                            if (user) {
                                const { error } = await supabaseClient
                                    .from('grants')
                                    .delete()
                                    .eq('user_id', user.id)
                                    .eq('project_id', String(currentEditProjectId));

                                if (error) {
                                    console.error('‚ùå [DELETE] Supabase delete failed:', error);
                                    addLog(`‚ö†Ô∏è Cloud delete failed: ${error.message}`);
                                } else {
                                    console.log(`‚úÖ [DELETE] Project ${currentEditProjectId} deleted from Supabase`);
                                    addLog(`‚òÅÔ∏è Deleted from cloud: ${projectName || 'Project'}`);
                                }
                            }
                        }
                    } catch (cloudError) {
                        console.error('‚ùå [DELETE] Cloud delete error:', cloudError);
                    }

                    // Close modal
                    closeProjectEditModal();

                    // Clear display if the deleted project was currently loaded
                    if (projectBudget.projectId === currentEditProjectId) {
                        document.getElementById('detailedBudgetResults').classList.remove('show');
                        document.getElementById('detailedBudgetResults').style.display = 'none';
                        projectBudget = {
                            projectName: '',
                            projectNumber: '',
                            projectId: null,
                            fundingBody: 'auto',
                            labour: { items: [], quarterly: [] },
                            overheads: { items: [], quarterly: [] },
                            materials: { items: [], quarterly: [] },
                            capitalUsage: { items: [], quarterly: [] },
                            subcontracting: { items: [], quarterly: [] },
                            travel: { items: [], quarterly: [] },
                            otherCosts: { items: [], quarterly: [] },
                            financeSummary: {},
                            quarterlyBreakdown: []
                        };

                        // Update button text
                        const currentProjectNameElement = document.getElementById('currentProjectName');
                        if (currentProjectNameElement) {
                            currentProjectNameElement.textContent = 'Select Project';
                        }
                    }

                    // Remove from localStorage if it was the last selected project
                    const lastSelectedId = localStorage.getItem('lastSelectedProjectId');
                    if (lastSelectedId && String(lastSelectedId) === String(currentEditProjectId)) {
                        localStorage.removeItem('lastSelectedProjectId');
                    }

                    // Refresh the dropdown list
                    listSavedProjects();
                };

                deleteRequest.onerror = () => {
                    addLog(`‚ùå Delete failed: ${deleteRequest.error}`);
                    alert('Failed to delete project: ' + deleteRequest.error);
                };
            } catch (error) {
                console.error('Error deleting project:', error);
                addLog(`‚ùå Error: ${error.message}`);
                alert('Error deleting project: ' + error.message);
            }
        }

        // ============================================================================
        // CATEGORY MANAGEMENT FUNCTIONS
        // ============================================================================

        let draggedCategoryItem = null;

        // Load categories for the project being edited
        async function loadProjectCategories(projectId) {
            if (!db) {
                console.error('‚ùå Database not initialized');
                return;
            }

            try {
                const transaction = db.transaction(['projects'], 'readonly');
                const objectStore = transaction.objectStore('projects');
                const getRequest = objectStore.get(projectId);

                getRequest.onsuccess = () => {
                    const project = getRequest.result;
                    if (project) {
                        // Get categories or initialize with defaults
                        let categories = project.customCategories || getDefaultCategories(project.fundingBody);
                        renderCategoryList(categories);
                    }
                };

                getRequest.onerror = () => {
                    console.error('Failed to load project categories:', getRequest.error);
                };
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Get default categories based on funding body
        function getDefaultCategories(fundingBody) {
            const isWelshGov = fundingBody === 'Welsh Gov';

            if (isWelshGov) {
                return [
                    { key: 'capitalNonStandard', name: 'Capital - Non Standard Costs' },
                    { key: 'revenueNonStandard', name: 'Revenue - Non Standard Costs' },
                    { key: 'revenueStandard', name: 'Revenue - Standard Costs' },
                    { key: 'itemBreakdownCapital', name: 'Item Breakdown - Capital' },
                    { key: 'itemBreakdownRevenue', name: 'Item Breakdown - Revenue' }
                ];
            } else {
                return [
                    { key: 'labour', name: 'Labour' },
                    { key: 'overheads', name: 'Overheads' },
                    { key: 'materials', name: 'Materials' },
                    { key: 'capitalUsage', name: 'Capital usage' },
                    { key: 'subcontracting', name: 'Subcontracting' },
                    { key: 'travel', name: 'Travel and subsistence' },
                    { key: 'otherCosts', name: 'Other costs' }
                ];
            }
        }

        // Render the category list in the modal
        function renderCategoryList(categories) {
            const categoryList = document.getElementById('categoryList');
            if (!categoryList) return;

            categoryList.innerHTML = '';

            categories.forEach((category, index) => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                categoryItem.draggable = true;
                categoryItem.dataset.index = index;
                categoryItem.dataset.key = category.key;

                categoryItem.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    padding: 10px 12px;
                    background: #f8fafc;
                    border: 2px solid #e2e8f0;
                    border-radius: 6px;
                    cursor: grab;
                    transition: all 0.2s;
                `;

                categoryItem.innerHTML = `
                    <span style="color: #94a3b8; font-size: 1.2em; cursor: grab;">‚ò∞</span>
                    <span style="flex: 1; font-weight: 500; color: #334155;">${category.name}</span>
                    <button onclick="deleteCategory('${category.key}'); event.stopPropagation();" style="background: #ef4444; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: 600;">‚úï</button>
                `;

                // Drag event listeners
                categoryItem.addEventListener('dragstart', handleDragStart);
                categoryItem.addEventListener('dragend', handleDragEnd);
                categoryItem.addEventListener('dragover', handleDragOver);
                categoryItem.addEventListener('drop', handleDrop);
                categoryItem.addEventListener('dragleave', handleDragLeave);

                categoryList.appendChild(categoryItem);
            });
        }

        // Drag and drop event handlers
        function handleDragStart(e) {
            draggedCategoryItem = this;
            this.style.opacity = '0.5';
            this.style.cursor = 'grabbing';
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
            this.style.cursor = 'grab';

            // Remove all drag-over styles
            document.querySelectorAll('.category-item').forEach(item => {
                item.style.borderColor = '#e2e8f0';
                item.style.background = '#f8fafc';
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }

            this.style.borderColor = '#3AAFA9';
            this.style.background = '#e0f7f6';
            e.dataTransfer.dropEffect = 'move';

            return false;
        }

        function handleDragLeave(e) {
            this.style.borderColor = '#e2e8f0';
            this.style.background = '#f8fafc';
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedCategoryItem !== this) {
                const categoryList = document.getElementById('categoryList');
                const allItems = [...categoryList.querySelectorAll('.category-item')];
                const draggedIndex = allItems.indexOf(draggedCategoryItem);
                const targetIndex = allItems.indexOf(this);

                if (draggedIndex < targetIndex) {
                    this.parentNode.insertBefore(draggedCategoryItem, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedCategoryItem, this);
                }

                // Save the new order
                saveCategoryOrder();
            }

            return false;
        }

        // Add a new category
        function addNewCategory() {
            const input = document.getElementById('newCategoryName');
            const categoryName = input.value.trim();

            if (!categoryName) {
                alert('Please enter a category name');
                return;
            }

            // Generate a key from the name (lowercase, no spaces)
            const categoryKey = categoryName.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');

            // Get current categories
            const categoryList = document.getElementById('categoryList');
            const existingKeys = [...categoryList.querySelectorAll('.category-item')].map(item => item.dataset.key);

            // Check for duplicates
            if (existingKeys.includes(categoryKey)) {
                alert('A category with this name already exists');
                return;
            }

            // Get all current categories and add the new one
            const categories = getCurrentCategories();
            categories.push({ key: categoryKey, name: categoryName });

            // Re-render the list
            renderCategoryList(categories);

            // Clear input
            input.value = '';

            // Save to database
            saveCategoryOrder();

            addLog(`‚ûï Added category: ${categoryName}`);
        }

        // Delete a category
        function deleteCategory(categoryKey) {
            if (!confirm('Are you sure you want to delete this category?')) {
                return;
            }

            const categories = getCurrentCategories().filter(cat => cat.key !== categoryKey);
            renderCategoryList(categories);
            saveCategoryOrder();

            addLog(`üóëÔ∏è Deleted category: ${categoryKey}`);
        }

        // ============================================================================
        // DRAG AND DROP REORDERING
        // ============================================================================

        let draggedRow = null;
        let draggedCategoryPath = null;
        let draggedIndex = null;

        /**
         * Initialize drag for a row
         */
        function handleDragStart(e, categoryPath, index) {
            draggedRow = e.target.closest('tr');
            draggedCategoryPath = categoryPath;
            draggedIndex = index;

            draggedRow.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', index);

            console.log(`üîÄ [DRAG] Started dragging item ${index} from ${categoryPath}`);
        }

        /**
         * Handle drag over event
         */
        function handleDragOver(e, categoryPath, index) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            // Only allow reordering within the same category
            if (categoryPath !== draggedCategoryPath) {
                return;
            }

            const row = e.target.closest('tr');
            if (!row || row === draggedRow) return;

            // Clear previous indicators
            document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(el => {
                el.classList.remove('drag-over', 'drag-over-bottom');
            });

            // Determine if dropping above or below
            const rect = row.getBoundingClientRect();
            const midpoint = rect.top + rect.height / 2;

            if (e.clientY < midpoint) {
                row.classList.add('drag-over');
            } else {
                row.classList.add('drag-over-bottom');
            }
        }

        /**
         * Handle drag leave event
         */
        function handleDragLeave(e) {
            const row = e.target.closest('tr');
            if (row) {
                row.classList.remove('drag-over', 'drag-over-bottom');
            }
        }

        /**
         * Handle drop event
         */
        async function handleDrop(e, categoryPath, targetIndex) {
            e.preventDefault();

            // Only allow reordering within the same category
            if (categoryPath !== draggedCategoryPath) {
                console.log('üö´ [DRAG] Cannot move items between different categories');
                return;
            }

            // Clear all indicators
            document.querySelectorAll('.drag-over, .drag-over-bottom, .dragging').forEach(el => {
                el.classList.remove('drag-over', 'drag-over-bottom', 'dragging');
            });

            if (draggedIndex === targetIndex || draggedIndex === null) {
                return;
            }

            // Determine if dropping above or below the target
            const targetRow = e.target.closest('tr');
            const rect = targetRow.getBoundingClientRect();
            const midpoint = rect.top + rect.height / 2;
            const dropBelow = e.clientY > midpoint;

            console.log(`üîÄ [DRAG] Dropping item ${draggedIndex} ${dropBelow ? 'below' : 'above'} item ${targetIndex}`);

            // Reorder the array
            await reorderCategoryItems(categoryPath, draggedIndex, targetIndex, dropBelow);

            // Reset drag state
            draggedRow = null;
            draggedCategoryPath = null;
            draggedIndex = null;
        }

        /**
         * Handle drag end event
         */
        function handleDragEnd(e) {
            // Clear all indicators
            document.querySelectorAll('.drag-over, .drag-over-bottom, .dragging').forEach(el => {
                el.classList.remove('drag-over', 'drag-over-bottom', 'dragging');
            });

            draggedRow = null;
            draggedCategoryPath = null;
            draggedIndex = null;
        }

        /**
         * Reorder items in a category
         */
        async function reorderCategoryItems(categoryPath, fromIndex, toIndex, dropBelow) {
            let itemsArray;

            switch(categoryPath) {
                case 'labour.staff':
                    itemsArray = projectBudget.labour.staff;
                    break;
                case 'materials.items':
                    itemsArray = projectBudget.materials.items;
                    break;
                case 'capitalUsage.items':
                    itemsArray = projectBudget.capitalUsage.items;
                    break;
                case 'subcontracting.contractors':
                    itemsArray = projectBudget.subcontracting.contractors;
                    break;
                case 'travel.trips':
                    itemsArray = projectBudget.travel.trips;
                    break;
                case 'travel.items':
                    itemsArray = projectBudget.travel.items;
                    break;
                case 'otherCosts.items':
                    itemsArray = projectBudget.otherCosts.items;
                    break;
                // Welsh Gov categories
                case 'welshGov.capital.nonStandard':
                    itemsArray = projectBudget.welshGovData?.sections?.capital?.nonStandard;
                    break;
                case 'welshGov.revenue.nonStandard':
                    itemsArray = projectBudget.welshGovData?.sections?.revenue?.nonStandard;
                    break;
                case 'welshGov.revenue.standardCosts':
                    itemsArray = projectBudget.welshGovData?.sections?.revenue?.standardCosts;
                    break;
                default:
                    console.error('Unknown category path for reordering:', categoryPath);
                    return;
            }

            if (!itemsArray || itemsArray.length === 0) {
                console.error('No items array found for:', categoryPath);
                return;
            }

            // Record action for undo
            const previousOrder = [...itemsArray];

            // Remove the item from its original position
            const [movedItem] = itemsArray.splice(fromIndex, 1);

            // Calculate the new position
            let newIndex = toIndex;
            if (fromIndex < toIndex) {
                // Moving down: account for the removed item
                newIndex = dropBelow ? toIndex : toIndex - 1;
            } else {
                // Moving up
                newIndex = dropBelow ? toIndex + 1 : toIndex;
            }

            // Ensure newIndex is within bounds
            newIndex = Math.max(0, Math.min(newIndex, itemsArray.length));

            // Insert at the new position
            itemsArray.splice(newIndex, 0, movedItem);

            console.log(`üîÄ [REORDER] Moved item from index ${fromIndex} to ${newIndex} in ${categoryPath}`);

            // Record action for undo
            const itemDescription = movedItem.role || movedItem.destination || movedItem.item || movedItem.name || movedItem.description || movedItem.itemCode || 'Unknown';
            recordAction(
                'reorder_items',
                categoryPath,
                { previousOrder: previousOrder, categoryPath: categoryPath },
                `Reordered "${itemDescription}" in ${categoryPath.split('.')[0]}`
            );

            // Save to database
            await saveToIndexedDB();
            await saveToSupabase();

            // Re-render the display - use appropriate function based on category
            if (categoryPath.startsWith('welshGov.')) {
                displayWelshGovBudget(projectBudget.welshGovData);
            } else {
                displayDetailedBudget();
            }

            addLog(`üîÄ Reordered items in ${categoryPath}`);
        }

        // ============================================================================
        // UNDO / ACTION HISTORY SYSTEM
        // ============================================================================

        // Action history stack
        const actionHistory = [];
        const MAX_HISTORY_SIZE = 50; // Maximum number of actions to keep

        // Action types
        const ACTION_TYPES = {
            ADD_ITEM: 'add_item',
            DELETE_ITEM: 'delete_item',
            EDIT_ITEM: 'edit_item',
            DELETE_PROJECT: 'delete_project',
            REORDER_ITEMS: 'reorder_items'
        };

        /**
         * Record an action to the history stack
         * @param {string} type - Action type from ACTION_TYPES
         * @param {string} category - Category affected (labour, materials, etc.)
         * @param {object} data - Data needed to undo the action
         * @param {string} description - Human-readable description
         */
        function recordAction(type, category, data, description) {
            const action = {
                id: Date.now(),
                type: type,
                category: category,
                data: JSON.parse(JSON.stringify(data)), // Deep clone
                description: description,
                timestamp: new Date().toISOString(),
                projectId: projectBudget.projectId
            };

            // Add to beginning of array (most recent first)
            actionHistory.unshift(action);

            // Limit history size
            if (actionHistory.length > MAX_HISTORY_SIZE) {
                actionHistory.pop();
            }

            console.log(`üìù [HISTORY] Recorded action: ${description}`, action);

            // Update UI
            updateHistoryUI();
        }

        /**
         * Undo the last action
         */
        async function undoLastAction() {
            if (actionHistory.length === 0) {
                alert('No actions to undo.');
                return;
            }

            const action = actionHistory[0];

            // Verify we're on the same project
            if (action.projectId !== projectBudget.projectId) {
                alert('Cannot undo: Action was performed on a different project.');
                return;
            }

            console.log(`‚Ü∂ [UNDO] Undoing action: ${action.description}`, action);

            try {
                switch (action.type) {
                    case ACTION_TYPES.ADD_ITEM:
                        await undoAddItem(action);
                        break;
                    case ACTION_TYPES.DELETE_ITEM:
                        await undoDeleteItem(action);
                        break;
                    case ACTION_TYPES.EDIT_ITEM:
                        await undoEditItem(action);
                        break;
                    case ACTION_TYPES.DELETE_PROJECT:
                        await undoDeleteProject(action);
                        break;
                    case ACTION_TYPES.REORDER_ITEMS:
                        await undoReorderItems(action);
                        break;
                    default:
                        console.error('Unknown action type:', action.type);
                        alert('Cannot undo this action type.');
                        return;
                }

                // Remove the action from history
                actionHistory.shift();

                // Save changes
                await saveToIndexedDB();
                await saveToSupabase();

                // Refresh display
                displayDetailedBudget();

                // Update UI
                updateHistoryUI();

                addLog(`‚Ü∂ Undone: ${action.description}`);
                alert(`‚úÖ Undone: ${action.description}`);

            } catch (error) {
                console.error('Error undoing action:', error);
                alert('‚ùå Error undoing action: ' + error.message);
            }
        }

        /**
         * Undo an add item action (remove the item)
         */
        async function undoAddItem(action) {
            const { category, data } = action;
            const categoryPath = data.categoryPath || category;

            // Handle Welsh Gov items
            if (categoryPath.startsWith('welshGov.')) {
                const sectionPath = categoryPath.replace('welshGov.', '');
                let itemsArray;
                switch(sectionPath) {
                    case 'capital.nonStandard':
                        itemsArray = projectBudget.welshGovData?.sections?.capital?.nonStandard;
                        break;
                    case 'revenue.nonStandard':
                        itemsArray = projectBudget.welshGovData?.sections?.revenue?.nonStandard;
                        break;
                    case 'revenue.standardCosts':
                        itemsArray = projectBudget.welshGovData?.sections?.revenue?.standardCosts;
                        break;
                    default:
                        console.error('Unknown Welsh Gov section path for undo:', sectionPath);
                        return;
                }
                if (itemsArray) {
                    const index = itemsArray.findIndex(i =>
                        i.itemCode === data.item.itemCode &&
                        i.description === data.item.description
                    );
                    if (index !== -1) {
                        itemsArray.splice(index, 1);
                        updateWelshGovFinanceSummary();
                        displayWelshGovBudget(projectBudget.welshGovData);
                    }
                }
                return;
            }

            if (categoryPath === 'labour.staff' || category === 'labour') {
                // Find and remove the item from labour.staff
                const index = projectBudget.labour.staff.findIndex(s =>
                    s.role === data.item.role &&
                    s.grossCost === data.item.grossCost &&
                    s.days === data.item.days
                );
                if (index !== -1) {
                    projectBudget.labour.staff.splice(index, 1);
                    projectBudget.labour.totalCost = projectBudget.labour.staff.reduce((sum, s) => sum + (s.totalCost || 0), 0);
                }
            } else if (categoryPath === 'travel.items' || category === 'travel') {
                const index = projectBudget.travel.items.findIndex(i =>
                    i.destination === data.item.destination &&
                    i.total === data.item.total
                );
                if (index !== -1) {
                    projectBudget.travel.items.splice(index, 1);
                    projectBudget.travel.totalCost = projectBudget.travel.items.reduce((sum, i) => sum + (i.total || 0), 0);
                }
            } else {
                // Materials, Capital Usage, Subcontracting, Other Costs - extract category from path
                const baseCat = categoryPath.split('.')[0] || category;
                const categoryArray = projectBudget[baseCat]?.items;
                if (categoryArray) {
                    const index = categoryArray.findIndex(i =>
                        i.item === data.item.item &&
                        i.total === data.item.total
                    );
                    if (index !== -1) {
                        categoryArray.splice(index, 1);
                        projectBudget[baseCat].totalCost = categoryArray.reduce((sum, i) => sum + (i.total || 0), 0);
                    }
                }
            }
        }

        /**
         * Undo a delete item action (restore the item)
         */
        async function undoDeleteItem(action) {
            const { category, data } = action;
            const categoryPath = data.categoryPath || category;

            // Handle Welsh Gov items
            if (categoryPath.startsWith('welshGov.')) {
                const sectionPath = data.sectionPath || categoryPath.replace('welshGov.', '');
                let itemsArray;
                switch(sectionPath) {
                    case 'capital.nonStandard':
                        if (!projectBudget.welshGovData.sections.capital.nonStandard) {
                            projectBudget.welshGovData.sections.capital.nonStandard = [];
                        }
                        itemsArray = projectBudget.welshGovData.sections.capital.nonStandard;
                        break;
                    case 'revenue.nonStandard':
                        if (!projectBudget.welshGovData.sections.revenue.nonStandard) {
                            projectBudget.welshGovData.sections.revenue.nonStandard = [];
                        }
                        itemsArray = projectBudget.welshGovData.sections.revenue.nonStandard;
                        break;
                    case 'revenue.standardCosts':
                        if (!projectBudget.welshGovData.sections.revenue.standardCosts) {
                            projectBudget.welshGovData.sections.revenue.standardCosts = [];
                        }
                        itemsArray = projectBudget.welshGovData.sections.revenue.standardCosts;
                        break;
                    case 'itemBreakdown.capital':
                        if (!projectBudget.welshGovData.sections.itemBreakdown.capital) {
                            projectBudget.welshGovData.sections.itemBreakdown.capital = [];
                        }
                        itemsArray = projectBudget.welshGovData.sections.itemBreakdown.capital;
                        break;
                    case 'itemBreakdown.revenue':
                        if (!projectBudget.welshGovData.sections.itemBreakdown.revenue) {
                            projectBudget.welshGovData.sections.itemBreakdown.revenue = [];
                        }
                        itemsArray = projectBudget.welshGovData.sections.itemBreakdown.revenue;
                        break;
                    default:
                        console.error('Unknown Welsh Gov section path for undo:', sectionPath);
                        return;
                }
                if (data.index !== undefined && data.index <= itemsArray.length) {
                    itemsArray.splice(data.index, 0, data.item);
                } else {
                    itemsArray.push(data.item);
                }
                displayWelshGovBudget(projectBudget.welshGovData);
                return;
            }

            // Handle standard categories using categoryPath
            if (categoryPath === 'labour.staff' || category === 'labour') {
                if (!projectBudget.labour.staff) {
                    projectBudget.labour.staff = [];
                }
                // Restore at original index if possible
                if (data.index !== undefined && data.index <= projectBudget.labour.staff.length) {
                    projectBudget.labour.staff.splice(data.index, 0, data.item);
                } else {
                    projectBudget.labour.staff.push(data.item);
                }
                projectBudget.labour.totalCost = projectBudget.labour.staff.reduce((sum, s) => sum + (s.totalCost || 0), 0);
            } else if (categoryPath === 'travel.items' || category === 'travel') {
                if (!projectBudget.travel.items) {
                    projectBudget.travel.items = [];
                }
                if (data.index !== undefined && data.index <= projectBudget.travel.items.length) {
                    projectBudget.travel.items.splice(data.index, 0, data.item);
                } else {
                    projectBudget.travel.items.push(data.item);
                }
                projectBudget.travel.totalCost = projectBudget.travel.items.reduce((sum, i) => sum + (i.total || 0), 0);
            } else {
                // Materials, Capital Usage, Subcontracting, Other Costs - extract category from path
                const baseCat = categoryPath.split('.')[0] || category;
                if (!projectBudget[baseCat]) {
                    projectBudget[baseCat] = { items: [], totalCost: 0 };
                }
                if (!projectBudget[baseCat].items) {
                    projectBudget[baseCat].items = [];
                }
                if (data.index !== undefined && data.index <= projectBudget[baseCat].items.length) {
                    projectBudget[baseCat].items.splice(data.index, 0, data.item);
                } else {
                    projectBudget[baseCat].items.push(data.item);
                }
                projectBudget[baseCat].totalCost = projectBudget[baseCat].items.reduce((sum, i) => sum + (i.total || 0), 0);
            }
        }

        /**
         * Undo an edit item action (restore previous values)
         */
        async function undoEditItem(action) {
            const { category, data } = action;

            if (category === 'labour') {
                if (projectBudget.labour.staff[data.index]) {
                    projectBudget.labour.staff[data.index] = data.previousValue;
                    projectBudget.labour.totalCost = projectBudget.labour.staff.reduce((sum, s) => sum + (s.totalCost || 0), 0);
                }
            } else if (category === 'travel') {
                if (projectBudget.travel.items[data.index]) {
                    projectBudget.travel.items[data.index] = data.previousValue;
                    projectBudget.travel.totalCost = projectBudget.travel.items.reduce((sum, i) => sum + (i.total || 0), 0);
                }
            } else {
                if (projectBudget[category].items[data.index]) {
                    projectBudget[category].items[data.index] = data.previousValue;
                    projectBudget[category].totalCost = projectBudget[category].items.reduce((sum, i) => sum + (i.total || 0), 0);
                }
            }
        }

        /**
         * Undo a delete project action (restore the project)
         */
        async function undoDeleteProject(action) {
            const { data } = action;

            // Restore to IndexedDB
            if (db) {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                await new Promise((resolve, reject) => {
                    const request = objectStore.add(data.project);
                    request.onsuccess = resolve;
                    request.onerror = () => reject(request.error);
                });
            }

            // Restore to Supabase
            if (typeof supabaseClient !== 'undefined') {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                    await supabaseClient
                        .from('grants')
                        .upsert({
                            user_id: user.id,
                            project_id: String(data.project.projectId),
                            project_data: data.project
                        }, {
                            onConflict: 'user_id,project_id'
                        });
                }
            }

            // Refresh project list
            listSavedProjects();

            addLog(`‚úÖ Restored project: ${data.project.projectName || 'Unnamed'}`);
        }

        /**
         * Undo a reorder items action (restore previous order)
         */
        async function undoReorderItems(action) {
            const { data } = action;
            const categoryPath = data.categoryPath;

            // Restore the previous order
            switch(categoryPath) {
                case 'labour.staff':
                    projectBudget.labour.staff = data.previousOrder;
                    break;
                case 'materials.items':
                    projectBudget.materials.items = data.previousOrder;
                    break;
                case 'capitalUsage.items':
                    projectBudget.capitalUsage.items = data.previousOrder;
                    break;
                case 'subcontracting.contractors':
                    projectBudget.subcontracting.contractors = data.previousOrder;
                    break;
                case 'travel.trips':
                    projectBudget.travel.trips = data.previousOrder;
                    break;
                case 'travel.items':
                    projectBudget.travel.items = data.previousOrder;
                    break;
                case 'otherCosts.items':
                    projectBudget.otherCosts.items = data.previousOrder;
                    break;
                // Welsh Gov categories
                case 'welshGov.capital.nonStandard':
                    if (projectBudget.welshGovData?.sections?.capital) {
                        projectBudget.welshGovData.sections.capital.nonStandard = data.previousOrder;
                    }
                    break;
                case 'welshGov.revenue.nonStandard':
                    if (projectBudget.welshGovData?.sections?.revenue) {
                        projectBudget.welshGovData.sections.revenue.nonStandard = data.previousOrder;
                    }
                    break;
                case 'welshGov.revenue.standardCosts':
                    if (projectBudget.welshGovData?.sections?.revenue) {
                        projectBudget.welshGovData.sections.revenue.standardCosts = data.previousOrder;
                    }
                    break;
                default:
                    console.error('Unknown category path for undo reorder:', categoryPath);
                    return;
            }

            console.log(`‚Ü∂ [UNDO REORDER] Restored previous order for ${categoryPath}`);
        }

        /**
         * Update the history UI (button state, count, list)
         */
        function updateHistoryUI() {
            const undoButton = document.getElementById('undoButton');
            const historyCount = document.getElementById('historyCount');
            const historyList = document.getElementById('historyList');

            // Update undo button state
            if (undoButton) {
                if (actionHistory.length > 0) {
                    undoButton.disabled = false;
                    undoButton.style.background = '#3b82f6';
                    undoButton.style.cursor = 'pointer';
                    undoButton.title = `Undo: ${actionHistory[0].description}`;
                } else {
                    undoButton.disabled = true;
                    undoButton.style.background = '#6b7280';
                    undoButton.style.cursor = 'not-allowed';
                    undoButton.title = 'No actions to undo';
                }
            }

            // Update history count
            if (historyCount) {
                historyCount.textContent = actionHistory.length;
            }

            // Update history list
            if (historyList) {
                if (actionHistory.length === 0) {
                    historyList.innerHTML = '<p style="color: #94a3b8; text-align: center; margin: 20px 0; font-style: italic;">No actions recorded yet</p>';
                } else {
                    let html = '';
                    actionHistory.forEach((action, index) => {
                        const timeAgo = getTimeAgo(new Date(action.timestamp));
                        const icon = getActionIcon(action.type);
                        const isFirst = index === 0;

                        html += `
                            <div style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border-bottom: 1px solid #f1f5f9; ${isFirst ? 'background: #fffbeb;' : ''}">
                                <span style="font-size: 1.2em;">${icon}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #334155; font-size: 0.9em;">${action.description}</div>
                                    <div style="font-size: 0.75em; color: #94a3b8;">${timeAgo}</div>
                                </div>
                                ${isFirst ? `
                                    <button onclick="undoLastAction()" style="background: #3b82f6; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75em; font-weight: 500;">
                                        ‚Ü∂ Undo
                                    </button>
                                ` : ''}
                            </div>
                        `;
                    });
                    historyList.innerHTML = html;
                }
            }
        }

        /**
         * Get an icon for an action type
         */
        function getActionIcon(type) {
            switch (type) {
                case ACTION_TYPES.ADD_ITEM: return '‚ûï';
                case ACTION_TYPES.DELETE_ITEM: return 'üóëÔ∏è';
                case ACTION_TYPES.EDIT_ITEM: return '‚úèÔ∏è';
                case ACTION_TYPES.DELETE_PROJECT: return 'üìÅ';
                default: return 'üìù';
            }
        }

        /**
         * Get human-readable time ago string
         */
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} min ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            return `${Math.floor(seconds / 86400)} days ago`;
        }

        /**
         * Toggle the history panel visibility
         */
        function toggleHistoryPanel() {
            const panel = document.getElementById('historyPanel');
            if (panel) {
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
        }

        /**
         * Clear all action history
         */
        function clearHistory() {
            if (actionHistory.length === 0) {
                alert('History is already empty.');
                return;
            }

            if (confirm(`Are you sure you want to clear all ${actionHistory.length} action(s) from history?\n\nThis cannot be undone.`)) {
                actionHistory.length = 0;
                updateHistoryUI();
                addLog('üóëÔ∏è Action history cleared');
            }
        }

        // Keyboard shortcut for undo (Ctrl+Z)
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                // Only trigger if not in an input field
                if (!['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) {
                    e.preventDefault();
                    if (actionHistory.length > 0) {
                        undoLastAction();
                    }
                }
            }
        });

        // ============================================================================
        // ADD ITEM MODAL FUNCTIONS
        // ============================================================================

        // Open the Add Item modal (optionally pre-select a category)
        function openAddItemModal(preselectedCategory = null) {
            console.log(`üîì [ADD ITEM] Opening modal with preselectedCategory="${preselectedCategory}"`);
            console.log(`üîç [ADD ITEM] projectBudget.projectId = ${projectBudget?.projectId || 'UNDEFINED'}`);
            console.log(`üîç [ADD ITEM] projectBudget exists:`, !!projectBudget);

            if (!projectBudget.projectId) {
                console.error('‚ùå [ADD ITEM] No projectId found - cannot add items');
                alert('Please load or create a project first.');
                return;
            }

            console.log('‚úÖ [ADD ITEM] ProjectId exists, opening modal...');

            // Reset form
            document.getElementById('addItemCategory').value = '';
            document.getElementById('addItemStep2').style.display = 'none';
            document.getElementById('saveNewItemBtn').style.display = 'none';

            // Hide all field sections
            document.getElementById('labourFields').style.display = 'none';
            document.getElementById('genericItemFields').style.display = 'none';
            document.getElementById('travelFields').style.display = 'none';

            // Clear all inputs
            clearAddItemInputs();

            // If a category is pre-selected, set it and show fields
            if (preselectedCategory) {
                console.log(`üìã [ADD ITEM] Pre-selecting category: ${preselectedCategory}`);
                document.getElementById('addItemCategory').value = preselectedCategory;
                showAddItemFields();
            }

            // Show modal
            console.log('üé¨ [ADD ITEM] Setting modal display to flex...');
            const modal = document.getElementById('addItemModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('‚úÖ [ADD ITEM] Modal is now visible');
            } else {
                console.error('‚ùå [ADD ITEM] Modal element #addItemModal not found!');
            }
        }

        // Close the Add Item modal
        function closeAddItemModal() {
            document.getElementById('addItemModal').style.display = 'none';
        }

        // ============================================================================
        // WELSH GOV ADD ITEM MODAL FUNCTIONS
        // ============================================================================

        // Open the Welsh Gov Add Item modal
        function openAddWelshGovItemModal(preselectedCategory = null) {
            if (!projectBudget.welshGovData) {
                alert('This feature is only available for Welsh Gov grants.');
                return;
            }

            // Reset form
            document.getElementById('addWelshGovItemCode').value = '';
            document.getElementById('addWelshGovDescription').value = '';
            document.getElementById('addWelshGovTotalCost').value = '';
            document.getElementById('addWelshGovGrantRate').value = projectBudget.welshGovData.financeSummary.fundingLevel || 80;
            document.getElementById('addWelshGovMaxGrant').textContent = '¬£0';

            // Pre-select category if provided
            if (preselectedCategory) {
                document.getElementById('addWelshGovCategory').value = preselectedCategory;
            }

            // Show modal
            document.getElementById('addWelshGovItemModal').style.display = 'flex';
        }

        // Close the Welsh Gov Add Item modal
        function closeAddWelshGovItemModal() {
            document.getElementById('addWelshGovItemModal').style.display = 'none';
        }

        // Update the max grant value display
        function updateWelshGovMaxGrant() {
            const totalCost = parseFloat(document.getElementById('addWelshGovTotalCost').value) || 0;
            const grantRate = parseFloat(document.getElementById('addWelshGovGrantRate').value) || 0;
            const maxGrant = (totalCost * grantRate / 100).toFixed(2);
            document.getElementById('addWelshGovMaxGrant').textContent = '¬£' + parseFloat(maxGrant).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        // Save a new Welsh Gov item
        async function saveNewWelshGovItem() {
            const category = document.getElementById('addWelshGovCategory').value;
            const itemCode = document.getElementById('addWelshGovItemCode').value.trim();
            const description = document.getElementById('addWelshGovDescription').value.trim();
            const totalCost = parseFloat(document.getElementById('addWelshGovTotalCost').value) || 0;
            const grantRate = parseFloat(document.getElementById('addWelshGovGrantRate').value) || 80;
            const maxGrantValue = totalCost * grantRate / 100;

            // Validation
            if (!itemCode) {
                alert('Please enter an item code.');
                return;
            }
            if (!description) {
                alert('Please enter a description.');
                return;
            }
            if (totalCost <= 0) {
                alert('Please enter a valid total cost.');
                return;
            }

            // Create the new item
            const newItem = {
                itemCode: itemCode,
                description: description,
                totalCost: totalCost,
                grantRate: grantRate,
                maxGrantValue: maxGrantValue,
                quarterlyCosts: { q1: 0, q2: 0, q3: 0, q4: 0 }
            };

            // Add to the appropriate array
            let itemsArray;
            let categoryName;
            switch(category) {
                case 'capital.nonStandard':
                    if (!projectBudget.welshGovData.sections.capital.nonStandard) {
                        projectBudget.welshGovData.sections.capital.nonStandard = [];
                    }
                    itemsArray = projectBudget.welshGovData.sections.capital.nonStandard;
                    categoryName = 'Capital Non-Standard';
                    break;
                case 'revenue.nonStandard':
                    if (!projectBudget.welshGovData.sections.revenue.nonStandard) {
                        projectBudget.welshGovData.sections.revenue.nonStandard = [];
                    }
                    itemsArray = projectBudget.welshGovData.sections.revenue.nonStandard;
                    categoryName = 'Revenue Non-Standard';
                    break;
                case 'revenue.standardCosts':
                    if (!projectBudget.welshGovData.sections.revenue.standardCosts) {
                        projectBudget.welshGovData.sections.revenue.standardCosts = [];
                    }
                    itemsArray = projectBudget.welshGovData.sections.revenue.standardCosts;
                    categoryName = 'Revenue Standard Costs';
                    break;
                default:
                    alert('Unknown category: ' + category);
                    return;
            }

            itemsArray.push(newItem);

            // Record action for undo
            recordAction(
                ACTION_TYPES.ADD_ITEM,
                'welshGov.' + category,
                { item: newItem, categoryPath: 'welshGov.' + category },
                `Added "${itemCode}" to ${categoryName}`
            );

            // Update finance summary totals
            updateWelshGovFinanceSummary();

            // Save to IndexedDB
            await saveToIndexedDB();

            // Save to Supabase
            await saveToSupabase();

            // Close modal
            closeAddWelshGovItemModal();

            // Refresh display
            displayWelshGovBudget(projectBudget.welshGovData);

            // Log and notify
            addLog(`‚ûï Added Welsh Gov item: ${itemCode} to ${categoryName}`);
        }

        // Update Welsh Gov finance summary totals after adding/removing items
        function updateWelshGovFinanceSummary() {
            if (!projectBudget.welshGovData || !projectBudget.welshGovData.sections) return;

            const sections = projectBudget.welshGovData.sections;

            // Calculate capital total
            let capitalTotal = 0;
            if (sections.capital && sections.capital.nonStandard) {
                capitalTotal = sections.capital.nonStandard.reduce((sum, item) => sum + (item.maxGrantValue || 0), 0);
            }

            // Calculate revenue total
            let revenueTotal = 0;
            if (sections.revenue) {
                if (sections.revenue.nonStandard) {
                    revenueTotal += sections.revenue.nonStandard.reduce((sum, item) => sum + (item.maxGrantValue || 0), 0);
                }
                if (sections.revenue.standardCosts) {
                    revenueTotal += sections.revenue.standardCosts.reduce((sum, item) => sum + (item.maxGrantValue || 0), 0);
                }
            }

            // Update finance summary
            projectBudget.welshGovData.financeSummary.capitalTotal = capitalTotal;
            projectBudget.welshGovData.financeSummary.revenueTotal = revenueTotal;
            projectBudget.welshGovData.financeSummary.totalCosts = capitalTotal + revenueTotal;
        }

        // Clear all input fields in the Add Item modal
        function clearAddItemInputs() {
            // Labour fields
            document.getElementById('addLabourRole').value = '';
            document.getElementById('addLabourGrossCost').value = '';
            document.getElementById('addLabourDays').value = '';

            // Generic item fields
            document.getElementById('addItemDescription').value = '';
            document.getElementById('addItemQuantity').value = '1';
            document.getElementById('addItemCostPerItem').value = '';

            // Travel fields
            document.getElementById('addTravelDescription').value = '';
            document.getElementById('addTravelTrips').value = '1';
            document.getElementById('addTravelCostPerTrip').value = '';
            document.getElementById('addTravelSubsistence').value = '';
        }

        // Show fields based on selected category
        function showAddItemFields() {
            const category = document.getElementById('addItemCategory').value;
            console.log(`üìù [ADD ITEM FIELDS] Category selected: "${category}"`);

            // Hide all field sections first
            document.getElementById('labourFields').style.display = 'none';
            document.getElementById('genericItemFields').style.display = 'none';
            document.getElementById('travelFields').style.display = 'none';

            if (!category) {
                console.log('‚ö†Ô∏è [ADD ITEM FIELDS] No category selected, hiding fields');
                document.getElementById('addItemStep2').style.display = 'none';
                document.getElementById('saveNewItemBtn').style.display = 'none';
                return;
            }

            // Show step 2 and save button
            document.getElementById('addItemStep2').style.display = 'block';
            document.getElementById('saveNewItemBtn').style.display = 'inline-block';

            // Show appropriate fields based on category
            if (category === 'labour') {
                console.log('üë∑ [ADD ITEM FIELDS] Showing labour fields');
                document.getElementById('labourFields').style.display = 'block';
            } else if (category === 'travel') {
                console.log('‚úàÔ∏è [ADD ITEM FIELDS] Showing travel fields');
                document.getElementById('travelFields').style.display = 'block';
                setupTravelCalculation();
            } else {
                // Materials, Capital Usage, Subcontracting, Other Costs
                console.log(`üì¶ [ADD ITEM FIELDS] Showing generic item fields for category: ${category}`);
                document.getElementById('genericItemFields').style.display = 'block';
                setupGenericCalculation();
            }
        }

        // Setup live calculation for generic items
        function setupGenericCalculation() {
            const quantityInput = document.getElementById('addItemQuantity');
            const costInput = document.getElementById('addItemCostPerItem');
            const totalSpan = document.getElementById('addItemTotal');

            const updateTotal = () => {
                const quantity = parseFloat(quantityInput.value) || 0;
                const costPerItem = parseFloat(costInput.value) || 0;
                const total = quantity * costPerItem;
                totalSpan.textContent = '¬£' + total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            };

            quantityInput.addEventListener('input', updateTotal);
            costInput.addEventListener('input', updateTotal);
        }

        // Setup live calculation for travel items
        function setupTravelCalculation() {
            const tripsInput = document.getElementById('addTravelTrips');
            const costPerTripInput = document.getElementById('addTravelCostPerTrip');
            const subsistenceInput = document.getElementById('addTravelSubsistence');
            const totalSpan = document.getElementById('addTravelTotal');

            const updateTotal = () => {
                const trips = parseFloat(tripsInput.value) || 0;
                const costPerTrip = parseFloat(costPerTripInput.value) || 0;
                const subsistence = parseFloat(subsistenceInput.value) || 0;
                const total = trips * (costPerTrip + subsistence);
                totalSpan.textContent = '¬£' + total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            };

            tripsInput.addEventListener('input', updateTotal);
            costPerTripInput.addEventListener('input', updateTotal);
            subsistenceInput.addEventListener('input', updateTotal);
        }

        // Save the new item
        async function saveNewItem() {
            const category = document.getElementById('addItemCategory').value;

            if (!category) {
                alert('Please select a category.');
                return;
            }

            let newItem = null;
            let categoryName = '';

            try {
                if (category === 'labour') {
                    const role = document.getElementById('addLabourRole').value.trim();
                    const grossCost = parseFloat(document.getElementById('addLabourGrossCost').value) || 0;
                    const days = parseFloat(document.getElementById('addLabourDays').value) || 0;

                    if (!role) {
                        alert('Please enter a role/position.');
                        return;
                    }

                    const ratePerDay = days > 0 ? grossCost / days : 0;
                    const totalCost = grossCost;

                    newItem = {
                        role: role,
                        grossCost: grossCost,
                        ratePerDay: ratePerDay,
                        days: days,
                        totalCost: totalCost,
                        quarterlyCosts: {}
                    };

                    // Add to labour staff array
                    if (!projectBudget.labour.staff) {
                        projectBudget.labour.staff = [];
                    }
                    projectBudget.labour.staff.push(newItem);

                    // Update total
                    projectBudget.labour.totalCost = projectBudget.labour.staff.reduce((sum, s) => sum + (s.totalCost || 0), 0);

                    categoryName = 'Labour';

                } else if (category === 'travel') {
                    const description = document.getElementById('addTravelDescription').value.trim();
                    const trips = parseInt(document.getElementById('addTravelTrips').value) || 1;
                    const costPerTrip = parseFloat(document.getElementById('addTravelCostPerTrip').value) || 0;
                    const subsistence = parseFloat(document.getElementById('addTravelSubsistence').value) || 0;

                    if (!description) {
                        alert('Please enter a description.');
                        return;
                    }

                    const totalTravel = trips * costPerTrip;
                    const totalSubsistence = trips * subsistence;
                    const total = totalTravel + totalSubsistence;

                    newItem = {
                        destination: description,
                        trips: trips,
                        travelCostPerTrip: costPerTrip,
                        subsistencePerTrip: subsistence,
                        totalTravel: totalTravel,
                        totalSubsistence: totalSubsistence,
                        total: total,
                        quarterlyCosts: {}
                    };

                    // Add to travel trips array
                    if (!projectBudget.travel.trips) {
                        projectBudget.travel.trips = [];
                    }
                    projectBudget.travel.trips.push(newItem);

                    // Update total
                    projectBudget.travel.totalCost = projectBudget.travel.trips.reduce((sum, i) => sum + (i.total || 0), 0);

                    categoryName = 'Travel';

                } else {
                    // Materials, Capital Usage, Subcontracting, Other Costs
                    const description = document.getElementById('addItemDescription').value.trim();
                    const quantity = parseInt(document.getElementById('addItemQuantity').value) || 1;
                    const costPerItem = parseFloat(document.getElementById('addItemCostPerItem').value) || 0;

                    if (!description) {
                        alert('Please enter a description.');
                        return;
                    }

                    const total = quantity * costPerItem;

                    newItem = {
                        item: description,
                        quantity: quantity,
                        costPerItem: costPerItem,
                        total: total,
                        quarterlyCosts: {}
                    };

                    // Determine which array to add to
                    const categoryMap = {
                        'materials': { array: 'materials', property: 'items', name: 'Materials' },
                        'capitalUsage': { array: 'capitalUsage', property: 'items', name: 'Capital Usage' },
                        'subcontracting': { array: 'subcontracting', property: 'contractors', name: 'Subcontracting' },
                        'otherCosts': { array: 'otherCosts', property: 'items', name: 'Other Costs' }
                    };

                    const catInfo = categoryMap[category];
                    if (catInfo) {
                        const propertyName = catInfo.property;
                        if (!projectBudget[catInfo.array][propertyName]) {
                            projectBudget[catInfo.array][propertyName] = [];
                        }
                        projectBudget[catInfo.array][propertyName].push(newItem);

                        // Update total
                        projectBudget[catInfo.array].totalCost = projectBudget[catInfo.array][propertyName].reduce((sum, i) => sum + (i.total || 0), 0);

                        categoryName = catInfo.name;
                    }
                }

                // Determine the category path for undo
                const categoryPathMap = {
                    'labour': 'labour.staff',
                    'travel': 'travel.trips',
                    'materials': 'materials.items',
                    'capitalUsage': 'capitalUsage.items',
                    'subcontracting': 'subcontracting.contractors',
                    'otherCosts': 'otherCosts.items'
                };
                const categoryPath = categoryPathMap[category] || category;

                // Record action for undo
                const itemDescription = newItem.role || newItem.destination || newItem.item || 'Unknown';
                recordAction(
                    ACTION_TYPES.ADD_ITEM,
                    categoryPath,
                    { item: newItem, categoryPath: categoryPath },
                    `Added "${itemDescription}" to ${categoryName}`
                );

                // Save to IndexedDB
                await saveToIndexedDB();

                // Save to Supabase
                await saveToSupabase();

                // Close modal
                closeAddItemModal();

                // Refresh display
                displayDetailedBudget();

                // Log and notify
                addLog(`‚ûï Added item to ${categoryName}: ${newItem.role || newItem.destination || newItem.item}`);
                alert(`‚úÖ Item added to ${categoryName} successfully!`);

            } catch (error) {
                console.error('Error adding item:', error);
                alert('‚ùå Error adding item: ' + error.message);
            }
        }

        // Show the Add Item button when a project is loaded
        function showAddItemButton() {
            const container = document.getElementById('addItemButtonContainer');
            if (container) {
                container.style.display = 'block';
            }
        }

        // Hide the Add Item button
        function hideAddItemButton() {
            const container = document.getElementById('addItemButtonContainer');
            if (container) {
                container.style.display = 'none';
            }
        }

        // Get current categories from the UI
        function getCurrentCategories() {
            const categoryList = document.getElementById('categoryList');
            const categoryItems = categoryList.querySelectorAll('.category-item');

            return [...categoryItems].map(item => ({
                key: item.dataset.key,
                name: item.querySelector('span:nth-child(2)').textContent
            }));
        }

        // Save category order to database
        async function saveCategoryOrder() {
            if (!currentEditProjectId || !db) return;

            const categories = getCurrentCategories();

            try {
                const transaction = db.transaction(['projects'], 'readwrite');
                const objectStore = transaction.objectStore('projects');
                const getRequest = objectStore.get(currentEditProjectId);

                getRequest.onsuccess = () => {
                    const project = getRequest.result;
                    if (project) {
                        project.customCategories = categories;
                        project.lastModified = new Date().toISOString();

                        const updateRequest = objectStore.put(project);

                        updateRequest.onsuccess = () => {
                            // Update projectBudget if it's the current project
                            if (projectBudget.projectId === currentEditProjectId) {
                                projectBudget.customCategories = categories;
                                // Refresh the display to show new category order
                                displayDetailedBudget();
                            }
                        };
                    }
                };
            } catch (error) {
                console.error('Error saving category order:', error);
            }
        }

        // ============================================================================
        // END CATEGORY MANAGEMENT FUNCTIONS
        // ============================================================================

        function exportProjectJSON() {
            console.log('üîç exportProjectJSON() called');
            console.log('projectBudget.projectName:', projectBudget.projectName);
            console.log('projectBudget.projectNumber:', projectBudget.projectNumber);
            console.log('Full projectBudget:', projectBudget);

            if (!projectBudget.projectName && !projectBudget.projectNumber) {
                console.error('‚ùå Export failed: No project name or number');
                addLog('‚ùå Export failed: No project name or number found');
                alert('No project data to export. Please parse a budget first.');
                return;
            }

            addLog(`üì• Exporting project: ${projectBudget.projectName || projectBudget.projectNumber}`);
            const json = JSON.stringify(projectBudget, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fileName = projectBudget.projectNumber || projectBudget.projectName || 'project-budget';
            a.download = `${fileName.replace(/[^a-z0-9]/gi, '_')}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            addLog(`üì• Exported project: ${fileName}`);
        }

        function loadProjectJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const loadedProject = JSON.parse(e.target.result);

                    // Validate structure
                    if (!loadedProject.financeSummary || !loadedProject.labour) {
                        throw new Error('Invalid project budget file format');
                    }

                    // Remove projectId so it gets a new one when saved
                    loadedProject.projectId = null;
                    projectBudget = loadedProject;

                    addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    addLog('üìÇ Loaded project budget from JSON file');
                    addLog(`Project: ${projectBudget.projectName || projectBudget.projectNumber || 'Unnamed'}`);
                    addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                    await displayDetailedBudget();
                    document.getElementById('detailedBudgetResults').classList.add('show');

                    // Auto-save to IndexedDB
                    saveToIndexedDB();
                } catch (error) {
                    addLog(`‚ùå Failed to load project: ${error.message}`);
                    alert('Failed to load project budget. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        function toggleLog() {
            const content = document.getElementById('logContent');
            const chevron = document.getElementById('logChevron');
            content.classList.toggle('open');
            chevron.classList.toggle('open');
        }

        // Parse Budget Section Toggle
        function toggleParseBudgetSection() {
            const content = document.getElementById('parseBudgetSection');
            const chevron = document.getElementById('parseSectionChevron');
            content.classList.toggle('open');
            chevron.classList.toggle('open');
        }

        // Funding Body Selector Functions
        let selectedFundingBody = 'auto'; // Default to auto-detect

        function toggleFundingBodyDropdown() {
            const dropdown = document.getElementById('fundingBodyDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        function selectFundingBody(value, icon, label) {
            selectedFundingBody = value;
            document.getElementById('fundingBodyIcon').textContent = icon;
            document.getElementById('fundingBodyBtn').setAttribute('title', label);
            document.getElementById('fundingBodyDropdown').style.display = 'none';
            console.log(`Selected funding body: ${label} (${value})`);
        }

        // Close funding body dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const fundingDropdown = document.getElementById('fundingBodyDropdown');
            const fundingBtn = document.getElementById('fundingBodyBtn');
            if (fundingDropdown && fundingBtn && !fundingDropdown.contains(event.target) && !fundingBtn.contains(event.target)) {
                fundingDropdown.style.display = 'none';
            }
        });

        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logs.push(logMessage);

            // Also log to console for debugging
            console.log(logMessage);

            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = logs.map(log =>
                `<div class="log-entry">${log}</div>`
            ).join('');

            document.getElementById('logCount').textContent = `${logs.length} entries`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // AI Prompts for Parallel Section Parsing
        const AI_PROMPTS = {
            financeSummary: `Extract ONLY the Finance Summary section from the grant budget text.

Return a JSON object with these exact fields:
{
    "projectDuration": "12 months",
    "totalCosts": 91621,
    "fundingLevel": 100,
    "fundingSought": 91621,
    "otherPublicFunding": 0,
    "contribution": 0
}

Rules:
- Extract all numbers as numeric values (not strings)
- Remove all currency symbols and commas
- If a field is not found, use 0 or empty string
- Return ONLY valid JSON, no markdown`,

            labour: `Extract ONLY the Labour section from the grant budget text.

Return a JSON object with these exact fields:
{
    "workingDaysPerYear": 232,
    "hasPAYE": true,
    "staff": [
        {
            "role": "Project Manager",
            "grossCost": 40000,
            "ratePerDay": 172,
            "days": 60,
            "totalCost": 10345
        }
    ],
    "totalCost": 39612
}

Rules:
- Extract each staff member with their role, costs, rates, and days
- Remove all currency symbols and commas
- Calculate totalCost as sum of all staff costs
- Return ONLY valid JSON, no markdown`,

            overheads: `Extract ONLY the Overhead costs section from the grant budget text.

Return a JSON object with these exact fields:
{
    "percentage": 20,
    "labourCosts": 39612,
    "totalCost": 7922
}

Rules:
- Extract the percentage (typically 20%)
- Extract base labour costs and total overhead costs
- Return ONLY valid JSON, no markdown`,

            materials: `Extract ONLY the Materials section from the grant budget text.

Return a JSON object with these exact fields:
{
    "items": [
        {
            "item": "Acoustic imaging probes",
            "quantity": 2,
            "costPerItem": 2000,
            "total": 4000
        }
    ],
    "totalCost": 8050
}

Rules:
- Extract each material item with quantity and costs
- Remove all currency symbols and commas
- Calculate totalCost as sum of all items
- Return ONLY valid JSON, no markdown`,

            capitalSubcontracting: `Extract Capital Usage AND Subcontracting sections from the grant budget text.

Return a JSON object with these exact fields:
{
    "capitalUsage": {
        "items": [
            {
                "description": "Item name",
                "newOrExisting": "New",
                "depreciationPeriod": 12,
                "netPresentValue": 0,
                "residualValue": 0,
                "utilisation": 100,
                "netCost": 0
            }
        ],
        "totalCost": 0
    },
    "subcontracting": {
        "contractors": [
            {
                "name": "Oxalid Design Ltd",
                "country": "UK",
                "role": "Design of custom PCB...",
                "cost": 16000
            }
        ],
        "totalCost": 30400
    }
}

Rules:
- Extract both sections in one response
- Remove all currency symbols and commas
- Preserve full role descriptions for subcontractors
- Return ONLY valid JSON, no markdown`,

            travelOther: `Extract Travel/Subsistence AND Other Costs sections from the grant budget text.

Return a JSON object with these exact fields:
{
    "travel": {
        "trips": [
            {
                "purpose": "Travel to visit subcontractor Ecodetect",
                "numberOfTimes": 4,
                "costEach": 250,
                "total": 1000
            }
        ],
        "totalCost": 3000
    },
    "otherCosts": {
        "items": [
            {
                "description": "Cloud compute for training model",
                "estimatedCost": 500
            }
        ],
        "totalCost": 2637
    }
}

Rules:
- Extract both sections in one response
- Remove all currency symbols and commas
- Preserve full descriptions
- Return ONLY valid JSON, no markdown`
        };

        // Parse individual section using AI
        async function parseSection(sectionName, inputText) {
            addLog(`üîÑ Parsing ${sectionName}...`);
            console.log(`Parsing section: ${sectionName}`);

            try {
                const apiKey = getAPIKey();
                if (!apiKey) {
                    throw new Error('OpenAI API key not configured. Please set it in the settings.');
                }

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [{
                            role: 'system',
                            content: 'You are a budget parsing expert. Extract data into clean JSON format with precise field extraction.'
                        }, {
                            role: 'user',
                            content: AI_PROMPTS[sectionName] + '\n\n' + inputText
                        }],
                        temperature: 0.1,
                        max_tokens: 2048
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API request failed: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                let responseText = data.choices[0].message.content.trim();

                // Clean markdown formatting if present
                if (responseText.startsWith('```json')) {
                    responseText = responseText.replace(/^```json\n?/, '').replace(/\n?```$/, '');
                } else if (responseText.startsWith('```')) {
                    responseText = responseText.replace(/^```\n?/, '').replace(/\n?```$/, '');
                }

                const parsed = JSON.parse(responseText);
                addLog(`‚úÖ ${sectionName} parsed successfully`);
                console.log(`${sectionName} result:`, parsed);

                return { section: sectionName, data: parsed };
            } catch (error) {
                console.error(`Error parsing ${sectionName}:`, error);
                addLog(`‚ùå ${sectionName} parsing failed: ${error.message}`);
                throw error;
            }
        }

        // Display Welsh Gov Budget
        function displayWelshGovBudget(welshGovData) {
            console.log('displayWelshGovBudget called with:', welshGovData);
            const { sections, financeSummary } = welshGovData;
            console.log('sections:', sections);
            console.log('financeSummary:', financeSummary);

            // Clear ALL previous IUK budget sections (with null checks)
            const iukSections = ['labourSection', 'overheadsSection', 'materialsSection', 'capitalSection', 'subcontractingSection', 'travelSection', 'otherCostsSection', 'overheadsMaterialsSection', 'capitalSubcontractingSection', 'travelOtherSection'];
            iukSections.forEach(sectionId => {
                const element = document.getElementById(sectionId);
                if (element) element.innerHTML = '';
            });

            // Update project name inputs
            const projectNameInput = document.getElementById('projectNameInput');
            const projectNumberInput = document.getElementById('projectNumberInput');
            if (projectNameInput) projectNameInput.value = projectBudget.projectName || 'Welsh Gov Grant';
            if (projectNumberInput) projectNumberInput.value = projectBudget.projectNumber || '';

            // Calculate quarters once for all sections
            const quarters = calculateQuarters();
            const hasQuarters = quarters.length > 0;
            const currentQuarter = getCurrentQuarter();

            // Build finance summary section with compact design
            const fs = projectBudget.financeSummary;
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
            const monthOptions = months.map((m, i) =>
                `<option value="${i+1}" ${fs.projectStartMonth === i+1 ? 'selected' : ''}>${m}</option>`
            ).join('');

            const currentYear = new Date().getFullYear();
            const yearOptions = [];
            for (let y = currentYear - 5; y <= currentYear + 5; y++) {
                yearOptions.push(`<option value="${y}" ${fs.projectStartYear === y ? 'selected' : ''}>${y}</option>`);
            }

            let financeHTML = `
                <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 15px 0; font-size: 1.1em; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.2em;">üí∞</span>
                        Finance Summary - Welsh Gov
                    </h3>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px;">
                        <div style="background: #f0fdfa; padding: 12px; border-radius: 6px; border-left: 3px solid #14b8a6;">
                            <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Total Grant Approved</div>
                            <div style="font-size: 1.1em; font-weight: 600; color: #1e293b;">¬£${financeSummary.totalCosts.toLocaleString()}</div>
                        </div>

                        <div style="background: #f0fdfa; padding: 12px; border-radius: 6px; border-left: 3px solid #06b6d4;">
                            <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Total Project Costs</div>
                            <div style="font-size: 1.1em; font-weight: 600; color: #1e293b;">¬£${financeSummary.totalProjectCosts.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        </div>

                        <div style="background: #f0fdfa; padding: 12px; border-radius: 6px; border-left: 3px solid #0891b2;">
                            <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Capital Total</div>
                            <div style="font-size: 1.1em; font-weight: 600; color: #1e293b;">¬£${financeSummary.capitalTotal.toLocaleString()}</div>
                        </div>

                        <div style="background: #f0fdfa; padding: 12px; border-radius: 6px; border-left: 3px solid #0e7490;">
                            <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Revenue Total</div>
                            <div style="font-size: 1.1em; font-weight: 600; color: #1e293b;">¬£${financeSummary.revenueTotal.toLocaleString()}</div>
                        </div>

                        <div style="background: #f0fdfa; padding: 12px; border-radius: 6px; border-left: 3px solid #155e75;">
                            <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Grant Rate</div>
                            <div style="font-size: 1.1em; font-weight: 600; color: #1e293b;">${financeSummary.fundingLevel}%</div>
                            <div style="font-size: 0.7em; color: #94a3b8; margin-top: 2px;">No overhead calculations</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 12px; align-items: center; padding: 12px; background: #f8fafc; border-radius: 6px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.85em; color: #64748b; font-weight: 500; white-space: nowrap;">Project Start:</label>
                            <select id="projectStartMonth" onchange="updateProjectStartDate()" style="padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.9em; background: white;">
                                <option value="">Month</option>
                                ${monthOptions}
                            </select>
                            <select id="projectStartYear" onchange="updateProjectStartDate()" style="padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.9em; background: white;">
                                <option value="">Year</option>
                                ${yearOptions.join('')}
                            </select>
                        </div>

                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 0.85em; color: #64748b; font-weight: 500; white-space: nowrap;">Duration:</label>
                            <input type="number" id="projectDurationMonths" value="${fs.projectDurationMonths || ''}"
                                   min="1" max="120" onchange="updateProjectDuration()"
                                   style="width: 70px; padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.9em;"
                                   placeholder="12">
                            <span style="font-size: 0.85em;">months</span>
                            ${fs.projectStartMonth && fs.projectDurationMonths ?
                                `<span style="color: #64748b; font-size: 0.85em;">(Ends: ${calculateEndDate(fs.projectStartMonth, fs.projectStartYear, fs.projectDurationMonths)})</span>` :
                                ''}
                        </div>
                    </div>
                </div>
            `;

            // Add Quarterly Budget Tracking Controls
            if (hasQuarters) {
                financeHTML += `
                    <div style="background: white; border-radius: 8px; padding: 16px; margin-bottom: 15px; border: 1px solid #e2e8f0;">
                        <div onclick="toggleCategorySection('quarterly-tracking-content')" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; cursor: pointer; user-select: none;">
                            <h3 style="margin: 0; font-size: 1em; display: flex; align-items: center; gap: 8px; color: #333;">
                                <span id="quarterly-tracking-arrow" style="display: inline-block; width: 20px;">‚ñ∂</span>
                                <span>üìÖ</span>
                                Quarterly Budget Tracking
                            </h3>
                            ${currentQuarter ? `
                                <span style="background: #e0e7ff; color: #4338ca; padding: 4px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 500;">
                                    Current: Q${currentQuarter}
                                </span>
                            ` : ''}
                        </div>

                        <div id="quarterly-tracking-content" style="display: none;">
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 12px; padding: 12px; background: #f8fafc; border-radius: 6px;">
                            <span style="font-size: 0.85em; color: #475569; font-weight: 500;">Activate Quarter:</span>
                `;

                quarters.forEach(quarter => {
                    const isCurrentQuarter = currentQuarter === quarter.index;
                    const isActive = activeQuarterIndex === quarter.index;

                    financeHTML += `
                        <button
                            class="quarter-activate-btn"
                            data-quarter="${quarter.index}"
                            onclick="setActiveQuarter(${quarter.index})"
                            style="
                                padding: 6px 14px;
                                border-radius: 6px;
                                border: ${isActive ? '2px solid #f59e0b' : (isCurrentQuarter ? '2px solid #3AAFA9' : '1px solid #cbd5e1')};
                                background: ${isActive ? '#f59e0b' : (isCurrentQuarter ? '#3AAFA9' : 'white')};
                                color: ${isActive || isCurrentQuarter ? 'white' : '#475569'};
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.2s;
                                font-size: 0.85em;
                            "
                            onmouseover="if(!${isActive} && !${isCurrentQuarter}) { this.style.background='#f8fafc'; this.style.borderColor='#94a3b8'; }"
                            onmouseout="if(!${isActive}) this.style.background='${isCurrentQuarter ? '#3AAFA9' : 'white'}'; if(!${isActive}) this.style.borderColor='${isCurrentQuarter ? '#3AAFA9' : '#cbd5e1'}'"
                        >
                            ${quarter.label}
                        </button>
                    `;
                });

                financeHTML += `
                        </div>
                `;

                // Add transaction table for active quarter if available
                if (activeQuarterIndex && cachedTransactions && cachedTransactions.length > 0) {
                    financeHTML += renderActiveQuarterTransactions(activeQuarterIndex, cachedTransactions, cachedInvoices || []);
                }

                financeHTML += `
                        </div>
                    </div>
                `;
            } else {
                financeHTML += `
                    <div style="background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 16px; margin-bottom: 15px; text-align: center;">
                        <p style="margin: 0; color: #64748b; font-size: 0.9em;">
                            ‚ÑπÔ∏è Set Project Start Date and Duration in Finance Summary to enable quarterly tracking
                        </p>
                    </div>
                `;
            }

            // Build Capital Non-Standard Costs table
            if (sections.capital.nonStandard.length > 0) {
                financeHTML += `
                    <div class="card">
                        <h3>üèóÔ∏è Capital - Non Standard Costs</h3>
                        <table class="item-table">
                            <thead>
                                <tr>
                                    <th style="width: 20px;"></th>
                                    <th style="width: 70px;">Item Code</th>
                                    <th style="min-width: 400px; width: 35%;">Item Description</th>
                                    <th>Total Cost</th>
                                    <th>Grant Rate</th>
                                    <th>Maximum Grant Value ¬£</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                    <th>Delete</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sections.capital.nonStandard.map((item, index) => {
                                    if (!item.totalCost && item.maxGrantValue) item.totalCost = item.maxGrantValue;
                                    initializeQuarterlyCosts(item);
                                    const itemKey = `capitalNonStandard-${index}`;
                                    const costsClaimed = getItemClaimedFromTransactions(projectBudget.projectId, 'Capital Non-Standard', itemKey);
                                    const remaining = item.totalCost - costsClaimed;
                                    const difference = item.totalCost > 0 ? ((costsClaimed - item.totalCost) / item.totalCost) * 100 : 0;
                                    const isOverBudget = costsClaimed > item.totalCost;

                                    return `
                                        <tr style="cursor: pointer; ${isOverBudget && hasQuarters ? 'background: #fee;' : ''}"
                                            draggable="true"
                                            ondragstart="handleDragStart(event, 'welshGov.capital.nonStandard', ${index})"
                                            ondragover="handleDragOver(event, 'welshGov.capital.nonStandard', ${index})"
                                            ondragleave="handleDragLeave(event)"
                                            ondrop="handleDrop(event, 'welshGov.capital.nonStandard', ${index})"
                                            ondragend="handleDragEnd(event)">
                                            <td class="drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-capital-ns-${index}')">${item.itemCode}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-capital-ns-${index}')">${item.description}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-capital-ns-${index}')">¬£${item.totalCost.toLocaleString()}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-capital-ns-${index}')">${item.grantRate}%</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-capital-ns-${index}')">¬£${item.maxGrantValue.toLocaleString()}</td>
                                            ${hasQuarters ? `
                                                <td onclick="toggleQuarterlyBreakdown('wg-capital-ns-${index}')" ${isOverBudget ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${costsClaimed.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('wg-capital-ns-${index}')" ${remaining < 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${remaining.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('wg-capital-ns-${index}')" ${difference > 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>${difference.toFixed(1)}%</td>
                                            ` : ''}
                                            <td style="text-align: center;">
                                                <button onclick="console.log('üóëÔ∏è [BUTTON CLICK] Capital Non-Standard trash clicked, index:', ${index}); event.stopPropagation(); deleteWelshGovItem(this, 'capital.nonStandard', ${index}, 'Capital Non-Standard');"
                                                        style="background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background-color 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'"
                                                        title="Delete this item">
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                        </tr>
                                        ${hasQuarters ? `
                                        <tr id="wg-capital-ns-${index}-breakdown" style="display: none;">
                                            <td colspan="${hasQuarters ? '10' : '7'}" style="padding: 0; background: transparent;">
                                                <div class="quarterly-breakdown-container">
                                                    <h4 class="quarterly-breakdown-header">Quarterly Breakdown - ${item.description}</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                            <thead>
                                                                <tr style="background: #e2e8f0;">
                                                                    <th style="width: 150px;">Metric</th>
                                                                    ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td style="font-weight: 600;">Costs Claimed</td>
                                                                    ${quarters.map(q => `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${item.quarterlyCosts['q' + q.index] || 0}"
                                                                                onchange="updateQuarterlyCost(projectBudget.welshGovData.sections.capital.nonStandard[${index}], ${q.index}, this.value); displayWelshGovBudget(projectBudget.welshGovData);"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                                            />
                                                                        </td>
                                                                    `).join('')}
                                                                </tr>
                                                                <tr style="background: #f1f5f9;">
                                                                    <td style="font-weight: 600;">Budget Remaining</td>
                                                                    <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                        ¬£${remaining.toLocaleString()}
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    ${(() => {
                                                        // Render transaction details for this Capital Non-Standard item
                                                        if (cachedTransactions && cachedTransactions.length > 0) {
                                                            const itemTransactions = getTransactionsForItem(
                                                                cachedTransactions,
                                                                projectBudget.projectId,
                                                                'Capital Non-Standard',
                                                                'capitalNonStandard-' + index,
                                                                null
                                                            );
                                                            return renderTransactionDetails(
                                                                itemTransactions,
                                                                projectBudget.projectId,
                                                                'Capital Non-Standard',
                                                                'capitalNonStandard-' + index,
                                                                null,
                                                                cachedInvoices || []
                                                            );
                                                        }
                                                        return '';
                                                    })()}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    `;
                                }).join('')}

                                ${hasQuarters && sections.capital.nonStandard.length > 0 ? (() => {
                                    const summary = getCategorySummary(sections.capital.nonStandard, 'Capital Non-Standard', 'capitalNonStandard');
                                    const isSummaryOverBudget = summary.totalClaimed > summary.totalCosts;

                                    // Initialize category forecast if it doesn't exist
                                    if (!sections.capital.categoryForecast) {
                                        sections.capital.categoryForecast = {'q1': 0, 'q2': 0, 'q3': 0, 'q4': 0};
                                    }

                                    return `
                                        <tr style="cursor: pointer; background: #dbeafe; font-weight: 600; border-top: 3px solid #3b82f6; ${isSummaryOverBudget ? 'background: #ffebee;' : ''}">
                                            <td colspan="4" style="text-align: right; padding-right: 15px;">CATEGORY TOTAL:</td>
                                            <td>¬£${summary.totalCosts.toLocaleString()}</td>
                                            <td ${isSummaryOverBudget ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.totalClaimed.toLocaleString()}</td>
                                            <td ${summary.remaining < 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.remaining.toLocaleString()}</td>
                                            <td ${summary.difference > 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>${summary.difference.toFixed(1)}%</td>
                                            <td></td>
                                        </tr>
                                        <tr id="wg-capital-ns-summary-breakdown" style="display: none;">
                                            <td colspan="9" style="padding: 0; background: transparent;">
                                                <div class="quarterly-breakdown-container">
                                                    <h4 class="quarterly-breakdown-header">Capital Non-Standard - Quarterly Breakdown</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #bfdbfe;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                <th>Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => {
                                                                    const qClaimed = summary.quarterlyTotals['q' + q.index] || 0;
                                                                    return `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${qClaimed}"
                                                                                onchange="updateCategoryQuarterlyCost(sections.capital.nonStandard, ${q.index}, parseFloat(this.value) || 0, 'Capital Non-Standard', 'capitalNonStandard'); displayWelshGovBudget(projectBudget.welshGovData);"
                                                                                onkeypress="if(event.key==='Enter'){event.preventDefault();const val=this.value;updateCategoryQuarterlyCost(sections.capital.nonStandard, ${q.index}, parseFloat(val) || 0, 'Capital Non-Standard', 'capitalNonStandard'); displayWelshGovBudget(projectBudget.welshGovData);}"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600;"
                                                                                step="0.01"
                                                                            />
                                                                        </td>
                                                                    `;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #dbeafe;">¬£${summary.totalClaimed.toLocaleString()}</td>
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600; cursor: pointer; color: #3AAFA9; user-select: none;"
                                                                    onclick="event.stopPropagation(); const success = calculateCategoryForecast(sections.capital.nonStandard, sections.capital.categoryForecast); if(success) { refreshForecastUI(event.target, sections.capital.categoryForecast, sections.capital.nonStandard); } else { alert('No empty quarters to forecast or no budget remaining.'); }"
                                                                    title="Click to calculate forecast for empty quarters">
                                                                    <span style="font-size: 1.1em;">üîÑ</span> Forecast
                                                                </td>
                                                                ${quarters.map(q => {
                                                                    const forecast = sections.capital.categoryForecast['q' + q.index] || 0;
                                                                    return `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${forecast.toFixed(2)}"
                                                                                onchange="updateCategoryForecast(sections.capital.categoryForecast, ${q.index}, this.value); displayDetailedBudget();"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600;"
                                                                            />
                                                                        </td>
                                                                    `;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #dbeafe;">
                                                                    ¬£${getTotalForecast(sections.capital.categoryForecast).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 700; color: ${(summary.remaining - getTotalForecast(sections.capital.categoryForecast)) < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${(summary.remaining - getTotalForecast(sections.capital.categoryForecast)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                                </td>
                                                                <td style="font-weight: 700; background: #dbeafe; color: ${(summary.remaining - getTotalForecast(sections.capital.categoryForecast)) < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${(summary.remaining - getTotalForecast(sections.capital.categoryForecast)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                })() : ''}
                            </tbody>
                        </table>
                        <div style="margin-top: 12px; text-align: left;">
                            <button onclick="openAddWelshGovItemModal('capital.nonStandard')"
                                    style="background: #7c3aed; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; display: inline-flex; align-items: center; gap: 6px;"
                                    onmouseover="this.style.background='#6d28d9'" onmouseout="this.style.background='#7c3aed'">
                                ‚ûï Add Capital Item
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Show Add Item button even if no items exist
                financeHTML += `
                    <div class="card">
                        <h3>üèóÔ∏è Capital - Non Standard Costs</h3>
                        <p style="color: #94a3b8; font-style: italic;">No capital items</p>
                        <div style="margin-top: 12px; text-align: left;">
                            <button onclick="openAddWelshGovItemModal('capital.nonStandard')"
                                    style="background: #7c3aed; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; display: inline-flex; align-items: center; gap: 6px;"
                                    onmouseover="this.style.background='#6d28d9'" onmouseout="this.style.background='#7c3aed'">
                                ‚ûï Add Capital Item
                            </button>
                        </div>
                    </div>
                `;
            }

            // Build Revenue Non-Standard Costs table
            if (sections.revenue.nonStandard.length > 0) {
                financeHTML += `
                    <div class="card">
                        <h3>üìä Revenue - Non Standard Costs</h3>
                        <table class="item-table">
                            <thead>
                                <tr>
                                    <th style="width: 20px;"></th>
                                    <th style="width: 70px;">Item Code</th>
                                    <th style="min-width: 400px; width: 35%;">Item Description</th>
                                    <th>Total Cost</th>
                                    <th>Grant Rate</th>
                                    <th>Maximum Grant Value ¬£</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                    <th>Delete</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sections.revenue.nonStandard.map((item, index) => {
                                    if (!item.totalCost && item.maxGrantValue) item.totalCost = item.maxGrantValue;
                                    initializeQuarterlyCosts(item);
                                    const itemKey = `revenueNonStandard-${index}`;
                                    const costsClaimed = getItemClaimedFromTransactions(projectBudget.projectId, 'Revenue Non-Standard', itemKey);
                                    const remaining = item.totalCost - costsClaimed;
                                    const difference = item.totalCost > 0 ? ((costsClaimed - item.totalCost) / item.totalCost) * 100 : 0;
                                    const isOverBudget = costsClaimed > item.totalCost;

                                    return `
                                        <tr style="cursor: pointer; ${isOverBudget && hasQuarters ? 'background: #fee;' : ''}"
                                            draggable="true"
                                            ondragstart="handleDragStart(event, 'welshGov.revenue.nonStandard', ${index})"
                                            ondragover="handleDragOver(event, 'welshGov.revenue.nonStandard', ${index})"
                                            ondragleave="handleDragLeave(event)"
                                            ondrop="handleDrop(event, 'welshGov.revenue.nonStandard', ${index})"
                                            ondragend="handleDragEnd(event)">
                                            <td class="drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-revenue-ns-${index}')">${item.itemCode}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-revenue-ns-${index}')">${item.description}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-revenue-ns-${index}')">¬£${item.totalCost.toLocaleString()}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-revenue-ns-${index}')">${item.grantRate}%</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-revenue-ns-${index}')">¬£${item.maxGrantValue.toLocaleString()}</td>
                                            ${hasQuarters ? `
                                                <td onclick="toggleQuarterlyBreakdown('wg-revenue-ns-${index}')" ${isOverBudget ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${costsClaimed.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('wg-revenue-ns-${index}')" ${remaining < 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${remaining.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('wg-revenue-ns-${index}')" ${difference > 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>${difference.toFixed(1)}%</td>
                                            ` : ''}
                                            <td style="text-align: center;">
                                                <button onclick="console.log('üóëÔ∏è [BUTTON CLICK] Revenue Non-Standard trash clicked, index:', ${index}); event.stopPropagation(); deleteWelshGovItem(this, 'revenue.nonStandard', ${index}, 'Revenue Non-Standard');"
                                                        style="background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background-color 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'"
                                                        title="Delete this item">
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                        </tr>
                                        ${hasQuarters ? `
                                        <tr id="wg-revenue-ns-${index}-breakdown" style="display: none;">
                                            <td colspan="10" style="padding: 0; background: transparent;">
                                                <div class="quarterly-breakdown-container">
                                                    <h4 class="quarterly-breakdown-header">Quarterly Breakdown - ${item.description}</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                            <thead>
                                                                <tr style="background: #e2e8f0;">
                                                                    <th style="width: 150px;">Metric</th>
                                                                    ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td style="font-weight: 600;">Costs Claimed</td>
                                                                    ${quarters.map(q => `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${item.quarterlyCosts['q' + q.index] || 0}"
                                                                                onchange="updateQuarterlyCost(projectBudget.welshGovData.sections.revenue.nonStandard[${index}], ${q.index}, this.value); displayWelshGovBudget(projectBudget.welshGovData);"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                                            />
                                                                        </td>
                                                                    `).join('')}
                                                                </tr>
                                                                <tr style="background: #f1f5f9;">
                                                                    <td style="font-weight: 600;">Budget Remaining</td>
                                                                    <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                        ¬£${remaining.toLocaleString()}
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    ${(() => {
                                                        // Render transaction details for this Revenue Non-Standard item
                                                        if (cachedTransactions && cachedTransactions.length > 0) {
                                                            const itemTransactions = getTransactionsForItem(
                                                                cachedTransactions,
                                                                projectBudget.projectId,
                                                                'Revenue Non-Standard',
                                                                'revenueNonStandard-' + index,
                                                                null
                                                            );
                                                            return renderTransactionDetails(
                                                                itemTransactions,
                                                                projectBudget.projectId,
                                                                'Revenue Non-Standard',
                                                                'revenueNonStandard-' + index,
                                                                null,
                                                                cachedInvoices || []
                                                            );
                                                        }
                                                        return '';
                                                    })()}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    `;
                                }).join('')}

                                ${hasQuarters && sections.revenue.nonStandard.length > 0 ? (() => {
                                    const summary = getCategorySummary(sections.revenue.nonStandard, 'Revenue Non-Standard', 'revenueNonStandard');
                                    const isSummaryOverBudget = summary.totalClaimed > summary.totalCosts;

                                    // Initialize category forecast if it doesn't exist
                                    if (!sections.revenue.categoryForecast) {
                                        sections.revenue.categoryForecast = {'q1': 0, 'q2': 0, 'q3': 0, 'q4': 0};
                                    }

                                    return `
                                        <tr style="cursor: pointer; background: #dcfce7; font-weight: 600; border-top: 3px solid #22c55e; ${isSummaryOverBudget ? 'background: #ffebee;' : ''}">
                                            <td colspan="4" style="text-align: right; padding-right: 15px;">CATEGORY TOTAL:</td>
                                            <td>¬£${summary.totalCosts.toLocaleString()}</td>
                                            <td ${isSummaryOverBudget ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.totalClaimed.toLocaleString()}</td>
                                            <td ${summary.remaining < 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.remaining.toLocaleString()}</td>
                                            <td ${summary.difference > 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>${summary.difference.toFixed(1)}%</td>
                                            <td></td>
                                        </tr>
                                        <tr id="wg-revenue-ns-summary-breakdown" style="display: none;">
                                            <td colspan="9" style="padding: 0; background: transparent;">
                                                <div class="quarterly-breakdown-container">
                                                    <h4 class="quarterly-breakdown-header">Revenue Non-Standard - Quarterly Breakdown</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #bbf7d0;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                <th>Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => {
                                                                    const qClaimed = summary.quarterlyTotals['q' + q.index] || 0;
                                                                    return `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${qClaimed}"
                                                                                onchange="updateCategoryQuarterlyCost(sections.revenue.nonStandard, ${q.index}, parseFloat(this.value) || 0, 'Revenue Non-Standard', 'revenueNonStandard'); displayWelshGovBudget(projectBudget.welshGovData);"
                                                                                onkeypress="if(event.key==='Enter'){event.preventDefault();const val=this.value;updateCategoryQuarterlyCost(sections.revenue.nonStandard, ${q.index}, parseFloat(val) || 0, 'Revenue Non-Standard', 'revenueNonStandard'); displayWelshGovBudget(projectBudget.welshGovData);}"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600;"
                                                                                step="0.01"
                                                                            />
                                                                        </td>
                                                                    `;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #dcfce7;">¬£${summary.totalClaimed.toLocaleString()}</td>
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600; cursor: pointer; color: #3AAFA9; user-select: none;"
                                                                    onclick="event.stopPropagation(); const success = calculateCategoryForecast(sections.revenue.nonStandard, sections.revenue.categoryForecast); if(success) { refreshForecastUI(event.target, sections.revenue.categoryForecast, sections.revenue.nonStandard); } else { alert('No empty quarters to forecast or no budget remaining.'); }"
                                                                    title="Click to calculate forecast for empty quarters">
                                                                    <span style="font-size: 1.1em;">üîÑ</span> Forecast
                                                                </td>
                                                                ${quarters.map(q => {
                                                                    const forecast = sections.revenue.categoryForecast['q' + q.index] || 0;
                                                                    return `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${forecast.toFixed(2)}"
                                                                                onchange="updateCategoryForecast(sections.revenue.categoryForecast, ${q.index}, this.value); displayDetailedBudget();"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600;"
                                                                            />
                                                                        </td>
                                                                    `;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #dcfce7;">
                                                                    ¬£${getTotalForecast(sections.revenue.categoryForecast).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 700; color: ${(summary.remaining - getTotalForecast(sections.revenue.categoryForecast)) < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${(summary.remaining - getTotalForecast(sections.revenue.categoryForecast)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                                </td>
                                                                <td style="font-weight: 700; background: #dcfce7; color: ${(summary.remaining - getTotalForecast(sections.revenue.categoryForecast)) < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${(summary.remaining - getTotalForecast(sections.revenue.categoryForecast)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                })() : ''}
                            </tbody>
                        </table>
                        <div style="margin-top: 12px; text-align: left;">
                            <button onclick="openAddWelshGovItemModal('revenue.nonStandard')"
                                    style="background: #7c3aed; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; display: inline-flex; align-items: center; gap: 6px;"
                                    onmouseover="this.style.background='#6d28d9'" onmouseout="this.style.background='#7c3aed'">
                                ‚ûï Add Revenue Item
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Show Add Item button even if no items exist
                financeHTML += `
                    <div class="card">
                        <h3>üìä Revenue - Non Standard Costs</h3>
                        <p style="color: #94a3b8; font-style: italic;">No revenue non-standard items</p>
                        <div style="margin-top: 12px; text-align: left;">
                            <button onclick="openAddWelshGovItemModal('revenue.nonStandard')"
                                    style="background: #7c3aed; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; display: inline-flex; align-items: center; gap: 6px;"
                                    onmouseover="this.style.background='#6d28d9'" onmouseout="this.style.background='#7c3aed'">
                                ‚ûï Add Revenue Item
                            </button>
                        </div>
                    </div>
                `;
            }

            // Build Revenue Standard Costs table
            if (sections.revenue.standardCosts.length > 0) {
                financeHTML += `
                    <div class="card">
                        <h3>üë• Revenue - Standard Costs</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Item Code</th>
                                    <th>Item Description</th>
                                    <th>Item Details</th>
                                    <th>Quantity</th>
                                    <th>Grant Rate</th>
                                    <th>Maximum Grant Value ¬£</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                    <th>Delete</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sections.revenue.standardCosts.map((item, index) => {
                                    if (!item.maxGrantValue && item.grantRate && item.quantity) {
                                        item.maxGrantValue = parseFloat(item.grantRate.replace(/[¬£,]/g, '')) * parseFloat(item.quantity);
                                    }
                                    initializeQuarterlyCosts(item);
                                    const itemKey = `revenueStandard-${index}`;
                                    const costsClaimed = getItemClaimedFromTransactions(projectBudget.projectId, 'Revenue Standard', itemKey);
                                    const remaining = item.totalCost - costsClaimed;
                                    const difference = item.totalCost > 0 ? ((costsClaimed - item.totalCost) / item.totalCost) * 100 : 0;
                                    const isOverBudget = costsClaimed > item.totalCost;

                                    return `
                                        <tr style="cursor: pointer; ${isOverBudget && hasQuarters ? 'background: #fee;' : ''}">
                                            <td onclick="toggleQuarterlyBreakdown('wg-revenue-std-${index}')">${item.itemCode}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-revenue-std-${index}')">${item.description}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-revenue-std-${index}')">${item.itemDetails}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-revenue-std-${index}')">${item.quantity} Hours</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-revenue-std-${index}')">¬£${item.grantRate}/Hour</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-revenue-std-${index}')">¬£${item.maxGrantValue.toLocaleString()}</td>
                                            ${hasQuarters ? `
                                                <td onclick="toggleQuarterlyBreakdown('wg-revenue-std-${index}')" ${isOverBudget ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${costsClaimed.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('wg-revenue-std-${index}')" ${remaining < 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${remaining.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('wg-revenue-std-${index}')" ${difference > 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>${difference.toFixed(1)}%</td>
                                            ` : ''}
                                            <td style="text-align: center;">
                                                <button onclick="console.log('üóëÔ∏è [BUTTON CLICK] Revenue Standard Costs trash clicked, index:', ${index}); event.stopPropagation(); deleteWelshGovItem(this, 'revenue.standardCosts', ${index}, 'Revenue Standard Costs');"
                                                        style="background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background-color 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'"
                                                        title="Delete this item">
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                        </tr>
                                        ${hasQuarters ? `
                                        <tr id="wg-revenue-std-${index}-breakdown" style="display: none;">
                                            <td colspan="10" style="padding: 0; background: transparent;">
                                                <div class="quarterly-breakdown-container">
                                                    <h4 class="quarterly-breakdown-header">Quarterly Breakdown - ${item.description}</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #e2e8f0;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => `
                                                                    <td data-quarter="${q.index}">
                                                                        <input
                                                                            type="number"
                                                                            value="${item.quarterlyCosts['q' + q.index] || 0}"
                                                                            onchange="updateQuarterlyCost(projectBudget.welshGovData.sections.revenue.standardCosts[${index}], ${q.index}, this.value); displayWelshGovBudget(projectBudget.welshGovData);"
                                                                            onclick="event.stopPropagation()"
                                                                            style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                                        />
                                                                    </td>
                                                                `).join('')}
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${remaining.toLocaleString()}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    ${(() => {
                                                        if (cachedTransactions && cachedTransactions.length > 0) {
                                                            const itemTransactions = getTransactionsForItem(
                                                                cachedTransactions,
                                                                projectBudget.projectId,
                                                                'Revenue Standard',
                                                                'revenueStandard-' + index,
                                                                null
                                                            );
                                                            return renderTransactionDetails(
                                                                itemTransactions,
                                                                projectBudget.projectId,
                                                                'Revenue Standard',
                                                                'revenueStandard-' + index,
                                                                null,
                                                                cachedInvoices || []
                                                            );
                                                        }
                                                        return '';
                                                    })()}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    `;
                                }).join('')}
                                <tr style="background: #f1f5f9; font-weight: 600;">
                                    <td colspan="${hasQuarters ? '6' : '5'}" style="text-align: right;">Total Maximum Revenue Grant Value (Standard Costs)</td>
                                    <td>¬£${sections.totals.totalRevenueStandard.toLocaleString()}</td>
                                    ${hasQuarters ? '<td colspan="2"></td>' : ''}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Build Item Breakdown - Capital
            if (sections.itemBreakdown.capital.length > 0) {
                financeHTML += `
                    <div class="card">
                        <h3>üìã Item Breakdown - Capital</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Item Code</th>
                                    <th>Item Description</th>
                                    <th>Item Details</th>
                                    <th>Total Cost</th>
                                    <th>Grant Rate</th>
                                    <th>Maximum Grant Approved ¬£</th>
                                    <th>*Claimable</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                    <th>Delete</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sections.itemBreakdown.capital.map((item, index) => {
                                    if (!item.maxGrantApproved && item.totalCost && item.grantRate) {
                                        item.maxGrantApproved = (item.totalCost * item.grantRate) / 100;
                                    }
                                    initializeQuarterlyCosts(item);
                                    const itemKey = `itemBreakdownCapital-${index}`;
                                    const costsClaimed = getItemClaimedFromTransactions(projectBudget.projectId, 'Item Breakdown Capital', itemKey);
                                    const remaining = item.totalCost - costsClaimed;
                                    const difference = item.totalCost > 0 ? ((costsClaimed - item.totalCost) / item.totalCost) * 100 : 0;
                                    const isOverBudget = costsClaimed > item.totalCost;

                                    return `
                                        <tr style="cursor: pointer; ${isOverBudget && hasQuarters ? 'background: #fee;' : ''}">
                                            <td onclick="toggleQuarterlyBreakdown('wg-item-cap-${index}')">${item.itemCode}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-item-cap-${index}')">${item.description}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-item-cap-${index}')">${item.itemDetails}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-item-cap-${index}')">¬£${item.totalCost.toLocaleString()}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-item-cap-${index}')">${item.grantRate}%</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-item-cap-${index}')">¬£${item.maxGrantApproved.toLocaleString()}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-item-cap-${index}')">${item.claimable ? 'Yes' : 'No'}</td>
                                            ${hasQuarters ? `
                                                <td onclick="toggleQuarterlyBreakdown('wg-item-cap-${index}')" ${isOverBudget ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${costsClaimed.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('wg-item-cap-${index}')" ${remaining < 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${remaining.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('wg-item-cap-${index}')" ${difference > 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>${difference.toFixed(1)}%</td>
                                            ` : ''}
                                            <td style="text-align: center;">
                                                <button onclick="console.log('üóëÔ∏è [BUTTON CLICK] Item Breakdown Capital trash clicked, index:', ${index}); event.stopPropagation(); deleteWelshGovItem(this, 'itemBreakdown.capital', ${index}, 'Item Breakdown Capital');"
                                                        style="background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background-color 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'"
                                                        title="Delete this item">
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                        </tr>
                                        ${hasQuarters ? `
                                        <tr id="wg-item-cap-${index}-breakdown" style="display: none;">
                                            <td colspan="11" style="padding: 0; background: transparent;">
                                                <div class="quarterly-breakdown-container">
                                                    <h4 class="quarterly-breakdown-header">Quarterly Breakdown - ${item.description}</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #e2e8f0;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => `
                                                                    <td data-quarter="${q.index}">
                                                                        <input
                                                                            type="number"
                                                                            value="${item.quarterlyCosts['q' + q.index] || 0}"
                                                                            onchange="updateQuarterlyCost(projectBudget.welshGovData.sections.itemBreakdown.capital[${index}], ${q.index}, this.value); displayWelshGovBudget(projectBudget.welshGovData);"
                                                                            onclick="event.stopPropagation()"
                                                                            style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                                        />
                                                                    </td>
                                                                `).join('')}
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${remaining.toLocaleString()}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    ${(() => {
                                                        if (cachedTransactions && cachedTransactions.length > 0) {
                                                            const itemTransactions = getTransactionsForItem(
                                                                cachedTransactions,
                                                                projectBudget.projectId,
                                                                'Item Breakdown Capital',
                                                                'itemBreakdownCapital-' + index,
                                                                null
                                                            );
                                                            return renderTransactionDetails(
                                                                itemTransactions,
                                                                projectBudget.projectId,
                                                                'Item Breakdown Capital',
                                                                'itemBreakdownCapital-' + index,
                                                                null,
                                                                cachedInvoices || []
                                                            );
                                                        }
                                                        return '';
                                                    })()}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        <div style="margin-top: 12px; text-align: left;">
                            <button onclick="openAddWelshGovItemModal('revenue.standardCosts')"
                                    style="background: #7c3aed; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; display: inline-flex; align-items: center; gap: 6px;"
                                    onmouseover="this.style.background='#6d28d9'" onmouseout="this.style.background='#7c3aed'">
                                ‚ûï Add Standard Cost Item
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Show Add Item button even if no items exist
                financeHTML += `
                    <div class="card">
                        <h3>üë• Revenue - Standard Costs</h3>
                        <p style="color: #94a3b8; font-style: italic;">No revenue standard cost items</p>
                        <div style="margin-top: 12px; text-align: left;">
                            <button onclick="openAddWelshGovItemModal('revenue.standardCosts')"
                                    style="background: #7c3aed; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; display: inline-flex; align-items: center; gap: 6px;"
                                    onmouseover="this.style.background='#6d28d9'" onmouseout="this.style.background='#7c3aed'">
                                ‚ûï Add Standard Cost Item
                            </button>
                        </div>
                    </div>
                `;
            }

            // Build Item Breakdown - Revenue
            if (sections.itemBreakdown.revenue.length > 0) {
                financeHTML += `
                    <div class="card">
                        <h3>üìã Item Breakdown - Revenue</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Item Code</th>
                                    <th>Item Description</th>
                                    <th>Item Details</th>
                                    <th>Total Cost</th>
                                    <th>Grant Rate</th>
                                    <th>Maximum Grant Approved ¬£</th>
                                    <th>*Claimable</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                    <th>Delete</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sections.itemBreakdown.revenue.map((item, index) => {
                                    if (!item.maxGrantApproved && item.totalCost && item.grantRate) {
                                        item.maxGrantApproved = (item.totalCost * item.grantRate) / 100;
                                    }
                                    initializeQuarterlyCosts(item);
                                    const itemKey = `itemBreakdownRevenue-${index}`;
                                    const costsClaimed = getItemClaimedFromTransactions(projectBudget.projectId, 'Item Breakdown Revenue', itemKey);
                                    const remaining = item.totalCost - costsClaimed;
                                    const difference = item.totalCost > 0 ? ((costsClaimed - item.totalCost) / item.totalCost) * 100 : 0;
                                    const isOverBudget = costsClaimed > item.totalCost;

                                    return `
                                        <tr style="cursor: pointer; ${isOverBudget && hasQuarters ? 'background: #fee;' : ''}">
                                            <td onclick="toggleQuarterlyBreakdown('wg-item-rev-${index}')">${item.itemCode}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-item-rev-${index}')">${item.description}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-item-rev-${index}')">${item.itemDetails}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-item-rev-${index}')">¬£${item.totalCost.toLocaleString()}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-item-rev-${index}')">${item.grantRate}%</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-item-rev-${index}')">¬£${item.maxGrantApproved.toLocaleString()}</td>
                                            <td onclick="toggleQuarterlyBreakdown('wg-item-rev-${index}')">${item.claimable ? 'Yes' : 'No'}</td>
                                            ${hasQuarters ? `
                                                <td onclick="toggleQuarterlyBreakdown('wg-item-rev-${index}')" ${isOverBudget ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${costsClaimed.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('wg-item-rev-${index}')" ${remaining < 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>¬£${remaining.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('wg-item-rev-${index}')" ${difference > 0 ? 'style="color: #d32f2f; font-weight: 600;"' : ''}>${difference.toFixed(1)}%</td>
                                            ` : ''}
                                            <td style="text-align: center;">
                                                <button onclick="console.log('üóëÔ∏è [BUTTON CLICK] Item Breakdown Revenue trash clicked, index:', ${index}); event.stopPropagation(); deleteWelshGovItem(this, 'itemBreakdown.revenue', ${index}, 'Item Breakdown Revenue');"
                                                        style="background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background-color 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'"
                                                        title="Delete this item">
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                        </tr>
                                        ${hasQuarters ? `
                                        <tr id="wg-item-rev-${index}-breakdown" style="display: none;">
                                            <td colspan="11" style="padding: 0; background: transparent;">
                                                <div class="quarterly-breakdown-container">
                                                    <h4 class="quarterly-breakdown-header">Quarterly Breakdown - ${item.description}</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #e2e8f0;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => `
                                                                    <td data-quarter="${q.index}">
                                                                        <input
                                                                            type="number"
                                                                            value="${item.quarterlyCosts['q' + q.index] || 0}"
                                                                            onchange="updateQuarterlyCost(projectBudget.welshGovData.sections.itemBreakdown.revenue[${index}], ${q.index}, this.value); displayWelshGovBudget(projectBudget.welshGovData);"
                                                                            onclick="event.stopPropagation()"
                                                                            style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                                        />
                                                                    </td>
                                                                `).join('')}
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${remaining.toLocaleString()}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    ${(() => {
                                                        if (cachedTransactions && cachedTransactions.length > 0) {
                                                            const itemTransactions = getTransactionsForItem(
                                                                cachedTransactions,
                                                                projectBudget.projectId,
                                                                'Item Breakdown Revenue',
                                                                'itemBreakdownRevenue-' + index,
                                                                null
                                                            );
                                                            return renderTransactionDetails(
                                                                itemTransactions,
                                                                projectBudget.projectId,
                                                                'Item Breakdown Revenue',
                                                                'itemBreakdownRevenue-' + index,
                                                                null,
                                                                cachedInvoices || []
                                                            );
                                                        }
                                                        return '';
                                                    })()}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        <p style="font-size: 0.85em; color: #64748b; margin-top: 10px; font-style: italic;">
                            * Claimable means quotes have been received and verified and/or field parcels have been provided, where applicable, for those items.
                        </p>
                    </div>
                `;
            }

            // Insert the built HTML (with null check)
            const financeSummarySection = document.getElementById('financeSummarySection');
            if (financeSummarySection) {
                financeSummarySection.innerHTML = financeHTML;
            } else {
                console.error('financeSummarySection element not found in DOM');
                addLog('‚ùå Error: Could not find financeSummarySection in page - check HTML structure');
            }
        }

        // Welsh Gov Budget Parser
        async function parseWelshGovBudget(inputText, parseBtn) {
            addLog('üìã Parsing Welsh Gov budget format...');
            addLog('‚ö†Ô∏è Note: Welsh Gov format does not include overhead calculations');

            try {
                // Parse the Welsh Gov format
                const welshGovData = await parseWelshGovFormat(inputText);

                // Store ONLY Welsh Gov data - clear all IUK category data
                projectBudget.fundingBody = 'Welsh Gov';
                projectBudget.welshGovData = welshGovData;
                projectBudget.financeSummary = welshGovData.financeSummary;
                projectBudget.lastModified = new Date().toISOString();

                // Clear ALL IUK-specific category data to prevent mixing
                projectBudget.labour = { staff: [], workingDaysPerYear: 0, totalCost: 0 };
                projectBudget.overheads = { items: [], totalCost: 0 };
                projectBudget.materials = { items: [], totalCost: 0 };
                projectBudget.capitalUsage = { items: [], totalCost: 0 };
                projectBudget.subcontracting = { contractors: [], totalCost: 0 };
                projectBudget.travel = { trips: [], totalCost: 0 };
                projectBudget.otherCosts = { items: [], totalCost: 0 };

                addLog('üßπ Cleared all IUK category data');
                addLog('üì¶ Welsh Gov categories: Capital, Revenue (Standard/Non-Standard), Item Breakdown');

                // Auto-save to IndexedDB
                addLog('üíæ Auto-saving to IndexedDB...');
                await saveToIndexedDB();

                addLog('üé® Rendering Welsh Gov budget view...');
                displayWelshGovBudget(welshGovData);

                document.getElementById('detailedBudgetResults').classList.add('show');
                addLog('‚úÖ Welsh Gov budget parsing complete!');

            } catch (error) {
                console.error('Welsh Gov parsing error:', error);
                addLog(`‚ùå Parsing failed: ${error.message}`);
                alert(`Failed to parse budget: ${error.message}`);
            } finally {
                parseBtn.disabled = false;
                parseBtn.innerHTML = '<span>üìä</span> <span id="parseBtnText">Parse Budget</span>';
            }
        }

        // Parse Welsh Gov format structure - REWRITTEN for flexibility
        async function parseWelshGovFormat(inputText) {
            addLog('üîç Extracting Welsh Gov sections...');
            console.log('Welsh Gov input text length:', inputText.length);

            const sections = {
                capital: { nonStandard: [], standardCosts: [] },
                revenue: { nonStandard: [], standardCosts: [] },
                itemBreakdown: { capital: [], revenue: [] },
                totals: {}
            };

            // Extract totals
            const totalCapitalMatch = inputText.match(/Total Maximum Capital Grant Value[^\d]+([\d,]+\.\d{2})/i);
            const totalRevenueNonStdMatch = inputText.match(/Total Maximum Revenue Grant Value \(Non Standard Costs\)[^\d]+([\d,]+\.\d{2})/i);
            const totalRevenueStdMatch = inputText.match(/Total Maximum Revenue Grant Value \(Standard Costs\)[^\d]+([\d,]+\.\d{2})/i);
            const totalRevenueMatch = inputText.match(/Total Maximum Revenue Grant Approved[^\d]+([\d,]+\.\d{2})/i);
            const totalGrantMatch = inputText.match(/Total Maximum Grant Approved[^\d]+([\d,]+\.\d{2})/i);

            sections.totals = {
                totalCapital: totalCapitalMatch ? parseFloat(totalCapitalMatch[1].replace(/,/g, '')) : 0,
                totalRevenueNonStandard: totalRevenueNonStdMatch ? parseFloat(totalRevenueNonStdMatch[1].replace(/,/g, '')) : 0,
                totalRevenueStandard: totalRevenueStdMatch ? parseFloat(totalRevenueStdMatch[1].replace(/,/g, '')) : 0,
                totalRevenueApproved: totalRevenueMatch ? parseFloat(totalRevenueMatch[1].replace(/,/g, '')) : 0,
                totalGrantApproved: totalGrantMatch ? parseFloat(totalGrantMatch[1].replace(/,/g, '')) : 0
            };

            console.log('Totals extracted:', sections.totals);

            // Track context - which section are we in?
            let inItemBreakdown = false;
            let inStandardCosts = false;
            let currentMainSection = 'revenue'; // default
            let currentBreakdownSection = '';

            const lines = inputText.split('\n');

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // Detect section headers
                if (/^Item Breakdown/i.test(line)) {
                    inItemBreakdown = true;
                    inStandardCosts = false;
                    continue;
                }
                if (/^Standard Costs/i.test(line)) {
                    inStandardCosts = true;
                    inItemBreakdown = false;
                    continue;
                }
                if (/^Non Standard Costs/i.test(line)) {
                    inStandardCosts = false;
                    inItemBreakdown = false;
                    continue;
                }

                // Track main sections (Capital/Revenue) within Item Breakdown
                if (inItemBreakdown) {
                    if (/^Capital\s*$/i.test(line)) {
                        currentBreakdownSection = 'capital';
                        continue;
                    }
                    if (/^Revenue\s*$/i.test(line)) {
                        currentBreakdownSection = 'revenue';
                        continue;
                    }
                }

                // Update main section tracking
                if (/capital/i.test(line) && !inItemBreakdown) currentMainSection = 'capital';
                if (/revenue/i.test(line) && !inItemBreakdown) currentMainSection = 'revenue';

                // Parse GF### items (Non-Standard and Standard Costs)
                if (line.match(/^GF\d{3}/)) {
                    const itemCode = line.match(/^(GF\d{3})/)[1];

                    // Gather all lines for this item until next item code or total
                    let itemText = line;
                    let j = i + 1;
                    while (j < lines.length) {
                        const nextLine = lines[j].trim();
                        if (/^GF\d{3}|^Total|^Item Code|^\d{3}aa/i.test(nextLine)) break;
                        itemText += ' ' + nextLine;
                        j++;
                    }

                    // Parse based on whether it's Standard Costs or Non-Standard
                    if (inStandardCosts) {
                        // Standard Costs format: Code | Description | Details | Quantity Hours | ¬£rate/Hour | ¬£maxGrant
                        const match = itemText.match(/GF\d{3}\s+(.+?)\s+(.+?)\s+(\d+)\s+Hours?\s+([\d,]+(?:\.\d+)?)\s*Hours?\s+¬£([\d.]+)\s*\/?\s*Hou[r]?\s+([\d,]+\.\d{2})/i);
                        if (match) {
                            sections.revenue.standardCosts.push({
                                itemCode: itemCode,
                                description: match[1].trim(),
                                itemDetails: match[2].trim(),
                                quantity: parseFloat(match[3]),
                                grantRate: parseFloat(match[5]),
                                maxGrantValue: parseFloat(match[6].replace(/,/g, ''))
                            });
                            console.log(`‚úÖ Parsed standard cost: ${itemCode}`);
                        }
                    } else {
                        // Non-Standard Costs format: Code | Description | ¬£cost | rate% | ¬£maxGrant
                        const match = itemText.match(/GF\d{3}\s+(.+?)\s+¬£([\d,]+\.\d{2})\s+([\d.]+)\s*%\s+([\d,]+\.\d{2})/);
                        if (match) {
                            const item = {
                                itemCode: itemCode,
                                description: match[1].trim(),
                                totalCost: parseFloat(match[2].replace(/,/g, '')),
                                grantRate: parseFloat(match[3]),
                                maxGrantValue: parseFloat(match[4].replace(/,/g, ''))
                            };

                            if (currentMainSection === 'capital') {
                                sections.capital.nonStandard.push(item);
                            } else {
                                sections.revenue.nonStandard.push(item);
                            }
                            console.log(`‚úÖ Parsed non-standard: ${itemCode} (${currentMainSection})`);
                        }
                    }

                    i = j - 1; // Skip processed lines
                    continue;
                }

                // Parse ###aa items (Item Breakdown)
                if (line.match(/^\d{3}aa\b/)) {
                    const itemCode = line.match(/^(\d{3}aa)/)[1];

                    // Gather all lines for this item
                    let itemText = line;
                    let j = i + 1;
                    while (j < lines.length) {
                        const nextLine = lines[j].trim();
                        if (/^\d{3}aa|^Item Code|^\*\s*Claimable|^CRN:/i.test(nextLine)) break;
                        itemText += ' ' + nextLine;
                        j++;
                    }

                    // Item Breakdown format: Code | Description | Details | ¬£cost | rate% | ¬£approved | Yes/No
                    const match = itemText.match(/\d{3}aa\s+(.+?)\s+(.+?)\s+¬£([\d,]+\.\d{2})\s+([\d.]+)\s*%\s+([\d,]+\.\d{2})\s+(Yes|No)/i);
                    if (match) {
                        const item = {
                            itemCode: itemCode,
                            description: match[1].trim(),
                            itemDetails: match[2].trim(),
                            totalCost: parseFloat(match[3].replace(/,/g, '')),
                            grantRate: parseFloat(match[4]),
                            maxGrantApproved: parseFloat(match[5].replace(/,/g, '')),
                            claimable: match[6] === 'Yes'
                        };

                        if (currentBreakdownSection === 'capital' || /capital/i.test(item.description)) {
                            sections.itemBreakdown.capital.push(item);
                            console.log(`‚úÖ Parsed capital breakdown: ${itemCode}`);
                        } else {
                            sections.itemBreakdown.revenue.push(item);
                            console.log(`‚úÖ Parsed revenue breakdown: ${itemCode}`);
                        }
                    } else {
                        console.log(`‚ö†Ô∏è Could not parse ${itemCode}:`, itemText.substring(0, 150));
                    }

                    i = j - 1; // Skip processed lines
                    continue;
                }
            }

            // Calculate finance summary - Welsh Gov specific (no 20% overhead rule)
            // Extract the actual grant rate from the first item (they're typically all the same)
            let avgGrantRate = 80; // Default
            if (sections.capital.nonStandard.length > 0) {
                avgGrantRate = sections.capital.nonStandard[0].grantRate;
            } else if (sections.revenue.nonStandard.length > 0) {
                avgGrantRate = sections.revenue.nonStandard[0].grantRate;
            } else if (sections.itemBreakdown.capital.length > 0) {
                avgGrantRate = sections.itemBreakdown.capital[0].grantRate;
            } else if (sections.itemBreakdown.revenue.length > 0) {
                avgGrantRate = sections.itemBreakdown.revenue[0].grantRate;
            }

            // If capital total wasn't found in totals, calculate from item breakdown
            if (sections.totals.totalCapital === 0 && sections.itemBreakdown.capital.length > 0) {
                sections.totals.totalCapital = sections.itemBreakdown.capital.reduce((sum, item) => sum + item.maxGrantApproved, 0);
                console.log('Calculated capital total from item breakdown:', sections.totals.totalCapital);
            }

            // Calculate total project costs from grant approved amount
            const totalProjectCosts = sections.totals.totalGrantApproved / (avgGrantRate / 100);

            const financeSummary = {
                fundingBody: 'Welsh Gov',
                totalCosts: sections.totals.totalGrantApproved,
                totalProjectCosts: totalProjectCosts,
                fundingLevel: avgGrantRate, // Use actual grant rate from data, not calculated
                projectDuration: 'See grant documentation',
                capitalTotal: sections.totals.totalCapital,
                revenueTotal: sections.totals.totalRevenueApproved
            };

            addLog(`‚úÖ Extracted ${sections.capital.nonStandard.length} capital items`);
            addLog(`‚úÖ Extracted ${sections.revenue.nonStandard.length} revenue non-standard items`);
            addLog(`‚úÖ Extracted ${sections.revenue.standardCosts.length} revenue standard cost items`);
            addLog(`‚úÖ Extracted ${sections.itemBreakdown.capital.length} capital breakdown items`);
            addLog(`‚úÖ Extracted ${sections.itemBreakdown.revenue.length} revenue breakdown items`);
            addLog(`‚úÖ Total grant approved: ¬£${sections.totals.totalGrantApproved.toLocaleString()}`);

            console.log('Final sections:', sections);

            return {
                sections,
                financeSummary
            };
        }

        // Auto-detect funding body format
        function detectFundingBodyFormat(inputText) {
            const lowerText = inputText.toLowerCase();

            // Welsh Gov indicators
            const hasItemCode = /item code/i.test(inputText);
            const hasGFCodes = /GF\d{3}/g.test(inputText);
            const hasNonStandardCosts = /non standard costs/i.test(inputText);
            const hasSchedule1a = /schedule 1a/i.test(inputText);
            const hasClaimable = /\*claimable/i.test(inputText);

            // Count Welsh Gov indicators
            const welshGovScore = [hasItemCode, hasGFCodes, hasNonStandardCosts, hasSchedule1a, hasClaimable].filter(Boolean).length;

            // IUK indicators
            const hasLabour = lowerText.includes('labour');
            const hasFinanceSummary = lowerText.includes('finance summary') || lowerText.includes('project duration');

            // Simple Summary format indicators (e.g., WWF grant)
            const hasSimpleCategories = (
                (lowerText.includes('labour') || lowerText.includes('labor')) &&
                (lowerText.includes('materials') || lowerText.includes('capuse') || lowerText.includes('subcon'))
            );
            const hasNoDetailedBreakdown = !lowerText.includes('finance summary') &&
                                          !lowerText.includes('project duration') &&
                                          !lowerText.includes('staff') &&
                                          !lowerText.includes('gross cost');
            const linesCount = inputText.split('\n').filter(line => line.trim()).length;
            const isSimpleSummary = hasSimpleCategories && hasNoDetailedBreakdown && linesCount <= 15;

            if (welshGovScore >= 3) {
                return 'welshgov';
            } else if (isSimpleSummary) {
                return 'simple_summary';
            } else if (hasLabour && hasFinanceSummary) {
                return 'iuk';
            }

            return 'unknown';
        }

        // Parse simple summary budget format (e.g., WWF grant)
        async function parseSimpleSummaryBudget(inputText, parseBtn) {
            addLog('üìã Detected: SIMPLE SUMMARY BUDGET FORMAT');
            addLog('üîç Parsing category totals...');

            try {
                // RESET projectBudget to default state
                projectBudget = {
                    projectNumber: '',
                    projectName: '',
                    fundingBody: '',
                    financeSummary: {
                        fundingBody: '',
                        projectStartMonth: null,
                        projectStartYear: null,
                        projectDurationMonths: null,
                        totalCosts: 0,
                        fundingLevel: 0,
                        fundingSought: 0,
                        otherPublicFunding: 0,
                        contribution: 0
                    },
                    labour: {
                        workingDaysPerYear: 232,
                        staff: [],
                        totalCost: 0,
                        hasPAYE: true
                    },
                    overheads: {
                        percentage: 20,
                        labourCosts: 0,
                        totalCost: 0
                    },
                    materials: {
                        items: [],
                        totalCost: 0
                    },
                    capitalUsage: {
                        items: [],
                        totalCost: 0
                    },
                    subcontracting: {
                        contractors: [],
                        totalCost: 0
                    },
                    travel: {
                        trips: [],
                        totalCost: 0
                    },
                    otherCosts: {
                        items: [],
                        totalCost: 0
                    }
                };
                addLog('‚úì Reset project budget structure');

                // Initialize totals
                let totalCosts = 0;
                const categories = {
                    labour: 0,
                    materials: 0,
                    capUse: 0,
                    subcon: 0,
                    travel: 0,
                    overheads: 0,
                    other: 0
                };

                // Parse each line
                const lines = inputText.split('\n').filter(line => line.trim());

                addLog(`üìù Processing ${lines.length} lines...`);

                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) continue;

                    // Try to extract category name and amount
                    // Format: "Category Name    Amount" (tabs or spaces)
                    // More flexible regex: handles tabs, multiple spaces, or even single space before number
                    const match = trimmedLine.match(/^(.+?)\s+(\d[\d,]*(?:\.\d{1,2})?)$/);

                    if (match) {
                        const categoryName = match[1].trim();
                        const category = categoryName.toLowerCase();
                        const amountStr = match[2].replace(/,/g, '');
                        const amount = parseFloat(amountStr);

                        addLog(`  ‚úì ${categoryName}: ¬£${amount.toLocaleString()}`);

                        // Map to correct category
                        if (category.includes('labour') || category.includes('labor')) {
                            categories.labour = amount;
                        } else if (category.includes('material')) {
                            categories.materials = amount;
                        } else if (category.includes('capuse') || category.includes('capital')) {
                            categories.capUse = amount;
                        } else if (category.includes('subcon')) {
                            categories.subcon = amount;
                        } else if (category.includes('travel') || category.includes('subs')) {
                            categories.travel = amount;
                        } else if (category.includes('indir') || category.includes('overh')) {
                            categories.overheads = amount;
                        } else if (category.includes('other')) {
                            categories.other = amount;
                        }

                        totalCosts += amount;
                    } else {
                        addLog(`  ‚ö†Ô∏è Could not parse line: "${trimmedLine}"`);
                    }
                }

                // Update projectBudget structure
                projectBudget.projectNumber = 'WWF-' + Date.now();
                projectBudget.projectName = 'WWF Grant';
                projectBudget.fundingBody = 'WWF';

                // Finance Summary
                projectBudget.financeSummary = {
                    fundingBody: 'WWF',
                    projectStartMonth: null,
                    projectStartYear: null,
                    projectDurationMonths: null,
                    totalCosts: totalCosts,
                    fundingLevel: 0,
                    fundingSought: 0,
                    otherPublicFunding: 0,
                    contribution: 0
                };

                // Labour
                projectBudget.labour = {
                    workingDaysPerYear: 232,
                    staff: [],
                    totalCost: categories.labour,
                    hasPAYE: true
                };

                // Overheads
                projectBudget.overheads = {
                    percentage: categories.labour > 0 ? (categories.overheads / categories.labour * 100) : 0,
                    labourCosts: categories.labour,
                    totalCost: categories.overheads
                };

                // Materials
                projectBudget.materials = {
                    items: [],
                    totalCost: categories.materials
                };

                // Capital Usage
                projectBudget.capitalUsage = {
                    items: [],
                    totalCost: categories.capUse
                };

                // Subcontracting
                projectBudget.subcontracting = {
                    contractors: [],
                    totalCost: categories.subcon
                };

                // Travel
                projectBudget.travel = {
                    trips: [],
                    totalCost: categories.travel
                };

                // Other Costs
                projectBudget.otherCosts = {
                    items: [],
                    totalCost: categories.other
                };

                // Clear any Welsh Gov data
                if (projectBudget.welshGovData) {
                    delete projectBudget.welshGovData;
                }

                addLog('‚úÖ Simple summary budget parsed successfully!');
                addLog(`Total Costs: ¬£${totalCosts.toLocaleString()}`);
                addLog(`   ‚Ä¢ Labour: ¬£${categories.labour.toLocaleString()}`);
                addLog(`   ‚Ä¢ Materials: ¬£${categories.materials.toLocaleString()}`);
                addLog(`   ‚Ä¢ Capital: ¬£${categories.capUse.toLocaleString()}`);
                addLog(`   ‚Ä¢ Subcontracting: ¬£${categories.subcon.toLocaleString()}`);
                addLog(`   ‚Ä¢ Travel: ¬£${categories.travel.toLocaleString()}`);
                addLog(`   ‚Ä¢ Overheads: ¬£${categories.overheads.toLocaleString()}`);
                addLog(`   ‚Ä¢ Other: ¬£${categories.other.toLocaleString()}`);

                addLog('üíæ Auto-saving to IndexedDB...');
                await saveToIndexedDB();

                addLog('üé® Rendering detailed budget view...');
                await displayDetailedBudget();

            } catch (error) {
                console.error('Error parsing simple summary budget:', error);
                addLog(`‚ùå Error: ${error.message}`);
                alert('Failed to parse simple summary budget. Please check the format and try again.');
            } finally {
                // Re-enable button
                parseBtn.disabled = false;
                parseBtn.innerHTML = 'ü§ñ Parse Budget with AI';
            }
        }

        async function parseBudget() {
            console.log('üöÄ parseBudget() function called');

            const inputText = document.getElementById('budgetInput').value.trim();
            console.log('Input text length:', inputText.length);

            if (!inputText) {
                console.log('No input text provided');
                alert('Please paste some budget text to parse.');
                return;
            }

            // Reset
            logs = [];
            document.getElementById('results').classList.remove('show');
            console.log('Reset complete');

            // Note: System Log stays collapsed by default - user can click to expand if needed
            console.log('System log available (click to expand)');

            // Disable button
            const parseBtn = document.getElementById('parseBtn');
            parseBtn.disabled = true;
            parseBtn.innerHTML = '<div class="spinner"></div> Processing...';

            addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            addLog('üöÄ Starting budget parsing process...');
            addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            // Determine funding body format
            let fundingBodyFormat = selectedFundingBody;

            if (selectedFundingBody === 'auto') {
                fundingBodyFormat = detectFundingBodyFormat(inputText);
                addLog(`üîç Auto-detected format: ${fundingBodyFormat.toUpperCase()}`);
            } else {
                addLog(`üìã Using selected format: ${fundingBodyFormat.toUpperCase()}`);
            }

            // Route to appropriate parser
            if (fundingBodyFormat === 'welshgov') {
                await parseWelshGovBudget(inputText, parseBtn);
                return;
            }

            if (fundingBodyFormat === 'simple_summary') {
                await parseSimpleSummaryBudget(inputText, parseBtn);
                return;
            }

            // Detect input type for IUK format
            const isDetailedBudget = inputText.toLowerCase().includes('labour') &&
                                    (inputText.toLowerCase().includes('finance summary') ||
                                     inputText.toLowerCase().includes('project duration'));

            try {
                if (isDetailedBudget) {
                    // DETAILED BUDGET PARSING (Parallel AI requests)
                    addLog('üìã Detected: DETAILED PROJECT BUDGET');
                    addLog('üîÑ Launching 6 parallel AI parsing requests...');

                    // Extract project info from first line if available
                    const firstLine = inputText.split('\n')[0];
                    console.log('First line of input:', firstLine);
                    addLog(`üìù First line: ${firstLine.substring(0, 100)}...`);

                    if (firstLine.includes(':')) {
                        const parts = firstLine.split(':');
                        projectBudget.projectNumber = parts[0].trim();
                        projectBudget.projectName = parts[1] ? parts[1].trim() : '';
                        console.log('Extracted projectNumber:', projectBudget.projectNumber);
                        console.log('Extracted projectName:', projectBudget.projectName);
                        addLog(`üìå Project Number: ${projectBudget.projectNumber}`);
                        addLog(`üìå Project Name: ${projectBudget.projectName}`);
                    } else {
                        console.log('First line does not contain ":", setting defaults');
                        projectBudget.projectNumber = 'PROJ-' + Date.now();
                        projectBudget.projectName = 'Unnamed Project';
                        addLog(`‚ö†Ô∏è No project identifier found in first line, using defaults`);
                        addLog(`üìå Default Project Number: ${projectBudget.projectNumber}`);
                    }

                    // Create 6 parallel AI requests
                    const promises = [
                        parseSection('financeSummary', inputText),
                        parseSection('labour', inputText),
                        parseSection('overheads', inputText),
                        parseSection('materials', inputText),
                        parseSection('capitalSubcontracting', inputText),
                        parseSection('travelOther', inputText)
                    ];

                    // Wait for all to complete
                    addLog('‚è≥ Waiting for all sections to parse...');
                    const results = await Promise.all(promises);
                    addLog('‚úÖ All sections parsed successfully!');

                    // Merge results into projectBudget
                    results.forEach(result => {
                        if (result.section === 'financeSummary') {
                            projectBudget.financeSummary = result.data;
                        } else if (result.section === 'labour') {
                            projectBudget.labour = result.data;
                        } else if (result.section === 'overheads') {
                            projectBudget.overheads = result.data;
                        } else if (result.section === 'materials') {
                            projectBudget.materials = result.data;
                        } else if (result.section === 'capitalSubcontracting') {
                            projectBudget.capitalUsage = result.data.capitalUsage;
                            projectBudget.subcontracting = result.data.subcontracting;
                        } else if (result.section === 'travelOther') {
                            projectBudget.travel = result.data.travel;
                            projectBudget.otherCosts = result.data.otherCosts;
                        }
                    });

                    // Set funding body for IUK projects
                    projectBudget.fundingBody = 'Innovate UK';

                    // Clear any Welsh Gov data to prevent mixing
                    if (projectBudget.welshGovData) {
                        delete projectBudget.welshGovData;
                    }

                    addLog('Merged all data into project budget');
                    console.log('Project Budget after merge:', projectBudget);
                    console.log('projectBudget.projectName:', projectBudget.projectName);
                    console.log('projectBudget.projectNumber:', projectBudget.projectNumber);
                    console.log('projectBudget.financeSummary:', projectBudget.financeSummary);

                    addLog(`‚úÖ Project Budget Complete:`);
                    addLog(`   ‚Ä¢ Project: ${projectBudget.projectName || projectBudget.projectNumber || 'Unknown'}`);
                    addLog(`   ‚Ä¢ Total Cost: ¬£${projectBudget.financeSummary?.totalCosts || 0}`);
                    addLog(`   ‚Ä¢ Labour: ${projectBudget.labour?.staff?.length || 0} staff members`);
                    addLog(`   ‚Ä¢ Materials: ${projectBudget.materials?.items?.length || 0} items`);

                    addLog('üíæ Auto-saving to IndexedDB...');

                    // Auto-save to IndexedDB
                    await saveToIndexedDB();

                    addLog('üé® Rendering detailed budget view...');
                    // Display detailed budget
                    await displayDetailedBudget();

                } else {
                    // SIMPLE QUARTERLY FORECAST PARSING (Old AI method)
                    addLog('üìã Detected: QUARTERLY FORECAST DATA');
                    addLog('ü§ñ Using standard AI parser...');

                    budgetData = [];

                    // Use the old AI parsing method (simplified version)
                    const apiKey = getAPIKey();
                    if (!apiKey) {
                        throw new Error('OpenAI API key not configured. Please set it in the settings.');
                    }

                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o',
                            messages: [{
                                role: 'system',
                                content: 'You are a budget parsing assistant. Parse budget text into JSON arrays with accurate categorization and cost extraction.'
                            }, {
                                role: 'user',
                                content: `Parse this budget text into JSON array format with Q1-Q4 quarterly data. Return ONLY valid JSON, no markdown.

Budget text:
${inputText}`
                            }],
                            temperature: 0.1,
                            max_tokens: 4096
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`API request failed: ${response.status}`);
                    }

                    const data = await response.json();
                    let responseText = data.choices[0].message.content.trim();

                    // Clean markdown
                    if (responseText.startsWith('```json')) {
                        responseText = responseText.replace(/^```json\n?/, '').replace(/\n?```$/, '');
                    } else if (responseText.startsWith('```')) {
                        responseText = responseText.replace(/^```\n?/, '').replace(/\n?```$/, '');
                    }

                    budgetData = JSON.parse(responseText);

                    // Add IDs
                    budgetData = budgetData.map((item, index) => ({
                        id: Date.now() + index,
                        ...item
                    }));

                    addLog(`‚úÖ Successfully parsed ${budgetData.length} budget items!`);

                    displayResults();
                    document.getElementById('results').classList.add('show');
                }

                addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                addLog('‚ú® Processing complete!');
                addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            } catch (error) {
                console.error('‚ùå PARSING ERROR:', error);
                addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                addLog(`‚ùå ERROR: ${error.message}`);
                addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                alert(`Parsing failed: ${error.message}`);
            } finally {
                console.log('Finally block: Re-enabling button');
                parseBtn.disabled = false;
                parseBtn.innerHTML = '<span>üìä</span> Parse Budget';
            }
        }

        function displayResults() {
            // Group by category
            const grouped = budgetData.reduce((acc, item) => {
                const cat = item.category || 'Other';
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(item);
                return acc;
            }, {});

            // Calculate totals
            const categoryTotals = {};
            let grandTotalEligible = 0;
            let grandTotalSpent = 0;
            let grandDifference = 0;

            for (const [category, items] of Object.entries(grouped)) {
                const totalEligible = items.reduce((sum, item) => sum + (item.totalEligible || item.forecast || 0), 0);
                const totalSpent = items.reduce((sum, item) => sum + (item.totalSpent || (item.q1 || 0) + (item.q2 || 0) + (item.q3 || 0) + (item.q4 || 0)), 0);
                const difference = totalEligible - totalSpent;
                
                categoryTotals[category] = { totalEligible, totalSpent, difference, count: items.length };
                grandTotalEligible += totalEligible;
                grandTotalSpent += totalSpent;
                grandDifference += difference;
            }

            // Display summary
            let summaryHTML = `
                <div class="summary-card total">
                    <div class="summary-category">üí∞ Total Eligible</div>
                    <div class="summary-amount">¬£${grandTotalEligible.toLocaleString()}</div>
                    <div class="summary-count">${budgetData.length} items</div>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                    <div class="summary-category" style="color: #1565c0;">üí≥ Total Spent</div>
                    <div class="summary-amount" style="color: #0d47a1;">¬£${grandTotalSpent.toLocaleString()}</div>
                    <div class="summary-count" style="color: #1976d2;">${((grandTotalSpent / grandTotalEligible) * 100).toFixed(1)}% of eligible</div>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, ${grandDifference < 0 ? '#ffebee 0%, #ffcdd2 100%' : '#e8f5e9 0%, #c8e6c9 100%'});">
                    <div class="summary-category" style="color: ${grandDifference < 0 ? '#c62828' : '#2e7d32'};">üíé Remaining</div>
                    <div class="summary-amount" style="color: ${grandDifference < 0 ? '#b71c1c' : '#1b5e20'};">¬£${grandDifference.toLocaleString()}</div>
                    <div class="summary-count" style="color: ${grandDifference < 0 ? '#d32f2f' : '#388e3c'};">${grandDifference < 0 ? 'OVER BUDGET!' : 'Within budget'}</div>
                </div>
            `;

            for (const [category, stats] of Object.entries(categoryTotals)) {
                const badgeClass = `badge-${category.toLowerCase().replace(' ', '')}`;
                const pct = stats.totalEligible > 0 ? ((stats.totalSpent / stats.totalEligible) * 100).toFixed(0) : 0;
                summaryHTML += `
                    <div class="summary-card">
                        <div class="category-badge ${badgeClass}">${category}</div>
                        <div class="summary-amount" style="font-size: 1.3em;">¬£${stats.totalEligible.toLocaleString()}</div>
                        <div class="summary-count">Eligible | ¬£${stats.totalSpent.toLocaleString()} spent (${pct}%)</div>
                    </div>
                `;
            }

            document.getElementById('summaryGrid').innerHTML = summaryHTML;

            // Display tables
            let tablesHTML = '';
            for (const [category, items] of Object.entries(grouped)) {
                const badgeClass = `badge-${category.toLowerCase().replace(' ', '')}`;
                const categoryStats = categoryTotals[category];
                const totalEligible = categoryStats.totalEligible;

                tablesHTML += `
                    <div class="category-section">
                        <div class="category-header">
                            <span class="category-badge ${badgeClass}">${category}</span>
                            <span class="category-total">¬£${totalEligible.toLocaleString()} eligible | ¬£${categoryStats.totalSpent.toLocaleString()} spent</span>
                        </div>
                        <table style="font-size: 0.85em;">
                            <thead>
                                <tr>
                                    <th style="width: 180px">Description</th>
                                    <th style="width: 60px">Qty</th>
                                    <th style="width: 50px">Unit</th>
                                    <th style="width: 80px">Unit ¬£</th>
                                    <th style="width: 90px; background: #e8f5e9;">Forecast</th>
                                    <th style="width: 75px; background: #fff3e0;">Q1</th>
                                    <th style="width: 75px; background: #fff3e0;">Q2</th>
                                    <th style="width: 75px; background: #fff3e0;">Q3</th>
                                    <th style="width: 75px; background: #fff3e0;">Q4</th>
                                    <th style="width: 100px; background: #e3f2fd; font-weight: 700;">Total Spent</th>
                                    <th style="width: 110px; background: #fff9c4; font-weight: 700;">Total Eligible</th>
                                    <th style="width: 100px; background: #fce4ec; font-weight: 700;">Difference</th>
                                    <th style="width: 120px">Notes</th>
                                    <th style="width: 35px"></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => {
                                    const forecast = item.forecast || item.totalCost || 0;
                                    const q1 = item.q1 || 0;
                                    const q2 = item.q2 || 0;
                                    const q3 = item.q3 || 0;
                                    const q4 = item.q4 || 0;
                                    const totalSpent = item.totalSpent || (q1 + q2 + q3 + q4);
                                    const totalEligible = item.totalEligible || forecast;
                                    const difference = item.difference !== undefined ? item.difference : (totalEligible - totalSpent);
                                    const rowStyle = difference < 0 ? 'background-color: #ffebee;' : '';

                                    return `
                                    <tr data-id="${item.id}" style="${rowStyle}">
                                        <td><input type="text" value="${item.description || ''}" onchange="updateItem(${item.id}, 'description', this.value)" style="font-size: 0.9em;"></td>
                                        <td><input type="number" value="${item.quantity || ''}" onchange="updateItem(${item.id}, 'quantity', parseFloat(this.value))" style="font-size: 0.9em;"></td>
                                        <td><input type="text" value="${item.unit || ''}" onchange="updateItem(${item.id}, 'unit', this.value)" style="font-size: 0.9em;"></td>
                                        <td><input type="number" value="${item.unitCost || ''}" onchange="updateItem(${item.id}, 'unitCost', parseFloat(this.value))" style="font-size: 0.9em;"></td>
                                        <td style="background: #f1f8e9;"><input type="number" value="${forecast}" onchange="updateItemAndRecalc(${item.id}, 'forecast', parseFloat(this.value))" style="font-weight: 600; background: #f1f8e9; font-size: 0.9em;"></td>
                                        <td style="background: #fff8e1;"><input type="number" value="${q1}" onchange="updateItemAndRecalc(${item.id}, 'q1', parseFloat(this.value) || 0)" style="font-size: 0.9em;"></td>
                                        <td style="background: #fff8e1;"><input type="number" value="${q2}" onchange="updateItemAndRecalc(${item.id}, 'q2', parseFloat(this.value) || 0)" style="font-size: 0.9em;"></td>
                                        <td style="background: #fff8e1;"><input type="number" value="${q3}" onchange="updateItemAndRecalc(${item.id}, 'q3', parseFloat(this.value) || 0)" style="font-size: 0.9em;"></td>
                                        <td style="background: #fff8e1;"><input type="number" value="${q4}" onchange="updateItemAndRecalc(${item.id}, 'q4', parseFloat(this.value) || 0)" style="font-size: 0.9em;"></td>
                                        <td style="background: #e1f5fe;"><input type="number" value="${totalSpent}" onchange="updateItemAndRecalc(${item.id}, \'totalSpent\', parseFloat(this.value) || 0)" style="font-weight: 600; background: #e1f5fe; font-size: 0.9em;"></td>
                                        <td style="background: #fff9e0;"><input type="number" value="${totalEligible}" onchange="updateItemAndRecalc(${item.id}, 'totalEligible', parseFloat(this.value) || 0)" style="font-weight: 600; background: #fff9e0; font-size: 0.9em;"></td>
                                        <td style="background: ${difference < 0 ? '#ffcdd2' : '#f3e5f5'}; font-weight: 600; color: ${difference < 0 ? '#c62828' : '#4a148c'}; text-align: right; padding-right: 8px; font-size: 0.9em;">¬£${difference.toLocaleString()}</td>
                                        <td><input type="text" value="${item.notes || ''}" onchange="updateItem(${item.id}, 'notes', this.value)" style="font-size: 0.9em;"></td>
                                        <td><button class="btn-danger" onclick="deleteItemWithConfirmation(this, ${item.id}); event.stopPropagation();" style="font-size: 0.8em; padding: 4px;">üóëÔ∏è</button></td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            document.getElementById('tablesContainer').innerHTML = tablesHTML;
            document.getElementById('results').classList.add('show');
        }

        // Save expanded state of all breakdown sections
        function saveExpandedState() {
            const expandedSections = [];
            document.querySelectorAll('[id$="-breakdown"]').forEach(row => {
                if (row.style.display !== 'none') {
                    expandedSections.push(row.id);
                }
            });
            return expandedSections;
        }

        // Restore expanded state after re-render
        function restoreExpandedState(expandedSections) {
            if (!expandedSections || expandedSections.length === 0) return;

            // Use setTimeout to ensure DOM has been updated
            setTimeout(() => {
                console.log('üóëÔ∏è [DELETE] Setting up click-outside listener with 100ms delay');
                expandedSections.forEach(id => {
                    const row = document.getElementById(id);
                    if (row) {
                        row.style.display = '';
                    }
                });
            }, 50);
        }

        async function displayDetailedBudget() {
            console.log('[DISPLAY] Displaying detailed budget');
            console.log('[DISPLAY] Funding Body:', projectBudget.fundingBody);
            addLog('üé® Rendering detailed budget sections...');

            // Save which sections are currently expanded
            const expandedSections = saveExpandedState();

            // Ensure transactions and invoices are loaded before displaying
            if (!cachedTransactions || cachedTransactions.length === 0) {
                console.log('‚è≥ [DISPLAY] Waiting for transactions to load...');
                cachedTransactions = await loadAllTransactions();
                console.log(`‚úÖ [DISPLAY] Transactions loaded: ${cachedTransactions.length}`);
            }

            if (!cachedInvoices || cachedInvoices.length === 0) {
                console.log('‚è≥ [DISPLAY] Waiting for invoices to load...');
                cachedInvoices = await loadInvoiceAttachments();
                console.log(`‚úÖ [DISPLAY] Invoices loaded: ${cachedInvoices.length}`);
            }

            console.log(`[DISPLAY] Ready to render with ${cachedTransactions.length} transactions and ${cachedInvoices.length} invoices`);

            // Initialize active quarter to previous quarter if not set
            if (activeQuarterIndex === null) {
                activeQuarterIndex = getPreviousQuarter();
                if (activeQuarterIndex) {
                    console.log(`[DISPLAY] Initialized active quarter to Q${activeQuarterIndex} (previous quarter)`);
                }
            }

            // Check if this is a Welsh Gov project
            const isWelshGov = projectBudget.fundingBody === 'Welsh Gov' || projectBudget.welshGovData;

            if (isWelshGov) {
                console.log('üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø [DISPLAY] Detected Welsh Gov project, using Welsh Gov renderer');

                if (projectBudget.welshGovData) {
                    displayWelshGovBudget(projectBudget.welshGovData);
                    document.getElementById('detailedBudgetResults').classList.add('show');
                    addLog('‚úÖ Welsh Gov budget displayed');
                    // Restore expanded state
                    restoreExpandedState(expandedSections);
                } else {
                    console.warn('‚ö†Ô∏è [DISPLAY] Welsh Gov project but no welshGovData found');
                    addLog('‚ö†Ô∏è Welsh Gov data missing - may need to re-parse');
                }
                return;
            }

            // IUK project rendering
            console.log('üá¨üáß [DISPLAY] Detected IUK project, using IUK renderer');

            // Populate project name and number input fields
            const projectNameInput = document.getElementById('projectNameInput');
            const projectNumberInput = document.getElementById('projectNumberInput');
            if (projectNameInput) {
                projectNameInput.value = projectBudget.projectName || '';
            }
            if (projectNumberInput) {
                projectNumberInput.value = projectBudget.projectNumber || '';
            }

            // For now, create a simple display
            const detailedResults = document.getElementById('detailedBudgetResults');
            if (!detailedResults) {
                console.error('detailedBudgetResults element not found!');
                alert('Note: Detailed budget HTML structure not yet added. Data is parsed and saved successfully!\n\nCheck console for projectBudget object.');
                console.log('PROJECT BUDGET DATA:', projectBudget);
                return;
            }

            // Finance Summary with null checks for IUK
            const financeSummary = document.getElementById('financeSummarySection');
            if (financeSummary) {
                const fs = projectBudget.financeSummary || {};

                // Generate month options
                const months = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
                const monthOptions = months.map((m, i) =>
                    `<option value="${i+1}" ${fs.projectStartMonth === i+1 ? 'selected' : ''}>${m}</option>`
                ).join('');

                // Generate year options (current year - 5 to current year + 5)
                const currentYear = new Date().getFullYear();
                const yearOptions = [];
                for (let y = currentYear - 5; y <= currentYear + 5; y++) {
                    yearOptions.push(`<option value="${y}" ${fs.projectStartYear === y ? 'selected' : ''}>${y}</option>`);
                }

                const projectName = projectBudget.projectName || 'Unnamed Project';
                const totalCosts = fs.totalCosts || 0;

                // Calculate total costs claimed and remaining budget
                const totalCostsClaimed = getTotalBudgetSummary();
                const budgetRemaining = totalCosts - totalCostsClaimed;

                // Format start date
                const startMonth = fs.projectStartMonth ? months[fs.projectStartMonth - 1] : '';
                const startYear = fs.projectStartYear || '';
                const startDate = startMonth && startYear ? `${startMonth} ${startYear}` : 'Not set';

                // Get duration
                const duration = fs.projectDuration || 'Not set';

                financeSummary.innerHTML = `
                    <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 onclick="toggleCategorySection('finance-summary-details')" style="margin: 0 0 15px 0; font-size: 1.1em; color: #1e293b; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
                            <span id="finance-summary-arrow" style="display: inline-block; width: 20px;">‚ñ∂</span>
                            <span>Project Budget: ${projectName} | Start: ${startDate} | Duration: ${duration} | Budget: ¬£${totalCosts.toLocaleString()} | Remaining: <span style="color: ${budgetRemaining < 0 ? '#d32f2f' : '#2e7d32'};">¬£${budgetRemaining.toLocaleString()}</span></span>
                        </h3>

                        <div id="finance-summary-details" style="display: none;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px;">
                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px; border-left: 3px solid #3b82f6;">
                                <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Duration</div>
                                <div style="font-size: 1.1em; font-weight: 600; color: #1e293b;">${fs.projectDuration || 'N/A'}</div>
                            </div>

                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px; border-left: 3px solid #10b981;">
                                <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Total Costs</div>
                                <div style="font-size: 1.1em; font-weight: 600; color: #1e293b;">¬£${(fs.totalCosts || 0).toLocaleString()}</div>
                            </div>

                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px; border-left: 3px solid #f59e0b;">
                                <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Funding Level</div>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <input type="number" id="fundingLevelInput" value="${fs.fundingLevel || 0}"
                                           min="0" max="100" onchange="updateFundingLevel()"
                                           style="width: 60px; padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 1em; font-weight: 600;"
                                           placeholder="0">
                                    <span style="font-size: 1.1em; font-weight: 600; color: #1e293b;">%</span>
                                </div>
                            </div>

                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px; border-left: 3px solid #8b5cf6;">
                                <div style="font-size: 0.75em; color: #64748b; font-weight: 500; margin-bottom: 4px; text-transform: uppercase;">Funding Sought</div>
                                <div style="font-size: 1.1em; font-weight: 600; color: #1e293b;">¬£${(fs.fundingSought || 0).toLocaleString()}</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 12px; align-items: center; padding: 12px; background: #f8fafc; border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.85em; color: #64748b; font-weight: 500; white-space: nowrap;">Project Start:</label>
                                <select id="projectStartMonth" onchange="updateProjectStartDate()" style="padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.9em; background: white;">
                                    <option value="">Month</option>
                                    ${monthOptions}
                                </select>
                                <select id="projectStartYear" onchange="updateProjectStartDate()" style="padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.9em; background: white;">
                                    <option value="">Year</option>
                                    ${yearOptions.join('')}
                                </select>
                            </div>

                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.85em; color: #64748b; font-weight: 500; white-space: nowrap;">Duration:</label>
                                <input type="number" id="projectDurationMonths" value="${fs.projectDurationMonths || ''}"
                                       min="1" max="120" onchange="updateProjectDuration()"
                                       style="width: 70px; padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.9em;"
                                       placeholder="12">
                                <span style="font-size: 0.85em;">months</span>
                                ${fs.projectStartMonth && fs.projectDurationMonths ?
                                    `<span style="color: #64748b; font-size: 0.85em;">(Ends: ${calculateEndDate(fs.projectStartMonth, fs.projectStartYear, fs.projectDurationMonths)})</span>` :
                                    ''}
                            </div>
                        </div>
                        </div>
                    </div>
                `;
            }

            // Calculate quarters once for all sections
            const quarters = calculateQuarters();
            const hasQuarters = quarters.length > 0;
            const currentQuarter = getCurrentQuarter();

            // Quarter Controls Section
            const quarterControlsSection = document.getElementById('quarterControlsSection');
            if (quarterControlsSection) {

                if (quarters.length > 0) {
                    let quarterControlsHTML = `
                        <div class="category-section" style="margin-bottom: 15px;">
                            <h3 onclick="toggleCategorySection('quarterly-tracking-details')" style="cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span id="quarterly-tracking-arrow" style="display: inline-block; width: 20px;">‚ñ∂</span>
                                    Quarterly Budget Tracking
                                </div>
                                ${currentQuarter ? `
                                    <span style="background: #e0e7ff; color: #4338ca; padding: 4px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 500;">
                                        Current: Q${currentQuarter}
                                    </span>
                                ` : ''}
                            </h3>

                            <div id="quarterly-tracking-details" style="display: none;">
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin: 12px 0; padding: 12px; background: #f8fafc; border-radius: 6px;">
                                <span style="font-size: 0.85em; color: #475569; font-weight: 500;">Activate Quarter:</span>
                    `;

                    quarters.forEach(quarter => {
                        const isCurrentQuarter = currentQuarter === quarter.index;
                        const isActive = activeQuarterIndex === quarter.index;

                        quarterControlsHTML += `
                            <button
                                class="quarter-activate-btn"
                                data-quarter="${quarter.index}"
                                onclick="setActiveQuarter(${quarter.index})"
                                style="
                                    padding: 6px 14px;
                                    border-radius: 6px;
                                    border: ${isActive ? '2px solid #f59e0b' : (isCurrentQuarter ? '2px solid #3AAFA9' : '1px solid #cbd5e1')};
                                    background: ${isActive ? '#f59e0b' : (isCurrentQuarter ? '#3AAFA9' : 'white')};
                                    color: ${isActive || isCurrentQuarter ? 'white' : '#475569'};
                                    font-weight: 600;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                    font-size: 0.85em;
                                "
                                onmouseover="if(!${isActive} && !${isCurrentQuarter}) { this.style.background='#f8fafc'; this.style.borderColor='#94a3b8'; }"
                                onmouseout="if(!${isActive}) this.style.background='${isCurrentQuarter ? '#3AAFA9' : 'white'}'; if(!${isActive}) this.style.borderColor='${isCurrentQuarter ? '#3AAFA9' : '#cbd5e1'}'"
                            >
                                ${quarter.label}
                            </button>
                        `;
                    });

                    quarterControlsHTML += `
                            </div>
                    `;

                    // Add transaction table for active quarter
                    if (activeQuarterIndex && cachedTransactions && cachedTransactions.length > 0) {
                        quarterControlsHTML += renderActiveQuarterTransactions(activeQuarterIndex, cachedTransactions, cachedInvoices || []);
                    }

                    quarterControlsHTML += `
                            </div>
                        </div>
                    `;

                    quarterControlsSection.innerHTML = quarterControlsHTML;
                } else {
                    quarterControlsSection.innerHTML = `
                        <div style="background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 16px; margin-bottom: 15px; text-align: center;">
                            <p style="margin: 0; color: #64748b; font-size: 0.9em;">
                                ‚ÑπÔ∏è Set Project Start Date and Duration in Finance Summary to enable quarterly tracking
                            </p>
                        </div>
                    `;
                }
            }

            // Labour Section
            const labourSection = document.getElementById('labourSection');
            // Show Labour section if there are staff entries OR if there's a total cost (for Simple Summary format)
            if (labourSection && (projectBudget.labour.staff.length > 0 || projectBudget.labour.totalCost > 0)) {
                let labourHTML = `
                    <div class="category-section">
                        <h3 onclick="toggleCategorySection('labour-details')" style="cursor: pointer; user-select: none;">
                            <span id="labour-arrow" style="display: inline-block; width: 20px;">‚ñ∂</span>
                            Labour (¬£${projectBudget.labour.totalCost.toLocaleString()})
                        </h3>
                        <div id="labour-details" style="display: none;">
                            <p style="color: #64748b; font-size: 0.9em; margin-bottom: 16px;">Working days per year: ${projectBudget.labour.workingDaysPerYear}</p>
                            <div class="item-table-container">
                            <table class="item-table">
                            <thead>
                                <tr>
                                    <th style="width: 30px;"></th>
                                    <th>Role</th>
                                    <th>Gross Cost</th>
                                    <th>Rate/Day</th>
                                    <th>Days</th>
                                    <th>Total</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                    <th style="width: 60px;">Delete</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Check if we have staff breakdown or just a total cost
                if (projectBudget.labour.staff.length === 0 && projectBudget.labour.totalCost > 0) {
                    // Simple Summary format: Show just the total without breakdown
                    labourHTML += `
                        <tr>
                            <td colspan="${hasQuarters ? '8' : '5'}" style="text-align: center; padding: 20px; color: #64748b; font-style: italic;">
                                Total Labour Cost: ¬£${projectBudget.labour.totalCost.toLocaleString()}
                                <br><br>
                                <span style="font-size: 0.85em;">No detailed staff breakdown available for this project format.</span>
                            </td>
                        </tr>
                    `;
                }

                projectBudget.labour.staff.forEach((staff, index) => {
                    initializeQuarterlyCosts(staff);
                    const itemKey = `labour-${index}`;
                    const costsClaimed = getItemClaimedFromTransactions(projectBudget.projectId, 'Labour', itemKey);
                    const remaining = staff.totalCost - costsClaimed;
                    const difference = staff.totalCost > 0 ? ((costsClaimed - staff.totalCost) / staff.totalCost) * 100 : 0;
                    const isOverBudget = costsClaimed > staff.totalCost;

                    labourHTML += `
                        <tr style="${isOverBudget && hasQuarters ? 'background: #fee;' : ''}"
                            draggable="true"
                            ondragstart="handleDragStart(event, 'labour.staff', ${index})"
                            ondragover="handleDragOver(event, 'labour.staff', ${index})"
                            ondragleave="handleDragLeave(event)"
                            ondrop="handleDrop(event, 'labour.staff', ${index})"
                            ondragend="handleDragEnd(event)">
                            <td class="drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</td>
                            <td onclick="toggleQuarterlyBreakdown('labour-${index}')" style="cursor: pointer;">${staff.role}</td>
                            <td onclick="toggleQuarterlyBreakdown('labour-${index}')" style="cursor: pointer;">¬£${staff.grossCost.toLocaleString()}</td>
                            <td onclick="toggleQuarterlyBreakdown('labour-${index}')" style="cursor: pointer;">¬£${staff.ratePerDay}</td>
                            <td onclick="toggleQuarterlyBreakdown('labour-${index}')" style="cursor: pointer;">${staff.days}</td>
                            <td onclick="toggleQuarterlyBreakdown('labour-${index}')" style="cursor: pointer;">¬£${staff.totalCost.toLocaleString()}</td>
                            ${hasQuarters ? `
                                <td onclick="toggleQuarterlyBreakdown('labour-${index}')" style="cursor: pointer; ${isOverBudget ? 'color: #d32f2f; font-weight: 600;' : ''}">¬£${costsClaimed.toLocaleString()}</td>
                                <td onclick="toggleQuarterlyBreakdown('labour-${index}')" style="cursor: pointer; ${remaining < 0 ? 'color: #d32f2f; font-weight: 600;' : ''}">¬£${remaining.toLocaleString()}</td>
                                <td onclick="toggleQuarterlyBreakdown('labour-${index}')" style="cursor: pointer; ${difference > 0 ? 'color: #d32f2f; font-weight: 600;' : ''}">${difference.toFixed(1)}%</td>
                            ` : ''}
                            <td style="text-align: center;">
                                <button onclick="event.stopPropagation(); deleteCategoryItem(this, 'labour.staff', ${index}, 'Labour');"
                                        style="background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background-color 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'"
                                        title="Delete this item">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                        ${hasQuarters ? `
                        <tr id="labour-${index}-breakdown" style="display: none;">
                            <td colspan="${hasQuarters ? '10' : '7'}" style="padding: 0; background: transparent;">
                                <div class="quarterly-breakdown-container">
                                    <h4 class="quarterly-breakdown-header">Quarterly Breakdown - ${staff.role}</h4>
                                    <table class="quarterly-breakdown-table">
                                        <thead>
                                            <tr style="background: #e2e8f0;">
                                                <th style="width: 150px;">Metric</th>
                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                ${quarters.map(q => `
                                                    <td data-quarter="${q.index}">
                                                        <input
                                                            type="number"
                                                            value="${staff.quarterlyCosts[`q${q.index}`] || 0}"
                                                            onchange="updateQuarterlyCost(projectBudget.labour.staff[${index}], ${q.index}, this.value); displayDetailedBudget();"
                                                            onclick="event.stopPropagation()"
                                                            style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                        />
                                                    </td>
                                                `).join('')}
                                            </tr>
                                            <tr style="background: #f1f5f9;">
                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                    ¬£${remaining.toLocaleString()}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 600;">Difference (%)</td>
                                                <td colspan="${quarters.length}" style="font-weight: 600; color: ${difference > 0 ? '#d32f2f' : '#2e7d32'};">
                                                    ${difference.toFixed(1)}%
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                        ` : ''}
                    `;
                });

                // Add category summary row (only if there are staff members with breakdown)
                if (hasQuarters && projectBudget.labour.staff.length > 0) {
                    const summary = getCategorySummary(projectBudget.labour.staff, 'Labour', 'labour');
                    const isSummaryOverBudget = summary.totalClaimed > summary.totalCosts;

                    // Initialize category forecast if it doesn't exist
                    if (!projectBudget.labour.categoryForecast) {
                        projectBudget.labour.categoryForecast = {'q1': 0, 'q2': 0, 'q3': 0, 'q4': 0};
                    }

                    labourHTML += `
                        <tr onclick="toggleQuarterlyBreakdown('labour-summary')" class="category-summary-row ${isSummaryOverBudget ? 'over-budget' : ''}">
                            <td colspan="4" style="text-align: right; padding-right: 15px;">LABOUR CATEGORY TOTAL:</td>
                            <td>¬£${summary.totalCosts.toLocaleString()}</td>
                            <td ${isSummaryOverBudget ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.totalClaimed.toLocaleString()}</td>
                            <td ${summary.remaining < 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.remaining.toLocaleString()}</td>
                            <td ${summary.difference > 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>${summary.difference.toFixed(1)}%</td>
                        </tr>
                        <tr id="labour-summary-breakdown" style="display: none;">
                            <td colspan="8" style="padding: 0; background: transparent;">
                                <div class="quarterly-breakdown-container">
                                    <h4 class="quarterly-breakdown-header">Labour Category - Quarterly Breakdown</h4>
                                    <table class="quarterly-breakdown-table">
                                        <thead>
                                            <tr style="background: #bbdefb;">
                                                <th style="width: 150px;">Metric</th>
                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                ${quarters.map(q => {
                                                    const qClaimed = summary.quarterlyTotals[`q${q.index}`] || 0;
                                                    return `
                                                        <td data-quarter="${q.index}">
                                                            <input
                                                                type="number"
                                                                value="${qClaimed}"
                                                                onchange="updateCategoryQuarterlyCost(projectBudget.labour.staff, ${q.index}, parseFloat(this.value) || 0, 'Labour', 'labour'); displayDetailedBudget();"
                                                                onkeypress="if(event.key==='Enter'){event.preventDefault();const val=this.value;updateCategoryQuarterlyCost(projectBudget.labour.staff, ${q.index}, parseFloat(val) || 0, 'Labour', 'labour'); displayDetailedBudget();}"
                                                                onclick="event.stopPropagation()"
                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600;"
                                                                step="0.01"
                                                            />
                                                        </td>
                                                    `;
                                                }).join('')}
                                                <td style="font-weight: 700; background: #e3f2fd;">¬£${summary.totalClaimed.toLocaleString()}</td>
                                            </tr>
                                            <tr style="background: #f1f5f9;">
                                                <td style="font-weight: 600; cursor: pointer; color: #3AAFA9; user-select: none;"
                                                    onclick="event.stopPropagation(); const success = calculateCategoryForecast(projectBudget.labour.staff, projectBudget.labour.categoryForecast); if(success) { refreshForecastUI(event.target, projectBudget.labour.categoryForecast, projectBudget.labour.staff); } else { alert('No empty quarters to forecast or no budget remaining.'); }"
                                                    title="Click to calculate forecast for empty quarters">
                                                    <span style="font-size: 1.1em;">üîÑ</span> Forecast
                                                </td>
                                                ${quarters.map(q => {
                                                    const forecast = projectBudget.labour.categoryForecast['q' + q.index] || 0;
                                                    return `
                                                        <td data-quarter="${q.index}">
                                                            <input
                                                                type="number"
                                                                value="${forecast.toFixed(2)}"
                                                                onchange="updateCategoryForecast(projectBudget.labour.categoryForecast, ${q.index}, this.value); displayDetailedBudget();"
                                                                onclick="event.stopPropagation()"
                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600;"
                                                            />
                                                        </td>
                                                    `;
                                                }).join('')}
                                                <td style="font-weight: 700; background: #e3f2fd;">
                                                    ¬£${getTotalForecast(projectBudget.labour.categoryForecast).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 600;">Total Budget</td>
                                                ${quarters.map(q => `<td></td>`).join('')}
                                                <td style="font-weight: 700; background: #e3f2fd;">¬£${summary.totalCosts.toLocaleString()}</td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                ${quarters.map(q => `<td></td>`).join('')}
                                                <td style="font-weight: 700; background: #e3f2fd; color: ${(summary.remaining - getTotalForecast(projectBudget.labour.categoryForecast)) < 0 ? '#d32f2f' : '#2e7d32'};">
                                                    ¬£${(summary.remaining - getTotalForecast(projectBudget.labour.categoryForecast)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                </td>
                                            </tr>
                                            <tr style="background: #f1f5f9;">
                                                <td style="font-weight: 600;">Difference (%)</td>
                                                ${quarters.map(q => `<td></td>`).join('')}
                                                <td style="font-weight: 700; background: #e3f2fd; color: ${summary.difference > 0 ? '#d32f2f' : '#2e7d32'};">
                                                    ${summary.difference.toFixed(1)}%
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                    `;
                }

                labourHTML += `
                            </tbody>
                        </table>
                        </div>
                        <div style="margin-top: 12px; text-align: left;">
                            <button onclick="openAddItemModal('labour')"
                                    style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; display: inline-flex; align-items: center; gap: 6px;"
                                    onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                ‚ûï Add Labour Item
                            </button>
                        </div>
                        </div>
                    </div>
                `;
                labourSection.innerHTML = labourHTML;
            }

            // Overheads & Materials Section
            const overheadsMaterialsSection = document.getElementById('overheadsMaterialsSection');
            if (overheadsMaterialsSection) {
                let overheadsMaterialsHTML = `
                    <div class="category-section">
                        <h3 onclick="toggleCategorySection('overheads-details')" style="cursor: pointer; user-select: none;">
                            <span id="overheads-arrow" style="display: inline-block; width: 20px;">‚ñ∂</span>
                            Overhead Costs (¬£${projectBudget.overheads.totalCost.toLocaleString()})
                        </h3>
                        <div id="overheads-details" style="display: none;">
                            <table>
                                <tr>
                                    <th>Description</th>
                                    <td>${projectBudget.overheads.percentage}% of labour costs</td>
                                </tr>
                                <tr>
                                    <th>Labour Costs</th>
                                    <td>¬£${projectBudget.overheads.labourCosts.toLocaleString()}</td>
                                </tr>
                                <tr>
                                    <th>Total Overhead Costs</th>
                                    <td>¬£${projectBudget.overheads.totalCost.toLocaleString()}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <div class="category-section" style="margin-top: 20px;">
                        <h3 onclick="toggleCategorySection('materials-details')" style="cursor: pointer; user-select: none;">
                            <span id="materials-arrow" style="display: inline-block; width: 20px;">‚ñ∂</span>
                            Materials (¬£${projectBudget.materials.totalCost.toLocaleString()})
                        </h3>
                        <div id="materials-details" style="display: none;">
                        ${projectBudget.materials.items.length > 0 ? `
                        <div class="item-table-container">
                        <table class="item-table">
                            <thead>
                                <tr>
                                    <th style="width: 30px;"></th>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Cost Per Item</th>
                                    <th>Total</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                    <th style="width: 60px;">Delete</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${projectBudget.materials.items.map((item, index) => {
                                    initializeQuarterlyCosts(item);
                                    const itemKey = `materials-${index}`;
                                    const costsClaimed = getItemClaimedFromTransactions(projectBudget.projectId, 'Materials', itemKey);
                                    const remaining = item.total - costsClaimed;
                                    const difference = item.total > 0 ? ((costsClaimed - item.total) / item.total) * 100 : 0;
                                    const isOverBudget = costsClaimed > item.total;

                                    return `
                                        <tr style="${isOverBudget && hasQuarters ? 'background: #fee;' : ''}"
                                            draggable="true"
                                            ondragstart="handleDragStart(event, 'materials.items', ${index})"
                                            ondragover="handleDragOver(event, 'materials.items', ${index})"
                                            ondragleave="handleDragLeave(event)"
                                            ondrop="handleDrop(event, 'materials.items', ${index})"
                                            ondragend="handleDragEnd(event)">
                                            <td class="drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</td>
                                            <td onclick="toggleQuarterlyBreakdown('materials-${index}')" style="cursor: pointer;">${item.item}</td>
                                            <td onclick="toggleQuarterlyBreakdown('materials-${index}')" style="cursor: pointer;">${item.quantity}</td>
                                            <td onclick="toggleQuarterlyBreakdown('materials-${index}')" style="cursor: pointer;">¬£${item.costPerItem.toLocaleString()}</td>
                                            <td onclick="toggleQuarterlyBreakdown('materials-${index}')" style="cursor: pointer;">¬£${item.total.toLocaleString()}</td>
                                            ${hasQuarters ? `
                                                <td onclick="toggleQuarterlyBreakdown('materials-${index}')" style="cursor: pointer; ${isOverBudget ? 'color: #d32f2f; font-weight: 600;' : ''}">¬£${costsClaimed.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('materials-${index}')" style="cursor: pointer; ${remaining < 0 ? 'color: #d32f2f; font-weight: 600;' : ''}">¬£${remaining.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('materials-${index}')" style="cursor: pointer; ${difference > 0 ? 'color: #d32f2f; font-weight: 600;' : ''}">${difference.toFixed(1)}%</td>
                                            ` : ''}
                                            <td style="text-align: center;">
                                                <button onclick="event.stopPropagation(); deleteCategoryItem(this, 'materials.items', ${index}, 'Materials');"
                                                        style="background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background-color 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'"
                                                        title="Delete this item">
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                        </tr>
                                        ${hasQuarters ? `
                                        <tr id="materials-${index}-breakdown" style="display: none;">
                                            <td colspan="${hasQuarters ? '9' : '6'}" style="padding: 0; background: transparent;">
                                                <div class="quarterly-breakdown-container">
                                                    <div id="quarterly-table-materials-${index}" style="display: none;">
                                                        <h4 class="quarterly-breakdown-header">Quarterly Breakdown - ${item.item}</h4>
                                                        <table class="quarterly-breakdown-table">
                                                            <thead>
                                                                <tr style="background: #e2e8f0;">
                                                                    <th style="width: 150px;">Metric</th>
                                                                    ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td style="font-weight: 600;">Costs Claimed</td>
                                                                    ${quarters.map(q => `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${item.quarterlyCosts['q' + q.index] || 0}"
                                                                                onchange="updateQuarterlyCost(projectBudget.materials.items[${index}], ${q.index}, this.value); displayDetailedBudget();"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                                            />
                                                                        </td>
                                                                    `).join('')}
                                                                </tr>
                                                                <tr style="background: #f1f5f9;">
                                                                    <td style="font-weight: 600;">Budget Remaining</td>
                                                                    <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                        ¬£${remaining.toLocaleString()}
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td style="font-weight: 600;">Difference (%)</td>
                                                                    <td colspan="${quarters.length}" style="font-weight: 600; color: ${difference > 0 ? '#d32f2f' : '#2e7d32'};">
                                                                        ${difference.toFixed(1)}%
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    ${(() => {
                                                        // Render transaction details for this Materials item
                                                        if (cachedTransactions && cachedTransactions.length > 0) {
                                                            const itemTransactions = getTransactionsForItem(
                                                                cachedTransactions,
                                                                projectBudget.projectId,
                                                                'Materials',
                                                                'materials-' + index,
                                                                null // null = show all quarters
                                                            );
                                                            return renderTransactionDetails(
                                                                itemTransactions,
                                                                projectBudget.projectId,
                                                                'Materials',
                                                                'materials-' + index,
                                                                null,
                                                                cachedInvoices || []
                                                            );
                                                        }
                                                        return '';
                                                    })()}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    `;
                                }).join('')}

                                ${hasQuarters && projectBudget.materials.items.length > 0 ? (() => {
                                    const summary = getCategorySummary(projectBudget.materials.items, 'Materials', 'materials');
                                    const isSummaryOverBudget = summary.totalClaimed > summary.totalCosts;

                                    // Initialize category forecast if it doesn't exist
                                    if (!projectBudget.materials.categoryForecast) {
                                        projectBudget.materials.categoryForecast = {'q1': 0, 'q2': 0, 'q3': 0, 'q4': 0};
                                    }

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('materials-summary')" class="category-summary-row ${isSummaryOverBudget ? 'over-budget' : ''}">
                                            <td colspan="3" style="text-align: right; padding-right: 15px;">MATERIALS CATEGORY TOTAL:</td>
                                            <td>¬£${summary.totalCosts.toLocaleString()}</td>
                                            <td ${isSummaryOverBudget ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.totalClaimed.toLocaleString()}</td>
                                            <td ${summary.remaining < 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.remaining.toLocaleString()}</td>
                                            <td ${summary.difference > 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>${summary.difference.toFixed(1)}%</td>
                                        </tr>
                                        <tr id="materials-summary-breakdown" style="display: none;">
                                            <td colspan="7" style="padding: 0; background: transparent;">
                                                <div class="quarterly-breakdown-container">
                                                    <h4 class="quarterly-breakdown-header">Materials Category - Quarterly Breakdown</h4>
                                                    <table class="quarterly-breakdown-table">
                                                        <thead>
                                                            <tr style="background: #c8e6c9;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                <th>Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => {
                                                                    const qClaimed = summary.quarterlyTotals['q' + q.index] || 0;
                                                                    return `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${qClaimed}"
                                                                                onchange="updateCategoryQuarterlyCost(projectBudget.materials.items, ${q.index}, parseFloat(this.value) || 0, 'Materials', 'materials'); displayDetailedBudget();"
                                                                                onkeypress="if(event.key==='Enter'){event.preventDefault();const val=this.value;updateCategoryQuarterlyCost(projectBudget.materials.items, ${q.index}, parseFloat(val) || 0, 'Materials', 'materials'); displayDetailedBudget();}"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600;"
                                                                                step="0.01"
                                                                            />
                                                                        </td>
                                                                    `;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #e8f5e9;">¬£${summary.totalClaimed.toLocaleString()}</td>
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600; cursor: pointer; color: #3AAFA9; user-select: none;"
                                                                    onclick="event.stopPropagation(); const success = calculateCategoryForecast(projectBudget.materials.items, projectBudget.materials.categoryForecast); if(success) { refreshForecastUI(event.target, projectBudget.materials.categoryForecast, projectBudget.materials.items); } else { alert('No empty quarters to forecast or no budget remaining.'); }"
                                                                    title="Click to calculate forecast for empty quarters">
                                                                    <span style="font-size: 1.1em;">üîÑ</span> Forecast
                                                                </td>
                                                                ${quarters.map(q => {
                                                                    const forecast = projectBudget.materials.categoryForecast['q' + q.index] || 0;
                                                                    return `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${forecast.toFixed(2)}"
                                                                                onchange="updateCategoryForecast(projectBudget.materials.categoryForecast, ${q.index}, this.value); displayDetailedBudget();"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600;"
                                                                            />
                                                                        </td>
                                                                    `;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #e8f5e9;">
                                                                    ¬£${getTotalForecast(projectBudget.materials.categoryForecast).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td style="font-weight: 600;">Total Budget</td>
                                                                ${quarters.map(q => `<td></td>`).join('')}
                                                                <td style="font-weight: 700; background: #e8f5e9;">¬£${summary.totalCosts.toLocaleString()}</td>
                                                            </tr>
                                                            <tr>
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                ${quarters.map(q => `<td></td>`).join('')}
                                                                <td style="font-weight: 700; background: #e8f5e9; color: ${(summary.remaining - getTotalForecast(projectBudget.materials.categoryForecast)) < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${(summary.remaining - getTotalForecast(projectBudget.materials.categoryForecast)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                                </td>
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600;">Difference (%)</td>
                                                                ${quarters.map(q => `<td></td>`).join('')}
                                                                <td style="font-weight: 700; background: #e8f5e9; color: ${summary.difference > 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ${summary.difference.toFixed(1)}%
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                })() : ''}
                            </tbody>
                        </table>
                        </div>
                        ` : '<p style="color: #94a3b8; font-style: italic;">No materials items</p>'}

                        ${(() => {
                            // Always show assigned transactions for Materials, even if no budget items
                            if (cachedTransactions && cachedTransactions.length > 0) {
                                const categoryTransactions = getTransactionsForItem(
                                    cachedTransactions,
                                    projectBudget.projectId,
                                    'Materials',
                                    null,  // No specific item - get all Materials transactions
                                    null   // All quarters
                                );
                                if (categoryTransactions.length > 0) {
                                    return renderTransactionDetails(
                                        categoryTransactions,
                                        projectBudget.projectId,
                                        'Materials',
                                        'materials-all',
                                        null,
                                        cachedInvoices || []
                                    );
                                }
                            }
                            return '';
                        })()}
                        <div style="margin-top: 12px; text-align: left;">
                            <button onclick="openAddItemModal('materials')"
                                    style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; display: inline-flex; align-items: center; gap: 6px;"
                                    onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                ‚ûï Add Materials Item
                            </button>
                        </div>
                        </div>
                    </div>
                `;
                overheadsMaterialsSection.innerHTML = overheadsMaterialsHTML;
            }

            // Capital & Subcontracting Section
            const capitalSubcontractingSection = document.getElementById('capitalSubcontractingSection');
            if (capitalSubcontractingSection) {
                let capitalSubHTML = `
                    <div class="category-section">
                        <h3 onclick="toggleCategorySection('capital-details')" style="cursor: pointer; user-select: none;">
                            <span id="capital-arrow" style="display: inline-block; width: 20px;">‚ñ∂</span>
                            Capital Usage (¬£${projectBudget.capitalUsage.totalCost.toLocaleString()})
                        </h3>
                        <div id="capital-details" style="display: none;">
                        ${projectBudget.capitalUsage.items && projectBudget.capitalUsage.items.length > 0 ? `
                        <div class="item-table-container"><table class="item-table">
                            <thead>
                                <tr>
                                    <th>Item Description</th>
                                    <th>New or Existing</th>
                                    <th>Utilisation %</th>
                                    <th>Net Cost</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                    <th style="width: 60px;">Delete</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${projectBudget.capitalUsage.items.map((item, index) => {
                                    // Ensure netCost is treated as the total cost
                                    if (!item.totalCost && item.netCost) {
                                        item.totalCost = item.netCost;
                                    }
                                    initializeQuarterlyCosts(item);
                                    const itemKey = `capitalUsage-${index}`;
                                    const costsClaimed = getItemClaimedFromTransactions(projectBudget.projectId, 'Capital Usage', itemKey);
                                    const remaining = item.netCost - costsClaimed;
                                    const difference = item.netCost > 0 ? ((costsClaimed - item.netCost) / item.netCost) * 100 : 0;
                                    const isOverBudget = costsClaimed > item.netCost;

                                    return `
                                        <tr style="${isOverBudget && hasQuarters ? 'background: #fee;' : ''}">
                                            <td onclick="toggleQuarterlyBreakdown('capital-${index}')" style="cursor: pointer;">${item.description}</td>
                                            <td onclick="toggleQuarterlyBreakdown('capital-${index}')" style="cursor: pointer;">${item.newOrExisting}</td>
                                            <td onclick="toggleQuarterlyBreakdown('capital-${index}')" style="cursor: pointer;">${item.utilisation}%</td>
                                            <td onclick="toggleQuarterlyBreakdown('capital-${index}')" style="cursor: pointer;">¬£${item.netCost.toLocaleString()}</td>
                                            ${hasQuarters ? `
                                                <td onclick="toggleQuarterlyBreakdown('capital-${index}')" style="cursor: pointer; ${isOverBudget ? 'color: #d32f2f; font-weight: 600;' : ''}">¬£${costsClaimed.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('capital-${index}')" style="cursor: pointer; ${remaining < 0 ? 'color: #d32f2f; font-weight: 600;' : ''}">¬£${remaining.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('capital-${index}')" style="cursor: pointer; ${difference > 0 ? 'color: #d32f2f; font-weight: 600;' : ''}">${difference.toFixed(1)}%</td>
                                            ` : ''}
                                            <td style="text-align: center;">
                                                <button onclick="event.stopPropagation(); deleteCategoryItem(this, 'capitalUsage.items', ${index}, 'Capital Usage');"
                                                        style="background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background-color 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'"
                                                        title="Delete this item">
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                        </tr>
                                        ${hasQuarters ? `
                                        <tr id="capital-${index}-breakdown" style="display: none;">
                                            <td colspan="${hasQuarters ? '8' : '5'}" style="padding: 0; background: transparent;">
                                                <div class="quarterly-breakdown-container">
                                                    <div id="quarterly-table-capitalUsage-${index}" style="display: none;">
                                                        <h4 class="quarterly-breakdown-header">Quarterly Breakdown - ${item.description}</h4>
                                                        <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                            <thead>
                                                                <tr style="background: #e2e8f0;">
                                                                    <th style="width: 150px;">Metric</th>
                                                                    ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td style="font-weight: 600;">Costs Claimed</td>
                                                                    ${quarters.map(q => `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${item.quarterlyCosts['q' + q.index] || 0}"
                                                                                onchange="updateQuarterlyCost(projectBudget.capitalUsage.items[${index}], ${q.index}, this.value); displayDetailedBudget();"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                                            />
                                                                        </td>
                                                                    `).join('')}
                                                                </tr>
                                                                <tr style="background: #f1f5f9;">
                                                                    <td style="font-weight: 600;">Budget Remaining</td>
                                                                    <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                        ¬£${remaining.toLocaleString()}
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    ${(() => {
                                                        // Render transaction details for this Capital Usage item
                                                        if (cachedTransactions && cachedTransactions.length > 0) {
                                                            const itemTransactions = getTransactionsForItem(
                                                                cachedTransactions,
                                                                projectBudget.projectId,
                                                                'Capital Usage',
                                                                'capitalUsage-' + index,
                                                                null
                                                            );
                                                            return renderTransactionDetails(
                                                                itemTransactions,
                                                                projectBudget.projectId,
                                                                'Capital Usage',
                                                                'capitalUsage-' + index,
                                                                null,
                                                                cachedInvoices || []
                                                            );
                                                        }
                                                        return '';
                                                    })()}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    `;
                                }).join('')}

                                ${hasQuarters && projectBudget.capitalUsage.items.length > 0 ? (() => {
                                    const summary = getCategorySummary(projectBudget.capitalUsage.items, 'Capital Usage', 'capitalUsage');
                                    const isSummaryOverBudget = summary.totalClaimed > summary.totalCosts;

                                    // Initialize category forecast if it doesn't exist
                                    if (!projectBudget.capitalUsage.categoryForecast) {
                                        projectBudget.capitalUsage.categoryForecast = {'q1': 0, 'q2': 0, 'q3': 0, 'q4': 0};
                                    }

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('capital-summary')" class="category-summary-row ${isSummaryOverBudget ? 'over-budget' : ''}">
                                            <td colspan="3" style="text-align: right; padding-right: 15px;">CAPITAL USAGE TOTAL:</td>
                                            <td>¬£${summary.totalCosts.toLocaleString()}</td>
                                            <td ${isSummaryOverBudget ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.totalClaimed.toLocaleString()}</td>
                                            <td ${summary.remaining < 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.remaining.toLocaleString()}</td>
                                            <td ${summary.difference > 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>${summary.difference.toFixed(1)}%</td>
                                        </tr>
                                        <tr id="capital-summary-breakdown" style="display: none;">
                                            <td colspan="7" style="padding: 0; background: #f1f5f9;">
                                                <div class="quarterly-breakdown-container">
                                                    <h4 class="quarterly-breakdown-header">Capital Usage - Quarterly Breakdown</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #ffe0b2;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                <th>Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => {
                                                                    const qClaimed = summary.quarterlyTotals['q' + q.index] || 0;
                                                                    return `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${qClaimed}"
                                                                                onchange="updateCategoryQuarterlyCost(projectBudget.capitalUsage.items, ${q.index}, parseFloat(this.value) || 0, 'Capital Usage', 'capitalUsage'); displayDetailedBudget();"
                                                                                onkeypress="if(event.key==='Enter'){event.preventDefault();const val=this.value;updateCategoryQuarterlyCost(projectBudget.capitalUsage.items, ${q.index}, parseFloat(val) || 0, 'Capital Usage', 'capitalUsage'); displayDetailedBudget();}"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600;"
                                                                                step="0.01"
                                                                            />
                                                                        </td>
                                                                    `;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #fff3e0;">¬£${summary.totalClaimed.toLocaleString()}</td>
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600; cursor: pointer; color: #3AAFA9; user-select: none;"
                                                                    onclick="event.stopPropagation(); const success = calculateCategoryForecast(projectBudget.capitalUsage.items, projectBudget.capitalUsage.categoryForecast); if(success) { refreshForecastUI(event.target, projectBudget.capitalUsage.categoryForecast, projectBudget.capitalUsage.items); } else { alert('No empty quarters to forecast or no budget remaining.'); }"
                                                                    title="Click to calculate forecast for empty quarters">
                                                                    <span style="font-size: 1.1em;">üîÑ</span> Forecast
                                                                </td>
                                                                ${quarters.map(q => {
                                                                    const forecast = projectBudget.capitalUsage.categoryForecast['q' + q.index] || 0;
                                                                    return `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${forecast.toFixed(2)}"
                                                                                onchange="updateCategoryForecast(projectBudget.capitalUsage.categoryForecast, ${q.index}, this.value); refreshForecastUI(event.target, projectBudget.capitalUsage.categoryForecast, projectBudget.capitalUsage.items);"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600;"
                                                                            />
                                                                        </td>
                                                                    `;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #fff3e0;">
                                                                    ¬£${getTotalForecast(projectBudget.capitalUsage.categoryForecast).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                ${quarters.map(q => `<td></td>`).join('')}
                                                                <td style="font-weight: 700; background: #fff3e0; color: ${(summary.remaining - getTotalForecast(projectBudget.capitalUsage.categoryForecast)) < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${(summary.remaining - getTotalForecast(projectBudget.capitalUsage.categoryForecast)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                })() : ''}
                            </tbody>
                        </table>
                        </div>
                        ` : '<p style="color: #94a3b8; font-style: italic;">No capital usage items</p>'}
                        <div style="margin-top: 12px; text-align: left;">
                            <button onclick="openAddItemModal('capitalUsage')"
                                    style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; display: inline-flex; align-items: center; gap: 6px;"
                                    onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                ‚ûï Add Capital Usage Item
                            </button>
                        </div>
                        </div>
                    </div>

                    <div class="category-section" style="margin-top: 20px;">
                        <h3 onclick="toggleCategorySection('subcontracting-details')" style="cursor: pointer; user-select: none;">
                            <span id="subcontracting-arrow" style="display: inline-block; width: 20px;">‚ñ∂</span>
                            Subcontracting (¬£${projectBudget.subcontracting.totalCost.toLocaleString()})
                        </h3>
                        <div id="subcontracting-details" style="display: none;">
                        ${projectBudget.subcontracting.contractors && projectBudget.subcontracting.contractors.length > 0 ? `
                        <div class="item-table-container"><table class="item-table">
                            <thead>
                                <tr>
                                    <th>Subcontractor Name</th>
                                    <th>Country</th>
                                    <th>Role</th>
                                    <th>Cost</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                    <th style="width: 60px;">Delete</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${projectBudget.subcontracting.contractors.map((contractor, index) => {
                                    // Normalize property names for items added via "Add Item" modal
                                    // Old format: name, country, role, cost
                                    // New format: item, quantity, costPerItem, total
                                    const name = contractor.name || contractor.item || 'Unnamed';
                                    const country = contractor.country || '-';
                                    const role = contractor.role || `Qty: ${contractor.quantity || 1} @ ¬£${contractor.costPerItem || 0}`;
                                    const cost = contractor.cost || contractor.total || 0;

                                    // Ensure cost is treated as the total cost
                                    if (!contractor.totalCost && cost) {
                                        contractor.totalCost = cost;
                                    }
                                    initializeQuarterlyCosts(contractor);
                                    const itemKey = `subcontracting-${index}`;
                                    const costsClaimed = getItemClaimedFromTransactions(projectBudget.projectId, 'Subcontracting', itemKey);
                                    const remaining = cost - costsClaimed;
                                    const difference = cost > 0 ? ((costsClaimed - cost) / cost) * 100 : 0;
                                    const isOverBudget = costsClaimed > cost;

                                    return `
                                        <tr style="${isOverBudget && hasQuarters ? 'background: #fee;' : ''}">
                                            <td onclick="toggleQuarterlyBreakdown('subcontracting-${index}')" style="cursor: pointer;">${name}</td>
                                            <td onclick="toggleQuarterlyBreakdown('subcontracting-${index}')" style="cursor: pointer;">${country}</td>
                                            <td onclick="toggleQuarterlyBreakdown('subcontracting-${index}')" style="cursor: pointer;">${role}</td>
                                            <td onclick="toggleQuarterlyBreakdown('subcontracting-${index}')" style="cursor: pointer;">¬£${cost.toLocaleString()}</td>
                                            ${hasQuarters ? `
                                                <td onclick="toggleQuarterlyBreakdown('subcontracting-${index}')" style="cursor: pointer; ${isOverBudget ? 'color: #d32f2f; font-weight: 600;' : ''}">¬£${costsClaimed.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('subcontracting-${index}')" style="cursor: pointer; ${remaining < 0 ? 'color: #d32f2f; font-weight: 600;' : ''}">¬£${remaining.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('subcontracting-${index}')" style="cursor: pointer; ${difference > 0 ? 'color: #d32f2f; font-weight: 600;' : ''}">${difference.toFixed(1)}%</td>
                                            ` : ''}
                                            <td style="text-align: center;">
                                                <button onclick="event.stopPropagation(); deleteCategoryItem(this, 'subcontracting.contractors', ${index}, 'Subcontracting');"
                                                        style="background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background-color 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'"
                                                        title="Delete this item">
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                        </tr>
                                        ${hasQuarters ? `
                                        <tr id="subcontracting-${index}-breakdown" style="display: none;">
                                            <td colspan="${hasQuarters ? '8' : '5'}" style="padding: 0; background: transparent;">
                                                <div class="quarterly-breakdown-container">
                                                    <div id="quarterly-table-subcontracting-${index}" style="display: none;">
                                                        <h4 class="quarterly-breakdown-header">Quarterly Breakdown - ${name}</h4>
                                                        <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                            <thead>
                                                                <tr style="background: #e2e8f0;">
                                                                    <th style="width: 150px;">Metric</th>
                                                                    ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td style="font-weight: 600;">Costs Claimed</td>
                                                                    ${quarters.map(q => `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${contractor.quarterlyCosts['q' + q.index] || 0}"
                                                                                onchange="updateQuarterlyCost(projectBudget.subcontracting.contractors[${index}], ${q.index}, this.value); displayDetailedBudget();"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                                            />
                                                                        </td>
                                                                    `).join('')}
                                                                </tr>
                                                                <tr style="background: #f1f5f9;">
                                                                    <td style="font-weight: 600;">Budget Remaining</td>
                                                                    <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                        ¬£${remaining.toLocaleString()}
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    ${(() => {
                                                        // Render transaction details for this Subcontracting item
                                                        if (cachedTransactions && cachedTransactions.length > 0) {
                                                            const itemTransactions = getTransactionsForItem(
                                                                cachedTransactions,
                                                                projectBudget.projectId,
                                                                'Subcontracting',
                                                                'subcontracting-' + index,
                                                                null
                                                            );
                                                            return renderTransactionDetails(
                                                                itemTransactions,
                                                                projectBudget.projectId,
                                                                'Subcontracting',
                                                                'subcontracting-' + index,
                                                                null,
                                                                cachedInvoices || []
                                                            );
                                                        }
                                                        return '';
                                                    })()}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    `;
                                }).join('')}

                                ${hasQuarters && projectBudget.subcontracting.contractors.length > 0 ? (() => {
                                    const summary = getCategorySummary(projectBudget.subcontracting.contractors, 'Subcontracting', 'subcontracting');
                                    const isSummaryOverBudget = summary.totalClaimed > summary.totalCosts;

                                    // Initialize category forecast if it doesn't exist
                                    if (!projectBudget.subcontracting.categoryForecast) {
                                        projectBudget.subcontracting.categoryForecast = {'q1': 0, 'q2': 0, 'q3': 0, 'q4': 0};
                                    }

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('subcontracting-summary')" class="category-summary-row ${isSummaryOverBudget ? 'over-budget' : ''}">
                                            <td colspan="3" style="text-align: right; padding-right: 15px;">SUBCONTRACTING TOTAL:</td>
                                            <td>¬£${summary.totalCosts.toLocaleString()}</td>
                                            <td ${isSummaryOverBudget ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.totalClaimed.toLocaleString()}</td>
                                            <td ${summary.remaining < 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.remaining.toLocaleString()}</td>
                                            <td ${summary.difference > 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>${summary.difference.toFixed(1)}%</td>
                                        </tr>
                                        <tr id="subcontracting-summary-breakdown" style="display: none;">
                                            <td colspan="7" style="padding: 0; background: #f1f5f9;">
                                                <div class="quarterly-breakdown-container">
                                                    <h4 class="quarterly-breakdown-header">Subcontracting - Quarterly Breakdown</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #f8bbd0;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                <th>Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => {
                                                                    const qClaimed = summary.quarterlyTotals['q' + q.index] || 0;
                                                                    return `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${qClaimed}"
                                                                                onchange="updateCategoryQuarterlyCost(projectBudget.subcontracting.contractors, ${q.index}, parseFloat(this.value) || 0, 'Subcontracting', 'subcontracting'); displayDetailedBudget();"
                                                                                onkeypress="if(event.key==='Enter'){event.preventDefault();const val=this.value;updateCategoryQuarterlyCost(projectBudget.subcontracting.contractors, ${q.index}, parseFloat(val) || 0, 'Subcontracting', 'subcontracting'); displayDetailedBudget();}"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600;"
                                                                                step="0.01"
                                                                            />
                                                                        </td>
                                                                    `;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #fce4ec;">¬£${summary.totalClaimed.toLocaleString()}</td>
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600; cursor: pointer; color: #3AAFA9; user-select: none;"
                                                                    onclick="event.stopPropagation(); const success = calculateCategoryForecast(projectBudget.subcontracting.contractors, projectBudget.subcontracting.categoryForecast); if(success) { refreshForecastUI(event.target, projectBudget.subcontracting.categoryForecast, projectBudget.subcontracting.contractors); } else { alert('No empty quarters to forecast or no budget remaining.'); }"
                                                                    title="Click to calculate forecast for empty quarters">
                                                                    <span style="font-size: 1.1em;">üîÑ</span> Forecast
                                                                </td>
                                                                ${quarters.map(q => {
                                                                    const forecast = projectBudget.subcontracting.categoryForecast['q' + q.index] || 0;
                                                                    return `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${forecast.toFixed(2)}"
                                                                                onchange="updateCategoryForecast(projectBudget.subcontracting.categoryForecast, ${q.index}, this.value); refreshForecastUI(event.target, projectBudget.subcontracting.categoryForecast, projectBudget.subcontracting.contractors);"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600;"
                                                                            />
                                                                        </td>
                                                                    `;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #fce4ec;">
                                                                    ¬£${getTotalForecast(projectBudget.subcontracting.categoryForecast).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                ${quarters.map(q => `<td></td>`).join('')}
                                                                <td style="font-weight: 700; background: #fce4ec; color: ${(summary.remaining - getTotalForecast(projectBudget.subcontracting.categoryForecast)) < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${(summary.remaining - getTotalForecast(projectBudget.subcontracting.categoryForecast)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                })() : ''}
                            </tbody>
                        </table>
                        </div>
                        ` : '<p style="color: #94a3b8; font-style: italic;">No subcontracting items</p>'}

                        ${(() => {
                            // Always show assigned transactions for Subcontracting, even if no budget items
                            if (cachedTransactions && cachedTransactions.length > 0) {
                                const categoryTransactions = getTransactionsForItem(
                                    cachedTransactions,
                                    projectBudget.projectId,
                                    'Subcontracting',
                                    null,  // No specific item - get all Subcontracting transactions
                                    null   // All quarters
                                );
                                if (categoryTransactions.length > 0) {
                                    return renderTransactionDetails(
                                        categoryTransactions,
                                        projectBudget.projectId,
                                        'Subcontracting',
                                        'subcontracting-all',
                                        null,
                                        cachedInvoices || []
                                    );
                                }
                            }
                            return '';
                        })()}
                        <div style="margin-top: 12px; text-align: left;">
                            <button onclick="openAddItemModal('subcontracting')"
                                    style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; display: inline-flex; align-items: center; gap: 6px;"
                                    onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                ‚ûï Add Subcontracting Item
                            </button>
                        </div>
                        </div>
                    </div>
                `;
                capitalSubcontractingSection.innerHTML = capitalSubHTML;
            }

            // Travel & Other Costs Section
            const travelOtherSection = document.getElementById('travelOtherSection');
            if (travelOtherSection) {
                let travelOtherHTML = `
                    <div class="category-section">
                        <h3 onclick="toggleCategorySection('travel-details')" style="cursor: pointer; user-select: none;">
                            <span id="travel-arrow" style="display: inline-block; width: 20px;">‚ñ∂</span>
                            Travel and Subsistence (¬£${projectBudget.travel.totalCost.toLocaleString()})
                        </h3>
                        <div id="travel-details" style="display: none;">
                        ${(projectBudget.travel.trips && projectBudget.travel.trips.length > 0) || (projectBudget.travel.totalCost > 0 && projectBudget.travel.quarterlyCosts) ? `
                        <div class="item-table-container"><table class="item-table">
                            <thead>
                                <tr>
                                    <th>Purpose of Journey or Subsistence</th>
                                    <th>Number of Times</th>
                                    <th>Cost Each</th>
                                    <th>Total</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                    <th>Delete</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(projectBudget.travel.trips && projectBudget.travel.trips.length > 0 ? projectBudget.travel.trips : (projectBudget.travel.quarterlyCosts ? [projectBudget.travel] : [])).map((trip, index) => {
                                    // Ensure total is treated as totalCost
                                    if (!trip.totalCost && trip.total) {
                                        trip.totalCost = trip.total;
                                    }
                                    initializeQuarterlyCosts(trip);
                                    // FIX: Calculate costs from actual transaction assignments, not stale quarterly data
                                    const costsClaimed = getItemClaimedFromTransactions(projectBudget.projectId, 'Travel', 'travel-' + index);
                                    const totalBudget = trip.total || trip.totalCost;
                                    const remaining = totalBudget - costsClaimed;
                                    const difference = totalBudget > 0 ? ((costsClaimed - totalBudget) / totalBudget) * 100 : 0;
                                    const isOverBudget = costsClaimed > totalBudget;

                                    return `
                                        <tr style="${isOverBudget && hasQuarters ? 'background: #fee;' : ''}">
                                            <td onclick="toggleQuarterlyBreakdown('travel-${index}')" style="cursor: pointer;">${trip.purpose || 'General Travel'}</td>
                                            <td onclick="toggleQuarterlyBreakdown('travel-${index}')" style="cursor: pointer;">${trip.numberOfTimes || '-'}</td>
                                            <td onclick="toggleQuarterlyBreakdown('travel-${index}')" style="cursor: pointer;">${trip.costEach ? '¬£' + trip.costEach.toLocaleString() : '-'}</td>
                                            <td onclick="toggleQuarterlyBreakdown('travel-${index}')" style="cursor: pointer;">¬£${(trip.total || trip.totalCost).toLocaleString()}</td>
                                            ${hasQuarters ? `
                                                <td onclick="toggleQuarterlyBreakdown('travel-${index}')" style="cursor: pointer; ${isOverBudget ? 'color: #d32f2f; font-weight: 600;' : ''}">¬£${costsClaimed.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('travel-${index}')" style="cursor: pointer; ${remaining < 0 ? 'color: #d32f2f; font-weight: 600;' : ''}">¬£${remaining.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('travel-${index}')" style="cursor: pointer; ${difference > 0 ? 'color: #d32f2f; font-weight: 600;' : ''}">${difference.toFixed(1)}%</td>
                                            ` : ''}
                                            <td style="text-align: center;">
                                                <button onclick="event.stopPropagation(); deleteCategoryItem(this, 'travel.trips', ${index}, 'Travel');"
                                                        style="background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background-color 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'"
                                                        title="Delete this item">
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                        </tr>
                                        <tr id="travel-${index}-breakdown" style="display: none;">
                                            <td colspan="${hasQuarters ? '8' : '5'}" style="padding: 0; background: transparent;">
                                                <div class="quarterly-breakdown-container">
                                                    ${hasQuarters ? `
                                                    <div id="quarterly-table-travel-${index}" style="display: none;">
                                                        <h4 class="quarterly-breakdown-header">Quarterly Breakdown - ${trip.purpose || 'General Travel'}</h4>
                                                        <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                            <thead>
                                                                <tr style="background: #e2e8f0;">
                                                                    <th style="width: 150px;">Metric</th>
                                                                    ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td style="font-weight: 600;">Costs Claimed</td>
                                                                    ${quarters.map(q => `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${trip.quarterlyCosts['q' + q.index] || 0}"
                                                                                onchange="updateQuarterlyCost(${projectBudget.travel.trips && projectBudget.travel.trips.length > 0 ? `projectBudget.travel.trips[${index}]` : 'projectBudget.travel'}, ${q.index}, this.value); displayDetailedBudget();"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                                            />
                                                                        </td>
                                                                    `).join('')}
                                                                </tr>
                                                                <tr style="background: #f1f5f9;">
                                                                    <td style="font-weight: 600;">Budget Remaining</td>
                                                                    <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                        ¬£${remaining.toLocaleString()}
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    ` : ''}
                                                    ${(() => {
                                                        // Render transaction details for this Travel item
                                                        if (cachedTransactions && cachedTransactions.length > 0) {
                                                            const itemTransactions = getTransactionsForItem(
                                                                cachedTransactions,
                                                                projectBudget.projectId,
                                                                'Travel',
                                                                'travel-' + index,
                                                                null
                                                            );
                                                            return renderTransactionDetails(
                                                                itemTransactions,
                                                                projectBudget.projectId,
                                                                'Travel',
                                                                'travel-' + index,
                                                                null,
                                                                cachedInvoices || []
                                                            );
                                                        }
                                                        return '';
                                                    })()}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}

                                ${hasQuarters && ((projectBudget.travel.trips && projectBudget.travel.trips.length > 0) || projectBudget.travel.quarterlyCosts) ? (() => {
                                    // FIX: Pass category and itemKeyPrefix to use transaction-based calculation
                                    const summary = getCategorySummary(projectBudget.travel.trips && projectBudget.travel.trips.length > 0 ? projectBudget.travel.trips : [projectBudget.travel], 'Travel', 'travel');
                                    const isSummaryOverBudget = summary.totalClaimed > summary.totalCosts;

                                    // Initialize category forecast if it doesn't exist
                                    if (!projectBudget.travel.categoryForecast) {
                                        projectBudget.travel.categoryForecast = {'q1': 0, 'q2': 0, 'q3': 0, 'q4': 0};
                                    }

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('travel-summary')" class="category-summary-row ${isSummaryOverBudget ? 'over-budget' : ''}">
                                            <td colspan="3" style="text-align: right; padding-right: 15px;">TRAVEL TOTAL:</td>
                                            <td>¬£${summary.totalCosts.toLocaleString()}</td>
                                            <td ${isSummaryOverBudget ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.totalClaimed.toLocaleString()}</td>
                                            <td ${summary.remaining < 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.remaining.toLocaleString()}</td>
                                            <td ${summary.difference > 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>${summary.difference.toFixed(1)}%</td>
                                        </tr>
                                        <tr id="travel-summary-breakdown" style="display: none;">
                                            <td colspan="7" style="padding: 0; background: #f1f5f9;">
                                                <div class="quarterly-breakdown-container">
                                                    <h4 class="quarterly-breakdown-header">Travel - Quarterly Breakdown</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #b3e5fc;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                <th>Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => {
                                                                    const qClaimed = summary.quarterlyTotals['q' + q.index] || 0;
                                                                    return `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${qClaimed}"
                                                                                onchange="updateCategoryQuarterlyCost(projectBudget.travel.trips && projectBudget.travel.trips.length > 0 ? projectBudget.travel.trips : [projectBudget.travel], ${q.index}, parseFloat(this.value) || 0, 'Travel', 'travel'); displayDetailedBudget();"
                                                                                onkeypress="if(event.key==='Enter'){event.preventDefault();const val=this.value;updateCategoryQuarterlyCost(projectBudget.travel.trips && projectBudget.travel.trips.length > 0 ? projectBudget.travel.trips : [projectBudget.travel], ${q.index}, parseFloat(val) || 0, 'Travel', 'travel'); displayDetailedBudget();}"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600;"
                                                                                step="0.01"
                                                                            />
                                                                        </td>
                                                                    `;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #e1f5fe;">¬£${summary.totalClaimed.toLocaleString()}</td>
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600; cursor: pointer; color: #3AAFA9; user-select: none;"
                                                                    onclick="event.stopPropagation(); const success = calculateCategoryForecast(projectBudget.travel.trips && projectBudget.travel.trips.length > 0 ? projectBudget.travel.trips : [projectBudget.travel], projectBudget.travel.categoryForecast); if(success) { refreshForecastUI(event.target, projectBudget.travel.categoryForecast, projectBudget.travel.trips && projectBudget.travel.trips.length > 0 ? projectBudget.travel.trips : [projectBudget.travel]); } else { alert('No empty quarters to forecast or no budget remaining.'); }"
                                                                    title="Click to calculate forecast for empty quarters">
                                                                    <span style="font-size: 1.1em;">üîÑ</span> Forecast
                                                                </td>
                                                                ${quarters.map(q => {
                                                                    const forecast = projectBudget.travel.categoryForecast['q' + q.index] || 0;
                                                                    return `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${forecast.toFixed(2)}"
                                                                                onchange="updateCategoryForecast(projectBudget.travel.categoryForecast, ${q.index}, this.value); refreshForecastUI(event.target, projectBudget.travel.categoryForecast, projectBudget.travel.trips && projectBudget.travel.trips.length > 0 ? projectBudget.travel.trips : [projectBudget.travel]);"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600;"
                                                                            />
                                                                        </td>
                                                                    `;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #e1f5fe;">
                                                                    ¬£${getTotalForecast(projectBudget.travel.categoryForecast).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                ${quarters.map(q => `<td></td>`).join('')}
                                                                <td style="font-weight: 700; background: #e1f5fe; color: ${(summary.remaining - getTotalForecast(projectBudget.travel.categoryForecast)) < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${(summary.remaining - getTotalForecast(projectBudget.travel.categoryForecast)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                })() : ''}
                            </tbody>
                        </table>
                        </div>
                        ` : '<p style="color: #94a3b8; font-style: italic;">No travel items</p>'}
                        <div style="margin-top: 12px; text-align: left;">
                            <button onclick="openAddItemModal('travel')"
                                    style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; display: inline-flex; align-items: center; gap: 6px;"
                                    onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                ‚ûï Add Travel Item
                            </button>
                        </div>
                        </div>
                    </div>

                    <div class="category-section" style="margin-top: 20px;">
                        <h3 onclick="toggleCategorySection('other-costs-details')" style="cursor: pointer; user-select: none;">
                            <span id="other-costs-arrow" style="display: inline-block; width: 20px;">‚ñ∂</span>
                            Other Costs (¬£${projectBudget.otherCosts.totalCost.toLocaleString()})
                        </h3>
                        <div id="other-costs-details" style="display: none;">
                        ${(projectBudget.otherCosts.items && projectBudget.otherCosts.items.length > 0) || (projectBudget.otherCosts.totalCost > 0 && projectBudget.otherCosts.quarterlyCosts) ? `
                        <div class="item-table-container"><table class="item-table">
                            <thead>
                                <tr>
                                    <th>Description and Justification</th>
                                    <th>Estimated Cost</th>
                                    ${hasQuarters ? '<th>Costs Claimed</th><th>Remaining</th><th>Difference (%)</th>' : ''}
                                    <th>Delete</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(projectBudget.otherCosts.items && projectBudget.otherCosts.items.length > 0 ? projectBudget.otherCosts.items : (projectBudget.otherCosts.quarterlyCosts ? [projectBudget.otherCosts] : [])).map((item, index) => {
                                    // Normalize property names for items added via "Add Item" modal
                                    // Old format: description, estimatedCost
                                    // New format: item, total
                                    const description = item.description || item.item || 'General Other Costs';
                                    const budgetAmount = item.estimatedCost || item.total || item.totalCost || 0;

                                    // Ensure estimatedCost is treated as totalCost
                                    if (!item.totalCost && budgetAmount) {
                                        item.totalCost = budgetAmount;
                                    }
                                    initializeQuarterlyCosts(item);
                                    const itemKey = `otherCosts-${index}`;
                                    const costsClaimed = getItemClaimedFromTransactions(projectBudget.projectId, 'Other Costs', itemKey);
                                    const remaining = budgetAmount - costsClaimed;
                                    const difference = budgetAmount > 0 ? ((costsClaimed - budgetAmount) / budgetAmount) * 100 : 0;
                                    const isOverBudget = costsClaimed > budgetAmount;

                                    return `
                                        <tr style="${isOverBudget && hasQuarters ? 'background: #fee;' : ''}">
                                            <td onclick="toggleQuarterlyBreakdown('othercosts-${index}')" style="cursor: pointer;">${description}</td>
                                            <td onclick="toggleQuarterlyBreakdown('othercosts-${index}')" style="cursor: pointer;">¬£${budgetAmount.toLocaleString()}</td>
                                            ${hasQuarters ? `
                                                <td onclick="toggleQuarterlyBreakdown('othercosts-${index}')" style="cursor: pointer; ${isOverBudget ? 'color: #d32f2f; font-weight: 600;' : ''}">¬£${costsClaimed.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('othercosts-${index}')" style="cursor: pointer; ${remaining < 0 ? 'color: #d32f2f; font-weight: 600;' : ''}">¬£${remaining.toLocaleString()}</td>
                                                <td onclick="toggleQuarterlyBreakdown('othercosts-${index}')" style="cursor: pointer; ${difference > 0 ? 'color: #d32f2f; font-weight: 600;' : ''}">${difference.toFixed(1)}%</td>
                                            ` : ''}
                                            <td style="text-align: center;">
                                                <button onclick="event.stopPropagation(); deleteCategoryItem(this, 'otherCosts.items', ${index}, 'Other Costs');"
                                                        style="background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background-color 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'"
                                                        title="Delete this item">
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                        </tr>
                                        <tr id="othercosts-${index}-breakdown" style="display: none;">
                                            <td colspan="${hasQuarters ? '6' : '3'}" class="breakdown-row-cell">
                                                <div class="quarterly-breakdown-container">
                                                    ${hasQuarters ? `
                                                    <div id="quarterly-table-otherCosts-${index}" style="display: none;">
                                                        <h4 class="quarterly-breakdown-header">Quarterly Breakdown - ${item.description || 'General Other Costs'}</h4>
                                                        <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                            <thead>
                                                                <tr style="background: #e2e8f0;">
                                                                    <th style="width: 150px;">Metric</th>
                                                                    ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td style="font-weight: 600;">Costs Claimed</td>
                                                                    ${quarters.map(q => `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${item.quarterlyCosts['q' + q.index] || 0}"
                                                                                onchange="updateQuarterlyCost(${projectBudget.otherCosts.items && projectBudget.otherCosts.items.length > 0 ? `projectBudget.otherCosts.items[${index}]` : 'projectBudget.otherCosts'}, ${q.index}, this.value); displayDetailedBudget();"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;"
                                                                            />
                                                                        </td>
                                                                    `).join('')}
                                                                </tr>
                                                                <tr style="background: #f1f5f9;">
                                                                    <td style="font-weight: 600;">Budget Remaining</td>
                                                                    <td colspan="${quarters.length}" style="font-weight: 600; color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                        ¬£${remaining.toLocaleString()}
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    ` : ''}
                                                    ${(() => {
                                                        // Render transaction details for this Other Costs item
                                                        if (cachedTransactions && cachedTransactions.length > 0) {
                                                            const itemTransactions = getTransactionsForItem(
                                                                cachedTransactions,
                                                                projectBudget.projectId,
                                                                'Other Costs',
                                                                'otherCosts-' + index,
                                                                null
                                                            );
                                                            return renderTransactionDetails(
                                                                itemTransactions,
                                                                projectBudget.projectId,
                                                                'Other Costs',
                                                                'otherCosts-' + index,
                                                                null,
                                                                cachedInvoices || []
                                                            );
                                                        }
                                                        return '';
                                                    })()}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}

                                ${hasQuarters && ((projectBudget.otherCosts.items && projectBudget.otherCosts.items.length > 0) || projectBudget.otherCosts.quarterlyCosts) ? (() => {
                                    // FIX: Pass category and itemKeyPrefix to use transaction-based calculation
                                    const summary = getCategorySummary(projectBudget.otherCosts.items && projectBudget.otherCosts.items.length > 0 ? projectBudget.otherCosts.items : [projectBudget.otherCosts], 'Other Costs', 'otherCosts');
                                    const isSummaryOverBudget = summary.totalClaimed > summary.totalCosts;

                                    // Initialize category forecast if it doesn't exist
                                    if (!projectBudget.otherCosts.categoryForecast) {
                                        projectBudget.otherCosts.categoryForecast = {'q1': 0, 'q2': 0, 'q3': 0, 'q4': 0};
                                    }

                                    return `
                                        <tr onclick="toggleQuarterlyBreakdown('othercosts-summary')" class="category-summary-row ${isSummaryOverBudget ? 'over-budget' : ''}">
                                            <td style="text-align: right; padding-right: 15px;">OTHER COSTS TOTAL:</td>
                                            <td>¬£${summary.totalCosts.toLocaleString()}</td>
                                            <td ${isSummaryOverBudget ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.totalClaimed.toLocaleString()}</td>
                                            <td ${summary.remaining < 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>¬£${summary.remaining.toLocaleString()}</td>
                                            <td ${summary.difference > 0 ? 'style="color: #d32f2f; font-weight: 700;"' : ''}>${summary.difference.toFixed(1)}%</td>
                                        </tr>
                                        <tr id="othercosts-summary-breakdown" style="display: none;">
                                            <td colspan="5" style="padding: 0; background: #f1f5f9;">
                                                <div class="quarterly-breakdown-container">
                                                    <h4 class="quarterly-breakdown-header">Other Costs - Quarterly Breakdown</h4>
                                                    <table class="quarterly-breakdown-table" style="width: 100%; margin: 0;">
                                                        <thead>
                                                            <tr style="background: #e1bee7;">
                                                                <th style="width: 150px;">Metric</th>
                                                                ${quarters.map(q => `<th data-quarter="${q.index}">${q.label}</th>`).join('')}
                                                                <th>Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td style="font-weight: 600;">Costs Claimed</td>
                                                                ${quarters.map(q => {
                                                                    const qClaimed = summary.quarterlyTotals['q' + q.index] || 0;
                                                                    return `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${qClaimed}"
                                                                                onchange="updateCategoryQuarterlyCost(projectBudget.otherCosts.items && projectBudget.otherCosts.items.length > 0 ? projectBudget.otherCosts.items : [projectBudget.otherCosts], ${q.index}, parseFloat(this.value) || 0, 'Other Costs', 'otherCosts'); displayDetailedBudget();"
                                                                                onkeypress="if(event.key==='Enter'){event.preventDefault();const val=this.value;updateCategoryQuarterlyCost(projectBudget.otherCosts.items && projectBudget.otherCosts.items.length > 0 ? projectBudget.otherCosts.items : [projectBudget.otherCosts], ${q.index}, parseFloat(val) || 0, 'Other Costs', 'otherCosts'); displayDetailedBudget();}"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600;"
                                                                                step="0.01"
                                                                            />
                                                                        </td>
                                                                    `;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #f3e5f5;">¬£${summary.totalClaimed.toLocaleString()}</td>
                                                            </tr>
                                                            <tr style="background: #f1f5f9;">
                                                                <td style="font-weight: 600; cursor: pointer; color: #3AAFA9; user-select: none;"
                                                                    onclick="event.stopPropagation(); const success = calculateCategoryForecast(projectBudget.otherCosts.items && projectBudget.otherCosts.items.length > 0 ? projectBudget.otherCosts.items : [projectBudget.otherCosts], projectBudget.otherCosts.categoryForecast); if(success) { refreshForecastUI(event.target, projectBudget.otherCosts.categoryForecast, projectBudget.otherCosts.items && projectBudget.otherCosts.items.length > 0 ? projectBudget.otherCosts.items : [projectBudget.otherCosts]); } else { alert('No empty quarters to forecast or no budget remaining.'); }"
                                                                    title="Click to calculate forecast for empty quarters">
                                                                    <span style="font-size: 1.1em;">üîÑ</span> Forecast
                                                                </td>
                                                                ${quarters.map(q => {
                                                                    const forecast = projectBudget.otherCosts.categoryForecast['q' + q.index] || 0;
                                                                    return `
                                                                        <td data-quarter="${q.index}">
                                                                            <input
                                                                                type="number"
                                                                                value="${forecast.toFixed(2)}"
                                                                                onchange="updateCategoryForecast(projectBudget.otherCosts.categoryForecast, ${q.index}, this.value); refreshForecastUI(event.target, projectBudget.otherCosts.categoryForecast, projectBudget.otherCosts.items && projectBudget.otherCosts.items.length > 0 ? projectBudget.otherCosts.items : [projectBudget.otherCosts]);"
                                                                                onclick="event.stopPropagation()"
                                                                                style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600;"
                                                                            />
                                                                        </td>
                                                                    `;
                                                                }).join('')}
                                                                <td style="font-weight: 700; background: #f3e5f5;">
                                                                    ¬£${getTotalForecast(projectBudget.otherCosts.categoryForecast).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td style="font-weight: 600;">Budget Remaining</td>
                                                                ${quarters.map(q => `<td></td>`).join('')}
                                                                <td style="font-weight: 700; background: #f3e5f5; color: ${(summary.remaining - getTotalForecast(projectBudget.otherCosts.categoryForecast)) < 0 ? '#d32f2f' : '#2e7d32'};">
                                                                    ¬£${(summary.remaining - getTotalForecast(projectBudget.otherCosts.categoryForecast)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                })() : ''}
                            </tbody>
                        </table>
                        </div>
                        ` : '<p style="color: #94a3b8; font-style: italic;">No other cost items</p>'}
                        <div style="margin-top: 12px; text-align: left;">
                            <button onclick="openAddItemModal('otherCosts')"
                                    style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; display: inline-flex; align-items: center; gap: 6px;"
                                    onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                ‚ûï Add Other Costs Item
                            </button>
                        </div>
                        </div>
                    </div>
                `;
                travelOtherSection.innerHTML = travelOtherHTML;
            }

            addLog('‚úÖ Detailed budget displayed');
            detailedResults.style.display = 'block';

            // Show the Add Item button
            showAddItemButton();

            // Restore expanded state
            restoreExpandedState(expandedSections);
        }

        function updateItem(id, field, value) {
            const item = budgetData.find(i => i.id === id);
            if (item) {
                item[field] = value;
                addLog(`Updated ${field} for item ${id}`);
            }
        }

        function deleteItemWithConfirmation(buttonElement, id) {
            showDeleteConfirmation(buttonElement, () => {
                deleteItem(id);
            });
        }

        function deleteItem(id) {
            budgetData = budgetData.filter(i => i.id !== id);
            addLog(`Deleted item ${id}`);
            displayResults();
        }

        function exportCSV() {
            const headers = ['Category', 'Description', 'Quantity', 'Unit', 'Unit Cost', 'Total Cost', 'Notes'];
            const rows = budgetData.map(item => [
                item.category || '',
                item.description || '',
                item.quantity || '',
                item.unit || '',
                item.unitCost || '',
                item.totalCost || 0,
                item.notes || ''
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `budget-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            addLog('Exported budget to CSV');
        }

        function saveBudgetProfile() {
            if (budgetData.length === 0) {
                alert('No budget data to save. Please parse a budget first.');
                return;
            }

            const profile = {
                savedDate: new Date().toISOString(),
                budgetData: budgetData,
                metadata: {
                    itemCount: budgetData.length,
                    totalEligible: budgetData.reduce((sum, item) => sum + (item.totalEligible || 0), 0),
                    totalSpent: budgetData.reduce((sum, item) => sum + (item.totalSpent || 0), 0)
                }
            };

            const json = JSON.stringify(profile, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `budget-profile-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            addLog('Saved budget profile to JSON file');
            addLog(`Total items: ${budgetData.length}, Total Eligible: ¬£${profile.metadata.totalEligible.toLocaleString()}`);
        }

        function loadBudgetProfile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const profile = JSON.parse(e.target.result);

                    if (!profile.budgetData || !Array.isArray(profile.budgetData)) {
                        throw new Error('Invalid budget profile format');
                    }

                    budgetData = profile.budgetData;
                    addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    addLog('üìÇ Loaded budget profile successfully!');
                    addLog(`Saved on: ${new Date(profile.savedDate).toLocaleString()}`);
                    addLog(`Items loaded: ${budgetData.length}`);
                    addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                    displayResults();
                    document.getElementById('results').classList.add('show');
                } catch (error) {
                    addLog(`ERROR: Failed to load profile - ${error.message}`);
                    alert('Failed to load budget profile. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        function updateItemAndRecalc(id, field, value) {
            const item = budgetData.find(i => i.id === id);
            if (item) {
                item[field] = value;

                // Recalculate dependent values
                if (['q1', 'q2', 'q3', 'q4'].includes(field)) {
                    item.totalSpent = (item.q1 || 0) + (item.q2 || 0) + (item.q3 || 0) + (item.q4 || 0);
                    item.difference = (item.totalEligible || item.forecast || 0) - item.totalSpent;
                } else if (field === 'totalSpent' || field === 'totalEligible') {
                    item.difference = (item.totalEligible || item.forecast || 0) - (item.totalSpent || 0);
                }

                addLog(`Updated ${field} for item ${id} to ${value}`);
                displayResults();
            }
        }

        function setActiveQuarter(quarter) {
            activeQuarter = quarter;

            // Update button styles
            document.querySelectorAll('.quarter-btn').forEach(btn => {
                if (parseInt(btn.dataset.quarter) === quarter) {
                    btn.style.background = '#ff9800';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#ff9800';
                    btn.classList.add('active-quarter');
                } else {
                    btn.style.background = 'white';
                    btn.style.color = 'black';
                    btn.style.borderColor = '#ddd';
                    btn.classList.remove('active-quarter');
                }
            });

            // Update label
            document.getElementById('activeQuarterLabel').textContent = `‚Üê Currently claiming for Q${quarter}`;
            addLog(`Active claiming period changed to Q${quarter}`);
        }

        function updateProjectName(value) {
            projectBudget.projectName = value.trim();
            console.log('‚úèÔ∏è Project name updated:', projectBudget.projectName);
            addLog(`‚úèÔ∏è Project name set to: ${projectBudget.projectName}`);
        }

        function updateProjectNumber(value) {
            projectBudget.projectNumber = value.trim();
            console.log('‚úèÔ∏è Project number updated:', projectBudget.projectNumber);
            addLog(`‚úèÔ∏è Project number set to: ${projectBudget.projectNumber}`);
        }

        async function updateProjectStartDate() {
            const monthSelect = document.getElementById('projectStartMonth');
            const yearSelect = document.getElementById('projectStartYear');

            if (monthSelect && yearSelect) {
                const month = parseInt(monthSelect.value);
                const year = parseInt(yearSelect.value);

                if (month && year) {
                    projectBudget.financeSummary.projectStartMonth = month;
                    projectBudget.financeSummary.projectStartYear = year;
                    console.log('‚úèÔ∏è Project start date updated:', month, year);
                    addLog(`‚úèÔ∏è Project start date set to: ${getMonthName(month)} ${year}`);

                    // Re-render to show updated end date
                    await displayDetailedBudget();

                    // Auto-save
                    saveToIndexedDB();
                }
            }
        }

        async function updateProjectDuration() {
            const durationInput = document.getElementById('projectDurationMonths');
            if (durationInput) {
                const duration = parseInt(durationInput.value);
                if (duration && duration > 0) {
                    projectBudget.financeSummary.projectDurationMonths = duration;
                    console.log('‚úèÔ∏è Project duration updated:', duration);
                    addLog(`‚úèÔ∏è Project duration set to: ${duration} months`);

                    // Re-render to show updated end date and quarters
                    await displayDetailedBudget();

                    // Auto-save
                    saveToIndexedDB();
                }
            }
        }

        async function updateFundingLevel() {
            const fundingInput = document.getElementById('fundingLevelInput');
            if (fundingInput) {
                const fundingLevel = parseFloat(fundingInput.value);
                if (!isNaN(fundingLevel) && fundingLevel >= 0 && fundingLevel <= 100) {
                    projectBudget.financeSummary.fundingLevel = fundingLevel;

                    // Recalculate funding sought based on new funding level
                    const totalCosts = projectBudget.financeSummary.totalCosts || 0;
                    projectBudget.financeSummary.fundingSought = (totalCosts * fundingLevel) / 100;

                    console.log('‚úèÔ∏è Funding level updated:', fundingLevel + '%');
                    addLog(`‚úèÔ∏è Funding level set to: ${fundingLevel}% (¬£${projectBudget.financeSummary.fundingSought.toLocaleString()} sought)`);

                    // Re-render to show updated funding amounts
                    await displayDetailedBudget();

                    // Auto-save
                    saveToIndexedDB();
                } else {
                    showToast('Funding level must be between 0 and 100%', 'error');
                    fundingInput.value = projectBudget.financeSummary.fundingLevel || 0;
                }
            }
        }

        function calculateEndDate(startMonth, startYear, durationMonths) {
            if (!startMonth || !startYear || !durationMonths) return '';

            const startDate = new Date(startYear, startMonth - 1, 1); // First day of start month
            const endDate = new Date(startYear, startMonth - 1 + durationMonths, 0); // Last day of end month

            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${monthNames[endDate.getMonth()]} ${endDate.getFullYear()}`;
        }

        function getMonthName(monthNumber) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
            return months[monthNumber - 1] || '';
        }

        // Toggle category section collapse
        function toggleCategorySection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;

            const isHidden = section.style.display === 'none';
            section.style.display = isHidden ? 'block' : 'none';

            // Update arrow indicator
            const arrowId = sectionId.replace('-details', '-arrow');
            const arrow = document.getElementById(arrowId);
            if (arrow) {
                arrow.textContent = isHidden ? '‚ñº' : '‚ñ∂';
            }
        }

        function calculateQuarters() {
            const fs = projectBudget.financeSummary;
            if (!fs.projectStartMonth || !fs.projectStartYear || !fs.projectDurationMonths) {
                return [];
            }

            const quarters = [];
            const startMonth = fs.projectStartMonth;
            const startYear = fs.projectStartYear;
            const durationMonths = fs.projectDurationMonths;

            let currentMonth = startMonth;
            let currentYear = startYear;
            let monthsRemaining = durationMonths;
            let quarterIndex = 1;

            while (monthsRemaining > 0) {
                const quarterMonths = Math.min(3, monthsRemaining);
                const endMonth = currentMonth + quarterMonths - 1;
                const endYear = currentYear + Math.floor((endMonth - 1) / 12);
                const adjustedEndMonth = ((endMonth - 1) % 12) + 1;

                const startYYMM = `${String(currentYear).slice(-2)}${String(currentMonth).padStart(2, '0')}`;
                const endYYMM = `${String(endYear).slice(-2)}${String(adjustedEndMonth).padStart(2, '0')}`;

                quarters.push({
                    index: quarterIndex,
                    label: `Q${quarterIndex} (${startYYMM}-${endYYMM})`,
                    startMonth: currentMonth,
                    startYear: currentYear,
                    endMonth: adjustedEndMonth,
                    endYear: endYear
                });

                currentMonth = adjustedEndMonth + 1;
                if (currentMonth > 12) {
                    currentMonth = 1;
                    currentYear++;
                }

                monthsRemaining -= quarterMonths;
                quarterIndex++;
            }

            return quarters;
        }

        function getCurrentQuarter() {
            const quarters = calculateQuarters();
            if (quarters.length === 0) return null;

            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            for (const quarter of quarters) {
                const startDate = new Date(quarter.startYear, quarter.startMonth - 1, 1);
                const endDate = new Date(quarter.endYear, quarter.endMonth, 0);
                const nowDate = new Date(currentYear, currentMonth - 1, now.getDate());

                if (nowDate >= startDate && nowDate <= endDate) {
                    return quarter.index;
                }
            }

            return null;
        }

        // Get the previous quarter (the one that just finished)
        function getPreviousQuarter() {
            const quarters = calculateQuarters();
            if (quarters.length === 0) return null;

            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();
            const nowDate = new Date(currentYear, currentMonth - 1, now.getDate());

            console.log(`[getPreviousQuarter] Today: ${nowDate.toDateString()}`);

            let previousQuarter = null;

            for (const quarter of quarters) {
                const endDate = new Date(quarter.endYear, quarter.endMonth, 0);
                console.log(`[getPreviousQuarter] Q${quarter.index} (${quarter.label}): ends ${endDate.toDateString()}, has ended: ${endDate < nowDate}`);

                // If the quarter has ended (endDate is before now), it's a candidate for previous quarter
                if (endDate < nowDate) {
                    previousQuarter = quarter.index;
                }
            }

            // If no quarter has ended yet, return the first quarter
            if (previousQuarter === null) {
                console.log(`[getPreviousQuarter] No quarter has ended yet, defaulting to Q1`);
                return quarters.length > 0 ? quarters[0].index : null;
            }

            console.log(`[getPreviousQuarter] Most recently completed quarter: Q${previousQuarter}`);
            return previousQuarter;
        }

        // Initialize quarterly costs for an item (ensures all quarters have cost entries)
        function initializeQuarterlyCosts(item) {
            if (!item.quarterlyCosts) {
                item.quarterlyCosts = {};
            }

            const quarters = calculateQuarters();
            quarters.forEach(q => {
                if (item.quarterlyCosts[`q${q.index}`] === undefined) {
                    item.quarterlyCosts[`q${q.index}`] = 0;
                }
            });

            return item;
        }

        // Calculate total costs claimed across all quarters for an item
        function getTotalCostsClaimed(item) {
            // DEPRECATED: Don't use item.quarterlyCosts - it contains stale data
            // Instead, calculate from actual transaction assignments

            // This function is called during rendering, and we don't have access to
            // the actual item context (category, index) here, so we still use quarterlyCosts
            // TODO: Replace this with proper calculation from assignments

            if (!item.quarterlyCosts) return 0;

            let total = 0;
            Object.values(item.quarterlyCosts).forEach(cost => {
                total += parseFloat(cost) || 0;
            });
            return total;
        }

        // NEW: Calculate costs claimed from actual transaction assignments
        function getItemClaimedFromTransactions(projectId, category, itemKey) {
            if (!cachedTransactions || cachedTransactions.length === 0) return 0;

            console.log(`üîç [COSTS] Calculating costs for: projectId=${projectId}, category=${category}, itemKey=${itemKey}`);

            let total = 0;
            let matchCount = 0;
            cachedTransactions.forEach(transaction => {
                if (!transaction.assignments) return;

                transaction.assignments.forEach(assignment => {
                    // Match project, category, and itemKey
                    const projectMatch = assignment.projectId === projectId || String(assignment.projectId) === String(projectId);
                    const categoryMatch = assignment.category === category;

                    // STRICT MATCH ONLY - no backwards compatibility for cost calculation
                    // Only count assignments that are specifically assigned to this item
                    const itemMatch = assignment.itemKey === itemKey;

                    if (projectMatch && categoryMatch && itemMatch) {
                        // FIX: Calculate amount dynamically from transaction ex-VAT value and percentage
                        // This ensures the total matches what's displayed in the assigned transactions table
                        const spentAmount = parseAmount(transaction.spent);

                        // Calculate ex-VAT amount (same logic as display)
                        let valueExTax = 0;
                        if (transaction.zeroVAT || transaction.spent_ex_vat) {
                            valueExTax = parseAmount(transaction.spent_ex_vat || transaction.spent);
                        } else {
                            valueExTax = spentAmount / 1.2; // 20% UK VAT
                        }

                        // Calculate assigned amount using percentage
                        const percentage = parseFloat(assignment.percentage) || 0;
                        const assignedAmount = (valueExTax * percentage) / 100;

                        // CRITICAL FIX: Round to 2 decimal places to match the display
                        // This ensures the sum matches what user sees in the table
                        const roundedAmount = Math.round(assignedAmount * 100) / 100;

                        console.log(`  ‚úì Match #${++matchCount}: ${transaction.description?.substring(0, 30)} | spent=${transaction.spent} | exVAT=${valueExTax.toFixed(2)} | ${percentage}% | assigned=${roundedAmount.toFixed(2)} (raw=${assignedAmount.toFixed(4)}) | stored=${assignment.amount}`);

                        total += roundedAmount;
                    }
                });
            });

            console.log(`üí∞ [COSTS] Total claimed: ¬£${total.toFixed(2)} (from ${matchCount} transactions)`);
            return total;
        }

        // Calculate remaining budget for an item
        function getRemainingBudget(item) {
            const totalBudget = parseFloat(item.totalCost || item.total || item.cost || 0);
            const costsClaimed = getTotalCostsClaimed(item);
            return totalBudget - costsClaimed;
        }

        // Calculate difference percentage for an item
        function getDifferencePercentage(item) {
            const totalBudget = parseFloat(item.totalCost || item.total || item.cost || 0);
            const costsClaimed = getTotalCostsClaimed(item);

            if (totalBudget === 0) return 0;

            return ((costsClaimed - totalBudget) / totalBudget) * 100;
        }

        // Calculate category-level summaries
        function getCategorySummary(items, category, itemKeyPrefix) {
            let totalCosts = 0;
            let totalClaimed = 0;
            const quarterlyTotals = {q1: 0, q2: 0, q3: 0, q4: 0};

            items.forEach((item, index) => {
                // Sum up total costs
                totalCosts += parseFloat(item.totalCost || item.total || item.cost || 0);

                // Calculate claimed from actual assignments if we have category and prefix
                let itemClaimed = 0;
                if (category && itemKeyPrefix && cachedTransactions) {
                    const itemKey = `${itemKeyPrefix}-${index}`;
                    itemClaimed = getItemClaimedFromTransactions(projectBudget.projectId, category, itemKey);

                    // Also calculate quarterly totals from assignments
                    cachedTransactions.forEach(transaction => {
                        if (!transaction.assignments) return;

                        transaction.assignments.forEach(assignment => {
                            const projectMatch = assignment.projectId === projectBudget.projectId;
                            const categoryMatch = assignment.category === category;
                            // STRICT MATCH - only count assignments specifically for this item
                            const itemMatch = assignment.itemKey === itemKey;

                            if (projectMatch && categoryMatch && itemMatch && assignment.quarter) {
                                // FIX: Calculate amount dynamically (same as getItemClaimedFromTransactions)
                                const spentAmount = parseAmount(transaction.spent);
                                let valueExTax = 0;
                                if (transaction.zeroVAT || transaction.spent_ex_vat) {
                                    valueExTax = parseAmount(transaction.spent_ex_vat || transaction.spent);
                                } else {
                                    valueExTax = spentAmount / 1.2;
                                }
                                const percentage = parseFloat(assignment.percentage) || 0;
                                const assignedAmount = (valueExTax * percentage) / 100;

                                // CRITICAL FIX: Round to match display
                                const roundedAmount = Math.round(assignedAmount * 100) / 100;

                                const qKey = `q${assignment.quarter}`;
                                quarterlyTotals[qKey] = (quarterlyTotals[qKey] || 0) + roundedAmount;
                            }
                        });
                    });
                } else {
                    // Fallback to old method if no category/prefix provided
                    initializeQuarterlyCosts(item);
                    itemClaimed = getTotalCostsClaimed(item);

                    Object.keys(item.quarterlyCosts || {}).forEach(quarterKey => {
                        quarterlyTotals[quarterKey] = (quarterlyTotals[quarterKey] || 0) + (parseFloat(item.quarterlyCosts[quarterKey]) || 0);
                    });
                }

                totalClaimed += itemClaimed;
            });

            const remaining = totalCosts - totalClaimed;
            const difference = totalCosts === 0 ? 0 : ((totalClaimed - totalCosts) / totalCosts) * 100;

            return {
                totalCosts,
                totalClaimed,
                remaining,
                difference,
                quarterlyTotals
            };
        }

        // Calculate total costs claimed across all categories
        function getTotalBudgetSummary() {
            let totalCostsClaimed = 0;

            // Sum costs claimed from all categories
            const categories = [
                projectBudget.welshGovData?.sections?.capital?.nonStandard || [],
                projectBudget.welshGovData?.sections?.revenue?.nonStandard || [],
                projectBudget.labour?.staff || [],
                projectBudget.materials?.items || [],
                projectBudget.capitalUsage?.items || [],
                projectBudget.subcontracting?.contractors || [],
                projectBudget.travel?.trips || (projectBudget.travel ? [projectBudget.travel] : []),
                projectBudget.otherCosts?.items || (projectBudget.otherCosts ? [projectBudget.otherCosts] : [])
            ];

            categories.forEach(categoryItems => {
                if (categoryItems && categoryItems.length > 0) {
                    const summary = getCategorySummary(categoryItems);
                    totalCostsClaimed += summary.totalClaimed;
                }
            });

            return totalCostsClaimed;
        }

        // Update quarterly cost for an item
        function updateQuarterlyCost(item, quarter, value) {
            if (!item.quarterlyCosts) {
                item.quarterlyCosts = {};
            }

            item.quarterlyCosts[`q${quarter}`] = parseFloat(value) || 0;

            // Update budget summary overview if it's currently visible
            const summarySection = document.getElementById('budgetSummaryOverview');
            if (summarySection && summarySection.style.display !== 'none') {
                summarySection.innerHTML = generateBudgetSummaryOverview();
            }

            // Auto-save after update
            saveToIndexedDB();
        }

        // Show delete confirmation popup - TEMPORARY: Using native confirm
        function showDeleteConfirmation(buttonElement, onConfirm) {
            console.log("üóëÔ∏è [DELETE] Using native confirm dialog");
            const confirmed = confirm("Delete this item?");
            console.log("üóëÔ∏è [DELETE] User response:", confirmed);
            if (confirmed) {
                console.log("üóëÔ∏è [DELETE] User confirmed, executing callback");
                onConfirm();
            } else {
                console.log("üóëÔ∏è [DELETE] User cancelled");
                deleteWelshGovItem.isDeleting = false;
            }
        }

        // Delete item from a category
        function deleteCategoryItem(buttonElement, categoryPath, index, categoryName) {
            showDeleteConfirmation(buttonElement, () => {
                // Navigate to the correct array based on category path
            let itemsArray;
            switch(categoryPath) {
                case 'labour.staff':
                    itemsArray = projectBudget.labour.staff;
                    break;
                case 'materials.items':
                    itemsArray = projectBudget.materials.items;
                    break;
                case 'capitalUsage.items':
                    itemsArray = projectBudget.capitalUsage.items;
                    break;
                case 'subcontracting.contractors':
                    itemsArray = projectBudget.subcontracting.contractors;
                    break;
                case 'travel.trips':
                    itemsArray = projectBudget.travel.trips;
                    break;
                case 'otherCosts.items':
                    itemsArray = projectBudget.otherCosts.items;
                    break;
                default:
                    console.error('Unknown category path:', categoryPath);
                    return;
            }

            // Remove the item
            if (itemsArray && index >= 0 && index < itemsArray.length) {
                const deletedItem = itemsArray[index];

                // Record action for undo BEFORE deleting
                const itemDescription = deletedItem.role || deletedItem.destination || deletedItem.item || deletedItem.name || 'Unknown';
                recordAction(
                    ACTION_TYPES.DELETE_ITEM,
                    categoryPath,
                    { item: deletedItem, index: index, categoryPath: categoryPath },
                    `Deleted "${itemDescription}" from ${categoryName}`
                );

                itemsArray.splice(index, 1);

                console.log(`Deleted item from ${categoryName}:`, deletedItem);

                // Re-render the budget display
                displayDetailedBudget();

                // Save to database
                saveToIndexedDB();

                addLog(`Deleted item from ${categoryName}`);
            }
            });
        }

        // Delete item from Welsh Gov categories
        function deleteWelshGovItem(buttonElement, sectionPath, index, categoryName) {
            // Debounce: prevent rapid multiple calls
            if (deleteWelshGovItem.isDeleting) {
                console.log('üóëÔ∏è [DELETE WELSH] BLOCKED - Already processing a delete');
                return;
            }
            deleteWelshGovItem.isDeleting = true;
            setTimeout(() => { deleteWelshGovItem.isDeleting = false; }, 1000);
            console.log('üóëÔ∏è [DELETE WELSH] deleteWelshGovItem called');
            console.log('üóëÔ∏è [DELETE WELSH] Parameters:', { buttonElement, sectionPath, index, categoryName });
            console.log('üóëÔ∏è [DELETE WELSH] Button element:', buttonElement);
            showDeleteConfirmation(buttonElement, () => {
                // Navigate to the correct array based on section path
            let itemsArray;
            switch(sectionPath) {
                case 'capital.nonStandard':
                    itemsArray = projectBudget.welshGovData.sections.capital.nonStandard;
                    break;
                case 'revenue.nonStandard':
                    itemsArray = projectBudget.welshGovData.sections.revenue.nonStandard;
                    break;
                case 'revenue.standardCosts':
                    itemsArray = projectBudget.welshGovData.sections.revenue.standardCosts;
                    break;
                case 'itemBreakdown.capital':
                    itemsArray = projectBudget.welshGovData.sections.itemBreakdown.capital;
                    break;
                case 'itemBreakdown.revenue':
                    itemsArray = projectBudget.welshGovData.sections.itemBreakdown.revenue;
                    break;
                default:
                    console.error('Unknown Welsh Gov section path:', sectionPath);
                    return;
            }

            // Remove the item
            if (itemsArray && index >= 0 && index < itemsArray.length) {
                const deletedItem = itemsArray[index];

                // Record action for undo BEFORE deleting
                const itemDescription = deletedItem.description || deletedItem.item || deletedItem.name || 'Unknown';
                recordAction(
                    ACTION_TYPES.DELETE_ITEM,
                    'welshGov.' + sectionPath,
                    { item: deletedItem, index: index, categoryPath: 'welshGov.' + sectionPath, sectionPath: sectionPath },
                    `Deleted "${itemDescription}" from ${categoryName}`
                );

                itemsArray.splice(index, 1);

                console.log(`Deleted Welsh Gov item from ${categoryName}:`, deletedItem);

                // Re-render the Welsh Gov budget display
                displayWelshGovBudget(projectBudget.welshGovData);

                // Save to database
                saveToIndexedDB();

                addLog(`Deleted item from ${categoryName}`);
            }
            });
        }

        // Update quarterly cost at category level - distributes value across all items
        function updateCategoryQuarterlyCost(categoryItems, quarter, newValue, categoryName, categoryKey) {
            const quarterKey = `q${quarter}`;
            const newTotal = parseFloat(newValue) || 0;

            // Initialize quarterly costs for all items if needed
            categoryItems.forEach(item => {
                if (!item.quarterlyCosts) {
                    item.quarterlyCosts = {q1: 0, q2: 0, q3: 0, q4: 0};
                }
            });

            // Calculate current total for this quarter
            const currentTotal = categoryItems.reduce((sum, item) => {
                return sum + (item.quarterlyCosts[quarterKey] || 0);
            }, 0);

            // If new total is 0, clear all items for this quarter
            if (newTotal === 0) {
                categoryItems.forEach(item => {
                    item.quarterlyCosts[quarterKey] = 0;
                });
            }
            // If current total is 0 but new total is not, distribute equally
            else if (currentTotal === 0) {
                const perItem = newTotal / categoryItems.length;
                categoryItems.forEach(item => {
                    item.quarterlyCosts[quarterKey] = perItem;
                });
            }
            // Otherwise, distribute proportionally based on existing values
            else {
                const ratio = newTotal / currentTotal;
                categoryItems.forEach(item => {
                    const currentItemValue = item.quarterlyCosts[quarterKey] || 0;
                    item.quarterlyCosts[quarterKey] = currentItemValue * ratio;
                });
            }

            // Update budget summary overview if it's currently visible
            const summarySection = document.getElementById('budgetSummaryOverview');
            if (summarySection && summarySection.style.display !== 'none') {
                summarySection.innerHTML = generateBudgetSummaryOverview();
            }

            // Auto-save after update
            saveToIndexedDB();
        }

        // Toggle quarterly breakdown visibility
        function toggleQuarterlyBreakdown(rowId) {
            const breakdownRow = document.getElementById(`${rowId}-breakdown`);
            if (breakdownRow) {
                const isCurrentlyHidden = breakdownRow.style.display === 'none' || breakdownRow.style.display === '';
                // Use 'table-row' for proper table row display
                breakdownRow.style.display = isCurrentlyHidden ? 'table-row' : 'none';

                console.log(`üîΩ [TOGGLE] ${rowId}: ${isCurrentlyHidden ? 'SHOWING' : 'HIDING'}`);

                // Enhanced diagnostics when opening
                if (isCurrentlyHidden) {
                    const container = breakdownRow.querySelector('.quarterly-breakdown-container');
                    const transactionTable = breakdownRow.querySelector('.transaction-details-table');
                    const transactionRows = transactionTable ? transactionTable.querySelectorAll('tbody tr') : [];

                    console.log(`üì¶ [DEBUG] Breakdown row HTML length: ${breakdownRow.innerHTML.length} chars`);
                    console.log(`üì¶ [DEBUG] Container exists: ${!!container}`);
                    console.log(`üì¶ [DEBUG] Transaction table exists: ${!!transactionTable}`);
                    console.log(`üì¶ [DEBUG] Transaction rows found: ${transactionRows.length}`);
                    console.log(`üì¶ [DEBUG] Breakdown row display: ${breakdownRow.style.display}`);
                    console.log(`üì¶ [DEBUG] Breakdown row offsetHeight: ${breakdownRow.offsetHeight}px`);

                    if (container) {
                        console.log(`üì¶ [DEBUG] Container offsetHeight: ${container.offsetHeight}px`);
                        console.log(`üì¶ [DEBUG] Container innerHTML preview: ${container.innerHTML.substring(0, 200)}...`);
                    }
                }

                // Update arrow indicator
                const arrow = document.getElementById(`${rowId}-arrow`);
                if (arrow) {
                    arrow.textContent = isCurrentlyHidden ? '‚ñº' : '‚ñ∂';
                }
            } else {
                console.log(`‚ùå [TOGGLE] Element not found: ${rowId}-breakdown`);
            }
        }

        // Toggle quarterly breakdown table visibility (triggered by Q button)
        function toggleQuarterlyTable(tableId) {
            const table = document.getElementById(tableId);
            if (table) {
                const isCurrentlyHidden = table.style.display === 'none';
                table.style.display = isCurrentlyHidden ? 'block' : 'none';
            }
        }

        // Get total forecast across all quarters for a category
        function getTotalForecast(categoryForecast) {
            if (!categoryForecast) return 0;
            return (categoryForecast['q1'] || 0) +
                   (categoryForecast['q2'] || 0) +
                   (categoryForecast['q3'] || 0) +
                   (categoryForecast['q4'] || 0);
        }

        // Calculate forecast for empty quarters in a category
        function calculateCategoryForecast(categoryItems, categoryForecast) {
            const summary = getCategorySummary(categoryItems);
            const remaining = summary.remaining;

            // Find quarters with BOTH zero claimed AND zero forecast
            const emptyQuarters = [];
            for (let q = 1; q <= 4; q++) {
                const claimed = summary.quarterlyTotals['q' + q] || 0;
                const forecast = categoryForecast['q' + q] || 0;
                if (claimed === 0 && forecast === 0) {
                    emptyQuarters.push(q);
                }
            }

            // If no empty quarters or no remaining budget, do nothing
            if (emptyQuarters.length === 0 || remaining <= 0) {
                return false;
            }

            // Split remaining budget evenly
            const forecastPerQuarter = remaining / emptyQuarters.length;

            // Update forecast values
            emptyQuarters.forEach(q => {
                categoryForecast['q' + q] = forecastPerQuarter;
            });

            saveToIndexedDB();
            return true;
        }

        // Update category forecast for a specific quarter
        function updateCategoryForecast(categoryForecast, quarter, value) {
            categoryForecast['q' + quarter] = parseFloat(value) || 0;
            saveToIndexedDB();
        }

        // Update forecast UI without full page re-render
        function refreshForecastUI(clickedElement, categoryForecast, categoryItems) {
            try {
                // Find the forecast row (the row that was clicked)
                const forecastRow = clickedElement.closest('tr');
                if (!forecastRow) return;

                // Find all input fields in this row and update them
                const inputs = forecastRow.querySelectorAll('input[type="number"]');
                inputs.forEach((input, idx) => {
                    const quarter = idx + 1;
                    const forecastValue = categoryForecast['q' + quarter] || 0;
                    input.value = forecastValue.toFixed(2);
                });

                // Update the total forecast cell (last cell in the forecast row)
                const totalCell = forecastRow.querySelector('td:last-child');
                if (totalCell) {
                    const totalForecast = getTotalForecast(categoryForecast);
                    totalCell.textContent = `¬£${totalForecast.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                }

                // Update budget remaining row (next row after forecast)
                const budgetRow = forecastRow.nextElementSibling;
                if (budgetRow) {
                    const summary = getCategorySummary(categoryItems);
                    const budgetCell = budgetRow.querySelector('td:last-child');
                    if (budgetCell) {
                        const remainingAfterForecast = summary.remaining - getTotalForecast(categoryForecast);
                        budgetCell.textContent = `¬£${remainingAfterForecast.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                        // Update color
                        budgetCell.style.color = remainingAfterForecast < 0 ? '#d32f2f' : '#2e7d32';
                    }
                }
            } catch (error) {
                console.error('Error refreshing forecast UI:', error);
            }
        }

        // Toggle budget summary overview
        function toggleBudgetSummaryOverview() {
            const summarySection = document.getElementById('budgetSummaryOverview');
            if (!summarySection) return;

            const isCurrentlyHidden = summarySection.style.display === 'none';

            if (isCurrentlyHidden) {
                // Generate and show the summary
                summarySection.innerHTML = generateBudgetSummaryOverview();
                summarySection.style.display = 'block';

                // Update button text
                const button = event.target;
                button.textContent = 'Hide Budget Summary Overview';
            } else {
                // Hide the summary
                summarySection.style.display = 'none';

                // Update button text
                const button = event.target;
                button.textContent = 'Show Budget Summary Overview';
            }
        }

        // Toggle category section collapse
        function toggleCategorySection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;

            const isHidden = section.style.display === 'none';
            section.style.display = isHidden ? 'block' : 'none';

            // Update arrow indicator
            const arrowId = sectionId.replace('-details', '-arrow');
            const arrow = document.getElementById(arrowId);
            if (arrow) {
                arrow.textContent = isHidden ? '‚ñº' : '‚ñ∂';
            }
        }

        // Helper function to map category keys to their data in projectBudget
        function getCategoryDataMapping(categoryKey, isWelshGov) {
            // Welsh Gov mappings
            if (isWelshGov && projectBudget.welshGovData) {
                const sections = projectBudget.welshGovData.sections;
                const welshGovMappings = {
                    'capitalNonStandard': { items: sections?.capital?.nonStandard || [] },
                    'revenueNonStandard': { items: sections?.revenue?.nonStandard || [] },
                    'revenueStandard': { items: sections?.revenue?.standardCosts || [] },
                    'itemBreakdownCapital': { items: sections?.itemBreakdown?.capital || [] },
                    'itemBreakdownRevenue': { items: sections?.itemBreakdown?.revenue || [] }
                };
                return welshGovMappings[categoryKey] || { items: [] };
            }

            // IUK mappings
            const iukMappings = {
                'labour': { items: projectBudget.labour?.staff || [] },
                'overheads': { items: [], totalCost: projectBudget.overheads?.totalCost || 0 },
                'materials': { items: projectBudget.materials?.items || [] },
                'capitalUsage': { items: projectBudget.capitalUsage?.items || [] },
                'subcontracting': { items: projectBudget.subcontracting?.contractors || [] },
                'travel': { items: projectBudget.travel?.trips || [] },
                'otherCosts': { items: projectBudget.otherCosts?.items || [] }
            };

            // Check if it's a custom category (not in standard mappings)
            if (!iukMappings[categoryKey]) {
                // For custom categories, try to find matching data or return empty
                // This allows users to add categories that will be displayed even if empty
                return { items: [] };
            }

            return iukMappings[categoryKey] || { items: [] };
        }

        // Generate budget summary overview HTML
        function generateBudgetSummaryOverview() {
            const quarters = calculateQuarters();
            if (quarters.length === 0) {
                return '<p style="color: #64748b; text-align: center; padding: 20px;">Set project dates to view budget summary</p>';
            }

            // Check if this is a Welsh Gov project
            const isWelshGov = projectBudget.fundingBody === 'Welsh Gov' || projectBudget.welshGovData;

            let categories = [];

            // Use custom category order if available
            if (projectBudget.customCategories && projectBudget.customCategories.length > 0) {
                // Map custom categories to their data
                categories = projectBudget.customCategories.map(customCat => {
                    const categoryMapping = getCategoryDataMapping(customCat.key, isWelshGov);
                    return {
                        key: customCat.key,
                        name: customCat.name,
                        items: categoryMapping.items || [],
                        totalCost: categoryMapping.totalCost || 0
                    };
                });
            } else if (isWelshGov && projectBudget.welshGovData) {
                // Welsh Gov categories (default order)
                const sections = projectBudget.welshGovData.sections;
                categories = [
                    { key: 'capitalNonStandard', name: 'Capital - Non Standard Costs', items: sections?.capital?.nonStandard || [] },
                    { key: 'revenueNonStandard', name: 'Revenue - Non Standard Costs', items: sections?.revenue?.nonStandard || [] },
                    { key: 'revenueStandard', name: 'Revenue - Standard Costs', items: sections?.revenue?.standardCosts || [] },
                    { key: 'itemBreakdownCapital', name: 'Item Breakdown - Capital', items: sections?.itemBreakdown?.capital || [] },
                    { key: 'itemBreakdownRevenue', name: 'Item Breakdown - Revenue', items: sections?.itemBreakdown?.revenue || [] }
                ];
            } else {
                // IUK categories (default order)
                categories = [
                    { key: 'labour', name: 'Labour', items: projectBudget.labour?.staff || [] },
                    { key: 'overheads', name: 'Overheads', items: [], totalCost: projectBudget.overheads?.totalCost || 0 },
                    { key: 'materials', name: 'Materials', items: projectBudget.materials?.items || [] },
                    { key: 'capitalUsage', name: 'Capital usage', items: projectBudget.capitalUsage?.items || [] },
                    { key: 'subcontracting', name: 'Subcontracting', items: projectBudget.subcontracting?.contractors || [] },
                    { key: 'travel', name: 'Travel and subsistence', items: projectBudget.travel?.trips || [] },
                    { key: 'otherCosts', name: 'Other costs', items: projectBudget.otherCosts?.items || [] }
                ];
            }

            let grandTotalCosts = 0;
            let grandTotalClaimedThisPeriod = 0;
            let grandTotalRemaining = 0;

            let tableRows = '';

            categories.forEach(category => {
                let categoryTotal = 0;
                let categoryClaimedThisPeriod = 0;
                let categoryTotalClaimed = 0;

                // Special handling for overheads (has direct totalCost, no items)
                if (category.key === 'overheads') {
                    categoryTotal = category.totalCost;
                } else if (category.items.length > 0) {
                    // Calculate category totals from items
                    category.items.forEach(item => {
                        // Handle different cost field names for Welsh Gov vs IUK
                        let itemTotal = 0;
                        if (isWelshGov) {
                            // Welsh Gov items use maxGrantValue or maxGrantApproved
                            itemTotal = parseFloat(item.maxGrantValue || item.maxGrantApproved || item.totalCost || 0);
                        } else {
                            // IUK items use various field names
                            itemTotal = parseFloat(item.totalCost || item.total || item.cost || item.netCost || item.estimatedCost || 0);
                        }
                        categoryTotal += itemTotal;

                        // Initialize quarterly costs
                        initializeQuarterlyCosts(item);

                        // Calculate claimed this period (active quarter)
                        if (activeQuarterIndex) {
                            const claimedInActiveQuarter = parseFloat(item.quarterlyCosts[`q${activeQuarterIndex}`]) || 0;
                            categoryClaimedThisPeriod += claimedInActiveQuarter;
                        }

                        // Calculate total claimed across all quarters
                        categoryTotalClaimed += getTotalCostsClaimed(item);
                    });
                }

                // Only include categories that have costs
                if (categoryTotal > 0 || category.items.length > 0) {
                    const categoryRemaining = categoryTotal - categoryTotalClaimed;

                    grandTotalCosts += categoryTotal;
                    grandTotalClaimedThisPeriod += categoryClaimedThisPeriod;
                    grandTotalRemaining += categoryRemaining;

                    tableRows += `
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 12px; color: #667eea; font-weight: 500;">${category.name}</td>
                            <td style="padding: 12px; text-align: right;">¬£${categoryTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td style="padding: 12px; text-align: right; ${categoryClaimedThisPeriod > 0 ? 'font-weight: 600; color: #2563eb;' : ''}">¬£${categoryClaimedThisPeriod.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td style="padding: 12px; text-align: right; ${categoryRemaining < 0 ? 'color: #dc2626; font-weight: 600;' : ''}">¬£${categoryRemaining.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        </tr>
                    `;
                }
            });

            return `
                <div class="category-section" style="margin-top: 20px; background: white; border: 2px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Budget Summary Overview${activeQuarterIndex ? ` - Q${activeQuarterIndex} Active` : ''}</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Category</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600;">Total eligible costs</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600;">Costs claimed this period</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600;">Remaining eligible costs</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                            <tr style="background: #f8fafc; border-top: 3px solid #667eea; font-weight: 700; font-size: 1.05em;">
                                <td style="padding: 15px; color: #1e293b;">Total</td>
                                <td style="padding: 15px; text-align: right; color: #1e293b;">¬£${grandTotalCosts.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                <td style="padding: 15px; text-align: right; color: ${grandTotalClaimedThisPeriod > 0 ? '#2563eb' : '#1e293b'};">¬£${grandTotalClaimedThisPeriod.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                <td style="padding: 15px; text-align: right; color: ${grandTotalRemaining < 0 ? '#dc2626' : '#1e293b'};">¬£${grandTotalRemaining.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            </tr>
                        </tbody>
                    </table>
                    ${activeQuarterIndex ? `
                        <p style="margin-top: 12px; color: #64748b; font-size: 0.9em; font-style: italic;">
                            * "Costs claimed this period" shows costs claimed in Q${activeQuarterIndex}. Activate a different quarter to see its claimed costs.
                        </p>
                    ` : `
                        <p style="margin-top: 12px; color: #64748b; font-size: 0.9em; font-style: italic;">
                            * Click a quarter button above to see "Costs claimed this period" for that quarter.
                        </p>
                    `}
                </div>
            `;
        }

        // Track active quarter for highlighting
        let activeQuarterIndex = null; // Will be initialized to previous quarter on load

        async function setActiveQuarter(quarterIndex) {
            activeQuarterIndex = quarterIndex;

            // Refresh the entire budget display to update button states and summary
            await displayDetailedBudget();

            addLog(`‚úÖ Active quarter set to Q${quarterIndex}`);

            // Scroll to the quarterly tracking section
            const quarterSection = document.getElementById('quarterControlsSection');
            if (quarterSection) {
                quarterSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Delete Project Functions - Immediate deletion without confirmation - v2.0 Updated
        async function deleteProjectImmediately(projectId, projectName) {
            console.log(`üóëÔ∏è [DELETE v2.0] Starting deletion for project ${projectId}: ${projectName}`);

            if (!db) {
                console.error('‚ùå [DELETE] Database not initialized');
                addLog('‚ùå Cannot delete: Database not initialized');
                alert('Database not initialized. Please refresh the page.');
                return;
            }

            console.log(`üóëÔ∏è [DELETE] Database OK, creating transaction...`);

            try {
                // Delete from IndexedDB
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.delete(projectId);

                console.log(`üóëÔ∏è [DELETE] Delete request sent for ID: ${projectId}`);

                request.onsuccess = async () => {
                    console.log(`‚úÖ [DELETE] Project ${projectId} successfully deleted from IndexedDB`);
                    addLog(`üóëÔ∏è Deleted from local: ${projectName} (ID: ${projectId})`);

                    // Also delete from Supabase (cloud)
                    try {
                        if (typeof supabaseClient !== 'undefined') {
                            const { data: { user } } = await supabaseClient.auth.getUser();
                            if (user) {
                                const { error } = await supabaseClient
                                    .from('grants')
                                    .delete()
                                    .eq('user_id', user.id)
                                    .eq('project_id', String(projectId));

                                if (error) {
                                    console.error('‚ùå [DELETE] Supabase delete failed:', error);
                                    addLog(`‚ö†Ô∏è Cloud delete failed: ${error.message}`);
                                } else {
                                    console.log(`‚úÖ [DELETE] Project ${projectId} deleted from Supabase`);
                                    addLog(`‚òÅÔ∏è Deleted from cloud: ${projectName}`);
                                }
                            }
                        }
                    } catch (cloudError) {
                        console.error('‚ùå [DELETE] Cloud delete error:', cloudError);
                    }

                    // If this was the current project, clear it
                    if (projectBudget.projectId === projectId) {
                        console.log(`üßπ [DELETE] Clearing current project data (was active project)`);
                        clearAll();
                    } else {
                        console.log(`‚ÑπÔ∏è [DELETE] Not active project, skipping clearAll()`);
                    }

                    // Reload the dropdown to reflect deletion
                    const dropdown = document.getElementById('savedProjectsDropdown');
                    if (dropdown) {
                        console.log(`üîÑ [DELETE] Dropdown exists, display state: ${dropdown.style.display}`);
                        if (dropdown.style.display === 'block') {
                            console.log(`üîÑ [DELETE] Refreshing projects dropdown...`);
                            listSavedProjects();
                        } else {
                            console.log(`‚ÑπÔ∏è [DELETE] Dropdown hidden, skipping refresh`);
                        }
                    } else {
                        console.warn(`‚ö†Ô∏è [DELETE] Dropdown element not found`);
                    }

                    console.log(`‚úÖ [DELETE] Deletion complete from local AND cloud!`);
                };

                request.onerror = (event) => {
                    console.error('‚ùå [DELETE] Delete failed:', event.target.error);
                    addLog(`‚ùå Failed to delete project: ${event.target.error}`);
                    alert(`Failed to delete project: ${event.target.error}`);
                };

                transaction.oncomplete = () => {
                    console.log(`‚úÖ [DELETE] Transaction completed successfully`);
                };

                transaction.onerror = (event) => {
                    console.error('‚ùå [DELETE] Transaction error:', event.target.error);
                };

            } catch (error) {
                console.error('‚ùå [DELETE] Exception caught:', error);
                console.error('‚ùå [DELETE] Stack trace:', error.stack);
                addLog(`‚ùå Delete error: ${error.message}`);
                alert(`Error deleting project: ${error.message}`);
            }
        }

        function clearAll() {
            // Clear input
            document.getElementById('budgetInput').value = '';

            // Clear data arrays
            budgetData = [];
            logs = [];

            // Reset project budget (preserve structure but clear data)
            projectBudget.projectId = null;
            projectBudget.projectName = '';
            projectBudget.projectNumber = '';
            projectBudget.lastModified = null;

            // Clear logs display
            document.getElementById('logContainer').innerHTML = '<div class="log-empty">No logs yet...</div>';
            document.getElementById('logCount').textContent = '0 entries';

            // Hide results section
            const results = document.getElementById('results');
            if (results) results.classList.remove('show');

            const detailedResults = document.getElementById('detailedBudgetResults');
            if (detailedResults) detailedResults.classList.remove('show');

            // Reset project dropdown button
            const currentProjectNameElement = document.getElementById('currentProjectName');
            if (currentProjectNameElement) {
                currentProjectNameElement.textContent = 'Select Project';
            }

            console.log('‚úÖ All data cleared');
        }

        // Toggle fullscreen mode for textarea
        function toggleFullscreenTextarea() {
            const textarea = document.getElementById('budgetInput');

            if (!document.fullscreenElement) {
                // Enter fullscreen
                textarea.requestFullscreen().then(() => {
                    // Apply fullscreen styles
                    textarea.style.width = '100vw';
                    textarea.style.height = '100vh';
                    textarea.style.fontSize = '1em';
                    textarea.style.padding = '20px';
                    textarea.style.margin = '0';
                    textarea.style.border = 'none';
                    textarea.style.borderRadius = '0';
                }).catch(err => {
                    console.error('Failed to enter fullscreen:', err);
                    alert('Fullscreen not supported on this browser');
                });
            } else {
                // Exit fullscreen
                document.exitFullscreen();
            }
        }

        // Reset textarea styles when exiting fullscreen
        document.addEventListener('fullscreenchange', () => {
            const textarea = document.getElementById('budgetInput');
            if (!document.fullscreenElement) {
                // Reset to normal styles
                textarea.style.width = '';
                textarea.style.height = '60px';
                textarea.style.fontSize = '0.85em';
                textarea.style.padding = '8px 12px';
                textarea.style.border = '1px solid #cbd5e1';
                textarea.style.borderRadius = '6px';
            }
        });

        /**
         * Animated navigation to transaction assignment
         * This orchestrates a multi-step animation sequence:
         * 1. Wait for page load
         * 2. Scroll to category section
         * 3. Find and scroll to budget item
         * 4. Expand the item breakdown
         * 5. Scroll to and highlight the transaction
         */
        async function checkForTransactionHighlight() {
            const urlParams = new URLSearchParams(window.location.search);

            if (urlParams.get('highlightTransaction') !== 'true') {
                return;
            }

            const projectId = urlParams.get('projectId');
            const category = urlParams.get('category');
            const itemKey = urlParams.get('itemKey');
            const transactionDate = urlParams.get('transactionDate');
            const transactionDescription = urlParams.get('transactionDescription');

            if (!transactionDate || !transactionDescription || !category || !itemKey) {
                console.log('‚ùå Missing transaction parameters for highlighting');
                return;
            }

            console.log('üé¨ Starting animated navigation sequence:', {
                projectId, category, itemKey, transactionDate, transactionDescription
            });

            // Helper function to wait
            const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            // Helper function to scroll smoothly to element
            const scrollToElement = (element, offset = 0) => {
                const elementTop = element.getBoundingClientRect().top + window.pageYOffset;
                window.scrollTo({
                    top: elementTop + offset - 100, // 100px offset from top
                    behavior: 'smooth'
                });
            };

            try {
                // STEP 1: Wait for page to fully render
                console.log('‚è≥ Step 1: Waiting for page to render...');
                await wait(1000);

                // STEP 2: Find the category section
                console.log('üîç Step 2: Finding category section...');
                const categorySections = document.querySelectorAll('.category-section');
                let targetCategorySection = null;

                for (const section of categorySections) {
                    // Try to find by category-badge
                    const categoryBadge = section.querySelector('.category-badge');
                    if (categoryBadge && categoryBadge.textContent.trim() === category) {
                        targetCategorySection = section;
                        break;
                    }

                    // Also try to find by h3 heading (for IUK budgets)
                    const h3 = section.querySelector('h3');
                    if (h3) {
                        const h3Text = h3.textContent;
                        // Check if h3 contains the category name (e.g., "üìã Other Costs (¬£123)")
                        if (h3Text.includes(category)) {
                            targetCategorySection = section;
                            break;
                        }
                    }
                }

                if (!targetCategorySection) {
                    console.log(`‚ùå Category section not found: ${category}`);
                    alert(`Category "${category}" not found on this page. Make sure the correct budget is loaded.`);
                    return;
                }

                // STEP 3: Scroll to category
                console.log('üìú Step 3: Scrolling to category...');
                targetCategorySection.style.transition = 'all 0.2s ease';
                targetCategorySection.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.5)';
                scrollToElement(targetCategorySection);
                await wait(400);

                // STEP 4: Find the budget item row
                console.log('üîç Step 4: Finding budget item...');
                const table = targetCategorySection.querySelector('table');
                if (!table) {
                    console.log('‚ùå Table not found in category section');
                    return;
                }

                // Helper function to generate possible onclick ID formats
                function getPossibleOnclickIds(itemKey) {
                    const ids = [itemKey]; // Try exact match first

                    // Map common itemKey formats to onclick ID formats
                    const mappings = {
                        'capitalNonStandard': 'wg-capital-ns',
                        'revenueNonStandard': 'wg-revenue-ns',
                        'revenueStandard': 'wg-revenue-std',
                        'itemBreakdownCapital': 'item-capital',
                        'itemBreakdownRevenue': 'item-revenue',
                        'materials': 'materials',
                        'capitalUsage': 'capital',
                        'subcontracting': 'subcontracting',
                        'travel': 'travel',
                        'otherCosts': 'othercosts',  // IUK format is lowercase
                        'labour': 'labour'
                    };

                    // Extract prefix and index from itemKey (e.g., "capitalNonStandard-5")
                    const match = itemKey.match(/^(.+)-(\d+|general)$/);
                    if (match) {
                        const [, prefix, index] = match;
                        if (mappings[prefix]) {
                            ids.push(`${mappings[prefix]}-${index}`);
                        }

                        // Also try lowercase version of the whole prefix
                        ids.push(`${prefix.toLowerCase()}-${index}`);
                    }

                    return ids;
                }

                // Look for the row that has an onclick matching one of the possible IDs
                const allRows = table.querySelectorAll('tr[onclick*="toggleQuarterlyBreakdown"]');
                let targetItemRow = null;
                let breakdownId = null;

                const possibleIds = getPossibleOnclickIds(itemKey);
                console.log('üîç Searching for onclick IDs:', possibleIds);

                for (const row of allRows) {
                    const onclickAttr = row.getAttribute('onclick');
                    if (!onclickAttr) continue;

                    // Extract the ID from onclick="toggleQuarterlyBreakdown('id')"
                    const match = onclickAttr.match(/toggleQuarterlyBreakdown\('([^']+)'\)/);
                    if (match) {
                        const rowId = match[1];
                        // Check if this row ID matches any of our possible IDs
                        if (possibleIds.some(id => rowId.includes(id) || id.includes(rowId))) {
                            targetItemRow = row;
                            breakdownId = rowId;
                            console.log('‚úÖ Found matching row with ID:', rowId);
                            break;
                        }
                    }
                }

                if (!targetItemRow || !breakdownId) {
                    console.log(`‚ùå Budget item not found: ${itemKey}`);
                    // Try to find transaction anyway
                    await findAndHighlightTransaction();
                    return;
                }

                // STEP 5: Scroll to and highlight the item row
                console.log('üìú Step 5: Scrolling to budget item...');
                targetItemRow.style.transition = 'all 0.2s ease';
                targetItemRow.style.backgroundColor = '#fef3c7';
                scrollToElement(targetItemRow);
                await wait(300);

                // STEP 6: Expand the breakdown
                console.log('üìÇ Step 6: Expanding item breakdown...');
                const breakdownRow = document.getElementById(`${breakdownId}-breakdown`);
                if (breakdownRow) {
                    if (breakdownRow.style.display === 'none') {
                        breakdownRow.style.display = 'table-row';
                    }
                    await wait(300);
                } else {
                    console.log(`‚ö†Ô∏è Breakdown row not found: ${breakdownId}-breakdown`);
                }

                // Reset item row highlight
                targetItemRow.style.backgroundColor = '';

                // STEP 7: Find the transaction row
                console.log('üîç Step 7: Finding transaction row...');
                await findAndHighlightTransaction();

                // STEP 8: Remove category highlight
                await wait(500);
                targetCategorySection.style.boxShadow = '';

            } catch (error) {
                console.error('‚ùå Error during animated navigation:', error);
            }

            // Helper function to find and highlight transaction
            async function findAndHighlightTransaction() {
                await wait(200);

                const allTransactionRows = document.querySelectorAll('tr[data-transaction-date]');
                console.log(`üîç Searching ${allTransactionRows.length} transaction rows...`);

                let foundRow = null;
                for (const row of allTransactionRows) {
                    const rowDate = row.getAttribute('data-transaction-date');
                    const rowDesc = row.getAttribute('data-transaction-description');

                    if (rowDate === transactionDate && rowDesc === transactionDescription) {
                        foundRow = row;
                        break;
                    }
                }

                if (foundRow) {
                    console.log('‚úÖ Step 8: Transaction found! Scrolling and highlighting...');

                    // Scroll to transaction
                    await wait(200);
                    scrollToElement(foundRow, -50);
                    await wait(300);

                    // Add highlight animation
                    foundRow.classList.add('transaction-highlight');

                    // Remove highlight after animation completes
                    setTimeout(() => {
                console.log('üóëÔ∏è [DELETE] Setting up click-outside listener with 100ms delay');
                        foundRow.classList.remove('transaction-highlight');
                    }, 6500);

                    console.log('üéâ Animation sequence complete!');
                } else {
                    console.log('‚ùå Transaction not found in rendered rows');
                    alert('Transaction details loaded, but the specific transaction was not found. It may be in a different quarter or project.');
                }

                // Clean up URL parameters
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
            }
        }

        // Run animated navigation after page load
        setTimeout(checkForTransactionHighlight, 2000);

        /**
         * Navigate to spend page and highlight transaction (reverse of viewAssignment)
         */
        function viewInSpend(transactionDate, transactionDescription) {
            console.log('üîÑ Navigating to spend page:', { transactionDate, transactionDescription });

            // Create URL parameters
            const params = new URLSearchParams({
                transactionDate: transactionDate,
                transactionDescription: transactionDescription,
                highlightTransaction: 'true'
            });

            // Navigate to spend.html with parameters
            window.location.href = `spend.html?${params.toString()}`;
        }

        /**
         * Unassign a transaction from a grant item
         */
        async function unassignTransaction(transactionDate, transactionDescription, projectId, category, itemKey) {
            console.log('üîÑ [UNASSIGN] Starting unassignment:', { transactionDate, transactionDescription, projectId, category, itemKey });

            // Confirm with user
            if (!confirm(`Remove this transaction assignment?\n\nTransaction: ${transactionDescription}\nDate: ${transactionDate}\n\nThe transaction will remain in your spend data but won't be linked to this grant item.`)) {
                return;
            }

            try {
                if (!db) await initIndexedDB();
                if (!db) throw new Error('Database not available');

                // Get all CSV files from SpendDB
                const txn = db.transaction([CSV_STORE_NAME], 'readwrite');
                const store = txn.objectStore(CSV_STORE_NAME);
                const allFiles = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                let updated = false;
                let removedAssignment = null;

                for (const file of allFiles) {
                    if (file.transactions && Array.isArray(file.transactions)) {
                        const txIndex = file.transactions.findIndex(t =>
                            t.date === transactionDate && t.description === transactionDescription
                        );

                        if (txIndex !== -1) {
                            const transaction = file.transactions[txIndex];
                            console.log(`‚úÖ [UNASSIGN] Found transaction with ${transaction.assignments?.length || 0} assignments`);
                            console.log(`üîç [UNASSIGN] Looking for: projectId=${projectId}, category=${category}, itemKey=${itemKey}`);
                            console.log(`üîç [UNASSIGN] Available assignments:`, transaction.assignments?.map(a => ({
                                projectId: a.projectId,
                                projectIdType: typeof a.projectId,
                                category: a.category,
                                itemKey: a.itemKey,
                                itemKeyType: typeof a.itemKey
                            })));

                            if (transaction.assignments && Array.isArray(transaction.assignments)) {
                                // Find the assignment to remove using same logic as renderTransactionDetails
                                const assignmentIndex = transaction.assignments.findIndex(a => {
                                    // Project match - try both direct and string comparison
                                    const projectMatch = a.projectId === projectId ||
                                                        String(a.projectId) === String(projectId) ||
                                                        a.projectId == projectId;

                                    // Category match
                                    const categoryMatch = a.category === category;

                                    // Item key match with backwards compatibility
                                    let itemMatch = false;
                                    if (itemKey === null || itemKey === undefined || itemKey === 'null' || itemKey === 'undefined' || itemKey.endsWith('-all')) {
                                        // Category-level: match any assignment in this category
                                        itemMatch = true;
                                    } else {
                                        // Item-level match
                                        if (a.itemKey === itemKey) {
                                            itemMatch = true;
                                        } else if (!a.itemKey || a.itemKey === null || a.itemKey === undefined) {
                                            // Old assignment without itemKey - match if same category
                                            itemMatch = true;
                                        } else if (String(a.itemKey) === String(itemKey)) {
                                            itemMatch = true;
                                        }
                                    }

                                    console.log(`üîç [UNASSIGN] Checking assignment:`, {
                                        aProjectId: a.projectId,
                                        aCategory: a.category,
                                        aItemKey: a.itemKey,
                                        projectMatch,
                                        categoryMatch,
                                        itemMatch
                                    });

                                    return projectMatch && categoryMatch && itemMatch;
                                });

                                if (assignmentIndex !== -1) {
                                    // Store the removed assignment for logging
                                    removedAssignment = transaction.assignments[assignmentIndex];
                                    console.log(`‚úÖ [UNASSIGN] Removing assignment at index ${assignmentIndex}:`, removedAssignment);

                                    // Remove the assignment from the array
                                    transaction.assignments.splice(assignmentIndex, 1);

                                    // Save the updated file back to IndexedDB
                                    await new Promise((resolve, reject) => {
                                        const updateRequest = store.put(file);
                                        updateRequest.onsuccess = () => resolve();
                                        updateRequest.onerror = () => reject(updateRequest.error);
                                    });

                                    updated = true;
                                    console.log(`‚úÖ [UNASSIGN] Assignment removed. Remaining assignments: ${transaction.assignments.length}`);
                                    break;
                                }
                            }
                        }
                    }
                }

                if (!updated) {
                    throw new Error('Assignment not found in database');
                }

                // Refresh cached transactions
                cachedTransactions = await loadAllTransactions();

                // Re-render the grants page to reflect the change
                if (typeof renderBudgetBreakdown === 'function') {
                    renderBudgetBreakdown();
                }

                console.log(`‚úÖ [UNASSIGN] Successfully unassigned transaction: ${transactionDescription}`);

            } catch (error) {
                console.error('‚ùå [UNASSIGN] Failed to unassign transaction:', error);
                alert(`Failed to unassign transaction: ${error.message}`);
            }
        }

        /**
         * Make transaction reference editable on double-click
         */
        function makeTransactionRefEditable(cell, transactionDate, transactionDescription, projectId, category, itemKey, currentRef) {
            // Prevent multiple edit sessions
            if (cell.querySelector('input')) return;

            const originalContent = cell.innerHTML;
            const originalValue = currentRef === '-' ? '' : currentRef;

            // Create input with save/cancel buttons
            cell.innerHTML = `
                <div style="display: flex; align-items: center; gap: 4px; justify-content: center;">
                    <input
                        type="text"
                        value="${escapeHtml(originalValue)}"
                        id="ref-input-${transactionDate}"
                        style="width: 120px; padding: 4px 6px; border: 2px solid #3b82f6; border-radius: 4px; font-family: monospace; font-weight: 600; font-size: 0.9em; text-align: center;"
                        placeholder="Enter ref"
                        maxlength="30"
                    />
                    <button
                        onclick="saveTransactionRef('${escapeHtml(transactionDate)}', '${escapeHtml(transactionDescription)}', '${escapeHtml(projectId)}', '${escapeHtml(category)}', '${escapeHtml(itemKey)}', this); event.stopPropagation();"
                        style="background: #10b981; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; transition: background 0.2s;"
                        onmouseover="this.style.background='#059669'"
                        onmouseout="this.style.background='#10b981'"
                        title="Save changes"
                    >‚úì</button>
                    <button
                        onclick="cancelTransactionRefEdit(this, \`${originalContent.replace(/`/g, '\\`')}\`); event.stopPropagation();"
                        style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; transition: background 0.2s;"
                        onmouseover="this.style.background='#dc2626'"
                        onmouseout="this.style.background='#ef4444'"
                        title="Cancel"
                    >‚úï</button>
                </div>
            `;

            // Focus the input and select all
            const input = cell.querySelector('input');
            input.focus();
            input.select();

            // Save on Enter key, cancel on Escape
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const saveBtn = cell.querySelector('button');
                    saveBtn.click();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    const cancelBtn = cell.querySelectorAll('button')[1];
                    cancelBtn.click();
                }
            });
        }

        /**
         * Save the updated transaction reference for a specific assignment
         */
        async function saveTransactionRef(transactionDate, transactionDescription, projectId, category, itemKey, button) {
            const cell = button.closest('td');
            const input = cell.querySelector('input');
            const newRef = input.value.trim();

            // Validate input
            if (!newRef) {
                alert('‚ùå Transaction reference cannot be empty');
                input.focus();
                return;
            }

            // Show loading state
            button.disabled = true;
            button.innerHTML = '‚è≥';
            input.disabled = true;

            try {
                // Update in database (for this specific assignment)
                await updateTransactionRef(transactionDate, transactionDescription, projectId, category, itemKey, newRef);

                // Update the cell with the new value
                cell.innerHTML = `<span style="color: #059669; font-weight: 600; font-family: monospace;">${escapeHtml(newRef)}</span>`;
                cell.style.padding = '6px 10px';
                cell.style.textAlign = 'center';
                cell.style.whiteSpace = 'nowrap';

                // Re-enable double-click editing
                cell.ondblclick = function() {
                    makeTransactionRefEditable(this, transactionDate, transactionDescription, projectId, category, itemKey, newRef);
                };

                // Show success message
                addLog(`‚úÖ Transaction reference updated to: ${newRef}`);
                console.log(`‚úÖ [TRANSACTION REF] Successfully updated to: ${newRef} for assignment: ${category} - ${itemKey}`);

            } catch (error) {
                // Show error message
                alert(`‚ùå Failed to update transaction reference:\n${error.message}`);
                console.error('‚ùå [TRANSACTION REF] Update failed:', error);

                // Re-enable the button
                button.disabled = false;
                button.innerHTML = '‚úì';
                input.disabled = false;
                input.focus();
            }
        }

        /**
         * Cancel transaction reference editing
         */
        function cancelTransactionRefEdit(button, originalContent) {
            const cell = button.closest('td');
            cell.innerHTML = originalContent;
            cell.style.padding = '6px 10px';
            cell.style.textAlign = 'center';
            cell.style.whiteSpace = 'nowrap';
        }
    </script>

    <!-- Saved Projects Modal -->
    <div id="projectsModal" class="modal-overlay" onclick="closeProjectsModal(event)">
        <div class="modal-dialog" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">Saved Projects</h2>
                <button class="modal-close" onclick="closeProjectsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <ul id="projectsList" class="project-list"></ul>

                <!-- Delete Confirmation Popup -->
                <div id="deleteConfirmPopup" class="delete-confirm-popup">
                    <div class="delete-confirm-title">‚ö†Ô∏è Delete Project?</div>
                    <div class="delete-confirm-text" id="deleteConfirmText">Are you sure you want to delete this project?</div>
                    <div class="delete-confirm-buttons">
                        <button class="delete-confirm-btn cancel" onclick="hideDeleteConfirmation()">Cancel</button>
                        <button class="delete-confirm-btn confirm" onclick="confirmDeleteProject()">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Edit Modal -->
    <div id="projectEditModal" class="modal-overlay" onclick="closeProjectEditModal(event)" style="display: none;">
        <div class="modal-dialog" onclick="event.stopPropagation()" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è Edit Project</h2>
                <button class="modal-close" onclick="closeProjectEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <!-- Project Details Section -->
                    <div style="border-bottom: 2px solid #e2e8f0; padding-bottom: 20px;">
                        <h3 style="font-size: 1.05em; font-weight: 600; color: #334155; margin-bottom: 15px;">üìã Project Details</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div>
                                <label for="editProjectName" style="font-weight: 600; color: #64748b; font-size: 0.9em; display: block; margin-bottom: 8px;">üìù Project Name:</label>
                                <input
                                    type="text"
                                    id="editProjectName"
                                    placeholder="Enter project name..."
                                    style="width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em;"
                                >
                            </div>
                            <div>
                                <label for="editProjectNumber" style="font-weight: 600; color: #64748b; font-size: 0.9em; display: block; margin-bottom: 8px;">üî¢ Project #:</label>
                                <input
                                    type="text"
                                    id="editProjectNumber"
                                    placeholder="Project number..."
                                    style="width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95em;"
                                >
                            </div>
                        </div>
                    </div>

                    <!-- Category Management Section -->
                    <div>
                        <h3 style="font-size: 1.05em; font-weight: 600; color: #334155; margin-bottom: 10px;">üì¶ Budget Categories</h3>
                        <p style="font-size: 0.85em; color: #64748b; margin-bottom: 12px;">Drag to reorder categories as they appear in your budget overview</p>

                        <!-- Category List -->
                        <div id="categoryList" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
                            <!-- Categories will be populated here -->
                        </div>

                        <!-- Add Category Section -->
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input
                                type="text"
                                id="newCategoryName"
                                placeholder="New category name..."
                                style="flex: 1; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9em;"
                                onkeypress="if(event.key === 'Enter') { addNewCategory(); event.preventDefault(); }"
                            >
                            <button onclick="addNewCategory()" style="background: #3AAFA9; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap; display: flex; align-items: center; gap: 6px;">
                                ‚ûï Add
                            </button>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; justify-content: space-between; margin-top: 10px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <button class="btn-delete" onclick="deleteProjectFromEdit()">
                            üóëÔ∏è Delete Project
                        </button>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-secondary" onclick="closeProjectEditModal()" style="padding: 10px 20px;">
                                Cancel
                            </button>
                            <button class="btn-primary" onclick="saveProjectEdit()" style="padding: 10px 20px;">
                                üíæ Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
