<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quote Generator - PEBLGen</title>
    <!-- Google Fonts - PEBL Brand Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400&display=swap" rel="stylesheet">
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Navigation Banner - PEBL Brand Colors */
        .nav-banner { position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); padding: 15px 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 30px; margin-bottom: 0; z-index: 100; }
        .nav-banner h1 { color: white; font-size: 28px; font-weight: 700; margin: 0; font-family: 'Roboto', sans-serif; letter-spacing: 0.5px; }
        .nav-buttons { display: flex; gap: 8px; }
        .nav-btn { background-color: rgba(255, 255, 255, 0.15); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; text-decoration: none; transition: all 0.2s ease; display: inline-block; font-family: 'Roboto', sans-serif; }
        .nav-btn:hover { background-color: rgba(255, 255, 255, 0.25); border-color: rgba(255, 255, 255, 0.5); }
        .nav-btn.active { background-color: rgba(255, 255, 255, 0.9); color: #2B7A78; border-color: rgba(255, 255, 255, 0.9); }

        /* Split Screen Mode */
        .split-screen-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #1e293b; z-index: 9999; }
        .split-screen-overlay.active { display: flex; flex-direction: column; }
        .split-screen-header { background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); padding: 10px 20px; display: flex; align-items: center; gap: 20px; flex-shrink: 0; }
        .split-screen-header h2 { color: white; margin: 0; font-size: 18px; font-weight: 600; }
        .split-screen-controls { display: flex; align-items: center; gap: 15px; flex: 1; }
        .split-pane-selector { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 6px; }
        .split-pane-selector label { color: rgba(255,255,255,0.8); font-size: 12px; font-weight: 500; }
        .split-pane-selector select { padding: 6px 10px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.9); font-size: 13px; cursor: pointer; min-width: 120px; }
        .split-screen-close { margin-left: auto; background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; }
        .split-screen-close:hover { background: #dc2626; }
        .split-screen-container { display: flex; flex: 1; gap: 4px; padding: 4px; background: #1e293b; overflow: hidden; }
        .split-pane { flex: 1; display: flex; flex-direction: column; background: white; border-radius: 6px; overflow: hidden; }
        .split-pane-header { background: #f1f5f9; padding: 8px 12px; font-size: 12px; font-weight: 600; color: #475569; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; }
        .split-pane-content { flex: 1; position: relative; }
        .split-pane-content iframe { width: 100%; height: 100%; border: none; position: absolute; top: 0; left: 0; }
        .split-divider { width: 6px; background: #475569; cursor: col-resize; border-radius: 3px; flex-shrink: 0; }
        .split-divider:hover { background: #3AAFA9; }
        .split-orientation-btn { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .split-orientation-btn:hover { background: rgba(255,255,255,0.25); }
        .split-screen-container.vertical { flex-direction: column; }
        .split-screen-container.vertical .split-divider { width: auto; height: 6px; cursor: row-resize; }
        .split-btn-icon { font-size: 16px; }

        body {
            font-family: 'Roboto', sans-serif;
            font-weight: 300;
            background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%);
            min-height: 100vh;
            padding: 0;
            padding-top: 90px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px 25px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grid-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .grid-2col {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95em;
            font-family: 'Roboto', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3AAFA9;
            box-shadow: 0 0 0 3px rgba(58, 175, 169, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Roboto', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(43, 122, 120, 0.3);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Price List Table */
        .price-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .price-table th,
        .price-table td {
            padding: 6px 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .price-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
            font-size: 0.85em;
            text-transform: uppercase;
            padding: 8px 12px;
        }

        .price-table tbody tr {
            height: 42px;
        }

        .price-table tbody tr:hover {
            background: #f8fafc;
        }

        /* Filter buttons */
        .filter-btn {
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            opacity: 0.8;
        }

        .filter-btn.active {
            background: #2B7A78 !important;
            color: white !important;
            border-color: #2B7A78 !important;
        }

        .price-table input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .price-table .price-input {
            width: 100px;
            text-align: right;
        }

        /* Quote Preview */
        .quote-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        .quote-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .quote-logo {
            width: 120px;
        }

        .quote-title-banner {
            background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .quote-title-banner h2 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 600;
        }

        .company-address {
            text-align: right;
            color: #555;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .client-section {
            margin-bottom: 30px;
        }

        .client-section p {
            margin: 5px 0;
            color: #333;
        }

        .quote-body {
            margin-bottom: 30px;
            color: #333;
            line-height: 1.6;
        }

        .quote-items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .quote-items-table th {
            background: #e0f2f1;
            color: #2B7A78;
            padding: 8px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }

        .quote-items-table td {
            padding: 6px 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }

        .quote-items-table .amount-col {
            text-align: right;
            font-weight: 500;
        }

        .quote-total-row td {
            background: #e0f2f1;
            font-weight: 700;
            font-size: 1.1em;
        }

        .signature-section {
            margin-top: 40px;
        }

        .signature-section p {
            margin: 5px 0;
        }

        .signature-img {
            font-family: 'Brush Script MT', cursive;
            font-size: 2em;
            color: #333;
            margin: 10px 0;
        }

        .quote-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            font-size: 0.8em;
            color: #666;
        }

        /* Saved Quotes List */
        .quotes-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .quote-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quote-item:hover {
            background: #f8fafc;
            border-color: #3AAFA9;
        }

        .quote-item-info {
            flex: 1;
        }

        .quote-item-ref {
            font-weight: 600;
            color: #2B7A78;
        }

        .quote-item-client {
            font-size: 0.9em;
            color: #666;
        }

        .quote-item-date {
            font-size: 0.85em;
            color: #999;
        }

        .quote-item-amount {
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.info { background: #3b82f6; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            font-size: 0.95em;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #3AAFA9;
        }

        .tab.active {
            color: #2B7A78;
            border-bottom-color: #2B7A78;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* VAT Note */
        .vat-note {
            font-size: 0.85em;
            color: #666;
            font-style: italic;
            margin-top: 10px;
        }

        /* AI Status */
        .ai-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 6px;
            font-size: 0.85em;
            color: #166534;
            margin-bottom: 15px;
        }

        .ai-status.error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #991b1b;
        }

        .ai-status.processing {
            background: #eff6ff;
            border-color: #bfdbfe;
            color: #1e40af;
        }

        /* Line items editor */
        .line-items-container {
            margin-top: 15px;
        }

        .line-item-row {
            display: grid;
            grid-template-columns: 1fr 120px 40px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .line-item-row input {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .line-item-row .remove-btn {
            background: #fee2e2;
            border: none;
            color: #ef4444;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        .line-item-row .remove-btn:hover {
            background: #fecaca;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        /* Currency Selector */
        .currency-selector {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .currency-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .currency-btn:hover {
            border-color: #3AAFA9;
            background: #f0fdfa;
        }

        .currency-btn.active {
            background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%);
            color: white;
            border-color: #2B7A78;
        }

        .currency-btn .flag {
            font-size: 1.1em;
        }

        .exchange-rate-info {
            font-size: 0.8em;
            color: #666;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .exchange-rate-info.loading {
            color: #3b82f6;
        }

        .exchange-rate-info.error {
            color: #ef4444;
        }
    </style>

    <!-- Automatic Cloud Backup System -->
    <script src="supabase-client.js"></script>
    <script src="universal-backup.js"></script>
</head>
<body>
    <!-- Navigation Banner -->
    <div class="nav-banner">
        <h1>PEBLGen</h1>
        <div class="nav-buttons">
            <a href="grants.html" class="nav-btn">Grants</a>
            <a href="spend.html" class="nav-btn">Spend</a>
            <a href="gantt.html" class="nav-btn">Gantt</a>
            <a href="timesheet.html" class="nav-btn">Labour</a>
            <a href="index.html" class="nav-btn">Sketcher</a>
            <a href="exploit.html" class="nav-btn">Exploit</a>
            <a href="risks.html" class="nav-btn">Risks</a>
            <a href="quote.html" class="nav-btn active">Quote</a>
            <button onclick="openSplitScreenMode()" class="nav-btn" style="background-color: rgba(255, 255, 255, 0.15);" title="Split Screen Mode"><span class="split-btn-icon">‚´ø</span> Split</button>
            <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="nav-btn" style="margin-left: auto;">&#8593; Top</button>
        </div>
    </div>

    <div class="container">
        <!-- Mode Toggle -->
        <div style="background: #f8fafc; padding: 15px 30px; border-bottom: 2px solid #e2e8f0; display: flex; gap: 15px; align-items: center;">
            <span style="font-weight: 600; color: #64748b; font-size: 14px;">MODE:</span>
            <button id="quoteModeBtn" class="tab active" onclick="switchMode('quote')" style="padding: 10px 20px; border-radius: 6px;">üìã Quote System</button>
            <button id="invoiceModeBtn" class="tab" onclick="switchMode('invoice')" style="padding: 10px 20px; border-radius: 6px;">üìÑ Invoice System</button>
        </div>

        <!-- Tabs (dynamic based on mode) -->
        <div class="tabs" id="mainTabs">
            <button class="tab active" onclick="showTab('create')">Create Quote</button>
            <button class="tab" onclick="showTab('saved')">Saved Quotes</button>
            <button class="tab" onclick="showTab('pricelist')">Price List</button>
        </div>

        <!-- Create Quote Tab -->
        <div id="tab-create" class="tab-content active">
            <div class="grid-2col">
                <!-- Left Column: Input Form -->
                <div>
                    <!-- Load Saved Quote -->
                    <div class="card" style="background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%); border: 1px solid #99f6e4;">
                        <div class="card-title" style="margin-bottom: 10px;">Load Saved Quote</div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="savedQuoteSelector" style="flex: 1; padding: 10px; border: 1px solid #99f6e4; border-radius: 6px; font-size: 0.95em;">
                                <option value="">-- Select a saved quote --</option>
                            </select>
                            <button class="btn btn-primary btn-sm" onclick="loadSelectedQuote()">Load</button>
                        </div>
                        <p style="font-size: 0.8em; color: #0f766e; margin-top: 8px;" id="savedQuotesInfo">No saved quotes</p>
                    </div>

                    <!-- Client Details -->
                    <div class="card">
                        <div class="card-title">Client Details</div>
                        <div class="form-group">
                            <label>Select Existing Client</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="clientSelector" style="flex: 1;" onchange="loadSelectedClient()">
                                    <option value="">-- New Client --</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Client Name</label>
                            <input type="text" id="clientName" placeholder="e.g., John Smith">
                        </div>
                        <div class="form-group">
                            <label>Organisation</label>
                            <input type="text" id="clientOrg" placeholder="e.g., Blue Ocean Marine Ltd">
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="lookupClientAddress()">
                                <span id="addressLookupText">Look Up Address</span>
                            </button>
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label>Client Address</label>
                            <textarea id="clientAddress" rows="3" placeholder="Address will be auto-filled or enter manually..."></textarea>
                        </div>
                        <div class="btn-group" style="margin-top: 10px;">
                            <button class="btn btn-primary btn-sm" onclick="saveClientManually()" style="background: #10b981;">
                                üíæ Save Client
                            </button>
                        </div>
                    </div>

                    <!-- Service Description -->
                    <div class="card">
                        <div class="card-title">Service Description</div>
                        <div id="aiStatus" class="ai-status" style="display: none;"></div>
                        <div class="form-group">
                            <label>Describe the services (AI will parse this)</label>
                            <textarea id="serviceDescription" rows="4" placeholder="e.g., Kelp micro-hatchery design consultancy, bill of materials, installation support and staff training. Also need materials for the hatchery setup."></textarea>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="parseServicesWithAI()">
                                <span id="parseText">Parse with AI</span>
                            </button>
                        </div>
                    </div>

                    <!-- Quote Items -->
                    <div class="card">
                        <div class="card-title">Quote Items</div>
                        <!-- Quick add from price list -->
                        <div style="display: flex; gap: 10px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0;">
                            <select id="priceListSelector" style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">-- Quick add from price list --</option>
                            </select>
                            <button class="btn btn-primary btn-sm" onclick="addFromPriceList()">Add</button>
                        </div>
                        <div class="line-items-container" id="lineItemsContainer">
                            <!-- Line items will be added here -->
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="addLineItem()" style="margin-top: 10px;">
                            + Add Custom Item
                        </button>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">Subtotal:</span>
                                <span id="subtotalDisplay">0.00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                                <span style="font-weight: 600;">VAT (20%):</span>
                                <span id="vatDisplay">0.00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 1.2em; font-weight: 700; color: #2B7A78;">
                                <span>Total:</span>
                                <span id="totalDisplay">0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Notes -->
                    <div class="card">
                        <div class="card-title">Additional Notes</div>
                        <div class="form-group">
                            <textarea id="additionalNotes" rows="3" placeholder="Any additional notes to include in the quote..."></textarea>
                        </div>
                    </div>

                    <!-- Quote Details -->
                    <div class="card">
                        <div class="card-title">Quote Details</div>
                        <div class="grid-2col">
                            <div class="form-group">
                                <label>Quote Title</label>
                                <input type="text" id="quoteTitle" placeholder="e.g., Hatchery Support">
                            </div>
                            <div class="form-group">
                                <label>Quote Reference</label>
                                <input type="text" id="quoteRef" readonly>
                            </div>
                        </div>
                        <div class="grid-2col">
                            <div class="form-group">
                                <label>Quote Date</label>
                                <input type="date" id="quoteDate">
                            </div>
                            <div class="form-group">
                                <label>Valid Until</label>
                                <input type="date" id="validUntil">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Include VAT</label>
                            <select id="includeVat">
                                <option value="yes">Yes - Add 20% VAT</option>
                                <option value="no">No - Prices exclude VAT</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Currency</label>
                            <div class="currency-selector">
                                <button type="button" class="currency-btn active" onclick="setCurrency('GBP')" data-currency="GBP">
                                    <span class="flag">üá¨üáß</span> GBP
                                </button>
                                <button type="button" class="currency-btn" onclick="setCurrency('EUR')" data-currency="EUR">
                                    <span class="flag">üá™üá∫</span> EUR
                                </button>
                                <button type="button" class="currency-btn" onclick="setCurrency('USD')" data-currency="USD">
                                    <span class="flag">üá∫üá∏</span> USD
                                </button>
                            </div>
                            <div id="exchangeRateInfo" class="exchange-rate-info" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="generatePreview()">Preview Quote</button>
                        <button class="btn btn-primary" onclick="saveQuote()" id="saveQuoteBtn">Save Quote</button>
                        <button class="btn btn-primary" onclick="saveAsNewQuote()" id="saveAsNewBtn" style="display: none;">Save as New</button>
                        <button class="btn btn-primary" onclick="downloadPDF()">Download PDF</button>
                        <button class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
                    </div>

                    <!-- Editing indicator -->
                    <div id="editingIndicator" style="display: none; margin-top: 15px; padding: 12px 15px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; color: #92400e;">
                        <strong>Editing:</strong> <span id="editingQuoteRef"></span>
                        <button onclick="cancelEditing()" style="float: right; background: none; border: none; color: #92400e; cursor: pointer; font-weight: bold;">‚úï Cancel</button>
                    </div>
                </div>

                <!-- Right Column: Quote Preview -->
                <div>
                    <div class="card" style="padding: 0; overflow: hidden;">
                        <div style="padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                            <strong>Quote Preview</strong>
                        </div>
                        <div id="quotePreviewContainer" style="padding: 20px; background: #f1f5f9; min-height: 600px;">
                            <div class="quote-preview" id="quotePreview">
                                <!-- Quote preview will be rendered here -->
                                <div style="text-align: center; color: #999; padding: 100px 20px;">
                                    <p>Fill in the form and click "Preview Quote" to see the preview</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Saved Quotes Tab -->
        <div id="tab-saved" class="tab-content">
            <div class="card">
                <div class="card-title">
                    Saved Quotes
                    <span id="quotesCount" style="background: #e0f2f1; color: #2B7A78; padding: 4px 12px; border-radius: 12px; font-size: 0.75em; font-weight: 600; margin-left: 10px;">0</span>
                </div>
                <div class="btn-group" style="margin-bottom: 15px;">
                    <button class="btn btn-secondary btn-sm" onclick="loadSavedQuotes()">Refresh</button>
                    <button class="btn btn-danger btn-sm" onclick="clearAllQuotes()">Clear All</button>
                </div>
                <div class="quotes-list" id="quotesListContainer">
                    <p style="color: #999; text-align: center; padding: 40px;">No saved quotes yet</p>
                </div>
            </div>
        </div>

        <!-- Price List Tab -->
        <div id="tab-pricelist" class="tab-content">
            <div class="card">
                <div class="card-title">
                    Price List
                    <span id="priceItemsCount" style="background: #e0f2f1; color: #2B7A78; padding: 4px 12px; border-radius: 12px; font-size: 0.75em; font-weight: 600; margin-left: 10px;">0</span>
                </div>
                <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                    Manage your standard pricing. The AI will reference these prices when parsing service descriptions.
                </p>
                <div class="btn-group" style="margin-bottom: 15px;">
                    <button class="btn btn-primary btn-sm" onclick="addPriceItem()">+ Add Item</button>
                    <button class="btn btn-primary btn-sm" onclick="bulkImportBudgetItems()" style="background: #10b981;">üìã Import Budget Items</button>
                    <button class="btn btn-secondary btn-sm" onclick="savePriceList()">Save Price List</button>
                    <button class="btn btn-secondary btn-sm" onclick="loadPriceList()">Refresh</button>
                </div>
                <div style="margin-bottom: 15px; display: flex; gap: 8px; align-items: center;">
                    <span style="color: #666; font-weight: 600; font-size: 0.9em;">Filter:</span>
                    <button class="filter-btn active" data-filter="all" onclick="filterPriceList('all')" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 6px; background: #2B7A78; color: white; cursor: pointer; font-size: 0.85em; font-weight: 600;">All</button>
                    <button class="filter-btn" data-filter="R" onclick="filterPriceList('R')" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; color: #3b82f6; cursor: pointer; font-size: 0.85em; font-weight: 600; border-color: #3b82f6;">üîß Rental</button>
                    <button class="filter-btn" data-filter="P" onclick="filterPriceList('P')" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; color: #8b5cf6; cursor: pointer; font-size: 0.85em; font-weight: 600; border-color: #8b5cf6;">üõí Purchase</button>
                    <button class="filter-btn" data-filter="S" onclick="filterPriceList('S')" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; color: #10b981; cursor: pointer; font-size: 0.85em; font-weight: 600; border-color: #10b981;">‚öôÔ∏è Service</button>
                </div>
                <table class="price-table" id="priceListTable">
                    <thead>
                        <tr>
                            <th>Service/Item Name</th>
                            <th>Description</th>
                            <th>Unit Price (GBP)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="priceListBody">
                        <!-- Price items will be added here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- INVOICE TABS (Hidden by default) -->
        <!-- Create Invoice Tab -->
        <div id="tab-invoice-create" class="tab-content" style="display: none;">
            <!-- Import Sample Invoice Card (Discrete) -->
            <div class="card" style="margin-bottom: 20px;">
                <div style="font-weight: 700; font-size: 18px; color: #1e293b; margin-bottom: 10px;">Load Sample Invoice</div>
                <p style="margin: 0 0 15px 0; color: #64748b; font-size: 14px;">
                    Import a complete Algapelago invoice (17 items, ¬£15,548.94) as a starting template
                </p>
                <button class="btn" onclick="importAlgapelagoInvoice()" style="background: #3AAFA9; color: white; font-weight: 600; padding: 10px 20px;">
                    üìÑ Import Sample
                </button>
            </div>

            <!-- Top Section: Invoice Details and Client Details Side by Side -->
            <div class="grid-2col" style="gap: 20px; margin-bottom: 20px;">
                <!-- Invoice Details Card -->
                <div class="card">
                    <div class="card-title">Invoice Details</div>
                    <div class="form-group">
                        <label>Invoice Number *</label>
                        <input type="text" id="invoiceNumber" placeholder="INV-2025-001">
                        <small style="color: #64748b; display: block; margin-top: 5px;">Enter invoice number or leave blank for auto-generation</small>
                    </div>
                    <div class="grid-2col">
                        <div class="form-group">
                            <label>Invoice Date *</label>
                            <input type="date" id="invoiceDate">
                        </div>
                        <div class="form-group">
                            <label>Due Date *</label>
                            <input type="date" id="invoiceDueDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Project Name</label>
                        <input type="text" id="invoiceProjectName" placeholder="e.g., Marine Monitoring 2025">
                    </div>
                    <div class="form-group">
                        <label>Reference Quote (optional)</label>
                        <input type="text" id="linkedQuoteRef" placeholder="Q-2025-015">
                        <small style="color: #64748b; display: block; margin-top: 5px;">Enter quote reference if applicable</small>
                    </div>
                </div>

                <!-- Client Details Card -->
                <div class="card">
                    <div class="card-title">Client Details</div>
                    <div class="form-group">
                        <label>Client Name *</label>
                        <input type="text" id="invoiceClientName" placeholder="e.g., Algapelago">
                    </div>
                    <div class="form-group">
                        <label>Organisation</label>
                        <input type="text" id="invoiceClientOrg" placeholder="e.g., Nestle">
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <textarea id="invoiceClientAddress" rows="3" placeholder="Client's billing address..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Line Items Card - Full Width -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-title">Line Items</div>
                <div id="invoiceLineItemsContainer">
                    <!-- Line items will be rendered here -->
                </div>
                <button class="btn btn-secondary" onclick="addInvoiceLineItem()">+ Add Line Item</button>
            </div>

            <!-- Additional Notes Card - Full Width -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-title">Additional Notes</div>
                <div class="form-group">
                    <textarea id="invoiceAdditionalNotes" rows="4" placeholder="Payment terms, additional information, etc."></textarea>
                </div>
            </div>

            <!-- Summary Panel - Full Width at Bottom -->
            <div class="card" style="background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%); border: 2px solid #10b981;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #1e293b; font-size: 20px;">Invoice Summary</h3>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; color: #64748b; margin-bottom: 4px;">Total Amount</div>
                        <div id="invoiceTotal" style="font-weight: 700; font-size: 28px; color: #059669;">¬£0.00</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; padding: 20px; background: white; border-radius: 8px;">
                    <div style="text-align: center; padding: 15px; border-right: 1px solid #e2e8f0;">
                        <div style="font-size: 13px; color: #64748b; margin-bottom: 8px; font-weight: 600;">Subtotal (ex VAT)</div>
                        <div id="invoiceSubtotal" style="font-size: 22px; font-weight: 700; color: #333;">¬£0.00</div>
                    </div>
                    <div style="text-align: center; padding: 15px; border-right: 1px solid #e2e8f0;">
                        <div style="font-size: 13px; color: #64748b; margin-bottom: 8px; font-weight: 600;">VAT (<span id="invoiceVatRate">20</span>%)</div>
                        <div id="invoiceVat" style="font-size: 22px; font-weight: 700; color: #333;">¬£0.00</div>
                    </div>
                    <div style="text-align: center; padding: 15px;">
                        <div style="font-size: 13px; color: #059669; margin-bottom: 8px; font-weight: 700;">TOTAL (inc VAT)</div>
                        <div style="font-size: 24px; font-weight: 700; color: #059669;" id="invoiceTotalDuplicate">¬£0.00</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                    <button class="btn btn-primary" onclick="saveInvoice()" style="width: 100%; font-size: 15px; padding: 14px; background: #059669;">
                        üíæ Save Invoice
                    </button>
                    <button class="btn btn-secondary" onclick="previewInvoicePDF()" style="width: 100%; font-size: 15px; padding: 14px; background: #3b82f6; color: white;">
                        üëÅÔ∏è Preview PDF
                    </button>
                    <button class="btn btn-secondary" onclick="clearInvoiceForm()" style="width: 100%; padding: 14px;">
                        üóëÔ∏è Clear Form
                    </button>
                </div>
            </div>
        </div>

        <!-- Saved Invoices Tab -->
        <div id="tab-invoice-saved" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-title">
                    Saved Invoices
                    <span class="badge" id="invoiceCount" style="background: #e0f2f1; color: #2B7A78; padding: 4px 12px; border-radius: 12px; font-size: 0.75em; font-weight: 600; margin-left: 10px;">0</span>
                </div>
                <div id="savedInvoicesList" style="padding: 20px;">
                    <p style="color: #999; text-align: center; padding: 40px;">No invoices yet. Create your first invoice in the Create Invoice tab.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Price Item Modal -->
    <div class="modal-overlay" id="priceItemModal">
        <div class="modal">
            <div class="modal-title">Add/Edit Price Item</div>
            <div class="form-group">
                <label>Service/Item Name</label>
                <input type="text" id="modalItemName" placeholder="e.g., Hatchery Design Consultancy">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="modalItemCategory" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                    <option value="S">‚öôÔ∏è Service (data analysis, reports, consulting)</option>
                    <option value="R">üîß Rental (equipment, temporary use)</option>
                    <option value="P">üõí Purchase (buy equipment, one-time purchase)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="modalItemDesc" rows="2" placeholder="Brief description..."></textarea>
            </div>
            <div class="form-group">
                <label>Unit Price (GBP)</label>
                <input type="number" id="modalItemPrice" step="0.01" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>Keywords (comma-separated, for AI matching)</label>
                <input type="text" id="modalItemKeywords" placeholder="e.g., hatchery, design, consultancy">
            </div>
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="savePriceItem()">Save</button>
                <button class="btn btn-secondary" onclick="closePriceModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div class="modal-overlay" id="pdfPreviewModal" style="display: none;">
        <div class="modal" style="max-width: 950px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-title" style="display: flex; justify-content: space-between; align-items: center;">
                <span>Invoice PDF Preview</span>
                <button onclick="closePDFPreviewModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #64748b; padding: 0; line-height: 1;">&times;</button>
            </div>
            <div id="pdfPreviewContent" style="border: 1px solid #cbd5e1; border-radius: 6px; padding: 20px; background: #ffffff; max-height: 65vh; overflow-y: auto;">
                <p style="color: #94a3b8; text-align: center; padding: 40px;">Click "Preview PDF" to see how your invoice will look</p>
            </div>
            <div class="btn-group" style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="exportInvoicePDF()" style="flex: 1; font-size: 15px; padding: 12px;">üìÑ Download PDF</button>
                <button class="btn btn-secondary" onclick="closePDFPreviewModal()" style="flex: 1; font-size: 15px; padding: 12px;">Close</button>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // DATABASE CONFIGURATION
        // =====================================================
        const DB_NAME = 'PEBLQuotesDB';
        const DB_VERSION = 3; // Bumped for invoices store
        const QUOTES_STORE = 'quotes';
        const PRICELIST_STORE = 'pricelist';
        const CLIENTS_STORE = 'clients';
        const INVOICES_STORE = 'invoices';
        let db = null;

        // Company Details
        const COMPANY = {
            name: 'Plant Ecology Beyond Land CIC',
            address: '29 Glan Yr Afon Road',
            city: 'Swansea',
            postcode: 'SA29JA',
            website: 'www.pebl-cic.co.uk',
            email: 'christian@pebl-cic.co.uk',
            companyNumber: '12076622',
            vatNumber: '351949083',
            directorName: 'Christian Berger',
            directorTitle: 'Director'
        };

        // Current quote data
        let currentLineItems = [];
        let priceList = [];
        let savedQuotes = [];
        let savedClients = [];
        let savedInvoices = [];
        let editingPriceItemId = null;
        let editingQuoteId = null; // Track which quote is being edited
        let editingInvoiceId = null; // Track which invoice is being edited
        let priceListFilter = 'all'; // Filter for price list: 'all', 'R', 'P', 'S'

        // Currency configuration
        let currentCurrency = 'GBP';
        let exchangeRates = { GBP: 1, EUR: 1, USD: 1 };
        let baseAmountsGBP = []; // Store original GBP amounts for accurate conversion

        const CURRENCY_SYMBOLS = {
            GBP: '¬£',
            EUR: '‚Ç¨',
            USD: '$'
        };

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', function() {
            initializeDB();
            fetchExchangeRates(); // Fetch rates on load
            generateQuoteRef();
            setDefaultDates();
            addLineItem(); // Start with one empty line item
        });

        function initializeDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = (event) => {
                console.error('Database error:', event.target.error);
                showToast('Database error', 'error');
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                console.log('Database opened successfully');
                loadPriceList();
                loadSavedQuotes();
                loadSavedClients();
                loadSavedInvoices();
            };

            request.onupgradeneeded = (event) => {
                db = event.target.result;

                // Create quotes store
                if (!db.objectStoreNames.contains(QUOTES_STORE)) {
                    const quotesStore = db.createObjectStore(QUOTES_STORE, { keyPath: 'id', autoIncrement: true });
                    quotesStore.createIndex('reference', 'reference', { unique: true });
                    quotesStore.createIndex('date', 'date', { unique: false });
                    quotesStore.createIndex('clientName', 'clientName', { unique: false });
                }

                // Create price list store
                if (!db.objectStoreNames.contains(PRICELIST_STORE)) {
                    const priceStore = db.createObjectStore(PRICELIST_STORE, { keyPath: 'id', autoIncrement: true });
                    priceStore.createIndex('name', 'name', { unique: false });
                }

                // Create clients store
                if (!db.objectStoreNames.contains(CLIENTS_STORE)) {
                    const clientsStore = db.createObjectStore(CLIENTS_STORE, { keyPath: 'id', autoIncrement: true });
                    clientsStore.createIndex('name', 'name', { unique: false });
                    clientsStore.createIndex('organisation', 'organisation', { unique: false });
                }

                // Create invoices store
                if (!db.objectStoreNames.contains(INVOICES_STORE)) {
                    const invoicesStore = db.createObjectStore(INVOICES_STORE, { keyPath: 'id', autoIncrement: true });
                    invoicesStore.createIndex('invoiceNumber', 'invoiceNumber', { unique: true });
                    invoicesStore.createIndex('date', 'date', { unique: false });
                    invoicesStore.createIndex('clientName', 'clientName', { unique: false });
                }

                console.log('Database schema created');
            };
        }

        // =====================================================
        // TAB NAVIGATION
        // =====================================================
        function showTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            // Hide all tab content (handle both quote and invoice tabs)
            document.querySelectorAll('.tab-content').forEach(c => {
                c.classList.remove('active');
                c.style.display = 'none';
            });

            // Activate the clicked tab button
            const tabButton = document.querySelector(`[onclick="showTab('${tabName}')"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }

            // Show the selected tab content
            const tabContent = document.getElementById(`tab-${tabName}`);
            if (tabContent) {
                tabContent.classList.add('active');
                tabContent.style.display = 'block';
            }
        }

        // =====================================================
        // QUOTE REFERENCE & DATES
        // =====================================================
        function generateQuoteRef() {
            const now = new Date();
            const dateStr = now.toISOString().slice(2, 10).replace(/-/g, '');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            document.getElementById('quoteRef').value = `Q${dateStr}-${random}`;
        }

        function setDefaultDates() {
            const today = new Date();
            document.getElementById('quoteDate').value = today.toISOString().split('T')[0];

            const validUntil = new Date(today);
            validUntil.setDate(validUntil.getDate() + 30);
            document.getElementById('validUntil').value = validUntil.toISOString().split('T')[0];
        }

        // =====================================================
        // LINE ITEMS MANAGEMENT
        // =====================================================
        function addLineItem(description = '', amount = '') {
            const container = document.getElementById('lineItemsContainer');
            const itemId = Date.now();

            const row = document.createElement('div');
            row.className = 'line-item-row';
            row.dataset.itemId = itemId;
            row.innerHTML = `
                <input type="text" placeholder="Item description" value="${description}" onchange="updateTotals()">
                <input type="number" class="price-input" placeholder="0.00" step="0.01" value="${amount}" onchange="updateTotals()">
                <button class="remove-btn" onclick="removeLineItem(${itemId})">X</button>
            `;
            container.appendChild(row);
            updateTotals();
        }

        function removeLineItem(itemId) {
            const row = document.querySelector(`[data-item-id="${itemId}"]`);
            if (row) {
                row.remove();
                updateTotals();
            }
        }

        function getLineItems() {
            const items = [];
            document.querySelectorAll('.line-item-row').forEach(row => {
                const inputs = row.querySelectorAll('input');
                const description = inputs[0].value.trim();
                const amount = parseFloat(inputs[1].value) || 0;
                if (description || amount > 0) {
                    items.push({ description, amount });
                }
            });
            return items;
        }

        function updateTotals() {
            const items = getLineItems();
            const subtotal = items.reduce((sum, item) => sum + item.amount, 0);
            const includeVat = document.getElementById('includeVat').value === 'yes';
            const vat = includeVat ? subtotal * 0.2 : 0;
            const total = subtotal + vat;

            const symbol = CURRENCY_SYMBOLS[currentCurrency];
            document.getElementById('subtotalDisplay').textContent = `${symbol}${subtotal.toFixed(2)}`;
            document.getElementById('vatDisplay').textContent = `${symbol}${vat.toFixed(2)}`;
            document.getElementById('totalDisplay').textContent = `${symbol}${total.toFixed(2)}`;
        }

        // Add event listener for VAT select
        document.getElementById('includeVat').addEventListener('change', updateTotals);

        // =====================================================
        // CURRENCY CONVERSION
        // =====================================================
        async function fetchExchangeRates() {
            const infoDiv = document.getElementById('exchangeRateInfo');
            infoDiv.style.display = 'flex';
            infoDiv.className = 'exchange-rate-info loading';
            infoDiv.innerHTML = '<span class="spinner"></span> Fetching exchange rates...';

            try {
                // Using Frankfurter API (free, open source, no API key required)
                const response = await fetch('https://api.frankfurter.app/latest?from=GBP&to=EUR,USD');

                if (!response.ok) {
                    throw new Error('Failed to fetch rates');
                }

                const data = await response.json();
                exchangeRates = {
                    GBP: 1,
                    EUR: data.rates.EUR,
                    USD: data.rates.USD
                };

                infoDiv.className = 'exchange-rate-info';
                infoDiv.innerHTML = `Rates: 1 GBP = ${data.rates.EUR.toFixed(4)} EUR | ${data.rates.USD.toFixed(4)} USD`;

                console.log('Exchange rates loaded:', exchangeRates);
            } catch (error) {
                console.error('Failed to fetch exchange rates:', error);
                infoDiv.className = 'exchange-rate-info error';
                infoDiv.innerHTML = 'Could not fetch rates. Using estimates: 1 GBP ‚âà 1.17 EUR | 1.27 USD';

                // Fallback rates
                exchangeRates = {
                    GBP: 1,
                    EUR: 1.17,
                    USD: 1.27
                };
            }
        }

        function setCurrency(currency) {
            if (currency === currentCurrency) return;

            // Store current amounts in GBP before switching
            if (currentCurrency === 'GBP') {
                // Save current amounts as base GBP values
                baseAmountsGBP = [];
                document.querySelectorAll('.line-item-row').forEach(row => {
                    const amountInput = row.querySelectorAll('input')[1];
                    baseAmountsGBP.push(parseFloat(amountInput.value) || 0);
                });
            } else {
                // Convert current amounts back to GBP first
                const currentRate = exchangeRates[currentCurrency];
                document.querySelectorAll('.line-item-row').forEach((row, index) => {
                    const amountInput = row.querySelectorAll('input')[1];
                    const currentAmount = parseFloat(amountInput.value) || 0;
                    baseAmountsGBP[index] = currentAmount / currentRate;
                });
            }

            // Update button states
            document.querySelectorAll('.currency-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.currency === currency) {
                    btn.classList.add('active');
                }
            });

            currentCurrency = currency;

            // Convert amounts to new currency
            const newRate = exchangeRates[currency];
            document.querySelectorAll('.line-item-row').forEach((row, index) => {
                const amountInput = row.querySelectorAll('input')[1];
                if (baseAmountsGBP[index] !== undefined) {
                    const newAmount = baseAmountsGBP[index] * newRate;
                    amountInput.value = newAmount.toFixed(2);
                }
            });

            updateTotals();
            showToast(`Currency changed to ${currency}`, 'success');
        }

        function formatCurrency(amount, currency = currentCurrency) {
            const symbol = CURRENCY_SYMBOLS[currency];
            return `${symbol}${amount.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        function convertToGBP(amount) {
            return amount / exchangeRates[currentCurrency];
        }

        function convertFromGBP(amount, targetCurrency = currentCurrency) {
            return amount * exchangeRates[targetCurrency];
        }

        // =====================================================
        // AI INTEGRATION
        // =====================================================
        function getAPIKey() {
            const key = localStorage.getItem('openai_api_key');
            if (!key) {
                const newKey = prompt('Please enter your OpenAI API Key:\n\n(Get one from: https://platform.openai.com/api-keys)\n\nYour key will be stored locally in your browser.');
                if (newKey && newKey.trim()) {
                    localStorage.setItem('openai_api_key', newKey.trim());
                    return newKey.trim();
                }
                return null;
            }
            return key;
        }

        async function parseServicesWithAI() {
            const description = document.getElementById('serviceDescription').value.trim();
            if (!description) {
                showToast('Please enter a service description', 'error');
                return;
            }

            const apiKey = getAPIKey();
            if (!apiKey) {
                showToast('API key required', 'error');
                return;
            }

            // Get current price list for context
            const priceListContext = priceList.map(item =>
                `- "${item.name}": ¬£${item.price} (Keywords: ${item.keywords || 'none'})`
            ).join('\n');

            const statusDiv = document.getElementById('aiStatus');
            statusDiv.style.display = 'flex';
            statusDiv.className = 'ai-status processing';
            statusDiv.innerHTML = '<span class="spinner"></span> Parsing service description...';

            document.getElementById('parseText').innerHTML = '<span class="spinner"></span> Parsing...';

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [{
                            role: 'system',
                            content: `You are a quote parsing assistant. Extract individual billable items from a service description.

Available price list:
${priceListContext || 'No predefined prices - estimate reasonable market rates for UK marine/ecology consultancy services'}

Return a JSON array of items with this format:
[{"description": "Service name", "amount": 1234.00}]

Rules:
1. Match items to the price list when possible
2. For items not in price list, provide reasonable estimates
3. Be specific in descriptions
4. Amounts should be in GBP without currency symbols
5. Group related items logically
6. Return ONLY the JSON array, no other text`
                        }, {
                            role: 'user',
                            content: description
                        }],
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content.trim();

                // Parse JSON response
                let items;
                try {
                    // Handle potential markdown code blocks
                    const jsonStr = content.replace(/```json\n?/g, '').replace(/```\n?/g, '');
                    items = JSON.parse(jsonStr);
                } catch (e) {
                    throw new Error('Failed to parse AI response');
                }

                // Clear existing items and add new ones
                document.getElementById('lineItemsContainer').innerHTML = '';
                items.forEach(item => {
                    addLineItem(item.description, item.amount);
                });

                statusDiv.className = 'ai-status';
                statusDiv.innerHTML = `Parsed ${items.length} item(s) from description`;

                showToast(`Parsed ${items.length} items`, 'success');

            } catch (error) {
                console.error('AI parsing error:', error);
                statusDiv.className = 'ai-status error';
                statusDiv.innerHTML = `Error: ${error.message}`;
                showToast('Failed to parse with AI', 'error');
            }

            document.getElementById('parseText').textContent = 'Parse with AI';
        }

        async function lookupClientAddress() {
            const clientName = document.getElementById('clientName').value.trim();
            const clientOrg = document.getElementById('clientOrg').value.trim();

            if (!clientOrg && !clientName) {
                showToast('Please enter client name or organisation', 'error');
                return;
            }

            const apiKey = getAPIKey();
            if (!apiKey) {
                showToast('API key required', 'error');
                return;
            }

            const btn = document.getElementById('addressLookupText');
            btn.innerHTML = '<span class="spinner"></span> Looking up...';

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [{
                            role: 'system',
                            content: `You are an address lookup assistant. Given a company or organisation name, try to find their registered or main business address in the UK.

If you cannot find a specific address, provide a reasonable format placeholder that the user can fill in.

Return ONLY the address in this format (no other text):
Street Address
City/Town
Postcode
Country (if not UK)`
                        }, {
                            role: 'user',
                            content: `Find the address for: ${clientOrg || clientName}`
                        }],
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                const address = data.choices[0].message.content.trim();

                document.getElementById('clientAddress').value = address;
                showToast('Address found', 'success');

            } catch (error) {
                console.error('Address lookup error:', error);
                showToast('Could not find address', 'error');
            }

            btn.textContent = 'Look Up Address';
        }

        // =====================================================
        // QUOTE PREVIEW GENERATION
        // =====================================================
        function generatePreview() {
            const clientName = document.getElementById('clientName').value.trim() || 'Dear Client';
            const clientOrg = document.getElementById('clientOrg').value.trim();
            const clientAddress = document.getElementById('clientAddress').value.trim();
            const quoteTitle = document.getElementById('quoteTitle').value.trim() || 'Quote';
            const quoteRef = document.getElementById('quoteRef').value;
            const quoteDate = document.getElementById('quoteDate').value;
            const additionalNotes = document.getElementById('additionalNotes').value.trim();
            const includeVat = document.getElementById('includeVat').value === 'yes';

            const items = getLineItems();
            const subtotal = items.reduce((sum, item) => sum + item.amount, 0);
            const vat = includeVat ? subtotal * 0.2 : 0;
            const total = subtotal + vat;

            // Format date
            const formattedDate = quoteDate ? new Date(quoteDate).toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            }) : new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });

            // Format reference for title
            const refParts = quoteRef.split('-');
            const refDate = refParts[0].replace('Q', '');
            const titleRef = `Quote ${refDate}-${quoteTitle}`;

            // Build items HTML
            const symbol = CURRENCY_SYMBOLS[currentCurrency];
            let itemsHtml = items.map(item => `
                <tr>
                    <td>${item.description}</td>
                    <td class="amount-col">${symbol}${item.amount.toLocaleString('en-GB', { minimumFractionDigits: 2 })}</td>
                </tr>
            `).join('');

            const previewHtml = `
                <div class="quote-preview" style="padding: 30px;">
                    <!-- Header with Logo -->
                    <div class="quote-header" style="margin-bottom: 20px;">
                        <div>
                            <img src="pebl-logo.png" alt="PEBL Logo" class="quote-logo" style="width: 120px; height: auto; filter: brightness(0.4);">
                        </div>
                        <div class="company-address" style="font-size: 0.85em; line-height: 1.5;">
                            ${COMPANY.name}<br>
                            ${COMPANY.address}<br>
                            ${COMPANY.city}<br>
                            ${COMPANY.postcode}<br>
                            ${COMPANY.website}
                        </div>
                    </div>

                    <!-- Quote Title Banner -->
                    <div class="quote-title-banner" style="padding: 15px 25px; margin-bottom: 20px;">
                        <h2 style="font-size: 1.5em;">${titleRef}</h2>
                    </div>

                    <!-- Client Section -->
                    <div class="client-section" style="margin-bottom: 15px;">
                        <p><strong>${quoteRef}</strong></p>
                        <p style="margin-top: 10px;">Dear ${clientName.split(' ')[0] || 'Client'},</p>
                        <p style="margin-top: 10px; color: #333;">Thank you for your enquiry. Please find the quotation below. If you have any further questions, please do not hesitate to get in touch.</p>
                    </div>

                    <!-- Signature (compact) -->
                    <div style="margin-bottom: 20px;">
                        <p style="margin-bottom: 8px;">Yours sincerely</p>
                        <p><strong>${COMPANY.directorName}</strong><br>
                        <span style="color: #666;">${COMPANY.directorTitle}</span><br>
                        <span style="color: #666; font-size: 0.9em;">${COMPANY.email}</span></p>
                    </div>

                    <!-- Quote Items Table -->
                    <div>
                        <p style="font-weight: 600; margin-bottom: 10px; font-size: 0.95em;">Overview of quotation${includeVat ? ' (20% VAT to be added to all costs on checkout)' : ''}</p>
                        <table class="quote-items-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th style="text-align: right;">Item cost *<br><span style="font-weight: normal; font-size: 0.8em;">(after discounts)</span></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                                <tr class="quote-total-row">
                                    <td>Total cost</td>
                                    <td class="amount-col">${symbol}${total.toLocaleString('en-GB', { minimumFractionDigits: 2 })}</td>
                                </tr>
                            </tbody>
                        </table>
                        ${additionalNotes ? `<p style="font-size: 0.85em; color: #333; margin-top: 10px;"><strong>Note:</strong> ${additionalNotes}</p>` : ''}
                        <p class="vat-note">*Please note all quoted costs are based on current market conditions and may be subject to change in the future.</p>
                    </div>

                    <!-- Footer -->
                    <div class="quote-footer" style="margin-top: 30px; font-size: 0.75em;">
                        <p><strong>${COMPANY.name}</strong> is a Community Interest Company registered at ${COMPANY.address}, ${COMPANY.city}, ${COMPANY.postcode}</p>
                        <p>and registered in the UK at Companies house with company number: ${COMPANY.companyNumber} and VAT registration number: ${COMPANY.vatNumber}</p>
                        <p style="margin-top: 8px;">Contact email: ${COMPANY.email} | Website: ${COMPANY.website}</p>
                    </div>
                </div>
            `;

            document.getElementById('quotePreview').innerHTML = previewHtml;
        }

        // =====================================================
        // PDF GENERATION
        // =====================================================
        async function downloadPDF() {
            generatePreview(); // Ensure preview is up to date

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            const clientName = document.getElementById('clientName').value.trim() || 'Client';
            const quoteTitle = document.getElementById('quoteTitle').value.trim() || 'Quote';
            const quoteRef = document.getElementById('quoteRef').value;
            const quoteDate = document.getElementById('quoteDate').value;
            const additionalNotes = document.getElementById('additionalNotes').value.trim();
            const includeVat = document.getElementById('includeVat').value === 'yes';

            const items = getLineItems();
            const subtotal = items.reduce((sum, item) => sum + item.amount, 0);
            const vat = includeVat ? subtotal * 0.2 : 0;
            const total = subtotal + vat;

            // Format reference
            const refParts = quoteRef.split('-');
            const refDate = refParts[0].replace('Q', '');

            // Page dimensions
            const pageWidth = 210;
            const margin = 20;
            const contentWidth = pageWidth - (margin * 2);

            let y = 20;

            // Add logo (load from image) - dark grey version
            try {
                const logoImg = new Image();
                logoImg.src = 'pebl-logo.png';
                await new Promise((resolve, reject) => {
                    logoImg.onload = resolve;
                    logoImg.onerror = reject;
                    setTimeout(reject, 2000); // 2 second timeout
                });
                // Add logo to PDF (left aligned, ~40mm wide)
                // Note: Logo will appear as-is, we'll use a dark grey text fallback
                doc.addImage(logoImg, 'PNG', margin, y - 5, 40, 12);
            } catch (e) {
                // Fallback to text if logo fails to load (dark grey)
                doc.setFontSize(20);
                doc.setTextColor(80, 80, 80);
                doc.setFont('helvetica', 'bold');
                doc.text('PEBL', margin, y);
            }

            // Company address (right aligned)
            y += 10;
            doc.setFontSize(9);
            doc.setTextColor(85, 85, 85);
            doc.setFont('helvetica', 'normal');
            const addressLines = [
                COMPANY.name,
                COMPANY.address,
                COMPANY.city,
                COMPANY.postcode,
                COMPANY.website
            ];
            addressLines.forEach(line => {
                doc.text(line, pageWidth - margin, y, { align: 'right' });
                y += 4;
            });

            y += 8;

            // Title banner
            doc.setFillColor(58, 175, 169);
            doc.roundedRect(margin, y, contentWidth, 12, 2, 2, 'F');
            doc.setFontSize(14);
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.text(`Quote ${refDate}-${quoteTitle}`, margin + 8, y + 8);

            y += 18;

            // Client greeting
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.text(`${quoteRef}`, margin, y);
            y += 7;

            doc.setFont('helvetica', 'normal');
            doc.text(`Dear ${clientName.split(' ')[0]},`, margin, y);
            y += 7;

            // Thank you text
            doc.setFontSize(10);
            const thankYouText = doc.splitTextToSize('Thank you for your enquiry. Please find the quotation below. If you have any further questions, please do not hesitate to get in touch.', contentWidth);
            doc.text(thankYouText, margin, y);
            y += thankYouText.length * 5 + 5;

            // Signature (compact)
            doc.setFontSize(10);
            doc.text('Yours sincerely', margin, y);
            y += 6;
            doc.setFont('helvetica', 'bold');
            doc.text(COMPANY.directorName, margin, y);
            y += 4;
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text(COMPANY.directorTitle, margin, y);
            y += 4;
            doc.setFontSize(9);
            doc.text(COMPANY.email, margin, y);
            y += 12;

            // Items table header
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(`Overview of quotation${includeVat ? ' (20% VAT to be added to all costs on checkout)' : ''}`, margin, y);
            y += 6;

            // Table
            const symbol = CURRENCY_SYMBOLS[currentCurrency];
            doc.autoTable({
                startY: y,
                head: [['Item', 'Item cost *\n(after discounts)']],
                body: [
                    ...items.map(item => [
                        item.description,
                        `${symbol}${item.amount.toLocaleString('en-GB', { minimumFractionDigits: 2 })}`
                    ]),
                    ['Total cost', `${symbol}${total.toLocaleString('en-GB', { minimumFractionDigits: 2 })}`]
                ],
                styles: {
                    fontSize: 9,
                    cellPadding: 3
                },
                headStyles: {
                    fillColor: [176, 224, 230],
                    textColor: [43, 122, 120],
                    fontStyle: 'bold'
                },
                columnStyles: {
                    1: { halign: 'right' }
                },
                margin: { left: margin, right: margin },
                didParseCell: function(data) {
                    if (data.row.index === items.length && data.section === 'body') {
                        data.cell.styles.fillColor = [176, 224, 230];
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            });

            y = doc.lastAutoTable.finalY + 4;

            // Notes (if any) - after table
            if (additionalNotes) {
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('Note: ', margin, y);
                doc.setFont('helvetica', 'normal');
                const noteWidth = doc.getTextWidth('Note: ');
                const notesText = doc.splitTextToSize(additionalNotes, contentWidth - noteWidth);
                doc.text(notesText[0], margin + noteWidth, y);
                if (notesText.length > 1) {
                    for (let i = 1; i < notesText.length; i++) {
                        y += 4;
                        doc.text(notesText[i], margin, y);
                    }
                }
                y += 5;
            }

            // VAT note
            doc.setFontSize(7);
            doc.setTextColor(100, 100, 100);
            doc.setFont('helvetica', 'italic');
            doc.text('*Please note all quoted costs are based on current market conditions and may be subject to change in the future.', margin, y);

            // Footer
            y = 280;
            doc.setFontSize(7);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text(`${COMPANY.name} is a Community Interest Company registered at ${COMPANY.address}, ${COMPANY.city}, ${COMPANY.postcode}`, pageWidth / 2, y, { align: 'center' });
            y += 3;
            doc.text(`Company number: ${COMPANY.companyNumber} | VAT: ${COMPANY.vatNumber} | ${COMPANY.email} | ${COMPANY.website}`, pageWidth / 2, y, { align: 'center' });

            // Save
            const filename = `Quote_${quoteRef}_${quoteTitle.replace(/\s+/g, '_')}.pdf`;
            doc.save(filename);
            showToast('PDF downloaded', 'success');
        }

        // =====================================================
        // QUOTE SAVE/LOAD
        // =====================================================
        async function saveQuote() {
            if (!db) {
                showToast('Database not ready', 'error');
                return;
            }

            const clientName = document.getElementById('clientName').value.trim();
            const clientOrg = document.getElementById('clientOrg').value.trim();
            const clientAddress = document.getElementById('clientAddress').value.trim();
            const items = getLineItems();

            const quote = {
                reference: document.getElementById('quoteRef').value,
                title: document.getElementById('quoteTitle').value,
                date: document.getElementById('quoteDate').value,
                validUntil: document.getElementById('validUntil').value,
                clientName: clientName,
                clientOrg: clientOrg,
                clientAddress: clientAddress,
                items: items,
                additionalNotes: document.getElementById('additionalNotes').value,
                includeVat: document.getElementById('includeVat').value === 'yes',
                currency: currentCurrency,
                updatedAt: new Date().toISOString()
            };

            const subtotal = quote.items.reduce((sum, item) => sum + item.amount, 0);
            quote.total = quote.includeVat ? subtotal * 1.2 : subtotal;

            // Check if client is new and prompt to save
            if (clientName) {
                const existingClient = savedClients.find(c =>
                    c.name.toLowerCase() === clientName.toLowerCase() &&
                    (c.organisation || '').toLowerCase() === (clientOrg || '').toLowerCase()
                );

                if (!existingClient) {
                    const saveClientAnswer = confirm(`Save "${clientName}${clientOrg ? ' (' + clientOrg + ')' : ''}" to your clients list for future quotes?`);
                    if (saveClientAnswer) {
                        await saveClient(clientName, clientOrg, clientAddress);
                        showToast('Client saved', 'success');
                    }
                }
            }

            // Check for new items not in price list and prompt to save
            const newItems = items.filter(item => {
                if (!item.description) return false;
                return !priceList.find(p =>
                    p.name.toLowerCase() === item.description.toLowerCase()
                );
            });

            if (newItems.length > 0) {
                const itemNames = newItems.map(i => `‚Ä¢ ${i.description}`).join('\n');
                const saveItemsAnswer = confirm(`Save these ${newItems.length} new item(s) to your price list?\n\n${itemNames}`);
                if (saveItemsAnswer) {
                    for (const item of newItems) {
                        await saveItemToPriceList(item.description, item.amount);
                    }
                    showToast(`${newItems.length} item(s) added to price list`, 'success');
                }
            }

            // Now save the quote
            const transaction = db.transaction([QUOTES_STORE], 'readwrite');
            const store = transaction.objectStore(QUOTES_STORE);

            if (editingQuoteId) {
                // Update existing quote
                quote.id = editingQuoteId;
                // Preserve original createdAt
                const originalQuote = savedQuotes.find(q => q.id === editingQuoteId);
                quote.createdAt = originalQuote ? originalQuote.createdAt : quote.updatedAt;

                const request = store.put(quote);
                request.onsuccess = () => {
                    showToast('Quote updated', 'success');
                    loadSavedQuotes();
                    cancelEditing();
                };
                request.onerror = () => {
                    showToast('Failed to update quote', 'error');
                };
            } else {
                // Create new quote
                quote.createdAt = quote.updatedAt;
                const request = store.add(quote);
                request.onsuccess = () => {
                    showToast('Quote saved', 'success');
                    loadSavedQuotes();
                    generateQuoteRef(); // Generate new reference for next quote
                };
                request.onerror = () => {
                    showToast('Failed to save quote', 'error');
                };
            }
        }

        function saveAsNewQuote() {
            // Generate new reference and save as new
            generateQuoteRef();
            editingQuoteId = null; // Clear editing mode so it saves as new
            document.getElementById('editingIndicator').style.display = 'none';
            document.getElementById('saveQuoteBtn').textContent = 'Save Quote';
            document.getElementById('saveAsNewBtn').style.display = 'none';

            // Now save as new
            saveQuote();
        }

        function cancelEditing() {
            editingQuoteId = null;
            document.getElementById('editingIndicator').style.display = 'none';
            document.getElementById('saveQuoteBtn').textContent = 'Save Quote';
            document.getElementById('saveAsNewBtn').style.display = 'none';
            // Reset the dropdown selection
            document.getElementById('savedQuoteSelector').value = '';
        }

        function loadSavedQuotes() {
            if (!db) return;

            const transaction = db.transaction([QUOTES_STORE], 'readonly');
            const store = transaction.objectStore(QUOTES_STORE);
            const request = store.getAll();

            request.onsuccess = () => {
                savedQuotes = request.result.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                renderQuotesList();
            };
        }

        function renderQuotesList() {
            const container = document.getElementById('quotesListContainer');
            document.getElementById('quotesCount').textContent = savedQuotes.length;

            // Update the dropdown selector on the Create tab
            const selector = document.getElementById('savedQuoteSelector');
            const infoText = document.getElementById('savedQuotesInfo');

            if (savedQuotes.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">No saved quotes yet</p>';
                selector.innerHTML = '<option value="">-- No saved quotes --</option>';
                infoText.textContent = 'No saved quotes';
                return;
            }

            // Populate the dropdown
            selector.innerHTML = '<option value="">-- Select a saved quote --</option>' +
                savedQuotes.map(quote => {
                    const symbol = CURRENCY_SYMBOLS[quote.currency || 'GBP'];
                    return `<option value="${quote.id}">${quote.reference} - ${quote.title || 'Untitled'} (${symbol}${quote.total.toFixed(2)})</option>`;
                }).join('');

            infoText.textContent = `${savedQuotes.length} saved quote${savedQuotes.length > 1 ? 's' : ''} available`;

            // Render the list in the Saved Quotes tab
            container.innerHTML = savedQuotes.map(quote => {
                const symbol = CURRENCY_SYMBOLS[quote.currency || 'GBP'];
                return `
                <div class="quote-item" onclick="loadQuote(${quote.id})">
                    <div class="quote-item-info">
                        <div class="quote-item-ref">${quote.reference} - ${quote.title || 'Untitled'}</div>
                        <div class="quote-item-client">${quote.clientName || 'No client'} ${quote.clientOrg ? `(${quote.clientOrg})` : ''}</div>
                        <div class="quote-item-date">${new Date(quote.date).toLocaleDateString('en-GB')} ${quote.currency ? `(${quote.currency})` : ''}</div>
                    </div>
                    <div class="quote-item-amount">${symbol}${quote.total.toFixed(2)}</div>
                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); convertQuoteToInvoice(${quote.id})" style="margin-left: 10px; background: #2B7A78;">üìÑ Convert to Invoice</button>
                    <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteQuote(${quote.id})" style="margin-left: 5px;">Delete</button>
                </div>
            `}).join('');
        }

        function loadSelectedQuote() {
            const selector = document.getElementById('savedQuoteSelector');
            const selectedId = parseInt(selector.value);
            if (selectedId) {
                loadQuote(selectedId);
            } else {
                showToast('Please select a quote to load', 'error');
            }
        }

        function loadQuote(id) {
            const quote = savedQuotes.find(q => q.id === id);
            if (!quote) return;

            // Set editing mode
            editingQuoteId = id;
            document.getElementById('editingIndicator').style.display = 'block';
            document.getElementById('editingQuoteRef').textContent = `${quote.reference} - ${quote.title || 'Untitled'}`;
            document.getElementById('saveQuoteBtn').textContent = 'Update Quote';
            document.getElementById('saveAsNewBtn').style.display = 'inline-flex';

            document.getElementById('quoteRef').value = quote.reference;
            document.getElementById('quoteTitle').value = quote.title || '';
            document.getElementById('quoteDate').value = quote.date;
            document.getElementById('validUntil').value = quote.validUntil || '';
            document.getElementById('clientName').value = quote.clientName || '';
            document.getElementById('clientOrg').value = quote.clientOrg || '';
            document.getElementById('clientAddress').value = quote.clientAddress || '';
            document.getElementById('additionalNotes').value = quote.additionalNotes || '';
            document.getElementById('includeVat').value = quote.includeVat ? 'yes' : 'no';

            // Load line items
            document.getElementById('lineItemsContainer').innerHTML = '';
            quote.items.forEach(item => {
                addLineItem(item.description, item.amount);
            });

            // Restore currency
            if (quote.currency) {
                currentCurrency = quote.currency;
                document.querySelectorAll('.currency-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.currency === quote.currency) {
                        btn.classList.add('active');
                    }
                });
            }

            showTab('create');
            generatePreview();
            updateTotals();
            showToast('Quote loaded for editing', 'success');
        }

        function deleteQuote(id) {
            if (!confirm('Delete this quote?')) return;

            const transaction = db.transaction([QUOTES_STORE], 'readwrite');
            const store = transaction.objectStore(QUOTES_STORE);
            store.delete(id);

            transaction.oncomplete = () => {
                showToast('Quote deleted', 'success');
                loadSavedQuotes();
            };
        }

        function convertQuoteToInvoice(id) {
            const quote = savedQuotes.find(q => q.id === id);
            if (!quote) {
                showToast('Quote not found', 'error');
                return;
            }

            // Convert quote items structure to invoice line items structure
            // Quote items: { description, amount }
            // Invoice needs: { description, quantity, unitPrice }
            const items = quote.items || quote.lineItems || [];
            const convertedLineItems = items.map(item => ({
                description: item.description || item.name || '',
                quantity: item.quantity || 1, // Default to quantity 1 if not specified
                unitPrice: item.unitPrice || item.price || item.amount || 0, // Use amount as unit price for quote conversion
                name: item.description || item.name || ''
            }));

            // Store quote data in localStorage for invoice.html to pick up
            localStorage.setItem('pebl_convert_quote', JSON.stringify({
                quoteId: id,
                quoteReference: quote.reference,
                quoteTitle: quote.title,
                clientName: quote.clientName,
                clientOrg: quote.clientOrg,
                clientAddress: quote.clientAddress,
                projectTitle: quote.title,
                date: quote.date,
                lineItems: convertedLineItems,
                subtotal: quote.subtotal,
                vatRate: quote.vatRate,
                vatAmount: quote.vatAmount,
                total: quote.total,
                currency: quote.currency,
                additionalNotes: quote.additionalNotes,
                includeVat: quote.includeVat
            }));

            // Switch to invoice mode and populate form
            switchMode('invoice');
            populateInvoiceFromQuote(convertedLineItems, quote);
            showToast('Switched to invoice editor', 'success');
        }

        function clearAllQuotes() {
            if (!confirm('Delete ALL saved quotes? This cannot be undone.')) return;

            const transaction = db.transaction([QUOTES_STORE], 'readwrite');
            const store = transaction.objectStore(QUOTES_STORE);
            store.clear();

            transaction.oncomplete = () => {
                showToast('All quotes deleted', 'success');
                loadSavedQuotes();
            };
        }

        // =====================================================
        // PRICE LIST MANAGEMENT
        // =====================================================
        function loadPriceList() {
            if (!db) return;

            const transaction = db.transaction([PRICELIST_STORE], 'readonly');
            const store = transaction.objectStore(PRICELIST_STORE);
            const request = store.getAll();

            request.onsuccess = () => {
                priceList = request.result;
                renderPriceList();
            };
        }

        function renderPriceList() {
            const tbody = document.getElementById('priceListBody');

            // Apply filter
            const filteredList = priceListFilter === 'all'
                ? priceList
                : priceList.filter(item => item.category === priceListFilter);

            document.getElementById('priceItemsCount').textContent = filteredList.length;

            // Also update the quick add selector on the Create Quote tab
            const selector = document.getElementById('priceListSelector');
            if (priceList.length === 0) {
                selector.innerHTML = '<option value="">-- No items in price list --</option>';
            } else {
                selector.innerHTML = '<option value="">-- Quick add from price list --</option>' +
                    priceList.map(item => {
                        const categoryIcon = getCategoryIcon(item.category);
                        return `<option value="${item.id}">${categoryIcon} ${item.name} - ¬£${parseFloat(item.price).toFixed(2)}</option>`;
                    }).join('');
            }

            if (priceList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999; padding: 20px;">No items in price list. Click "+ Add Item" to add one.</td></tr>';
                return;
            }

            if (filteredList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999; padding: 20px;">No items match the selected filter.</td></tr>';
                return;
            }

            tbody.innerHTML = filteredList.map(item => {
                const categoryIcon = getCategoryIcon(item.category);
                const categoryColor = getCategoryColor(item.category);
                return `
                <tr style="height: 45px;">
                    <td>
                        <span style="display: inline-flex; align-items: center; gap: 8px;">
                            <span style="background: ${categoryColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; font-weight: 600; min-width: 20px; text-align: center;">${categoryIcon}</span>
                            <strong>${item.name}</strong>
                        </span>
                    </td>
                    <td style="font-size: 0.9em;">${item.description || '-'}</td>
                    <td style="text-align: right;">¬£${parseFloat(item.price).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editPriceItem(${item.id})">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deletePriceItem(${item.id})">Delete</button>
                    </td>
                </tr>
            `}).join('');
        }

        function getCategoryIcon(category) {
            switch(category) {
                case 'R': return 'R';
                case 'P': return 'P';
                case 'S': return 'S';
                default: return '-';
            }
        }

        function getCategoryColor(category) {
            switch(category) {
                case 'R': return '#3b82f6'; // Blue for Rental
                case 'P': return '#8b5cf6'; // Purple for Purchase
                case 'S': return '#10b981'; // Green for Service
                default: return '#6b7280'; // Gray for undefined
            }
        }

        function filterPriceList(filter) {
            priceListFilter = filter;

            // Update button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');

            renderPriceList();
        }

        function addFromPriceList() {
            const selector = document.getElementById('priceListSelector');
            const selectedId = parseInt(selector.value);

            if (!selectedId) {
                showToast('Please select an item from the price list', 'error');
                return;
            }

            const item = priceList.find(p => p.id === selectedId);
            if (!item) return;

            // Convert price to current currency if needed
            let price = parseFloat(item.price);
            if (currentCurrency !== 'GBP') {
                price = price * exchangeRates[currentCurrency];
            }

            addLineItem(item.name, price.toFixed(2));
            selector.value = ''; // Reset selector
            showToast(`Added: ${item.name}`, 'success');
        }

        function addPriceItem() {
            editingPriceItemId = null;
            document.getElementById('modalItemName').value = '';
            document.getElementById('modalItemCategory').value = 'S';
            document.getElementById('modalItemDesc').value = '';
            document.getElementById('modalItemPrice').value = '';
            document.getElementById('modalItemKeywords').value = '';
            document.getElementById('priceItemModal').classList.add('show');
        }

        function editPriceItem(id) {
            const item = priceList.find(p => p.id === id);
            if (!item) return;

            editingPriceItemId = id;
            document.getElementById('modalItemName').value = item.name || '';
            document.getElementById('modalItemCategory').value = item.category || 'S';
            document.getElementById('modalItemDesc').value = item.description || '';
            document.getElementById('modalItemPrice').value = item.price || '';
            document.getElementById('modalItemKeywords').value = item.keywords || '';
            document.getElementById('priceItemModal').classList.add('show');
        }

        function closePriceModal() {
            document.getElementById('priceItemModal').classList.remove('show');
            editingPriceItemId = null;
        }

        function savePriceItem() {
            const name = document.getElementById('modalItemName').value.trim();
            const category = document.getElementById('modalItemCategory').value;
            const description = document.getElementById('modalItemDesc').value.trim();
            const price = parseFloat(document.getElementById('modalItemPrice').value) || 0;
            const keywords = document.getElementById('modalItemKeywords').value.trim();

            if (!name) {
                showToast('Please enter an item name', 'error');
                return;
            }

            const item = { name, category, description, price, keywords };

            const transaction = db.transaction([PRICELIST_STORE], 'readwrite');
            const store = transaction.objectStore(PRICELIST_STORE);

            if (editingPriceItemId) {
                item.id = editingPriceItemId;
                store.put(item);
            } else {
                store.add(item);
            }

            transaction.oncomplete = () => {
                showToast('Price item saved', 'success');
                closePriceModal();
                loadPriceList();
            };
        }

        function deletePriceItem(id) {
            if (!confirm('Delete this price item?')) return;

            const transaction = db.transaction([PRICELIST_STORE], 'readwrite');
            const store = transaction.objectStore(PRICELIST_STORE);
            store.delete(id);

            transaction.oncomplete = () => {
                showToast('Price item deleted', 'success');
                loadPriceList();
            };
        }

        function savePriceList() {
            showToast('Price list saved automatically', 'success');
        }

        // Bulk import price list items from Budget V2
        async function bulkImportBudgetItems() {
            if (!db) {
                showToast('Database not ready', 'error');
                return;
            }

            const budgetItems = [
                {
                    name: 'SubCam2 - Benthic Deployment (Annual)',
                    description: 'SubCam2 camera system for benthic (seafloor) deployment. Annual rental at ¬£750/year (1 unit √ó ¬£750)',
                    price: 750.00,
                    category: 'R',
                    keywords: 'subcam, camera, benthic, seafloor, deployment, video, monitoring'
                },
                {
                    name: 'SubCam2 - Pelagic Deployment (Annual)',
                    description: 'SubCam2 camera system for pelagic (water column) deployment. Annual rental at ¬£750/year (1 unit √ó ¬£750)',
                    price: 750.00,
                    category: 'R',
                    keywords: 'subcam, camera, pelagic, water column, deployment, video, monitoring'
                },
                {
                    name: 'SubCam2 - Benthic Deployment (Quarterly)',
                    description: 'SubCam2 camera system for benthic deployment. Quarterly rental at ¬£187.50/quarter (1 unit √ó ¬£187.50)',
                    price: 187.50,
                    category: 'R',
                    keywords: 'subcam, camera, benthic, seafloor, quarterly, video'
                },
                {
                    name: 'SubCam2 - Pelagic Deployment (Quarterly)',
                    description: 'SubCam2 camera system for pelagic deployment. Quarterly rental at ¬£187.50/quarter (1 unit √ó ¬£187.50)',
                    price: 187.50,
                    category: 'R',
                    keywords: 'subcam, camera, pelagic, water column, quarterly, video'
                },
                {
                    name: 'SubCam Benthic Mooring Kit (Annual)',
                    description: 'Mooring equipment for benthic SubCam deployment. Annual rental at ¬£100/year (1 kit √ó ¬£100)',
                    price: 100.00,
                    category: 'R',
                    keywords: 'mooring, benthic, subcam, mounting, anchor'
                },
                {
                    name: 'SubCam Benthic Mooring Kit (Quarterly)',
                    description: 'Mooring equipment for benthic SubCam deployment. Quarterly rental at ¬£18.75/quarter (1 kit √ó ¬£18.75)',
                    price: 18.75,
                    category: 'R',
                    keywords: 'mooring, benthic, subcam, mounting, anchor, quarterly'
                },
                {
                    name: 'SubCam Pelagic Mooring Kit (Annual)',
                    description: 'Mooring equipment for pelagic SubCam deployment. Annual rental at ¬£50/year (1 kit √ó ¬£50)',
                    price: 50.00,
                    category: 'R',
                    keywords: 'mooring, pelagic, subcam, mounting, water column'
                },
                {
                    name: 'SubCam Pelagic Mooring Kit (Quarterly)',
                    description: 'Mooring equipment for pelagic SubCam deployment. Quarterly rental at ¬£18.75/quarter (1 kit √ó ¬£18.75)',
                    price: 18.75,
                    category: 'R',
                    keywords: 'mooring, pelagic, subcam, mounting, quarterly'
                },
                {
                    name: 'GrowProbe (Annual)',
                    description: 'GrowProbe monitoring equipment. Annual rental at ¬£300/year (1 unit √ó ¬£300)',
                    price: 300.00,
                    category: 'R',
                    keywords: 'growprobe, monitoring, sensor, annual'
                },
                {
                    name: 'SeaLens (Quarterly)',
                    description: 'SeaLens monitoring equipment. Quarterly rental at ¬£750/quarter (1 unit √ó ¬£750)',
                    price: 750.00,
                    category: 'R',
                    keywords: 'sealens, monitoring, sensor, quarterly'
                },
                {
                    name: 'Equipment Shipping & Maintenance',
                    description: 'Shipping to/from site for equipment repairs and maintenance. Annual service at ¬£50/year',
                    price: 50.00,
                    category: 'S',
                    keywords: 'shipping, maintenance, transport, logistics, repairs'
                },
                {
                    name: 'Video Processing - 180 days',
                    description: 'Processing underwater video footage. 180 days of data at ¬£40/10 days (18 √ó ¬£40 = ¬£720)',
                    price: 720.00,
                    category: 'S',
                    keywords: 'video, processing, analysis, footage, data, 180 days'
                },
                {
                    name: 'Video Processing - 270 days',
                    description: 'Processing underwater video footage. 270 days of data at ¬£40/10 days (27 √ó ¬£40 = ¬£1,080)',
                    price: 1080.00,
                    category: 'S',
                    keywords: 'video, processing, analysis, footage, data, 270 days'
                },
                {
                    name: 'Video Processing - 360 days',
                    description: 'Processing underwater video footage. 360 days of data at ¬£40/10 days (36 √ó ¬£40 = ¬£1,440)',
                    price: 1440.00,
                    category: 'S',
                    keywords: 'video, processing, analysis, footage, data, 360 days'
                },
                {
                    name: 'Video Processing (per 10 days)',
                    description: 'Processing underwater video footage. Rate: ¬£40 per 10 days of data',
                    price: 40.00,
                    category: 'S',
                    keywords: 'video, processing, analysis, footage, data'
                },
                {
                    name: 'FPOD Processing - 270 days',
                    description: 'Processing acoustic data from FPOD devices. 270 days of data at ¬£40/10 days (27 √ó ¬£40 = ¬£1,080)',
                    price: 1080.00,
                    category: 'S',
                    keywords: 'fpod, acoustic, processing, analysis, marine mammal, 270 days'
                },
                {
                    name: 'FPOD Processing - 360 days',
                    description: 'Processing acoustic data from FPOD devices. 360 days of data at ¬£40/10 days (36 √ó ¬£40 = ¬£1,440)',
                    price: 1440.00,
                    category: 'S',
                    keywords: 'fpod, acoustic, processing, analysis, marine mammal, 360 days'
                },
                {
                    name: 'FPOD Processing (per 10 days)',
                    description: 'Processing acoustic data from FPOD devices. Rate: ¬£40 per 10 days of data',
                    price: 40.00,
                    category: 'S',
                    keywords: 'fpod, acoustic, processing, analysis, marine mammal'
                },
                {
                    name: 'eDNA Sediment Sampling (3 replicates)',
                    description: 'eDNA sediment sampling with 3 replicates. Cost: ¬£175/sample + ¬£150/1st metabarcode + ¬£75/2nd metabarcode = ¬£400/replicate (3 √ó ¬£400 = ¬£1,200)',
                    price: 1200.00,
                    category: 'S',
                    keywords: 'edna, dna, sediment, sampling, metabarcode, genetic, molecular'
                },
                {
                    name: 'eDNA Processing - 3 samples',
                    description: 'Laboratory processing and analysis of eDNA samples. 3 samples at ¬£200/sample (3 √ó ¬£200 = ¬£600)',
                    price: 600.00,
                    category: 'S',
                    keywords: 'edna, dna, processing, laboratory, analysis, genetic, 3 samples'
                },
                {
                    name: 'eDNA Processing (per sample)',
                    description: 'Laboratory processing and analysis of eDNA samples. Rate: ¬£200 per sample',
                    price: 200.00,
                    category: 'S',
                    keywords: 'edna, dna, processing, laboratory, analysis, genetic'
                },
                {
                    name: 'Benthic Faunal ID Sampling (3 replicates)',
                    description: 'Collection and taxonomic identification of benthic fauna. 3 replicates at ¬£590/sample (3 √ó ¬£590 = ¬£1,770)',
                    price: 1770.00,
                    category: 'S',
                    keywords: 'benthic, fauna, taxonomy, identification, sampling, biodiversity'
                },
                {
                    name: 'Benthic Faunal ID Processing - 9 replicates',
                    description: 'Laboratory processing and taxonomic ID of benthic fauna. 3 sites with 3 replicates each at ¬£40/replicate (9 √ó ¬£40 = ¬£360)',
                    price: 360.00,
                    category: 'S',
                    keywords: 'benthic, fauna, taxonomy, identification, processing, laboratory, 9 replicates'
                },
                {
                    name: 'Benthic Faunal ID Processing (per replicate)',
                    description: 'Laboratory processing and taxonomic identification of benthic fauna samples. Rate: ¬£40 per replicate',
                    price: 40.00,
                    category: 'S',
                    keywords: 'benthic, fauna, taxonomy, identification, processing, laboratory'
                },
                {
                    name: 'Nitrates & Phosphates Analysis - 6 samples',
                    description: 'Water chemistry analysis for nitrates and phosphates. 6 samples (Mar, May, Jul for 2 sites) at ¬£50/sample (6 √ó ¬£50 = ¬£300)',
                    price: 300.00,
                    category: 'S',
                    keywords: 'nitrates, phosphates, nutrients, water quality, chemistry, analysis'
                },
                {
                    name: 'Nitrates & Phosphates Analysis (per sample)',
                    description: 'Water chemistry analysis for nitrates and phosphates. Rate: ¬£50 per sample',
                    price: 50.00,
                    category: 'S',
                    keywords: 'nitrates, phosphates, nutrients, water quality, chemistry, analysis'
                },
                {
                    name: 'Heavy Metals Analysis - 8 samples',
                    description: 'Analysis of heavy metals (Hg, As, Cd, Pb) in seaweed samples. 8 samples from Control and ArcticFarm sites in July at ¬£50/sample (8 √ó ¬£50 = ¬£400)',
                    price: 400.00,
                    category: 'S',
                    keywords: 'heavy metals, mercury, arsenic, cadmium, lead, contamination, analysis'
                },
                {
                    name: 'Heavy Metals Analysis (per sample)',
                    description: 'Analysis of heavy metals (Hg, As, Cd, Pb) in seaweed or sediment samples. Rate: ¬£50 per sample',
                    price: 50.00,
                    category: 'S',
                    keywords: 'heavy metals, mercury, arsenic, cadmium, lead, contamination, analysis'
                },
                {
                    name: 'Salinity & pH Analysis',
                    description: 'Water quality analysis for salinity and pH measurements. Package rate: ¬£200',
                    price: 200.00,
                    category: 'S',
                    keywords: 'salinity, ph, water quality, chemistry, analysis'
                },
                {
                    name: 'Iodine Analysis - 2 samples',
                    description: 'Iodine content analysis by Fera Scientific. 2 samples at ¬£200/sample (2 √ó ¬£200 = ¬£400)',
                    price: 400.00,
                    category: 'S',
                    keywords: 'iodine, analysis, fera, laboratory, seaweed, chemistry'
                },
                {
                    name: 'Iodine Analysis (per sample)',
                    description: 'Iodine content analysis by Fera Scientific. Rate: ¬£200 per sample',
                    price: 200.00,
                    category: 'S',
                    keywords: 'iodine, analysis, fera, laboratory, seaweed, chemistry'
                },
                {
                    name: 'Data Processing & Chart Creation (per hour)',
                    description: 'Processing environmental data and creating visualizations and charts. Rate: ¬£40 per hour',
                    price: 40.00,
                    category: 'S',
                    keywords: 'data, processing, charts, visualization, analysis, graphs'
                },
                {
                    name: 'Technical Support & Reporting (per hour)',
                    description: 'Technical support, data interpretation, and report writing. Rate: ¬£40 per hour',
                    price: 40.00,
                    category: 'S',
                    keywords: 'technical support, reporting, documentation, analysis, consultation'
                },
                {
                    name: 'Technical Support Package (Quarterly)',
                    description: 'Comprehensive technical support including data processing and reporting. Quarterly rate: ¬£1,260 (approx. 32 hours at ¬£40/hour)',
                    price: 1260.00,
                    category: 'S',
                    keywords: 'technical support, reporting, package, quarterly, documentation'
                },
                {
                    name: 'On-Site Equipment Training',
                    description: 'On-site training for equipment deployment, use, and maintenance. 2 sessions at ¬£550 each (2 √ó ¬£550 = ¬£1,100)',
                    price: 1100.00,
                    category: 'S',
                    keywords: 'training, onsite, equipment, deployment, maintenance, instruction'
                },
                {
                    name: 'Remote Equipment Training (per hour)',
                    description: 'Remote/online training for equipment use and maintenance. Rate: ¬£40 per hour',
                    price: 40.00,
                    category: 'S',
                    keywords: 'training, remote, online, equipment, instruction, virtual'
                },
                {
                    name: 'Pre/Post Deployment Inspection',
                    description: 'Equipment check-in inspection before and after deployment. 18 inspections at ¬£40 each (18 √ó ¬£40 = ¬£720)',
                    price: 720.00,
                    category: 'S',
                    keywords: 'inspection, deployment, equipment, check-in, maintenance'
                },
                {
                    name: 'Quarterly Training Package',
                    description: 'Comprehensive training including on-site and remote sessions. Quarterly rate: ¬£635 (approx. 16 hours at ¬£40/hour)',
                    price: 635.00,
                    category: 'S',
                    keywords: 'training, quarterly, package, comprehensive, onsite, remote'
                },
                {
                    name: 'Quarterly Sampling Package',
                    description: 'Comprehensive sampling including eDNA, water quality, and analysis. Quarterly rate: ¬£1,850',
                    price: 1850.00,
                    category: 'S',
                    keywords: 'sampling, quarterly, package, comprehensive, edna, water quality'
                },
                {
                    name: 'Quarterly Equipment Rental Package',
                    description: 'Complete equipment rental including cameras, sensors, and moorings. Quarterly rate: ¬£1,125',
                    price: 1125.00,
                    category: 'R',
                    keywords: 'equipment, rental, quarterly, package, subcam, sensors'
                }
            ];

            const transaction = db.transaction([PRICELIST_STORE], 'readwrite');
            const store = transaction.objectStore(PRICELIST_STORE);

            let addedCount = 0;
            let skippedCount = 0;

            for (const item of budgetItems) {
                // Check if item already exists
                const existingIndex = store.index('name');
                const existingRequest = existingIndex.get(item.name);

                existingRequest.onsuccess = () => {
                    if (!existingRequest.result) {
                        store.add(item);
                        addedCount++;
                    } else {
                        skippedCount++;
                    }
                };
            }

            transaction.oncomplete = () => {
                showToast(`Import complete: ${addedCount} items added, ${skippedCount} items already existed`, 'success');
                loadPriceList();
            };

            transaction.onerror = () => {
                showToast('Import failed', 'error');
            };
        }

        // =====================================================
        // CLIENT MANAGEMENT
        // =====================================================
        function loadSavedClients() {
            if (!db) return;

            const transaction = db.transaction([CLIENTS_STORE], 'readonly');
            const store = transaction.objectStore(CLIENTS_STORE);
            const request = store.getAll();

            request.onsuccess = () => {
                savedClients = request.result.sort((a, b) =>
                    (a.name || '').localeCompare(b.name || '')
                );
                renderClientsDropdown();
            };
        }

        function renderClientsDropdown() {
            const selector = document.getElementById('clientSelector');

            if (savedClients.length === 0) {
                selector.innerHTML = '<option value="">-- New Client --</option>';
                return;
            }

            selector.innerHTML = '<option value="">-- New Client --</option>' +
                savedClients.map(client => {
                    const displayName = client.organisation
                        ? `${client.name} (${client.organisation})`
                        : client.name;
                    return `<option value="${client.id}">${displayName}</option>`;
                }).join('');
        }

        function loadSelectedClient() {
            const selector = document.getElementById('clientSelector');
            const selectedId = parseInt(selector.value);

            if (!selectedId) {
                // New client selected - clear fields
                document.getElementById('clientName').value = '';
                document.getElementById('clientOrg').value = '';
                document.getElementById('clientAddress').value = '';
                return;
            }

            const client = savedClients.find(c => c.id === selectedId);
            if (!client) return;

            document.getElementById('clientName').value = client.name || '';
            document.getElementById('clientOrg').value = client.organisation || '';
            document.getElementById('clientAddress').value = client.address || '';

            showToast('Client loaded', 'success');
        }

        function saveClient(name, organisation, address) {
            return new Promise((resolve, reject) => {
                if (!db || !name) {
                    resolve(false);
                    return;
                }

                // Check if client already exists
                const existingClient = savedClients.find(c =>
                    c.name.toLowerCase() === name.toLowerCase() &&
                    (c.organisation || '').toLowerCase() === (organisation || '').toLowerCase()
                );

                if (existingClient) {
                    // Update existing client's address if changed
                    if (address && address !== existingClient.address) {
                        existingClient.address = address;
                        const transaction = db.transaction([CLIENTS_STORE], 'readwrite');
                        const store = transaction.objectStore(CLIENTS_STORE);
                        store.put(existingClient);
                        transaction.oncomplete = () => {
                            loadSavedClients();
                            resolve(true);
                        };
                    } else {
                        resolve(false);
                    }
                    return;
                }

                // Save new client
                const client = { name, organisation, address, createdAt: new Date().toISOString() };
                const transaction = db.transaction([CLIENTS_STORE], 'readwrite');
                const store = transaction.objectStore(CLIENTS_STORE);
                const request = store.add(client);

                request.onsuccess = () => {
                    loadSavedClients();
                    resolve(true);
                };
                request.onerror = () => {
                    resolve(false);
                };
            });
        }

        async function saveClientManually() {
            const name = document.getElementById('clientName').value.trim();
            const organisation = document.getElementById('clientOrg').value.trim();
            const address = document.getElementById('clientAddress').value.trim();

            if (!name) {
                showToast('Please enter a client name', 'error');
                return;
            }

            const saved = await saveClient(name, organisation, address);
            if (saved) {
                showToast(`Client "${name}" saved successfully`, 'success');
            } else {
                // Check if client already exists
                const existingClient = savedClients.find(c =>
                    c.name.toLowerCase() === name.toLowerCase() &&
                    (c.organisation || '').toLowerCase() === (organisation || '').toLowerCase()
                );
                if (existingClient) {
                    showToast('Client already exists in your list', 'info');
                } else {
                    showToast('Failed to save client', 'error');
                }
            }
        }

        function saveItemToPriceList(description, amount) {
            return new Promise((resolve, reject) => {
                if (!db || !description) {
                    resolve(false);
                    return;
                }

                // Check if item already exists (by name)
                const existingItem = priceList.find(p =>
                    p.name.toLowerCase() === description.toLowerCase()
                );

                if (existingItem) {
                    resolve(false);
                    return;
                }

                // Save new price item
                const item = {
                    name: description,
                    description: '',
                    price: amount,
                    keywords: description.toLowerCase().split(' ').filter(w => w.length > 3).join(', ')
                };

                const transaction = db.transaction([PRICELIST_STORE], 'readwrite');
                const store = transaction.objectStore(PRICELIST_STORE);
                const request = store.add(item);

                request.onsuccess = () => {
                    loadPriceList();
                    resolve(true);
                };
                request.onerror = () => {
                    resolve(false);
                };
            });
        }

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================
        function clearForm() {
            document.getElementById('clientName').value = '';
            document.getElementById('clientOrg').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('clientSelector').value = ''; // Reset client selector
            document.getElementById('serviceDescription').value = '';
            document.getElementById('quoteTitle').value = '';
            document.getElementById('additionalNotes').value = '';
            document.getElementById('lineItemsContainer').innerHTML = '';
            document.getElementById('priceListSelector').value = ''; // Reset price list selector
            addLineItem();
            generateQuoteRef();
            setDefaultDates();

            // Reset currency to GBP
            currentCurrency = 'GBP';
            baseAmountsGBP = [];
            document.querySelectorAll('.currency-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.currency === 'GBP') {
                    btn.classList.add('active');
                }
            });

            // Cancel editing mode
            cancelEditing();

            updateTotals();

            document.getElementById('quotePreview').innerHTML = `
                <div style="text-align: center; color: #999; padding: 100px 20px;">
                    <p>Fill in the form and click "Preview Quote" to see the preview</p>
                </div>
            `;

            document.getElementById('aiStatus').style.display = 'none';
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>

    <!-- Split Screen Overlay -->
    <div class="split-screen-overlay" id="splitScreenOverlay">
        <div class="split-screen-header">
            <h2>Split Screen Mode</h2>
            <div class="split-screen-controls">
                <div class="split-pane-selector">
                    <label>Left:</label>
                    <select id="leftPaneSelector" onchange="updateSplitPane('left')">
                        <option value="grants.html">Grants</option>
                        <option value="spend.html">Spend</option>
                        <option value="gantt.html">Gantt</option>
                        <option value="timesheet.html">Labour</option>
                        <option value="index.html">Sketcher</option>
                        <option value="exploit.html">Exploit</option>
                        <option value="risks.html">Risks</option>
                        <option value="quote.html" selected>Quote</option>
                    </select>
                </div>
                <div class="split-pane-selector">
                    <label>Right:</label>
                    <select id="rightPaneSelector" onchange="updateSplitPane('right')">
                        <option value="grants.html">Grants</option>
                        <option value="spend.html">Spend</option>
                        <option value="gantt.html">Gantt</option>
                        <option value="timesheet.html">Labour</option>
                        <option value="index.html">Sketcher</option>
                        <option value="exploit.html">Exploit</option>
                        <option value="risks.html">Risks</option>
                        <option value="quote.html">Quote</option>
                    </select>
                </div>
                <button class="split-orientation-btn" onclick="toggleOrientation()">
                    <span id="orientationIcon">‚Üî</span> Toggle Layout
                </button>
            </div>
            <button class="split-screen-close" onclick="closeSplitScreenMode()">Close Split Screen</button>
        </div>
        <div class="split-screen-container" id="splitContainer">
            <div class="split-pane">
                <div class="split-pane-header">
                    <span id="leftPaneTitle">Quote</span>
                </div>
                <div class="split-pane-content">
                    <iframe id="leftPane" src="quote.html"></iframe>
                </div>
            </div>
            <div class="split-divider" id="splitDivider"></div>
            <div class="split-pane">
                <div class="split-pane-header">
                    <span id="rightPaneTitle">Grants</span>
                </div>
                <div class="split-pane-content">
                    <iframe id="rightPane" src="grants.html"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Split Screen Functionality
        let isVerticalLayout = false;

        function openSplitScreenMode() {
            document.getElementById('splitScreenOverlay').classList.add('active');
            // Initialize with current page on left, first other page on right
            updateSplitPane('left');
            updateSplitPane('right');
        }

        function closeSplitScreenMode() {
            document.getElementById('splitScreenOverlay').classList.remove('active');
        }

        function updateSplitPane(side) {
            const selector = document.getElementById(side + 'PaneSelector');
            const iframe = document.getElementById(side + 'Pane');
            const title = document.getElementById(side + 'PaneTitle');

            const selectedValue = selector.value;
            const selectedText = selector.options[selector.selectedIndex].text;

            iframe.src = selectedValue;
            title.textContent = selectedText;
        }

        function toggleOrientation() {
            const container = document.getElementById('splitContainer');
            const icon = document.getElementById('orientationIcon');

            isVerticalLayout = !isVerticalLayout;

            if (isVerticalLayout) {
                container.classList.add('vertical');
                icon.textContent = '‚Üï';
            } else {
                container.classList.remove('vertical');
                icon.textContent = '‚Üî';
            }
        }

        // Divider dragging functionality
        const divider = document.getElementById('splitDivider');
        const container = document.getElementById('splitContainer');
        let isDragging = false;

        divider.addEventListener('mousedown', (e) => {
            isDragging = true;
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            const containerRect = container.getBoundingClientRect();
            const panes = container.querySelectorAll('.split-pane');

            if (isVerticalLayout) {
                const offsetY = e.clientY - containerRect.top;
                const percentage = (offsetY / containerRect.height) * 100;
                if (percentage > 10 && percentage < 90) {
                    panes[0].style.flex = `0 0 ${percentage}%`;
                    panes[1].style.flex = `0 0 ${100 - percentage}%`;
                }
            } else {
                const offsetX = e.clientX - containerRect.left;
                const percentage = (offsetX / containerRect.width) * 100;
                if (percentage > 10 && percentage < 90) {
                    panes[0].style.flex = `0 0 ${percentage}%`;
                    panes[1].style.flex = `0 0 ${100 - percentage}%`;
                }
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        // =====================================================
        // MODE SWITCHING (Quote vs Invoice)
        // =====================================================
        let currentMode = 'quote'; // 'quote' or 'invoice'

        function switchMode(mode) {
            currentMode = mode;

            // Update mode buttons
            const quoteBtn = document.getElementById('quoteModeBtn');
            const invoiceBtn = document.getElementById('invoiceModeBtn');

            if (mode === 'quote') {
                quoteBtn.classList.add('active');
                invoiceBtn.classList.remove('active');

                // Update main tabs to show quote tabs
                document.getElementById('mainTabs').innerHTML = `
                    <button class="tab active" onclick="showTab('create')">Create Quote</button>
                    <button class="tab" onclick="showTab('saved')">Saved Quotes</button>
                    <button class="tab" onclick="showTab('pricelist')">Price List</button>
                `;

                // Hide invoice tabs, show quote tabs
                document.getElementById('tab-create').style.display = 'block';
                document.getElementById('tab-saved').style.display = 'none';
                document.getElementById('tab-pricelist').style.display = 'none';
                document.getElementById('tab-invoice-create').style.display = 'none';
                document.getElementById('tab-invoice-saved').style.display = 'none';

                // Show create quote tab
                showTab('create');
            } else {
                invoiceBtn.classList.add('active');
                quoteBtn.classList.remove('active');

                // Update main tabs to show invoice tabs
                document.getElementById('mainTabs').innerHTML = `
                    <button class="tab active" onclick="showTab('invoice-create')">Create Invoice</button>
                    <button class="tab" onclick="showTab('invoice-saved')">Saved Invoices</button>
                    <button class="tab" onclick="showTab('pricelist')">Price List</button>
                `;

                // Hide quote tabs, show invoice tabs
                document.getElementById('tab-create').style.display = 'none';
                document.getElementById('tab-saved').style.display = 'none';
                document.getElementById('tab-pricelist').style.display = 'none';
                document.getElementById('tab-invoice-create').style.display = 'block';
                document.getElementById('tab-invoice-saved').style.display = 'none';

                // Show create invoice tab
                showTab('invoice-create');
            }
        }

        // =====================================================
        // INVOICE LINE ITEMS MANAGEMENT
        // =====================================================
        let invoiceLineItems = [];
        let nextInvoiceLineItemId = 1;

        function addInvoiceLineItem() {
            const newItem = {
                id: nextInvoiceLineItemId++,
                description: '',
                quantity: 1,
                unitPrice: 0,
                total: 0
            };
            invoiceLineItems.push(newItem);
            renderInvoiceLineItems();
            updateInvoiceTotals();
        }

        function removeInvoiceLineItem(id) {
            invoiceLineItems = invoiceLineItems.filter(item => item.id !== id);
            renderInvoiceLineItems();
            updateInvoiceTotals();
        }

        function duplicateInvoiceLineItem(id) {
            const item = invoiceLineItems.find(i => i.id === id);
            if (!item) return;

            // Create a copy with a new ID
            const duplicatedItem = {
                id: nextInvoiceLineItemId++,
                description: item.description,
                quantity: item.quantity,
                unitPrice: item.unitPrice,
                total: item.total
            };

            // Find the index of the original item and insert the duplicate right after it
            const index = invoiceLineItems.findIndex(i => i.id === id);
            invoiceLineItems.splice(index + 1, 0, duplicatedItem);

            renderInvoiceLineItems();
            updateInvoiceTotals();
            showToast('Line item duplicated successfully', 'success');
        }

        function renderInvoiceLineItems() {
            const container = document.getElementById('invoiceLineItemsContainer');

            if (invoiceLineItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #94a3b8;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üìã</div>
                        <p>No line items yet. Click "+ Add Line Item" to get started.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = invoiceLineItems.map(item => {
                // Calculate dynamic height based on content - more generous calculation
                // Count actual line breaks
                const lineBreaks = (item.description.match(/\n/g) || []).length;
                // Estimate wrapped lines (assuming ~70 chars per line with proper wrapping)
                const wrappedLines = Math.ceil(item.description.length / 70);
                // Total estimated lines
                const totalLines = Math.max(lineBreaks + 1, wrappedLines);
                // Calculate height with generous spacing (25px per line + base padding)
                const minHeight = Math.max(120, totalLines * 25 + 40);

                return `
                <div class="line-item" style="margin-bottom: 20px; padding: 20px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <!-- Description - Full Width -->
                        <div style="width: 100%;">
                            <label style="display: block; font-size: 13px; color: #475569; margin-bottom: 6px; font-weight: 700;">Description</label>
                            <textarea
                                   placeholder="Enter detailed item description, calculations, and justification"
                                   onchange="updateInvoiceLineItem(${item.id}, 'description', this.value)"
                                   oninput="autoResizeTextarea(this)"
                                   style="width: 100%; height: ${minHeight}px; min-height: ${minHeight}px; padding: 14px; border: 2px solid #cbd5e1; border-radius: 6px; font-size: 14px; font-family: inherit; resize: vertical; line-height: 1.8; background: #fafafa; overflow-y: hidden;">${item.description}</textarea>
                        </div>

                        <!-- Quantity, Unit Price, Total, Actions - In a row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto auto; gap: 12px; align-items: end;">
                            <div>
                                <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 600;">Quantity</label>
                                <input type="number"
                                       value="${item.quantity}"
                                       placeholder="Qty"
                                       onchange="updateInvoiceLineItem(${item.id}, 'quantity', parseFloat(this.value) || 0)"
                                       style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 600;">Unit Price (¬£)</label>
                                <input type="number"
                                       value="${item.unitPrice}"
                                       placeholder="0.00"
                                       step="0.01"
                                       onchange="updateInvoiceLineItem(${item.id}, 'unitPrice', parseFloat(this.value) || 0)"
                                       style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 600;">Total</label>
                                <div style="padding: 10px 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 6px; font-weight: 700; text-align: right; color: white; font-size: 16px;">
                                    ¬£${item.total.toFixed(2)}
                                </div>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="duplicateInvoiceLineItem(${item.id})" style="padding: 10px 14px; height: 42px; background: #3b82f6; color: white;" title="Duplicate this item">
                                üìã
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="removeInvoiceLineItem(${item.id})" style="padding: 10px 14px; height: 42px;" title="Delete this item">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');

            // After rendering, ensure all textareas are properly sized
            setTimeout(() => {
                container.querySelectorAll('textarea').forEach(textarea => {
                    autoResizeTextarea(textarea);
                });
            }, 10);
        }

        function updateInvoiceLineItem(id, field, value) {
            const item = invoiceLineItems.find(i => i.id === id);
            if (!item) return;

            item[field] = value;
            item.total = item.quantity * item.unitPrice;
            renderInvoiceLineItems();
            updateInvoiceTotals();
        }

        function autoResizeTextarea(textarea) {
            // Reset height to allow shrinking
            textarea.style.height = 'auto';
            // Set to scrollHeight to fit all content
            textarea.style.height = (textarea.scrollHeight + 5) + 'px';
        }

        function updateInvoiceTotals() {
            const subtotal = invoiceLineItems.reduce((sum, item) => sum + item.total, 0);
            const vatRate = parseFloat(document.getElementById('invoiceVatRate')?.textContent || 20);
            const vatAmount = subtotal * (vatRate / 100);
            const total = subtotal + vatAmount;

            document.getElementById('invoiceSubtotal').textContent = `¬£${subtotal.toFixed(2)}`;
            document.getElementById('invoiceVat').textContent = `¬£${vatAmount.toFixed(2)}`;
            document.getElementById('invoiceTotal').textContent = `¬£${total.toFixed(2)}`;

            // Update duplicate total in summary panel
            const totalDuplicate = document.getElementById('invoiceTotalDuplicate');
            if (totalDuplicate) {
                totalDuplicate.textContent = `¬£${total.toFixed(2)}`;
            }
        }

        function populateInvoiceFromQuote(lineItems, quote) {
            // Set invoice date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDate').value = today;

            // Set due date to 30 days from now
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];

            // Populate client details
            document.getElementById('invoiceClientName').value = quote.clientName || '';
            document.getElementById('invoiceClientOrg').value = quote.clientOrg || '';
            document.getElementById('invoiceClientAddress').value = quote.clientAddress || '';

            // Populate project details
            document.getElementById('invoiceProjectName').value = quote.title || '';
            document.getElementById('linkedQuoteRef').value = quote.reference || '';

            // Populate line items
            invoiceLineItems = lineItems.map((item, index) => ({
                id: index + 1,
                description: item.description || item.name || '',
                quantity: item.quantity || 1,
                unitPrice: item.unitPrice || 0,
                total: (item.quantity || 1) * (item.unitPrice || 0)
            }));
            nextInvoiceLineItemId = invoiceLineItems.length + 1;

            renderInvoiceLineItems();
            updateInvoiceTotals();

            // Hide import banner
            if (document.getElementById('sampleImportBannerQuote')) {
                document.getElementById('sampleImportBannerQuote').style.display = 'none';
            }
        }

        function clearInvoiceForm() {
            invoiceLineItems = [];
            nextInvoiceLineItemId = 1;
            document.getElementById('invoiceNumber').value = '';
            document.getElementById('invoiceDate').value = '';
            document.getElementById('invoiceDueDate').value = '';
            document.getElementById('invoiceProjectName').value = '';
            document.getElementById('linkedQuoteRef').value = '';
            document.getElementById('invoiceClientName').value = '';
            document.getElementById('invoiceClientOrg').value = '';
            document.getElementById('invoiceClientAddress').value = '';
            document.getElementById('invoiceAdditionalNotes').value = '';
            renderInvoiceLineItems();
            updateInvoiceTotals();
        }

        // =====================================================
        // IMPORT SAMPLE INVOICE
        // =====================================================
        function importAlgapelagoInvoice() {
            if (!confirm('Import sample Algapelago invoice?\n\nThis will load a complete invoice with all line items from the Marine Monitoring March - November 2025 project. You can then review, edit, and save it.')) {
                return;
            }

            // Clear form first
            clearInvoiceForm();

            // Set invoice details
            document.getElementById('invoiceNumber').value = 'SAMPLE';
            document.getElementById('invoiceDate').value = '2026-01-11';
            document.getElementById('invoiceDueDate').value = '2026-02-11';

            document.getElementById('invoiceProjectName').value = 'Algapelago Marine Monitoring March - November 2025';
            document.getElementById('linkedQuoteRef').value = '';

            // Client details
            document.getElementById('invoiceClientName').value = 'Algapelago Marine Ltd';
            document.getElementById('invoiceClientOrg').value = '';
            document.getElementById('invoiceClientAddress').value = '';

            // Additional notes
            document.getElementById('invoiceAdditionalNotes').value = 'Payment Terms: Net 30 days from invoice date';

            // Create line items matching actual invoice
            invoiceLineItems = [
                {
                    id: 1,
                    description: 'SubCam2 - Benthic Deployment (Datasets: Subcam_Farm_AS_2504-2506, Subcam_Farm_LE_2504-2506)\nDeployment Period: April-June 2025 (3 months)\nUnits Deployed: 2 cameras\nRental Rate: ¬£187.50 per unit per quarter\nCalculation: 1 quarter per unit √ó 2 units = 2 quarter-units\nCost Breakdown: 2 quarter-units √ó ¬£187.50 = ¬£375\nJustification: Benthic underwater camera systems for farm site monitoring during spring deployment phase',
                    quantity: 2,
                    unitPrice: 187.50,
                    total: 375.00
                },
                {
                    id: 2,
                    description: 'SubCam2 - Benthic Deployment (Dataset: Subcam_C_S_2506-2508, Subcam_LE_2506-2508)\nDeployment Period: June-August 2025 (2 months)\nUnits Deployed: 2 cameras\nRental Rate: ¬£187.50 per unit per quarter\nCalculation: 0.67 quarters per unit √ó 2 units = 1.33 quarter-units\nCost Breakdown: 1.33 quarter-units √ó ¬£187.50 = ¬£249.38\nJustification: Control site benthic camera deployment for comparative baseline data during summer period',
                    quantity: 1.33,
                    unitPrice: 187.50,
                    total: 249.38
                },
                {
                    id: 3,
                    description: 'SubCam2 - Pelagic Deployment (Dataset: Subcam_Pel_Farm_LE_2504-2506, Farm_LE_2506-2508, Control_2504-2506, Control_2506-2508)\nDeployment Period: June 2025 (5 month)\nUnits Deployed: 2 camera\nRental Rate: ¬£187.50 per unit per quarter\nCalculation: 2 √ó 1.67 = 3.33 quarter-units\nCost Breakdown: 3.33 quarter-units √ó ¬£187.50 = ¬£624.38\nJustification: Single-month pelagic zone monitoring at control site to assess water column biodiversity and validate deployment methodology',
                    quantity: 3.33,
                    unitPrice: 187.50,
                    total: 624.38
                },
                {
                    id: 4,
                    description: 'SubCam Mooring Kits - Complete Deployment System (Benthic & Pelagic)\nDeployment Period: March-August 2025 (variable duration across 4 moorings)\nUnits Deployed: 4 complete mooring kits\nRental Rate: ¬£18.75 per kit per month\nDeployment Details:\n  - Mooring 1 (Farm AS): 6 months\n  - Mooring 2 (Control): 6 months\n  - Mooring 3 (Farm L): 6 months\n  - Mooring 4 (Pel LE): 6 month\n  - Mooring 4 (Pel Control): 6 month\nCalculation: 30 kit-months = 10 kit-quarters\nCost Breakdown: 10 kit-quarters √ó ¬£18.75 = ¬£187.50\nJustification: Essential mooring infrastructure including weights, buoys, and rigging for secure camera deployment',
                    quantity: 10,
                    unitPrice: 18.75,
                    total: 187.50
                },
                {
                    id: 5,
                    description: 'GrowProbe Environmental Sensors - Multi-Parameter Water Quality Monitoring (Dataset: Control_S Pelagic 2410-2412, Farm_LE 2504-2506)\nDeployment Period: (3 months per deployment)\nUnits Deployed: 2 sensors (1 farm site, 1 control site)\nRental Rate: ¬£187.50 per unit per quarter\nCalculation: 2 quarter-units\nCost Breakdown: 2 quarter-units √ó ¬£187.50 = ¬£375\nParameters Monitored: Temperature, salinity, dissolved oxygen, pH, turbidity, chlorophyll-a\nJustification: Correlating biological observations with environmental conditions and detecting farm-related water quality impacts',
                    quantity: 2,
                    unitPrice: 187.50,
                    total: 375.00
                },
                {
                    id: 6,
                    description: 'eDNA Sampling Kits - ecoType Sediment Collection System\nSampling Design: 6 sampling sites √ó 2 metbarcodes per site (COI + 18S)\nKit Type: ecoType Sediment eDNA collection kits with sterile collection apparatus\nUnit Cost Kit: ¬£175.00 per kit (includes preservation buffer, sterile sampling tools, shipping container)\nUnit Cost Analysis: ¬£225.00 for Metataxonomic Analysis - Two Markers (COI and 18S)\nCalculation: 6 samples √ó (¬£175.00 + ¬£225) = ¬£2,400.00\nJustification: Molecular biodiversity assessment using environmental DNA from sediment samples to detect species presence without direct observation; replicates ensure statistical robustness',
                    quantity: 6,
                    unitPrice: 400.00,
                    total: 2400.00
                },
                {
                    id: 7,
                    description: 'Water Quality Analysis - Heavy Metals Panel (ICP-MS), Nitrogen & Carbon Panel (CHN Elemental Analysis)\nAnalysis Type: Inductively Coupled Plasma Mass Spectrometry (ICP-MS) for trace metal detection, Total Carbon, Total Nitrogen, and C:N ratio determination\nSample Count: 3 seaweed samples (Farm_LE)\nAnalyzed: Mercury (Hg), Arsenic (As), Cadmium (Cd), Lead (Pb), Carbon (C), Nitrogen (N)\nUnit Cost: ¬£150.00 per sample for full heavy metals panel\nCalculation: 3 samples √ó ¬£150.00 = ¬£450.00\nJustification: Essential baseline for detecting potential heavy metal contamination from farm infrastructure or localized pollution sources; regulatory compliance requirement',
                    quantity: 3,
                    unitPrice: 150.00,
                    total: 450.00
                },
                {
                    id: 8,
                    description: 'Water Quality Analysis - Salinity, pH, Nitrates, Phosphates\nAnalysis Type: Desktop PCE Datalogger Probe, Colorimeter for marine Nitrates and Phosphates\nSample Count: 8 water samples (each 6 replicates)\nUnit Cost: ¬£60.00 per sample with 6 replicates\nCalculation: 8 samples √ó ¬£60.00 = ¬£480\nJustification: Essential for detecting water quality anomalies that might effect seaweed/bivalve growth conditions',
                    quantity: 8,
                    unitPrice: 60.00,
                    total: 480.00
                },
                {
                    id: 9,
                    description: 'Seaweed Morphology Analysis - Length, Width, Fouling\nAnalysis Type: Photogrammetry\nSample Count: 6 (March), 6 (April), 1 (June), 1(July), 2 (Aug) = 16 sample bags\nSample cost: 1.5hrs per sample at ¬£40/hr\nCalculation: 16 samples √ó ¬£60.00 = ¬£960\nJustification: Essential for detecting water quality anomalies that might effect seaweed/bivalve growth conditions',
                    quantity: 16,
                    unitPrice: 60.00,
                    total: 960.00
                },
                {
                    id: 10,
                    description: 'Sample Courier charges:\neDNA samples: ¬£25 - DHL Express Insured Service\nHeavy Metal: Courier Collection SOCOTEC: ¬£35\nC / N Water Quality : Courier Collection SOCOTEC: ¬£35\nSeaweed Morphology Samples: Evri / DHL Express: ¬£10 x 4',
                    quantity: 1,
                    unitPrice: 135.00,
                    total: 135.00
                },
                {
                    id: 11,
                    description: 'Subcam footage Analysis rate: ¬£40/hr of usable footage\nSubcam_Alga_Farm_AS_2503-2504-benthic, (10min), 9 files analysed\nSubcam_Alga_Farm_L_2503-2504-benthic, (10min), 10 analysed\nSubCam_Alga_Control_2504-2506-Benthic, (10min), 39 analysed\nSubCam_Alga_Farm_AS_2504-2506-Benthic, (10min), 88 analysed\nSubCam_Alga_Farm_L_2504-2506-Benthic, (10min), 92 analysed\nSubCam_Alga_Control_2506-2508-Benthic, (2min), 67analysed\nSubCam_Alga_Farm_L_2506-2508-Benthic, (2min), 85 analysed\nSubcam_Alga_Control_2503-2504-pelagic, no charge\nSubcam_Alga_Farm_L_2503-2504-pelagic, no charge\nSubCam_Alga_Control_2504-2506-Pelagic, no charge\nSubCam_Alga_Farm_L_2504-2506-Pelagic, no charge\nSubCam_Alga_Control_2506-2508-Pelagic, no charge\nSubCam_Alga_Farm_L_2506-2508-MidPelagic, no charge\nSubCam_Alga_Farm_L_2506-2508-Pelagic, no charge',
                    quantity: 44.73,
                    unitPrice: 40.00,
                    total: 1789.20
                },
                {
                    id: 12,
                    description: 'FPOD data analysis rate: ¬£40/20days of usable data\nFPOD_Alga_Control_2504-2506 (74days)\nFPOD_Alga_Farm_AS_2503-2506 (90days)\nFPOD_Alga_Farm_L_2503-2506 (89days)\nFPOD_Alga_Control_2506-2508 (59days)\nFPOD_Alga_Farm_AS_2506-2508 (57days)\nFPOD_Alga_Farm_L_2506-2508 (147days)',
                    quantity: 25.8,
                    unitPrice: 40.00,
                    total: 1032.00
                },
                {
                    id: 13,
                    description: 'GrowProbe Data Analysis rate: ¬£40/quarter of usable data\nGrowProbe Data Processing (3 months √ó 2 sensor)\nJustification: Taking raw .csv format data, checking for anomalies, cropping data, reformatting for visualisations',
                    quantity: 2,
                    unitPrice: 40.00,
                    total: 80.00
                },
                {
                    id: 14,
                    description: 'eDNA Data Analysis rate: ¬£80/dataset\nJustification: Taking raw .csv format data, checking for anomalies, cropping data, reformatting for visualisations',
                    quantity: 1,
                    unitPrice: 80.00,
                    total: 80.00
                },
                {
                    id: 15,
                    description: 'Technical Report - Executive Summary & Recommendations (4 hrs)\nTechnical Report - Methods & Site Descriptions (8 hrs)\nTechnical Report - Results & Discussion: Video Analysis (Species, Abundance, Behavior) (10 hrs)\nTechnical Report - Results & Discussion: Acoustic Monitoring (Marine Mammals) (8 hrs)\nTechnical Report - Results & Discussion: eDNA Biodiversity & Community Analysis (6 hrs)\nTechnical Report - Results & Discussion: Seaweed Morphology Analysis (4 hrs)\nTechnical Report - Results & Discussion: Environmental Data & Water Quality (8 hrs)\nTechnical Report - Results & Discussion: Pelagic Camera Analysis (2 hrs)\nTechnical Report - Data Visualization (30+ Figures, Maps, Charts) (16 hrs)\nTechnical Report - References, Appendices & Final Formatting (8 hrs)',
                    quantity: 74,
                    unitPrice: 40.00,
                    total: 2960.00
                },
                {
                    id: 16,
                    description: 'Field Support - eDNA sediment sampling support (1 site visits)',
                    quantity: 1,
                    unitPrice: 500.00,
                    total: 500.00
                },
                {
                    id: 17,
                    description: 'Datapack preperation: Management, Quality Control, Database Organization & Visualisation (¬£40/hr)\nDatapack_ALGA_2501-2503 (1hrs)\nDatapack_ALGA_2504-2508 (6hrs)',
                    quantity: 7,
                    unitPrice: 40.00,
                    total: 280.00
                }
            ];

            nextInvoiceLineItemId = 18;

            renderInvoiceLineItems();
            updateInvoiceTotals();

            showToast('Sample invoice imported successfully!', 'success');
        }