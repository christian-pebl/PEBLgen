<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spend</title>
    <!-- Google Fonts - PEBL Brand Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400&display=swap" rel="stylesheet">

    <!-- External Libraries for Gmail & PDF Processing -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        .nav-banner { background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%); padding: 15px 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 30px; margin-bottom: 0; }
        .nav-banner .page-title { color: white; font-size: 28px; font-weight: 700; margin: 0; font-family: 'Roboto', sans-serif; letter-spacing: 0.5px; }
        .nav-banner h1 { color: white; font-size: 28px; font-weight: 700; margin: 0; font-family: 'Roboto', sans-serif; letter-spacing: 0.5px; }
        .nav-buttons { display: flex; gap: 15px; }
        .nav-btn { background-color: rgba(255, 255, 255, 0.2); color: white; border: 2px solid rgba(255, 255, 255, 0.3); padding: 10px 25px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500; text-decoration: none; transition: all 0.3s ease; display: inline-block; font-family: 'Roboto', sans-serif; }
        .nav-btn:hover { background-color: rgba(255, 255, 255, 0.3); border-color: rgba(255, 255, 255, 0.5); transform: translateY(-2px); }
        .nav-btn.active { background-color: white; color: #2B7A78; border-color: white; }
        .content-container { padding: 20px; max-width: 1200px; margin: 0 auto; }

        body {
            font-family: 'Roboto', sans-serif;
            font-weight: 300;
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #DEF2F1 0%, #ffffff 100%);
            min-height: 100vh;
        }

        /* Upload Section */
        .upload-section {
            background-color: #f5f5f5;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px dashed #3AAFA9;
            text-align: center;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .upload-section.drag-over {
            background-color: #e8eaf6;
            border-color: #2B7A78;
            border-width: 3px;
            transform: scale(1.02);
        }
        .upload-section p {
            margin: 10px 0 0 0;
            color: #666;
            font-size: 14px;
        }
        .upload-label {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%);
            color: white;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .upload-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* Table Container */
        .table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        #transactionsTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        #transactionsTable thead {
            background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%);
            color: white;
        }
        #transactionsTable th {
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        #transactionsTable tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: background-color 0.2s ease;
        }
        #transactionsTable tbody tr:hover {
            background-color: #f8f9ff;
        }
        #transactionsTable td {
            padding: 10px;
            vertical-align: middle;
        }
        #transactionsTable td.notes-cell {
            max-width: 200px;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.4;
            font-size: 13px;
            color: #555;
        }
        .empty-state td {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        .description-cell {
            max-width: 300px;
        }
        .original-description {
            color: #999;
            font-size: 12px;
            font-style: italic;
        }
        .manual-description {
            color: #333;
            font-weight: 500;
            margin-bottom: 3px;
        }
        .manual-description::before {
            content: "üìù ";
        }
        .amount-spent {
            color: #d32f2f;
            font-weight: 600;
        }
        .amount-received {
            color: #2e7d32;
            font-weight: 600;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            white-space: nowrap;
        }
        .action-btn {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .action-btn:hover {
            background-color: #3AAFA9;
            border-color: #3AAFA9;
        }
        .action-btn:hover svg {
            stroke: white;
        }
        .action-btn svg {
            display: block;
            stroke: #555;
            transition: stroke 0.2s ease;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover {
            color: #333;
        }
        .modal-body {
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #555;
            margin-bottom: 5px;
        }
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        .form-input:focus {
            outline: none;
            border-color: #3AAFA9;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .modal-btn {
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        .modal-btn-primary {
            background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%);
            color: white;
        }
        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .modal-btn-secondary {
            background-color: #f5f5f5;
            color: #555;
            border: 1px solid #ddd;
        }
        .modal-btn-secondary:hover {
            background-color: #e0e0e0;
        }
        .modal-btn-danger {
            background-color: #dc3545;
            color: white;
            border: none;
        }
        .modal-btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }
        .current-value {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }
        .category-option {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: white;
        }
        .category-option:hover {
            border-color: #3AAFA9;
            background-color: #f8f9ff;
        }
        .category-option.selected {
            border-color: #3AAFA9;
            background-color: #e8eaf6;
        }
        .category-option.keyboard-selected {
            border-color: #f59e0b !important;
            background-color: #fef3c7 !important;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }
        .category-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        tbody tr.row-selected {
            background-color: #dbeafe !important;
            border-left: 4px solid #3b82f6 !important;
        }
        tbody tr:focus {
            outline: none;
        }
        .keyboard-shortcut-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .keyboard-shortcut-hint.visible {
            opacity: 1;
        }
        .category-budget {
            font-size: 12px;
            color: #666;
        }
        .budget-warning {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        .assigned-category {
            display: inline-block;
            background-color: #e8eaf6;
            color: #3AAFA9;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
            vertical-align: top;
            line-height: 1.3;
        }

        /* Voice Recording Styles - Row Action Buttons */
        .action-btn {
            background-color: transparent;
            border: none;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s;
            border-radius: 4px;
        }
        .action-btn:hover {
            transform: scale(1.2);
        }
        .action-btn.edit-btn {
            color: #3AAFA9;
        }
        .action-btn.edit-btn:hover {
            background-color: #DEF2F1;
        }
        .action-btn.mic-btn {
            color: #3AAFA9;
        }
        .action-btn.mic-btn:hover {
            background-color: #DEF2F1;
        }
        .action-btn.mic-btn.recording {
            color: #dc2626;
            animation: pulse 1.5s infinite;
        }
        .action-btn.mic-btn.processing {
            color: #f59e0b;
        }
        .action-btn.delete-btn {
            color: #dc2626;
        }
        .action-btn.delete-btn:hover {
            background-color: #fee2e2;
        }
        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: #17252A;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            max-width: 400px;
            font-family: 'Roboto', sans-serif;
            font-size: 13px;
            line-height: 1.4;
        }
        .toast.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        .toast.positioned {
            animation: fadeIn 0.2s ease;
        }
        .toast.success {
            background-color: #059669;
        }
        .toast.error {
            background-color: #dc2626;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Transcription Modal */
        .transcription-modal {
            display: none;
            position: fixed;
            z-index: 1500;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .transcription-modal.show {
            display: flex;
        }
        .transcription-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        .transcription-content h3 {
            color: #17252A;
            margin-bottom: 15px;
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
        }
        .transcription-content textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid #DEF2F1;
            border-radius: 8px;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            margin-bottom: 20px;
            resize: vertical;
        }
        .transcription-content textarea:focus {
            outline: none;
            border-color: #3AAFA9;
        }
        .transcription-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .transcription-buttons button {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
        }
        .transcription-buttons .cancel-btn {
            background-color: #e2e8f0;
            color: #334155;
        }
        .transcription-buttons .cancel-btn:hover {
            background-color: #cbd5e1;
        }
        .transcription-buttons .process-btn {
            background-color: #3AAFA9;
            color: white;
        }
        .transcription-buttons .process-btn:hover {
            background-color: #2B7A78;
        }

        /* Invoice Search & Gmail Integration Styles */
        .action-btn.invoice-btn {
            color: #3AAFA9;
            position: relative;
        }
        .action-btn.invoice-btn:hover {
            background-color: #DEF2F1;
        }
        .action-btn.invoice-btn.searching {
            color: #f59e0b;
            animation: pulse 1.5s infinite;
        }
        .action-btn.invoice-btn.invoice-attached::after {
            content: "üìé";
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 12px;
        }
        .gmail-account-badge {
            display: inline-block;
            background: #e8f5e9;
            padding: 6px 12px;
            border-radius: 4px;
            margin-right: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            border: 1px solid #4caf50;
        }
        .invoice-result-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #3AAFA9;
        }
        .invoice-result-card:hover {
            background: #f0f0f0;
        }
        .pdf-attachment-btn {
            margin: 5px 5px 0 0;
            font-size: 13px;
            padding: 8px 15px;
        }
    </style>
</head>
<body>
    <!-- Navigation Banner -->
    <div class="nav-banner">
        <h1>PEBLGen</h1>
        <div class="nav-buttons">
            <a href="grants.html" class="nav-btn">Grants</a>
            <a href="spend.html" class="nav-btn active">Spend</a>
            <a href="gantt.html" class="nav-btn">Gantt</a>
            <a href="timesheet.html" class="nav-btn">Timesheet</a>
            <a href="index.html" class="nav-btn">Sketcher</a>
        </div>
    </div>
    
    <div class="content-container">

    <!-- Compact Control Panel -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">

        <!-- API Config Card -->
        <div class="table-container" style="margin: 0;">
            <div style="padding: 15px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <span style="font-size: 20px;">üîë</span>
                    <h4 style="margin: 0; font-size: 14px; font-weight: 600; color: #333;">API Config</h4>
                </div>
                <div id="apiKeyStatus" style="font-size: 12px; color: #666; margin-bottom: 10px; min-height: 18px;">
                    <!-- Populated dynamically -->
                </div>
                <div style="display: flex; gap: 5px;">
                    <button onclick="updateOpenAIKey()" class="modal-btn modal-btn-primary" style="margin: 0; padding: 6px 12px; font-size: 12px; flex: 1;">
                        Set Key
                    </button>
                    <button onclick="clearOpenAIKey()" class="modal-btn modal-btn-secondary" style="margin: 0; padding: 6px 12px; font-size: 12px;">
                        Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Gmail Integration Card -->
        <div class="table-container" style="margin: 0;">
            <div style="padding: 15px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <span style="font-size: 20px;">üìß</span>
                    <h4 style="margin: 0; font-size: 14px; font-weight: 600; color: #333;">Gmail</h4>
                </div>
                <div id="gmailConnectionStatus" style="font-size: 12px; color: #666; margin-bottom: 10px; min-height: 18px;">
                    Not connected
                </div>
                <div id="gmailAccountsList" style="margin-bottom: 10px; max-height: 120px; overflow-y: auto;">
                    <!-- Populated dynamically -->
                </div>
                <button id="gmailConnectBtn" onclick="signInToGmail()" class="modal-btn modal-btn-primary" style="margin: 0; padding: 6px 12px; font-size: 12px; width: 100%;">
                    Connect
                </button>
            </div>
        </div>

        <!-- Project Budgets Card -->
        <div class="table-container" style="margin: 0;">
            <div style="padding: 15px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <span style="font-size: 20px;">üìä</span>
                    <h4 style="margin: 0; font-size: 14px; font-weight: 600; color: #333;">Project Budgets</h4>
                </div>
                <div id="loadedBudgetsInfo" style="font-size: 12px; color: #666; margin-bottom: 10px; min-height: 18px;">
                    Loading...
                </div>
                <button onclick="loadProjectsFromDB()" class="modal-btn modal-btn-primary" style="margin: 0; padding: 6px 12px; font-size: 12px; width: 100%;">
                    Refresh
                </button>
            </div>
        </div>

        <!-- Bank Feed Data Card -->
        <div class="table-container" id="bankFeedDropZone" style="margin: 0; transition: all 0.2s; overflow: visible;">
            <div style="padding: 15px; position: relative;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <span style="font-size: 20px;">üìÅ</span>
                    <h4 style="margin: 0; font-size: 14px; font-weight: 600; color: #333; flex: 1;">Bank Feed</h4>

                    <!-- Table Settings Button -->
                    <button onclick="toggleTableSettings()" id="tableSettingsBtn" style="background: white; border: 1px solid #d1d5db; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 14px; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1);" title="Table Display Settings">
                        ‚öôÔ∏è
                    </button>
                </div>

                <!-- Settings Dropdown Menu -->
                <div id="tableSettingsMenu" style="display: none; position: absolute; top: 50px; right: 15px; background: white; border: 1px solid #d1d5db; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 280px; padding: 12px; z-index: 1000;">
                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px; color: #374151; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px;">Table Display Settings</div>

                    <!-- Spent Section -->
                    <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #f3f4f6;">
                        <div style="font-size: 11px; font-weight: 600; color: #059669; margin-bottom: 4px;">üí≥ Spent (Expenses)</div>

                        <label style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; cursor: pointer; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background=''">
                            <input type="checkbox" id="showSpentColumnToggle" onchange="toggleSpentColumn()" style="cursor: pointer;" checked>
                            <div>
                                <div style="font-size: 12px; font-weight: 500; color: #1f2937;">Show Spent Columns</div>
                                <div style="font-size: 10px; color: #6b7280;">Display spent amount columns</div>
                            </div>
                        </label>
                    </div>

                    <!-- Received Section -->
                    <div>
                        <div style="font-size: 11px; font-weight: 600; color: #3b82f6; margin-bottom: 4px;">üí∞ Received (Income)</div>

                        <label style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; cursor: pointer; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background=''">
                            <input type="checkbox" id="showReceivedColumnToggle" onchange="toggleReceivedColumn()" style="cursor: pointer;" checked>
                            <div>
                                <div style="font-size: 12px; font-weight: 500; color: #1f2937;">Show Received Column</div>
                                <div style="font-size: 10px; color: #6b7280;">Display received amount column</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div id="csvSummaryContent" style="font-size: 12px; color: #666; margin-bottom: 8px; min-height: 18px;">
                    No files loaded ‚Ä¢ Drop CSV files here
                </div>
                <button onclick="openCSVManager()" style="font-size: 11px; padding: 3px 8px; margin-bottom: 8px; background: #3AAFA9; color: white; border: none; border-radius: 3px; cursor: pointer;">
                    Manage Files
                </button>
                <div style="font-size: 11px; color: #888; margin-bottom: 10px; line-height: 1.4;">
                    <div><span id="totalTransactions">0</span> transactions</div>
                    <div>Spent: ¬£<span id="totalSpent">0.00</span> | Received: ¬£<span id="totalReceived">0.00</span></div>
                </div>
                <div style="display: flex; gap: 5px; flex-direction: column;">
                    <div style="display: flex; gap: 5px;">
                        <label for="csvFileInput" class="modal-btn modal-btn-primary" style="margin: 0; padding: 6px 12px; font-size: 12px; flex: 1; cursor: pointer; text-align: center;">
                            Load CSV
                        </label>
                        <button onclick="clearAllTransactions(event)" class="modal-btn modal-btn-secondary" style="margin: 0; padding: 6px 12px; font-size: 12px;">
                            Clear View
                        </button>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="fixDuplicates(event)" class="modal-btn modal-btn-secondary" style="margin: 0; padding: 6px 12px; font-size: 11px; flex: 1; background: #f59e0b; color: white;" title="Remove duplicate transactions from database">
                            üîß Fix Duplicates
                        </button>
                        <button onclick="clearAndRefreshDatabase(event)" class="modal-btn modal-btn-secondary" style="margin: 0; padding: 6px 12px; font-size: 11px; flex: 1; background: #dc2626; color: white;" title="Clear CSV files only (preserves project budgets)">
                            üîÑ Reset CSVs
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Hidden file input -->
    <input type="file" id="csvFileInput" accept=".csv" multiple style="display: none;">

    <!-- Transactions Table -->
    <div class="table-container">
        <table id="transactionsTable">
            <thead>
                <tr>
                    <th>Bank</th>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Spent</th>
                    <th>Spent (ex. VAT)</th>
                    <th>Received</th>
                    <th>From/To</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr class="empty-state">
                    <td colspan="9">No transactions loaded. Please upload a CSV file.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Edit Description Modal -->
    <div class="modal-overlay" id="editDescriptionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Transaction Description</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Transaction Date</label>
                    <div class="current-value" id="modalDate"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Current Description</label>
                    <div class="current-value" id="modalCurrentDescription"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Manual Description / Notes</label>
                    <textarea
                        class="form-input form-textarea"
                        id="modalManualDescription"
                        placeholder="Enter custom description or notes for this expense..."
                    ></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Voice Notes</label>
                    <textarea
                        class="form-input form-textarea"
                        id="modalVoiceNotes"
                        placeholder="Voice notes for this transaction..."
                        style="min-height: 60px;"
                    ></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount</label>
                    <div class="current-value" id="modalAmount"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="saveManualDescription()">Save</button>
            </div>
        </div>
    </div>

    <!-- Assign Budget Category Modal -->
    <div class="modal-overlay" id="assignCategoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Assign to Budget Category</h3>
                <button class="modal-close" onclick="closeAssignModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="assignModalContent"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeAssignModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="saveAssignment()">Assign</button>
            </div>
        </div>
    </div>

    <!-- Transcription Modal -->
    <div id="transcriptionModal" class="transcription-modal">
        <div class="transcription-content">
            <h3>Review Voice Note</h3>
            <p style="color: #64748b; font-size: 14px; margin-bottom: 10px;">Edit the text if needed, then click "Save" to add this note to the transaction:</p>
            <textarea id="transcriptionText" placeholder="Your speech will appear here..."></textarea>
            <div class="transcription-buttons">
                <button class="cancel-btn" onclick="closeTranscriptionModal()">Cancel</button>
                <button class="process-btn" onclick="processTranscription()">Save Note</button>
            </div>
        </div>
    </div>

    <!-- Invoice Search Modal -->
    <div id="invoiceSearchModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 class="modal-title">üìß Invoice Search Results</h3>
                <button class="modal-close" onclick="closeInvoiceSearchModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="invoiceSearchStatus" style="padding: 15px; background: #f5f5f5; border-radius: 6px; margin-bottom: 15px;">
                    <strong>Transaction:</strong> <span id="searchTransactionInfo"></span>
                </div>

                <div id="invoiceSearchResults" style="max-height: 500px; overflow-y: auto;">
                    <!-- Populated dynamically -->
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 6px; border: 1px solid #ffc107;">
                    <strong>üí° Tip:</strong> No results? You can manually upload an invoice PDF using the button below.
                    <input type="file" id="manualInvoiceUpload" accept=".pdf" style="display: none;" onchange="handleManualInvoiceUpload()">
                    <button onclick="document.getElementById('manualInvoiceUpload').click()" class="modal-btn modal-btn-secondary" style="margin-top: 10px; width: 100%;">
                        üìé Upload PDF Manually
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeInvoiceSearchModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- CSV File Manager Modal -->
    <div id="csvManagerModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 style="margin: 0;">üìÅ Manage CSV Files</h3>
                <button class="modal-close-btn" onclick="closeCSVManager()">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="csvFileList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Populated by JavaScript -->
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 12px; color: #856404;">
                    ‚ö†Ô∏è <strong>Note:</strong> Delete old CSV files here and re-upload them to load ALL transactions including spent items.
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-danger" onclick="deleteAllCSVFiles()" style="margin-right: auto;">Delete All</button>
                <button class="modal-btn modal-btn-secondary" onclick="closeCSVManager()">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // ========================================
        // API KEY MANAGEMENT (Secure - Not Exposed)
        // ========================================
        // OpenAI API Key is stored in localStorage, not hardcoded
        let API_KEY = localStorage.getItem('openai_api_key');

        // Function to get or prompt for API key
        function getOpenAIKey() {
            if (!API_KEY || API_KEY === '') {
                API_KEY = prompt('Please enter your OpenAI API Key:\n\n(Get one from: https://platform.openai.com/api-keys)\n\nYour key will be stored locally in your browser.');
                if (API_KEY && API_KEY.trim() !== '') {
                    localStorage.setItem('openai_api_key', API_KEY.trim());
                    showToast('‚úÖ OpenAI API Key saved', 'success');
                    return API_KEY.trim();
                } else {
                    return null;
                }
            }
            return API_KEY;
        }

        // Function to update API key
        function updateOpenAIKey() {
            const newKey = prompt('Enter your new OpenAI API Key:', API_KEY || '');
            if (newKey && newKey.trim() !== '') {
                API_KEY = newKey.trim();
                localStorage.setItem('openai_api_key', API_KEY);
                updateAPIKeyStatus();
                showToast('‚úÖ OpenAI API Key updated', 'success');
            }
        }

        // Function to clear API key
        function clearOpenAIKey() {
            if (confirm('Are you sure you want to remove your stored OpenAI API Key?')) {
                localStorage.removeItem('openai_api_key');
                API_KEY = null;
                updateAPIKeyStatus();
                showToast('‚úÖ OpenAI API Key removed', 'success');
            }
        }

        // Update API key status display
        function updateAPIKeyStatus() {
            const statusDiv = document.getElementById('apiKeyStatus');
            if (API_KEY && API_KEY.length > 0) {
                const maskedKey = API_KEY.substring(0, 7) + '...' + API_KEY.substring(API_KEY.length - 4);
                statusDiv.innerHTML = `<span style="color: #059669;">‚úÖ Key configured (${maskedKey})</span>`;
            } else {
                statusDiv.innerHTML = '<span style="color: #dc2626;">‚ùå No key configured</span>';
            }
        }

        // ========================================
        // GMAIL API CONFIGURATION
        // ========================================
        const GOOGLE_CLIENT_ID = '335938881771-o8q7kbrmk4militaeolsamfcreohn094.apps.googleusercontent.com';
        const GOOGLE_API_KEY = 'AIzaSyAJGE3KTxDhFXKAkXRj1SIDoSnqGOohPSE';
        const GMAIL_SCOPES = 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/userinfo.email';

        // Gmail authentication state
        let tokenClient = null;
        let gmailAccounts = []; // Array of { email, accessToken, selected }
        let gapiInited = false;
        let gisInited = false;

        // Load saved Gmail accounts from localStorage on page load
        function loadGmailAccountsFromStorage() {
            try {
                const stored = localStorage.getItem('gmailAccounts');
                if (stored) {
                    const accounts = JSON.parse(stored);
                    // Restore email and selection state (but not tokens - they need re-auth)
                    gmailAccounts = accounts.map(acc => ({
                        email: acc.email,
                        accessToken: null, // Will need to re-authenticate
                        selected: acc.selected
                    }));
                    console.log(`Restored ${gmailAccounts.length} Gmail account(s) from storage (need re-authentication)`);
                }
            } catch (error) {
                console.error('Error loading Gmail accounts from storage:', error);
            }
        }

        // Save Gmail account emails and selection state to localStorage
        function saveGmailAccountsToStorage() {
            try {
                const accountsToSave = gmailAccounts.map(acc => ({
                    email: acc.email,
                    selected: acc.selected
                    // Don't save accessToken for security
                }));
                localStorage.setItem('gmailAccounts', JSON.stringify(accountsToSave));
                console.log('Saved Gmail accounts to storage');
            } catch (error) {
                console.error('Error saving Gmail accounts to storage:', error);
            }
        }

        // PDF.js configuration
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc =
                'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        let allTransactions = [];
        let currentEditingIndex = null;
        let selectedCategory = null; // Currently selected category for assignment
        let currentAssignments = []; // For split allocations: [{projectId, category, itemKey, itemName, percentage, quarter}]
        let remainingAllocation = 100; // Percentage remaining to allocate

        // Multi-step assignment state
        let assignmentStep = 1; // 1=Project, 2=Category, 3=Item
        let selectedProject = null;
        let selectedCategoryName = null;

        // Keyboard navigation state
        let selectedRowIndex = null;
        let keyboardBuffer = '';
        let keyboardBufferTimeout = null;
        let modalKeyboardIndex = -1;

        // Table display settings
        let showSpentColumn = true; // Show spent column by default
        let showReceivedColumn = true; // Show received column by default

        // Load settings from localStorage
        function loadDisplaySettings() {
            const savedSettings = localStorage.getItem('spendTableSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    showSpentColumn = settings.showSpentColumn ?? true;
                    showReceivedColumn = settings.showReceivedColumn ?? true;
                    console.log('üìã [SETTINGS] Loaded saved settings from localStorage:', settings);
                } catch (e) {
                    console.error('‚ùå [SETTINGS] Failed to load settings:', e);
                }
            } else {
                console.log('üìã [SETTINGS] No saved settings found, using defaults');
            }

            console.log(`üìã [SETTINGS] Active column settings: showSpentColumn=${showSpentColumn}, showReceivedColumn=${showReceivedColumn}`);

            // Sync checkbox states with loaded settings
            syncCheckboxStates();

            applyColumnVisibility();
        }

        // Sync checkbox states with current settings (called on load and when needed)
        function syncCheckboxStates() {
            const spentColToggle = document.getElementById('showSpentColumnToggle');
            const receivedColToggle = document.getElementById('showReceivedColumnToggle');

            if (spentColToggle) spentColToggle.checked = showSpentColumn;
            if (receivedColToggle) receivedColToggle.checked = showReceivedColumn;

            console.log('üîÑ [SETTINGS] Synced checkbox states with settings');
        }

        // Helper function to reset table settings to default (only called from console if needed)
        window.resetTableSettings = function() {
            console.log('üîÑ [SETTINGS] Resetting table settings to default...');
            localStorage.removeItem('spendTableSettings');
            showSpentColumn = true;
            showReceivedColumn = true;
            document.getElementById('showSpentColumnToggle').checked = true;
            document.getElementById('showReceivedColumnToggle').checked = true;
            saveDisplaySettings();
            applyColumnVisibility();
            console.log('‚úÖ [SETTINGS] Reset complete! All columns visible.');
            showToast('‚úÖ Settings reset: all columns visible', 'success');
        }

        // Save settings to localStorage
        function saveDisplaySettings() {
            const settings = {
                showSpentColumn,
                showReceivedColumn
            };
            localStorage.setItem('spendTableSettings', JSON.stringify(settings));
            console.log('üíæ [SETTINGS] Saved display settings:', settings);
        }

        // Apply column visibility based on settings
        function applyColumnVisibility() {
            const headers = document.querySelectorAll('th');
            const spentCells = document.querySelectorAll('.amount-spent');
            const receivedCells = document.querySelectorAll('.amount-received');

            // Find and toggle the "Spent" and "Spent (Ex. VAT)" column headers
            headers.forEach(header => {
                const headerText = header.textContent.trim();
                if (headerText === 'SPENT' || headerText === 'SPENT (EX. VAT)') {
                    header.style.display = showSpentColumn ? '' : 'none';
                } else if (headerText === 'RECEIVED') {
                    header.style.display = showReceivedColumn ? '' : 'none';
                }
            });

            // Toggle all spent column cells
            spentCells.forEach(cell => {
                cell.style.display = showSpentColumn ? '' : 'none';
            });

            // Toggle all received column cells
            receivedCells.forEach(cell => {
                cell.style.display = showReceivedColumn ? '' : 'none';
            });
        }

        // Toggle table settings menu visibility
        function toggleTableSettings() {
            const menu = document.getElementById('tableSettingsMenu');
            const isVisible = menu.style.display !== 'none';

            if (isVisible) {
                menu.style.display = 'none';
            } else {
                // Update checkbox states to match current settings
                document.getElementById('showSpentColumnToggle').checked = showSpentColumn;
                document.getElementById('showReceivedColumnToggle').checked = showReceivedColumn;

                menu.style.display = 'block';
            }
        }

        // Close settings menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('tableSettingsMenu');
            const btn = document.getElementById('tableSettingsBtn');

            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.style.display = 'none';
            }
        });

        // Toggle spent column visibility
        function toggleSpentColumn() {
            showSpentColumn = document.getElementById('showSpentColumnToggle').checked;
            console.log('üîÑ [SETTINGS] Toggle spent column:', showSpentColumn);

            // Get settings button position for toast
            const settingsBtn = document.getElementById('tableSettingsBtn');
            const btnRect = settingsBtn?.getBoundingClientRect();
            const toastPosition = btnRect ? { x: btnRect.right, y: btnRect.top } : null;

            saveDisplaySettings();
            applyColumnVisibility();

            const message = showSpentColumn ?
                '‚úÖ Showing spent column' :
                'üîí Hiding spent column';
            showToast(message, 'success', toastPosition);
        }

        // Toggle received column visibility
        function toggleReceivedColumn() {
            showReceivedColumn = document.getElementById('showReceivedColumnToggle').checked;
            console.log('üîÑ [SETTINGS] Toggle received column:', showReceivedColumn);

            // Get settings button position for toast
            const settingsBtn = document.getElementById('tableSettingsBtn');
            const btnRect = settingsBtn?.getBoundingClientRect();
            const toastPosition = btnRect ? { x: btnRect.right, y: btnRect.top } : null;

            saveDisplaySettings();
            applyColumnVisibility();

            const message = showReceivedColumn ?
                '‚úÖ Showing received column' :
                'üîí Hiding received column';
            showToast(message, 'success', toastPosition);
        }

        // ========================================
        // QUARTER CALCULATION HELPERS
        // ========================================

        /**
         * Calculate which quarter a transaction falls into based on project start date
         * @param {string} transactionDate - Date string from transaction (e.g., "15/03/2024")
         * @param {object} project - Project object with projectStartMonth, projectStartYear, projectDurationMonths
         * @returns {number} Quarter number (1-4) or null if cannot calculate
         */
        function calculateTransactionQuarter(transactionDate, project) {
            console.log('üìÖ [QUARTER CALC] Calculating quarter for transaction:', transactionDate);
            console.log('üìÖ [QUARTER CALC] Project structure:', {
                name: project.projectName,
                hasFinanceSummary: !!project.financeSummary,
                topLevelStartMonth: project.projectStartMonth,
                topLevelStartYear: project.projectStartYear,
                nestedStartMonth: project.financeSummary?.projectStartMonth,
                nestedStartYear: project.financeSummary?.projectStartYear
            });

            // Check for start dates in both locations (for backward compatibility)
            const startMonth = project.projectStartMonth || project.financeSummary?.projectStartMonth;
            const startYear = project.projectStartYear || project.financeSummary?.projectStartYear;

            if (!startMonth || !startYear) {
                console.error(`‚ö†Ô∏è [QUARTER CALC] Project "${project.projectName}" is missing start date!`, {
                    projectName: project.projectName,
                    projectId: project.projectId,
                    startMonth,
                    startYear,
                    hasFinanceSummary: !!project.financeSummary
                });
                console.error(`‚ùå [QUARTER CALC] Solution: Open grants.html ‚Üí Load project "${project.projectName}" ‚Üí Set "Project Start Date" in the Finance Summary section`);

                // Show user-friendly toast notification
                alert(`‚ö†Ô∏è Project Start Date Missing\n\nProject "${project.projectName}" doesn't have a start date set.\n\nTo assign transactions to quarters:\n1. Open grants.html\n2. Load project "${project.projectName}"\n3. Set the "Project Start Date" in the Finance Summary section\n4. Save the project\n5. Return to spend.html and refresh`);

                return null;
            }

            // Parse transaction date (handle DD/MM/YYYY, DD/MM/YY, etc.)
            const dateParts = transactionDate.split('/');
            if (dateParts.length !== 3) {
                console.warn('‚ö†Ô∏è [QUARTER CALC] Invalid date format:', transactionDate);
                return null;
            }

            const transDay = parseInt(dateParts[0]);
            const transMonth = parseInt(dateParts[1]);
            let transYear = parseInt(dateParts[2]);

            // Handle 2-digit years
            if (transYear < 100) {
                transYear += 2000;
            }

            console.log(`üìÖ [QUARTER CALC] Parsed transaction date: ${transDay}/${transMonth}/${transYear}`);

            // Calculate project start date
            const projectStart = new Date(startYear, startMonth - 1, 1);
            const transactionDateObj = new Date(transYear, transMonth - 1, transDay);

            console.log(`üìÖ [QUARTER CALC] Project start: ${projectStart.toISOString()}`);
            console.log(`üìÖ [QUARTER CALC] Transaction: ${transactionDateObj.toISOString()}`);

            // Calculate months since project start
            const monthsSinceStart = (transYear - startYear) * 12 + (transMonth - startMonth);

            console.log(`üìÖ [QUARTER CALC] Months since project start: ${monthsSinceStart}`);

            // Determine quarter (1-4)
            if (monthsSinceStart < 0) {
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                const projectStartDisplay = `${monthNames[startMonth - 1]} ${startYear}`;
                const transactionDisplay = `${transDay}/${transMonth}/${transYear}`;

                console.warn(`‚ö†Ô∏è [QUARTER CALC] Transaction date (${transactionDisplay}) is before project start (${projectStartDisplay})!`);

                alert(`‚ö†Ô∏è Transaction Date Issue\n\nTransaction date: ${transactionDisplay}\nProject "${project.projectName}" starts: ${projectStartDisplay}\n\nThis transaction is ${Math.abs(monthsSinceStart)} month(s) before the project start date.\n\nTo fix this:\n1. Open grants.html\n2. Load project "${project.projectName}"\n3. Adjust the "Project Start Date" in Finance Summary\n4. Save and return to spend.html\n\nOR assign this transaction to a different project.`);

                return null;
            }

            if (monthsSinceStart >= 0 && monthsSinceStart < 3) return 1;
            if (monthsSinceStart >= 3 && monthsSinceStart < 6) return 2;
            if (monthsSinceStart >= 6 && monthsSinceStart < 9) return 3;
            if (monthsSinceStart >= 9 && monthsSinceStart < 12) return 4;

            console.warn('‚ö†Ô∏è [QUARTER CALC] Transaction beyond 12 months, defaulting to Q4');
            return 4; // Default to Q4 if beyond 12 months
        }

        /**
         * Get quarter name for display
         */
        function getQuarterName(quarter) {
            return quarter ? `Q${quarter}` : 'Unknown';
        }

        // Voice recording variables
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        const MAX_RECORDING_TIME = 30000; // 30 seconds
        let recordingTimeout;
        let currentRecordingRowIndex = null; // Track which row is being recorded
        let microphoneStream = null; // Keep stream alive to avoid repeated permission requests

        // IndexedDB variables
        let db;
        const DB_NAME = 'PEBLGrantsBudgets';
        const DB_VERSION = 6; // Updated to match grants.html
        const STORE_NAME = 'projects';
        const CSV_STORE_NAME = 'csvFiles';
        const INVOICES_STORE_NAME = 'invoices';
        let allProjects = [];
        let currentProject = null; // Currently selected project
        let savedCSVFiles = []; // List of saved CSV files

        // Invoice search variables
        let currentInvoiceSearchIndex = null;

        // IndexedDB initialization
        async function initIndexedDB() {
            console.log(`üîÑ [INDEXEDDB] Initializing database: ${DB_NAME}, version: ${DB_VERSION}`);

            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => {
                    console.error('‚ùå [INDEXEDDB] Error opening database:', request.error);
                    reject(request.error);
                };

                request.onsuccess = () => {
                    db = request.result;
                    console.log(`‚úÖ [INDEXEDDB] Database opened successfully (version ${db.version})`);
                    console.log(`üìã [INDEXEDDB] Available object stores:`, Array.from(db.objectStoreNames));
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    console.log(`üîß [INDEXEDDB] Upgrading database from version ${event.oldVersion} to ${event.newVersion}`);
                    db = event.target.result;

                    // Create projects object store if it doesn't exist
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        console.log(`üîß [INDEXEDDB] Creating projects object store: ${STORE_NAME}`);
                        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'projectId', autoIncrement: true });
                        objectStore.createIndex('projectName', 'projectName', { unique: false });
                        objectStore.createIndex('projectNumber', 'projectNumber', { unique: false });
                        objectStore.createIndex('lastModified', 'lastModified', { unique: false });
                        console.log(`‚úÖ [INDEXEDDB] Created projects object store`);
                    } else {
                        console.log(`‚ÑπÔ∏è [INDEXEDDB] Projects object store already exists`);
                    }

                    // Create CSV files object store if it doesn't exist
                    if (!db.objectStoreNames.contains(CSV_STORE_NAME)) {
                        console.log(`üîß [INDEXEDDB] Creating CSV files object store: ${CSV_STORE_NAME}`);
                        const csvStore = db.createObjectStore(CSV_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        csvStore.createIndex('fileName', 'fileName', { unique: false });
                        csvStore.createIndex('uploadDate', 'uploadDate', { unique: false });
                        console.log(`‚úÖ [INDEXEDDB] Created CSV files object store`);
                    } else {
                        console.log(`‚ÑπÔ∏è [INDEXEDDB] CSV files object store already exists`);
                    }

                    // Create invoices object store if it doesn't exist
                    if (!db.objectStoreNames.contains(INVOICES_STORE_NAME)) {
                        console.log(`üîß [INDEXEDDB] Creating invoices object store: ${INVOICES_STORE_NAME}`);
                        const invoiceStore = db.createObjectStore(INVOICES_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        invoiceStore.createIndex('transactionIndex', 'transactionIndex', { unique: false });
                        invoiceStore.createIndex('filename', 'filename', { unique: false });
                        invoiceStore.createIndex('uploadDate', 'uploadDate', { unique: false });
                        invoiceStore.createIndex('messageId', 'gmailMessageId', { unique: false });
                        console.log(`‚úÖ [INDEXEDDB] Created invoices object store`);
                    } else {
                        console.log(`‚ÑπÔ∏è [INDEXEDDB] Invoices object store already exists`);
                    }
                };
            });
        }

        async function loadProjectsFromDB() {
            console.log('üîÑ [BUDGET LOAD] Starting loadProjectsFromDB...');

            if (!db) {
                console.log('üîÑ [BUDGET LOAD] Database not initialized, initializing...');
                await initIndexedDB();
            }

            try {
                console.log('üîÑ [BUDGET LOAD] Opening transaction to projects store...');
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.getAll();

                request.onsuccess = () => {
                    allProjects = request.result || [];
                    console.log('‚úÖ [BUDGET LOAD] Successfully loaded projects from DB');
                    console.log(`üìä [BUDGET LOAD] Number of projects: ${allProjects.length}`);

                    if (allProjects.length > 0) {
                        console.log('üìã [BUDGET LOAD] Project details:');
                        allProjects.forEach((project, index) => {
                            console.log(`   Project ${index + 1}:`, {
                                projectId: project.projectId,
                                projectName: project.projectName,
                                projectNumber: project.projectNumber,
                                fundingBody: project.fundingBody,
                                hasLabour: !!project.labour,
                                hasOverheads: !!project.overheads,
                                hasMaterials: !!project.materials,
                                hasCapitalUsage: !!project.capitalUsage,
                                hasSubcontracting: !!project.subcontracting,
                                hasTravel: !!project.travel,
                                hasOtherCosts: !!project.otherCosts,
                                hasWelshGovData: !!project.welshGovData,
                                hasFinanceSummary: !!project.financeSummary,
                                lastModified: project.lastModified
                            });

                            // Log finance summary details
                            if (project.financeSummary) {
                                console.log(`      Finance Summary (FULL):`, project.financeSummary);
                                console.log(`      Finance Summary (Parsed):`, {
                                    startMonth: project.financeSummary.projectStartMonth,
                                    startYear: project.financeSummary.projectStartYear,
                                    duration: project.financeSummary.projectDurationMonths,
                                    durationString: project.financeSummary.projectDuration,
                                    totalCosts: project.financeSummary.totalCosts
                                });
                            }

                            // Log category details
                            if (project.labour) {
                                console.log(`      Labour: ${project.labour.staff?.length || 0} staff, total ¬£${project.labour.totalCost || 0}`);
                            }
                            if (project.overheads) {
                                console.log(`      Overheads: total ¬£${project.overheads.totalCost || 0}`);
                            }
                            if (project.materials) {
                                console.log(`      Materials: ${project.materials.items?.length || 0} items, total ¬£${project.materials.totalCost || 0}`);
                            }
                            if (project.capitalUsage) {
                                console.log(`      Capital Usage: ${project.capitalUsage.items?.length || 0} items, total ¬£${project.capitalUsage.totalCost || 0}`);
                            }
                            if (project.subcontracting) {
                                console.log(`      Subcontracting: ${project.subcontracting.contractors?.length || 0} contractors, total ¬£${project.subcontracting.totalCost || 0}`);
                            }
                            if (project.travel) {
                                console.log(`      Travel: ${project.travel.trips?.length || 0} trips, total ¬£${project.travel.totalCost || 0}`);
                            }
                            if (project.otherCosts) {
                                console.log(`      Other Costs: ${project.otherCosts.items?.length || 0} items, total ¬£${project.otherCosts.totalCost || 0}`);
                            }

                            // Special logging for Welsh Gov projects
                            if (project.welshGovData) {
                                console.log(`      ‚ö†Ô∏è WELSH GOV DATA DETECTED - This project uses welshGovData structure`);
                                console.log(`      Welsh Gov Sections:`, Object.keys(project.welshGovData.sections || {}));
                            }

                            // If no categories detected, log full project structure for debugging
                            if (!project.labour && !project.materials && !project.capitalUsage &&
                                !project.subcontracting && !project.travel && !project.otherCosts && !project.welshGovData) {
                                console.warn(`      ‚ö†Ô∏è NO CATEGORIES DETECTED - Full project structure:`, project);
                            }
                        });
                    } else {
                        console.log('‚ö†Ô∏è [BUDGET LOAD] No projects found in database');
                    }

                    console.log('üîÑ [BUDGET LOAD] Calling updateBudgetInfo()...');
                    updateBudgetInfo();
                };

                request.onerror = () => {
                    console.error('‚ùå [BUDGET LOAD] Failed to load projects:', request.error);
                    document.getElementById('loadedBudgetsInfo').innerHTML =
                        '‚ùå Failed to load projects from database.';
                };
            } catch (error) {
                console.error('‚ùå [BUDGET LOAD] Error loading projects:', error);
                document.getElementById('loadedBudgetsInfo').innerHTML =
                    '‚ùå Error accessing database.';
            }
        }

        // Auto-load and activate ALL projects (no selection needed)
        let activeProjects = [];

        async function loadSavedCSVFiles() {
            console.log('üìÇ [LOAD CSV FILES] Starting loadSavedCSVFiles...');
            if (!db) {
                await initIndexedDB();
            }

            try {
                const transaction = db.transaction([CSV_STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(CSV_STORE_NAME);
                const request = objectStore.getAll();

                request.onsuccess = () => {
                    savedCSVFiles = request.result || [];
                    console.log('‚úÖ [LOAD CSV FILES] Loaded saved CSV files from IndexedDB:', savedCSVFiles.length, 'files');

                    savedCSVFiles.forEach((file, idx) => {
                        console.log(`üìÑ [LOAD CSV FILES] File ${idx + 1}:`, {
                            id: file.id,
                            fileName: file.fileName,
                            bank: file.bank,
                            transactionCount: file.transactionCount,
                            uploadDate: file.uploadDate,
                            hasTransactions: !!file.transactions,
                            firstTransaction: file.transactions?.[0]
                        });
                    });

                    // Update CSV summary to show saved files
                    updateCSVSummary();

                    // Auto-load all saved CSV files
                    if (savedCSVFiles.length > 0) {
                        console.log('üîÑ [LOAD CSV FILES] Triggering autoLoadSavedCSVs...');
                        autoLoadSavedCSVs();
                    } else {
                        console.log('‚ÑπÔ∏è [LOAD CSV FILES] No saved CSV files found');
                    }
                };

                request.onerror = () => {
                    console.error('‚ùå [LOAD CSV FILES] Failed to load CSV files:', request.error);
                };
            } catch (error) {
                console.error('‚ùå [LOAD CSV FILES] Error loading CSV files:', error);
            }
        }

        // Auto-load all saved CSV files from IndexedDB
        let isAutoLoadingCSVs = false; // Flag to prevent multiple simultaneous loads
        async function autoLoadSavedCSVs() {
            // Prevent multiple simultaneous loads
            if (isAutoLoadingCSVs) {
                console.warn('‚ö†Ô∏è [AUTO-LOAD CSV] Already loading CSVs, skipping duplicate call');
                return;
            }

            isAutoLoadingCSVs = true;
            console.log('üîÑ [AUTO-LOAD CSV] Starting autoLoadSavedCSVs...');
            console.log(`üìÇ [AUTO-LOAD CSV] savedCSVFiles.length: ${savedCSVFiles.length}`);
            console.log(`üìä [AUTO-LOAD CSV] allTransactions.length BEFORE clear: ${allTransactions.length}`);

            // Clear existing transactions before loading (prevent duplicates on multiple calls)
            allTransactions = [];
            console.log(`üßπ [AUTO-LOAD CSV] Cleared allTransactions array`);

            let totalLoaded = 0;

            for (const csvFile of savedCSVFiles) {
                console.log(`üìÑ [AUTO-LOAD CSV] Processing CSV file:`, {
                    fileName: csvFile.fileName,
                    bank: csvFile.bank,
                    transactionCount: csvFile.transactionCount,
                    actualTransactionsLength: csvFile.transactions?.length,
                    uploadDate: csvFile.uploadDate
                });

                // Merge transactions from all saved CSV files
                const transactions = csvFile.transactions || [];
                console.log(`üí≥ [AUTO-LOAD CSV] Actual transactions array length: ${transactions.length}`);
                console.log(`üí≥ [AUTO-LOAD CSV] Stored transactionCount: ${csvFile.transactionCount}`);
                console.log(`‚ö†Ô∏è [AUTO-LOAD CSV] MISMATCH DETECTED: ${transactions.length} vs ${csvFile.transactionCount}` + (transactions.length !== csvFile.transactionCount ? ' ‚ùå' : ' ‚úÖ'));
                console.log(`üí≥ [AUTO-LOAD CSV] First transaction in this file:`, transactions[0]);
                console.log(`üí≥ [AUTO-LOAD CSV] Last transaction in this file:`, transactions[transactions.length - 1]);
                console.log(`üí≥ [AUTO-LOAD CSV] Transaction sample:`, transactions.slice(0, 3));

                allTransactions = allTransactions.concat(transactions);
                totalLoaded += transactions.length;
            }

            console.log(`‚úÖ [AUTO-LOAD CSV] Total loaded: ${totalLoaded} transactions`);
            console.log(`üìä [AUTO-LOAD CSV] allTransactions.length: ${allTransactions.length}`);
            console.log(`üîç [AUTO-LOAD CSV] First 3 transactions in allTransactions:`, allTransactions.slice(0, 3));

            // Log spent vs received breakdown
            const spentCount = allTransactions.filter(t => t.spent && t.spent.trim()).length;
            const receivedCount = allTransactions.filter(t => t.received && t.received.trim()).length;
            console.log(`üí∞ [AUTO-LOAD CSV] Breakdown: ${spentCount} spent, ${receivedCount} received`);

            if (totalLoaded > 0) {
                renderTransactions();
                updateSummary();

                // Show helpful message about what's being displayed
                const displayedCount = document.getElementById('tableBody').querySelectorAll('tr:not(.empty-state)').length;

                console.log(`üìä [AUTO-LOAD CSV] Display: ${displayedCount} visible of ${totalLoaded} loaded`);

                if (spentCount > 0) {
                    showToast(`‚úÖ Loaded ${spentCount} spent transaction${spentCount !== 1 ? 's' : ''} for budget allocation`, 'success');
                } else if (receivedCount > 0) {
                    showToast(`‚ö†Ô∏è Loaded ${receivedCount} received transaction${receivedCount !== 1 ? 's' : ''} (no spent transactions found)`, 'info');
                } else {
                    showToast(`‚úÖ Loaded ${totalLoaded} transaction${totalLoaded !== 1 ? 's' : ''}`, 'success');
                }
            } else {
                console.log('‚ÑπÔ∏è [AUTO-LOAD CSV] No transactions to load');
            }

            isAutoLoadingCSVs = false;
            console.log('‚úÖ [AUTO-LOAD CSV] Auto-load complete, flag reset');
        }

        async function saveCSVFileToDB(fileName, transactions, bankIdentifier) {
            if (!db) {
                await initIndexedDB();
            }

            try {
                // Check if file with same name already exists
                const existing = savedCSVFiles.find(f => f.fileName === fileName);
                if (existing) {
                    console.log('CSV file already saved:', fileName);
                    return existing.id;
                }

                const csvFileData = {
                    fileName: fileName,
                    uploadDate: new Date().toISOString(),
                    transactions: transactions,
                    transactionCount: transactions.length,
                    bank: bankIdentifier
                };

                const transaction = db.transaction([CSV_STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(CSV_STORE_NAME);
                const request = objectStore.add(csvFileData);

                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        console.log('CSV file saved with ID:', request.result);
                        loadSavedCSVFiles(); // Refresh the list
                        resolve(request.result);
                    };

                    request.onerror = () => {
                        console.error('Failed to save CSV file:', request.error);
                        reject(request.error);
                    };
                });
            } catch (error) {
                console.error('Error saving CSV file:', error);
                return null;
            }
        }

        async function loadCSVFromDB(csvId) {
            if (!csvId) {
                // If no CSV selected, clear the transactions
                allTransactions = [];
                renderTransactions();
                updateSummary();
                document.getElementById('loadedFiles').innerHTML = '';
                return;
            }

            if (!db) {
                await initIndexedDB();
            }

            try {
                const transaction = db.transaction([CSV_STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(CSV_STORE_NAME);
                const request = objectStore.get(parseInt(csvId));

                request.onsuccess = () => {
                    if (request.result) {
                        const csvData = request.result;
                        allTransactions = csvData.transactions;
                        renderTransactions();
                        updateSummary();

                        // Update loaded files display
                        const uploadDate = new Date(csvData.uploadDate).toLocaleString();
                        document.getElementById('loadedFiles').innerHTML =
                            `<p style="margin-top: 10px; color: #666;">
                                Currently loaded: <strong>${csvData.fileName}</strong>
                                (${csvData.transactionCount} transactions, uploaded ${uploadDate})
                            </p>`;

                        console.log('Loaded CSV from database:', csvData.fileName);
                    }
                };

                request.onerror = () => {
                    console.error('Failed to load CSV from database:', request.error);
                    alert('Failed to load CSV file from database.');
                };
            } catch (error) {
                console.error('Error loading CSV from database:', error);
            }
        }

        async function deleteCSVFromDB(csvId) {
            if (!db) {
                await initIndexedDB();
            }

            try {
                const transaction = db.transaction([CSV_STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(CSV_STORE_NAME);
                const request = objectStore.delete(parseInt(csvId));

                request.onsuccess = () => {
                    console.log('CSV file deleted:', csvId);
                    loadSavedCSVFiles(); // Refresh the list
                    showToast('‚úÖ CSV file deleted successfully!', 'success');
                };

                request.onerror = () => {
                    console.error('Failed to delete CSV file:', request.error);
                    showToast('‚ùå Failed to delete CSV file', 'error');
                };
            } catch (error) {
                console.error('Error deleting CSV file:', error);
            }
        }

        function openCSVManager() {
            console.log('üìÇ [CSV MANAGER] Opening CSV manager...');
            const modal = document.getElementById('csvManagerModal');
            const listDiv = document.getElementById('csvFileList');

            if (savedCSVFiles.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No CSV files saved</p>';
            } else {
                let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                savedCSVFiles.forEach(file => {
                    const uploadDate = new Date(file.uploadDate).toLocaleString();
                    const bankIcon = file.bank === 'R' ? 'üü£' : file.bank === 'M' ? 'üîµ' : '‚ö™';
                    html += `
                        <div style="display: flex; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 5px; gap: 10px;">
                            <span style="font-size: 20px;">${bankIcon}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 13px;">${file.fileName}</div>
                                <div style="font-size: 11px; color: #666;">
                                    ${file.transactionCount} transactions ‚Ä¢ Uploaded ${uploadDate}
                                </div>
                            </div>
                            <button onclick="deleteCSVFile(${file.id})"
                                    style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                Delete
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
                listDiv.innerHTML = html;
            }

            modal.style.display = 'flex';
        }

        function closeCSVManager() {
            document.getElementById('csvManagerModal').style.display = 'none';
        }

        async function deleteCSVFile(fileId) {
            if (!confirm('Delete this CSV file? You can re-upload it later.')) {
                return;
            }

            console.log(`üóëÔ∏è [CSV MANAGER] Deleting file ID: ${fileId}`);
            await deleteCSVFromDB(fileId);

            // Reload the page data
            allTransactions = [];
            await loadSavedCSVFiles();
            renderTransactions();
            updateSummary();

            // Refresh the manager view
            openCSVManager();
            showToast('‚úÖ CSV file deleted', 'success');
        }

        async function deleteAllCSVFiles() {
            if (!confirm('‚ö†Ô∏è Delete ALL CSV files? This cannot be undone.\n\nYou will need to re-upload your CSV files.')) {
                return;
            }

            console.log('üóëÔ∏è [CSV MANAGER] Deleting all CSV files...');

            if (!db) {
                await initIndexedDB();
            }

            try {
                const transaction = db.transaction([CSV_STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(CSV_STORE_NAME);
                const request = objectStore.clear();

                request.onsuccess = async () => {
                    console.log('‚úÖ [CSV MANAGER] All CSV files deleted');
                    allTransactions = [];
                    savedCSVFiles = [];
                    await loadSavedCSVFiles();
                    renderTransactions();
                    updateSummary();
                    updateCSVSummary();
                    closeCSVManager();
                    showToast('‚úÖ All CSV files deleted', 'success');
                };

                request.onerror = () => {
                    console.error('‚ùå [CSV MANAGER] Failed to delete all files:', request.error);
                    showToast('‚ùå Failed to delete files', 'error');
                };
            } catch (error) {
                console.error('‚ùå [CSV MANAGER] Error:', error);
                showToast('‚ùå Error deleting files', 'error');
            }
        }

        function updateCSVSummary() {
            const contentDiv = document.getElementById('csvSummaryContent');

            // Show saved CSV files from IndexedDB (compact format)
            if (savedCSVFiles.length > 0) {
                const totalTrans = savedCSVFiles.reduce((sum, f) => sum + f.transactionCount, 0);
                contentDiv.innerHTML = `${savedCSVFiles.length} file${savedCSVFiles.length > 1 ? 's' : ''} (${totalTrans} trans.)`;
                return;
            }

            // If no saved files, show current loaded data summary
            if (allTransactions.length === 0) {
                contentDiv.innerHTML = 'No files loaded ‚Ä¢ Drop CSV files here';
                return;
            }

            // Group transactions by bank (compact format)
            const revolutTransactions = allTransactions.filter(t => t.bank === 'R');
            const metroTransactions = allTransactions.filter(t => t.bank === 'M');

            let summary = [];
            if (revolutTransactions.length > 0) summary.push(`R: ${revolutTransactions.length}`);
            if (metroTransactions.length > 0) summary.push(`M: ${metroTransactions.length}`);

            contentDiv.innerHTML = summary.length > 0 ? summary.join(', ') + ' trans.' : `${allTransactions.length} trans.`;
        }

        function clearAllTransactions(event) {
            // Get button position for toast placement
            const buttonRect = event?.target?.getBoundingClientRect();
            const toastPosition = buttonRect ? { x: buttonRect.right, y: buttonRect.top } : null;

            if (confirm('Are you sure you want to clear all loaded transactions? This will not delete saved CSV files from the database.')) {
                allTransactions = [];
                renderTransactions();
                updateSummary();
                updateCSVSummary();
                document.getElementById('loadedFiles').innerHTML = '';
                showToast('‚úÖ All transactions cleared from view', 'success', toastPosition);
            }
        }

        /**
         * Fix duplicate transactions in IndexedDB
         */
        async function fixDuplicates(event) {
            console.log('üîß [FIX DUPLICATES] User clicked Fix DB button');

            // Get button position for toast placement
            const buttonRect = event?.target?.getBoundingClientRect();
            const toastPosition = buttonRect ? { x: buttonRect.right, y: buttonRect.top } : null;

            // Show confirmation dialog
            const confirmed = confirm(
                '‚ö†Ô∏è Fix Database - Remove Duplicate Transactions\n\n' +
                'This will scan all saved CSV files and remove EXACT duplicate transactions.\n\n' +
                'A duplicate is identified when ALL of these match:\n' +
                '  ‚Ä¢ Date\n' +
                '  ‚Ä¢ Description\n' +
                '  ‚Ä¢ Spent amount\n' +
                '  ‚Ä¢ Received amount\n' +
                '  ‚Ä¢ From/To\n\n' +
                'Only exact duplicates will be removed. Your unique transactions will be preserved.\n\n' +
                'Do you want to continue?'
            );

            if (!confirmed) {
                console.log('üîß [FIX DUPLICATES] User cancelled operation');
                return;
            }

            console.log('üîß [FIX DUPLICATES] Starting duplicate fix...');

            if (!db) {
                await initIndexedDB();
            }

            try {
                const transaction = db.transaction([CSV_STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(CSV_STORE_NAME);
                const getAllRequest = objectStore.getAll();

                getAllRequest.onsuccess = async () => {
                    const allCSVFiles = getAllRequest.result || [];
                    console.log(`üìÇ [FIX DUPLICATES] Found ${allCSVFiles.length} CSV files`);

                    let totalBefore = 0;
                    let totalAfter = 0;
                    let totalSpentBefore = 0;
                    let totalReceivedBefore = 0;
                    let totalSpentAfter = 0;
                    let totalReceivedAfter = 0;

                    for (const csvFile of allCSVFiles) {
                        const before = csvFile.transactions?.length || 0;
                        totalBefore += before;

                        console.log(`üìÑ [FIX DUPLICATES] Processing: ${csvFile.fileName} (${before} transactions)`);

                        // Count before deduplication
                        const spentBeforeCount = csvFile.transactions.filter(t => t.spent && t.spent.trim()).length;
                        const receivedBeforeCount = csvFile.transactions.filter(t => t.received && t.received.trim()).length;
                        totalSpentBefore += spentBeforeCount;
                        totalReceivedBefore += receivedBeforeCount;

                        console.log(`   üìä BEFORE: ${spentBeforeCount} spent, ${receivedBeforeCount} received`);
                        console.log(`   üîç Sample transactions BEFORE:`, csvFile.transactions.slice(0, 3));

                        // Deduplicate transactions using date + description + amount as unique key
                        const uniqueTransactions = [];
                        const seen = new Set();
                        let duplicatesRemoved = 0;

                        for (const trans of csvFile.transactions || []) {
                            // Create unique key using ALL important fields to identify EXACT duplicates only
                            const key = `${trans.date}|${trans.description}|${trans.spent}|${trans.received}|${trans.fromTo}`;

                            if (!seen.has(key)) {
                                seen.add(key);
                                uniqueTransactions.push(trans);
                            } else {
                                duplicatesRemoved++;
                                console.log(`   üóëÔ∏è Removing EXACT duplicate:`, {
                                    date: trans.date,
                                    description: trans.description.substring(0, 30) + '...',
                                    spent: trans.spent,
                                    received: trans.received,
                                    fromTo: trans.fromTo,
                                    uniqueKey: key
                                });
                            }
                        }

                        console.log(`   ‚ÑπÔ∏è [FIX DUPLICATES] Deduplication complete for ${csvFile.fileName}`);
                        console.log(`   üìä Unique transactions found: ${uniqueTransactions.length}`);
                        console.log(`   üóëÔ∏è Exact duplicates removed: ${duplicatesRemoved}`);

                        const after = uniqueTransactions.length;
                        totalAfter += after;
                        const removed = before - after;

                        // Log spent vs received breakdown after deduplication
                        const spentCount = uniqueTransactions.filter(t => t.spent && t.spent.trim()).length;
                        const receivedCount = uniqueTransactions.filter(t => t.received && t.received.trim()).length;
                        totalSpentAfter += spentCount;
                        totalReceivedAfter += receivedCount;

                        console.log(`‚úÖ [FIX DUPLICATES] ${csvFile.fileName}: ${before} ‚Üí ${after} (removed ${removed} duplicates)`);
                        console.log(`   üìä BEFORE: ${spentBeforeCount} spent, ${receivedBeforeCount} received`);
                        console.log(`   üìä AFTER:  ${spentCount} spent, ${receivedCount} received`);
                        console.log(`   üîç Sample transactions AFTER:`, uniqueTransactions.slice(0, 3));

                        // Safety check: Verify no data type was completely wiped out
                        if (spentBeforeCount > 0 && spentCount === 0) {
                            console.error(`   ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITICAL WARNING: All ${spentBeforeCount} SPENT transactions were removed! Skipping save for this file.`);
                            continue; // Skip saving this file
                        }
                        if (receivedBeforeCount > 0 && receivedCount === 0) {
                            console.error(`   ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITICAL WARNING: All ${receivedBeforeCount} RECEIVED transactions were removed! Skipping save for this file.`);
                            continue; // Skip saving this file
                        }

                        // Update the CSV file with deduplicated transactions
                        csvFile.transactions = uniqueTransactions;
                        csvFile.transactionCount = after;

                        // Save back to IndexedDB
                        const updateTransaction = db.transaction([CSV_STORE_NAME], 'readwrite');
                        const updateStore = updateTransaction.objectStore(CSV_STORE_NAME);
                        await new Promise((resolve, reject) => {
                            const updateRequest = updateStore.put(csvFile);
                            updateRequest.onsuccess = () => resolve();
                            updateRequest.onerror = () => reject(updateRequest.error);
                        });
                    }

                    console.log(`\nüéâ [FIX DUPLICATES] === SUMMARY ===`);
                    console.log(`üìä [FIX DUPLICATES] Total transactions: ${totalBefore} ‚Üí ${totalAfter} (removed ${totalBefore - totalAfter} exact duplicates)`);
                    console.log(`üí≥ [FIX DUPLICATES] SPENT transactions: ${totalSpentBefore} ‚Üí ${totalSpentAfter} (${totalSpentBefore - totalSpentAfter} removed)`);
                    console.log(`üí∞ [FIX DUPLICATES] RECEIVED transactions: ${totalReceivedBefore} ‚Üí ${totalReceivedAfter} (${totalReceivedBefore - totalReceivedAfter} removed)`);

                    // Verify data integrity
                    const spentLoss = totalSpentBefore > 0 ? ((totalSpentBefore - totalSpentAfter) / totalSpentBefore * 100).toFixed(1) : 0;
                    const receivedLoss = totalReceivedBefore > 0 ? ((totalReceivedBefore - totalReceivedAfter) / totalReceivedBefore * 100).toFixed(1) : 0;

                    console.log(`üìà [FIX DUPLICATES] SPENT loss: ${spentLoss}% | RECEIVED loss: ${receivedLoss}%`);

                    if (totalSpentBefore > 0 && totalSpentAfter === 0) {
                        console.error(`‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è [FIX DUPLICATES] CRITICAL ERROR: ALL SPENT TRANSACTIONS WERE REMOVED! This is likely a bug!`);
                        alert('‚ö†Ô∏è ERROR: All spent transactions were removed during deduplication. The operation was aborted to prevent data loss. Please check the console for details.');
                        return;
                    }

                    if (totalReceivedBefore > 0 && totalReceivedAfter === 0) {
                        console.error(`‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è [FIX DUPLICATES] CRITICAL ERROR: ALL RECEIVED transactions were removed! This is likely a bug!`);
                        alert('‚ö†Ô∏è ERROR: All received transactions were removed during deduplication. The operation was aborted to prevent data loss. Please check the console for details.');
                        return;
                    }

                    const message = `‚úÖ Fixed! Removed ${totalBefore - totalAfter} exact duplicate transactions.\nSpent: ${totalSpentBefore} ‚Üí ${totalSpentAfter} | Received: ${totalReceivedBefore} ‚Üí ${totalReceivedAfter}`;
                    showToast(message, 'success', toastPosition);

                    // Reload the page to show clean data
                    setTimeout(() => location.reload(), 1500);
                };

                getAllRequest.onerror = () => {
                    console.error('‚ùå [FIX DUPLICATES] Failed to load CSV files:', getAllRequest.error);
                    showToast('‚ùå Failed to fix duplicates', 'error', toastPosition);
                };
            } catch (error) {
                console.error('‚ùå [FIX DUPLICATES] Error:', error);
                showToast('‚ùå Error fixing duplicates', 'error', toastPosition);
            }
        }

        /**
         * Clear CSV files and transactions only (preserve project budgets)
         */
        async function clearAndRefreshDatabase(event) {
            console.log('üîÑ [RESET CSV] User clicked Reset DB button');

            // Get button position for toast placement
            const buttonRect = event?.target?.getBoundingClientRect();
            const toastPosition = buttonRect ? { x: buttonRect.right, y: buttonRect.top } : null;

            // Show confirmation dialog
            const confirmed = confirm(
                '‚ö†Ô∏è RESET CSV DATA\n\n' +
                'This will delete:\n' +
                '  ‚Ä¢ All saved CSV files\n' +
                '  ‚Ä¢ All transactions\n' +
                '  ‚Ä¢ All transaction assignments\n\n' +
                '‚úÖ This will PRESERVE:\n' +
                '  ‚Ä¢ Your project budgets\n' +
                '  ‚Ä¢ Your project settings\n' +
                '  ‚Ä¢ Your invoices\n\n' +
                'After reset, you will need to re-upload your CSV files.\n\n' +
                'Continue?'
            );

            if (!confirmed) {
                console.log('üîÑ [RESET CSV] User cancelled operation');
                return;
            }

            console.log('üîÑ [RESET CSV] Starting CSV data reset...');
            showToast('üîÑ Clearing CSV data...', 'info', toastPosition);

            try {
                if (!db) {
                    await initIndexedDB();
                }

                // Clear only the csvFiles object store (preserve projects and invoices)
                const transaction = db.transaction([CSV_STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(CSV_STORE_NAME);
                const clearRequest = objectStore.clear();

                clearRequest.onsuccess = () => {
                    console.log('‚úÖ [RESET CSV] CSV files cleared successfully');

                    // Clear in-memory transaction data
                    allTransactions = [];
                    savedCSVFiles = [];

                    showToast('‚úÖ CSV data cleared! Reloading...', 'success', toastPosition);

                    // Reload the page after a short delay
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                };

                clearRequest.onerror = (event) => {
                    console.error('‚ùå [RESET CSV] Failed to clear CSV files:', event);
                    showToast('‚ùå Failed to clear CSV data', 'error', toastPosition);
                };

            } catch (error) {
                console.error('‚ùå [RESET CSV] Error:', error);
                showToast('‚ùå Error clearing CSV data', 'error', toastPosition);
            }
        }

        // Initialize on page load
        let isPageInitialized = false;
        document.addEventListener('DOMContentLoaded', async () => {
            if (isPageInitialized) {
                console.warn('‚ö†Ô∏è [PAGE LOAD] Page already initialized, skipping duplicate initialization');
                return;
            }

            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üöÄ [PAGE LOAD] DOMContentLoaded event fired');
            console.log('üìÖ [PAGE LOAD] Timestamp:', new Date().toISOString());
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            try {
                console.log('‚öôÔ∏è [PAGE LOAD] Step 1/6: Loading display settings...');
                loadDisplaySettings();

                console.log('üíæ [PAGE LOAD] Step 2/6: Initializing IndexedDB...');
                await initIndexedDB();

                console.log('üìä [PAGE LOAD] Step 3/6: Loading projects from DB...');
                await loadProjectsFromDB();

                console.log('üìÇ [PAGE LOAD] Step 4/6: Loading saved CSV files...');
                await loadSavedCSVFiles();

                console.log('üîë [PAGE LOAD] Step 5/6: Updating API key status...');
                updateAPIKeyStatus(); // Update API key status display

                console.log('üìß [PAGE LOAD] Step 6/6: Loading Gmail accounts...');
                loadGmailAccountsFromStorage(); // Restore saved Gmail accounts
                updateGmailStatus(); // Update UI to show restored accounts

                // Final summary
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('‚úÖ [PAGE LOAD] Page initialization complete!');
                console.log('üìä [PAGE LOAD] Summary:');
                console.log(`   - CSV Files: ${savedCSVFiles.length}`);
                console.log(`   - Total Transactions: ${allTransactions.length}`);
                console.log(`   - Projects Loaded: ${allProjects.length}`);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                isPageInitialized = true;
            } catch (error) {
                console.error('‚ùå [PAGE LOAD] Initialization failed:', error);
                showToast('‚ùå Failed to initialize page. Please refresh.', 'error');
            }
        });

        // Drag and drop removed - using compact file input button in Bank Feed card

        // File upload handler
        document.getElementById('csvFileInput').addEventListener('change', async function(e) {
            const files = e.target.files;
            if (files.length === 0) return;

            for (let file of files) {
                await loadAndSaveCSVFile(file);
            }

            renderTransactions();
            updateSummary();
            updateCSVSummary();
            // Reset file input to allow reloading same file
            e.target.value = '';
        });

        // ========================================
        // DRAG AND DROP FOR CSV FILES
        // ========================================

        const dropZone = document.getElementById('bankFeedDropZone');

        // Prevent default drag behaviors on the entire page
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Highlight drop zone when dragging over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, function() {
                dropZone.style.background = 'linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%)';
                dropZone.style.border = '2px dashed #3AAFA9';
                dropZone.style.transform = 'scale(1.02)';
            }, false);
        });

        // Remove highlight when leaving drop zone
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, function() {
                dropZone.style.background = '';
                dropZone.style.border = '';
                dropZone.style.transform = '';
            }, false);
        });

        // Handle dropped files
        dropZone.addEventListener('drop', async function(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length === 0) return;

            // Filter for CSV files only
            const csvFiles = Array.from(files).filter(file =>
                file.name.toLowerCase().endsWith('.csv')
            );

            if (csvFiles.length === 0) {
                showToast('‚ö†Ô∏è Please drop CSV files only', 'error');
                return;
            }

            // Process each CSV file
            for (let file of csvFiles) {
                await loadAndSaveCSVFile(file);
            }

            renderTransactions();
            updateSummary();
            updateCSVSummary();

            showToast(`‚úÖ Loaded ${csvFiles.length} CSV file(s)`, 'success');
        }, false);

        function updateBudgetInfo() {
            console.log('üîÑ [BUDGET INFO] Starting updateBudgetInfo...');
            const infoDiv = document.getElementById('loadedBudgetsInfo');

            console.log(`üìä [BUDGET INFO] allProjects.length: ${allProjects.length}`);

            if (allProjects.length === 0) {
                console.log('‚ö†Ô∏è [BUDGET INFO] No projects to display');
                infoDiv.innerHTML = 'No budgets found';
                return;
            }

            // Automatically activate ALL projects
            activeProjects = allProjects;
            console.log(`‚úÖ [BUDGET INFO] Activated ${activeProjects.length} projects`);

            // Build compact summary
            let totalBudget = 0;
            console.log('üí∞ [BUDGET INFO] Calculating total budget...');

            allProjects.forEach((project, index) => {
                const labour = project.labour?.totalCost || 0;
                const overheads = project.overheads?.totalCost || 0;
                const materials = project.materials?.totalCost || 0;
                const capital = project.capitalUsage?.totalCost || 0;
                const subcontracting = project.subcontracting?.totalCost || 0;
                const travel = project.travel?.totalCost || 0;
                const other = project.otherCosts?.totalCost || 0;

                const projectTotal = labour + overheads + materials + capital + subcontracting + travel + other;

                console.log(`   Project ${index + 1} (${project.projectName || 'Unnamed'}):`, {
                    labour: `¬£${labour}`,
                    overheads: `¬£${overheads}`,
                    materials: `¬£${materials}`,
                    capital: `¬£${capital}`,
                    subcontracting: `¬£${subcontracting}`,
                    travel: `¬£${travel}`,
                    other: `¬£${other}`,
                    projectTotal: `¬£${projectTotal}`
                });

                totalBudget += projectTotal;
            });

            console.log(`üí∞ [BUDGET INFO] Total budget across all projects: ¬£${totalBudget.toLocaleString()}`);

            const displayText = `${allProjects.length} project${allProjects.length > 1 ? 's' : ''} (¬£${totalBudget.toLocaleString()})`;
            console.log(`‚úÖ [BUDGET INFO] Setting display text: "${displayText}"`);
            infoDiv.innerHTML = displayText;

            console.log('‚úÖ [BUDGET INFO] updateBudgetInfo complete');
        }


        async function loadCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const transactions = parseCSV(content);
                    allTransactions.push(...transactions);
                    resolve();
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        async function loadAndSaveCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const content = e.target.result;

                    // Detect bank from filename
                    const bankIdentifier = detectBank(file.name);

                    const transactions = parseCSV(content, bankIdentifier);

                    // APPEND transactions instead of replacing
                    allTransactions.push(...transactions);

                    // Save to IndexedDB
                    await saveCSVFileToDB(file.name, transactions, bankIdentifier);

                    resolve();
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function detectBank(fileName) {
            const nameLower = fileName.toLowerCase();
            if (nameLower.includes('revolut')) {
                return 'R';
            } else if (nameLower.includes('metro')) {
                return 'M';
            }
            return '?'; // Unknown bank
        }

        function parseCSV(csvText, bankIdentifier = '?') {
            console.log('üìù [PARSE CSV] Starting CSV parsing...');
            console.log(`üìè [PARSE CSV] CSV text length: ${csvText.length} characters`);
            console.log(`üè¶ [PARSE CSV] Bank identifier: "${bankIdentifier}"`);

            const lines = csvText.split('\n');
            console.log(`üìÑ [PARSE CSV] Total lines: ${lines.length}`);
            console.log(`üìÑ [PARSE CSV] Header line: "${lines[0]}"`);

            const transactions = [];

            // Parse header row to identify column indices
            const headerLine = lines[0].trim();
            const headerFields = parseCSVLine(headerLine);
            console.log(`üìã [PARSE CSV] Header fields:`, headerFields);

            // Detect column indices based on header names
            const columnMap = {
                date: -1,
                description: -1,
                spent: -1,
                received: -1,
                fromTo: -1,
                transactionPosted: -1
            };

            headerFields.forEach((header, index) => {
                const lowerHeader = header.toLowerCase().trim();

                // Date column
                if (lowerHeader.includes('date') && columnMap.date === -1) {
                    columnMap.date = index;
                }
                // Description column
                else if ((lowerHeader.includes('description') || lowerHeader.includes('details') ||
                         lowerHeader.includes('narrative')) && columnMap.description === -1) {
                    columnMap.description = index;
                }
                // Spent/Debit/Money Out column
                else if ((lowerHeader.includes('spent') || lowerHeader.includes('debit') ||
                         lowerHeader.includes('money out') || lowerHeader.includes('paid out') ||
                         lowerHeader.includes('withdrawal')) && columnMap.spent === -1) {
                    columnMap.spent = index;
                }
                // Received/Credit/Money In column
                else if ((lowerHeader.includes('received') || lowerHeader.includes('credit') ||
                         lowerHeader.includes('money in') || lowerHeader.includes('paid in') ||
                         lowerHeader.includes('deposit')) && columnMap.received === -1) {
                    columnMap.received = index;
                }
                // From/To column
                else if ((lowerHeader.includes('from') || lowerHeader.includes('to') ||
                         lowerHeader.includes('payee')) && columnMap.fromTo === -1) {
                    columnMap.fromTo = index;
                }
                // Transaction Posted column
                else if (lowerHeader.includes('posted') && columnMap.transactionPosted === -1) {
                    columnMap.transactionPosted = index;
                }
            });

            console.log(`üó∫Ô∏è [PARSE CSV] Column mapping:`, columnMap);
            console.log(`   üìÖ Date: column ${columnMap.date}`);
            console.log(`   üìù Description: column ${columnMap.description}`);
            console.log(`   üí∏ Spent: column ${columnMap.spent}`);
            console.log(`   üí∞ Received: column ${columnMap.received}`);
            console.log(`   üë§ From/To: column ${columnMap.fromTo}`);

            // If column detection failed, fall back to default indices
            if (columnMap.date === -1) columnMap.date = 0;
            if (columnMap.description === -1) columnMap.description = 1;
            if (columnMap.spent === -1) columnMap.spent = 2;
            if (columnMap.received === -1) columnMap.received = 3;
            if (columnMap.fromTo === -1) columnMap.fromTo = 4;
            if (columnMap.transactionPosted === -1) columnMap.transactionPosted = 5;

            for (let i = 1; i < lines.length; i++) { // Skip header row
                const line = lines[i].trim();
                if (!line) continue;

                const fields = parseCSVLine(line);

                if (fields.length >= 4) {
                    const transaction = {
                        bank: bankIdentifier,
                        date: fields[columnMap.date] || '',
                        description: fields[columnMap.description] || '',
                        spent: fields[columnMap.spent] || '',
                        received: fields[columnMap.received] || '',
                        fromTo: fields[columnMap.fromTo] || '',
                        transactionPosted: fields[columnMap.transactionPosted] || ''
                    };
                    transactions.push(transaction);

                    // Log first 3 transactions for debugging
                    if (i <= 3) {
                        console.log(`üí≥ [PARSE CSV] Transaction ${i}:`, transaction);
                    }
                }
            }

            console.log(`‚úÖ [PARSE CSV] Parsed ${transactions.length} transactions`);

            // Log spent vs received breakdown
            const spentCount = transactions.filter(t => t.spent && t.spent.trim()).length;
            const receivedCount = transactions.filter(t => t.received && t.received.trim()).length;
            console.log(`üí∞ [PARSE CSV] Breakdown: ${spentCount} spent, ${receivedCount} received`);

            // Log first few spent and received transactions for verification
            const sampleSpent = transactions.filter(t => t.spent && t.spent.trim()).slice(0, 3);
            const sampleReceived = transactions.filter(t => t.received && t.received.trim()).slice(0, 3);
            if (sampleSpent.length > 0) {
                console.log(`üì§ [PARSE CSV] Sample SPENT transactions:`, sampleSpent);
            }
            if (sampleReceived.length > 0) {
                console.log(`üì• [PARSE CSV] Sample RECEIVED transactions:`, sampleReceived);
            }

            return transactions;
        }

        // Helper function to parse a single CSV line (handles quoted fields)
        function parseCSVLine(line) {
            const fields = [];
            let currentField = '';
            let inQuotes = false;

            for (let j = 0; j < line.length; j++) {
                const char = line[j];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    fields.push(currentField);
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            fields.push(currentField); // Add last field

            return fields;
        }

        function renderTransactions() {
            console.log('üé® [RENDER] Starting renderTransactions...');
            console.log(`üìä [RENDER] allTransactions.length: ${allTransactions.length}`);
            if (allTransactions.length > 0) {
                console.log(`üîç [RENDER] First transaction:`, allTransactions[0]);
                console.log(`üîç [RENDER] Transaction keys:`, Object.keys(allTransactions[0]));
                console.log(`üîç [RENDER] Sample transactions:`, allTransactions.slice(0, 3));
            }

            const tbody = document.getElementById('tableBody');

            if (allTransactions.length === 0) {
                console.log('‚ö†Ô∏è [RENDER] No transactions to render');
                tbody.innerHTML = '<tr class="empty-state"><td colspan="9">No transactions loaded. Please upload a CSV file.</td></tr>';
                return;
            }

            // Display all transactions (no filtering)
            console.log(`‚úÖ [RENDER] Rendering ${allTransactions.length} transactions...`);
            tbody.innerHTML = allTransactions.map((transaction, index) => {
                const descriptionHtml = transaction.manualDescription ?
                    `<div class="manual-description">${escapeHtml(transaction.manualDescription)}</div>
                     <div class="original-description">${escapeHtml(transaction.description)}</div>` :
                    escapeHtml(transaction.description);

                // Handle both old single assignment format and new split assignments array
                let categoryBadges = '';
                if (transaction.assignments && transaction.assignments.length > 0) {
                    // New format: array of assignments
                    categoryBadges = transaction.assignments.map(assignment => {
                        const percentage = assignment.percentage === 100 ? '' : ` (${assignment.percentage}%)`;
                        const quarter = assignment.quarter ? ` ${getQuarterName(assignment.quarter)}` : '';
                        const icon = assignment.icon ? `${assignment.icon} ` : '';
                        const isGeneral = assignment.projectId === 'GENERAL_EXPENSES';
                        const badgeStyle = isGeneral ? 'background-color: #fef3c7; border: 1px solid #fbbf24;' : '';
                        return `<span class="assigned-category" title="${escapeHtml(assignment.category)} - ${escapeHtml(assignment.projectName || 'Project')}${quarter}" style="position: relative; padding-right: 24px; ${badgeStyle}">
                            <div style="font-weight: 600; font-size: 11px;">${icon}${escapeHtml(assignment.itemName)}${percentage}</div>
                            <div style="font-size: 9px; opacity: 0.65; margin-top: 1px; line-height: 1.2;">${escapeHtml(assignment.category)} ‚Ä¢ ${escapeHtml(assignment.projectName || 'Project')}</div>
                            <button onclick="handleUnassign(${index}); event.stopPropagation();"
                                    style="position: absolute; top: 2px; right: 2px; background: rgba(220, 38, 38, 0.1); border: none; border-radius: 3px; width: 18px; height: 18px; cursor: pointer; font-size: 12px; line-height: 1; padding: 0; color: #dc2626; transition: all 0.2s;"
                                    onmouseover="this.style.background='rgba(220, 38, 38, 0.2)'; this.style.transform='scale(1.1)';"
                                    onmouseout="this.style.background='rgba(220, 38, 38, 0.1)'; this.style.transform='scale(1)';"
                                    title="Remove assignment">√ó</button>
                        </span>`;
                    }).join(' ');
                } else if (transaction.assignedItemName) {
                    // Old format: single assignment (backward compatibility)
                    const isGeneral = transaction.assignedProject === 'GENERAL_EXPENSES';
                    const badgeStyle = isGeneral ? 'background-color: #fef3c7; border: 1px solid #fbbf24;' : '';
                    categoryBadges = `<span class="assigned-category" title="${escapeHtml(transaction.assignedCategory)}" style="position: relative; padding-right: 24px; ${badgeStyle}">
                        <div style="font-weight: 600; font-size: 11px;">${escapeHtml(transaction.assignedItemName)}</div>
                        <div style="font-size: 9px; opacity: 0.65; margin-top: 1px; line-height: 1.2;">${escapeHtml(transaction.assignedCategory)}</div>
                        <button onclick="handleUnassign(${index}); event.stopPropagation();"
                                style="position: absolute; top: 2px; right: 2px; background: rgba(220, 38, 38, 0.1); border: none; border-radius: 3px; width: 18px; height: 18px; cursor: pointer; font-size: 12px; line-height: 1; padding: 0; color: #dc2626; transition: all 0.2s;"
                                onmouseover="this.style.background='rgba(220, 38, 38, 0.2)'; this.style.transform='scale(1.1)';"
                                onmouseout="this.style.background='rgba(220, 38, 38, 0.1)'; this.style.transform='scale(1)';"
                                title="Remove assignment">√ó</button>
                    </span>`;
                }

                // Notes column - show voice notes if available
                const notesContent = transaction.voiceNotes ? escapeHtml(transaction.voiceNotes) : '';

                // Determine assign button appearance
                const hasAssignments = (transaction.assignments && transaction.assignments.length > 0) || transaction.assignedItemName;
                const assignBtnTitle = hasAssignments ? 'Reassign / Add Split' : 'Assign to Budget';
                const assignBtnIcon = hasAssignments ? '‚û°Ô∏è' : '‚û°Ô∏è';

                // Calculate VAT-exclusive amount (divide by 1.2 for UK 20% VAT)
                const spentAmount = parseAmount(transaction.spent);
                const spentExVAT = spentAmount > 0 ? (spentAmount / 1.2).toFixed(2) : '';

                return `
                <tr class="${selectedRowIndex === index ? 'row-selected' : ''}" onclick="selectRow(${index}, event)" data-row-index="${index}" tabindex="0">
                    <td style="text-align: center; font-weight: 600; color: ${transaction.bank === 'R' ? '#3AAFA9' : '#2B7A78'};">${transaction.bank || '?'}</td>
                    <td>${escapeHtml(transaction.date)}</td>
                    <td class="description-cell">${descriptionHtml}${categoryBadges}</td>
                    <td class="amount-spent">${escapeHtml(transaction.spent)}</td>
                    <td class="amount-spent" style="color: #059669; font-weight: 500;">${spentExVAT}</td>
                    <td class="amount-received">${escapeHtml(transaction.received)}</td>
                    <td>${escapeHtml(transaction.fromTo)}</td>
                    <td class="notes-cell">${notesContent}</td>
                    <td class="action-buttons">
                        <button class="action-btn edit-btn" onclick="handleManualEdit(${index}); event.stopPropagation();" title="Edit">‚úèÔ∏è</button>
                        <button class="action-btn mic-btn" id="micBtn${index}" onclick="toggleRowVoiceRecording(${index}); event.stopPropagation();" title="Voice Note">üé§</button>
                        <button class="action-btn invoice-btn" id="invoiceBtn${index}" onclick="handleInvoiceFetch(${index}); event.stopPropagation();" title="Find Invoice">üìß</button>
                        <button class="action-btn delete-btn ${hasAssignments ? 'has-assignment' : ''}" onclick="handleAssign(${index}); event.stopPropagation();" oncontextmenu="handleUnassign(${index}); return false;" title="${assignBtnTitle}" id="assignBtn${index}">
                            ${assignBtnIcon}
                        </button>
                    </td>
                </tr>
            `;
            }).join('');

            // Apply column visibility after rendering
            applyColumnVisibility();
        }

        function updateSummary() {
            document.getElementById('totalTransactions').textContent = allTransactions.length;

            let totalSpent = 0;
            let totalReceived = 0;

            allTransactions.forEach(t => {
                const spent = parseAmount(t.spent);
                const received = parseAmount(t.received);
                totalSpent += spent;
                totalReceived += received;
            });

            document.getElementById('totalSpent').textContent = totalSpent.toFixed(2);
            document.getElementById('totalReceived').textContent = totalReceived.toFixed(2);
        }

        function parseAmount(amountStr) {
            if (!amountStr) return 0;
            // Remove currency symbols and commas
            const cleaned = amountStr.replace(/[¬£$,]/g, '');
            return parseFloat(cleaned) || 0;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Action button handlers
        function handleManualEdit(index) {
            const transaction = allTransactions[index];
            currentEditingIndex = index;

            // Populate modal with transaction data
            document.getElementById('modalDate').textContent = transaction.date;
            document.getElementById('modalCurrentDescription').textContent = transaction.description;
            document.getElementById('modalManualDescription').value = transaction.manualDescription || '';
            document.getElementById('modalVoiceNotes').value = transaction.voiceNotes || '';

            // Display amount (either spent or received)
            const amount = transaction.spent ?
                `Spent: ¬£${transaction.spent}` :
                `Received: ¬£${transaction.received}`;
            document.getElementById('modalAmount').textContent = amount;

            // Show modal
            document.getElementById('editDescriptionModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editDescriptionModal').classList.remove('active');
            currentEditingIndex = null;
            document.getElementById('modalManualDescription').value = '';
            document.getElementById('modalVoiceNotes').value = '';
        }

        function saveManualDescription() {
            if (currentEditingIndex === null) return;

            const manualDescription = document.getElementById('modalManualDescription').value.trim();
            const voiceNotes = document.getElementById('modalVoiceNotes').value.trim();

            // Save both manual description and voice notes to the transaction
            allTransactions[currentEditingIndex].manualDescription = manualDescription;
            allTransactions[currentEditingIndex].voiceNotes = voiceNotes;

            // Re-render the table to show changes
            renderTransactions();

            // Close modal
            closeEditModal();

            // Show success feedback
            showToast('‚úÖ Transaction updated successfully!', 'success');
        }

        // Close modal when clicking outside
        document.getElementById('editDescriptionModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        function handleApplyRule(index) {
            const transaction = allTransactions[index];
            alert(`Apply Rule: ${transaction.description}\n\nThis feature will allow you to apply automated categorization rules.`);
        }

        /**
         * Calculate total claimed costs for a category (sum of all quarterly costs)
         */
        function getCategoryClaimed(category) {
            let total = 0;
            const items = category.items || category.staff || category.contractors || category.trips || [];

            items.forEach(item => {
                if (item.quarterlyCosts) {
                    total += (item.quarterlyCosts.q1 || 0) + (item.quarterlyCosts.q2 || 0) +
                             (item.quarterlyCosts.q3 || 0) + (item.quarterlyCosts.q4 || 0);
                }
            });

            return total;
        }

        /**
         * Calculate claimed costs for a specific item
         */
        function getItemClaimed(item) {
            if (!item.quarterlyCosts) return 0;
            return (item.quarterlyCosts.q1 || 0) + (item.quarterlyCosts.q2 || 0) +
                   (item.quarterlyCosts.q3 || 0) + (item.quarterlyCosts.q4 || 0);
        }

        /**
         * STEP 1: Show project selection
         */
        function showProjectSelection() {
            console.log('üìã [MODAL DEBUG] showProjectSelection called');
            console.log('üìã [MODAL DEBUG] currentEditingIndex:', currentEditingIndex);
            console.log('üìã [MODAL DEBUG] allTransactions.length:', allTransactions.length);

            assignmentStep = 1;
            selectedProject = null;
            selectedCategoryName = null;
            selectedCategory = null;

            const transaction = allTransactions[currentEditingIndex];
            console.log('üìã [MODAL DEBUG] Transaction:', transaction);

            let content = `
                <div style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 11px; color: #666;">Transaction</div>
                        <div style="font-size: 12px; font-weight: 600;">${escapeHtml(transaction.description)}</div>
                        <div style="font-size: 10px; color: #888;">${transaction.date} ‚Ä¢ ¬£${transaction.spent || transaction.received}</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.75); color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px;">
                        ‚å®Ô∏è Press 1-9 to select ‚Ä¢ ‚Üë‚Üì Navigate ‚Ä¢ ‚Üê Back ‚Ä¢ Enter to confirm
                    </div>
                </div>
                <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #333;">Step 1: Select Project</div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;

            // Add PEBL General Expenses option
            content += `
                <div class="category-option" onclick="selectGeneralExpenses()" style="cursor: pointer; padding: 8px 12px; margin-bottom: 4px; border: 2px solid #f59e0b; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 4px; transition: all 0.2s; display: flex; align-items: center; gap: 10px;">
                    <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: #f59e0b; color: white; border-radius: 4px; font-weight: 700; font-size: 13px;">1</span>
                    <span style="font-size: 16px;">üè¢</span>
                    <div style="flex: 1;">
                        <span style="font-size: 12px; font-weight: 600; color: #92400e;">PEBL General Expenses</span>
                        <span style="font-size: 10px; color: #78350f; margin-left: 8px;">Non-project business expenses</span>
                    </div>
                </div>
                <div style="border-bottom: 1px solid #e5e7eb; margin: 8px 0; padding-bottom: 4px;">
                    <div style="font-size: 10px; color: #6b7280; font-weight: 600;">PROJECT BUDGETS</div>
                </div>
            `;

            activeProjects.forEach((project, idx) => {
                const projectName = project.projectName || project.projectNumber || `Project #${project.projectId}`;
                const number = idx + 2; // Start from 2 (1 is PEBL General)

                content += `
                    <div class="category-option" onclick="selectProjectStep('${project.projectId}')" style="cursor: pointer; padding: 8px 12px; margin-bottom: 4px; border: 1px solid #e0e0e0; border-radius: 4px; transition: all 0.2s; display: flex; align-items: center; gap: 10px;">
                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 4px; font-weight: 700; font-size: 13px;">${number}</span>
                        <span>üìÅ</span>
                        <span style="font-size: 12px; font-weight: 600; color: #333;">${escapeHtml(projectName)}</span>
                        <span style="font-size: 10px; color: #999; margin-left: auto;">ID: ${project.projectId}</span>
                    </div>
                `;
            });

            content += '</div>';
            document.getElementById('assignModalContent').innerHTML = content;

            console.log('üìã [MODAL DEBUG] Modal content HTML set, length:', content.length);

            // Add numbers to options after rendering
            addNumbersToOptions();

            console.log('‚úÖ [MODAL DEBUG] showProjectSelection completed successfully');
        }

        /**
         * Add number badges to all category options
         */
        function addNumbersToOptions() {
            const options = document.querySelectorAll('.category-option');
            options.forEach((option, idx) => {
                // Skip if already has a number badge
                if (option.querySelector('[data-number-badge]')) return;

                const number = idx + 1;
                if (number > 9) return; // Only show numbers 1-9

                // Create number badge
                const badge = document.createElement('span');
                badge.setAttribute('data-number-badge', 'true');
                badge.style.cssText = 'display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 4px; font-weight: 700; font-size: 13px; flex-shrink: 0;';
                badge.textContent = number;

                // Insert at the beginning
                option.insertBefore(badge, option.firstChild);
            });
        }

        /**
         * Handle PEBL General Expenses selection - assigns directly
         */
        async function selectGeneralExpenses() {
            if (currentEditingIndex === null) return;

            const transaction = allTransactions[currentEditingIndex];
            const transAmount = parseAmount(transaction.spent || transaction.received);

            // Initialize assignments array if needed
            if (!transaction.assignments) {
                transaction.assignments = [];
            }

            // Create new assignment object
            const newAssignment = {
                projectId: 'GENERAL_EXPENSES',
                projectName: 'PEBL General Expenses',
                category: 'PEBL General Expenses',
                itemKey: 'general-expense',
                itemName: 'PEBL General Expenses',
                icon: 'üè¢',
                quarter: null,
                percentage: 100,
                amount: transAmount,
                assignedDate: new Date().toISOString()
            };

            // Add to assignments array
            transaction.assignments.push(newAssignment);

            console.log('‚úÖ [ASSIGN] General expense assignment created:', newAssignment);

            // Keep old format for backward compatibility
            transaction.assignedCategory = 'PEBL General Expenses';
            transaction.assignedItem = 'general-expense';
            transaction.assignedItemName = 'PEBL General Expenses';
            transaction.assignedProject = 'GENERAL_EXPENSES';

            // Re-render the table
            renderTransactions();

            // Save to storage
            await saveTransactionsToStorage();

            // Close modal
            closeAssignModal();

            // Show success message
            showToast(`‚úÖ Assigned to PEBL General Expenses - Saved to local storage`, 'success');

            // Auto-advance to next row
            advanceToNextRow();
        }

        /**
         * STEP 2: Show category selection for chosen project
         */
        function showCategorySelection() {
            assignmentStep = 2;

            const project = activeProjects.find(p => p.projectId == selectedProject);
            if (!project) return;

            const projectName = project.projectName || project.projectNumber || `Project #${project.projectId}`;

            let content = `
                <div style="margin-bottom: 15px;">
                    <button onclick="showProjectSelection()" style="background: none; border: none; color: #3AAFA9; cursor: pointer; font-size: 12px; padding: 0;">
                        ‚Üê Back to Projects
                    </button>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Selected: <strong>${escapeHtml(projectName)}</strong></div>
                </div>
                <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px; color: #333;">Step 2: Select Category</div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;

            // Materials
            if (project.materials?.items?.length > 0) {
                const claimed = getCategoryClaimed(project.materials);
                const budget = project.materials.totalCost || 0;
                const remaining = budget - claimed;

                content += `
                    <div class="category-option" onclick="selectCategoryStep('Materials')" style="cursor: pointer; padding: 10px; margin-bottom: 8px; border: 1px solid #e0e0e0; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-size: 12px; font-weight: 600; color: #333;">üîß Materials</span>
                            <span style="font-size: 11px; color: #666;">${project.materials.items.length} items</span>
                        </div>
                        <div style="font-size: 10px; color: #666; display: flex; gap: 12px;">
                            <span>Budget: ¬£${budget.toLocaleString()}</span>
                            <span>Claimed: ¬£${claimed.toLocaleString()}</span>
                            <span style="color: ${remaining < 0 ? '#dc2626' : '#059669'}; font-weight: 600;">Remaining: ¬£${remaining.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            }

            // Capital Usage
            if (project.capitalUsage?.items?.length > 0) {
                const claimed = getCategoryClaimed(project.capitalUsage);
                const budget = project.capitalUsage.totalCost || 0;
                const remaining = budget - claimed;

                content += `
                    <div class="category-option" onclick="selectCategoryStep('Capital Usage')" style="cursor: pointer; padding: 10px; margin-bottom: 8px; border: 1px solid #e0e0e0; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-size: 12px; font-weight: 600; color: #333;">üíº Capital Usage</span>
                            <span style="font-size: 11px; color: #666;">${project.capitalUsage.items.length} items</span>
                        </div>
                        <div style="font-size: 10px; color: #666; display: flex; gap: 12px;">
                            <span>Budget: ¬£${budget.toLocaleString()}</span>
                            <span>Claimed: ¬£${claimed.toLocaleString()}</span>
                            <span style="color: ${remaining < 0 ? '#dc2626' : '#059669'}; font-weight: 600;">Remaining: ¬£${remaining.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            }

            // Subcontracting
            if (project.subcontracting?.contractors?.length > 0) {
                const claimed = getCategoryClaimed(project.subcontracting);
                const budget = project.subcontracting.totalCost || 0;
                const remaining = budget - claimed;

                content += `
                    <div class="category-option" onclick="selectCategoryStep('Subcontracting')" style="cursor: pointer; padding: 10px; margin-bottom: 8px; border: 1px solid #e0e0e0; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-size: 12px; font-weight: 600; color: #333;">ü§ù Subcontracting</span>
                            <span style="font-size: 11px; color: #666;">${project.subcontracting.contractors.length} contractors</span>
                        </div>
                        <div style="font-size: 10px; color: #666; display: flex; gap: 12px;">
                            <span>Budget: ¬£${budget.toLocaleString()}</span>
                            <span>Claimed: ¬£${claimed.toLocaleString()}</span>
                            <span style="color: ${remaining < 0 ? '#dc2626' : '#059669'}; font-weight: 600;">Remaining: ¬£${remaining.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            }

            // Travel
            if (project.travel?.trips?.length > 0) {
                const claimed = getCategoryClaimed(project.travel);
                const budget = project.travel.totalCost || 0;
                const remaining = budget - claimed;

                content += `
                    <div class="category-option" onclick="selectCategoryStep('Travel')" style="cursor: pointer; padding: 10px; margin-bottom: 8px; border: 1px solid #e0e0e0; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-size: 12px; font-weight: 600; color: #333;">‚úàÔ∏è Travel</span>
                            <span style="font-size: 11px; color: #666;">${project.travel.trips.length} trips</span>
                        </div>
                        <div style="font-size: 10px; color: #666; display: flex; gap: 12px;">
                            <span>Budget: ¬£${budget.toLocaleString()}</span>
                            <span>Claimed: ¬£${claimed.toLocaleString()}</span>
                            <span style="color: ${remaining < 0 ? '#dc2626' : '#059669'}; font-weight: 600;">Remaining: ¬£${remaining.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            }

            // Other Costs
            if (project.otherCosts?.items?.length > 0) {
                const claimed = getCategoryClaimed(project.otherCosts);
                const budget = project.otherCosts.totalCost || 0;
                const remaining = budget - claimed;

                content += `
                    <div class="category-option" onclick="selectCategoryStep('Other Costs')" style="cursor: pointer; padding: 10px; margin-bottom: 8px; border: 1px solid #e0e0e0; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-size: 12px; font-weight: 600; color: #333;">üìã Other Costs</span>
                            <span style="font-size: 11px; color: #666;">${project.otherCosts.items.length} items</span>
                        </div>
                        <div style="font-size: 10px; color: #666; display: flex; gap: 12px;">
                            <span>Budget: ¬£${budget.toLocaleString()}</span>
                            <span>Claimed: ¬£${claimed.toLocaleString()}</span>
                            <span style="color: ${remaining < 0 ? '#dc2626' : '#059669'}; font-weight: 600;">Remaining: ¬£${remaining.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            }

            // WELSH GOV CATEGORIES
            if (project.welshGovData?.sections) {
                const sections = project.welshGovData.sections;

                // Capital - Non Standard Costs
                if (sections.capital?.nonStandard?.length > 0) {
                    const claimed = getCategoryClaimed({ items: sections.capital.nonStandard });
                    const budget = sections.totals?.totalCapitalNonStandard || 0;
                    const remaining = budget - claimed;

                    content += `
                        <div class="category-option" onclick="selectCategoryStep('Capital Non-Standard')" style="cursor: pointer; padding: 10px; margin-bottom: 8px; border: 1px solid #e0e0e0; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span style="font-size: 12px; font-weight: 600; color: #333;">üèóÔ∏è Capital - Non Standard</span>
                                <span style="font-size: 11px; color: #666;">${sections.capital.nonStandard.length} items</span>
                            </div>
                            <div style="font-size: 10px; color: #666; display: flex; gap: 12px;">
                                <span>Budget: ¬£${budget.toLocaleString()}</span>
                                <span>Claimed: ¬£${claimed.toLocaleString()}</span>
                                <span style="color: ${remaining < 0 ? '#dc2626' : '#059669'}; font-weight: 600;">Remaining: ¬£${remaining.toLocaleString()}</span>
                            </div>
                        </div>
                    `;
                }

                // Revenue - Non Standard Costs
                if (sections.revenue?.nonStandard?.length > 0) {
                    const claimed = getCategoryClaimed({ items: sections.revenue.nonStandard });
                    const budget = sections.totals?.totalRevenueNonStandard || 0;
                    const remaining = budget - claimed;

                    content += `
                        <div class="category-option" onclick="selectCategoryStep('Revenue Non-Standard')" style="cursor: pointer; padding: 10px; margin-bottom: 8px; border: 1px solid #e0e0e0; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span style="font-size: 12px; font-weight: 600; color: #333;">üí∞ Revenue - Non Standard</span>
                                <span style="font-size: 11px; color: #666;">${sections.revenue.nonStandard.length} items</span>
                            </div>
                            <div style="font-size: 10px; color: #666; display: flex; gap: 12px;">
                                <span>Budget: ¬£${budget.toLocaleString()}</span>
                                <span>Claimed: ¬£${claimed.toLocaleString()}</span>
                                <span style="color: ${remaining < 0 ? '#dc2626' : '#059669'}; font-weight: 600;">Remaining: ¬£${remaining.toLocaleString()}</span>
                            </div>
                        </div>
                    `;
                }

                // Revenue - Standard Costs
                if (sections.revenue?.standardCosts?.length > 0) {
                    const claimed = getCategoryClaimed({ items: sections.revenue.standardCosts });
                    const budget = sections.totals?.totalRevenueStandard || 0;
                    const remaining = budget - claimed;

                    content += `
                        <div class="category-option" onclick="selectCategoryStep('Revenue Standard')" style="cursor: pointer; padding: 10px; margin-bottom: 8px; border: 1px solid #e0e0e0; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span style="font-size: 12px; font-weight: 600; color: #333;">üë• Revenue - Standard</span>
                                <span style="font-size: 11px; color: #666;">${sections.revenue.standardCosts.length} items</span>
                            </div>
                            <div style="font-size: 10px; color: #666; display: flex; gap: 12px;">
                                <span>Budget: ¬£${budget.toLocaleString()}</span>
                                <span>Claimed: ¬£${claimed.toLocaleString()}</span>
                                <span style="color: ${remaining < 0 ? '#dc2626' : '#059669'}; font-weight: 600;">Remaining: ¬£${remaining.toLocaleString()}</span>
                            </div>
                        </div>
                    `;
                }

                // Item Breakdown - Capital
                if (sections.itemBreakdown?.capital?.length > 0) {
                    const claimed = getCategoryClaimed({ items: sections.itemBreakdown.capital });
                    let budget = 0;
                    sections.itemBreakdown.capital.forEach(item => {
                        budget += parseFloat(item.maxGrantApproved || item.totalCost || 0);
                    });
                    const remaining = budget - claimed;

                    content += `
                        <div class="category-option" onclick="selectCategoryStep('Item Breakdown Capital')" style="cursor: pointer; padding: 10px; margin-bottom: 8px; border: 1px solid #e0e0e0; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span style="font-size: 12px; font-weight: 600; color: #333;">üìã Item Breakdown - Capital</span>
                                <span style="font-size: 11px; color: #666;">${sections.itemBreakdown.capital.length} items</span>
                            </div>
                            <div style="font-size: 10px; color: #666; display: flex; gap: 12px;">
                                <span>Budget: ¬£${budget.toLocaleString()}</span>
                                <span>Claimed: ¬£${claimed.toLocaleString()}</span>
                                <span style="color: ${remaining < 0 ? '#dc2626' : '#059669'}; font-weight: 600;">Remaining: ¬£${remaining.toLocaleString()}</span>
                            </div>
                        </div>
                    `;
                }

                // Item Breakdown - Revenue
                if (sections.itemBreakdown?.revenue?.length > 0) {
                    const claimed = getCategoryClaimed({ items: sections.itemBreakdown.revenue });
                    let budget = 0;
                    sections.itemBreakdown.revenue.forEach(item => {
                        budget += parseFloat(item.maxGrantApproved || item.totalCost || 0);
                    });
                    const remaining = budget - claimed;

                    content += `
                        <div class="category-option" onclick="selectCategoryStep('Item Breakdown Revenue')" style="cursor: pointer; padding: 10px; margin-bottom: 8px; border: 1px solid #e0e0e0; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span style="font-size: 12px; font-weight: 600; color: #333;">üìã Item Breakdown - Revenue</span>
                                <span style="font-size: 11px; color: #666;">${sections.itemBreakdown.revenue.length} items</span>
                            </div>
                            <div style="font-size: 10px; color: #666; display: flex; gap: 12px;">
                                <span>Budget: ¬£${budget.toLocaleString()}</span>
                                <span>Claimed: ¬£${claimed.toLocaleString()}</span>
                                <span style="color: ${remaining < 0 ? '#dc2626' : '#059669'}; font-weight: 600;">Remaining: ¬£${remaining.toLocaleString()}</span>
                            </div>
                        </div>
                    `;
                }
            }

            content += '</div>';
            document.getElementById('assignModalContent').innerHTML = content;
        }

        /**
         * STEP 3: Show item selection for chosen category
         */
        function showItemSelection() {
            assignmentStep = 3;

            const project = activeProjects.find(p => p.projectId == selectedProject);
            if (!project) return;

            const category = getCategoryObject(project, selectedCategoryName);
            if (!category) return;

            const projectName = project.projectName || project.projectNumber || `Project #${project.projectId}`;

            let content = `
                <div style="margin-bottom: 15px;">
                    <button onclick="showCategorySelection()" style="background: none; border: none; color: #3AAFA9; cursor: pointer; font-size: 12px; padding: 0;">
                        ‚Üê Back to Categories
                    </button>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">${escapeHtml(projectName)} ‚Ä¢ ${selectedCategoryName}</div>
                </div>
                <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px; color: #333;">Step 3: Select Item</div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;

            // Get items based on category
            let items = [];
            let itemPrefix = '';

            // IUK Categories
            if (selectedCategoryName === 'Materials' && category.items) {
                items = category.items;
                itemPrefix = 'materials';
            } else if (selectedCategoryName === 'Capital Usage' && category.items) {
                items = category.items;
                itemPrefix = 'capitalUsage';
            } else if (selectedCategoryName === 'Subcontracting' && category.contractors) {
                items = category.contractors;
                itemPrefix = 'subcontracting';
            } else if (selectedCategoryName === 'Travel' && category.trips) {
                items = category.trips;
                itemPrefix = 'travel';
            } else if (selectedCategoryName === 'Other Costs' && category.items) {
                items = category.items;
                itemPrefix = 'otherCosts';
            }
            // Welsh Gov Categories
            else if (selectedCategoryName === 'Capital Non-Standard' && category.items) {
                items = category.items;
                itemPrefix = 'capitalNonStandard';
            } else if (selectedCategoryName === 'Revenue Non-Standard' && category.items) {
                items = category.items;
                itemPrefix = 'revenueNonStandard';
            } else if (selectedCategoryName === 'Revenue Standard' && category.items) {
                items = category.items;
                itemPrefix = 'revenueStandard';
            } else if (selectedCategoryName === 'Item Breakdown Capital' && category.items) {
                items = category.items;
                itemPrefix = 'itemBreakdownCapital';
            } else if (selectedCategoryName === 'Item Breakdown Revenue' && category.items) {
                items = category.items;
                itemPrefix = 'itemBreakdownRevenue';
            }

            items.forEach((item, idx) => {
                const itemKey = `${itemPrefix}-${idx}`;
                const claimed = getItemClaimed(item);

                // Get item name and budget
                let itemName = '';
                let itemBudget = 0;

                // IUK Categories
                if (selectedCategoryName === 'Materials') {
                    itemName = item.item;
                    itemBudget = item.total || 0;
                } else if (selectedCategoryName === 'Capital Usage') {
                    itemName = item.description;
                    itemBudget = item.netCost || 0;
                } else if (selectedCategoryName === 'Subcontracting') {
                    itemName = item.name;
                    itemBudget = item.cost || 0;
                } else if (selectedCategoryName === 'Travel') {
                    itemName = item.purpose;
                    itemBudget = item.total || 0;
                } else if (selectedCategoryName === 'Other Costs') {
                    itemName = item.description;
                    itemBudget = item.estimatedCost || 0;
                }
                // Welsh Gov Categories
                else if (selectedCategoryName === 'Capital Non-Standard' || selectedCategoryName === 'Revenue Non-Standard') {
                    itemName = `${item.itemCode} - ${item.description}`;
                    itemBudget = item.maxGrantValue || item.totalCost || 0;
                } else if (selectedCategoryName === 'Revenue Standard') {
                    itemName = `${item.itemCode} - ${item.description}`;
                    itemBudget = item.maxGrantValue || 0;
                } else if (selectedCategoryName === 'Item Breakdown Capital' || selectedCategoryName === 'Item Breakdown Revenue') {
                    itemName = `${item.itemCode} - ${item.description}`;
                    itemBudget = item.maxGrantApproved || item.totalCost || 0;
                }

                const remaining = itemBudget - claimed;

                content += `
                    <div class="category-option" onclick="selectCategoryItem('${selectedCategoryName}', '${itemKey}', '${escapeHtml(itemName)}', ${selectedProject})" style="cursor: pointer; padding: 10px; margin-bottom: 8px; border: 1px solid #e0e0e0; border-radius: 6px;">
                        <div style="font-size: 12px; font-weight: 600; color: #333; margin-bottom: 4px;">${escapeHtml(itemName)}</div>
                        <div style="font-size: 10px; color: #666; display: flex; gap: 12px;">
                            <span>Budget: ¬£${itemBudget.toLocaleString()}</span>
                            <span>Claimed: ¬£${claimed.toLocaleString()}</span>
                            <span style="color: ${remaining < 0 ? '#dc2626' : '#059669'}; font-weight: 600;">Remaining: ¬£${remaining.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            });

            content += '</div>';
            document.getElementById('assignModalContent').innerHTML = content;
        }

        /**
         * Handle project selection in step 1
         */
        function selectProjectStep(projectId) {
            selectedProject = projectId;
            showCategorySelection();
        }

        /**
         * Handle category selection in step 2
         */
        function selectCategoryStep(categoryName) {
            selectedCategoryName = categoryName;
            showItemSelection();
        }

        /**
         * Main entry point - open assignment modal
         */
        function handleAssign(index) {
            // Use the positioning handler for dropdown behavior
            handleAssignWithPosition(index);
        }

        async function selectCategoryItem(category, itemKey, itemName, projectId) {
            if (currentEditingIndex === null) return;

            const transaction = allTransactions[currentEditingIndex];
            const project = activeProjects.find(p => p.projectId === projectId);

            if (!project) {
                alert('‚ùå Project not found');
                return;
            }

            // Calculate quarter from transaction date
            const quarter = calculateTransactionQuarter(transaction.date, project);

            if (!quarter) {
                alert('‚ö†Ô∏è Cannot calculate quarter. Check project start date or transaction date.');
                return;
            }

            console.log(`üìÖ [ASSIGN] Calculated quarter: Q${quarter}`);

            // Calculate amount to assign (default 100%)
            const transAmount = parseAmount(transaction.spent || transaction.received);
            const percentage = 100;
            const amountToAssign = (transAmount * percentage) / 100;

            console.log(`üí∞ [ASSIGN] Amount to assign: ¬£${amountToAssign} (${percentage}% of ¬£${transAmount})`);

            // Initialize assignments array if needed
            if (!transaction.assignments) {
                transaction.assignments = [];
            }

            // Create new assignment object
            const newAssignment = {
                projectId: projectId,
                projectName: project.projectName || project.projectNumber || `Project ${project.projectId}`,
                category: category,
                itemKey: itemKey,
                itemName: itemName,
                quarter: quarter,
                percentage: percentage,
                amount: amountToAssign,
                assignedDate: new Date().toISOString()
            };

            // Add to assignments array
            transaction.assignments.push(newAssignment);

            console.log('‚úÖ [ASSIGN] New assignment created:', newAssignment);

            // Update project quarterly costs in database
            try {
                await updateProjectQuarterlyCosts(project, { category, itemKey, itemName, projectId }, quarter, amountToAssign);
                console.log('‚úÖ [ASSIGN] Project quarterly costs updated');
            } catch (error) {
                console.error('‚ùå [ASSIGN] Failed to update project:', error);
                alert('‚ö†Ô∏è Assignment saved locally but failed to update project budget. Check console for details.');
            }

            // Keep old format for backward compatibility
            transaction.assignedCategory = category;
            transaction.assignedItem = itemKey;
            transaction.assignedItemName = itemName;
            transaction.assignedProject = projectId;

            // Save values for toast message
            const projectName = project.projectName || 'Unknown Project';

            // Re-render the table
            renderTransactions();

            // Save to storage
            await saveTransactionsToStorage();

            // Close modal
            closeAssignModal();

            // Show success message
            showToast(`‚úÖ Assigned to ${itemName} (${category}) - Q${quarter} - ${projectName} - Saved`, 'success');

            // Auto-advance to next row
            advanceToNextRow();
        }

        function closeAssignModal() {
            console.log('‚ùå [MODAL DEBUG] closeAssignModal called');
            console.trace('‚ùå [MODAL DEBUG] Call stack:');

            const modal = document.getElementById('assignCategoryModal');
            const modalContent = modal.querySelector('.modal-content');

            modal.classList.remove('active');
            currentEditingIndex = null;
            selectedCategory = null;
            modalKeyboardIndex = -1;
            keyboardBuffer = '';

            // Reset modal positioning to center
            modalContent.style.position = '';
            modalContent.style.top = '';
            modalContent.style.left = '';
            modalContent.style.width = '';
            modalContent.style.margin = '';
            modalContent.style.maxHeight = '';
            modalContent.style.opacity = '';
            modalContent.style.transition = '';

            console.log('‚úÖ [MODAL DEBUG] Modal closed');
        }

        /**
         * Save all transactions to IndexedDB
         */
        async function saveTransactionsToStorage() {
            if (!db) {
                await initIndexedDB();
            }

            try {
                console.log('üíæ [SAVE] Saving transactions to storage...');

                // Group transactions by their source CSV file
                const transactionsByFile = {};

                savedCSVFiles.forEach(csvFile => {
                    // Find transactions that belong to this CSV file
                    const fileTransactions = allTransactions.filter(t => {
                        // Match transactions by date, bank, and description (robust matching)
                        return csvFile.transactions.some(ct =>
                            ct.date === t.date &&
                            ct.bank === t.bank &&
                            ct.description === t.description
                        );
                    });

                    if (fileTransactions.length > 0) {
                        transactionsByFile[csvFile.id] = {
                            csvFile: csvFile,
                            transactions: fileTransactions
                        };
                    }
                });

                // Update each CSV file with its transactions
                const transaction = db.transaction([CSV_STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(CSV_STORE_NAME);

                for (const [id, data] of Object.entries(transactionsByFile)) {
                    const updatedCSVFile = {
                        ...data.csvFile,
                        transactions: data.transactions,
                        lastModified: new Date().toISOString()
                    };

                    await new Promise((resolve, reject) => {
                        const request = objectStore.put(updatedCSVFile);
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                }

                await loadSavedCSVFiles(); // Refresh the list
                console.log('‚úÖ [SAVE] Transactions saved successfully');

            } catch (error) {
                console.error('‚ùå [SAVE] Failed to save transactions:', error);
            }
        }

        async function saveAssignment() {
            if (currentEditingIndex === null) return;

            if (!selectedCategory) {
                alert('‚ö†Ô∏è Please select a budget item first.');
                return;
            }

            const transaction = allTransactions[currentEditingIndex];
            const project = activeProjects.find(p => p.projectId === selectedCategory.projectId);

            if (!project) {
                alert('‚ùå Project not found');
                return;
            }

            // Calculate quarter from transaction date
            const quarter = calculateTransactionQuarter(transaction.date, project);

            if (!quarter) {
                alert('‚ö†Ô∏è Cannot calculate quarter. Check project start date or transaction date.');
                return;
            }

            console.log(`üìÖ [ASSIGN] Calculated quarter: Q${quarter}`);

            // Calculate amount to assign (default 100%)
            const transAmount = parseAmount(transaction.spent || transaction.received);
            const percentage = 100; // TODO: Add split allocation UI
            const amountToAssign = (transAmount * percentage) / 100;

            console.log(`üí∞ [ASSIGN] Amount to assign: ¬£${amountToAssign} (${percentage}% of ¬£${transAmount})`);

            // Initialize assignments array if needed
            if (!transaction.assignments) {
                transaction.assignments = [];
            }

            // Create new assignment object
            const newAssignment = {
                projectId: selectedCategory.projectId,
                projectName: project.projectName || project.projectNumber || `Project ${project.projectId}`,
                category: selectedCategory.category,
                itemKey: selectedCategory.itemKey,
                itemName: selectedCategory.itemName,
                quarter: quarter,
                percentage: percentage,
                amount: amountToAssign,
                assignedDate: new Date().toISOString()
            };

            // Add to assignments array
            transaction.assignments.push(newAssignment);

            console.log('‚úÖ [ASSIGN] New assignment created:', newAssignment);

            // Update project quarterly costs in database
            try {
                await updateProjectQuarterlyCosts(project, selectedCategory, quarter, amountToAssign);
                console.log('‚úÖ [ASSIGN] Project quarterly costs updated');
            } catch (error) {
                console.error('‚ùå [ASSIGN] Failed to update project:', error);
                alert('‚ö†Ô∏è Assignment saved locally but failed to update project budget. Check console for details.');
            }

            // Keep old format for backward compatibility
            transaction.assignedCategory = selectedCategory.category;
            transaction.assignedItem = selectedCategory.itemKey;
            transaction.assignedItemName = selectedCategory.itemName;
            transaction.assignedProject = selectedCategory.projectId;

            // Save values for toast message BEFORE closing modal (which nulls selectedCategory)
            const projectName = project.projectName || 'Unknown Project';
            const itemName = selectedCategory.itemName;
            const categoryName = selectedCategory.category;

            // Re-render the table
            renderTransactions();

            // Close modal (this will set selectedCategory = null)
            closeAssignModal();

            // Show success message
            showToast(`‚úÖ Assigned to ${itemName} (${categoryName}) - Q${quarter} - ${projectName}`, 'success');

            // Auto-advance to next row
            advanceToNextRow();
        }

        /**
         * Update project's quarterly costs in IndexedDB
         */
        async function updateProjectQuarterlyCosts(project, selection, quarter, amount) {
            console.log('üîÑ [UPDATE COSTS] Updating quarterly costs...');
            console.log(`   Project: ${project.projectName || project.projectId}`);
            console.log(`   Category: ${selection.category}`);
            console.log(`   Item: ${selection.itemName}`);
            console.log(`   Quarter: Q${quarter}`);
            console.log(`   Amount: ¬£${amount}`);

            // Load fresh copy from DB to avoid conflicts
            if (!db) await initIndexedDB();

            const freshProject = await new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(project.projectId);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });

            if (!freshProject) {
                throw new Error('Project not found in database');
            }

            // Get category and item
            const category = getCategoryObject(freshProject, selection.category);
            const item = findItemInCategory(category, selection.itemKey);

            if (!item) {
                throw new Error(`Item not found: ${selection.itemKey}`);
            }

            // Initialize quarterlyCosts if it doesn't exist
            if (!item.quarterlyCosts) {
                item.quarterlyCosts = {q1: 0, q2: 0, q3: 0, q4: 0};
                console.log('üìä [UPDATE COSTS] Initialized quarterly costs for item');
            }

            // Add amount to the correct quarter
            const quarterKey = `q${quarter}`;
            const previousAmount = item.quarterlyCosts[quarterKey] || 0;
            item.quarterlyCosts[quarterKey] = previousAmount + amount;

            console.log(`‚úÖ [UPDATE COSTS] ${quarterKey}: ¬£${previousAmount} ‚Üí ¬£${item.quarterlyCosts[quarterKey]}`);

            // Update lastModified
            freshProject.lastModified = new Date().toISOString();

            // Save back to database
            await saveProjectToDB(freshProject);

            // Update in-memory activeProjects array
            const activeIndex = activeProjects.findIndex(p => p.projectId === freshProject.projectId);
            if (activeIndex !== -1) {
                activeProjects[activeIndex] = freshProject;
            }

            console.log('‚úÖ [UPDATE COSTS] Project saved successfully');
        }

        // Close modal when clicking outside
        document.getElementById('assignCategoryModal').addEventListener('click', function(e) {
            console.log('üñ±Ô∏è [MODAL DEBUG] Click on modal overlay detected');
            console.log('üñ±Ô∏è [MODAL DEBUG] e.target:', e.target);
            console.log('üñ±Ô∏è [MODAL DEBUG] this:', this);
            console.log('üñ±Ô∏è [MODAL DEBUG] Are they equal?', e.target === this);

            if (e.target === this) {
                console.log('‚ö†Ô∏è [MODAL DEBUG] Click outside modal content - closing modal');
                closeAssignModal();
            } else {
                console.log('‚úÖ [MODAL DEBUG] Click inside modal content - keeping modal open');
            }
        });

        // ========================================
        // KEYBOARD NAVIGATION
        // ========================================

        /**
         * Select a row for keyboard navigation
         */
        function selectRow(index, event) {
            if (event && event.target.tagName === 'BUTTON') {
                return; // Don't select row when clicking buttons
            }
            selectedRowIndex = index;
            renderTransactions();
        }

        /**
         * Advance to the next unassigned row after successful assignment
         */
        function advanceToNextRow() {
            if (selectedRowIndex === null) return;

            console.log('üìç [NAV] Advancing to next row from index:', selectedRowIndex);

            // Find the next row in the filtered/displayed transactions
            let nextIndex = selectedRowIndex + 1;

            // Wrap around if we're at the end
            if (nextIndex >= allTransactions.length) {
                nextIndex = 0;
            }

            selectedRowIndex = nextIndex;
            renderTransactions();
            scrollRowIntoView(selectedRowIndex);

            console.log('‚úÖ [NAV] Advanced to row:', selectedRowIndex);
        }

        /**
         * Handle keyboard shortcuts for table navigation and assignment
         */
        document.addEventListener('keydown', function(e) {
            const modalOpen = document.getElementById('assignCategoryModal').classList.contains('active');
            console.log('‚å®Ô∏è [MODAL DEBUG] Keydown event:', e.key, 'Modal open:', modalOpen);

            // Modal is closed - table navigation
            if (!modalOpen) {
                console.log('‚å®Ô∏è [MODAL DEBUG] Processing key in table navigation mode');
                // Arrow Down - select next row
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (selectedRowIndex === null) {
                        selectedRowIndex = 0;
                    } else if (selectedRowIndex < allTransactions.length - 1) {
                        selectedRowIndex++;
                    }
                    renderTransactions();
                    scrollRowIntoView(selectedRowIndex);
                }
                // Arrow Up - select previous row
                else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (selectedRowIndex === null) {
                        selectedRowIndex = allTransactions.length - 1;
                    } else if (selectedRowIndex > 0) {
                        selectedRowIndex--;
                    }
                    renderTransactions();
                    scrollRowIntoView(selectedRowIndex);
                }
                // '1' key - open assign dialog for selected row
                else if (e.key === '1' && selectedRowIndex !== null) {
                    e.preventDefault();
                    console.log('‚å®Ô∏è [MODAL DEBUG] Opening assign modal for row:', selectedRowIndex);
                    handleAssignWithPosition(selectedRowIndex);
                }
            }
            // Modal is open - number-based navigation
            else {
                console.log('‚å®Ô∏è [MODAL DEBUG] Processing key in modal navigation mode');
                // Escape - close modal
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeAssignModal();
                }
                // Number keys (1-9) - direct selection
                else if (e.key >= '1' && e.key <= '9') {
                    e.preventDefault();
                    const optionIndex = parseInt(e.key) - 1;
                    selectModalOptionByIndex(optionIndex);
                }
                // Arrow keys in modal
                else if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    handleModalArrowNavigation(e.key === 'ArrowDown' ? 1 : -1);
                }
                // Back arrow - go to previous step
                else if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    if (assignmentStep === 3) {
                        // From item selection back to category selection
                        showCategorySelection();
                    } else if (assignmentStep === 2) {
                        // From category selection back to project selection
                        showProjectSelection();
                    } else if (assignmentStep === 1) {
                        // From project selection, close modal
                        closeAssignModal();
                    }
                }
                // Enter - select highlighted option
                else if (e.key === 'Enter') {
                    e.preventDefault();
                    selectHighlightedModalOption();
                }
            }
        });

        /**
         * Scroll row into view
         */
        function scrollRowIntoView(index) {
            const row = document.querySelector(`tr[data-row-index="${index}"]`);
            if (row) {
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        /**
         * Handle assign with dropdown positioning
         */
        function handleAssignWithPosition(index) {
            console.log('üîç [MODAL DEBUG] handleAssignWithPosition called for index:', index);

            const assignBtn = document.getElementById(`assignBtn${index}`);
            if (!assignBtn) {
                console.log('‚ö†Ô∏è [MODAL DEBUG] No assign button found, calling handleAssign directly');
                handleAssign(index);
                return;
            }

            // Get button position
            const rect = assignBtn.getBoundingClientRect();
            const modal = document.getElementById('assignCategoryModal');
            const modalContent = modal.querySelector('.modal-content');

            console.log('‚úÖ [MODAL DEBUG] Opening modal - preparing to position');

            // Hide modal initially to prevent flash
            modalContent.style.opacity = '0';
            modalContent.style.transition = 'none';

            // Position modal as dropdown below the button
            modal.classList.add('active');

            console.log('üîç [MODAL DEBUG] Modal active class added, classList:', modal.classList.toString());

            // Use setTimeout to ensure modal is rendered before positioning
            setTimeout(() => {
                console.log('üìê [MODAL DEBUG] Positioning modal');
                const modalHeight = modalContent.offsetHeight;
                const modalWidth = Math.min(500, window.innerWidth - 40);

                let top = rect.bottom + window.scrollY + 5;
                let left = rect.right + window.scrollX - modalWidth;

                // Adjust if modal goes off-screen
                if (left < 10) left = 10;
                if (left + modalWidth > window.innerWidth - 10) {
                    left = window.innerWidth - modalWidth - 10;
                }

                // If modal goes below viewport, position above button
                if (top + modalHeight > window.innerHeight + window.scrollY - 20) {
                    top = rect.top + window.scrollY - modalHeight - 5;
                }

                modalContent.style.position = 'absolute';
                modalContent.style.top = top + 'px';
                modalContent.style.left = left + 'px';
                modalContent.style.maxHeight = '70vh';
                modalContent.style.width = modalWidth + 'px';
                modalContent.style.margin = '0';

                // Show modal after positioning
                modalContent.style.opacity = '1';
                modalContent.style.transition = 'opacity 0.15s ease-in-out';

                console.log('‚úÖ [MODAL DEBUG] Modal positioned at:', { top, left });
            }, 10);

            // Now proceed with normal assignment flow
            currentEditingIndex = index;
            console.log('üîç [MODAL DEBUG] Active projects count:', activeProjects.length);

            if (activeProjects.length === 0) {
                console.log('‚ùå [MODAL DEBUG] No projects loaded, closing modal');
                alert('‚ö†Ô∏è No projects loaded. Please create a budget in the Grants page first.');
                closeAssignModal();
                return;
            }

            console.log('‚úÖ [MODAL DEBUG] Calling showProjectSelection()');
            showProjectSelection();
            modalKeyboardIndex = -1;
            console.log('‚úÖ [MODAL DEBUG] Modal setup complete');
        }

        /**
         * Select modal option by number key (1-9)
         */
        function selectModalOptionByIndex(index) {
            const options = document.querySelectorAll('.category-option');
            if (index >= 0 && index < options.length) {
                options[index].click();
            }
        }

        /**
         * Handle arrow navigation in modal
         */
        function handleModalArrowNavigation(direction) {
            const options = document.querySelectorAll('.category-option');
            if (options.length === 0) return;

            if (modalKeyboardIndex === -1) {
                modalKeyboardIndex = direction > 0 ? 0 : options.length - 1;
            } else {
                modalKeyboardIndex += direction;
                if (modalKeyboardIndex < 0) modalKeyboardIndex = 0;
                if (modalKeyboardIndex >= options.length) modalKeyboardIndex = options.length - 1;
            }

            updateModalHighlight();
            options[modalKeyboardIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        /**
         * Update modal option highlight
         */
        function updateModalHighlight() {
            const options = document.querySelectorAll('.category-option');
            options.forEach((opt, idx) => {
                opt.classList.remove('keyboard-selected');
                if (idx === modalKeyboardIndex) {
                    opt.classList.add('keyboard-selected');
                }
            });
        }

        /**
         * Select highlighted modal option
         */
        function selectHighlightedModalOption() {
            if (modalKeyboardIndex === -1) return;
            const options = document.querySelectorAll('.category-option');
            if (options[modalKeyboardIndex]) {
                options[modalKeyboardIndex].click();
            }
        }

        // ========================================
        // PROJECT UPDATE HELPERS
        // ========================================

        /**
         * Get category object from project by name
         */
        function getCategoryObject(project, categoryName) {
            // IUK Categories
            const categoryMap = {
                'Labour': project.labour,
                'Overheads': project.overheads,
                'Materials': project.materials,
                'Capital Usage': project.capitalUsage,
                'Subcontracting': project.subcontracting,
                'Travel': project.travel,
                'Other Costs': project.otherCosts
            };

            if (categoryMap[categoryName]) {
                return categoryMap[categoryName];
            }

            // Welsh Gov Categories
            if (project.welshGovData?.sections) {
                const sections = project.welshGovData.sections;
                const welshCategoryMap = {
                    'Capital Non-Standard': { items: sections.capital?.nonStandard || [] },
                    'Revenue Non-Standard': { items: sections.revenue?.nonStandard || [] },
                    'Revenue Standard': { items: sections.revenue?.standardCosts || [] },
                    'Item Breakdown Capital': { items: sections.itemBreakdown?.capital || [] },
                    'Item Breakdown Revenue': { items: sections.itemBreakdown?.revenue || [] }
                };

                return welshCategoryMap[categoryName];
            }

            return null;
        }

        /**
         * Find specific item in category by itemKey (e.g., "materials-2")
         */
        function findItemInCategory(category, itemKey) {
            if (!category) return null;

            const [catName, indexStr] = itemKey.split('-');
            const index = parseInt(indexStr);

            // IUK categories
            if (catName === 'labour' && category.staff) return category.staff[index];
            if (catName === 'overheads') return category; // Overheads is single object
            if (catName === 'materials' && category.items) return category.items[index];
            if (catName === 'capitalUsage' && category.items) return category.items[index];
            if (catName === 'subcontracting' && category.contractors) return category.contractors[index];
            if (catName === 'travel' && category.trips) return category.trips[index];
            if (catName === 'otherCosts' && category.items) return category.items[index];

            // Welsh Gov categories (all use .items array)
            if (catName === 'capitalNonStandard' && category.items) return category.items[index];
            if (catName === 'revenueNonStandard' && category.items) return category.items[index];
            if (catName === 'revenueStandard' && category.items) return category.items[index];
            if (catName === 'itemBreakdownCapital' && category.items) return category.items[index];
            if (catName === 'itemBreakdownRevenue' && category.items) return category.items[index];

            return null;
        }

        /**
         * Save project back to IndexedDB
         */
        async function saveProjectToDB(project) {
            if (!db) await initIndexedDB();

            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(project);

                request.onsuccess = () => {
                    console.log('‚úÖ [DB] Project saved:', project.projectId);
                    resolve();
                };

                request.onerror = () => {
                    console.error('‚ùå [DB] Error saving project:', request.error);
                    reject(request.error);
                };
            });
        }

        // ========================================
        // UNASSIGNMENT FUNCTIONALITY
        // ========================================

        /**
         * Handle unassignment (right-click on assign button)
         */
        async function handleUnassign(index) {
            const transaction = allTransactions[index];

            if (!transaction.assignments || transaction.assignments.length === 0) {
                if (!transaction.assignedItemName) {
                    showToast('‚ö†Ô∏è This transaction has no assignments to remove', 'info');
                    return;
                }

                // Old format - convert and remove
                if (confirm('Remove assignment from this transaction?')) {
                    delete transaction.assignedCategory;
                    delete transaction.assignedItem;
                    delete transaction.assignedItemName;
                    delete transaction.assignedProject;

                    renderTransactions();
                    await saveTransactionsToStorage();
                    showToast('‚úÖ Assignment removed and saved', 'success');
                }
                return;
            }

            // New format - show list of assignments to remove
            if (transaction.assignments.length === 1) {
                if (confirm(`Remove assignment: ${transaction.assignments[0].itemName}?`)) {
                    await removeAssignmentFromProject(transaction, transaction.assignments[0]);
                    transaction.assignments = [];
                    renderTransactions();
                    await saveTransactionsToStorage();
                    showToast('‚úÖ Assignment removed, project updated, and saved', 'success');
                }
            } else {
                // Multiple assignments - let user choose
                const assignmentList = transaction.assignments.map((a, i) =>
                    `${i + 1}. ${a.itemName} (${a.percentage}%) - ${getQuarterName(a.quarter)}`
                ).join('\n');

                const choice = prompt(`Multiple assignments found:\n\n${assignmentList}\n\nEnter number to remove (or 'all' to remove all):`);

                if (choice === 'all') {
                    for (const assignment of transaction.assignments) {
                        await removeAssignmentFromProject(transaction, assignment);
                    }
                    transaction.assignments = [];
                    renderTransactions();
                    await saveTransactionsToStorage();
                    showToast('‚úÖ All assignments removed and saved', 'success');
                } else {
                    const index = parseInt(choice) - 1;
                    if (index >= 0 && index < transaction.assignments.length) {
                        await removeAssignmentFromProject(transaction, transaction.assignments[index]);
                        transaction.assignments.splice(index, 1);
                        renderTransactions();
                        await saveTransactionsToStorage();
                        showToast('‚úÖ Assignment removed and saved', 'success');
                    }
                }
            }
        }

        /**
         * Remove assignment cost from project's quarterly costs
         */
        async function removeAssignmentFromProject(transaction, assignment) {
            console.log('üîÑ [UNASSIGN] Removing assignment from project:', assignment);

            try {
                // Load project from DB
                if (!db) await initIndexedDB();

                const project = await new Promise((resolve, reject) => {
                    const trans = db.transaction([STORE_NAME], 'readonly');
                    const store = trans.objectStore(STORE_NAME);
                    const request = store.get(assignment.projectId);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                if (!project) {
                    console.error('‚ùå [UNASSIGN] Project not found:', assignment.projectId);
                    return;
                }

                // Calculate amount to subtract
                const transAmount = parseAmount(transaction.spent || transaction.received);
                const amountToRemove = (transAmount * assignment.percentage) / 100;

                console.log(`üí∞ [UNASSIGN] Removing ¬£${amountToRemove} from ${assignment.category} - ${assignment.itemName} Q${assignment.quarter}`);

                // Find the item and update quarterly costs
                const category = getCategoryObject(project, assignment.category);
                const item = findItemInCategory(category, assignment.itemKey);

                if (item && item.quarterlyCosts) {
                    const quarterKey = `q${assignment.quarter}`;
                    item.quarterlyCosts[quarterKey] = (item.quarterlyCosts[quarterKey] || 0) - amountToRemove;

                    console.log(`‚úÖ [UNASSIGN] Updated ${quarterKey}:`, item.quarterlyCosts);

                    // Save project back to DB
                    project.lastModified = new Date().toISOString();
                    await saveProjectToDB(project);
                    console.log('‚úÖ [UNASSIGN] Project saved');
                }

            } catch (error) {
                console.error('‚ùå [UNASSIGN] Error removing assignment:', error);
            }
        }

        // ========================================
        // VOICE RECORDING FUNCTIONALITY
        // ========================================

        // Toast notification function
        function showToast(message, type = 'info', position = null) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            if (type) toast.classList.add(type);

            // Position toast near the button if coordinates provided
            if (position && position.x !== undefined && position.y !== undefined) {
                // Position toast near the click, offset slightly to the right and down
                const offsetX = 10;
                const offsetY = 10;

                // Calculate position, ensuring it stays within viewport
                let left = position.x + offsetX;
                let top = position.y + offsetY;

                // Adjust if toast would go off-screen (estimate toast width as 400px)
                if (left + 400 > window.innerWidth) {
                    left = position.x - 400 - offsetX; // Position to the left instead
                }
                if (top + 100 > window.innerHeight) {
                    top = position.y - 100 - offsetY; // Position above instead
                }

                // Ensure minimum margins
                left = Math.max(10, Math.min(left, window.innerWidth - 410));
                top = Math.max(10, Math.min(top, window.innerHeight - 110));

                toast.style.left = left + 'px';
                toast.style.top = top + 'px';
                toast.style.bottom = 'auto';
                toast.style.right = 'auto';
                toast.classList.add('positioned');
            } else {
                // Default position (bottom right)
                toast.style.left = '';
                toast.style.top = '';
                toast.style.bottom = '';
                toast.style.right = '';
                toast.classList.remove('positioned');
            }

            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // Toggle voice recording for specific row
        async function toggleRowVoiceRecording(rowIndex) {
            if (isRecording && currentRecordingRowIndex === rowIndex) {
                stopRecording();
            } else {
                await startRowRecording(rowIndex);
            }
        }

        // Start recording for specific row
        async function startRowRecording(rowIndex) {
            // If already recording another row, stop it first
            if (isRecording) {
                stopRecording();
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            const micBtn = document.getElementById(`micBtn${rowIndex}`);
            if (!micBtn) return;

            try {
                // Reuse existing stream or create new one (permission requested only once)
                if (!microphoneStream) {
                    microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                }
                const stream = microphoneStream;

                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                currentRecordingRowIndex = rowIndex;

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    // Keep stream alive - don't stop tracks
                    // stream.getTracks().forEach(track => track.stop());

                    micBtn.classList.remove('recording');
                    micBtn.textContent = 'üé§';

                    if (audioChunks.length > 0) {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        await transcribeAudio(audioBlob);
                    } else {
                        currentRecordingRowIndex = null;
                    }
                };

                mediaRecorder.start();
                isRecording = true;

                micBtn.classList.add('recording');
                micBtn.textContent = '‚èπÔ∏è';

                showToast('üé§ Recording... Click again to stop', 'info');

                // Auto-stop after MAX_RECORDING_TIME
                recordingTimeout = setTimeout(() => {
                    if (isRecording) {
                        showToast('‚è±Ô∏è Max recording time reached (30s)', 'info');
                        stopRecording();
                    }
                }, MAX_RECORDING_TIME);

            } catch (error) {
                console.error('Microphone error:', error);
                showToast('‚ùå Microphone access denied. Please allow microphone access.', 'error');
                micBtn.classList.remove('recording');
                micBtn.textContent = 'üé§';
                currentRecordingRowIndex = null;
            }
        }

        // Stop recording
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                clearTimeout(recordingTimeout);
                mediaRecorder.stop();
                isRecording = false;
            }
        }

        // Transcribe audio using Whisper API
        async function transcribeAudio(audioBlob) {
            if (currentRecordingRowIndex === null) {
                showToast('‚ùå No row selected for voice note', 'error');
                return;
            }

            const micBtn = document.getElementById(`micBtn${currentRecordingRowIndex}`);
            if (!micBtn) return;

            // Check for API key
            const apiKey = getOpenAIKey();
            if (!apiKey) {
                showToast('‚ùå OpenAI API Key required for voice transcription', 'error');
                micBtn.classList.remove('processing');
                micBtn.disabled = false;
                micBtn.textContent = 'üé§';
                currentRecordingRowIndex = null;
                return;
            }

            micBtn.classList.add('processing');
            micBtn.disabled = true;
            micBtn.textContent = '‚è≥';

            try {
                const formData = new FormData();
                formData.append('file', audioBlob, 'recording.webm');
                formData.append('model', 'whisper-1');
                formData.append('language', 'en');

                const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Transcription failed: ${response.status}`);
                }

                const data = await response.json();
                const transcription = data.text;

                console.log('Transcription:', transcription);

                if (!transcription || transcription.trim().length === 0) {
                    showToast('‚ùå Could not understand audio. Please try again.', 'error');
                    micBtn.classList.remove('processing');
                    micBtn.disabled = false;
                    micBtn.textContent = 'üé§';
                    currentRecordingRowIndex = null;
                    return;
                }

                // Show transcription modal for review
                document.getElementById('transcriptionText').value = transcription;
                document.getElementById('transcriptionModal').classList.add('show');

            } catch (error) {
                console.error('Transcription error:', error);
                showToast('‚ùå Transcription failed. Please try again.', 'error');
                currentRecordingRowIndex = null;
            } finally {
                micBtn.classList.remove('processing');
                micBtn.disabled = false;
                micBtn.textContent = 'üé§';
            }
        }

        // Close transcription modal
        function closeTranscriptionModal() {
            document.getElementById('transcriptionModal').classList.remove('show');
            document.getElementById('transcriptionText').value = '';
            currentRecordingRowIndex = null; // Reset recording row
        }

        // Process transcription and save as voice note
        async function processTranscription() {
            const transcription = document.getElementById('transcriptionText').value.trim();

            if (!transcription) {
                showToast('‚ùå No transcription to process', 'error');
                return;
            }

            if (currentRecordingRowIndex === null) {
                showToast('‚ùå No row selected for voice note', 'error');
                closeTranscriptionModal();
                return;
            }

            // Save the transcription directly as a voice note for the row
            const rowIndex = currentRecordingRowIndex;
            allTransactions[rowIndex].voiceNotes = transcription;

            // Re-render to show the note
            renderTransactions();
            updateSummary();

            showToast(`‚úÖ Voice note added to transaction`, 'success');

            closeTranscriptionModal();
        }

        // ========================================
        // GMAIL API AUTHENTICATION (Google Identity Services)
        // ========================================

        // Initialize GAPI client
        function gapiLoaded() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: GOOGLE_API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'],
                });
                gapiInited = true;
                console.log('GAPI client initialized');
                maybeEnableButtons();
            });
        }

        // Initialize GIS client
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: GMAIL_SCOPES,
                callback: (response) => {
                    if (response.error !== undefined) {
                        console.error('GIS error:', response);
                        showToast('‚ùå Gmail authentication failed', 'error');
                        return;
                    }
                    handleAuthSuccess(response.access_token);
                },
            });
            gisInited = true;
            console.log('GIS client initialized');
            maybeEnableButtons();
        }

        // Enable buttons when both libraries are loaded
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                updateGmailStatus();
            }
        }

        // Initialize Google Auth when page loads
        function initializeGoogleAuth() {
            // Load GAPI
            if (typeof gapi !== 'undefined') {
                gapiLoaded();
            } else {
                window.addEventListener('load', () => {
                    setTimeout(gapiLoaded, 100);
                });
            }

            // Load GIS
            if (typeof google !== 'undefined' && google.accounts) {
                gisLoaded();
            } else {
                window.addEventListener('load', () => {
                    setTimeout(gisLoaded, 100);
                });
            }
        }

        // Sign in to Gmail (add new account)
        async function signInToGmail() {
            if (!tokenClient) {
                showToast('‚ö†Ô∏è Google API not initialized yet. Please wait...', 'error');
                return;
            }

            // Request an access token (will prompt for account selection)
            tokenClient.requestAccessToken({ prompt: 'select_account' });
        }

        // Sign out from specific Gmail account
        function signOutFromAccount(email) {
            const accountIndex = gmailAccounts.findIndex(acc => acc.email === email);
            if (accountIndex !== -1) {
                const account = gmailAccounts[accountIndex];
                if (account.accessToken) {
                    google.accounts.oauth2.revoke(account.accessToken, () => {
                        console.log('Access token revoked for:', email);
                    });
                }
                gmailAccounts.splice(accountIndex, 1);
                saveGmailAccountsToStorage(); // Persist removal
                updateGmailStatus();
                showToast(`‚úÖ Signed out: ${email}`, 'success');
            }
        }

        // Sign out from all Gmail accounts
        function signOutFromGmail() {
            gmailAccounts.forEach(account => {
                if (account.accessToken) {
                    google.accounts.oauth2.revoke(account.accessToken, () => {
                        console.log('Access token revoked for:', account.email);
                    });
                }
            });
            gmailAccounts = [];
            saveGmailAccountsToStorage(); // Clear saved accounts
            updateGmailStatus();
            showToast('‚úÖ Signed out from all accounts', 'success');
        }

        async function handleAuthSuccess(accessToken) {
            console.log('Authentication successful, token received');

            try {
                // Get user info
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    const userInfo = await response.json();
                    const email = userInfo.email;

                    // Check if account already exists
                    const existingAccount = gmailAccounts.find(acc => acc.email === email);
                    if (existingAccount) {
                        // Update token for existing account
                        existingAccount.accessToken = accessToken;
                        showToast(`‚úÖ Reconnected: ${email}`, 'success');
                    } else {
                        // Add new account (selected by default)
                        gmailAccounts.push({
                            email: email,
                            accessToken: accessToken,
                            selected: true
                        });
                        showToast(`‚úÖ Connected: ${email}`, 'success');
                    }

                    console.log('User info retrieved:', email);
                } else {
                    console.warn('Could not get user info, but token is valid');
                    // Add account without email
                    gmailAccounts.push({
                        email: 'Account ' + (gmailAccounts.length + 1),
                        accessToken: accessToken,
                        selected: true
                    });
                    showToast('‚úÖ Connected to Gmail', 'success');
                }
            } catch (error) {
                console.error('Error getting user info:', error);
                // Even if we can't get user info, we have the token
                gmailAccounts.push({
                    email: 'Account ' + (gmailAccounts.length + 1),
                    accessToken: accessToken,
                    selected: true
                });
                showToast('‚úÖ Connected to Gmail', 'success');
            }

            saveGmailAccountsToStorage(); // Persist to localStorage
            updateGmailStatus();
        }

        function updateGmailStatus() {
            const statusDiv = document.getElementById('gmailConnectionStatus');
            const accountsList = document.getElementById('gmailAccountsList');
            const connectBtn = document.getElementById('gmailConnectBtn');
            const signOutBtn = document.getElementById('gmailSignOutBtn');

            if (gmailAccounts.length === 0) {
                statusDiv.innerHTML = '<span style="color: #dc2626;">‚ùå Not connected</span>';
                accountsList.innerHTML = '';
                if (connectBtn) connectBtn.style.display = 'inline-flex';
                if (signOutBtn) signOutBtn.style.display = 'none';
            } else {
                const selectedCount = gmailAccounts.filter(acc => acc.selected).length;
                statusDiv.innerHTML = `<span style="color: #059669;">${gmailAccounts.length} account${gmailAccounts.length > 1 ? 's' : ''} (${selectedCount} selected)</span>`;

                let html = '';

                gmailAccounts.forEach((account, index) => {
                    const needsAuth = !account.accessToken;
                    const statusIndicator = needsAuth ? '‚ö†Ô∏è' : '‚úÖ';

                    html += `
                        <div style="display: flex; align-items: center; gap: 5px; background: ${needsAuth ? '#fff3cd' : '#f8f9fa'}; padding: 6px 8px; border-radius: 4px; margin-bottom: 4px; border: 1px solid ${account.selected ? '#3AAFA9' : '#e9ecef'};">
                            <input
                                type="checkbox"
                                id="gmailAccount${index}"
                                ${account.selected ? 'checked' : ''}
                                ${needsAuth ? 'disabled' : ''}
                                onchange="toggleAccountSelection(${index})"
                                style="cursor: ${needsAuth ? 'not-allowed' : 'pointer'}; width: 14px; height: 14px; margin: 0;"
                            >
                            <label for="gmailAccount${index}" style="flex: 1; cursor: pointer; font-size: 11px; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${statusIndicator} ${escapeHtml(account.email.split('@')[0])}
                            </label>
                            ${needsAuth ? `
                                <button
                                    onclick="reconnectAccount(${index})"
                                    class="modal-btn modal-btn-primary"
                                    style="margin: 0; padding: 2px 6px; font-size: 10px;">
                                    Reconnect
                                </button>
                            ` : ''}
                            <button
                                onclick="signOutFromAccount('${escapeHtml(account.email)}')"
                                class="modal-btn modal-btn-secondary"
                                style="margin: 0; padding: 2px 6px; font-size: 10px;">
                                ‚úï
                            </button>
                        </div>
                    `;
                });

                accountsList.innerHTML = html;

                if (connectBtn) {
                    connectBtn.innerHTML = '+ Add Account';
                }
                if (signOutBtn) signOutBtn.style.display = 'none';
            }
        }

        // Reconnect a specific account that needs re-authentication
        function reconnectAccount(index) {
            if (!tokenClient) {
                showToast('‚ùå Gmail client not initialized', 'error');
                return;
            }

            // Store the index we're reconnecting so we can match it in handleAuthSuccess
            window.reconnectingAccountIndex = index;

            // Trigger OAuth flow
            tokenClient.requestAccessToken({ prompt: 'select_account' });
        }

        // Toggle account selection for searching
        function toggleAccountSelection(index) {
            if (gmailAccounts[index]) {
                gmailAccounts[index].selected = !gmailAccounts[index].selected;
                saveGmailAccountsToStorage(); // Persist selection state
                updateGmailStatus();
            }
        }

        // ========================================
        // GMAIL SEARCH & EMAIL PARSING
        // ========================================

        async function searchEmailsForTransaction(transaction) {
            const searchQueries = buildSearchQueries(transaction);
            const selectedAccounts = gmailAccounts.filter(acc => acc.selected);

            if (selectedAccounts.length === 0) {
                showToast('‚ö†Ô∏è No accounts selected for search', 'error');
                return [];
            }

            let allResults = [];

            // Search across all selected accounts
            for (const account of selectedAccounts) {
                console.log(`Searching account: ${account.email}`);

                for (const query of searchQueries) {
                    try {
                        const results = await searchGmail(query, account.accessToken);
                        // Tag results with account email
                        results.forEach(msg => msg.accountEmail = account.email);
                        allResults = allResults.concat(results);
                    } catch (error) {
                        console.error(`Search error for ${account.email}, query:`, query, error);
                    }
                }
            }

            // Deduplicate by message ID + account email
            const uniqueResults = [];
            const seenIds = new Set();
            for (const msg of allResults) {
                const uniqueKey = `${msg.accountEmail}:${msg.id}`;
                if (!seenIds.has(uniqueKey)) {
                    seenIds.add(uniqueKey);
                    uniqueResults.push(msg);
                }
            }

            console.log(`Found ${uniqueResults.length} unique results across ${selectedAccounts.length} account(s)`);
            return uniqueResults;
        }

        function buildSearchQueries(transaction) {
            const queries = [];
            const amount = parseAmount(transaction.spent || transaction.received);
            const date = new Date(transaction.date);

            // Date range: ¬±3 days from transaction date
            const afterDate = formatGmailDate(new Date(date.getTime() - 3 * 24 * 60 * 60 * 1000));
            const beforeDate = formatGmailDate(new Date(date.getTime() + 3 * 24 * 60 * 60 * 1000));

            // Extract merchant/vendor name from description
            const merchant = extractMerchantName(transaction.description);

            // Query 1: Merchant name + date range + common invoice keywords
            if (merchant) {
                queries.push(
                    `{from:${merchant} OR subject:${merchant}} ` +
                    `{invoice OR receipt OR order OR confirmation OR payment} ` +
                    `has:attachment filename:pdf ` +
                    `after:${afterDate} before:${beforeDate}`
                );
            }

            // Query 2: Amount-based search (format variations)
            const amountVariations = [
                amount.toFixed(2),
                '¬£' + amount.toFixed(2),
                amount.toFixed(2).replace('.', ',') // European format
            ];

            amountVariations.forEach(amt => {
                queries.push(
                    `{${amt}} ` +
                    `has:attachment filename:pdf ` +
                    `after:${afterDate} before:${beforeDate}`
                );
            });

            // Query 3: Description keywords + date
            const keywords = extractKeywords(transaction.description);
            if (keywords.length > 0) {
                queries.push(
                    `{${keywords.join(' OR ')}} ` +
                    `has:attachment filename:pdf ` +
                    `after:${afterDate} before:${beforeDate}`
                );
            }

            return queries.slice(0, 3); // Limit to first 3 queries to avoid too many searches
        }

        function extractMerchantName(description) {
            // Remove common payment processor prefixes
            let cleaned = description
                .replace(/^(CARD PAYMENT TO|PAYMENT TO|PURCHASE AT|POS|DEBIT CARD|PAYPAL|STRIPE)/i, '')
                .trim();

            // Extract first significant word(s)
            const words = cleaned.split(/\s+/).filter(w => w.length > 2);
            return words.slice(0, 2).join(' '); // First 2 words
        }

        function extractKeywords(description) {
            const stopWords = ['the', 'and', 'to', 'at', 'from', 'for', 'on', 'in', 'card', 'payment'];
            return description.toLowerCase()
                .split(/\s+/)
                .filter(word => word.length > 3 && !stopWords.includes(word))
                .slice(0, 5); // Top 5 keywords
        }

        function formatGmailDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        async function searchGmail(query, accessToken) {
            try {
                // Set the access token for this request
                gapi.client.setToken({ access_token: accessToken });

                const response = await gapi.client.gmail.users.messages.list({
                    userId: 'me',
                    q: query,
                    maxResults: 10
                });

                return response.result.messages || [];
            } catch (error) {
                console.error('Gmail search error:', error);
                return [];
            }
        }

        async function extractPDFsFromEmail(messageId, accessToken) {
            try {
                // Set the access token for this request
                gapi.client.setToken({ access_token: accessToken });

                const response = await gapi.client.gmail.users.messages.get({
                    userId: 'me',
                    id: messageId,
                    format: 'full'
                });

                const message = response.result;
                const pdfs = [];

                // Parse email parts recursively
                function extractAttachments(parts) {
                    if (!parts) return;

                    parts.forEach(part => {
                        if (part.mimeType === 'application/pdf') {
                            pdfs.push({
                                filename: part.filename,
                                attachmentId: part.body.attachmentId,
                                size: part.body.size,
                                messageId: messageId
                            });
                        }

                        if (part.parts) {
                            extractAttachments(part.parts);
                        }
                    });
                }

                extractAttachments(message.payload.parts);
                return pdfs;
            } catch (error) {
                console.error('Error extracting PDFs:', error);
                return [];
            }
        }

        async function downloadPDFAttachment(messageId, attachmentId, accessToken) {
            try {
                // Set the access token for this request
                gapi.client.setToken({ access_token: accessToken });

                const response = await gapi.client.gmail.users.messages.attachments.get({
                    userId: 'me',
                    messageId: messageId,
                    id: attachmentId
                });

                // Gmail returns data in URL-safe base64 format
                const data = response.result.data
                    .replace(/-/g, '+')
                    .replace(/_/g, '/');

                // Convert base64 to Blob
                const binaryString = atob(data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                return new Blob([bytes], { type: 'application/pdf' });
            } catch (error) {
                console.error('Error downloading attachment:', error);
                return null;
            }
        }

        // ========================================
        // PDF STORAGE IN INDEXEDDB
        // ========================================

        async function saveInvoiceToDB(transactionIndex, pdfBlob, filename, messageId = null) {
            if (!db) await initIndexedDB();

            const invoiceData = {
                transactionIndex: transactionIndex,
                filename: filename,
                pdfBlob: pdfBlob,
                size: pdfBlob.size,
                uploadDate: new Date().toISOString(),
                source: messageId ? 'gmail' : 'manual',
                gmailMessageId: messageId,
                extractedText: null,
                aiDescription: null
            };

            try {
                const transaction = db.transaction([INVOICES_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(INVOICES_STORE_NAME);
                const request = store.add(invoiceData);

                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        console.log('Invoice saved with ID:', request.result);
                        resolve(request.result);
                    };
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                console.error('Error saving invoice:', error);
                return null;
            }
        }

        async function getInvoicesForTransaction(transactionIndex) {
            if (!db) await initIndexedDB();

            try {
                const transaction = db.transaction([INVOICES_STORE_NAME], 'readonly');
                const store = transaction.objectStore(INVOICES_STORE_NAME);
                const index = store.index('transactionIndex');
                const request = index.getAll(transactionIndex);

                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                console.error('Error getting invoices:', error);
                return [];
            }
        }

        async function updateInvoiceText(invoiceId, text) {
            if (!db) await initIndexedDB();

            try {
                const transaction = db.transaction([INVOICES_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(INVOICES_STORE_NAME);
                const getRequest = store.get(invoiceId);

                getRequest.onsuccess = () => {
                    const invoice = getRequest.result;
                    if (invoice) {
                        invoice.extractedText = text;
                        store.put(invoice);
                    }
                };
            } catch (error) {
                console.error('Error updating invoice text:', error);
            }
        }

        async function updateInvoiceWithAIDescription(invoiceId, description) {
            if (!db) await initIndexedDB();

            try {
                const transaction = db.transaction([INVOICES_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(INVOICES_STORE_NAME);
                const getRequest = store.get(invoiceId);

                getRequest.onsuccess = () => {
                    const invoice = getRequest.result;
                    if (invoice) {
                        invoice.aiDescription = description;
                        store.put(invoice);
                    }
                };
            } catch (error) {
                console.error('Error updating invoice:', error);
            }
        }

        // ========================================
        // PDF TEXT EXTRACTION (PDF.js + OCR)
        // ========================================

        async function extractTextFromPDF(pdfBlob) {
            try {
                const arrayBuffer = await pdfBlob.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                let fullText = '';
                const totalPages = pdf.numPages;

                console.log(`Processing PDF with ${totalPages} page(s)...`);

                for (let pageNum = 1; pageNum <= Math.min(totalPages, 5); pageNum++) { // Limit to first 5 pages
                    const page = await pdf.getPage(pageNum);

                    // Try text extraction first (for text-based PDFs)
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');

                    if (pageText.trim().length > 50) {
                        // Text-based PDF
                        fullText += `\n--- Page ${pageNum} ---\n` + pageText;
                    } else {
                        // Scanned PDF - use OCR
                        fullText += `\n--- Page ${pageNum} (OCR) ---\n`;
                        const ocrText = await performOCR(page);
                        fullText += ocrText;
                    }
                }

                return fullText.trim();
            } catch (error) {
                console.error('PDF extraction error:', error);
                showToast('‚ùå Failed to extract text from PDF', 'error');
                return null;
            }
        }

        async function performOCR(pdfPage) {
            try {
                const viewport = pdfPage.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                await pdfPage.render({ canvasContext: context, viewport: viewport }).promise;

                // Perform OCR on canvas
                const { data: { text } } = await Tesseract.recognize(
                    canvas,
                    'eng',
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                console.log(`OCR progress: ${Math.round(m.progress * 100)}%`);
                            }
                        }
                    }
                );

                return text;
            } catch (error) {
                console.error('OCR error:', error);
                return '';
            }
        }

        // ========================================
        // AI DESCRIPTION GENERATION
        // ========================================

        async function generateDescriptionFromInvoice(invoiceText, transaction) {
            // Check for API key
            const apiKey = getOpenAIKey();
            if (!apiKey) {
                showToast('‚ùå OpenAI API Key required for AI description generation', 'error');
                return null;
            }

            const prompt = `You are a financial transaction classifier. Based on the invoice/receipt text below and the transaction details, generate a concise, descriptive summary (max 100 words) of what was purchased.

Transaction Details:
- Date: ${transaction.date}
- Amount: ¬£${transaction.spent || transaction.received}
- Original Description: ${transaction.description}

Invoice/Receipt Text:
${invoiceText.substring(0, 4000)}

Provide a clear summary focusing on:
1. What items/services were purchased
2. The vendor/merchant name
3. Any relevant details (quantities, categories)

Summary:`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            { role: 'system', content: 'You are a financial assistant that summarizes purchase invoices concisely.' },
                            { role: 'user', content: prompt }
                        ],
                        max_tokens: 200,
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API error: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content.trim();
            } catch (error) {
                console.error('AI description generation error:', error);
                showToast('‚ö†Ô∏è AI description generation failed', 'error');
                return null;
            }
        }

        // ========================================
        // INVOICE SEARCH UI HANDLERS
        // ========================================

        async function handleInvoiceFetch(index) {
            const transaction = allTransactions[index];
            currentInvoiceSearchIndex = index;

            // Check if Gmail is connected
            if (gmailAccounts.length === 0) {
                if (confirm('You need to connect your Gmail account first. Connect now?')) {
                    await signInToGmail();
                    // Wait a moment for auth to complete
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    if (gmailAccounts.length === 0) return;
                } else {
                    return;
                }
            }

            // Show modal with loading state
            document.getElementById('searchTransactionInfo').innerHTML = `
                <strong>${transaction.date}</strong> - ${escapeHtml(transaction.description)} -
                ¬£${transaction.spent || transaction.received}
            `;
            document.getElementById('invoiceSearchResults').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 40px;">‚è≥</div>
                    <div style="margin-top: 15px; color: #666;">Searching your Gmail...</div>
                </div>
            `;
            document.getElementById('invoiceSearchModal').classList.add('active');

            // Mark button as searching
            const btn = document.getElementById(`invoiceBtn${index}`);
            btn.classList.add('searching');
            btn.textContent = '‚è≥';

            try {
                // Search Gmail
                const messages = await searchEmailsForTransaction(transaction);

                if (messages.length === 0) {
                    document.getElementById('invoiceSearchResults').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 40px;">üì≠</div>
                            <div style="margin-top: 15px;">No matching invoices found</div>
                            <div style="font-size: 13px; margin-top: 10px;">Try uploading manually below</div>
                        </div>
                    `;
                    return;
                }

                // Display results
                await displayInvoiceSearchResults(messages, transaction);

            } catch (error) {
                console.error('Invoice search error:', error);
                showToast('‚ùå Failed to search for invoices', 'error');
                closeInvoiceSearchModal();
            } finally {
                btn.classList.remove('searching');
                btn.textContent = 'üìß';
            }
        }

        async function displayInvoiceSearchResults(messages, transaction) {
            const selectedCount = gmailAccounts.filter(acc => acc.selected).length;
            let html = `<div style="font-weight: 600; margin-bottom: 10px;">Found ${messages.length} potential match(es) across ${selectedCount} account(s):</div>`;

            for (const msg of messages) {
                try {
                    // Get the access token for this message's account
                    const account = gmailAccounts.find(acc => acc.email === msg.accountEmail);
                    if (!account) continue;

                    // Set the access token for Gmail API calls
                    gapi.client.setToken({ access_token: account.accessToken });

                    // Get full message details
                    const messageDetail = await gapi.client.gmail.users.messages.get({
                        userId: 'me',
                        id: msg.id,
                        format: 'metadata',
                        metadataHeaders: ['From', 'Subject', 'Date']
                    });

                    const headers = messageDetail.result.payload.headers;
                    const from = headers.find(h => h.name === 'From')?.value || 'Unknown';
                    const subject = headers.find(h => h.name === 'Subject')?.value || 'No Subject';
                    const date = headers.find(h => h.name === 'Date')?.value || '';

                    // Extract PDFs
                    const pdfs = await extractPDFsFromEmail(msg.id, account.accessToken);

                    html += `
                        <div class="invoice-result-card">
                            <div style="font-size: 12px; color: #3AAFA9; margin-bottom: 5px;">
                                <strong>Account:</strong> ${escapeHtml(msg.accountEmail)}
                            </div>
                            <div style="font-weight: 600; margin-bottom: 5px;">üìß ${escapeHtml(subject)}</div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 10px;">
                                <strong>From:</strong> ${escapeHtml(from)}<br>
                                <strong>Date:</strong> ${date}
                            </div>
                    `;

                    if (pdfs.length > 0) {
                        html += `<div style="margin-top: 10px;"><strong>Attachments (${pdfs.length}):</strong></div>`;
                        pdfs.forEach((pdf) => {
                            html += `
                                <button
                                    onclick="attachInvoiceToTransaction('${msg.id}', '${pdf.attachmentId}', '${escapeHtml(pdf.filename)}', ${currentInvoiceSearchIndex}, '${escapeHtml(msg.accountEmail)}')"
                                    class="modal-btn modal-btn-primary pdf-attachment-btn">
                                    üìé ${escapeHtml(pdf.filename)} (${formatFileSize(pdf.size)})
                                </button>
                            `;
                        });
                    } else {
                        html += `<div style="color: #999; font-style: italic;">No PDF attachments</div>`;
                    }

                    html += `</div>`;
                } catch (error) {
                    console.error('Error processing message:', msg.id, error);
                }
            }

            document.getElementById('invoiceSearchResults').innerHTML = html;
        }

        async function attachInvoiceToTransaction(messageId, attachmentId, filename, transactionIndex, accountEmail) {
            try {
                showToast('‚è≥ Downloading invoice...', 'info');

                // Get the access token for this account
                const account = gmailAccounts.find(acc => acc.email === accountEmail);
                if (!account) {
                    showToast('‚ùå Account not found', 'error');
                    return;
                }

                // Download PDF
                const pdfBlob = await downloadPDFAttachment(messageId, attachmentId, account.accessToken);
                if (!pdfBlob) {
                    showToast('‚ùå Failed to download invoice', 'error');
                    return;
                }

                // Save to IndexedDB
                const invoiceId = await saveInvoiceToDB(transactionIndex, pdfBlob, filename, messageId);

                // Extract text
                showToast('üìÑ Extracting text from invoice...', 'info');
                const extractedText = await extractTextFromPDF(pdfBlob);

                if (extractedText) {
                    // Update invoice with extracted text
                    await updateInvoiceText(invoiceId, extractedText);

                    // Generate AI description
                    showToast('ü§ñ Generating description...', 'info');
                    const aiDescription = await generateDescriptionFromInvoice(
                        extractedText,
                        allTransactions[transactionIndex]
                    );

                    if (aiDescription) {
                        await updateInvoiceWithAIDescription(invoiceId, aiDescription);

                        // Apply description to transaction
                        allTransactions[transactionIndex].manualDescription = aiDescription;
                        renderTransactions();
                    }
                }

                showToast('‚úÖ Invoice attached successfully!', 'success');
                closeInvoiceSearchModal();

                // Update button to show attachment
                const btn = document.getElementById(`invoiceBtn${transactionIndex}`);
                if (btn) {
                    btn.classList.add('invoice-attached');
                }

            } catch (error) {
                console.error('Error attaching invoice:', error);
                showToast('‚ùå Failed to attach invoice', 'error');
            }
        }

        async function handleManualInvoiceUpload() {
            const fileInput = document.getElementById('manualInvoiceUpload');
            const file = fileInput.files[0];

            if (!file || file.type !== 'application/pdf') {
                showToast('‚ùå Please select a PDF file', 'error');
                return;
            }

            if (currentInvoiceSearchIndex === null) {
                showToast('‚ùå No transaction selected', 'error');
                return;
            }

            try {
                showToast('‚è≥ Uploading invoice...', 'info');

                const pdfBlob = new Blob([await file.arrayBuffer()], { type: 'application/pdf' });
                const invoiceId = await saveInvoiceToDB(currentInvoiceSearchIndex, pdfBlob, file.name, null);

                // Extract and process
                showToast('üìÑ Extracting text from invoice...', 'info');
                const extractedText = await extractTextFromPDF(pdfBlob);

                if (extractedText) {
                    await updateInvoiceText(invoiceId, extractedText);

                    showToast('ü§ñ Generating description...', 'info');
                    const aiDescription = await generateDescriptionFromInvoice(
                        extractedText,
                        allTransactions[currentInvoiceSearchIndex]
                    );

                    if (aiDescription) {
                        await updateInvoiceWithAIDescription(invoiceId, aiDescription);
                        allTransactions[currentInvoiceSearchIndex].manualDescription = aiDescription;
                        renderTransactions();
                    }
                }

                showToast('‚úÖ Invoice uploaded successfully!', 'success');
                closeInvoiceSearchModal();

                const btn = document.getElementById(`invoiceBtn${currentInvoiceSearchIndex}`);
                if (btn) {
                    btn.classList.add('invoice-attached');
                }

            } catch (error) {
                console.error('Manual upload error:', error);
                showToast('‚ùå Failed to upload invoice', 'error');
            } finally {
                fileInput.value = ''; // Reset input
            }
        }

        function closeInvoiceSearchModal() {
            document.getElementById('invoiceSearchModal').classList.remove('active');
            currentInvoiceSearchIndex = null;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Close invoice modal when clicking outside
        document.getElementById('invoiceSearchModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeInvoiceSearchModal();
            }
        });

        // Initialize Google Auth when page loads
        window.addEventListener('load', () => {
            initializeGoogleAuth();
        });
    </script>
    </div>

    <!-- Keyboard Shortcuts Hint -->
    <div id="keyboardHint" class="keyboard-shortcut-hint" style="display: none;">
        <div style="font-weight: 600; margin-bottom: 6px;">‚å®Ô∏è Keyboard Shortcuts</div>
        <div style="font-size: 11px; opacity: 0.9;">
            <div>‚Üë‚Üì Navigate rows</div>
            <div><kbd style="background: rgba(255,255,255,0.2); padding: 2px 5px; border-radius: 3px;">A</kbd> Assign</div>
            <div><kbd style="background: rgba(255,255,255,0.2); padding: 2px 5px; border-radius: 3px;">Esc</kbd> Close</div>
            <div>Type letters to search</div>
        </div>
    </div>

    <script>
        // Show keyboard hint when user first interacts with keyboard
        let hintShown = false;
        document.addEventListener('keydown', function showHintOnce(e) {
            if (!hintShown && (e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'a' || e.key === 'A')) {
                const hint = document.getElementById('keyboardHint');
                hint.style.display = 'block';
                hint.classList.add('visible');
                hintShown = true;

                setTimeout(() => {
                    hint.classList.remove('visible');
                    setTimeout(() => {
                        hint.style.display = 'none';
                    }, 300);
                }, 4000);

                document.removeEventListener('keydown', showHintOnce);
            }
        });
    </script>
</body>
</html>
