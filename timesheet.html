<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labour</title>
    <!-- Google Fonts - PEBL Brand Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Roboto', sans-serif;
            font-weight: 300;
            background: linear-gradient(to bottom, #DEF2F1 0%, #ffffff 100%);
            min-height: 100vh;
        }

        /* Excel-like drag autofill styles */
        .drag-highlight {
            border: 2px solid #2196F3 !important;
        }

        .cell-drag-handle:hover {
            background: #1976D2 !important;
            transform: scale(1.2);
        }

        /* Navigation Banner */
        .nav-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%);
            padding: 15px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 0;
            z-index: 100;
        }
        .nav-banner h1 {
            color: white;
            font-size: 28px;
            font-weight: 700;
            margin: 0;
            font-family: 'Roboto', sans-serif;
            letter-spacing: 0.5px;
        }
        .nav-buttons {
            display: flex;
            gap: 8px;
        }
        .nav-btn {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
            display: inline-block;
        }
        .nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }
        .nav-btn.active {
            background-color: rgba(255, 255, 255, 0.9);
            color: #2B7A78;
            border-color: rgba(255, 255, 255, 0.9);
        }

        /* Tab Navigation */
        .tab-container {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #2B7A78;
        }
        .tab-btn {
            background: white;
            border: none;
            padding: 10px 24px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .tab-btn:hover {
            color: #2B7A78;
            background: #f5f5f5;
        }
        .tab-btn.active {
            color: #2B7A78;
            border-bottom-color: #2B7A78;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Paste selection highlight */
        .paste-selected {
            outline: 3px solid #2196F3 !important;
            outline-offset: -3px;
            background-color: #e3f2fd !important;
        }

        /* Content Container */
        .content-container {
            padding: 15px;
            max-width: 1400px;
            margin: 0 auto;
            padding-top: 80px;
        }

        /* Section Styles */
        .section {
            margin-bottom: 15px;
            padding: 12px;
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }

        .section h2 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 15px;
            color: #333;
            border-bottom: 2px solid #2196F3;
            padding-bottom: 6px;
            font-weight: 600;
        }

        /* System Prompt Section */
        .system-prompt-section {
            background-color: #e0f7fa;
            border-left: 3px solid #00acc1;
        }

        #systemPrompt {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            border: 1px solid #2196F3;
            border-radius: 4px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
            resize: vertical;
        }

        /* Staff Mapping Section */
        .staff-mapping-section {
            background-color: #f3e5f5;
            border-left: 3px solid #9c27b0;
        }

        .mapping-input-group {
            margin-bottom: 10px;
        }

        .mapping-input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 3px;
            color: #555;
            font-size: 13px;
        }

        .mapping-input-group input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
        }

        /* Forecast Data Section */
        .forecast-section {
            background-color: #fff3e0;
            border-left: 3px solid #ff9800;
        }

        .instructions {
            font-size: 11px;
            color: #666;
            margin-bottom: 6px;
        }

        #forecastInput {
            width: 100%;
            min-height: 80px;
            padding: 6px;
            border: 1px solid #ff9800;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            resize: vertical;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 11px;
        }

        .preview-table th,
        .preview-table td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: left;
        }

        .preview-table th {
            background-color: #2196F3;
            color: white;
            font-weight: 600;
        }

        .preview-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* Gantt Section */
        .gantt-section {
            background-color: #e8f5e9;
            border-left: 3px solid #4caf50;
        }

        .gantt-dropdown {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 6px;
        }

        .gantt-summary {
            background-color: white;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            border: 1px solid #ddd;
        }

        .gantt-summary h3 {
            margin-top: 0;
            margin-bottom: 6px;
            font-size: 14px;
            color: #4caf50;
        }

        .gantt-summary p {
            margin: 3px 0;
            font-size: 12px;
        }

        /* Generate Section */
        .generate-section {
            background-color: #e1f5fe;
            border-left: 3px solid #03a9f4;
        }

        .cost-estimate {
            background-color: white;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border: 2px solid #03a9f4;
            text-align: center;
        }

        .cost-estimate h3 {
            margin: 0 0 3px 0;
            font-size: 12px;
            color: #666;
        }

        .cost-amount {
            font-size: 20px;
            font-weight: bold;
            color: #0277bd;
            margin: 0;
        }

        /* Output Section */
        .output-section {
            background-color: #fce4ec;
            border-left: 3px solid #e91e63;
        }

        .timesheet-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-top: 8px;
        }

        .timesheet-table th,
        .timesheet-table td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: left;
        }

        .timesheet-table th {
            background-color: #e91e63;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .timesheet-table td {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        .timesheet-table td.editable {
            cursor: cell;
        }

        .timesheet-table td.editable:hover {
            background-color: #fff8e1;
            box-shadow: 0 0 0 1px #2196F3 inset;
        }

        .timesheet-table td.editing {
            cursor: text;
            outline: 2px solid #2196F3;
            background-color: #e3f2fd;
        }

        /* Selection highlighting for copying to Excel */
        .timesheet-table td::selection,
        .timesheet-table td *::selection {
            background-color: #2196F3;
            color: white;
        }

        .timesheet-table td::-moz-selection,
        .timesheet-table td *::-moz-selection {
            background-color: #2196F3;
            color: white;
        }

        .week-group {
            background-color: #f5f5f5;
        }

        /* Buttons */
        .btn {
            padding: 6px 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-primary {
            background-color: #2196F3;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #0b7dda;
        }

        .btn-success {
            background-color: #4CAF50;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #45a049;
        }

        .btn-warning {
            background-color: #FF9800;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background-color: #F57C00;
        }

        .btn-danger {
            background-color: #f44336;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #d32f2f;
        }

        .btn-info {
            background-color: #00BCD4;
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            background-color: #0097A7;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #323232;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            background-color: #4CAF50;
        }

        .toast.error {
            background-color: #f44336;
        }

        .toast.warning {
            background-color: #FF9800;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        /* Validation Warning */
        .validation-warning {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 12px;
            margin: 10px 0;
            color: #856404;
        }

        .validation-warning strong {
            display: block;
            margin-bottom: 5px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

    <!-- Automatic Cloud Backup System -->
    <script src="supabase-client.js"></script>
    <script src="auto-sync-manager.js"></script>
    <script src="sync-status-indicator.js"></script>
</head>
<body>
    <!-- Navigation Banner -->
    <div class="nav-banner">
        <h1>Labour</h1>
        <div class="nav-buttons">
            <a href="grants.html" class="nav-btn">Grants</a>
            <a href="spend.html" class="nav-btn">Spend</a>
            <a href="gantt.html" class="nav-btn">Gantt</a>
            <a href="timesheet.html" class="nav-btn active">Labour</a>
            <a href="index.html" class="nav-btn">Sketcher</a>
            <a href="exploit.html" class="nav-btn">Exploit</a>
            <a href="risks.html" class="nav-btn">Risks</a>
            <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="nav-btn" style="background-color: rgba(255, 255, 255, 0.15); margin-left: auto;" title="Scroll to top">‚Üë Top</button>
        </div>
    </div>

    <div class="content-container">
        <!-- Tab Navigation -->
        <div class="tab-container">
            <button class="tab-btn" onclick="switchTab('timesheets')">Timesheets</button>
            <button class="tab-btn active" onclick="switchTab('allocation')">Labour Allocation</button>
        </div>

        <!-- Timesheets Tab -->
        <div id="timesheets-tab" class="tab-content">
        <!-- Section 1: System Prompt -->
        <div class="section system-prompt-section">
            <h2 onclick="toggleSystemPrompt()" style="cursor: pointer;">System Prompt <span id="promptToggle">‚ñº</span></h2>
            <textarea id="systemPrompt" style="display: none;" placeholder="Enter AI system prompt...">Generate technical work descriptions for weekly timesheets based on Gantt chart tasks.

Keep it simple and technical:
- Use plain language, no corporate jargon
- Avoid words like: "Focused on", "Conducted", "Executed", "Spearheaded"
- Focus on WHAT was done technically, not HOW it was managed
- Be specific: mention actual components, APIs, features, tests, bugs
- Vary the descriptions naturally - don't repeat phrases

Examples of good descriptions:
- "Built REST API endpoints for user authentication. Set up database schemas and migration scripts."
- "Fixed bugs in data processing pipeline. Added unit tests for edge cases."
- "Integrated third-party payment gateway. Updated documentation."

Examples to AVOID:
- "Focused on implementing key deliverables" (too vague)
- "Conducted extensive testing procedures" (too formal)
- "Executed project milestones successfully" (meaningless)

Return ONLY valid JSON:
{
  "weeks": [
    {
      "weekNum": 1,
      "description": "Built user authentication module. Wrote API docs."
    }
  ]
}

Do not include markdown, code blocks, or explanatory text.</textarea>
        </div>

        <!-- Section 2: Forecast Data -->
        <div class="section forecast-section">
            <h2>Forecast Data</h2>
            <p class="instructions">Paste tab-separated data (no headers)</p>

            <!-- Fixed Header Table -->
            <table class="preview-table" style="margin-bottom: 8px;">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Staff</th>
                        <th>Days</th>
                        <th>Rate</th>
                        <th>Hrs</th>
                        <th>Remaining</th>
                        <th>Spent</th>
                        <th>Ref</th>
                        <th>Cost</th>
                    </tr>
                </thead>
            </table>

            <!-- Paste Area -->
            <textarea id="forecastPasteArea" placeholder="Apr    Hardware / Lead / CW    7.92    162.00    63.33    0.00    63.33        1282.43" style="width: 100%; min-height: 80px; padding: 6px; border: 1px solid #ff9800; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 11px; resize: vertical; margin-bottom: 6px;"></textarea>

            <button class="btn btn-primary" onclick="parseForecastData()">Parse Forecast Data</button>

            <!-- Preview Table -->
            <div id="forecastPreview"></div>
        </div>

        <!-- Section 3: Load Gantt -->
        <div class="section gantt-section">
            <h2>Gantt</h2>

            <div style="margin-bottom: 8px;">
                <select id="ganttDropdown" class="gantt-dropdown">
                    <option value="">-- Select Gantt --</option>
                </select>
                <button class="btn btn-success" onclick="loadGanttProject()">Load</button>
                <button class="btn btn-info" onclick="document.getElementById('ganttFileInput').click()">JSON File</button>
                <input type="file" id="ganttFileInput" accept=".json" style="display:none" onchange="loadGanttFromFile(event)">
                <span id="selectedFileName" style="margin-left: 8px; color: #666; font-size: 11px;"></span>
            </div>
            
            <div id="ganttSummary"></div>
        </div>

        <!-- Section 4: Generate Timesheet -->
        <div class="section generate-section">
            <h2>Generate</h2>
            <div class="cost-estimate">
                <p class="cost-amount">$<span id="estimatedCost">0.00</span></p>
            </div>
            <button class="btn btn-success" id="generateBtn" onclick="generateTimesheets()">
                Generate
            </button>
        </div>

        <!-- Section 5: Processing Log -->
        <div class="section log-section">
            <h2>Log</h2>
            <div id="processingLog" style="background: #1e1e1e; color: #00ff00; padding: 8px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 10px; max-height: 200px; overflow-y: auto; white-space: pre-wrap;"></div>
        </div>

        <!-- Section 6: Timesheet Output -->
        <div class="section output-section">
            <h2>Output</h2>
            <div id="validationWarnings"></div>
            <div id="timesheetOutput">
                <p class="empty-state">Generate timesheet data to see output here.</p>
            </div>
        </div>

        <!-- Section 7: Export Options -->
        <div class="section">
            <h2>Export</h2>
            <button class="btn btn-info" onclick="copyForExcel()">Copy Weeks</button>
            <button class="btn btn-warning" onclick="downloadCSV()">CSV</button>
            <button class="btn btn-success" onclick="showHistory()">History</button>
            <button class="btn btn-danger" onclick="clearTimesheet()">Clear</button>
        </div>

        <!-- History Modal (hidden by default) -->
        <div id="historyModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
            <div style="background:white; margin:50px auto; padding:30px; max-width:800px; border-radius:8px; max-height:80vh; overflow-y:auto;">
                <h2>Generation History</h2>
                <div id="historyList"></div>
                <button class="btn btn-secondary" onclick="closeHistory()">Close</button>
            </div>
        </div>


        <!-- Section 8: Merge Payslips -->
        <div class="section" style="background-color: #e8f5e9; border-left: 3px solid #4caf50;">
            <h2>Merge Payslips</h2>

            <div style="margin-bottom: 8px;">
                <button class="btn btn-success" onclick="selectPayslipFolder()">üìÅ Folder</button>
                <span id="payslipFolderStatus" style="margin-left: 8px; color: #666; font-size: 11px;"></span>
            </div>

            <div style="margin-bottom: 8px; overflow-x: auto;">
                <div style="margin-bottom: 6px;">
                    <label style="font-weight: 500; font-size: 11px; margin-right: 6px;">Year:</label>
                    <select id="payslipYear" style="padding: 3px; font-size: 11px; border-radius: 3px; border: 1px solid #ccc;">
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
                <table style="border-collapse: collapse; width: 100%; font-size: 11px;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Member</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Jan</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Feb</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Mar</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Apr</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">May</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Jun</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Jul</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Aug</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Sep</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Oct</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Nov</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Dec</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 4px; font-weight: 500;">CW - Craig</td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CW" data-month="01"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CW" data-month="02"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CW" data-month="03"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CW" data-month="04"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CW" data-month="05"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CW" data-month="06"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CW" data-month="07"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CW" data-month="08"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CW" data-month="09"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CW" data-month="10"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CW" data-month="11"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CW" data-month="12"></td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 4px; font-weight: 500;">CB - Christian</td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CB" data-month="01"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CB" data-month="02"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CB" data-month="03"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CB" data-month="04"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CB" data-month="05"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CB" data-month="06"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CB" data-month="07"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CB" data-month="08"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CB" data-month="09"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CB" data-month="10"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CB" data-month="11"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="CB" data-month="12"></td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 4px; font-weight: 500;">JG - Jack</td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="JG" data-month="01"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="JG" data-month="02"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="JG" data-month="03"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="JG" data-month="04"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="JG" data-month="05"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="JG" data-month="06"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="JG" data-month="07"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="JG" data-month="08"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="JG" data-month="09"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="JG" data-month="10"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="JG" data-month="11"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="JG" data-month="12"></td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 4px; font-weight: 500;">AK - Anjali</td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="AK" data-month="01"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="AK" data-month="02"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="AK" data-month="03"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="AK" data-month="04"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="AK" data-month="05"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="AK" data-month="06"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="AK" data-month="07"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="AK" data-month="08"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="AK" data-month="09"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="AK" data-month="10"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="AK" data-month="11"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="AK" data-month="12"></td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 4px; font-weight: 500;">HM - Huw</td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="HM" data-month="01"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="HM" data-month="02"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="HM" data-month="03"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="HM" data-month="04"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="HM" data-month="05"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="HM" data-month="06"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="HM" data-month="07"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="HM" data-month="08"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="HM" data-month="09"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="HM" data-month="10"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="HM" data-month="11"></td>
                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;"><input type="checkbox" data-member="HM" data-month="12"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-bottom: 6px;">
                <button class="btn btn-primary" id="fetchPayslipsBtn" onclick="fetchPayslips()" disabled>Fetch</button>
                <button class="btn btn-success" id="mergePayslipsBtn" onclick="mergePayslips()" style="display: none;">Merge</button>
                <span id="payslipCount" style="margin-left: 8px; font-size: 11px; color: #666;"></span>
            </div>

            <div id="fetchedPayslipsDisplay" style="display: none; font-size: 11px;">
                <div id="fetchedPayslipsList"></div>
            </div>
        </div>

        </div> <!-- End Timesheets Tab -->

        <!-- Labour Allocation Tab -->
        <div id="allocation-tab" class="tab-content active">
            <div class="section">
                <h2>Labour Allocation</h2>

                <div style="margin-bottom: 10px;">
                    <button class="btn btn-success" onclick="addStaffRow()">+ Line</button>
                    <button class="btn btn-info" onclick="addProject()">+ Project</button>
                    <button class="btn btn-primary" onclick="showGrantLinkModal()" style="background: #2196F3; color: white;">üîó Link Grant</button>
                    <button class="btn btn-warning" onclick="showCopyMonthDialog()" style="background: #ff9800; color: white;">üìã Copy Month</button>
                    <button class="btn btn-secondary" onclick="showAllProjects()" style="background: #607D8B;">Show All</button>
                </div>

                <!-- Labour Budget Section -->
                <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <h3 style="margin: 0 0 15px 0; color: #1e40af; font-size: 16px;">üíº Labour Budget</h3>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: #374151;">Select Grant Project:</label>
                        <select id="budgetProjectSelect" onchange="loadProjectBudgetData()" style="width: 100%; max-width: 400px; padding: 8px; font-size: 14px; border: 1px solid #cbd5e1; border-radius: 4px;">
                            <option value="">-- Select a project --</option>
                        </select>
                    </div>

                    <div id="budgetTableContainer" style="display: none;">
                        <table id="labourBudgetTable" style="width: 100%; max-width: 800px; border-collapse: collapse; margin-bottom: 15px;">
                            <thead>
                                <tr style="background: #f1f5f9;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e2e8f0; font-size: 13px;">Role</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e2e8f0; font-size: 13px; width: 150px;">Day Rate (¬£/day)</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e2e8f0; font-size: 13px; width: 120px;">Days</th>
                                    <th style="padding: 8px; text-align: right; border: 1px solid #e2e8f0; font-size: 13px; width: 150px;">Total (¬£)</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e2e8f0; font-size: 13px; width: 60px;"></th>
                                </tr>
                            </thead>
                            <tbody id="labourBudgetTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 20px; color: #999;">Click "+ Add Row" to get started</td>
                                </tr>
                            </tbody>
                        </table>

                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button onclick="addBudgetRowNew()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">+ Add Row</button>
                            <button onclick="saveBudgetData()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">üíæ Save</button>
                        </div>

                        <!-- Labour Allocation Breakdown -->
                        <div id="labourAllocationBreakdown" style="margin-top: 20px; padding: 15px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 6px;">
                            <h4 style="margin: 0 0 15px 0; color: #166534; font-size: 14px;">üìä Allocation Breakdown (from Labour Table)</h4>
                            <div id="allocationBreakdownContent">
                                <!-- Breakdown will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Copy Month Dialog -->
                <div id="copyMonthDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 500px; width: 90%;">
                        <h3 style="margin-top: 0; color: #1e40af;">Copy Month Data</h3>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Select month to copy:</label>
                            <select id="copyMonthSelect" onchange="updateCopyMonthPreview()" style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #d1d5db; border-radius: 4px;">
                                <option value="">-- Select a month --</option>
                            </select>
                        </div>

                        <div id="copyMonthPreview" style="margin-bottom: 20px; padding: 15px; background: #f3f4f6; border-radius: 4px; display: none;">
                            <p style="margin: 0; color: #374151;"><strong>Preview:</strong></p>
                            <p id="copyMonthPreviewText" style="margin: 10px 0 0 0; color: #6b7280;"></p>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeCopyMonthDialog()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Cancel</button>
                            <button id="executeCopyBtn" onclick="executeCopyMonth()" disabled style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Copy</button>
                        </div>
                    </div>
                </div>

                <!-- Grant Link Modal -->
                <div id="grantLinkModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin-top: 0; color: #1e40af;">üîó Link Grant to Labour Allocation Project</h3>

                        <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
                            Select one grant from the left and one labour project from the right, then click "Link Selected"
                        </p>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <!-- Column 1: Grants from Database -->
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #374151; font-size: 14px;">üìä Grants (from Grants page)</h4>
                                <div id="grantListColumn" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px; background: #f9fafb;">
                                    <!-- Grants will be populated here -->
                                </div>
                                <p id="noGrantsMessage" style="text-align: center; color: #9ca3af; padding: 20px; font-size: 12px; display: none;">
                                    No grants found
                                </p>
                            </div>

                            <!-- Column 2: Labour Allocation Projects -->
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #374151; font-size: 14px;">üìã Labour Projects</h4>
                                <div id="labourProjectListColumn" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px; background: #f9fafb;">
                                    <!-- Labour projects will be populated here -->
                                </div>
                                <p id="noLabourProjectsMessage" style="text-align: center; color: #9ca3af; padding: 20px; font-size: 12px; display: none;">
                                    No labour projects found
                                </p>
                            </div>
                        </div>

                        <div style="padding: 15px; background: #f3f4f6; border-radius: 4px; margin-bottom: 20px;">
                            <div id="linkSelectionPreview" style="color: #6b7280; font-size: 13px;">
                                Please select one grant and one labour project
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeGrantLinkModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Cancel</button>
                            <button id="linkSelectedBtn" onclick="linkSelectedGrantAndProject()" disabled style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; opacity: 0.5;">Link Selected</button>
                        </div>
                    </div>
                </div>

                <!-- Labour Budget Summary Section (Collapsible) -->
                <div id="labourBudgetSection" style="display: none; margin-bottom: 20px; padding: 20px; background: #f8fafc; border: 2px solid #3b82f6; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #1e40af;" id="labourBudgetSectionTitle">Labour Budget Summary</h3>
                        <button onclick="closeLabourBudgetSection()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">Close</button>
                    </div>

                    <div id="labourBudgetSectionContent">
                        <!-- Step 1: Add Staff Member -->
                        <div id="addStaffSectionInline" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <h4 style="margin-top: 0; font-size: 14px;">Add Staff Member</h4>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="staffMemberSelectInline" style="flex: 1; padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;">
                                    <option value="">-- Select Staff Member --</option>
                                </select>
                                <button class="btn btn-primary" onclick="addStaffAllocationInline()" style="white-space: nowrap;">+ Add</button>
                            </div>
                        </div>

                        <!-- Staff Allocations List -->
                        <div id="staffAllocationsListInline" style="margin-bottom: 20px;">
                            <!-- Staff allocations will be added here dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Labour allocation table -->
                <div style="overflow-x: auto; max-height: 70vh; overflow-y: auto;">
                    <p style="font-size: 10px; color: #666; margin-bottom: 6px;">‚ìò Tip: Type = then click cells to add references. Hover cells for the drag handle (blue dot) to autofill formulas. All editable (yellow) cells support formulas!</p>
                    <table id="labourTable" style="border-collapse: collapse; font-size: 11px; width: 100%; min-width: 1400px;" tabindex="0">
                        <thead style="position: sticky; top: 0; z-index: 10; background: white;">
                            <tr id="columnLetterRow" style="background: #f5f5f5;">
                                <th style="border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; position: sticky; left: 0; z-index: 12; background: #f5f5f5;">A</th>
                                <th style="border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; position: sticky; left: 50px; z-index: 12; background: #f5f5f5;">B</th>
                                <th style="border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; background: #f5f5f5;">C</th>
                                <th style="border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; background: #f5f5f5;">D</th>
                                <th style="border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; background: #f5f5f5;">E</th>
                                <th style="border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; background: #f5f5f5;">F</th>
                                <th style="border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; background: #f5f5f5;">G</th>
                                <th style="border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; background: #f5f5f5;">H</th>
                                <!-- Project column letters will be added dynamically here -->
                            </tr>
                            <tr id="projectHeaderRow">
                                <th rowspan="2" style="border: 1px solid #ddd; padding: 2px; background: #2B7A78; color: white; min-width: 50px; width: 50px; max-width: 50px; position: sticky; left: 0; z-index: 12; font-size: 10px;">Month</th>
                                <th rowspan="2" style="border: 1px solid #ddd; padding: 2px; background: #2B7A78; color: white; min-width: 80px; width: 80px; max-width: 80px; position: sticky; left: 50px; z-index: 12; font-size: 10px;">Staff</th>
                                <th colspan="1" style="border: 1px solid #ddd; padding: 4px; background: #3AAFA9; color: white;">Payslip</th>
                                <th colspan="5" style="border: 1px solid #ddd; padding: 4px; background: #3AAFA9; color: white;">Pay Details</th>
                                <!-- Projects will be added dynamically here -->
                            </tr>
                            <tr id="columnHeaderRow">
                                <th style="border: 1px solid #ddd; padding: 4px; background: #5ec4be; color: white; font-size: 10px;">Gross</th>
                                <th style="border: 1px solid #ddd; padding: 4px; background: #5ec4be; color: white; font-size: 10px;">FTE</th>
                                <th style="border: 1px solid #ddd; padding: 2px; background: #5ec4be; color: white; font-size: 10px; max-width: 50px; width: 50px; overflow: hidden; text-overflow: clip;">¬£/yr (if full time)</th>
                                <th style="border: 1px solid #ddd; padding: 2px; background: #5ec4be; color: white; font-size: 10px; max-width: 50px; width: 50px; overflow: hidden; text-overflow: clip;">¬£/yr (as paid)</th>
                                <th onclick="configureDailyRate()" style="border: 1px solid #ddd; padding: 4px; background: #5ec4be; color: white; font-size: 10px; cursor: pointer; user-select: none;" title="Click to configure working days per year">¬£/day ‚öô</th>
                                <th onclick="configureHourlyRate()" style="border: 1px solid #ddd; padding: 4px; background: #5ec4be; color: white; font-size: 10px; cursor: pointer; user-select: none;" title="Click to configure hours per day">¬£/hr ‚öô</th>
                                <!-- Project columns will be added dynamically here -->
                            </tr>
                        </thead>
                        <tbody id="labourTableBody">
                            <!-- Rows will be added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


    <script>
        // API key from localStorage (user must set it)
        let API_KEY = localStorage.getItem('openai_api_key') || '';
        
        // Prompt for API key if not set
        if (!API_KEY) {
            const key = prompt('Please enter your OpenAI API key:\n(It will be saved in browser localStorage)');
            if (key) {
                localStorage.setItem('openai_api_key', key);
                API_KEY = key;
            }
        }

        // Data storage
        let forecastData = [];

        // Toggle system prompt visibility
        function toggleSystemPrompt() {
            const textarea = document.getElementById('systemPrompt');
            const toggle = document.getElementById('promptToggle');

            if (textarea.style.display === 'none') {
                textarea.style.display = 'block';
                toggle.textContent = '‚ñ≤';
            } else {
                textarea.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }

                // Processing log helper
        function log(message, type = 'info') {
            const logDiv = document.getElementById('processingLog');
            const colors = {
                info: '#00bfff',
                success: '#00ff00',
                warning: '#ffaa00',
                error: '#ff4444'
            };
            const color = colors[type] || colors.info;
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>
`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('processingLog').innerHTML = '';
        }

        // Parse month string to index (0-11)
        function parseMonthToIndex(monthStr) {
            const monthMap = {
                'jan': 0, 'january': 0,
                'feb': 1, 'february': 1,
                'mar': 2, 'march': 2,
                'apr': 3, 'april': 3,
                'may': 4,
                'jun': 5, 'june': 5,
                'jul': 7, 'july': 7,
                'aug': 8, 'august': 8,
                'sep': 9, 'september': 9,
                'oct': 10, 'october': 10,
                'nov': 11, 'november': 11,
                'dec': 12, 'december': 12
            };
            
            const lower = monthStr.toLowerCase().trim();
            
            // Check if it's already a month name
            if (monthMap[lower] !== undefined) {
                return monthMap[lower];
            }
            
            // Check if it's YYYY-MM format
            if (monthStr.includes('-')) {
                const parts = monthStr.split('-');
                return parseInt(parts[1]) - 1;
            }
            
            return -1;
        }

        // Get active tasks for a specific month
        function getActiveTasksForMonth(monthIndex) {
            if (!ganttData) return [];
            
            const activeTasks = [];
            ganttData.tasks.forEach((task, taskIndex) => {
                const key = `${taskIndex}-${monthIndex}`;
                if (ganttData.ganttData[key]) {
                    activeTasks.push(task);
                }
            });
            
            return activeTasks;
        }

        // Calculate proper In/Out times for weekly hours
        function calculateInOutTimes(weeklyHours) {
            const daysNeeded = Math.ceil(weeklyHours / 8);
            const result = [];
            
            let remainingHours = weeklyHours;
            
            for (let day = 0; day < daysNeeded && remainingHours > 0; day++) {
                const hoursThisDay = Math.min(8, remainingHours);
                
                // Calculate out time based on hours (8 hours = 9:00-17:00)
                const startHour = 9;
                const endHour = startHour + hoursThisDay;
                const inTime = `${startHour.toString().padStart(2, '0')}:00`;
                const outTime = `${endHour.toString().padStart(2, '0')}:00`;
                
                result.push({ in: inTime, out: outTime, hours: hoursThisDay });
                remainingHours -= hoursThisDay;
            }
            
            return result;
        }

        let ganttData = null;
        let timesheetData = [];

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // Remove active from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            if (tabName === 'timesheets') {
                document.getElementById('timesheets-tab').classList.add('active');
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            } else if (tabName === 'allocation') {
                document.getElementById('allocation-tab').classList.add('active');
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadGanttProjects();
            loadSystemPrompt();
            loadPayslipFolder();
        });

        // Save/Load system prompt from localStorage
        function loadSystemPrompt() {
            const saved = localStorage.getItem('timesheet_system_prompt');
            if (saved) {
                document.getElementById('systemPrompt').value = saved;
            }
        }

        function saveSystemPrompt() {
            const prompt = document.getElementById('systemPrompt').value;
            localStorage.setItem('timesheet_system_prompt', prompt);
        }

        // Parse forecast data from textarea
        function parseForecastData() {
            const input = document.getElementById('forecastPasteArea').value.trim();
            if (!input) {
                showToast('Please paste forecast data first', 'error');
                return;
            }

            const lines = input.split('\n').filter(line => line.trim() !== '');
            forecastData = [];

            lines.forEach(line => {
                const cols = line.split('\t');
                if (cols.length >= 5) {
                    forecastData.push({
                        month: cols[0].trim(),
                        staff: cols[1].trim(),
                        daysForecast: parseFloat(cols[2]) || 0,
                        ratePerDay: parseFloat(cols[3]) || 0,
                        hrsForecast: parseFloat(cols[4]) || 0,
                        hrsRemaining: parseFloat(cols[5]) || 0,
                        hrsSpent: parseFloat(cols[6]) || 0,
                        ref: cols[7] ? cols[7].trim() : '',
                        costPerMonth: parseFloat(cols[8]) || 0
                    });
                }
            });

            if (forecastData.length === 0) {
                showToast('No valid forecast data found. Check format.', 'error');
                return;
            }

            displayForecastPreview();
            updateCostEstimate();
            showToast(`Parsed ${forecastData.length} forecast entries`, 'success');
        }

        // Display forecast preview table
        function displayForecastPreview() {
            const preview = document.getElementById('forecastPreview');

            let html = '<table class="preview-table" style="margin-top: 8px;">';
            html += '<thead><tr><th>Month</th><th>Staff</th><th>Hrs</th></tr></thead>';
            html += '<tbody>';

            forecastData.forEach(item => {
                html += `<tr>
                    <td>${item.month}</td>
                    <td>${item.staff}</td>
                    <td style="background-color: #c8e6c9; font-weight: bold;">${item.hrsForecast}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            preview.innerHTML = html;
        }

        // Load Gantt projects from localStorage
        function loadGanttProjects() {
            const dropdown = document.getElementById('ganttDropdown');
            dropdown.innerHTML = '<option value="">-- Select a Gantt project --</option>';

            // Try both possible localStorage keys
            const savedProjects = JSON.parse(localStorage.getItem('peblgen_gantt_projects') || localStorage.getItem('ganttProjects') || '{}');

            for (const [name, project] of Object.entries(savedProjects)) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                dropdown.appendChild(option);
            }
        }

        // Load selected Gantt project
        function loadGanttProject() {
            const dropdown = document.getElementById('ganttDropdown');
            const projectName = dropdown.value;

            if (!projectName) {
                showToast('Please select a Gantt project', 'error');
                return;
            }

            const savedProjects = JSON.parse(localStorage.getItem('peblgen_gantt_projects') || localStorage.getItem('ganttProjects') || '{}');
            ganttData = savedProjects[projectName];

            if (!ganttData) {
                showToast('Project not found', 'error');
                return;
            }

            displayGanttSummary();
            updateCostEstimate();
            showToast(`Loaded Gantt project: ${projectName}`, 'success');
        }


        // Load Gantt from file
        function loadGanttFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    ganttData = JSON.parse(e.target.result);
                    
                    // Display the file name
                    document.getElementById('selectedFileName').textContent = `Loaded: ${file.name}`;
                    
                    displayGanttSummary();
                    updateCostEstimate();
                    showToast(`Loaded Gantt from file: ${file.name}`, 'success');
                    log(`Gantt loaded from file: ${file.name}`, 'success');
                } catch (error) {
                    showToast('Error loading JSON file: ' + error.message, 'error');
                    log('Error loading JSON file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);

            // Reset input so same file can be loaded again
            event.target.value = '';
        }

                // Display Gantt summary
        function displayGanttSummary() {
            const summary = document.getElementById('ganttSummary');

            if (!ganttData) {
                summary.innerHTML = '';
                return;
            }

            const activeTasks = ganttData.tasks.filter(task => {
                // Check if task has any active weeks
                for (const key in ganttData.ganttData) {
                    if (ganttData.ganttData[key] && key.startsWith(ganttData.tasks.indexOf(task) + '-')) {
                        return true;
                    }
                }
                return false;
            });

            let html = '<div class="gantt-summary">';
            html += `<h3>Project: ${ganttData.name}</h3>`;
            html += `<p><strong>Date Range:</strong> ${ganttData.startDate} to ${ganttData.endDate}</p>`;
            html += `<p><strong>Total Tasks:</strong> ${ganttData.tasks.length}</p>`;
            html += `<p><strong>Active Tasks:</strong> ${activeTasks.length}</p>`;

            if (activeTasks.length > 0) {
                html += '<p><strong>Active Task List:</strong></p><ul style="margin-left: 20px; font-size: 13px;">';
                activeTasks.forEach(task => {
                    html += `<li>${task.number} ${task.name}</li>`;
                });
                html += '</ul>';
            }

            html += '</div>';
            summary.innerHTML = html;
        }

        // Update cost estimate
        function updateCostEstimate() {
            const costElement = document.getElementById('estimatedCost');

            if (forecastData.length === 0) {
                costElement.textContent = '0.00';
                return;
            }

            // Estimate: ~$0.01 per timesheet entry (conservative estimate for GPT-4o)
            const estimatedCost = forecastData.length * 0.01;
            costElement.textContent = estimatedCost.toFixed(2);
        }

        // Generate timesheet descriptions using GPT-4o
        async function generateTimesheets() {
            if (forecastData.length === 0) {
                showToast('Please parse forecast data first', 'error');
                return;
            }

            if (!ganttData) {
                showToast('Please load a Gantt project first', 'error');
                return;
            }

            saveSystemPrompt();
            clearLog();
            log('=== Starting Timesheet Generation ===', 'info');

            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = 'Generating... <span class="spinner"></span>';

            timesheetData = [];
            let totalCost = 0;

            try {
                // Process each forecast entry
                for (const forecast of forecastData) {
                    log(`Processing: ${forecast.month} - ${forecast.staff}`, 'info');
                    
                    // Parse month to index
                    const monthIndex = parseMonthToIndex(forecast.month);
                    if (monthIndex === -1) {
                        log(`Warning: Could not parse month "${forecast.month}"`, 'warning');
                        continue;
                    }
                    
                    // Get active tasks for this month
                    const activeTasks = getActiveTasksForMonth(monthIndex);
                    log(`Found ${activeTasks.length} active tasks in ${forecast.month}`, 'info');
                    
                    if (activeTasks.length > 0) {
                        const taskNames = activeTasks.map(t => `${t.number}`).join(', ');
                        log(`Active tasks: ${taskNames}`, 'info');
                    }
                    
                    // Calculate weekly breakdown (assume ~4 weeks per month)
                    const weeksInMonth = 4;
                    const hoursPerWeek = forecast.hrsForecast / weeksInMonth;
                    log(`Hours breakdown: ${forecast.hrsForecast}hrs total / ${weeksInMonth} weeks = ${hoursPerWeek.toFixed(2)}hrs/week`, 'info');
                    
                    // Generate descriptions using GPT-4o
                    log('Calling GPT-4o...', 'info');
                    const result = await generateWeekDescriptions(forecast, activeTasks, monthIndex, hoursPerWeek);

                    if (result.success) {
                        timesheetData.push({
                            month: forecast.month,
                            staff: forecast.staff,
                            forecastHours: forecast.hrsForecast,
                            weeks: result.weeks
                        });
                        totalCost += result.cost;
                        log(`Success! Cost: $${result.cost.toFixed(4)}`, 'success');
                    } else {
                        log(`Error: ${result.error}`, 'error');
                    }

                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                log('=== Generation Complete ===', 'success');
                log(`Total timesheets: ${timesheetData.length}, Total cost: $${totalCost.toFixed(4)}`, 'success');
                
                displayTimesheetOutput();
                saveToHistory();
                showToast(`Generated ${timesheetData.length} timesheets. Total cost: $${totalCost.toFixed(4)}`, 'success');

            } catch (error) {
                log(`Fatal error: ${error.message}`, 'error');
                showToast('Error generating timesheets: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Generate Timesheet Descriptions';
            }
        }

        // DUAL-MODEL APPROACH: Small model for In/Out times, Large model for descriptions

        // Function 1: Calculate In/Out times using GPT-4o-mini (fast, cheap, accurate math)
        async function calculateInOutTimes(hoursPerWeek, weekNum) {
            const systemPrompt = `You are a timesheet time calculator. Calculate realistic work In/Out times that add up to the specified hours.

Rules:
- Standard workday: 9:00-17:00 (8 hours)
- Lunch not deducted from hours
- If hours = 40, that's 5 full days: "Mon-Fri 9:00-17:00"
- If hours = 24, that's 3 full days: "Mon-Wed 9:00-17:00"
- If hours = 14.5, that's Mon 9:00-17:00 (8h) + Tue 9:00-15:30 (6.5h)
- Be precise with the math - times MUST add up exactly

Return ONLY valid JSON:
{"inOut": "Mon 9:00-17:00, Tue 9:00-15:30"}`;

            const userMessage = `Calculate In/Out times for ${hoursPerWeek.toFixed(2)} hours in week ${weekNum}.

Examples:
- 40 hours = Mon-Fri 9:00-17:00
- 32 hours = Mon-Thu 9:00-17:00
- 24 hours = Mon-Wed 9:00-17:00
- 16 hours = Mon-Tue 9:00-17:00
- 8 hours = Mon 9:00-17:00
- 14.5 hours = Mon 9:00-17:00, Tue 9:00-15:30

Return JSON with exact In/Out times that sum to ${hoursPerWeek.toFixed(2)} hours.`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini', // Small, fast, cheap model for math
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userMessage }
                        ],
                        temperature: 0.3, // Low temperature for consistent math
                        max_tokens: 100
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to calculate In/Out times');
                }

                const data = await response.json();
                const content = data.choices[0].message.content.trim();
                const jsonContent = content.replace(/```json\n?/g, '').replace(/```\n?/g, '');
                const parsed = JSON.parse(jsonContent);

                // Calculate cost (GPT-4o-mini: ~$0.00015/1K input, ~$0.0006/1K output)
                const cost = (data.usage.prompt_tokens / 1000 * 0.00015) +
                            (data.usage.completion_tokens / 1000 * 0.0006);

                return {
                    success: true,
                    inOut: parsed.inOut || '',
                    cost: cost
                };

            } catch (error) {
                console.error('In/Out Calculation Error:', error);
                // Fallback to basic calculation
                const days = Math.ceil(hoursPerWeek / 8);
                const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
                const fallback = days >= 5 ? 'Mon-Fri 9:00-17:00' :
                               days === 1 ? `${dayNames[0]} 9:00-17:00` :
                               `${dayNames[0]}-${dayNames[days-1]} 9:00-17:00`;

                return {
                    success: true,
                    inOut: fallback,
                    cost: 0
                };
            }
        }

        // Function 2: Generate descriptions using GPT-4o (large, creative model)
        async function generateDescriptions(forecast, activeTasks, monthIndex) {
            const systemPrompt = document.getElementById('systemPrompt').value;

            // Build task list with deliverables highlighted
            const taskDescriptions = activeTasks.map(task => {
                if (task.deliverableCode) {
                    return `${task.number}: ${task.name} **(DELIVERABLE DUE!)**`;
                }
                return `${task.number}: ${task.name}`;
            }).join('\n');

            const userMessage = `Generate 4 weekly work descriptions for:
Staff: ${forecast.staff}
Month: ${forecast.month}
Role: ${forecast.staff.split('/').pop().trim()} (extract role from staff name)

ACTIVE TASKS THIS MONTH:
${taskDescriptions || 'No specific tasks active'}

Requirements:
- Generate 4 descriptions (week 1, 2, 3, 4)
- Keep it technical and specific
- Base descriptions on the ACTIVE TASKS listed
- Mention deliverables if marked
- Vary the language naturally
- NO corporate jargon

Return JSON:
{
  "weeks": [
    {"weekNum": 1, "description": "..."},
    {"weekNum": 2, "description": "..."},
    {"weekNum": 3, "description": "..."},
    {"weekNum": 4, "description": "..."}
  ]
}`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o', // Large model for creative descriptions
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userMessage }
                        ],
                        temperature: 0.7,
                        max_tokens: 800
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate descriptions');
                }

                const data = await response.json();
                const content = data.choices[0].message.content.trim();
                const jsonContent = content.replace(/```json\n?/g, '').replace(/```\n?/g, '');
                const parsed = JSON.parse(jsonContent);

                // Calculate cost (GPT-4o: ~$0.005/1K input, ~$0.015/1K output)
                const cost = (data.usage.prompt_tokens / 1000 * 0.005) +
                            (data.usage.completion_tokens / 1000 * 0.015);

                return {
                    success: true,
                    weeks: parsed.weeks || [],
                    cost: cost
                };

            } catch (error) {
                console.error('Description Generation Error:', error);
                return {
                    success: false,
                    error: error.message,
                    cost: 0
                };
            }
        }

        // Combined function: Run both models in parallel
        async function generateWeekDescriptions(forecast, activeTasks, monthIndex, hoursPerWeek) {
            log('Running dual-model generation (In/Out + Descriptions in parallel)...', 'info');

            try {
                // Run both models in PARALLEL using Promise.all
                const [descriptionsResult, ...inOutResults] = await Promise.all([
                    generateDescriptions(forecast, activeTasks, monthIndex),
                    calculateInOutTimes(hoursPerWeek, 1),
                    calculateInOutTimes(hoursPerWeek, 2),
                    calculateInOutTimes(hoursPerWeek, 3),
                    calculateInOutTimes(hoursPerWeek, 4)
                ]);

                if (!descriptionsResult.success) {
                    throw new Error(descriptionsResult.error);
                }

                // Combine results from both models
                const weeks = descriptionsResult.weeks.map((week, index) => {
                    return {
                        weekNum: week.weekNum,
                        inOut: inOutResults[index].inOut,
                        hours: hoursPerWeek,
                        description: week.description
                    };
                });

                // Calculate total cost
                const totalCost = descriptionsResult.cost +
                                 inOutResults.reduce((sum, r) => sum + r.cost, 0);

                log(`‚úì Descriptions: $${descriptionsResult.cost.toFixed(6)} (GPT-4o)`, 'success');
                log(`‚úì In/Out times: $${inOutResults.reduce((s,r) => s+r.cost, 0).toFixed(6)} (GPT-4o-mini)`, 'success');

                return {
                    success: true,
                    weeks: weeks,
                    cost: totalCost
                };

            } catch (error) {
                console.error('Combined Generation Error:', error);
                return {
                    success: false,
                    error: error.message,
                    cost: 0
                };
            }
        }

        // Display timesheet output table
        function displayTimesheetOutput() {
            const output = document.getElementById('timesheetOutput');

            if (timesheetData.length === 0) {
                output.innerHTML = '<p class="empty-state">No timesheet data to display.</p>';
                return;
            }

            let html = '<table class="timesheet-table">';
            html += '<thead><tr>';
            html += '<th>Forecast</th><th>Generated</th><th>Diff</th>'; // Validation columns
            html += '<th>Month</th><th>Staff</th>';
            html += '<th>Week 1 In/Out</th><th>Week 1 Hrs</th><th>Week 1 Description</th>';
            html += '<th>Week 2 In/Out</th><th>Week 2 Hrs</th><th>Week 2 Description</th>';
            html += '<th>Week 3 In/Out</th><th>Week 3 Hrs</th><th>Week 3 Description</th>';
            html += '<th>Week 4 In/Out</th><th>Week 4 Hrs</th><th>Week 4 Description</th>';
            html += '<th>Week 5 In/Out</th><th>Week 5 Hrs</th><th>Week 5 Description</th>';
            html += '</tr></thead><tbody>';

            timesheetData.forEach((entry, entryIndex) => {
                html += '<tr>';
                
                // Calculate generated hours
                const generatedHours = entry.weeks.reduce((sum, week) => {
                    const hours = parseFloat(week.hours) || 0;
                    return sum + hours;
                }, 0);
                
                const forecastHours = entry.forecastHours || 0;
                const diff = generatedHours - forecastHours;
                const diffPercent = forecastHours > 0 ? Math.abs(diff / forecastHours * 100) : 0;
                
                // Color code based on difference
                let bgcolor = '#c8e6c9'; // green
                if (diffPercent > 10) {
                    bgcolor = '#ffcdd2'; // red
                } else if (diffPercent > 5) {
                    bgcolor = '#fff9c4'; // yellow
                }
                
                html += `<td style="background:${bgcolor};font-weight:bold">${forecastHours.toFixed(2)}</td>`;
                html += `<td style="background:${bgcolor};font-weight:bold">${generatedHours.toFixed(2)}</td>`;
                html += `<td style="background:${bgcolor};font-weight:bold">${diff >= 0 ? '+' : ''}${diff.toFixed(2)}</td>`;
                
                html += `<td class="editable">${entry.month}</td>`;
                html += `<td class="editable">${entry.staff}</td>`;

                // Create array of 5 weeks
                const weeks = Array(5).fill(null).map((_, i) => {
                    return entry.weeks.find(w => w.weekNum === i + 1) || { inOut: '', hours: '', description: '' };
                });

                weeks.forEach((week, weekIndex) => {
                    html += `<td class="editable week-group">${week.inOut || ''}</td>`;
                    html += `<td class="editable week-group">${week.hours || ''}</td>`;
                    html += `<td class="editable week-group">${week.description || ''}</td>`;
                });

                html += '</tr>';
            });

            html += '</tbody></table>';
            output.innerHTML = html;
            
            // Add double-click event listeners to editable cells
            setTimeout(() => {
                const editableCells = document.querySelectorAll('.timesheet-table td.editable');
                editableCells.forEach(cell => {
                    cell.addEventListener('dblclick', function() {
                        this.contentEditable = true;
                        this.classList.add('editing');
                        this.focus();
                        
                        // Select all text
                        const range = document.createRange();
                        range.selectNodeContents(this);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    });
                    
                    cell.addEventListener('blur', function() {
                        this.contentEditable = false;
                        this.classList.remove('editing');
                    });
                    
                    cell.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.blur();
                        } else if (e.key === 'Escape') {
                            this.blur();
                        }
                    });
                });
            }, 0);
        }

        // Validate timesheet hours against forecast
        function validateTimesheet() {
            const warnings = document.getElementById('validationWarnings');
            const warningList = [];

            timesheetData.forEach(entry => {
                const forecast = forecastData.find(f => f.month === entry.month && f.staff === entry.staff);
                if (!forecast) return;

                const totalHours = entry.weeks.reduce((sum, week) => sum + (parseFloat(week.hours) || 0), 0);
                const difference = Math.abs(totalHours - forecast.hrsForecast);
                const percentDiff = (difference / forecast.hrsForecast) * 100;

                if (percentDiff > 10) {
                    warningList.push({
                        staff: entry.staff,
                        month: entry.month,
                        forecast: forecast.hrsForecast,
                        actual: totalHours,
                        diff: percentDiff.toFixed(1)
                    });
                }
            });

            if (warningList.length > 0) {
                let html = '<div class="validation-warning">';
                html += '<strong>Warning: Hour Mismatch Detected</strong>';
                warningList.forEach(w => {
                    html += `<div>${w.staff} (${w.month}): Forecast ${w.forecast}hrs, Generated ${w.actual}hrs (${w.diff}% difference)</div>`;
                });
                html += '</div>';
                warnings.innerHTML = html;
            } else {
                warnings.innerHTML = '';
            }
        }

        // Copy to clipboard (tab-separated for Excel)
        function copyToClipboard() {
            if (timesheetData.length === 0) {
                showToast('No timesheet data to copy', 'error');
                return;
            }

            const table = document.querySelector('.timesheet-table');
            if (!table) return;

            let text = '';

            // Get headers
            const headers = table.querySelectorAll('thead th');
            headers.forEach((header, index) => {
                text += header.textContent;
                if (index < headers.length - 1) text += '\t';
            });
            text += '\n';

            // Get data rows
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                cells.forEach((cell, index) => {
                    text += cell.textContent;
                    if (index < cells.length - 1) text += '\t';
                });
                text += '\n';
            });

            navigator.clipboard.writeText(text).then(() => {
                showToast('Timesheet copied to clipboard (ready for Excel paste)', 'success');
            }).catch(err => {
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        // Download as CSV
        function downloadCSV() {
            if (timesheetData.length === 0) {
                showToast('No timesheet data to download', 'error');
                return;
            }

            const table = document.querySelector('.timesheet-table');
            if (!table) return;

            let csv = '';

            // Get headers
            const headers = table.querySelectorAll('thead th');
            headers.forEach((header, index) => {
                csv += '"' + header.textContent.replace(/"/g, '""') + '"';
                if (index < headers.length - 1) csv += ',';
            });
            csv += '\n';

            // Get data rows
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                cells.forEach((cell, index) => {
                    csv += '"' + cell.textContent.replace(/"/g, '""') + '"';
                    if (index < cells.length - 1) csv += ',';
                });
                csv += '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `timesheet_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);

            showToast('CSV downloaded successfully', 'success');
        }

        // Clear timesheet
        function clearTimesheet() {
            if (!confirm('Are you sure you want to clear all timesheet data?')) {
                return;
            }

            timesheetData = [];
            document.getElementById('timesheetOutput').innerHTML = '<p class="empty-state">Generate timesheet data to see output here.</p>';
            document.getElementById('validationWarnings').innerHTML = '';
            showToast('Timesheet cleared', 'success');
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Auto-save system prompt on change
        document.getElementById('systemPrompt').addEventListener('change', saveSystemPrompt);

        // Auto-save staff mappings on change

        // Copy for Excel (tab-separated)
        function copyForExcel() {
            if (timesheetData.length === 0) {
                showToast('No data to copy', 'error');
                return;
            }

            let text = '';

            timesheetData.forEach(entry => {
                const weeks = Array(5).fill(null).map((_, i) => {
                    return entry.weeks.find(w => w.weekNum === i + 1) || { inOut: '', hours: '', description: '' };
                });

                weeks.forEach((week, index) => {
                    text += week.inOut || '';
                    text += '\t';
                    text += week.hours || '';
                    text += '\t';
                    text += week.description || '';
                    if (index < weeks.length - 1) {
                        text += '\t';
                    }
                });

                text += '\n';
            });

            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied week data only', 'success');
            }).catch(err => {
                showToast('Copy failed: ' + err, 'error');
            });
        }

        // Save to history
        function saveToHistory() {
            const history = JSON.parse(localStorage.getItem('timesheetHistory') || '[]');
            const entry = {
                timestamp: new Date().toISOString(),
                data: timesheetData,
                forecastData: forecastData,
                ganttName: ganttData ? ganttData.name : 'Unknown'
            };
            
            history.unshift(entry);
            // Keep only last 10
            if (history.length > 10) {
                history.pop();
            }
            
            localStorage.setItem('timesheetHistory', JSON.stringify(history));
        }

        // Show history
        function showHistory() {
            const history = JSON.parse(localStorage.getItem('timesheetHistory') || '[]');
            const modal = document.getElementById('historyModal');
            const list = document.getElementById('historyList');

            if (history.length === 0) {
                list.innerHTML = '<p>No generation history found.</p>';
            } else {
                let html = '<table class="preview-table"><thead><tr><th>Date</th><th>Gantt</th><th>Entries</th><th>Actions</th></tr></thead><tbody>';
                
                history.forEach((entry, index) => {
                    const date = new Date(entry.timestamp).toLocaleString();
                    html += `<tr>
                        <td>${date}</td>
                        <td>${entry.ganttName}</td>
                        <td>${entry.data.length}</td>
                        <td>
                            <button class="btn btn-primary" onclick="loadHistory(${index})">Load</button>
                            <button class="btn btn-danger" onclick="deleteHistory(${index})">Delete</button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                list.innerHTML = html;
            }

            modal.style.display = 'block';
        }

        function closeHistory() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // ============================================
        // LABOUR BUDGET SUMMARY FUNCTIONALITY
        // ============================================

        let currentLabourBudgetProject = null;
        let staffAllocations = []; // Array to store staff allocations with their grant item assignments
        let labourBudgetStep = 1; // 1 = select project, 2 = select category, 3 = select item
        let selectedStaffMember = null;
        let selectedProjectForBudget = null;
        let selectedCategoryForBudget = null;

        function showLabourBudgetSummary(projectIdx) {
            try {
                console.log('üîµ showLabourBudgetSummary called! projectIdx:', projectIdx);
                console.log('üîµ labourProjects:', labourProjects);

                currentLabourBudgetProject = labourProjects[projectIdx];

                if (!currentLabourBudgetProject) {
                    console.error('‚ùå Project not found at index:', projectIdx);
                    alert('Project not found at index: ' + projectIdx);
                    return;
                }

                console.log('‚úÖ Found project:', currentLabourBudgetProject.name);
            } catch (error) {
                console.error('‚ùå‚ùå‚ùå ERROR in showLabourBudgetSummary (before steps):', error);
                alert('Error (1): ' + error.message);
                return;
            }

            try {

            // Close any existing budget panel
            console.log('üü° Step 1: Closing existing panel');
            closeInlineBudgetPanel();

            // Create or get the project's budget data
            console.log('üü° Step 2: Loading budget data');
            const projectKey = currentLabourBudgetProject.id || currentLabourBudgetProject.name;
            if (!currentLabourBudgetProject.budgetItems) {
                // Try to load from localStorage
                try {
                    const localData = localStorage.getItem(`project_budget_${projectKey}`);
                    currentLabourBudgetProject.budgetItems = localData ? JSON.parse(localData) : [];
                    console.log('Loaded budget items:', currentLabourBudgetProject.budgetItems);
                } catch (err) {
                    console.error('Error loading budget:', err);
                    currentLabourBudgetProject.budgetItems = [];
                }
            }

            // Calculate position above the project column
            console.log('üü° Step 3: Finding DOM elements');
            const projectHeaderRow = document.getElementById('projectHeaderRow');
            console.log('projectHeaderRow:', projectHeaderRow);

            const projectHeaders = projectHeaderRow.querySelectorAll('th[data-project-idx]');
            console.log('Found', projectHeaders.length, 'th elements with data-project-idx');

            const targetHeader = Array.from(projectHeaders).find(th =>
                parseInt(th.dataset.projectIdx) === projectIdx
            );
            console.log('targetHeader for idx', projectIdx, ':', targetHeader);

            if (!targetHeader) {
                console.error('‚ùå targetHeader not found!');
                alert('Could not find project header');
                return;
            }

            // Get position of the project header
            console.log('üü° Step 4: Calculating position');
            const rect = targetHeader.getBoundingClientRect();
            const tableContainer = document.querySelector('#labourTable').parentElement;
            const containerRect = tableContainer.getBoundingClientRect();
            const table = document.querySelector('#labourTable');
            const tableRect = table.getBoundingClientRect();
            console.log('rect:', rect);
            console.log('containerRect:', containerRect);
            console.log('tableRect:', tableRect);

            // Create inline budget panel - positioned above the table
            const panel = document.createElement('div');
            panel.id = 'inlineBudgetPanel';

            // Calculate position above the table, aligned with project column
            const topPosition = tableRect.top - containerRect.top + tableContainer.scrollTop - 220; // Above the table
            const leftPosition = rect.left - containerRect.left + tableContainer.scrollLeft;

            panel.style.cssText = `
                position: absolute;
                top: ${topPosition}px;
                left: ${leftPosition}px;
                width: 420px;
                background: white;
                border: 1.5px solid #3b82f6;
                border-radius: 4px;
                padding: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                z-index: 1000;
                font-size: 11px;
            `;

            // Build the panel content
            panel.innerHTML = `
                <div style="margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-weight: 600; color: #1e40af; font-size: 12px;">${currentLabourBudgetProject.name}</div>
                    <button onclick="closeInlineBudgetPanel()" style="background: #ef4444; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 11px; line-height: 1;">‚úï</button>
                </div>

                <table id="budgetItemsTable" style="width: 100%; border-collapse: collapse; margin-bottom: 6px; font-size: 11px;">
                    <thead>
                        <tr style="background: #f1f5f9;">
                            <th style="padding: 3px 4px; text-align: left; border: 1px solid #e2e8f0; font-size: 10px;">Role</th>
                            <th style="padding: 3px 4px; text-align: left; border: 1px solid #e2e8f0; font-size: 10px; width: 70px;">Rate (¬£)</th>
                            <th style="padding: 3px 4px; text-align: left; border: 1px solid #e2e8f0; font-size: 10px; width: 50px;">Days</th>
                            <th style="padding: 3px 4px; text-align: right; border: 1px solid #e2e8f0; font-size: 10px; width: 70px;">Total (¬£)</th>
                            <th style="padding: 3px 4px; text-align: center; border: 1px solid #e2e8f0; font-size: 10px; width: 24px;"></th>
                        </tr>
                    </thead>
                    <tbody id="budgetItemsBody">
                        ${renderBudgetItems(currentLabourBudgetProject.budgetItems)}
                    </tbody>
                </table>

                <div style="display: flex; gap: 6px;">
                    <button onclick="addBudgetRow()" style="background: #10b981; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">+ Row</button>
                    <button onclick="saveBudgetToDatabase()" style="background: #3b82f6; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">üíæ Save</button>
                </div>
            `;

            // Add to the table container (position relative)
            tableContainer.style.position = 'relative';
            tableContainer.appendChild(panel);

            // Store current project index
            window.currentBudgetProjectIdx = projectIdx;

            // Add click-outside-to-close functionality
            setTimeout(() => {
                document.addEventListener('click', handleOutsideClick);
            }, 100);

            console.log('‚úÖ‚úÖ‚úÖ Budget panel created successfully!');

            } catch (error) {
                console.error('‚ùå‚ùå‚ùå ERROR in showLabourBudgetSummary (main):', error);
                console.error('Error stack:', error.stack);
                alert('Error creating budget panel: ' + error.message);
            }
        }

        function handleOutsideClick(event) {
            const panel = document.getElementById('inlineBudgetPanel');
            if (panel && !panel.contains(event.target)) {
                // Check if the click was on a project header (to allow switching projects)
                const isProjectHeader = event.target.closest('[onclick*="showLabourBudgetSummary"]');
                if (!isProjectHeader) {
                    closeInlineBudgetPanel();
                    document.removeEventListener('click', handleOutsideClick);
                }
            }
        }

        function closeInlineBudgetPanel() {
            const existingPanel = document.getElementById('inlineBudgetPanel');
            if (existingPanel) {
                existingPanel.remove();
            }
            window.currentBudgetProjectIdx = null;
            document.removeEventListener('click', handleOutsideClick);
        }

        function renderBudgetItems(items) {
            if (!items || items.length === 0) {
                return '<tr><td colspan="5" style="text-align: center; padding: 8px; color: #999; font-size: 10px;">Click "+ Row"</td></tr>';
            }

            return items.map((item, idx) => {
                const total = (parseFloat(item.dayRate) || 0) * (parseFloat(item.days) || 0);
                return `
                    <tr>
                        <td style="padding: 2px 3px; border: 1px solid #e2e8f0;">
                            <input type="text" value="${item.role || ''}"
                                   onchange="updateBudgetItem(${idx}, 'role', this.value)"
                                   placeholder="Role"
                                   style="width: 100%; padding: 2px 3px; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 10px;">
                        </td>
                        <td style="padding: 2px 3px; border: 1px solid #e2e8f0;">
                            <input type="number" step="0.01" value="${item.dayRate || ''}"
                                   onchange="updateBudgetItem(${idx}, 'dayRate', this.value)"
                                   placeholder="0.00"
                                   style="width: 100%; padding: 2px 3px; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 10px;">
                        </td>
                        <td style="padding: 2px 3px; border: 1px solid #e2e8f0;">
                            <input type="number" step="0.1" value="${item.days || ''}"
                                   onchange="updateBudgetItem(${idx}, 'days', this.value)"
                                   placeholder="0"
                                   style="width: 100%; padding: 2px 3px; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 10px;">
                        </td>
                        <td style="padding: 2px 4px; border: 1px solid #e2e8f0; text-align: right; font-weight: 600; font-size: 10px;">
                            ¬£${total.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </td>
                        <td style="padding: 2px; border: 1px solid #e2e8f0; text-align: center;">
                            <button onclick="removeBudgetItem(${idx})"
                                    style="background: #ef4444; color: white; border: none; padding: 2px 4px; border-radius: 2px; cursor: pointer; font-size: 10px; line-height: 1;">√ó</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function addBudgetRow() {
            if (!currentLabourBudgetProject.budgetItems) {
                currentLabourBudgetProject.budgetItems = [];
            }

            currentLabourBudgetProject.budgetItems.push({
                role: '',
                dayRate: 0,
                days: 0
            });

            // Refresh the table
            refreshBudgetTable();
        }

        function updateBudgetItem(idx, field, value) {
            if (!currentLabourBudgetProject.budgetItems[idx]) return;

            if (field === 'role') {
                currentLabourBudgetProject.budgetItems[idx][field] = value;
            } else {
                currentLabourBudgetProject.budgetItems[idx][field] = parseFloat(value) || 0;
            }

            // Refresh the table to update totals
            refreshBudgetTable();
        }

        function removeBudgetItem(idx) {
            if (!currentLabourBudgetProject.budgetItems) return;

            currentLabourBudgetProject.budgetItems.splice(idx, 1);
            refreshBudgetTable();
        }

        function refreshBudgetTable() {
            const tbody = document.getElementById('budgetItemsBody');
            if (tbody && currentLabourBudgetProject) {
                tbody.innerHTML = renderBudgetItems(currentLabourBudgetProject.budgetItems);
            }
        }

        async function loadProjectBudget(projectKey) {
            try {
                // Try to load from Supabase first
                await ensureAuthenticated();
                const { data, error } = await supabaseClient
                    .from('labour_allocation')
                    .select('allocation_data')
                    .eq('user_id', currentUser.id)
                    .single();

                if (!error && data && data.allocation_data) {
                    const allBudgets = data.allocation_data;
                    if (allBudgets[projectKey]) {
                        return allBudgets[projectKey];
                    }
                }
            } catch (err) {
                console.log('Supabase load failed, trying localStorage:', err);
            }

            // Fallback to localStorage
            const localData = localStorage.getItem(`project_budget_${projectKey}`);
            if (localData) {
                return JSON.parse(localData);
            }

            return null;
        }

        async function saveBudgetToDatabase() {
            if (!currentLabourBudgetProject) {
                alert('No project data to save');
                return;
            }

            const projectKey = currentLabourBudgetProject.id || currentLabourBudgetProject.name;

            try {
                showToast('Saving budget...', 'info');

                // Save to localStorage first
                localStorage.setItem(
                    `project_budget_${projectKey}`,
                    JSON.stringify(currentLabourBudgetProject.budgetItems)
                );

                // Save to Supabase
                await ensureAuthenticated();

                // Load existing allocation data
                let allBudgets = {};
                const { data: existingData } = await supabaseClient
                    .from('labour_allocation')
                    .select('allocation_data')
                    .eq('user_id', currentUser.id)
                    .single();

                if (existingData && existingData.allocation_data) {
                    allBudgets = existingData.allocation_data;
                }

                // Update this project's budget
                allBudgets[projectKey] = currentLabourBudgetProject.budgetItems;

                // Upsert to Supabase
                const { error } = await supabaseClient
                    .from('labour_allocation')
                    .upsert({
                        user_id: currentUser.id,
                        allocation_data: allBudgets
                    }, {
                        onConflict: 'user_id'
                    });

                if (error) {
                    console.error('Supabase save error:', error);
                    showToast('‚ö†Ô∏è Saved locally, but cloud sync failed', 'warning');
                } else {
                    showToast('‚úÖ Budget saved successfully', 'success');
                }

                // Update the project in labourProjects array
                if (window.currentBudgetProjectIdx !== null) {
                    labourProjects[window.currentBudgetProjectIdx].budgetItems = currentLabourBudgetProject.budgetItems;
                }

            } catch (error) {
                console.error('Error saving budget:', error);
                alert('Failed to save budget: ' + error.message);
            }
        }

        function closeLabourBudgetSection() {
            document.getElementById('labourBudgetSection').style.display = 'none';
            currentLabourBudgetProject = null;
            staffAllocations = [];
            labourBudgetStep = 1;
            selectedStaffMember = null;
            selectedProjectForBudget = null;
            selectedCategoryForBudget = null;
        }

        // ============================================
        // NEW LABOUR BUDGET FUNCTIONS
        // ============================================

        let currentBudgetProject = null;
        let currentBudgetItems = [];

        // Populate the project dropdown with grant projects from database
        async function populateBudgetProjectDropdown() {
            const select = document.getElementById('budgetProjectSelect');
            if (!select) return;

            select.innerHTML = '<option value="">-- Select a project --</option>';

            try {
                // Load from IndexedDB
                await initializeGrantsDB();
                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');
                const allProjects = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                db.close();

                console.log('‚úÖ Loaded grant projects for budget dropdown:', allProjects.length);

                if (allProjects && allProjects.length > 0) {
                    allProjects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.projectId;
                        option.textContent = project.projectName || project.projectNumber || `Project ${project.projectId}`;
                        select.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '-- No grant projects found --';
                    option.disabled = true;
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('Error loading grant projects:', error);
                showToast('Failed to load grant projects', 'error');
            }
        }

        // Load budget data for the selected project
        async function loadProjectBudgetData() {
            const select = document.getElementById('budgetProjectSelect');
            const projectId = select.value;

            console.log('üìÇ Loading budget for projectId:', projectId);

            if (!projectId) {
                document.getElementById('budgetTableContainer').style.display = 'none';
                currentBudgetProject = null;
                currentBudgetItems = [];
                return;
            }

            try {
                // Load project from IndexedDB
                await initializeGrantsDB();
                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');
                const project = await new Promise((resolve, reject) => {
                    const request = store.get(projectId);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                db.close();

                console.log('üì¶ Retrieved from IndexedDB:', project);

                // If project not found, create a minimal object
                if (!project) {
                    console.warn('‚ö†Ô∏è Project not found in database, creating minimal object');
                    currentBudgetProject = {
                        projectId: projectId,
                        projectName: select.options[select.selectedIndex].text,
                        budgetItems: []
                    };
                } else {
                    currentBudgetProject = project;
                }

                currentBudgetItems = currentBudgetProject.budgetItems || [];

                console.log('‚úÖ currentBudgetProject:', currentBudgetProject);
                console.log('‚úÖ currentBudgetItems:', currentBudgetItems);

                // Show the table
                document.getElementById('budgetTableContainer').style.display = 'block';

                // Render the budget items
                renderBudgetTableNew();

                // Calculate and display allocation breakdown
                calculateAllocationBreakdown(projectId);

            } catch (error) {
                console.error('‚ùå Error loading project budget:', error);
                showToast('Failed to load project budget', 'error');
            }
        }

        // Calculate allocation breakdown from labour table
        function calculateAllocationBreakdown(grantProjectId) {
            const breakdownContent = document.getElementById('allocationBreakdownContent');
            if (!breakdownContent) return;

            // Find which labour project is linked to this grant
            const linkedProjectIdx = labourProjects.findIndex(p => p.grantProjectId == grantProjectId);

            if (linkedProjectIdx === -1) {
                breakdownContent.innerHTML = `
                    <p style="color: #9ca3af; font-size: 13px; margin: 0;">
                        ‚ÑπÔ∏è No labour allocation project is linked to this grant. Use "üîó Link Grant" to connect them.
                    </p>
                `;
                return;
            }

            const linkedProject = labourProjects[linkedProjectIdx];

            // Scan all rows and collect allocations for this project
            const allocationsByRate = {};

            labourRows.forEach(row => {
                const projectAllocation = row.projects[linkedProjectIdx];
                if (!projectAllocation) return;

                const days = parseFloat(projectAllocation.days) || 0;
                const rate = parseFloat(projectAllocation.rate) || 0;

                if (days > 0 && rate > 0) {
                    const rateKey = rate.toFixed(2);
                    if (!allocationsByRate[rateKey]) {
                        allocationsByRate[rateKey] = {
                            rate: rate,
                            totalDays: 0,
                            totalCost: 0
                        };
                    }
                    allocationsByRate[rateKey].totalDays += days;
                    allocationsByRate[rateKey].totalCost += days * rate;
                }
            });

            // Get budget items from grant
            const budgetItems = currentBudgetItems || [];

            // Build the breakdown HTML
            if (Object.keys(allocationsByRate).length === 0) {
                breakdownContent.innerHTML = `
                    <p style="color: #9ca3af; font-size: 13px; margin: 0;">
                        No allocations found for "${linkedProject.name}" in the labour table.
                    </p>
                `;
                return;
            }

            let breakdownHTML = `
                <div style="margin-bottom: 10px;">
                    <strong style="color: #166534;">Linked Labour Project:</strong> ${linkedProject.name}
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <thead>
                        <tr style="background: #dcfce7;">
                            <th style="padding: 6px; text-align: left; border: 1px solid #86efac;">Rate (¬£/day)</th>
                            <th style="padding: 6px; text-align: right; border: 1px solid #86efac;">Allocated Days</th>
                            <th style="padding: 6px; text-align: right; border: 1px solid #86efac;">Allocated Cost</th>
                            <th style="padding: 6px; text-align: right; border: 1px solid #86efac;">Budgeted Days</th>
                            <th style="padding: 6px; text-align: right; border: 1px solid #86efac;">Budget Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Sort by rate
            const sortedRates = Object.keys(allocationsByRate).sort((a, b) => parseFloat(b) - parseFloat(a));

            sortedRates.forEach(rateKey => {
                const allocation = allocationsByRate[rateKey];

                // Find matching budget item(s) with this rate
                const matchingBudgetItems = budgetItems.filter(item =>
                    Math.abs(parseFloat(item.dayRate) - allocation.rate) < 0.01
                );

                const budgetedDays = matchingBudgetItems.reduce((sum, item) =>
                    sum + (parseFloat(item.days) || 0), 0
                );

                const remaining = budgetedDays - allocation.totalDays;
                const percentUsed = budgetedDays > 0 ? (allocation.totalDays / budgetedDays * 100) : 0;

                let statusColor = '#16a34a'; // green
                let statusText = `${remaining.toFixed(1)} days remaining`;

                if (percentUsed > 100) {
                    statusColor = '#dc2626'; // red
                    statusText = `‚ö†Ô∏è ${Math.abs(remaining).toFixed(1)} days over budget!`;
                } else if (percentUsed > 80) {
                    statusColor = '#f59e0b'; // orange
                    statusText = `${remaining.toFixed(1)} days remaining (${percentUsed.toFixed(0)}% used)`;
                }

                breakdownHTML += `
                    <tr>
                        <td style="padding: 6px; border: 1px solid #86efac; font-weight: 600;">¬£${allocation.rate.toFixed(2)}</td>
                        <td style="padding: 6px; border: 1px solid #86efac; text-align: right;">${allocation.totalDays.toFixed(1)}</td>
                        <td style="padding: 6px; border: 1px solid #86efac; text-align: right;">¬£${allocation.totalCost.toLocaleString('en-GB', { minimumFractionDigits: 2 })}</td>
                        <td style="padding: 6px; border: 1px solid #86efac; text-align: right;">${budgetedDays > 0 ? budgetedDays.toFixed(1) : 'N/A'}</td>
                        <td style="padding: 6px; border: 1px solid #86efac; text-align: right; color: ${statusColor}; font-weight: 600;">${budgetedDays > 0 ? statusText : 'No budget set'}</td>
                    </tr>
                `;
            });

            // Calculate totals
            const totalAllocatedDays = sortedRates.reduce((sum, key) => sum + allocationsByRate[key].totalDays, 0);
            const totalAllocatedCost = sortedRates.reduce((sum, key) => sum + allocationsByRate[key].totalCost, 0);
            const totalBudgetedDays = budgetItems.reduce((sum, item) => sum + (parseFloat(item.days) || 0), 0);
            const totalBudgetedCost = budgetItems.reduce((sum, item) => sum + ((parseFloat(item.dayRate) || 0) * (parseFloat(item.days) || 0)), 0);

            breakdownHTML += `
                    <tr style="background: #d1fae5; font-weight: 600;">
                        <td style="padding: 6px; border: 1px solid #86efac;">TOTAL</td>
                        <td style="padding: 6px; border: 1px solid #86efac; text-align: right;">${totalAllocatedDays.toFixed(1)}</td>
                        <td style="padding: 6px; border: 1px solid #86efac; text-align: right;">¬£${totalAllocatedCost.toLocaleString('en-GB', { minimumFractionDigits: 2 })}</td>
                        <td style="padding: 6px; border: 1px solid #86efac; text-align: right;">${totalBudgetedDays.toFixed(1)}</td>
                        <td style="padding: 6px; border: 1px solid #86efac; text-align: right; color: ${totalAllocatedCost > totalBudgetedCost ? '#dc2626' : '#16a34a'};">
                            ${totalBudgetedCost > 0 ? `¬£${(totalBudgetedCost - totalAllocatedCost).toLocaleString('en-GB', { minimumFractionDigits: 2 })} remaining` : 'N/A'}
                        </td>
                    </tr>
                </tbody>
                </table>
            `;

            breakdownContent.innerHTML = breakdownHTML;
        }

        // Render the budget table
        function renderBudgetTableNew() {
            const tbody = document.getElementById('labourBudgetTableBody');
            if (!tbody) return;

            if (!currentBudgetItems || currentBudgetItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">Click "+ Add Row" to get started</td></tr>';
                return;
            }

            tbody.innerHTML = currentBudgetItems.map((item, idx) => {
                const total = (parseFloat(item.dayRate) || 0) * (parseFloat(item.days) || 0);
                return `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">
                            <input type="text" value="${item.role || ''}"
                                   onchange="updateBudgetRowNew(${idx}, 'role', this.value)"
                                   placeholder="e.g., Project Manager"
                                   style="width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 13px;">
                        </td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">
                            <input type="number" step="0.01" value="${item.dayRate || ''}"
                                   onchange="updateBudgetRowNew(${idx}, 'dayRate', this.value)"
                                   placeholder="0.00"
                                   style="width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 13px;">
                        </td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">
                            <input type="number" step="0.5" value="${item.days || ''}"
                                   onchange="updateBudgetRowNew(${idx}, 'days', this.value)"
                                   placeholder="0"
                                   style="width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 13px;">
                        </td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right; font-weight: 600; font-size: 14px;">
                            ¬£${total.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: center;">
                            <button onclick="removeBudgetRowNew(${idx})"
                                    style="background: #ef4444; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Add a new budget row
        function addBudgetRowNew() {
            console.log('‚ûï addBudgetRowNew called');
            console.log('currentBudgetProject:', currentBudgetProject);
            console.log('currentBudgetItems:', currentBudgetItems);

            if (!currentBudgetProject) {
                console.error('‚ùå currentBudgetProject is null/undefined!');
                alert('Please select a project first');
                return;
            }

            currentBudgetItems.push({
                role: '',
                dayRate: 0,
                days: 0
            });

            console.log('‚úÖ Added new row, currentBudgetItems now:', currentBudgetItems);

            renderBudgetTableNew();
            showToast('Row added', 'info');
        }

        // Update a budget row
        function updateBudgetRowNew(idx, field, value) {
            if (!currentBudgetItems[idx]) return;

            if (field === 'role') {
                currentBudgetItems[idx][field] = value;
            } else {
                currentBudgetItems[idx][field] = parseFloat(value) || 0;
            }

            renderBudgetTableNew();
        }

        // Remove a budget row
        function removeBudgetRowNew(idx) {
            if (!currentBudgetItems) return;

            currentBudgetItems.splice(idx, 1);
            renderBudgetTableNew();
            showToast('Row removed', 'info');
        }

        // Save budget data to database
        async function saveBudgetData() {
            if (!currentBudgetProject) {
                alert('No project selected');
                return;
            }

            try {
                showToast('Saving budget...', 'info');

                // Update the project with budget items
                currentBudgetProject.budgetItems = currentBudgetItems;

                // Save to IndexedDB
                await initializeGrantsDB();
                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readwrite');
                const store = tx.objectStore('projects');
                await new Promise((resolve, reject) => {
                    const request = store.put(currentBudgetProject);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
                db.close();

                // Also save to Supabase
                try {
                    await ensureAuthenticated();
                    const { error } = await supabaseClient
                        .from('grants')
                        .upsert({
                            user_id: currentUser.id,
                            project_id: String(currentBudgetProject.projectId),
                            project_data: currentBudgetProject
                        }, {
                            onConflict: 'user_id,project_id'
                        });

                    if (error) {
                        console.error('Supabase save error:', error);
                        showToast('‚ö†Ô∏è Saved locally, but cloud sync failed', 'warning');
                    } else {
                        showToast('‚úÖ Budget saved successfully', 'success');
                    }
                } catch (err) {
                    console.error('Supabase error:', err);
                    showToast('‚ö†Ô∏è Saved locally, but cloud sync failed', 'warning');
                }

            } catch (error) {
                console.error('Error saving budget:', error);
                alert('Failed to save budget: ' + error.message);
            }
        }

        // Initialize budget dropdown on page load
        document.addEventListener('DOMContentLoaded', () => {
            populateBudgetProjectDropdown();
        });

        // ============================================
        // END NEW LABOUR BUDGET FUNCTIONS
        // ============================================


        async function populateStaffDropdown() {
            const select = document.getElementById('staffMemberSelect');
            if (!select) return;
            select.innerHTML = '<option value="">-- Select Staff Member --</option>';

            // Load staff from database
            if (staffDatabase && staffDatabase.length > 0) {
                staffDatabase.forEach(staff => {
                    const option = document.createElement('option');

                    // Handle both object format {initials, name} and string format
                    if (typeof staff === 'string') {
                        // Staff is a simple string (e.g., "CW" or "Christian Abulhawa")
                        option.value = staff;
                        option.textContent = staff;
                    } else {
                        // Staff is an object with initials and name
                        option.value = staff.initials || staff.name;
                        option.textContent = `${staff.initials} - ${staff.name}`;
                    }

                    select.appendChild(option);
                });
            } else {
                // If no staff in database, show message
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '-- Add staff in labour allocation table first --';
                option.disabled = true;
                select.appendChild(option);
            }
        }

        async function populateStaffDropdownInline() {
            const select = document.getElementById('staffMemberSelectInline');
            if (!select) return;
            select.innerHTML = '<option value="">-- Select Staff Member --</option>';

            // Load staff from database
            if (staffDatabase && staffDatabase.length > 0) {
                staffDatabase.forEach(staff => {
                    const option = document.createElement('option');

                    // Handle both object format {initials, name} and string format
                    if (typeof staff === 'string') {
                        // Staff is a simple string (e.g., "CW" or "Christian Abulhawa")
                        option.value = staff;
                        option.textContent = staff;
                    } else {
                        // Staff is an object with initials and name
                        option.value = staff.initials || staff.name;
                        option.textContent = `${staff.initials} - ${staff.name}`;
                    }

                    select.appendChild(option);
                });
            } else {
                // If no staff in database, show message
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '-- Add staff in labour allocation table first --';
                option.disabled = true;
                select.appendChild(option);
            }
        }

        function addStaffAllocation() {
            const select = document.getElementById('staffMemberSelect');
            if (!select) return;
            const staffValue = select.value;

            if (!staffValue) {
                alert('Please select a staff member');
                return;
            }

            const staffName = select.options[select.selectedIndex].text;

            // Check if staff member already added
            const existing = staffAllocations.find(s => s.staffInitials === staffValue);
            if (existing) {
                alert('This staff member is already in the list. You can edit their grant allocation below.');
                return;
            }

            // Add new staff allocation
            const newAllocation = {
                staffInitials: staffValue,
                staffName: staffName,
                grantCategory: null,
                grantItemKey: null,
                grantItemName: null,
                grantProjectId: null,
                grantProjectName: null,
                budgetAllocated: 0,
                totalClaimed: 0
            };

            staffAllocations.push(newAllocation);
            saveStaffAllocations();
            renderStaffAllocations();

            // Reset dropdown
            select.value = '';
        }

        function addStaffAllocationInline() {
            const select = document.getElementById('staffMemberSelectInline');
            if (!select) return;
            const staffValue = select.value;

            if (!staffValue) {
                alert('Please select a staff member');
                return;
            }

            const staffName = select.options[select.selectedIndex].text;

            // Check if staff member already added
            const existing = staffAllocations.find(s => s.staffInitials === staffValue);
            if (existing) {
                alert('This staff member is already in the list. You can edit their grant allocation below.');
                return;
            }

            // Add new staff allocation
            const newAllocation = {
                staffInitials: staffValue,
                staffName: staffName,
                grantCategory: null,
                grantItemKey: null,
                grantItemName: null,
                grantProjectId: null,
                grantProjectName: null,
                budgetAllocated: 0,
                totalClaimed: 0
            };

            staffAllocations.push(newAllocation);
            saveStaffAllocations();
            renderStaffAllocationsInline();

            // Reset dropdown
            select.value = '';
        }

        function renderStaffAllocations() {
            const container = document.getElementById('staffAllocationsList');
            container.innerHTML = '';

            if (staffAllocations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No staff members added yet. Add one above to get started.</p>';
                return;
            }

            staffAllocations.forEach((allocation, idx) => {
                const allocDiv = document.createElement('div');
                allocDiv.style.cssText = 'border: 1px solid #ddd; border-radius: 6px; padding: 15px; margin-bottom: 15px; background: white;';

                // Calculate total claimed from labour allocation table
                const projectKey = currentLabourBudgetProject.id || currentLabourBudgetProject.name;
                const totalClaimed = calculateTotalClaimedForStaff(allocation.staffInitials, projectKey);
                allocation.totalClaimed = totalClaimed;

                const hasGrantAssignment = allocation.grantCategory && allocation.grantItemKey;
                const budgetRemaining = allocation.budgetAllocated - totalClaimed;
                const percentageUsed = allocation.budgetAllocated > 0 ? (totalClaimed / allocation.budgetAllocated * 100).toFixed(1) : 0;

                allocDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <h4 style="margin: 0; font-size: 16px;">${allocation.staffName}</h4>
                                ${hasGrantAssignment ? `
                                    <label style="display: flex; align-items: center; gap: 5px; font-size: 11px; color: #666; cursor: pointer;">
                                        <input type="checkbox" id="showQuarterly_${idx}" onchange="toggleQuarterlyBreakdown(${idx})" style="cursor: pointer;">
                                        Show quarterly breakdown
                                    </label>
                                ` : ''}
                            </div>
                            ${hasGrantAssignment ? `
                                <div style="font-size: 12px; color: #666;">
                                    <strong>Assigned to:</strong> ${allocation.grantProjectName || 'Unknown Project'}<br>
                                    ${allocation.grantCategory} ‚Üí ${allocation.grantItemName}
                                </div>
                            ` : `
                                <div style="font-size: 12px; color: #f59e0b;">
                                    ‚ö†Ô∏è No grant item assigned yet
                                </div>
                            `}
                        </div>
                        <button onclick="removeStaffAllocation(${idx})" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
                    </div>

                    ${hasGrantAssignment ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div style="background: #e0f2fe; padding: 10px; border-radius: 4px;">
                                <div style="font-size: 11px; color: #0284c7; font-weight: 600;">BUDGET ALLOCATED</div>
                                <div style="font-size: 18px; font-weight: bold; color: #0c4a6e;">¬£${allocation.budgetAllocated.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div style="background: #fef3c7; padding: 10px; border-radius: 4px;">
                                <div style="font-size: 11px; color: #d97706; font-weight: 600;">TOTAL CLAIMED</div>
                                <div style="font-size: 18px; font-weight: bold; color: #92400e;">¬£${totalClaimed.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div style="background: ${budgetRemaining >= 0 ? '#d1fae5' : '#fee2e2'}; padding: 10px; border-radius: 4px;">
                                <div style="font-size: 11px; color: ${budgetRemaining >= 0 ? '#059669' : '#dc2626'}; font-weight: 600;">REMAINING</div>
                                <div style="font-size: 18px; font-weight: bold; color: ${budgetRemaining >= 0 ? '#065f46' : '#991b1b'};">¬£${budgetRemaining.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <div style="background: #e5e7eb; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #3b82f6, #8b5cf6); height: 100%; width: ${Math.min(percentageUsed, 100)}%; transition: width 0.3s;"></div>
                            </div>
                            <div style="font-size: 11px; color: #666; margin-top: 4px; text-align: center;">
                                ${percentageUsed}% of budget claimed
                            </div>
                        </div>
                    ` : ''}

                    ${hasGrantAssignment ? `
                        <div id="quarterlyBreakdown_${idx}" style="display: none; margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <!-- Quarterly breakdown will be inserted here -->
                        </div>
                    ` : ''}

                    <button onclick="assignGrantItem(${idx})" class="btn btn-primary" style="width: 100%; margin-top: 5px;">
                        ${hasGrantAssignment ? '‚úèÔ∏è Change Grant Assignment' : '‚ûï Assign to Grant Item'}
                    </button>
                `;

                container.appendChild(allocDiv);
            });
        }

        function renderStaffAllocationsInline() {
            const container = document.getElementById('staffAllocationsListInline');
            if (!container) return;
            container.innerHTML = '';

            if (staffAllocations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No staff members added yet. Add one above to get started.</p>';
                return;
            }

            staffAllocations.forEach((allocation, idx) => {
                const allocDiv = document.createElement('div');
                allocDiv.style.cssText = 'border: 1px solid #ddd; border-radius: 6px; padding: 15px; margin-bottom: 15px; background: white;';

                // Calculate total claimed from labour allocation table
                const projectKey = currentLabourBudgetProject.id || currentLabourBudgetProject.name;
                const totalClaimed = calculateTotalClaimedForStaff(allocation.staffInitials, projectKey);
                allocation.totalClaimed = totalClaimed;

                const hasGrantAssignment = allocation.grantCategory && allocation.grantItemKey;
                const budgetRemaining = allocation.budgetAllocated - totalClaimed;
                const percentageUsed = allocation.budgetAllocated > 0 ? (totalClaimed / allocation.budgetAllocated * 100).toFixed(1) : 0;

                allocDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <h4 style="margin: 0; font-size: 16px;">${allocation.staffName}</h4>
                                ${hasGrantAssignment ? `
                                    <label style="display: flex; align-items: center; gap: 5px; font-size: 11px; color: #666; cursor: pointer;">
                                        <input type="checkbox" id="showQuarterlyInline_${idx}" onchange="toggleQuarterlyBreakdown(${idx})" style="cursor: pointer;">
                                        Show quarterly breakdown
                                    </label>
                                ` : ''}
                            </div>
                            ${hasGrantAssignment ? `
                                <div style="font-size: 12px; color: #666;">
                                    <strong>Assigned to:</strong> ${allocation.grantProjectName || 'Unknown Project'}<br>
                                    ${allocation.grantCategory} ‚Üí ${allocation.grantItemName}
                                </div>
                            ` : `
                                <div style="font-size: 12px; color: #f59e0b;">
                                    ‚ö†Ô∏è No grant item assigned yet
                                </div>
                            `}
                        </div>
                        <button onclick="removeStaffAllocationInline(${idx})" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
                    </div>

                    ${hasGrantAssignment ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div style="background: #e0f2fe; padding: 10px; border-radius: 4px;">
                                <div style="font-size: 11px; color: #0284c7; font-weight: 600;">BUDGET ALLOCATED</div>
                                <div style="font-size: 18px; font-weight: bold; color: #0c4a6e;">¬£${allocation.budgetAllocated.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div style="background: #fef3c7; padding: 10px; border-radius: 4px;">
                                <div style="font-size: 11px; color: #d97706; font-weight: 600;">TOTAL CLAIMED</div>
                                <div style="font-size: 18px; font-weight: bold; color: #92400e;">¬£${totalClaimed.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div style="background: ${budgetRemaining >= 0 ? '#d1fae5' : '#fee2e2'}; padding: 10px; border-radius: 4px;">
                                <div style="font-size: 11px; color: ${budgetRemaining >= 0 ? '#059669' : '#dc2626'}; font-weight: 600;">REMAINING</div>
                                <div style="font-size: 18px; font-weight: bold; color: ${budgetRemaining >= 0 ? '#065f46' : '#991b1b'};">¬£${budgetRemaining.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <div style="background: #e5e7eb; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #3b82f6, #8b5cf6); height: 100%; width: ${Math.min(percentageUsed, 100)}%; transition: width 0.3s;"></div>
                            </div>
                            <div style="font-size: 11px; color: #666; margin-top: 4px; text-align: center;">
                                ${percentageUsed}% of budget claimed
                            </div>
                        </div>
                    ` : ''}

                    ${hasGrantAssignment ? `
                        <div id="quarterlyBreakdownInline_${idx}" style="display: none; margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <!-- Quarterly breakdown will be inserted here -->
                        </div>
                    ` : ''}

                    <button onclick="assignGrantItem(${idx})" class="btn btn-primary" style="width: 100%; margin-top: 5px;">
                        ${hasGrantAssignment ? '‚úèÔ∏è Change Grant Assignment' : '‚ûï Assign to Grant Item'}
                    </button>
                `;

                container.appendChild(allocDiv);
            });
        }

        function removeStaffAllocationInline(idx) {
            if (confirm(`Remove ${staffAllocations[idx].staffName} from this budget summary?`)) {
                staffAllocations.splice(idx, 1);
                saveStaffAllocations();
                renderStaffAllocationsInline();
            }
        }

        function calculateTotalClaimedForStaff(staffInitials, projectKey) {
            // Calculate total claimed from labour allocation table
            let total = 0;

            labourRows.forEach(row => {
                // Find the project column for this project (match by ID or name)
                const projectIdx = labourProjects.findIndex(p => (p.id && p.id === projectKey) || p.name === projectKey);
                if (projectIdx === -1) return;

                const projectData = row.projects[projectIdx];
                if (!projectData) return;

                // Check if this row belongs to the staff member
                // Match by staff initials (e.g., "CW", "CA") or full staff value
                if (row.staff && (row.staff === staffInitials || row.staff.startsWith(staffInitials + ' ') || row.staff.startsWith(staffInitials + '-'))) {
                    total += projectData.total || 0;
                }
            });

            return total;
        }

        async function toggleQuarterlyBreakdown(staffIdx) {
            const checkbox = document.getElementById(`showQuarterly_${staffIdx}`);
            const breakdownDiv = document.getElementById(`quarterlyBreakdown_${staffIdx}`);

            if (!checkbox || !breakdownDiv) return;

            if (checkbox.checked) {
                // Show quarterly breakdown
                breakdownDiv.style.display = 'block';
                await renderQuarterlyBreakdown(staffIdx);
            } else {
                // Hide quarterly breakdown
                breakdownDiv.style.display = 'none';
            }
        }

        async function renderQuarterlyBreakdown(staffIdx) {
            const allocation = staffAllocations[staffIdx];
            const breakdownDiv = document.getElementById(`quarterlyBreakdown_${staffIdx}`);

            if (!allocation || !breakdownDiv) return;

            // Load project data to get start date
            try {
                // Ensure database is initialized
                await initializeGrantsDB();

                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');

                // Wrap getAll() in a promise
                const allProjects = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                db.close();

                const grantProject = allProjects.find(p => p.projectId == allocation.grantProjectId);

                if (!grantProject) {
                    breakdownDiv.innerHTML = '<p style="color: #ef4444; font-size: 12px;">‚ö†Ô∏è Grant project not found</p>';
                    return;
                }

                const startMonth = grantProject.projectStartMonth || grantProject.financeSummary?.projectStartMonth;
                const startYear = grantProject.projectStartYear || grantProject.financeSummary?.projectStartYear;

                if (!startMonth || !startYear) {
                    breakdownDiv.innerHTML = '<p style="color: #ef4444; font-size: 12px;">‚ö†Ô∏è Project start date not set in grants page</p>';
                    return;
                }

                // Calculate quarterly totals
                const projectKey = currentLabourBudgetProject.id || currentLabourBudgetProject.name;
                const quarterlyData = calculateQuarterlyTotals(allocation.staffInitials, projectKey, startMonth, startYear);

                // Render quarterly breakdown table
                let html = `
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #334155;">Quarterly Breakdown</h4>
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: #e2e8f0;">
                                <th style="padding: 8px; text-align: left; border: 1px solid #cbd5e1;">Quarter</th>
                                <th style="padding: 8px; text-align: left; border: 1px solid #cbd5e1;">Period</th>
                                <th style="padding: 8px; text-align: right; border: 1px solid #cbd5e1;">Claimed</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                if (quarterlyData.length === 0) {
                    html += `
                        <tr>
                            <td colspan="3" style="padding: 15px; text-align: center; color: #94a3b8; border: 1px solid #cbd5e1;">
                                No labour allocations found for this staff member
                            </td>
                        </tr>
                    `;
                } else {
                    quarterlyData.forEach(quarter => {
                        html += `
                            <tr style="background: white;">
                                <td style="padding: 8px; border: 1px solid #cbd5e1; font-weight: 600;">Q${quarter.quarter}</td>
                                <td style="padding: 8px; border: 1px solid #cbd5e1; color: #64748b;">${quarter.period}</td>
                                <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: right; font-weight: 600; color: #0c4a6e;">
                                    ¬£${quarter.total.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                </td>
                            </tr>
                        `;
                    });

                    // Add total row
                    const grandTotal = quarterlyData.reduce((sum, q) => sum + q.total, 0);
                    html += `
                        <tr style="background: #f1f5f9; font-weight: bold;">
                            <td colspan="2" style="padding: 8px; border: 1px solid #cbd5e1;">TOTAL</td>
                            <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: right; color: #0c4a6e;">
                                ¬£${grandTotal.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                            </td>
                        </tr>
                    `;
                }

                html += `
                        </tbody>
                    </table>
                `;

                breakdownDiv.innerHTML = html;
            } catch (error) {
                console.error('Error rendering quarterly breakdown:', error);
                breakdownDiv.innerHTML = '<p style="color: #ef4444; font-size: 12px;">‚ö†Ô∏è Failed to load quarterly breakdown</p>';
            }
        }

        function calculateQuarterlyTotals(staffInitials, projectKey, startMonth, startYear) {
            // Group labour allocations by quarter
            const quarterTotals = new Map();

            labourRows.forEach(row => {
                // Check if this row belongs to the staff member
                if (!row.staff || !(row.staff === staffInitials || row.staff.startsWith(staffInitials + ' ') || row.staff.startsWith(staffInitials + '-'))) {
                    return;
                }

                // Find the project column (match by ID or name)
                const projectIdx = labourProjects.findIndex(p => (p.id && p.id === projectKey) || p.name === projectKey);
                if (projectIdx === -1) return;

                const projectData = row.projects[projectIdx];
                if (!projectData || !projectData.total) return;

                // Parse the month (YYYY-MM format)
                const monthStr = row.month;
                if (!monthStr || typeof monthStr !== 'string') return;

                const [yearStr, monthNumStr] = monthStr.split('-');
                const year = parseInt(yearStr);
                const month = parseInt(monthNumStr);

                if (isNaN(year) || isNaN(month)) return;

                // Calculate months since project start
                const monthsSinceStart = (year - startYear) * 12 + (month - startMonth);

                // Skip if before project start
                if (monthsSinceStart < 0) return;

                // Calculate quarter (1-based)
                const quarter = Math.floor(monthsSinceStart / 3) + 1;

                // Add to quarter total
                if (!quarterTotals.has(quarter)) {
                    // Calculate quarter period string
                    const quarterStartMonth = startMonth + (quarter - 1) * 3;
                    const quarterEndMonth = quarterStartMonth + 2;

                    const qStartYear = startYear + Math.floor((quarterStartMonth - 1) / 12);
                    const qStartMonth = ((quarterStartMonth - 1) % 12) + 1;
                    const qEndYear = startYear + Math.floor((quarterEndMonth - 1) / 12);
                    const qEndMonth = ((quarterEndMonth - 1) % 12) + 1;

                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const periodStr = `${monthNames[qStartMonth - 1]} ${qStartYear} - ${monthNames[qEndMonth - 1]} ${qEndYear}`;

                    quarterTotals.set(quarter, {
                        quarter: quarter,
                        period: periodStr,
                        total: 0
                    });
                }

                quarterTotals.get(quarter).total += projectData.total;
            });

            // Convert map to sorted array
            return Array.from(quarterTotals.values()).sort((a, b) => a.quarter - b.quarter);
        }

        function removeStaffAllocation(idx) {
            if (confirm(`Remove ${staffAllocations[idx].staffName} from this budget summary?`)) {
                staffAllocations.splice(idx, 1);
                saveStaffAllocations();
                renderStaffAllocations();
            }
        }

        function saveStaffAllocations() {
            if (currentLabourBudgetProject) {
                // Use project ID if available, otherwise use project name (backward compatibility)
                const projectKey = currentLabourBudgetProject.id || currentLabourBudgetProject.name;
                localStorage.setItem(
                    `labour_budget_allocations_${projectKey}`,
                    JSON.stringify(staffAllocations)
                );
            }
        }

        // ============================================
        // GRANT ITEM SELECTION (Similar to Spend Assignment)
        // ============================================

        async function assignGrantItem(staffIdx) {
            selectedStaffMember = staffAllocations[staffIdx];
            labourBudgetStep = 1;

            showToast('Loading grants data...', 'info');

            // Try to load grants - auto-sync from Supabase if needed
            try {
                const allProjects = await loadGrantsData();

                if (!allProjects || allProjects.length === 0) {
                    alert('‚ö†Ô∏è No grants found.\n\nPlease add grant projects in grants.html first, or check your cloud sync.');
                    return;
                }

                // Show project selection
                showGrantProjectSelection(allProjects);
                showToast(`Loaded ${allProjects.length} grant project(s)`, 'success');
            } catch (error) {
                console.error('Error loading grants:', error);
                alert('‚ö†Ô∏è Failed to load grants data.\n\nError: ' + error.message + '\n\nPlease check your internet connection and try again.');
            }
        }

        // Centralized function to load grants from Supabase + IndexedDB
        async function loadGrantsData() {
            console.log('[GRANTS SYNC] Loading grants data...');

            // Step 1: Ensure database is initialized
            await initializeGrantsDB();

            // Step 2: Try IndexedDB first (fast local cache)
            try {
                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');

                // Wrap getAll() in a promise
                const localProjects = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                db.close();

                if (localProjects && localProjects.length > 0) {
                    console.log(`[GRANTS SYNC] Found ${localProjects.length} projects in IndexedDB`);

                    // Also sync from Supabase in background (don't wait)
                    syncGrantsFromSupabase().catch(err => console.warn('[GRANTS SYNC] Background sync failed:', err));

                    return localProjects;
                }
            } catch (error) {
                console.warn('[GRANTS SYNC] IndexedDB read failed:', error);
            }

            // Step 3: IndexedDB empty or failed - fetch from Supabase
            console.log('[GRANTS SYNC] IndexedDB empty, fetching from Supabase...');
            return await syncGrantsFromSupabase();
        }

        // Fetch grants from Supabase and populate IndexedDB
        async function syncGrantsFromSupabase() {
            console.log('[GRANTS SYNC] Syncing from Supabase...');

            try {
                await ensureAuthenticated();

                // Fetch all grants from Supabase
                const { data: grantsData, error } = await supabaseClient
                    .from('grants')
                    .select('*')
                    .eq('user_id', currentUser.id);

                if (error) {
                    console.error('[GRANTS SYNC] Supabase error:', error);
                    throw new Error('Failed to fetch grants from cloud: ' + error.message);
                }

                if (!grantsData || grantsData.length === 0) {
                    console.log('[GRANTS SYNC] No grants found in Supabase');
                    return [];
                }

                console.log(`[GRANTS SYNC] Found ${grantsData.length} grants in Supabase`);

                // Parse and populate IndexedDB
                const projects = grantsData.map(grant => grant.project_data);

                // Create/update IndexedDB
                const db = await initializeGrantsDB();
                const tx = db.transaction('projects', 'readwrite');
                const store = tx.objectStore('projects');

                // Clear existing data
                await store.clear();

                // Add all projects
                for (const project of projects) {
                    await store.put(project);
                }

                await tx.complete;
                db.close();
                console.log(`[GRANTS SYNC] ‚úÖ Synced ${projects.length} projects to IndexedDB`);

                // Refresh budget project dropdown
                populateBudgetProjectDropdown();

                return projects;

            } catch (error) {
                console.error('[GRANTS SYNC] Sync failed:', error);
                throw error;
            }
        }

        // Initialize GrantsDB if it doesn't exist
        async function initializeGrantsDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('GrantsDB', 2);

                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };

                request.onerror = function(event) {
                    reject(new Error('Failed to open GrantsDB: ' + event.target.error));
                };

                request.onupgradeneeded = function(event) {
                    const db = event.target.result;

                    // Create projects object store if it doesn't exist
                    if (!db.objectStoreNames.contains('projects')) {
                        const objectStore = db.createObjectStore('projects', { keyPath: 'projectId' });
                        objectStore.createIndex('projectName', 'projectName', { unique: false });
                        console.log('[GRANTS SYNC] Created projects object store');
                    }
                };
            });
        }

        // Helper function to check if GrantsDB exists
        async function checkGrantsDBExists() {
            return new Promise((resolve) => {
                const request = indexedDB.open('GrantsDB', 2);

                request.onsuccess = function(event) {
                    const db = event.target.result;
                    // Check if the 'projects' object store exists
                    const hasProjectsStore = db.objectStoreNames.contains('projects');
                    db.close();
                    resolve(hasProjectsStore);
                };

                request.onerror = function() {
                    resolve(false);
                };

                request.onupgradeneeded = function(event) {
                    // Database doesn't exist yet - create object store
                    const db = event.target.result;

                    if (!db.objectStoreNames.contains('projects')) {
                        const objectStore = db.createObjectStore('projects', { keyPath: 'projectId' });
                        objectStore.createIndex('projectName', 'projectName', { unique: false });
                        console.log('[GRANTS SYNC] Created projects object store in checkGrantsDBExists');
                    }
                    // Don't close here - let onsuccess handle it
                    // Will resolve false since we just created it (was empty before)
                };
            });
        }

        function showGrantProjectSelection(projects) {
            labourBudgetStep = 1;

            let content = `
                <div style="margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 16px;">Assigning: ${selectedStaffMember.staffName}</h3>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Step 1: Select Grant Project</div>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;

            projects.forEach(project => {
                const projectName = project.projectName || project.projectNumber || `Project ${project.projectId}`;
                content += `
                    <div onclick="selectGrantProject('${project.projectId}')"
                         style="padding: 12px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s;"
                         onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#3b82f6';"
                         onmouseout="this.style.background='white'; this.style.borderColor='#ddd';">
                        <div style="font-weight: 600; font-size: 14px; color: #1e293b;">${projectName}</div>
                        <div style="font-size: 12px; color: #64748b;">Project ID: ${project.projectId}</div>
                    </div>
                `;
            });

            content += '</div>';

            // Replace the staff allocations list with the grant selection UI
            document.getElementById('staffAllocationsListInline').innerHTML = `
                <div style="border: 1px solid #3b82f6; border-radius: 6px; padding: 15px; background: #f8fafc;">
                    <button onclick="cancelGrantSelection()" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 12px; margin-bottom: 15px;">‚Üê Back to Budget Summary</button>
                    ${content}
                </div>
            `;
        }

        async function selectGrantProject(projectId) {
            selectedProjectForBudget = projectId;
            labourBudgetStep = 2;

            // Load project data from IndexedDB
            try {
                // Ensure database is initialized
                await initializeGrantsDB();

                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');

                // Wrap getAll() in a promise
                const allProjects = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                db.close();

                const project = allProjects.find(p => p.projectId == projectId);

                if (!project) {
                    alert('Project not found');
                    return;
                }

                showLabourBudgetTable(project);
            } catch (error) {
                console.error('Error loading project:', error);
                alert('Failed to load project data');
            }
        }

        function showLabourBudgetTable(project, editMode = false) {
            const projectName = project.projectName || project.projectNumber || `Project ${project.projectId}`;

            // Get existing labour budget items (or initialize empty array)
            if (!project.labourBudgetItems) {
                project.labourBudgetItems = [];
            }

            // Determine if we should show display mode or edit mode
            const hasItems = project.labourBudgetItems.length > 0;
            const showDisplayMode = hasItems && !editMode;

            let content = '';

            if (showDisplayMode) {
                // DISPLAY MODE: Show saved budget items with assign buttons
                content = `
                    <div style="margin-bottom: 15px;">
                        <button onclick="assignGrantItem(${staffAllocations.indexOf(selectedStaffMember)})" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 12px;">‚Üê Back to Projects</button>
                        <h3 style="margin: 5px 0 0 0; font-size: 16px;">Labour Budget: ${projectName}</h3>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Saved labour budget items</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        ${project.labourBudgetItems.map((item, idx) => {
                            const hours = (item.days || 0) * 8;
                            const total = (item.dayRate || 0) * (item.days || 0);
                            return `
                                <div style="padding: 12px; margin-bottom: 10px; background: white; border: 1px solid #e2e8f0; border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-size: 14px; color: #1e293b; margin-bottom: 4px;">${item.role || 'Unnamed Role'}</div>
                                            <div style="font-size: 12px; color: #64748b; line-height: 1.5;">
                                                The application details show a total of <strong>${hours} Hours</strong> for the ${item.role || 'role'},
                                                calculated as <strong>${item.days} days</strong> at a rate of <strong>¬£${item.dayRate ? item.dayRate.toFixed(2) : '0.00'} per day</strong>
                                                (¬£${item.hourlyRate ? item.hourlyRate.toFixed(2) : '0.00'}/hr).
                                                Total budget: <strong>¬£${total.toLocaleString()}</strong>
                                            </div>
                                        </div>
                                        <button onclick="showStaffAssignmentForBudgetItem(${idx})"
                                                style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap; margin-left: 12px;">
                                            Assign
                                        </button>
                                    </div>
                                    <div id="staffAssignment_${idx}" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #e2e8f0;">
                                        <!-- Staff assignment dropdown will appear here -->
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button onclick="showLabourBudgetTable(window.currentEditingGrantProject, true)"
                                style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            ‚úèÔ∏è Edit Budget
                        </button>
                    </div>
                `;

            } else {
                // EDIT MODE: Show editable table
                let tableRows = '';
                project.labourBudgetItems.forEach((item, idx) => {
                    // Ensure hourlyRate is calculated if not set
                    if (!item.hourlyRate && item.dayRate) {
                        item.hourlyRate = item.dayRate / 8;
                    }

                    tableRows += `
                        <tr>
                            <td><input type="text" value="${item.role || ''}" onchange="updateLabourBudgetItem(${idx}, 'role', this.value)" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"></td>
                            <td><input type="number" step="0.01" value="${item.hourlyRate || ''}" onchange="updateLabourBudgetItem(${idx}, 'hourlyRate', this.value)" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"></td>
                            <td><input type="number" step="0.01" value="${item.dayRate || ''}" onchange="updateLabourBudgetItem(${idx}, 'dayRate', this.value)" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"></td>
                            <td><input type="number" value="${item.days || ''}" onchange="updateLabourBudgetItem(${idx}, 'days', this.value)" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"></td>
                            <td style="text-align: right; font-weight: 600;">¬£${((item.dayRate || 0) * (item.days || 0)).toLocaleString()}</td>
                            <td style="text-align: center;"><button onclick="removeLabourBudgetItem(${idx})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">√ó</button></td>
                        </tr>
                    `;
                });

                content = `
                    <div style="margin-bottom: 15px;">
                        <button onclick="assignGrantItem(${staffAllocations.indexOf(selectedStaffMember)})" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 12px;">‚Üê Back to Projects</button>
                        <h3 style="margin: 5px 0 0 0; font-size: 16px;">Labour Budget: ${projectName}</h3>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Define labour budget items for this project</div>
                    </div>

                    <div style="overflow-x: auto; margin-bottom: 15px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8fafc;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e2e8f0; font-size: 13px;">Role</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e2e8f0; font-size: 13px;">Hourly Rate (¬£/hr)</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e2e8f0; font-size: 13px;">Day Rate (¬£/day)</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e2e8f0; font-size: 13px;">Number of Days</th>
                                    <th style="padding: 8px; text-align: right; border: 1px solid #e2e8f0; font-size: 13px;">Total</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e2e8f0; font-size: 13px; width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody id="labourBudgetTableBody">
                                ${tableRows || '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">No budget items yet. Click "Add Row" below to get started.</td></tr>'}
                            </tbody>
                        </table>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button onclick="addLabourBudgetRow()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">+ Add Row</button>
                        <button onclick="saveLabourBudgetToProject()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">üíæ Save to Project</button>
                        ${hasItems ? '<button onclick="showLabourBudgetTable(window.currentEditingGrantProject, false)" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">Cancel</button>' : ''}
                    </div>
                `;
            }

            document.getElementById('staffAllocationsListInline').innerHTML = `
                <div style="border: 1px solid #3b82f6; border-radius: 6px; padding: 15px; background: #f8fafc;">
                    ${content}
                </div>
            `;

            // Store current project in memory for editing
            window.currentEditingGrantProject = project;
        }

        function addLabourBudgetRow() {
            if (!window.currentEditingGrantProject.labourBudgetItems) {
                window.currentEditingGrantProject.labourBudgetItems = [];
            }

            window.currentEditingGrantProject.labourBudgetItems.push({
                role: '',
                hourlyRate: 0,
                dayRate: 0,
                days: 0
            });

            showLabourBudgetTable(window.currentEditingGrantProject, true);
        }

        function updateLabourBudgetItem(idx, field, value) {
            if (window.currentEditingGrantProject && window.currentEditingGrantProject.labourBudgetItems[idx]) {
                const item = window.currentEditingGrantProject.labourBudgetItems[idx];

                if (field === 'role') {
                    item[field] = value;
                } else if (field === 'hourlyRate') {
                    // User changed hourly rate ‚Üí calculate day rate (8-hour workday)
                    item.hourlyRate = parseFloat(value) || 0;
                    item.dayRate = item.hourlyRate * 8;
                } else if (field === 'dayRate') {
                    // User changed day rate ‚Üí calculate hourly rate
                    item.dayRate = parseFloat(value) || 0;
                    item.hourlyRate = item.dayRate / 8;
                } else {
                    item[field] = parseFloat(value) || 0;
                }

                // Refresh the table in edit mode to update totals
                showLabourBudgetTable(window.currentEditingGrantProject, true);
            }
        }

        function removeLabourBudgetItem(idx) {
            if (window.currentEditingGrantProject && window.currentEditingGrantProject.labourBudgetItems) {
                window.currentEditingGrantProject.labourBudgetItems.splice(idx, 1);
                showLabourBudgetTable(window.currentEditingGrantProject, true);
            }
        }

        function showStaffAssignmentForBudgetItem(itemIdx) {
            const container = document.getElementById(`staffAssignment_${itemIdx}`);

            if (!container) return;

            // Toggle visibility
            if (container.style.display === 'none' || container.style.display === '') {
                // Show the staff assignment section
                const item = window.currentEditingGrantProject.labourBudgetItems[itemIdx];

                // Get available staff
                const availableStaff = window.staffDatabase || [];

                if (availableStaff.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 10px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 4px; font-size: 12px; color: #92400e;">
                            No staff members found. Please add staff in the labour allocation table first.
                        </div>
                    `;
                    container.style.display = 'block';
                    return;
                }

                container.innerHTML = `
                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px; color: #1e293b;">
                        Assign to Staff Member
                    </div>

                    ${availableStaff.map((staff, staffIdx) => {
                        const staffInitials = staff.initials || staff;
                        const staffName = staff.name || staff;

                        return `
                            <div style="display: flex; align-items: center; gap: 10px; padding: 8px; margin-bottom: 6px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 12px;">${staffInitials} - ${staffName}</div>
                                </div>
                                <input type="number"
                                       id="assignAmount_${itemIdx}_${staffIdx}"
                                       placeholder="Amount ¬£"
                                       step="0.01"
                                       style="width: 120px; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px;" />
                                <button onclick="confirmStaffAssignment(${itemIdx}, '${staffInitials}', '${staffName}')"
                                        style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">
                                    Assign
                                </button>
                            </div>
                        `;
                    }).join('')}

                    <button onclick="document.getElementById('staffAssignment_${itemIdx}').style.display='none'"
                            style="background: #64748b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 8px;">
                        Cancel
                    </button>
                `;

                container.style.display = 'block';
            } else {
                // Hide the section
                container.style.display = 'none';
            }
        }

        function confirmStaffAssignment(itemIdx, staffInitials, staffName) {
            const item = window.currentEditingGrantProject.labourBudgetItems[itemIdx];

            // Find the input for this staff member
            const inputs = document.querySelectorAll(`[id^="assignAmount_${itemIdx}_"]`);
            let assignedAmount = 0;

            for (let input of inputs) {
                if (input.value) {
                    assignedAmount = parseFloat(input.value);
                    break;
                }
            }

            if (!assignedAmount || assignedAmount <= 0) {
                alert('Please enter a valid amount to assign');
                return;
            }

            const budgetAllocated = assignedAmount;

            // Find the staff member in staffAllocations or create new one
            let staffMember = staffAllocations.find(s => s.staffInitials === staffInitials);

            if (!staffMember) {
                // Create new staff allocation entry
                staffMember = {
                    staffInitials: staffInitials,
                    staffName: staffName,
                    grantProjectId: window.currentEditingGrantProject.projectId,
                    grantProjectName: window.currentEditingGrantProject.projectName || window.currentEditingGrantProject.projectNumber || `Project ${window.currentEditingGrantProject.projectId}`,
                    grantRole: item.role,
                    grantHourlyRate: item.hourlyRate,
                    grantDayRate: item.dayRate,
                    grantDays: item.days,
                    budgetAllocated: budgetAllocated,
                    totalClaimed: 0
                };

                staffAllocations.push(staffMember);
            } else {
                // Update existing allocation
                staffMember.grantProjectId = window.currentEditingGrantProject.projectId;
                staffMember.grantProjectName = window.currentEditingGrantProject.projectName || window.currentEditingGrantProject.projectNumber || `Project ${window.currentEditingGrantProject.projectId}`;
                staffMember.grantRole = item.role;
                staffMember.grantHourlyRate = item.hourlyRate;
                staffMember.grantDayRate = item.dayRate;
                staffMember.grantDays = item.days;
                staffMember.budgetAllocated = budgetAllocated;
            }

            // Save allocations
            saveStaffAllocations();

            // Show success and hide assignment section
            showToast(`‚úÖ Assigned ¬£${budgetAllocated.toLocaleString()} to ${staffName} (${item.role})`, 'success');
            document.getElementById(`staffAssignment_${itemIdx}`).style.display = 'none';

            // Optionally refresh the display
            renderStaffAllocationsInline();
        }

        async function saveLabourBudgetToProject() {
            if (!window.currentEditingGrantProject) {
                alert('No project data to save');
                return;
            }

            try {
                showToast('Saving labour budget...', 'info');

                // Save to IndexedDB
                await initializeGrantsDB();
                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readwrite');
                const store = tx.objectStore('projects');

                await new Promise((resolve, reject) => {
                    const request = store.put(window.currentEditingGrantProject);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });

                db.close();

                // Also save to Supabase
                await ensureAuthenticated();
                const { error } = await supabaseClient
                    .from('grants')
                    .upsert({
                        user_id: currentUser.id,
                        project_id: String(window.currentEditingGrantProject.projectId),
                        project_data: window.currentEditingGrantProject
                    }, {
                        onConflict: 'user_id,project_id'
                    });

                if (error) {
                    console.error('Failed to save to Supabase:', error);
                    showToast('‚ö†Ô∏è Saved locally, but cloud sync failed', 'warning');
                } else {
                    showToast('‚úÖ Labour budget saved to project', 'success');
                }

                // Refresh the display
                showLabourBudgetTable(window.currentEditingGrantProject);

            } catch (error) {
                console.error('Error saving labour budget:', error);
                alert('Failed to save labour budget: ' + error.message);
            }
        }

        function assignLabourBudgetItemToEmployee(itemIdx) {
            const project = window.currentEditingGrantProject;
            const item = project.labourBudgetItems[itemIdx];

            if (!item || !item.role) {
                alert('Invalid budget item');
                return;
            }

            const budgetAllocated = (item.dayRate || 0) * (item.days || 0);

            // Update the staff member allocation
            selectedStaffMember.grantProjectId = project.projectId;
            selectedStaffMember.grantProjectName = project.projectName || project.projectNumber || `Project ${project.projectId}`;
            selectedStaffMember.grantRole = item.role;
            selectedStaffMember.grantHourlyRate = item.hourlyRate;
            selectedStaffMember.grantDayRate = item.dayRate;
            selectedStaffMember.grantDays = item.days;
            selectedStaffMember.budgetAllocated = budgetAllocated;

            // Calculate total claimed from labour table
            const projectKey = currentLabourBudgetProject.id || currentLabourBudgetProject.name;
            selectedStaffMember.totalClaimed = calculateTotalClaimedForStaff(selectedStaffMember.staffInitials, projectKey);

            // Save allocations
            saveStaffAllocations();

            // Show success and go back to budget summary
            showToast(`‚úÖ Assigned ${item.role} to ${selectedStaffMember.staffName}`, 'success');

            // Reset and show budget summary
            labourBudgetStep = 1;
            selectedProjectForBudget = null;
            window.currentEditingGrantProject = null;
            renderStaffAllocationsInline();
        }

        function showGrantCategorySelection(project) {
            const projectName = project.projectName || project.projectNumber || `Project ${project.projectId}`;

            let content = `
                <div style="margin-bottom: 15px;">
                    <button onclick="assignGrantItem(${staffAllocations.indexOf(selectedStaffMember)})" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 12px;">‚Üê Back to Projects</button>
                    <h3 style="margin: 5px 0 0 0; font-size: 16px;">Assigning: ${selectedStaffMember.staffName}</h3>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">${projectName} ‚Ä¢ Step 2: Select Category</div>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;

            // Get all categories from the project (same logic as spend.html)
            const categories = [];

            // IUK Categories
            if (project.labour) categories.push({ name: 'Labour', data: project.labour });
            if (project.materials) categories.push({ name: 'Materials', data: project.materials });
            if (project.capitalUsage) categories.push({ name: 'Capital Usage', data: project.capitalUsage });
            if (project.subcontracting) categories.push({ name: 'Subcontracting', data: project.subcontracting });
            if (project.travel) categories.push({ name: 'Travel', data: project.travel });
            if (project.otherCosts) categories.push({ name: 'Other Costs', data: project.otherCosts });

            // Welsh Gov Categories
            if (project.capitalNonStandard) categories.push({ name: 'Capital Non-Standard', data: project.capitalNonStandard });
            if (project.revenueNonStandard) categories.push({ name: 'Revenue Non-Standard', data: project.revenueNonStandard });
            if (project.revenueStandard) categories.push({ name: 'Revenue Standard', data: project.revenueStandard });
            if (project.itemBreakdownCapital) categories.push({ name: 'Item Breakdown Capital', data: project.itemBreakdownCapital });
            if (project.itemBreakdownRevenue) categories.push({ name: 'Item Breakdown Revenue', data: project.itemBreakdownRevenue });

            categories.forEach(cat => {
                content += `
                    <div onclick="selectGrantCategory('${cat.name}')"
                         style="padding: 12px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s;"
                         onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#3b82f6';"
                         onmouseout="this.style.background='white'; this.style.borderColor='#ddd';">
                        <div style="font-weight: 600; font-size: 14px; color: #1e293b;">${cat.name}</div>
                    </div>
                `;
            });

            content += '</div>';

            document.getElementById('staffAllocationsListInline').innerHTML = `
                <div style="border: 1px solid #3b82f6; border-radius: 6px; padding: 15px; background: #f8fafc;">
                    <button onclick="cancelGrantSelection()" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 12px; margin-bottom: 15px;">‚Üê Cancel</button>
                    ${content}
                </div>
            `;
        }

        async function selectGrantCategory(categoryName) {
            selectedCategoryForBudget = categoryName;
            labourBudgetStep = 3;

            // Load project data
            try {
                // Ensure database is initialized
                await initializeGrantsDB();

                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');

                // Wrap getAll() in a promise
                const allProjects = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                db.close();

                const project = allProjects.find(p => p.projectId == selectedProjectForBudget);

                if (!project) {
                    alert('Project not found');
                    return;
                }

                showGrantItemSelection(project, categoryName);
            } catch (error) {
                console.error('Error loading project:', error);
                alert('Failed to load project data');
            }
        }

        function showGrantItemSelection(project, categoryName) {
            const projectName = project.projectName || project.projectNumber || `Project ${project.projectId}`;
            const category = getCategoryObject(project, categoryName);

            if (!category) {
                alert('Category not found');
                return;
            }

            let content = `
                <div style="margin-bottom: 15px;">
                    <button onclick="selectGrantProject('${project.projectId}')" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 12px;">‚Üê Back to Categories</button>
                    <h3 style="margin: 5px 0 0 0; font-size: 16px;">Assigning: ${selectedStaffMember.staffName}</h3>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">${projectName} ‚Ä¢ ${categoryName} ‚Ä¢ Step 3: Select Item</div>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;

            // Get items based on category (same logic as spend.html)
            let items = [];
            let itemPrefix = '';

            // IUK Categories
            if (categoryName === 'Labour' && category.staff) {
                items = category.staff;
                itemPrefix = 'labour';
            } else if (categoryName === 'Materials' && category.items) {
                items = category.items;
                itemPrefix = 'materials';
            } else if (categoryName === 'Capital Usage' && category.items) {
                items = category.items;
                itemPrefix = 'capitalUsage';
            } else if (categoryName === 'Subcontracting' && category.contractors) {
                items = category.contractors;
                itemPrefix = 'subcontracting';
            } else if (categoryName === 'Travel' && category.trips) {
                items = category.trips;
                itemPrefix = 'travel';
            } else if (categoryName === 'Other Costs' && category.items) {
                items = category.items;
                itemPrefix = 'otherCosts';
            }
            // Welsh Gov Categories
            else if (categoryName === 'Capital Non-Standard' && category.items) {
                items = category.items;
                itemPrefix = 'capitalNonStandard';
            } else if (categoryName === 'Revenue Non-Standard' && category.items) {
                items = category.items;
                itemPrefix = 'revenueNonStandard';
            } else if (categoryName === 'Revenue Standard' && category.items) {
                items = category.items;
                itemPrefix = 'revenueStandard';
            } else if (categoryName === 'Item Breakdown Capital' && category.items) {
                items = category.items;
                itemPrefix = 'itemBreakdownCapital';
            } else if (categoryName === 'Item Breakdown Revenue' && category.items) {
                items = category.items;
                itemPrefix = 'itemBreakdownRevenue';
            }

            if (items && items.length > 0) {
                items.forEach((item, idx) => {
                    const itemKey = `${itemPrefix}-${idx}`;
                    let itemName = '';
                    let itemBudget = 0;

                    // Get item name and budget based on category type
                    if (categoryName === 'Labour') {
                        itemName = item.name;
                        itemBudget = item.salary || 0;
                    } else if (categoryName === 'Materials') {
                        itemName = item.item;
                        itemBudget = item.total || 0;
                    } else if (categoryName === 'Capital Usage') {
                        itemName = item.description;
                        itemBudget = item.netCost || 0;
                    } else if (categoryName === 'Subcontracting') {
                        itemName = item.name;
                        itemBudget = item.cost || 0;
                    } else if (categoryName === 'Travel') {
                        itemName = item.purpose;
                        itemBudget = item.total || 0;
                    } else if (categoryName === 'Other Costs') {
                        itemName = item.description;
                        itemBudget = item.estimatedCost || 0;
                    } else {
                        // Welsh Gov items
                        itemName = item.name || item.item || item.description || 'Unnamed Item';
                        itemBudget = item.total || item.cost || item.amount || 0;
                    }

                    content += `
                        <div onclick="selectGrantItem('${itemKey}', '${itemName.replace(/'/g, "\\'")}', ${itemBudget})"
                             style="padding: 12px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s;"
                             onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#3b82f6';"
                             onmouseout="this.style.background='white'; this.style.borderColor='#ddd';">
                            <div style="font-weight: 600; font-size: 14px; color: #1e293b;">${itemName}</div>
                            <div style="font-size: 12px; color: #64748b;">Budget: ¬£${itemBudget.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        </div>
                    `;
                });
            } else {
                content += '<p style="text-align: center; color: #999; padding: 20px;">No items found in this category</p>';
            }

            content += '</div>';

            document.getElementById('staffAllocationsListInline').innerHTML = `
                <div style="border: 1px solid #3b82f6; border-radius: 6px; padding: 15px; background: #f8fafc;">
                    <button onclick="cancelGrantSelection()" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 12px; margin-bottom: 15px;">‚Üê Cancel</button>
                    ${content}
                </div>
            `;
        }

        async function selectGrantItem(itemKey, itemName, itemBudget) {
            // Load project name for display
            try {
                // Ensure database is initialized
                await initializeGrantsDB();

                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');

                // Wrap getAll() in a promise
                const allProjects = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                db.close();

                const project = allProjects.find(p => p.projectId == selectedProjectForBudget);
                const projectName = project ? (project.projectName || project.projectNumber || `Project ${project.projectId}`) : 'Unknown Project';

                // Update the selected staff member's allocation
                selectedStaffMember.grantCategory = selectedCategoryForBudget;
                selectedStaffMember.grantItemKey = itemKey;
                selectedStaffMember.grantItemName = itemName;
                selectedStaffMember.grantProjectId = selectedProjectForBudget;
                selectedStaffMember.grantProjectName = projectName;
                selectedStaffMember.budgetAllocated = itemBudget;

                saveStaffAllocations();

                // Check which container is visible and render appropriately
                const inlineContainer = document.getElementById('staffAllocationsListInline');
                if (inlineContainer && inlineContainer.closest('#labourBudgetSection').style.display !== 'none') {
                    renderStaffAllocationsInline();
                } else {
                    renderStaffAllocations();
                }

                // Show success message
                showToast(`‚úÖ Assigned ${selectedStaffMember.staffName} to ${itemName} (Budget: ¬£${itemBudget.toLocaleString('en-GB')})`, 'success');
            } catch (error) {
                console.error('Error saving grant assignment:', error);
                alert('Failed to save grant assignment');
            }
        }

        function cancelGrantSelection() {
            labourBudgetStep = 1;
            selectedStaffMember = null;
            selectedProjectForBudget = null;
            selectedCategoryForBudget = null;

            // Check which container is visible and render appropriately
            const inlineContainer = document.getElementById('staffAllocationsListInline');
            const modalContainer = document.getElementById('staffAllocationsList');

            if (inlineContainer && inlineContainer.closest('#labourBudgetSection').style.display !== 'none') {
                renderStaffAllocationsInline();
            } else {
                renderStaffAllocations();
            }
        }

        function getCategoryObject(project, categoryName) {
            const categoryMap = {
                'Labour': 'labour',
                'Materials': 'materials',
                'Capital Usage': 'capitalUsage',
                'Subcontracting': 'subcontracting',
                'Travel': 'travel',
                'Other Costs': 'otherCosts',
                'Capital Non-Standard': 'capitalNonStandard',
                'Revenue Non-Standard': 'revenueNonStandard',
                'Revenue Standard': 'revenueStandard',
                'Item Breakdown Capital': 'itemBreakdownCapital',
                'Item Breakdown Revenue': 'itemBreakdownRevenue'
            };

            const key = categoryMap[categoryName];
            return key ? project[key] : null;
        }

        // Helper function to open IndexedDB
        function openDB(dbName, version) {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, version);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);

                // Handle database upgrade for GrantsDB
                request.onupgradeneeded = (event) => {
                    if (dbName === 'GrantsDB') {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('projects')) {
                            const objectStore = db.createObjectStore('projects', { keyPath: 'projectId' });
                            objectStore.createIndex('projectName', 'projectName', { unique: false });
                            console.log('[GRANTS SYNC] Created projects object store in openDB');
                        }
                    }
                };
            });
        }

        function loadHistory(index) {
            const history = JSON.parse(localStorage.getItem('timesheetHistory') || '[]');
            if (history[index]) {
                timesheetData = history[index].data;
                displayTimesheetOutput();
                closeHistory();
                showToast('Loaded generation from history', 'success');
            }
        }

        function deleteHistory(index) {
            const history = JSON.parse(localStorage.getItem('timesheetHistory') || '[]');
            history.splice(index, 1);
            localStorage.setItem('timesheetHistory', JSON.stringify(history));
            showHistory(); // Refresh
        }

        // ============================================
        // LABOUR ALLOCATION FUNCTIONALITY
        // ============================================

        let labourProjects = [];
        let labourRows = [];
        let hiddenProjects = new Set(); // Track which projects are hidden
        let staffDatabase = []; // Staff members list
        let workingDaysPerYear = 224; // Configurable days per year for ¬£/day calculation
        let hoursPerDay = 8; // Configurable hours per day for ¬£/hr calculation

        // Migrate old projects to add IDs and grant fields (backward compatibility)
        function migrateProjectIds() {
            let needsSave = false;
            labourProjects.forEach(project => {
                // Add ID if missing
                if (!project.id) {
                    project.id = Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);
                    needsSave = true;
                    console.log('[MIGRATION] Added ID to project:', project.name, '‚Üí', project.id);
                }

                // Add grant fields if missing (for backward compatibility)
                if (project.grantProjectId === undefined) {
                    project.grantProjectId = null;
                    project.grantProjectNumber = null;
                    project.linkedAt = null;
                    needsSave = true;
                    console.log('[MIGRATION] Added grant fields to project:', project.name);
                }
            });
            if (needsSave) {
                saveLabourData();
                console.log('[MIGRATION] Projects migrated and saved');
            }
        }

        // Initialize labour allocation on page load
        async function initLabourAllocation() {
            // Try to load from cloud/localStorage first
            try {
                await ensureAuthenticated();

                // Check if we have saved data in Supabase or localStorage
                const { data: supabaseData } = await supabaseClient
                    .from('labour_allocation')
                    .select('allocation_data')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                const hasSupabaseData = supabaseData && supabaseData.allocation_data;
                const hasLocalData = localStorage.getItem('labour_allocation_data');

                if (hasSupabaseData || hasLocalData) {
                    // Load existing data
                    await loadLabourData();
                    return;
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Error checking for saved data:', error);
            }

            // Initialize with empty projects (fresh start)
            labourProjects = [];

            renderLabourTable();
            console.log('‚ú® Initialized labour allocation with empty projects (use "Link Grant" to add projects)');
        }

        // Render the entire labour table
        function renderLabourTable() {
            renderProjectHeaders();
            renderLabourRows();
        }

        // Render project headers
        function renderProjectHeaders() {
            const columnLetterRow = document.getElementById('columnLetterRow');
            const projectHeaderRow = document.getElementById('projectHeaderRow');
            const columnHeaderRow = document.getElementById('columnHeaderRow');

            // Remove existing project headers
            while (columnLetterRow.children.length > 8) {
                columnLetterRow.removeChild(columnLetterRow.lastChild);
            }
            while (projectHeaderRow.children.length > 4) {
                projectHeaderRow.removeChild(projectHeaderRow.lastChild);
            }
            while (columnHeaderRow.children.length > 6) {
                columnHeaderRow.removeChild(columnHeaderRow.lastChild);
            }

            // Add project headers
            labourProjects.forEach((project, idx) => {
                const isHidden = hiddenProjects.has(idx);
                const baseColIndex = 8 + (idx * 4); // 8 fixed columns + 4 columns per project

                // Column letters (row 0)
                for (let i = 0; i < 4; i++) {
                    const letterTh = document.createElement('th');
                    const colLetter = columnIndexToLetter(baseColIndex + i);
                    letterTh.style.cssText = `border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; background: #f5f5f5;`;
                    // Add visual separator to first column of each project
                    if (idx > 0 && i === 0) {
                        letterTh.style.borderLeft = '3px solid #90a4ae';
                    }
                    letterTh.textContent = colLetter;
                    letterTh.dataset.projectIdx = idx;

                    if (isHidden) {
                        letterTh.style.display = 'none';
                    }

                    columnLetterRow.appendChild(letterTh);
                }

                // Project name header (row 1)
                const projectTh = document.createElement('th');
                projectTh.colSpan = 4; // Days, Rate, Total, Remaining
                projectTh.style.cssText = `border: 1px solid #ddd; padding: 4px; background: ${project.color}; color: #333; position: relative;`;
                // Add visual separator between projects
                if (idx > 0) {
                    projectTh.style.borderLeft = '3px solid #90a4ae';
                }
                projectTh.dataset.projectIdx = idx;

                // Create the project name span with onclick handler
                const projectNameSpan = document.createElement('span');
                projectNameSpan.style.cssText = 'cursor: pointer; text-decoration: underline;';

                // Add grant link indicator and tooltip
                if (project.grantProjectId) {
                    const linkIcon = document.createElement('span');
                    linkIcon.textContent = 'üîó ';
                    linkIcon.style.cssText = 'font-size: 12px;';
                    projectNameSpan.appendChild(linkIcon);

                    const grantInfo = project.grantProjectNumber ?
                        `Grant-linked: ${project.name} (${project.grantProjectNumber})` :
                        `Grant-linked: ${project.name}`;
                    projectNameSpan.title = `${grantInfo}\nLinked: ${new Date(project.linkedAt).toLocaleDateString()}\nClick to view labour budget summary`;
                } else {
                    projectNameSpan.title = 'Manual project\nClick to view labour budget summary';
                }

                const nameText = document.createTextNode(project.name);
                projectNameSpan.appendChild(nameText);

                projectNameSpan.onclick = function(e) {
                    console.log('üü¢ SPAN CLICKED! Project index:', idx, 'Project:', project.name);
                    e.stopPropagation();
                    showLabourBudgetSummary(idx);
                };

                // Create the visibility toggle button
                const toggleBtn = document.createElement('button');
                toggleBtn.style.cssText = `float: right; background: ${isHidden ? '#4CAF50' : '#FF9800'}; color: white; border: none; padding: 2px 4px; cursor: pointer; border-radius: 2px; font-size: 10px; margin-left: 4px; line-height: 1; opacity: 0.7;`;
                toggleBtn.title = isHidden ? 'Show project' : 'Hide project';
                toggleBtn.textContent = isHidden ? '+' : '‚àí';
                toggleBtn.onclick = function(e) {
                    e.stopPropagation();
                    toggleProjectVisibility(idx);
                };

                projectTh.appendChild(projectNameSpan);
                projectTh.appendChild(toggleBtn);

                if (isHidden) {
                    projectTh.style.display = 'none';
                }

                projectHeaderRow.appendChild(projectTh);

                // Column headers (row 2)
                const headers = ['Days', '¬£/rate', 'Total', 'Remain'];
                headers.forEach((header, headerIdx) => {
                    const th = document.createElement('th');
                    th.style.cssText = `border: 1px solid #ddd; padding: 4px; background: ${project.color}; color: #333; font-size: 10px; opacity: 0.9;`;
                    // Add visual separator to first column of each project
                    if (idx > 0 && headerIdx === 0) {
                        th.style.borderLeft = '3px solid #90a4ae';
                    }
                    th.textContent = header;
                    th.dataset.projectIdx = idx;

                    if (isHidden) {
                        th.style.display = 'none';
                    }

                    columnHeaderRow.appendChild(th);
                });
            });
        }

        // Render labour rows
        function renderLabourRows() {
            const tbody = document.getElementById('labourTableBody');
            tbody.innerHTML = '';

            if (labourRows.length === 0) {
                // Add a default row
                labourRows.push(createDefaultRow());
            }

            // Track month changes for alternating background colors and borders
            let previousMonth = null;
            let monthGroupIndex = 0;
            const monthColors = ['#ffffff', '#f0f4ff']; // White alternating with light blue

            labourRows.forEach((row, rowIdx) => {
                const tr = document.createElement('tr');
                const displayRowNum = rowIdx + 1; // 1-indexed for display
                let colIdx = 0; // Track column index for cell references

                // Add row number as data attribute for cell references
                tr.dataset.rowNumber = displayRowNum;

                // Detect month change
                const isNewMonth = previousMonth !== null && previousMonth !== row.month;
                if (isNewMonth) {
                    monthGroupIndex = (monthGroupIndex + 1) % 2;
                }
                previousMonth = row.month;

                // Apply background color to entire row based on month group
                tr.style.backgroundColor = monthColors[monthGroupIndex];

                // Add thick border on top of first row of new month
                if (isNewMonth) {
                    tr.style.borderTop = '3px solid #2B7A78';
                }

                // Month (dropdown) - STICKY with row number
                const monthCell = createMonthDropdownCell(row.month, (val) => {
                    labourRows[rowIdx].month = val;
                    saveLabourData();
                });
                monthCell.style.position = 'sticky';
                monthCell.style.left = '0';
                monthCell.style.zIndex = '5';
                monthCell.style.backgroundColor = monthColors[monthGroupIndex];
                if (isNewMonth) {
                    monthCell.style.borderTop = '3px solid #2B7A78';
                }
                // Add row number as a small prefix
                const originalContent = monthCell.textContent;
                monthCell.innerHTML = `<span style="font-size: 8px; color: #999; margin-right: 4px;">${displayRowNum}</span>${originalContent}`;
                monthCell.dataset.colIdx = colIdx;
                monthCell.title = `Cell: ${columnIndexToLetter(colIdx)}${displayRowNum}`;
                colIdx++;
                tr.appendChild(monthCell);

                // Staff (dropdown with database) - STICKY
                const staffCell = createStaffDropdownCell(row.staff, (val) => {
                    labourRows[rowIdx].staff = val;
                    saveLabourData();
                });
                staffCell.style.position = 'sticky';
                staffCell.style.left = '50px';
                staffCell.style.zIndex = '5';
                staffCell.style.backgroundColor = monthColors[monthGroupIndex];
                if (isNewMonth) {
                    staffCell.style.borderTop = '3px solid #2B7A78';
                }
                staffCell.dataset.colIdx = colIdx++;
                tr.appendChild(staffCell);

                // Gross (calculated)
                const grossCell = createCalculatedCell(row.gross || 0);
                grossCell.dataset.colIdx = colIdx++;
                tr.appendChild(grossCell);

                // FTE (editable with formula support)
                const fteDisplayValue = row.fte ? row.fte.toFixed(2) : '1.00';
                const fteCell = createEditableCell(fteDisplayValue, 'number', (val, evaluated) => {
                    labourRows[rowIdx].fte = evaluated.value;
                    labourRows[rowIdx].fteFormula = evaluated.formula;
                    recalculateRow(rowIdx);
                    saveLabourData();
                }, row.fteFormula);
                fteCell.style.background = '#fffde7';
                fteCell.dataset.colIdx = colIdx;
                fteCell.title = `Cell: ${columnIndexToLetter(colIdx)}${displayRowNum}`;
                colIdx++;
                tr.appendChild(fteCell);

                // ¬£/yr (if full time) - editable with formula support
                const yearlyDisplayValue = row.yearlyPay ? Math.floor(row.yearlyPay).toString() : '0';
                const yearlyCell = createEditableCell(yearlyDisplayValue, 'number', (val, evaluated) => {
                    labourRows[rowIdx].yearlyPay = evaluated.value;
                    labourRows[rowIdx].yearlyPayFormula = evaluated.formula;
                    recalculateRow(rowIdx);
                    saveLabourData();
                }, row.yearlyPayFormula);
                yearlyCell.style.background = '#fffde7';
                yearlyCell.style.maxWidth = '50px';
                yearlyCell.style.width = '50px';
                yearlyCell.style.overflow = 'hidden';
                yearlyCell.style.textOverflow = 'clip';
                yearlyCell.style.whiteSpace = 'nowrap';
                yearlyCell.dataset.colIdx = colIdx;
                yearlyCell.title = `Cell: ${columnIndexToLetter(colIdx)}${displayRowNum}`;
                colIdx++;
                tr.appendChild(yearlyCell);

                // ¬£/yr (as paid) - calculated (accounts for FTE)
                const yearlyAsPaidCell = createCalculatedCell(row.yearlyAsPaid || 0, 0);
                yearlyAsPaidCell.style.maxWidth = '50px';
                yearlyAsPaidCell.style.width = '50px';
                yearlyAsPaidCell.style.overflow = 'hidden';
                yearlyAsPaidCell.style.textOverflow = 'clip';
                yearlyAsPaidCell.style.whiteSpace = 'nowrap';
                yearlyAsPaidCell.dataset.colIdx = colIdx++;
                tr.appendChild(yearlyAsPaidCell);

                // ¬£/day (calculated)
                const dailyCell = createCalculatedCell(row.dailyRate || 0);
                dailyCell.dataset.colIdx = colIdx++;
                tr.appendChild(dailyCell);

                // ¬£/hr (calculated)
                const hourlyCell = createCalculatedCell(row.hourlyRate || 0);
                hourlyCell.dataset.colIdx = colIdx++;
                tr.appendChild(hourlyCell);

                // Ensure formula fields exist for backward compatibility
                if (row.fteFormula === undefined) row.fteFormula = null;
                if (row.yearlyPayFormula === undefined) row.yearlyPayFormula = null;

                // Project allocations
                // Track if we've encountered a fully allocated project (remaining = 0)
                let foundFullyAllocated = false;

                labourProjects.forEach((project, projIdx) => {
                    if (!row.projects[projIdx]) {
                        row.projects[projIdx] = { days: 0, daysFormula: null, rate: 0, rateFormula: null, total: 0, remaining: 0 };
                    }
                    // Ensure formula fields exist for backward compatibility
                    if (row.projects[projIdx].daysFormula === undefined) {
                        row.projects[projIdx].daysFormula = null;
                    }
                    if (row.projects[projIdx].rateFormula === undefined) {
                        row.projects[projIdx].rateFormula = null;
                    }

                    const proj = row.projects[projIdx];
                    const isHidden = hiddenProjects.has(projIdx);

                    // Check if previous project was fully allocated
                    const shouldDimCells = foundFullyAllocated;

                    // Check if this project is fully allocated (within 0.01 tolerance)
                    const isFullyAllocated = Math.abs(proj.remaining) < 0.01;

                    // Days (with formula support)
                    const displayValue = proj.days ? proj.days.toFixed(2) : '0';
                    const daysCell = createEditableCell(displayValue, 'number', (val, evaluated) => {
                        labourRows[rowIdx].projects[projIdx].days = evaluated.value;
                        labourRows[rowIdx].projects[projIdx].daysFormula = evaluated.formula;
                        recalculateRow(rowIdx);
                        saveLabourData();
                    }, proj.daysFormula);
                    daysCell.style.background = '#fffde7';
                    // Add visual separator between projects
                    if (projIdx > 0) {
                        daysCell.style.borderLeft = '3px solid #90a4ae';
                    }
                    // Apply dimming if project comes after a fully allocated one
                    if (shouldDimCells) {
                        daysCell.style.opacity = '0.25';
                    }
                    daysCell.dataset.projectIdx = projIdx;
                    daysCell.dataset.rowIdx = rowIdx;
                    daysCell.dataset.colIdx = colIdx;
                    daysCell.title = `Cell: ${columnIndexToLetter(colIdx)}${displayRowNum}`;
                    colIdx++;
                    if (isHidden) daysCell.style.display = 'none';
                    tr.appendChild(daysCell);

                    // Rate (editable with formula support)
                    const rateDisplayValue = proj.rate ? proj.rate.toFixed(2) : '0';
                    const rateCell = createEditableCell(rateDisplayValue, 'number', (val, evaluated) => {
                        labourRows[rowIdx].projects[projIdx].rate = evaluated.value;
                        labourRows[rowIdx].projects[projIdx].rateFormula = evaluated.formula;
                        recalculateRow(rowIdx);
                        saveLabourData();
                    }, proj.rateFormula);
                    rateCell.style.background = '#fffde7';
                    // Apply dimming if project comes after a fully allocated one
                    if (shouldDimCells) {
                        rateCell.style.opacity = '0.25';
                    }
                    rateCell.dataset.projectIdx = projIdx;
                    rateCell.dataset.colIdx = colIdx;
                    rateCell.title = `Cell: ${columnIndexToLetter(colIdx)}${displayRowNum}`;
                    colIdx++;
                    if (isHidden) rateCell.style.display = 'none';
                    tr.appendChild(rateCell);

                    // Total (calculated)
                    const totalCell = createCalculatedCell(proj.total || 0);
                    totalCell.style.background = '#e8f5e9';
                    // Apply dimming if project comes after a fully allocated one
                    if (shouldDimCells) {
                        totalCell.style.opacity = '0.25';
                    }
                    totalCell.dataset.projectIdx = projIdx;
                    totalCell.dataset.colIdx = colIdx++;
                    if (isHidden) totalCell.style.display = 'none';
                    tr.appendChild(totalCell);

                    // Remaining (calculated)
                    const remainCell = createCalculatedCell(proj.remaining || 0);

                    // Special styling for fully allocated projects (remaining = 0)
                    if (isFullyAllocated) {
                        remainCell.style.background = '#4caf50';  // Bright green
                        remainCell.style.color = 'white';
                        remainCell.style.fontWeight = 'bold';
                        remainCell.style.position = 'relative';
                        // Add checkmark in top-right corner
                        const checkmark = document.createElement('span');
                        checkmark.textContent = '‚úì';
                        checkmark.style.cssText = 'position: absolute; top: 2px; right: 4px; font-size: 10px; color: white;';
                        remainCell.appendChild(checkmark);
                    } else {
                        remainCell.style.background = proj.remaining < 0 ? '#ffcdd2' : '#e8f5e9';
                    }

                    // Apply dimming if project comes after a fully allocated one
                    if (shouldDimCells) {
                        remainCell.style.opacity = '0.25';
                    }

                    remainCell.dataset.projectIdx = projIdx;
                    remainCell.dataset.colIdx = colIdx++;
                    if (isHidden) remainCell.style.display = 'none';
                    tr.appendChild(remainCell);

                    // Update flag for next iteration
                    if (isFullyAllocated) {
                        foundFullyAllocated = true;
                    }
                });

                // Delete row button
                const deleteCell = document.createElement('td');
                deleteCell.style.cssText = 'border: 1px solid #ddd; padding: 4px; text-align: center;';
                deleteCell.innerHTML = `<button onclick="deleteRow(${rowIdx})" style="background: #f44336; color: white; border: none; padding: 2px 8px; cursor: pointer; border-radius: 3px; font-size: 10px;">Delete</button>`;
                tr.appendChild(deleteCell);

                tbody.appendChild(tr);
            });
        }

        // Create month dropdown cell
        function createMonthDropdownCell(value, onchange) {
            const td = document.createElement('td');
            td.style.cssText = 'border: 1px solid #ddd; padding: 2px; cursor: pointer; max-width: 50px; width: 50px; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
            // Format "2025-07" to "25-07"
            const displayValue = value ? value.replace(/^(\d{4})-/, (match, year) => String(year).slice(-2) + '-') : '';
            td.textContent = displayValue;

            td.addEventListener('click', function() {
                // Prevent multiple dropdowns
                if (td.querySelector('select')) return;

                const select = document.createElement('select');
                select.style.cssText = 'width: 100%; border: 2px solid #2196F3; padding: 2px; font-size: 11px;';

                // Generate months (current year and next 2 years)
                const currentYear = new Date().getFullYear();
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                for (let year = currentYear - 1; year <= currentYear + 2; year++) {
                    for (let month = 0; month < 12; month++) {
                        const monthValue = `${year}-${String(month + 1).padStart(2, '0')}`;
                        const option = document.createElement('option');
                        option.value = monthValue;
                        option.textContent = `${String(year).slice(-2)}-${String(month + 1).padStart(2, '0')}`;
                        if (monthValue === value) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    }
                }

                let isChanging = false;

                select.addEventListener('change', function() {
                    isChanging = true;
                    const newValue = select.value;
                    const displayValue = newValue.replace(/^(\d{4})-/, (match, year) => String(year).slice(-2) + '-');
                    td.textContent = displayValue;
                    if (onchange) onchange(newValue);
                    setTimeout(() => isChanging = false, 100);
                });

                select.addEventListener('blur', function() {
                    if (!isChanging) {
                        // User closed without selecting, restore original value
                        const displayValue = value ? value.replace(/^(\d{4})-/, (match, year) => String(year).slice(-2) + '-') : '';
                        td.textContent = displayValue;
                    }
                });

                select.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        const newValue = select.value;
                        const displayValue = newValue.replace(/^(\d{4})-/, (match, year) => String(year).slice(-2) + '-');
                        td.textContent = displayValue;
                        if (onchange) onchange(newValue);
                        select.blur();
                    }
                    if (e.key === 'Escape') {
                        const displayValue = value ? value.replace(/^(\d{4})-/, (match, year) => String(year).slice(-2) + '-') : '';
                        td.textContent = displayValue;
                        select.blur();
                    }
                });

                td.textContent = '';
                td.appendChild(select);
                select.focus();

                // Open dropdown automatically
                setTimeout(() => {
                    if (select.showPicker) {
                        select.showPicker();
                    } else {
                        select.click();
                    }
                }, 50);
            });

            return td;
        }

        // Create staff dropdown cell with database
        function createStaffDropdownCell(value, onchange) {
            const td = document.createElement('td');
            td.style.cssText = 'border: 1px solid #ddd; padding: 2px; cursor: pointer; max-width: 80px; width: 80px; font-size: 9px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
            // Abbreviate long titles: "Electronic Eng" -> "E. Eng.", "Managing Director" -> "Man. Dir."
            let displayValue = value || '';
            displayValue = displayValue.replace(/Electronic Eng/gi, 'E. Eng.');
            displayValue = displayValue.replace(/Electrical Eng/gi, 'Elec. Eng.');
            displayValue = displayValue.replace(/Managing Director/gi, 'Man. Dir.');
            displayValue = displayValue.replace(/Technical Director/gi, 'Tech. Dir.');
            displayValue = displayValue.replace(/Data Analyst/gi, 'Data An.');
            td.textContent = displayValue;

            td.addEventListener('click', function() {
                // Prevent multiple dropdowns
                if (td.querySelector('select')) return;

                const select = document.createElement('select');
                select.style.cssText = 'width: 100%; border: 2px solid #2196F3; padding: 2px; font-size: 11px;';

                // Add empty option
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = '-- Select Staff --';
                select.appendChild(emptyOption);

                // Add existing staff from database
                staffDatabase.forEach(staff => {
                    const option = document.createElement('option');
                    option.value = staff;
                    option.textContent = staff;
                    if (staff === value) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                // Add "Add new staff" option
                const addNewOption = document.createElement('option');
                addNewOption.value = '__ADD_NEW__';
                addNewOption.textContent = '+ Add New Staff';
                addNewOption.style.fontWeight = 'bold';
                addNewOption.style.color = '#4CAF50';
                select.appendChild(addNewOption);

                let isChanging = false;

                select.addEventListener('change', function() {
                    isChanging = true;

                    if (select.value === '__ADD_NEW__') {
                        // Prompt for new staff name
                        const newStaff = prompt('Enter new staff member name / initials:');
                        if (newStaff && newStaff.trim()) {
                            const trimmedStaff = newStaff.trim();
                            // Add to database if not already exists
                            if (!staffDatabase.includes(trimmedStaff)) {
                                staffDatabase.push(trimmedStaff);
                                staffDatabase.sort(); // Keep alphabetically sorted
                                saveLabourData();
                            }
                            // Set the value
                            td.textContent = trimmedStaff;
                            if (onchange) onchange(trimmedStaff);
                        } else {
                            // User cancelled, restore original value
                            td.textContent = value || '';
                        }
                    } else {
                        // Regular selection
                        td.textContent = select.value;
                        if (onchange) onchange(select.value);
                    }

                    setTimeout(() => isChanging = false, 100);
                });

                select.addEventListener('blur', function() {
                    if (!isChanging) {
                        // User closed without selecting, restore original value
                        td.textContent = value || '';
                    }
                });

                select.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        select.dispatchEvent(new Event('change'));
                        select.blur();
                    }
                    if (e.key === 'Escape') {
                        td.textContent = value || '';
                        select.blur();
                    }
                });

                td.textContent = '';
                td.appendChild(select);
                select.focus();

                // Open dropdown automatically
                setTimeout(() => {
                    if (select.showPicker) {
                        select.showPicker();
                    } else {
                        select.click();
                    }
                }, 50);
            });

            return td;
        }

        // Convert column index to Excel-style letter (0=A, 25=Z, 26=AA, 27=AB, etc.)
        function columnIndexToLetter(index) {
            let letter = '';
            while (index >= 0) {
                letter = String.fromCharCode((index % 26) + 65) + letter;
                index = Math.floor(index / 26) - 1;
            }
            return letter;
        }

        // Get cell value by reference (e.g., "A1", "AF67")
        function getCellValue(cellRef) {
            // Parse cell reference (e.g., "AF67" -> column: AF, row: 67)
            const match = cellRef.match(/^([A-Z]+)(\d+)$/);
            if (!match) return 0;

            const colLetters = match[1];
            const rowNum = parseInt(match[2]) - 1; // Convert to 0-indexed

            // Convert column letters to index
            let colIndex = 0;
            for (let i = 0; i < colLetters.length; i++) {
                colIndex = colIndex * 26 + (colLetters.charCodeAt(i) - 64);
            }
            colIndex -= 1; // Convert to 0-indexed

            // Find the cell in the table using data attributes
            const tbody = document.getElementById('labourTableBody');
            if (!tbody || rowNum >= labourRows.length) return 0;

            const row = tbody.children[rowNum];
            if (!row) return 0;

            // Find cell with matching colIdx
            const cells = Array.from(row.children);
            const cell = cells.find(c => parseInt(c.dataset.colIdx) === colIndex);
            if (!cell) return 0;

            // Get the value from the cell's textContent
            // Remove any HTML tags and extract just the number
            const textContent = cell.textContent.replace(/[^\d.\-]/g, '');
            const value = parseFloat(textContent) || 0;
            return value;
        }

        // Evaluate formula (Excel-like: =86/12 or =AF67/AI67)
        function evaluateFormula(input) {
            if (typeof input !== 'string' || !input.startsWith('=')) {
                return { isFormula: false, value: parseFloat(input) || 0, formula: null };
            }

            try {
                let expression = input.substring(1).trim(); // Remove '='

                // Replace cell references with their values (e.g., AF67 -> 123.45)
                expression = expression.replace(/([A-Z]+\d+)/g, (match) => {
                    const cellValue = getCellValue(match);
                    return cellValue.toString();
                });

                // Security: Only allow numbers, basic operators, parentheses, and dots
                if (!/^[\d\s+\-*/(). ]+$/.test(expression)) {
                    throw new Error('Invalid characters in formula');
                }

                // Evaluate the expression safely
                const result = Function('"use strict"; return (' + expression + ')')();

                if (isNaN(result) || !isFinite(result)) {
                    throw new Error('Invalid result');
                }

                return { isFormula: true, value: result, formula: input };
            } catch (error) {
                console.error('Formula evaluation error:', error);
                return { isFormula: true, value: 0, formula: input, error: true };
            }
        }

        // Adjust cell references in formula based on offset (like Excel autofill)
        function adjustFormulaReferences(formula, rowOffset, colOffset) {
            if (!formula || !formula.startsWith('=')) return formula;

            // Match cell references like A1, AB23, etc.
            return formula.replace(/([A-Z]+)(\d+)/g, (match, colLetters, rowNum) => {
                // Convert column letters to index
                let colIndex = 0;
                for (let i = 0; i < colLetters.length; i++) {
                    colIndex = colIndex * 26 + (colLetters.charCodeAt(i) - 64);
                }
                colIndex -= 1; // Convert to 0-indexed

                // Apply offsets
                const newColIndex = colIndex + colOffset;
                const newRowNum = parseInt(rowNum) + rowOffset;

                // Convert back to letters
                const newColLetters = columnIndexToLetter(newColIndex);
                return newColLetters + newRowNum;
            });
        }

        // Highlight cells in drag range
        function highlightDragRange(startRow, startCol, endRow, endCol) {
            const tbody = document.getElementById('labourTableBody');
            if (!tbody) return;

            const minRow = Math.min(startRow, endRow);
            const maxRow = Math.max(startRow, endRow);
            const minCol = Math.min(startCol, endCol);
            const maxCol = Math.max(startCol, endCol);

            for (let r = minRow; r <= maxRow; r++) {
                const row = tbody.children[r];
                if (!row) continue;

                for (let c = minCol; c <= maxCol; c++) {
                    const cells = Array.from(row.children);
                    const cell = cells.find(td => parseInt(td.dataset.colIdx) === c);

                    if (cell && cell.dataset.cellType === 'editable') {
                        cell.classList.add('drag-highlight');
                        cell.dataset.originalBg = cell.style.background || '#fffde7';
                        cell.style.background = '#bbdefb';
                    }
                }
            }
        }

        // Fill cells in drag range with adjusted formulas
        function fillDragRange(startRow, startCol, endRow, endCol, sourceCell) {
            const tbody = document.getElementById('labourTableBody');
            if (!tbody) return;

            const sourceFormula = sourceCell.dataset.formula;
            const sourceValue = sourceCell.textContent;

            const minRow = Math.min(startRow, endRow);
            const maxRow = Math.max(startRow, endRow);
            const minCol = Math.min(startCol, endCol);
            const maxCol = Math.max(startCol, endCol);

            for (let r = minRow; r <= maxRow; r++) {
                for (let c = minCol; c <= maxCol; c++) {
                    // Skip the source cell
                    if (r === startRow && c === startCol) continue;

                    const rowOffset = r - startRow;
                    const colOffset = c - startCol;

                    // Adjust formula references
                    const adjustedFormula = adjustFormulaReferences(sourceFormula, rowOffset, colOffset);

                    // Find the target cell
                    const row = tbody.children[r];
                    if (!row) continue;

                    const cells = Array.from(row.children);
                    const targetCell = cells.find(td => parseInt(td.dataset.colIdx) === c);

                    if (targetCell && targetCell.dataset.cellType === 'editable') {
                        if (adjustedFormula && adjustedFormula.startsWith('=')) {
                            // Evaluate and apply formula
                            const evaluated = evaluateFormula(adjustedFormula);
                            targetCell.textContent = evaluated.error ? '#ERROR' : evaluated.value;
                            targetCell.dataset.formula = adjustedFormula;
                            targetCell.style.color = evaluated.error ? 'red' : '';

                            // Trigger onchange callback if we can find it
                            // This updates the underlying data
                            triggerCellUpdate(r, c, adjustedFormula, evaluated);
                        } else {
                            // No formula, just copy the value
                            targetCell.textContent = sourceValue;
                            targetCell.dataset.formula = '';

                            // Trigger update with plain value
                            const evaluated = { isFormula: false, value: parseFloat(sourceValue) || 0, formula: null };
                            triggerCellUpdate(r, c, sourceValue, evaluated);
                        }
                    }
                }
            }

            // Re-render the table to ensure all calculations are updated
            renderLabourRows();
        }

        // Trigger cell update to sync with underlying data
        function triggerCellUpdate(rowIdx, colIdx, value, evaluated) {
            if (rowIdx >= labourRows.length) return;

            const row = labourRows[rowIdx];

            // Map column index to field
            if (colIdx === 3) { // FTE
                row.fte = evaluated.value;
                row.fteFormula = evaluated.formula;
                recalculateRow(rowIdx);
            } else if (colIdx === 4) { // yearlyPay
                row.yearlyPay = evaluated.value;
                row.yearlyPayFormula = evaluated.formula;
                recalculateRow(rowIdx);
            } else if (colIdx >= 8) { // Project columns
                const projectColIdx = colIdx - 8;
                const projectIdx = Math.floor(projectColIdx / 4);
                const fieldInProject = projectColIdx % 4;

                if (projectIdx < labourProjects.length && row.projects[projectIdx]) {
                    if (fieldInProject === 0) { // Days
                        row.projects[projectIdx].days = evaluated.value;
                        row.projects[projectIdx].daysFormula = evaluated.formula;
                        recalculateRow(rowIdx);
                    } else if (fieldInProject === 1) { // Rate
                        row.projects[projectIdx].rate = evaluated.value;
                        row.projects[projectIdx].rateFormula = evaluated.formula;
                        recalculateRow(rowIdx);
                    }
                }
            }

            saveLabourData();
        }

        // Create editable cell (with formula support and drag handle)
        function createEditableCell(value, type, onchange, formulaValue = null) {
            const td = document.createElement('td');
            td.style.cssText = 'border: 1px solid #ddd; padding: 4px; cursor: pointer; position: relative;';
            td.textContent = value || '';

            // Store formula for copy/paste
            td.dataset.formula = formulaValue || '';
            td.dataset.cellType = 'editable';

            // Add drag handle (small square in bottom-right corner)
            const dragHandle = document.createElement('div');
            dragHandle.style.cssText = `
                position: absolute;
                bottom: 0;
                right: 0;
                width: 6px;
                height: 6px;
                background: #2196F3;
                cursor: crosshair;
                display: none;
                z-index: 10;
            `;
            dragHandle.className = 'cell-drag-handle';

            // Show drag handle on hover
            td.addEventListener('mouseenter', function() {
                dragHandle.style.display = 'block';
            });
            td.addEventListener('mouseleave', function() {
                if (!td.dataset.dragging) {
                    dragHandle.style.display = 'none';
                }
            });

            // Drag handle functionality
            let isDragging = false;
            let startCell = null;
            let startRowIdx = null;
            let startColIdx = null;

            dragHandle.addEventListener('mousedown', function(e) {
                e.stopPropagation();
                isDragging = true;
                td.dataset.dragging = 'true';
                startCell = td;

                // Get starting position
                const row = td.parentElement;
                startRowIdx = parseInt(row.dataset.rowNumber) - 1; // Convert to 0-indexed
                startColIdx = parseInt(td.dataset.colIdx);

                // Add visual feedback
                td.style.background = '#e3f2fd';

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            function onMouseMove(e) {
                if (!isDragging) return;

                // Find the cell we're hovering over
                const targetElement = document.elementFromPoint(e.clientX, e.clientY);
                const targetCell = targetElement?.closest('td');

                if (targetCell && targetCell.dataset.cellType === 'editable') {
                    // Highlight cells in the drag range
                    const targetRow = targetCell.parentElement;
                    const endRowIdx = parseInt(targetRow.dataset.rowNumber) - 1;
                    const endColIdx = parseInt(targetCell.dataset.colIdx);

                    // Clear previous highlights
                    document.querySelectorAll('.drag-highlight').forEach(cell => {
                        cell.classList.remove('drag-highlight');
                        const origBg = cell.dataset.originalBg || '#fffde7';
                        cell.style.background = origBg;
                    });

                    // Highlight cells in range
                    highlightDragRange(startRowIdx, startColIdx, endRowIdx, endColIdx);
                }
            }

            function onMouseUp(e) {
                if (!isDragging) return;

                isDragging = false;
                delete td.dataset.dragging;
                dragHandle.style.display = 'none';

                // Get end position
                const targetElement = document.elementFromPoint(e.clientX, e.clientY);
                const targetCell = targetElement?.closest('td');

                if (targetCell && targetCell.dataset.cellType === 'editable') {
                    const targetRow = targetCell.parentElement;
                    const endRowIdx = parseInt(targetRow.dataset.rowNumber) - 1;
                    const endColIdx = parseInt(targetCell.dataset.colIdx);

                    // Fill cells with adjusted formulas
                    fillDragRange(startRowIdx, startColIdx, endRowIdx, endColIdx, startCell);
                }

                // Clear highlights
                document.querySelectorAll('.drag-highlight').forEach(cell => {
                    cell.classList.remove('drag-highlight');
                    const origBg = cell.dataset.originalBg || '#fffde7';
                    cell.style.background = origBg;
                });

                // Restore original background
                const origBg = td.dataset.originalBg || '#fffde7';
                td.style.background = origBg;

                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }

            td.appendChild(dragHandle);

            td.addEventListener('click', function(e) {
                // Don't open editor if clicking drag handle
                if (e.target.classList.contains('cell-drag-handle')) return;

                const input = document.createElement('input');
                input.type = 'text'; // Always use text to allow formulas
                input.value = formulaValue || value || '';
                input.style.cssText = 'width: 100%; border: 2px solid #2196F3; padding: 2px; font-size: 11px;';
                input.dataset.isFormula = input.value.startsWith('=');

                // Enable cell click to add reference mode
                let cellClickHandler = null;

                input.addEventListener('input', function() {
                    const isFormula = input.value.startsWith('=');
                    if (isFormula && !cellClickHandler) {
                        // Add cell click listener
                        cellClickHandler = function(e) {
                            const clickedCell = e.target.closest('td');
                            if (clickedCell && clickedCell !== td && clickedCell.dataset.colIdx !== undefined) {
                                const row = clickedCell.parentElement;
                                const rowNum = row.dataset.rowNumber;
                                const colIdx = parseInt(clickedCell.dataset.colIdx);
                                const cellRef = columnIndexToLetter(colIdx) + rowNum;

                                // Insert cell reference at cursor position
                                const cursorPos = input.selectionStart;
                                const textBefore = input.value.substring(0, cursorPos);
                                const textAfter = input.value.substring(cursorPos);
                                input.value = textBefore + cellRef + textAfter;

                                // Move cursor after inserted reference
                                const newPos = cursorPos + cellRef.length;
                                input.setSelectionRange(newPos, newPos);
                                input.focus();

                                e.preventDefault();
                                e.stopPropagation();
                            }
                        };
                        document.addEventListener('click', cellClickHandler, true);
                    } else if (!isFormula && cellClickHandler) {
                        // Remove cell click listener if formula is deleted
                        document.removeEventListener('click', cellClickHandler, true);
                        cellClickHandler = null;
                    }
                });

                input.addEventListener('blur', function() {
                    // Clean up cell click listener
                    if (cellClickHandler) {
                        document.removeEventListener('click', cellClickHandler, true);
                        cellClickHandler = null;
                    }

                    const newValue = input.value;

                    // Check if it's a formula
                    if (newValue.startsWith('=')) {
                        const evaluated = evaluateFormula(newValue);

                        if (!evaluated.error) {
                            td.textContent = evaluated.value;
                            td.dataset.formula = evaluated.formula;
                            td.style.color = '';
                            if (onchange) onchange(newValue, evaluated);
                        } else {
                            td.textContent = '#ERROR';
                            td.dataset.formula = evaluated.formula;
                            td.style.color = 'red';
                            if (onchange) onchange(newValue, evaluated);
                        }
                    } else {
                        // Not a formula, just plain value
                        td.textContent = newValue;
                        td.dataset.formula = '';
                        td.style.color = '';
                        if (onchange) onchange(newValue, { isFormula: false, value: parseFloat(newValue) || 0, formula: null });
                    }
                });

                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        input.blur();
                    }
                    if (e.key === 'Escape') {
                        // Clean up cell click listener
                        if (cellClickHandler) {
                            document.removeEventListener('click', cellClickHandler, true);
                            cellClickHandler = null;
                        }
                        td.textContent = value || '';
                        input.blur();
                    }
                });

                // Enable cell click mode immediately if editing formula
                if (input.value.startsWith('=')) {
                    cellClickHandler = function(e) {
                        const clickedCell = e.target.closest('td');
                        if (clickedCell && clickedCell !== td && clickedCell.dataset.colIdx !== undefined) {
                            const row = clickedCell.parentElement;
                            const rowNum = row.dataset.rowNumber;
                            const colIdx = parseInt(clickedCell.dataset.colIdx);
                            const cellRef = columnIndexToLetter(colIdx) + rowNum;

                            // Insert cell reference at cursor position
                            const cursorPos = input.selectionStart;
                            const textBefore = input.value.substring(0, cursorPos);
                            const textAfter = input.value.substring(cursorPos);
                            input.value = textBefore + cellRef + textAfter;

                            // Move cursor after inserted reference
                            const newPos = cursorPos + cellRef.length;
                            input.setSelectionRange(newPos, newPos);
                            input.focus();

                            e.preventDefault();
                            e.stopPropagation();
                        }
                    };
                    document.addEventListener('click', cellClickHandler, true);
                }

                td.textContent = '';
                td.appendChild(input);
                input.focus();
                input.select();
            });

            // Add copy/paste support
            td.addEventListener('copy', function(e) {
                e.preventDefault();
                const formula = td.dataset.formula || td.textContent;
                e.clipboardData.setData('text/plain', formula);
            });

            td.addEventListener('paste', function(e) {
                e.preventDefault();
                const pastedText = e.clipboardData.getData('text/plain');

                if (pastedText.startsWith('=')) {
                    const evaluated = evaluateFormula(pastedText);

                    if (!evaluated.error) {
                        td.textContent = evaluated.value;
                        td.dataset.formula = evaluated.formula;
                        td.style.color = '';
                        if (onchange) onchange(pastedText, evaluated);
                    } else {
                        td.textContent = '#ERROR';
                        td.dataset.formula = evaluated.formula;
                        td.style.color = 'red';
                        if (onchange) onchange(pastedText, evaluated);
                    }
                } else {
                    td.textContent = pastedText;
                    td.dataset.formula = '';
                    td.style.color = '';
                    if (onchange) onchange(pastedText, { isFormula: false, value: parseFloat(pastedText) || 0, formula: null });
                }
            });

            return td;
        }


        // Create calculated (read-only) cell
        function createCalculatedCell(value, decimals = 2) {
            const td = document.createElement('td');
            td.style.cssText = 'border: 1px solid #ddd; padding: 4px; background: #f5f5f5; color: #666; font-weight: 500;';
            const formatted = typeof value === 'number' ? value.toFixed(decimals) : value;
            td.textContent = formatted;
            return td;
        }

        // Create default row
        function createDefaultRow() {
            const projects = labourProjects.map(() => ({
                days: 0,
                daysFormula: null,
                rate: 0,
                rateFormula: null,
                total: 0,
                remaining: 0
            }));
            return {
                month: new Date().toISOString().split('T')[0].substring(0, 7), // YYYY-MM
                staff: '',
                net: 0,
                gross: 0,
                fte: 1.0,
                fteFormula: null,
                yearlyPay: 0,
                yearlyPayFormula: null,
                yearlyAsPaid: 0,
                dailyRate: 0,
                hourlyRate: 0,
                projects: projects
            };
        }

        // Recalculate row
        function recalculateRow(rowIdx) {
            const row = labourRows[rowIdx];

            // Calculate everything from yearlyPay (¬£/yr if full time) and FTE
            if (row.yearlyPay > 0 && row.fte > 0) {
                // Calculate actual paid amount (accounting for FTE)
                row.yearlyAsPaid = row.yearlyPay * row.fte;

                // Calculate monthly gross from yearly as paid
                row.gross = row.yearlyAsPaid / 12;

                // Calculate net (assuming 80% take-home after tax/NI)
                row.net = row.gross * 0.8;

                // Calculate daily rate (based on full-time rate and configurable working days)
                row.dailyRate = row.yearlyPay / workingDaysPerYear;

                // Calculate hourly rate (based on daily rate and configurable hours per day)
                row.hourlyRate = row.dailyRate / hoursPerDay;
            } else {
                // If either is 0, reset calculated fields
                row.yearlyAsPaid = 0;
                row.gross = 0;
                row.net = 0;
                row.dailyRate = 0;
                row.hourlyRate = 0;
            }

            // Calculate project totals
            let runningRemaining = row.gross;
            row.projects.forEach(proj => {
                proj.total = proj.days * proj.rate;
                runningRemaining -= proj.total;
                proj.remaining = runningRemaining;
            });

            renderLabourRows();
            saveLabourData();
        }

        // Add staff row
        function addStaffRow() {
            labourRows.push(createDefaultRow());
            renderLabourRows();
            saveLabourData();
        }

        // Delete row
        function deleteRow(rowIdx) {
            if (confirm('Delete this row?')) {
                labourRows.splice(rowIdx, 1);
                renderLabourRows();
                saveLabourData();
            }
        }

        // Show copy month dialog
        function showCopyMonthDialog() {
            if (labourRows.length === 0) {
                alert('No data to copy. Please add some rows first.');
                return;
            }

            // Get unique months from the data, sorted
            const uniqueMonths = [...new Set(labourRows.map(row => row.month))].sort();

            if (uniqueMonths.length === 0) {
                alert('No valid month data found.');
                return;
            }

            // Populate the dropdown
            const select = document.getElementById('copyMonthSelect');
            select.innerHTML = '<option value="">-- Select a month --</option>';

            uniqueMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                // Format: "2025-09" -> "September 2025"
                const [year, monthNum] = month.split('-');
                const monthName = new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                option.textContent = monthName;
                select.appendChild(option);
            });

            // Reset preview
            document.getElementById('copyMonthPreview').style.display = 'none';
            document.getElementById('executeCopyBtn').disabled = true;

            // Show dialog
            document.getElementById('copyMonthDialog').style.display = 'flex';
        }

        // Update preview when month is selected
        function updateCopyMonthPreview() {
            const selectedMonth = document.getElementById('copyMonthSelect').value;
            const previewDiv = document.getElementById('copyMonthPreview');
            const previewText = document.getElementById('copyMonthPreviewText');
            const copyBtn = document.getElementById('executeCopyBtn');

            if (!selectedMonth) {
                previewDiv.style.display = 'none';
                copyBtn.disabled = true;
                return;
            }

            // Count rows for this month
            const rowsToCopy = labourRows.filter(row => row.month === selectedMonth);
            const rowCount = rowsToCopy.length;

            // Calculate next month
            const [year, month] = selectedMonth.split('-').map(Number);
            let nextYear = year;
            let nextMonth = month + 1;

            if (nextMonth > 12) {
                nextMonth = 1;
                nextYear++;
            }

            const nextMonthStr = `${nextYear}-${String(nextMonth).padStart(2, '0')}`;
            const nextMonthName = new Date(nextYear, nextMonth - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Show preview
            previewText.innerHTML = `This will copy <strong>${rowCount} row(s)</strong> to <strong>${nextMonthName}</strong>`;
            previewDiv.style.display = 'block';
            copyBtn.disabled = false;
        }

        // Execute the copy operation
        function executeCopyMonth() {
            const selectedMonth = document.getElementById('copyMonthSelect').value;

            if (!selectedMonth) {
                return;
            }

            // Calculate next month
            const [year, month] = selectedMonth.split('-').map(Number);
            let nextYear = year;
            let nextMonth = month + 1;

            if (nextMonth > 12) {
                nextMonth = 1;
                nextYear++;
            }

            const nextMonthStr = `${nextYear}-${String(nextMonth).padStart(2, '0')}`;

            // Find all rows from the selected month
            const rowsToCopy = labourRows.filter(row => row.month === selectedMonth);

            if (rowsToCopy.length === 0) {
                alert(`No rows found for ${selectedMonth}.`);
                return;
            }

            // Create copies of the rows with the new month
            const newRows = rowsToCopy.map(row => {
                // Deep clone the row
                const newRow = JSON.parse(JSON.stringify(row));
                newRow.month = nextMonthStr;
                return newRow;
            });

            // Add the new rows to the end of the labour rows array (below the last row)
            labourRows.push(...newRows);

            // Re-render and save
            renderLabourRows();
            saveLabourData();

            // Close dialog
            closeCopyMonthDialog();

            // Show success message
            const nextMonthName = new Date(nextYear, nextMonth - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            alert(`‚úÖ Copied ${newRows.length} row(s) to ${nextMonthName}`);
        }

        // Close copy month dialog
        function closeCopyMonthDialog() {
            document.getElementById('copyMonthDialog').style.display = 'none';
            document.getElementById('copyMonthSelect').value = '';
            document.getElementById('copyMonthPreview').style.display = 'none';
        }

        // Add project (manual - not linked to grant)
        function addProject() {
            const name = prompt('Enter project name:');
            if (name) {
                const colors = ['#e3f2fd', '#f3e5f5', '#e8f5e9', '#fff3e0', '#fce4ec', '#e0f7fa'];
                const color = colors[labourProjects.length % colors.length];
                const id = Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9); // Generate unique ID

                // Create manual project (no grant link)
                labourProjects.push({
                    id,
                    name,
                    color,
                    grantProjectId: null,
                    grantProjectNumber: null,
                    linkedAt: null
                });

                // Add project to all existing rows
                labourRows.forEach(row => {
                    row.projects.push({ days: 0, daysFormula: null, rate: 0, rateFormula: null, total: 0, remaining: 0 });
                });

                renderLabourTable();
                saveLabourData();
            }
        }

        // Grant Linking Functions
        // ============================================

        let selectedGrantId = null;
        let selectedLabourProjectIdx = null;

        // Show grant link modal
        async function showGrantLinkModal() {
            const modal = document.getElementById('grantLinkModal');
            modal.style.display = 'flex';

            // Reset selections
            selectedGrantId = null;
            selectedLabourProjectIdx = null;

            // Populate both columns
            await populateGrantListColumn();
            populateLabourProjectListColumn();

            updateLinkPreview();
        }

        // Close grant link modal
        function closeGrantLinkModal() {
            const modal = document.getElementById('grantLinkModal');
            modal.style.display = 'none';
            selectedGrantId = null;
            selectedLabourProjectIdx = null;
        }

        // Populate grants column (left side)
        async function populateGrantListColumn() {
            try {
                // Sync grants from Supabase first
                await syncGrantsFromSupabase();

                // Get grants from IndexedDB
                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');

                // Wrap getAll() in a promise
                const allGrants = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                db.close();

                const grantListColumn = document.getElementById('grantListColumn');
                const noGrantsMessage = document.getElementById('noGrantsMessage');

                if (!allGrants || allGrants.length === 0) {
                    grantListColumn.innerHTML = '';
                    noGrantsMessage.style.display = 'block';
                    return;
                }

                noGrantsMessage.style.display = 'none';

                // Sort grants by name
                allGrants.sort((a, b) => (a.projectName || '').localeCompare(b.projectName || ''));

                // Debug: Log all grant IDs and types
                console.log('[GRANT LINK] All grants in database:');
                allGrants.forEach(grant => {
                    console.log('  - ID:', grant.projectId, 'Type:', typeof grant.projectId, 'Name:', grant.projectName);
                });

                // Render grant items with radio buttons
                grantListColumn.innerHTML = allGrants.map((grant, idx) => {
                    const labourBudget = grant.labour?.totalCost || 'N/A';
                    // Store grant reference for later lookup
                    const grantIdAttr = `data-grant-idx="${idx}"`;

                    return `
                        <label style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s;"
                               onmouseover="this.style.background='#eff6ff'"
                               onmouseout="this.style.background='white'">
                            <input type="radio" name="grantSelection" value="${idx}"
                                   onchange="selectGrantByIndex(${idx})"
                                   style="margin-right: 12px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1f2937; font-size: 13px; margin-bottom: 4px;">
                                    ${grant.projectName || 'Untitled Project'}
                                </div>
                                <div style="font-size: 11px; color: #6b7280;">
                                    ${grant.projectNumber || 'No number'} | Labour Budget: ¬£${labourBudget}
                                </div>
                            </div>
                        </label>
                    `;
                }).join('');

                // Store grants list for later reference
                window.cachedGrantsList = allGrants;

            } catch (error) {
                console.error('[GRANT LINK] Failed to populate grants:', error);
                showToast('Failed to load grants', 'error');
            }
        }

        // Populate labour projects column (right side)
        function populateLabourProjectListColumn() {
            const labourProjectListColumn = document.getElementById('labourProjectListColumn');
            const noLabourProjectsMessage = document.getElementById('noLabourProjectsMessage');

            if (!labourProjects || labourProjects.length === 0) {
                labourProjectListColumn.innerHTML = '';
                noLabourProjectsMessage.style.display = 'block';
                return;
            }

            noLabourProjectsMessage.style.display = 'none';

            // Render labour project items with radio buttons
            labourProjectListColumn.innerHTML = labourProjects.map((project, idx) => {
                const isLinked = project.grantProjectId !== null;
                const linkInfo = isLinked ? `üîó Linked to grant ${project.grantProjectNumber || project.grantProjectId}` : 'Not linked';

                return `
                    <label style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s;"
                           onmouseover="this.style.background='#eff6ff'"
                           onmouseout="this.style.background='white'">
                        <input type="radio" name="labourProjectSelection" value="${idx}"
                               onchange="selectLabourProject(${idx})"
                               style="margin-right: 12px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1f2937; font-size: 13px; margin-bottom: 4px;">
                                ${project.name}
                            </div>
                            <div style="font-size: 11px; color: ${isLinked ? '#059669' : '#9ca3af'};">
                                ${linkInfo}
                            </div>
                        </div>
                    </label>
                `;
            }).join('');
        }

        // Select grant by index (from cached list)
        function selectGrantByIndex(idx) {
            if (!window.cachedGrantsList || !window.cachedGrantsList[idx]) {
                console.error('[GRANT LINK] Invalid grant index:', idx);
                return;
            }

            const grant = window.cachedGrantsList[idx];
            selectedGrantId = grant.projectId;
            console.log('[GRANT LINK] Selected grant ID:', selectedGrantId, 'Type:', typeof selectedGrantId, 'Name:', grant.projectName);
            updateLinkPreview();
        }

        // Select labour project (right column)
        function selectLabourProject(projectIdx) {
            selectedLabourProjectIdx = projectIdx;
            updateLinkPreview();
        }

        // Update link preview and enable/disable button
        function updateLinkPreview() {
            const preview = document.getElementById('linkSelectionPreview');
            const linkBtn = document.getElementById('linkSelectedBtn');

            if (selectedGrantId !== null && selectedLabourProjectIdx !== null) {
                // Find grant in cached list
                const grant = window.cachedGrantsList?.find(g => g.projectId === selectedGrantId);
                const labourProject = labourProjects[selectedLabourProjectIdx];

                if (grant) {
                    preview.innerHTML = `
                        <strong style="color: #1f2937;">Ready to link:</strong><br>
                        üìä Grant: <strong>${grant.projectName || 'Unknown'}</strong> (${grant.projectNumber || 'No number'})<br>
                        üìã Labour Project: <strong>${labourProject.name}</strong>
                    `;
                    preview.style.color = '#059669';

                    linkBtn.disabled = false;
                    linkBtn.style.opacity = '1';
                } else {
                    preview.innerHTML = `
                        <strong style="color: #dc2626;">Error:</strong> Grant not found<br>
                        Grant ID: ${selectedGrantId}<br>
                        Labour Project: <strong>${labourProject.name}</strong>
                    `;
                    preview.style.color = '#dc2626';
                    linkBtn.disabled = true;
                    linkBtn.style.opacity = '0.5';
                }
            } else {
                preview.textContent = 'Please select one grant and one labour project';
                preview.style.color = '#6b7280';
                linkBtn.disabled = true;
                linkBtn.style.opacity = '0.5';
            }
        }

        // Link selected grant and labour project
        function linkSelectedGrantAndProject() {
            if (selectedGrantId === null || selectedLabourProjectIdx === null) {
                showToast('Please select both a grant and a labour project', 'warning');
                return;
            }

            try {
                // Find grant in cached list
                const grant = window.cachedGrantsList?.find(g => g.projectId === selectedGrantId);

                if (!grant) {
                    showToast('Grant not found in database', 'error');
                    console.error('[GRANT LINK] Grant not found for ID:', selectedGrantId);
                    return;
                }

                console.log('[GRANT LINK] Linking grant:', grant.projectName, 'ID:', grant.projectId, 'Type:', typeof grant.projectId);

                // Update the labour project with grant link
                const labourProject = labourProjects[selectedLabourProjectIdx];
                labourProject.grantProjectId = grant.projectId;
                labourProject.grantProjectNumber = grant.projectNumber || null;
                labourProject.linkedAt = new Date().toISOString();

                // Update table headers and save
                renderLabourTable();
                saveLabourData();

                closeGrantLinkModal();
                showToast(`‚úÖ Linked "${grant.projectName}" to "${labourProject.name}"`, 'success');
                console.log('[GRANT LINK] Successfully linked:', grant.projectName, '‚Üí', labourProject.name);

            } catch (error) {
                console.error('[GRANT LINK] Failed to link grant:', error);
                showToast('Failed to link grant', 'error');
            }
        }

        // Sync grant names with database (auto-update if grant name changed)
        async function syncGrantNamesWithDatabase() {
            try {
                // Get all grants from IndexedDB
                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');

                // Wrap getAll() in a promise
                const allGrants = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                db.close();

                if (!allGrants || allGrants.length === 0) {
                    console.log('[GRANT SYNC] No grants found in database');
                    return;
                }

                // Create a map of grantProjectId -> grant for quick lookup
                const grantsMap = new Map();
                allGrants.forEach(grant => {
                    grantsMap.set(grant.projectId, grant);
                });

                // Check each labour project
                let hasChanges = false;
                labourProjects.forEach(project => {
                    if (project.grantProjectId) {
                        const grant = grantsMap.get(project.grantProjectId);

                        if (!grant) {
                            console.warn('[GRANT SYNC] ‚ö†Ô∏è Grant missing:', project.grantProjectId, '(Project:', project.name + ')');
                            // Don't auto-delete, just log warning
                        } else if (grant.projectName !== project.name) {
                            console.log(`[GRANT SYNC] üîÑ Updating project name: "${project.name}" ‚Üí "${grant.projectName}"`);
                            project.name = grant.projectName;
                            project.grantProjectNumber = grant.projectNumber || null;
                            hasChanges = true;
                        }
                    }
                });

                if (hasChanges) {
                    console.log('[GRANT SYNC] ‚úÖ Grant names synchronized');
                    saveLabourData(); // Auto-save updated names
                }

            } catch (error) {
                console.error('[GRANT SYNC] Failed to sync grant names:', error);
            }
        }

        // Unlink project from grant (convert to manual project)
        function unlinkProjectFromGrant(projIdx) {
            const project = labourProjects[projIdx];

            if (!project.grantProjectId) {
                showToast('This project is not linked to a grant', 'warning');
                return;
            }

            const confirmed = confirm(
                `Unlink "${project.name}" from grant?\n\n` +
                `This will convert it to a manual project.\n` +
                `The project name and allocations will be preserved.`
            );

            if (confirmed) {
                console.log('[GRANT LINK] Unlinking project:', project.name);

                // Remove grant link data
                project.grantProjectId = null;
                project.grantProjectNumber = null;
                project.linkedAt = null;

                renderLabourTable();
                saveLabourData();
                showToast(`‚úÖ "${project.name}" is now a manual project`, 'success');
            }
        }

        // Remove project
        function removeProject(projIdx) {
            if (confirm(`Remove project "${labourProjects[projIdx].name}"?`)) {
                labourProjects.splice(projIdx, 1);

                // Remove project from all rows
                labourRows.forEach(row => {
                    row.projects.splice(projIdx, 1);
                });

                // Update hidden projects set (shift indices)
                const newHidden = new Set();
                hiddenProjects.forEach(idx => {
                    if (idx < projIdx) {
                        newHidden.add(idx);
                    } else if (idx > projIdx) {
                        newHidden.add(idx - 1);
                    }
                });
                hiddenProjects = newHidden;

                renderLabourTable();
                saveLabourData();
            }
        }

        // Configure daily rate calculation (working days per year)
        function configureDailyRate() {
            const newValue = prompt(
                `Configure daily rate calculation:\n\nEnter working days per year (currently: ${workingDaysPerYear}):\n\nNote: Standard UK = 224 days (52 weeks √ó 5 days - 8 bank holidays - 28 days holiday)`,
                workingDaysPerYear
            );

            if (newValue !== null && newValue.trim() !== '') {
                const parsedValue = parseFloat(newValue);
                if (!isNaN(parsedValue) && parsedValue > 0 && parsedValue <= 365) {
                    workingDaysPerYear = parsedValue;

                    // Recalculate all rows
                    labourRows.forEach((row, idx) => recalculateRow(idx));

                    saveLabourData();
                    showToast(`Daily rate now calculated using ${workingDaysPerYear} working days per year`, 'success');
                } else {
                    alert('Please enter a valid number between 1 and 365');
                }
            }
        }

        // Configure hourly rate calculation (hours per day)
        function configureHourlyRate() {
            const newValue = prompt(
                `Configure hourly rate calculation:\n\nEnter hours per working day (currently: ${hoursPerDay}):\n\nNote: Standard = 8 hours per day`,
                hoursPerDay
            );

            if (newValue !== null && newValue.trim() !== '') {
                const parsedValue = parseFloat(newValue);
                if (!isNaN(parsedValue) && parsedValue > 0 && parsedValue <= 24) {
                    hoursPerDay = parsedValue;

                    // Recalculate all rows
                    labourRows.forEach((row, idx) => recalculateRow(idx));

                    saveLabourData();
                    showToast(`Hourly rate now calculated using ${hoursPerDay} hours per day`, 'success');
                } else {
                    alert('Please enter a valid number between 1 and 24');
                }
            }
        }

        // Toggle project visibility
        function toggleProjectVisibility(projIdx) {
            if (hiddenProjects.has(projIdx)) {
                hiddenProjects.delete(projIdx);
            } else {
                hiddenProjects.add(projIdx);
            }

            // Toggle visibility of header cells
            const projectHeaders = document.querySelectorAll(`[data-project-idx="${projIdx}"]`);
            projectHeaders.forEach(cell => {
                if (hiddenProjects.has(projIdx)) {
                    cell.style.display = 'none';
                } else {
                    cell.style.display = '';
                }
            });

            // Update button text/color
            renderProjectHeaders();
            saveLabourData();
        }

        // Show all projects (unhide all minimized projects)
        function showAllProjects() {
            if (hiddenProjects.size === 0) {
                showToast('All projects are already visible', 'info');
                return;
            }

            const hiddenCount = hiddenProjects.size;
            hiddenProjects.clear();

            renderProjectHeaders();
            renderLabourRows();
            saveLabourData();

            showToast(`Showing all ${hiddenCount} hidden project(s)`, 'success');
        }

        // Save labour data
        async function saveLabourData() {
            const data = {
                projects: labourProjects,
                rows: labourRows,
                hiddenProjects: Array.from(hiddenProjects), // Convert Set to Array for JSON
                staff: staffDatabase,
                workingDaysPerYear: workingDaysPerYear,
                hoursPerDay: hoursPerDay
            };

            // Save to localStorage as fallback
            localStorage.setItem('labour_allocation_data', JSON.stringify(data));
            console.log('‚úÖ Labour data saved to localStorage');

            // Save to Supabase cloud
            try {
                await ensureAuthenticated();

                // Check if user already has a record
                const { data: existing, error: fetchError } = await supabaseClient
                    .from('labour_allocation')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (fetchError && fetchError.code !== 'PGRST116') {
                    throw fetchError;
                }

                if (existing) {
                    // Update existing record
                    const { error: updateError } = await supabaseClient
                        .from('labour_allocation')
                        .update({ allocation_data: data })
                        .eq('user_id', currentUser.id);

                    if (updateError) throw updateError;
                    console.log('‚òÅÔ∏è Labour data updated in Supabase');
                } else {
                    // Insert new record
                    const { error: insertError } = await supabaseClient
                        .from('labour_allocation')
                        .insert({
                            user_id: currentUser.id,
                            allocation_data: data
                        });

                    if (insertError) throw insertError;
                    console.log('‚òÅÔ∏è Labour data saved to Supabase');
                }
            } catch (error) {
                console.error('‚ùå Failed to save to Supabase:', error);
                console.log('‚ö†Ô∏è Data saved to localStorage only');
            }
        }

        // Load labour data
        async function loadLabourData() {
            try {
                // Try to load from Supabase first
                await ensureAuthenticated();

                const { data: supabaseData, error } = await supabaseClient
                    .from('labour_allocation')
                    .select('allocation_data')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                if (supabaseData && supabaseData.allocation_data) {
                    const data = supabaseData.allocation_data;
                    labourProjects = data.projects || [];
                    labourRows = data.rows || [];
                    hiddenProjects = new Set(data.hiddenProjects || []); // Convert Array back to Set
                    staffDatabase = data.staff || staffDatabase;
                    workingDaysPerYear = data.workingDaysPerYear || workingDaysPerYear;
                    hoursPerDay = data.hoursPerDay || hoursPerDay;

                    // Migrate projects to add IDs if needed
                    migrateProjectIds();

                    // Sync grant names with database (auto-update if changed)
                    await syncGrantNamesWithDatabase();

                    renderLabourTable();
                    showToast('‚òÅÔ∏è Labour data loaded from cloud', 'success');
                    console.log('‚òÅÔ∏è Labour data loaded from Supabase');
                    return;
                }
            } catch (error) {
                console.error('‚ùå Failed to load from Supabase:', error);
                console.log('‚ö†Ô∏è Trying localStorage fallback...');
            }

            // Fallback to localStorage
            const saved = localStorage.getItem('labour_allocation_data');
            if (saved) {
                const data = JSON.parse(saved);
                labourProjects = data.projects || [];
                labourRows = data.rows || [];
                hiddenProjects = new Set(data.hiddenProjects || []); // Convert Array back to Set
                staffDatabase = data.staff || staffDatabase;
                workingDaysPerYear = data.workingDaysPerYear || workingDaysPerYear;
                hoursPerDay = data.hoursPerDay || hoursPerDay;

                // Migrate projects to add IDs if needed
                migrateProjectIds();

                // Sync grant names with database (auto-update if changed)
                await syncGrantNamesWithDatabase();

                renderLabourTable();
                showToast('Labour data loaded from local storage', 'success');
                console.log('üíæ Labour data loaded from localStorage');
            } else {
                showToast('No saved data found', 'warning');
                console.log('‚ö†Ô∏è No saved data found');
            }
        }

        // Clear labour data
        async function clearLabourData() {
            if (confirm('Clear all labour allocation data? This will delete both local and cloud backups.')) {
                labourProjects = [];
                labourRows = [];
                hiddenProjects = new Set();

                // Clear localStorage
                localStorage.removeItem('labour_allocation_data');

                // Clear Supabase
                try {
                    await ensureAuthenticated();
                    const { error } = await supabaseClient
                        .from('labour_allocation')
                        .delete()
                        .eq('user_id', currentUser.id);

                    if (error) throw error;
                    console.log('‚òÅÔ∏è Labour data deleted from Supabase');
                } catch (error) {
                    console.error('‚ùå Failed to delete from Supabase:', error);
                }

                initLabourAllocation();
                showToast('Data cleared from local and cloud', 'success');
            }
        }

        // Handle paste from Excel
        let selectedCell = null;
        let selectedRowIdx = null;
        let selectedColIdx = null;

        function setupPasteHandler() {
            const table = document.getElementById('labourTable');
            const tbody = document.getElementById('labourTableBody');

            // Track which cell was clicked with visual highlight
            tbody.addEventListener('mousedown', function(e) {
                // Remove previous highlight
                const previousSelected = tbody.querySelector('.paste-selected');
                if (previousSelected) {
                    previousSelected.classList.remove('paste-selected');
                }

                const cell = e.target.closest('td');
                if (cell) {
                    // Don't select the delete button column
                    const cells = Array.from(cell.parentElement.children);
                    const cellIndex = cells.indexOf(cell);

                    // Skip if it's the last column (delete button)
                    if (cellIndex === cells.length - 1) {
                        return;
                    }

                    selectedCell = cell;
                    selectedRowIdx = Array.from(cell.parentElement.parentElement.children).indexOf(cell.parentElement);
                    selectedColIdx = cellIndex;

                    // Visual highlight
                    cell.classList.add('paste-selected');

                    console.log('Selected - Row:', selectedRowIdx, '(data row ' + selectedRowIdx + '), Col:', selectedColIdx);
                    console.log('Total rows in data:', labourRows.length);
                }
            });

            // Handle paste event
            document.addEventListener('paste', function(e) {
                // Only handle if we're in the labour allocation tab
                if (!document.getElementById('allocation-tab').classList.contains('active')) {
                    return;
                }

                // If pasting into an input element, allow default paste behavior
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    console.log('‚úÖ Allowing default paste into input/textarea element');
                    return; // Let the browser handle pasting into the input
                }

                e.preventDefault();

                const pasteData = e.clipboardData.getData('text');
                console.log('üìã RAW CLIPBOARD DATA:', JSON.stringify(pasteData));
                console.log('üìã Clipboard length:', pasteData ? pasteData.length : 0);

                if (!pasteData) {
                    console.log('‚ùå No paste data found in clipboard');
                    return;
                }

                // Parse tab-separated values (Excel format)
                const rows = pasteData.split('\n').filter(row => row.trim() !== '');
                console.log('üìã Parsed rows:', rows.length, ':', rows);

                let startRowIdx = selectedRowIdx !== null ? selectedRowIdx : 0;
                let startColIdx = selectedColIdx !== null ? selectedColIdx : 0;

                console.log('üìç Pasting at row:', startRowIdx, 'col:', startColIdx);

                // Column mapping for editable fields
                const editableColumns = {
                    0: 'month',     // Month
                    1: 'staff',     // Staff
                    3: 'fte',       // FTE (editable)
                    4: 'yearlyPay'  // ¬£/yr (if full time) (editable)
                    // Column 2 is calculated (Gross)
                    // Columns 5-7 are calculated (¬£/yr paid, ¬£/day, ¬£/hr)
                    // Project columns start at index 8
                };

                rows.forEach((row, rowOffset) => {
                    const rowIdx = startRowIdx + rowOffset;

                    console.log('üîÑ Processing paste row', rowOffset, '-> data row', rowIdx);

                    // Add new row if needed
                    while (rowIdx >= labourRows.length) {
                        console.log('‚ûï Creating new row at index', labourRows.length);
                        labourRows.push(createDefaultRow());
                    }

                    const cells = row.split('\t');
                    console.log('üìä Row has', cells.length, 'cells:', cells);

                    cells.forEach((value, colOffset) => {
                        const colIdx = startColIdx + colOffset;

                        // Handle editable columns (Month, Staff, FTE, ¬£/yr if full time)
                        if (editableColumns.hasOwnProperty(colIdx)) {
                            const field = editableColumns[colIdx];
                            console.log(`‚úèÔ∏è Setting row[${rowIdx}].${field} = "${value}" (col ${colIdx})`);

                            if (field === 'month' || field === 'staff') {
                                labourRows[rowIdx][field] = value.trim();
                                console.log(`‚úÖ Set to: "${labourRows[rowIdx][field]}"`);
                            } else if (field === 'fte') {
                                const evaluated = evaluateFormula(value);
                                labourRows[rowIdx].fte = evaluated.value;
                                labourRows[rowIdx].fteFormula = evaluated.formula;
                                console.log(`‚úÖ Set fte = ${evaluated.value} (formula: ${evaluated.formula || 'none'})`);
                            } else if (field === 'yearlyPay') {
                                const evaluated = evaluateFormula(value);
                                labourRows[rowIdx].yearlyPay = evaluated.value;
                                labourRows[rowIdx].yearlyPayFormula = evaluated.formula;
                                console.log(`‚úÖ Set yearlyPay = ${evaluated.value} (formula: ${evaluated.formula || 'none'})`);
                            }
                        }
                        // Skip calculated columns (Gross, etc.)
                        else if (colIdx >= 2 && colIdx <= 7) {
                            console.log(`‚ö†Ô∏è Column ${colIdx} is calculated - skipping`);
                        }
                        // Handle project allocation columns
                        // Column 8+ are project fields (Days, Rate repeating)
                        else if (colIdx >= 8) {
                            const projectColIdx = colIdx - 8; // Offset past the fixed columns (8 total now)
                            const projectIdx = Math.floor(projectColIdx / 4); // Each project has 4 columns
                            const fieldInProject = projectColIdx % 4; // 0=Days, 1=Rate, 2=Total, 3=Remaining

                            console.log(`üéØ Project column detected - col ${colIdx} -> project ${projectIdx}, field ${fieldInProject}`);

                            if (projectIdx < labourProjects.length) {
                                if (!labourRows[rowIdx].projects[projectIdx]) {
                                    labourRows[rowIdx].projects[projectIdx] = { days: 0, daysFormula: null, rate: 0, rateFormula: null, total: 0, remaining: 0 };
                                }

                                if (fieldInProject === 0) { // Days
                                    const evaluated = evaluateFormula(value);
                                    labourRows[rowIdx].projects[projectIdx].days = evaluated.value;
                                    labourRows[rowIdx].projects[projectIdx].daysFormula = evaluated.formula;
                                    console.log(`‚úÖ Set project[${projectIdx}].days = ${evaluated.value} (formula: ${evaluated.formula || 'none'})`);
                                } else if (fieldInProject === 1) { // Rate
                                    const evaluated = evaluateFormula(value);
                                    labourRows[rowIdx].projects[projectIdx].rate = evaluated.value;
                                    labourRows[rowIdx].projects[projectIdx].rateFormula = evaluated.formula;
                                    console.log(`‚úÖ Set project[${projectIdx}].rate = ${evaluated.value} (formula: ${evaluated.formula || 'none'})`);
                                }
                                // Total and Remaining are calculated, skip them
                            } else {
                                console.log(`‚ö†Ô∏è Project index ${projectIdx} out of range (max: ${labourProjects.length - 1})`);
                            }
                        } else {
                            console.log(`‚ö†Ô∏è Column ${colIdx} is in the calculated range (5-8) - skipping`);
                        }
                    });

                    // Recalculate this row
                    console.log(`üî¢ Recalculating row ${rowIdx}`);
                    recalculateRow(rowIdx);
                });

                // Re-render table
                console.log('üé® Re-rendering labour table');
                renderLabourRows();
                console.log('‚úÖ PASTE COMPLETE');
                showToast(`Pasted ${rows.length} row(s) successfully`, 'success');
            });
        }

        // Initialize labour allocation when switching to that tab
        document.addEventListener('DOMContentLoaded', function() {
            initLabourAllocation();
            setupPasteHandler();
        });


        // IndexedDB helper for folder handles
        function openPayslipDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('PEBLGenDB', 1);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('folderHandles')) {
                        db.createObjectStore('folderHandles', { keyPath: 'id' });
                    }
                };
            });
        }

        // PAYSLIP MERGER FUNCTIONALITY
        let payslipFolderHandle = null;
        let fetchedPayslips = [];
        const teamMembers = {'CW':'Craig Williams','CB':'Christian Berger','JG':'Jack Green','AK':'Anjali Cowan Krishna','HM':'Huw Matthews'};
        const folderNameMap = {
            'CW': ['Craig', 'PEBL Staff - Craig'],
            'CB': ['Christian', 'PEBL Staff - Christian'],
            'JG': ['Jack', 'PEBL Staff - Jack'],
            'AK': ['Anjali', 'PEBL Staff - Anjali'],
            'HM': ['Huw', 'PEBL Staff - Huw']
        };
        const monthNames = {'01':'January','02':'February','03':'March','04':'April','05':'May','06':'June','07':'July','08':'August','09':'September','10':'October','11':'November','12':'December'};

        async function selectPayslipFolder() {
            console.log("[Payslip] selectPayslipFolder called");
            if (!('showDirectoryPicker' in window)) {
                showToast('Use Chrome or Edge', 'error');
                return;
            }
            try {
                const dirHandle = await window.showDirectoryPicker({mode: 'read'});
                console.log("[Payslip] Folder selected:", dirHandle.name);
                payslipFolderHandle = dirHandle;
                const db = await openPayslipDB();
                const tx = db.transaction(['folderHandles'], 'readwrite');
                tx.objectStore('folderHandles').put({id: 'payslipFolder', handle: dirHandle});
                updatePayslipFolderStatus(dirHandle.name);
                document.getElementById('fetchPayslipsBtn').disabled = false;
                showToast('Folder set', 'success');
            } catch (e) {
                if (e.name !== 'AbortError') { console.error('[Payslip] Error:', e.name, e.message, e.stack); showToast('Error selecting folder: ' + e.message, 'error'); }
            }
        }

        async function loadPayslipFolder() {
            console.log("[Payslip] loadPayslipFolder called");
            if (!('showDirectoryPicker' in window)) return;
            try {
                const db = await openPayslipDB();
                const tx = db.transaction(['folderHandles'], 'readonly');
                const request = tx.objectStore('folderHandles').get('payslipFolder');
                request.onsuccess = async () => {
                    if (request.result) {
                        payslipFolderHandle = request.result.handle;
                        const perm = await payslipFolderHandle.queryPermission({mode: 'read'});
                        if (perm === 'granted') {
                            updatePayslipFolderStatus(payslipFolderHandle.name);
                            document.getElementById('fetchPayslipsBtn').disabled = false;
                        }
                    }
                };
            } catch (e) {}
        }

        function updatePayslipFolderStatus(name) {
            const status = document.getElementById('payslipFolderStatus');
            if (status) {
                status.textContent = '‚úì ' + name;
                status.style.color = '#4caf50';
            }
        }

        async function fetchPayslips() {
            console.log("[Payslip] fetchPayslips called");
            if (!payslipFolderHandle) {
                showToast('Select folder first', 'error');
                return;
            }

            const memberMonths = {};
            for (const code in teamMembers) {
                const checkboxes = document.querySelectorAll('input[type="checkbox"][data-member="' + code + '"]:checked');
                if (checkboxes.length > 0) {
                    memberMonths[code] = Array.from(checkboxes).map(cb => cb.getAttribute('data-month'));
                }
            }

            if (Object.keys(memberMonths).length === 0) {
                showToast('Select at least one month for a member', 'error');
                return;
            }

            const year = document.getElementById('payslipYear').value;
            showToast('Searching subfolders...', 'info');
            fetchedPayslips = [];

            try {
                const perm = await payslipFolderHandle.queryPermission({mode: 'read'});
                if (perm !== 'granted') await payslipFolderHandle.requestPermission({mode: 'read'});

                console.log("[Payslip] Scanning subfolders in:", payslipFolderHandle.name);
                for await (const entry of payslipFolderHandle.values()) {
                    if (entry.kind === 'directory') {
                        console.log('[Payslip] Found subfolder:', entry.name);
                        const memberCode = matchFolderToMember(entry.name);
                        console.log("[Payslip] Match result for", entry.name, "->", memberCode);
                        if (memberCode && memberMonths[memberCode]) {
                            await searchSubfolderForPayslips(entry, memberCode, memberMonths[memberCode], year);
                        }
                    }
                }

                displayFetchedPayslips();

                if (fetchedPayslips.length > 0) {
                    showToast('Fetched ' + fetchedPayslips.length + ' payslips', 'success');
                    document.getElementById('mergePayslipsBtn').style.display = 'inline-block';
                    document.getElementById('payslipCount').textContent = fetchedPayslips.length + ' payslips found';
                } else {
                    showToast('No payslips found', 'warning');
                    document.getElementById('payslipCount').textContent = 'No payslips found';
                }
            } catch (e) {
                console.error('[Payslip] Error in fetchPayslips:', e);
                console.error('[Payslip] Error name:', e.name);
                console.error('[Payslip] Error message:', e.message);
                console.error('[Payslip] Stack:', e.stack);
                showToast('Error fetching: ' + e.message, 'error');
            }
        }

        function matchFolderToMember(folderName) {
            for (const code in folderNameMap) {
                const patterns = folderNameMap[code];
                for (const pattern of patterns) {
                    if (folderName.toLowerCase().includes(pattern.toLowerCase())) {
                        return code;
                    }
                }
            }
            return null;
        }

        async function searchSubfolderForPayslips(folderHandle, memberCode, months, year) {
            try {
                for await (const entry of folderHandle.values()) {
                    if (entry.kind === 'file' && entry.name.endsWith('.pdf')) {
                            console.log('[Payslip] Found PDF:', entry.name);
                        const match = matchPayslipFile(entry.name, memberCode, months, year);
                            console.log("[Payslip] Match result:", match ? "YES" : "NO");
                        if (match) {
                            const file = await entry.getFile();
                            fetchedPayslips.push({
                                name: entry.name,
                                file: file,
                                memberCode: match.memberCode,
                                memberName: match.memberName,
                                month: match.month,
                                year: match.year,
                                folderName: folderHandle.name
                            });
                        }
                    }
                }
            } catch (e) {
                console.error('Error searching subfolder:', folderHandle.name, e);
            }
        }

        function matchPayslipFile(filename, memberCode, months, year) {
            const memberName = teamMembers[memberCode];
            for (const month of months) {
                const lastDay = new Date(parseInt(year), parseInt(month), 0).getDate();
                const dateStr = lastDay.toString().padStart(2, '0') + '-' + month + '-' + year;
                const pattern = 'Payslip - ' + memberName + ' - Month Ending ' + dateStr;
                if (filename.includes(pattern)) {
                    return {memberCode, memberName, month, year};
                }
            }
            return null;
        }

        function displayFetchedPayslips() {
            const display = document.getElementById('fetchedPayslipsDisplay');
            const list = document.getElementById('fetchedPayslipsList');

            if (fetchedPayslips.length === 0) {
                display.style.display = 'none';
                return;
            }

            display.style.display = 'block';
            fetchedPayslips.sort((a, b) => {
                if (a.memberCode !== b.memberCode) return a.memberCode.localeCompare(b.memberCode);
                return a.month.localeCompare(b.month);
            });

            let html = '<table style="border-collapse:collapse;width:100%;"><thead><tr>';
            html += '<th style="border:1px solid #ddd;padding:4px;background:#4caf50;color:white;">Member</th>';
            html += '<th style="border:1px solid #ddd;padding:4px;background:#4caf50;color:white;">Month</th>';
            html += '<th style="border:1px solid #ddd;padding:4px;background:#4caf50;color:white;">Folder</th>';
            html += '<th style="border:1px solid #ddd;padding:4px;background:#4caf50;color:white;">Filename</th>';
            html += '</tr></thead><tbody>';

            fetchedPayslips.forEach(p => {
                html += '<tr>';
                html += '<td style="border:1px solid #ddd;padding:4px;">' + p.memberCode + '</td>';
                html += '<td style="border:1px solid #ddd;padding:4px;">' + monthNames[p.month] + ' ' + p.year + '</td>';
                html += '<td style="border:1px solid #ddd;padding:4px;">' + p.folderName + '</td>';
                html += '<td style="border:1px solid #ddd;padding:4px;font-size:10px;">' + p.name + '</td>';
                html += '</tr>';
            });

            html += '</tbody></table>';
            list.innerHTML = html;
        }

        async function mergePayslips() {
            if (fetchedPayslips.length === 0) {
                showToast('No payslips to merge', 'error');
                return;
            }

            showToast('Merging PDFs...', 'info');

            try {
                const PDFDocument = PDFLib.PDFDocument;
                const mergedPdf = await PDFDocument.create();

                for (const ps of fetchedPayslips) {
                    const arrayBuffer = await ps.file.arrayBuffer();
                    const pdf = await PDFDocument.load(arrayBuffer);
                    const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                    copiedPages.forEach(page => mergedPdf.addPage(page));
                }

                const mergedPdfBytes = await mergedPdf.save();
                const blob = new Blob([mergedPdfBytes], {type: 'application/pdf'});
                const url = URL.createObjectURL(blob);
                const year = document.getElementById('payslipYear').value;
                const filename = 'Merged_Payslips_' + year + '_' + new Date().toISOString().split('T')[0] + '.pdf';

                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(url);

                showToast('PDF downloaded: ' + filename, 'success');
            } catch (e) {
                console.error(e);
                showToast('Error merging PDFs: ' + e.message, 'error');
            }
        }


    </script>
</body>
</html>
