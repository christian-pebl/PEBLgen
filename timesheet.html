<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labour</title>
    <!-- Google Fonts - PEBL Brand Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400&display=swap" rel="stylesheet">

    <!-- Export Libraries -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Roboto', sans-serif;
            font-weight: 300;
            background: linear-gradient(to bottom, #DEF2F1 0%, #ffffff 100%);
            min-height: 100vh;
        }

        /* Excel-like drag autofill styles */
        .drag-highlight {
            border: 2px solid #2196F3 !important;
        }

        .cell-drag-handle:hover {
            background: #1976D2 !important;
            transform: scale(1.2);
        }

        /* Navigation Banner */
        .nav-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%);
            padding: 15px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 0;
            z-index: 100;
        }
        .nav-banner h1 {
            color: white;
            font-size: 28px;
            font-weight: 700;
            margin: 0;
            font-family: 'Roboto', sans-serif;
            letter-spacing: 0.5px;
        }
        .nav-buttons {
            display: flex;
            gap: 8px;
        }
        .nav-btn {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
            display: inline-block;
        }
        .nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }
        .nav-btn.active {
            background-color: rgba(255, 255, 255, 0.9);
            color: #2B7A78;
            border-color: rgba(255, 255, 255, 0.9);
        }

        /* Split Screen Mode */
        .split-screen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1e293b;
            z-index: 9999;
        }
        .split-screen-overlay.active {
            display: flex;
            flex-direction: column;
        }
        .split-screen-header {
            background: linear-gradient(135deg, #3AAFA9 0%, #2B7A78 100%);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-shrink: 0;
        }
        .split-screen-header h2 {
            color: white;
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        .split-screen-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        .split-pane-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 6px;
        }
        .split-pane-selector label {
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            font-weight: 500;
        }
        .split-pane-selector select {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.9);
            font-size: 13px;
            cursor: pointer;
            min-width: 120px;
        }
        .split-screen-close {
            margin-left: auto;
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
        }
        .split-screen-close:hover {
            background: #dc2626;
        }
        .split-screen-container {
            display: flex;
            flex: 1;
            gap: 4px;
            padding: 4px;
            background: #1e293b;
            overflow: hidden;
        }
        .split-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 6px;
            overflow: hidden;
        }
        .split-pane-header {
            background: #f1f5f9;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            color: #475569;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .split-pane-content {
            flex: 1;
            position: relative;
        }
        .split-pane-content iframe {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
        }
        .split-divider {
            width: 6px;
            background: #475569;
            cursor: col-resize;
            border-radius: 3px;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        .split-divider:hover {
            background: #3AAFA9;
        }
        .split-orientation-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .split-orientation-btn:hover {
            background: rgba(255,255,255,0.25);
        }
        .split-screen-container.vertical {
            flex-direction: column;
        }
        .split-screen-container.vertical .split-divider {
            width: auto;
            height: 6px;
            cursor: row-resize;
        }
        .split-btn-icon {
            font-size: 16px;
        }

        /* Tab Navigation */
        .tab-container {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #2B7A78;
        }
        .tab-btn {
            background: white;
            border: none;
            padding: 10px 24px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .tab-btn:hover {
            color: #2B7A78;
            background: #f5f5f5;
        }
        .tab-btn.active {
            color: #2B7A78;
            border-bottom-color: #2B7A78;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Paste selection highlight */
        .paste-selected {
            outline: 3px solid #2196F3 !important;
            outline-offset: -3px;
            background-color: #e3f2fd !important;
        }

        /* Content Container */
        .content-container {
            padding: 15px;
            max-width: 1400px;
            margin: 0 auto;
            padding-top: 80px;
        }

        /* Section Styles */
        .section {
            margin-bottom: 15px;
            padding: 12px;
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }

        .section h2 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 15px;
            color: #333;
            border-bottom: 2px solid #2196F3;
            padding-bottom: 6px;
            font-weight: 600;
        }

        /* System Prompt Section */
        .system-prompt-section {
            background-color: #e0f7fa;
            border-left: 3px solid #00acc1;
        }

        #systemPrompt {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            border: 1px solid #2196F3;
            border-radius: 4px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
            resize: vertical;
        }

        /* Staff Mapping Section */
        .staff-mapping-section {
            background-color: #f3e5f5;
            border-left: 3px solid #9c27b0;
        }

        .mapping-input-group {
            margin-bottom: 10px;
        }

        .mapping-input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 3px;
            color: #555;
            font-size: 13px;
        }

        .mapping-input-group input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
        }

        /* Forecast Data Section */
        .forecast-section {
            background-color: #fff3e0;
            border-left: 3px solid #ff9800;
        }

        .instructions {
            font-size: 11px;
            color: #666;
            margin-bottom: 6px;
        }

        #forecastInput {
            width: 100%;
            min-height: 80px;
            padding: 6px;
            border: 1px solid #ff9800;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            resize: vertical;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 11px;
        }

        .preview-table th,
        .preview-table td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: left;
        }

        .preview-table th {
            background-color: #2196F3;
            color: white;
            font-weight: 600;
        }

        .preview-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* Gantt Section */
        .gantt-section {
            background-color: #e8f5e9;
            border-left: 3px solid #4caf50;
        }

        .gantt-dropdown {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 6px;
        }

        .gantt-summary {
            background-color: white;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            border: 1px solid #ddd;
        }

        .gantt-summary h3 {
            margin-top: 0;
            margin-bottom: 6px;
            font-size: 14px;
            color: #4caf50;
        }

        .gantt-summary p {
            margin: 3px 0;
            font-size: 12px;
        }

        /* Generate Section */
        .generate-section {
            background-color: #e1f5fe;
            border-left: 3px solid #03a9f4;
        }

        .cost-estimate {
            background-color: white;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border: 2px solid #03a9f4;
            text-align: center;
        }

        .cost-estimate h3 {
            margin: 0 0 3px 0;
            font-size: 12px;
            color: #666;
        }

        .cost-amount {
            font-size: 20px;
            font-weight: bold;
            color: #0277bd;
            margin: 0;
        }

        /* Output Section */
        .output-section {
            background-color: #fce4ec;
            border-left: 3px solid #e91e63;
        }

        .timesheet-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-top: 8px;
        }

        .timesheet-table th,
        .timesheet-table td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: left;
        }

        .timesheet-table th {
            background-color: #e91e63;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .timesheet-table td {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        .timesheet-table td.editable {
            cursor: cell;
        }

        .timesheet-table td.editable:hover {
            background-color: #fff8e1;
            box-shadow: 0 0 0 1px #2196F3 inset;
        }

        .timesheet-table td.editing {
            cursor: text;
            outline: 2px solid #2196F3;
            background-color: #e3f2fd;
        }

        /* Selection highlighting for copying to Excel */
        .timesheet-table td::selection,
        .timesheet-table td *::selection {
            background-color: #2196F3;
            color: white;
        }

        .timesheet-table td::-moz-selection,
        .timesheet-table td *::-moz-selection {
            background-color: #2196F3;
            color: white;
        }

        .week-group {
            background-color: #f5f5f5;
        }

        /* Buttons */
        .btn {
            padding: 6px 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-primary {
            background-color: #2196F3;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #0b7dda;
        }

        .btn-success {
            background-color: #4CAF50;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #45a049;
        }

        .btn-warning {
            background-color: #FF9800;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background-color: #F57C00;
        }

        .btn-danger {
            background-color: #f44336;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #d32f2f;
        }

        .btn-info {
            background-color: #00BCD4;
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            background-color: #0097A7;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #323232;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            background-color: #4CAF50;
        }

        .toast.error {
            background-color: #f44336;
        }

        .toast.warning {
            background-color: #FF9800;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        /* Validation Warning */
        .validation-warning {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 12px;
            margin: 10px 0;
            color: #856404;
        }

        .validation-warning strong {
            display: block;
            margin-bottom: 5px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

    <!-- Automatic Cloud Backup System -->
    <script src="supabase-client.js"></script>
    <script src="auto-sync-manager.js"></script>
    <script src="sync-status-indicator.js"></script>
    <script src="universal-backup.js"></script>
    <script>
        // Authentication guard - redirect to login if not authenticated
        window.addEventListener('supabaseReady', async () => {
            const user = await checkAuthStatus();
            if (!user) {
                console.warn('‚ö†Ô∏è [AUTH] Not authenticated, redirecting to login...');
                sessionStorage.setItem('redirectAfterLogin', window.location.href);
                window.location.href = 'login.html';
            }
        });
    </script>
</head>
<body>
    <!-- Navigation Banner -->
    <div class="nav-banner">
        <h1>Labour</h1>
        <div class="nav-buttons">
            <a href="grants.html" class="nav-btn">Grants</a>
            <a href="spend.html" class="nav-btn">Spend</a>
            <a href="gantt.html" class="nav-btn">Gantt</a>
            <a href="timesheet.html" class="nav-btn active">Labour</a>
            <a href="index.html" class="nav-btn">Sketcher</a>
            <a href="exploit.html" class="nav-btn">Exploit</a>
            <a href="risks.html" class="nav-btn">Risks</a>
            <a href="quote.html" class="nav-btn">Quote</a>
            <button onclick="openSplitScreenMode()" class="nav-btn" style="background-color: rgba(255, 255, 255, 0.15); margin-left: auto;" title="Split Screen Mode"><span class="split-btn-icon">‚´ø</span> Split</button>
            <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="nav-btn" style="background-color: rgba(255, 255, 255, 0.15);" title="Scroll to top">‚Üë Top</button>
            <button onclick="signOut()" class="nav-btn" style="background-color: rgba(239, 68, 68, 0.8); color: white;" title="Sign out">üö™ Sign Out</button>
        </div>
    </div>

    <div class="content-container">
        <!-- Tab Navigation -->
        <div class="tab-container">
            <button class="tab-btn" onclick="switchTab('timesheets')">Timesheets</button>
            <button class="tab-btn active" onclick="switchTab('allocation')">Labour Allocation</button>
        </div>

        <!-- Timesheets Tab -->
        <div id="timesheets-tab" class="tab-content">
        <!-- Section 1: System Prompt -->
        <div class="section system-prompt-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h2 onclick="toggleSystemPrompt()" style="cursor: pointer; margin: 0;">System Prompt <span id="promptToggle">‚ñº</span></h2>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div id="timesheetApiStatus" style="font-size: 11px; padding: 4px 8px; border-radius: 4px; border: 1px solid #e5e7eb;">
                        <!-- Populated dynamically -->
                    </div>
                    <button onclick="testGeminiAPI()" class="btn" style="background: #10b981; color: white; border: none; padding: 6px 12px; font-size: 12px;">üîç Test API</button>
                </div>
            </div>
            <textarea id="systemPrompt" style="display: none;" placeholder="Enter AI system prompt...">Generate technical work descriptions for weekly timesheets based on Gantt chart tasks.

Keep it simple and technical:
- Use plain language, no corporate jargon
- Avoid words like: "Focused on", "Conducted", "Executed", "Spearheaded"
- Focus on WHAT was done technically, not HOW it was managed
- Be specific: mention actual components, APIs, features, tests, bugs
- Vary the descriptions naturally - don't repeat phrases

Examples of good descriptions:
- "Built REST API endpoints for user authentication. Set up database schemas and migration scripts."
- "Fixed bugs in data processing pipeline. Added unit tests for edge cases."
- "Integrated third-party payment gateway. Updated documentation."

Examples to AVOID:
- "Focused on implementing key deliverables" (too vague)
- "Conducted extensive testing procedures" (too formal)
- "Executed project milestones successfully" (meaningless)

Return ONLY valid JSON:
{
  "weeks": [
    {
      "weekNum": 1,
      "description": "Built user authentication module. Wrote API docs."
    }
  ]
}

Do not include markdown, code blocks, or explanatory text.</textarea>
        </div>

        <!-- Section 2: Forecast Data -->
        <div class="section forecast-section">
            <h2>Forecast Data</h2>
            <p class="instructions">Select project and months from Labour Allocation table</p>

            <!-- Project Selection -->
            <div style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px; color: #374151;">Select Project:</label>
                <select id="forecastProjectSelect" onchange="onForecastProjectChange()" style="width: 100%; max-width: 350px; padding: 6px; font-size: 13px; border: 1px solid #ff9800; border-radius: 4px;">
                    <option value="">-- Select a project --</option>
                </select>
            </div>

            <!-- Month Selection -->
            <div style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px; color: #374151;">Select Months:</label>

                <!-- Quarter Quick Select -->
                <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                    <button type="button" onclick="selectQuarter(1)" class="btn" style="background: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; padding: 4px 12px; font-size: 11px;">Q1 (Jan-Mar)</button>
                    <button type="button" onclick="selectQuarter(2)" class="btn" style="background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; padding: 4px 12px; font-size: 11px;">Q2 (Apr-Jun)</button>
                    <button type="button" onclick="selectQuarter(3)" class="btn" style="background: #fff3e0; color: #e65100; border: 1px solid #ffcc80; padding: 4px 12px; font-size: 11px;">Q3 (Jul-Sep)</button>
                    <button type="button" onclick="selectQuarter(4)" class="btn" style="background: #fce4ec; color: #c2185b; border: 1px solid #f48fb1; padding: 4px 12px; font-size: 11px;">Q4 (Oct-Dec)</button>
                    <button type="button" onclick="clearMonthSelection()" class="btn" style="background: #f5f5f5; color: #666; border: 1px solid #ccc; padding: 4px 12px; font-size: 11px;">Clear</button>
                </div>

                <!-- Month Checkboxes -->
                <div id="monthCheckboxContainer" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 10px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 4px;">
                    <!-- Hidden checkboxes for form data -->
                    <input type="checkbox" id="month-01" class="month-checkbox" value="01" data-quarter="1" style="display: none;">
                    <input type="checkbox" id="month-02" class="month-checkbox" value="02" data-quarter="1" style="display: none;">
                    <input type="checkbox" id="month-03" class="month-checkbox" value="03" data-quarter="1" style="display: none;">
                    <input type="checkbox" id="month-04" class="month-checkbox" value="04" data-quarter="2" style="display: none;">
                    <input type="checkbox" id="month-05" class="month-checkbox" value="05" data-quarter="2" style="display: none;">
                    <input type="checkbox" id="month-06" class="month-checkbox" value="06" data-quarter="2" style="display: none;">
                    <input type="checkbox" id="month-07" class="month-checkbox" value="07" data-quarter="3" style="display: none;">
                    <input type="checkbox" id="month-08" class="month-checkbox" value="08" data-quarter="3" style="display: none;">
                    <input type="checkbox" id="month-09" class="month-checkbox" value="09" data-quarter="3" style="display: none;">
                    <input type="checkbox" id="month-10" class="month-checkbox" value="10" data-quarter="4" style="display: none;">
                    <input type="checkbox" id="month-11" class="month-checkbox" value="11" data-quarter="4" style="display: none;">
                    <input type="checkbox" id="month-12" class="month-checkbox" value="12" data-quarter="4" style="display: none;">

                    <!-- Large clickable month buttons -->
                    <button type="button" class="month-btn" data-month="01" onclick="toggleMonth('01')" style="padding: 12px 8px; font-size: 13px; font-weight: 500; border: 2px solid #d1d5db; border-radius: 6px; background: white; color: #6b7280; cursor: pointer; transition: all 0.2s;">Jan</button>
                    <button type="button" class="month-btn" data-month="02" onclick="toggleMonth('02')" style="padding: 12px 8px; font-size: 13px; font-weight: 500; border: 2px solid #d1d5db; border-radius: 6px; background: white; color: #6b7280; cursor: pointer; transition: all 0.2s;">Feb</button>
                    <button type="button" class="month-btn" data-month="03" onclick="toggleMonth('03')" style="padding: 12px 8px; font-size: 13px; font-weight: 500; border: 2px solid #d1d5db; border-radius: 6px; background: white; color: #6b7280; cursor: pointer; transition: all 0.2s;">Mar</button>
                    <button type="button" class="month-btn" data-month="04" onclick="toggleMonth('04')" style="padding: 12px 8px; font-size: 13px; font-weight: 500; border: 2px solid #d1d5db; border-radius: 6px; background: white; color: #6b7280; cursor: pointer; transition: all 0.2s;">Apr</button>
                    <button type="button" class="month-btn" data-month="05" onclick="toggleMonth('05')" style="padding: 12px 8px; font-size: 13px; font-weight: 500; border: 2px solid #d1d5db; border-radius: 6px; background: white; color: #6b7280; cursor: pointer; transition: all 0.2s;">May</button>
                    <button type="button" class="month-btn" data-month="06" onclick="toggleMonth('06')" style="padding: 12px 8px; font-size: 13px; font-weight: 500; border: 2px solid #d1d5db; border-radius: 6px; background: white; color: #6b7280; cursor: pointer; transition: all 0.2s;">Jun</button>
                    <button type="button" class="month-btn" data-month="07" onclick="toggleMonth('07')" style="padding: 12px 8px; font-size: 13px; font-weight: 500; border: 2px solid #d1d5db; border-radius: 6px; background: white; color: #6b7280; cursor: pointer; transition: all 0.2s;">Jul</button>
                    <button type="button" class="month-btn" data-month="08" onclick="toggleMonth('08')" style="padding: 12px 8px; font-size: 13px; font-weight: 500; border: 2px solid #d1d5db; border-radius: 6px; background: white; color: #6b7280; cursor: pointer; transition: all 0.2s;">Aug</button>
                    <button type="button" class="month-btn" data-month="09" onclick="toggleMonth('09')" style="padding: 12px 8px; font-size: 13px; font-weight: 500; border: 2px solid #d1d5db; border-radius: 6px; background: white; color: #6b7280; cursor: pointer; transition: all 0.2s;">Sep</button>
                    <button type="button" class="month-btn" data-month="10" onclick="toggleMonth('10')" style="padding: 12px 8px; font-size: 13px; font-weight: 500; border: 2px solid #d1d5db; border-radius: 6px; background: white; color: #6b7280; cursor: pointer; transition: all 0.2s;">Oct</button>
                    <button type="button" class="month-btn" data-month="11" onclick="toggleMonth('11')" style="padding: 12px 8px; font-size: 13px; font-weight: 500; border: 2px solid #d1d5db; border-radius: 6px; background: white; color: #6b7280; cursor: pointer; transition: all 0.2s;">Nov</button>
                    <button type="button" class="month-btn" data-month="12" onclick="toggleMonth('12')" style="padding: 12px 8px; font-size: 13px; font-weight: 500; border: 2px solid #d1d5db; border-radius: 6px; background: white; color: #6b7280; cursor: pointer; transition: all 0.2s;">Dec</button>
                </div>

                <!-- Year Selection -->
                <div style="margin-top: 8px;">
                    <label style="font-size: 11px; color: #666; margin-right: 6px;">Year:</label>
                    <select id="forecastYearSelect" style="padding: 4px 8px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary" onclick="loadAllocationData()">Load Allocation Data</button>

            <!-- Preview Table -->
            <div id="forecastPreview"></div>
        </div>

        <!-- Section 3: Load Gantt -->
        <div class="section gantt-section">
            <h2>Gantt</h2>

            <div style="margin-bottom: 8px;">
                <select id="ganttDropdown" class="gantt-dropdown">
                    <option value="">-- Select Gantt --</option>
                </select>
                <button class="btn btn-success" onclick="loadGanttProject()">Load</button>
                <button class="btn btn-info" onclick="document.getElementById('ganttFileInput').click()">JSON File</button>
                <input type="file" id="ganttFileInput" accept=".json" style="display:none" onchange="loadGanttFromFile(event)">
                <span id="selectedFileName" style="margin-left: 8px; color: #666; font-size: 11px;"></span>
            </div>
            
            <div id="ganttSummary"></div>
        </div>

        <!-- Section 4: Generate Timesheet -->
        <div class="section generate-section">
            <h2>Generate</h2>
            <div class="cost-estimate">
                <p class="cost-amount">$<span id="estimatedCost">0.00</span></p>
            </div>
            <button class="btn btn-success" id="generateBtn" onclick="generateTimesheets()">
                Generate
            </button>
        </div>

        <!-- Section 5: Processing Log -->
        <div class="section log-section">
            <h2>Log</h2>
            <div id="processingLog" style="background: #1e1e1e; color: #00ff00; padding: 8px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 10px; max-height: 200px; overflow-y: auto; white-space: pre-wrap;"></div>
        </div>

        <!-- Section 6: Timesheet Output -->
        <div class="section output-section">
            <h2>Output</h2>
            <div id="validationWarnings"></div>
            <div id="timesheetOutput">
                <p class="empty-state">Generate timesheet data to see output here.</p>
            </div>
        </div>

        <!-- Section 7: Export Options -->
        <div class="section">
            <h2>Export</h2>
            <button class="btn btn-info" onclick="copyForExcel()">Copy Weeks</button>
            <button class="btn btn-warning" onclick="downloadCSV()">CSV</button>
            <button class="btn btn-success" onclick="showHistory()">History</button>
            <button class="btn btn-danger" onclick="clearTimesheet()">Clear</button>
        </div>

        <!-- Section 7b: Approve & Save -->
        <div class="section" style="background-color: #e3f2fd; border-left: 3px solid #2196f3;">
            <h2>Approve & Save</h2>
            <p style="font-size: 11px; color: #666; margin-bottom: 10px;">Add signatures to approve timesheets, then save for later recall.</p>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="btn" id="addSignaturesBtn" onclick="showSignatureModal()" style="background: #7c4dff; color: white;" disabled>‚úçÔ∏è Add Signatures</button>
                <button class="btn" id="approveAllBtn" onclick="approveAllTimesheets()" style="background: #00c853; color: white;" disabled>‚úÖ Approve All</button>
                <button class="btn" onclick="saveTimesheetToDatabase()" style="background: #2196f3; color: white;">üíæ Save</button>
                <button class="btn" onclick="showLoadTimesheetModal()" style="background: #ff9800; color: white;">üìÇ Load</button>
            </div>
            <div id="signatureStatus" style="margin-top: 8px; font-size: 11px; color: #666;"></div>
        </div>

        <!-- Signature Management Modal -->
        <div id="signatureModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
            <div style="background:white; margin:30px auto; padding:20px; max-width:700px; border-radius:8px; max-height:85vh; overflow-y:auto;">
                <h2 style="margin-top:0;">‚úçÔ∏è Manage Signatures</h2>
                <p style="font-size: 12px; color: #666;">Upload PNG images or paste signatures from clipboard for each staff member.</p>
                <div id="signatureList" style="margin: 15px 0;"></div>
                <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                    <button class="btn btn-secondary" onclick="closeSignatureModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- Load Timesheet Modal -->
        <div id="loadTimesheetModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
            <div style="background:white; margin:50px auto; padding:20px; max-width:600px; border-radius:8px; max-height:80vh; overflow-y:auto;">
                <h2 style="margin-top:0;">üìÇ Load Saved Timesheet</h2>
                <div id="savedTimesheetList" style="margin: 15px 0;"></div>
                <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="closeLoadTimesheetModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- History Modal (hidden by default) -->
        <div id="historyModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
            <div style="background:white; margin:50px auto; padding:30px; max-width:800px; border-radius:8px; max-height:80vh; overflow-y:auto;">
                <h2>Generation History</h2>
                <div id="historyList"></div>
                <button class="btn btn-secondary" onclick="closeHistory()">Close</button>
            </div>
        </div>


        <!-- Section 8: Merge Payslips -->
        <div class="section" style="background-color: #e8f5e9; border-left: 3px solid #4caf50;">
            <h2>Merge Payslips</h2>

            <div style="margin-bottom: 8px;">
                <button class="btn btn-success" onclick="selectPayslipFolder()">üìÅ Folder</button>
                <span id="payslipFolderStatus" style="margin-left: 8px; color: #666; font-size: 11px;"></span>
            </div>

            <div style="margin-bottom: 8px;">
                <button class="btn btn-primary" onclick="addPayslipMember()" style="font-size: 11px; padding: 4px 8px;">+ Add Staff</button>
                <button class="btn btn-secondary" onclick="managePayslipMembers()" style="font-size: 11px; padding: 4px 8px;">‚öôÔ∏è Manage Staff</button>
            </div>

            <div style="margin-bottom: 8px; overflow-x: auto;">
                <div style="margin-bottom: 6px;">
                    <label style="font-weight: 500; font-size: 11px; margin-right: 6px;">Year:</label>
                    <select id="payslipYear" style="padding: 3px; font-size: 11px; border-radius: 3px; border: 1px solid #ccc;">
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
                <table style="border-collapse: collapse; width: 100%; font-size: 11px;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Member</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Jan</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Feb</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Mar</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Apr</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">May</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Jun</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Jul</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Aug</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Sep</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Oct</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Nov</th>
                            <th style="border: 1px solid #ddd; padding: 4px; background: #4caf50; color: white;">Dec</th>
                        </tr>
                    </thead>
                    <tbody id="payslipMembersTableBody">
                        <!-- Staff members will be dynamically generated here -->
                    </tbody>
                </table>
            </div>

            <div style="margin-bottom: 6px;">
                <button class="btn btn-primary" id="fetchPayslipsBtn" onclick="fetchPayslips()" disabled>Fetch</button>
                <button class="btn btn-success" id="mergePayslipsBtn" onclick="mergePayslips()" style="display: none;">Merge</button>
                <span id="payslipCount" style="margin-left: 8px; font-size: 11px; color: #666;"></span>
            </div>

            <div id="fetchedPayslipsDisplay" style="display: none; font-size: 11px;">
                <div id="fetchedPayslipsList"></div>
            </div>
        </div>

        </div> <!-- End Timesheets Tab -->

        <!-- Labour Allocation Tab -->
        <div id="allocation-tab" class="tab-content active">
            <div class="section">
                <h2>Labour Allocation</h2>

                <div style="margin-bottom: 10px;">
                    <button class="btn btn-success" onclick="showAddLineDialog()">+ Line</button>
                    <button class="btn btn-info" onclick="addProject()">+ Project</button>
                    <button class="btn btn-primary" onclick="showGrantLinkModal()" style="background: #2196F3; color: white;">üîó Link Grant</button>
                    <button class="btn btn-warning" onclick="showCopyMonthDialog()" style="background: #ff9800; color: white;">üìã Copy Month</button>
                    <button class="btn btn-warning" onclick="showHideMonthDialog()" style="background: #9c27b0; color: white;">üëÅÔ∏è Hide Month</button>
                    <button class="btn btn-secondary" onclick="showAllProjects()" style="background: #607D8B;">Show All</button>
                    <button class="btn btn-success" onclick="showExportDialog()" style="background: #10b981; color: white;">üì§ Export Data</button>
                </div>

                <!-- Labour Budget Section -->
                <div style="margin-bottom: 12px; padding: 10px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h3 style="margin: 0; color: #1e40af; font-size: 14px;">üíº Labour Budget</h3>
                        <button onclick="toggleLabourBudgetCollapse()" id="labourBudgetCollapseBtn" style="background: none; border: none; color: #64748b; cursor: pointer; font-size: 18px; padding: 0; line-height: 1;" title="Collapse/Expand">‚ñº</button>
                    </div>

                    <div id="labourBudgetContent">
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px; color: #374151;">Select Grant Project:</label>
                            <select id="budgetProjectSelect" onchange="loadProjectBudgetData()" style="width: 100%; max-width: 350px; padding: 6px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 4px;">
                                <option value="">-- Select a project --</option>
                            </select>
                        </div>

                        <div id="budgetTableContainer" style="display: none;">
                            <table id="labourBudgetTable" style="width: 100%; max-width: 800px; border-collapse: collapse; margin-bottom: 10px;">
                                <thead>
                                    <tr style="background: #f1f5f9;">
                                        <th style="padding: 6px; text-align: left; border: 1px solid #e2e8f0; font-size: 12px;">Role</th>
                                        <th style="padding: 6px; text-align: left; border: 1px solid #e2e8f0; font-size: 12px; width: 130px;">Day Rate (¬£/day)</th>
                                        <th style="padding: 6px; text-align: left; border: 1px solid #e2e8f0; font-size: 12px; width: 100px;">Days</th>
                                        <th style="padding: 6px; text-align: right; border: 1px solid #e2e8f0; font-size: 12px; width: 130px;">Total (¬£)</th>
                                        <th style="padding: 6px; text-align: center; border: 1px solid #e2e8f0; font-size: 12px; width: 50px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="labourBudgetTableBody">
                                    <tr>
                                        <td colspan="5" style="text-align: center; padding: 15px; color: #999; font-size: 12px;">Click "+ Add Row" to get started</td>
                                    </tr>
                                </tbody>
                            </table>

                            <div style="display: flex; gap: 8px; margin-bottom: 12px; align-items: center; flex-wrap: wrap;">
                                <button onclick="addBudgetRowNew()" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px;">+ Add Row</button>
                                <button onclick="saveBudgetData()" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px;">üíæ Save</button>
                                <div id="labourBudgetTotalBox" style="margin-left: auto; padding: 8px 16px; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); border-radius: 6px; color: white; display: none;">
                                    <div style="font-size: 11px; opacity: 0.9;">Total Labour Budget</div>
                                    <div id="labourBudgetTotalValue" style="font-size: 18px; font-weight: 700;">¬£0.00</div>
                                </div>
                            </div>

                            <!-- Budget Notes Section -->
                            <div id="budgetNotesSection" style="margin-top: 12px; padding: 10px; background: #fefce8; border: 1px solid #fde047; border-radius: 4px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <h4 style="margin: 0; color: #854d0e; font-size: 13px;">üìù Budget Notes</h4>
                                    <button onclick="toggleNotesSection()" id="notesSectionToggle" style="background: none; border: none; color: #854d0e; cursor: pointer; font-size: 14px; padding: 0;">‚ñº</button>
                                </div>
                                <div id="budgetNotesContent">
                                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                                        <input type="text" id="newBudgetNoteInput" placeholder="Type a note and press Add..."
                                            style="flex: 1; padding: 8px 12px; font-size: 13px; border: 1px solid #fde047; border-radius: 4px; background: white;"
                                            onkeypress="if(event.key==='Enter') addBudgetNote()">
                                        <button onclick="addBudgetNote()" style="background: #eab308; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500;">+ Add</button>
                                    </div>
                                    <div id="budgetNotesList" style="max-height: 200px; overflow-y: auto;">
                                        <p style="color: #a16207; font-size: 12px; margin: 0; font-style: italic;">No notes yet. Add a note above.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Labour Allocation Breakdown -->
                            <div id="labourAllocationBreakdown" style="margin-top: 12px; padding: 10px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 4px;">
                                <h4 style="margin: 0 0 10px 0; color: #166534; font-size: 13px;">üìä Allocation Breakdown (from Labour Table)</h4>
                                <div id="allocationBreakdownContent">
                                    <!-- Breakdown will be populated here -->
                                </div>
                            </div>

                            <!-- Quarterly Spend Breakdown -->
                            <div id="quarterlySpendBreakdown" style="margin-top: 12px; padding: 10px; background: #eff6ff; border: 1px solid #93c5fd; border-radius: 4px;">
                                <h4 style="margin: 0 0 10px 0; color: #1e40af; font-size: 13px;">üìÖ Quarterly Spend Breakdown</h4>
                                <div id="quarterlyBreakdownContent">
                                    <!-- Quarterly breakdown will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Copy Month Dialog -->
                <div id="copyMonthDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 500px; width: 90%;">
                        <h3 style="margin-top: 0; color: #1e40af;">üìã Copy Month Data</h3>
                        <p style="color: #6b7280; font-size: 13px; margin-bottom: 20px;">Copy labour allocation data from one month to another. You can copy to past or future months.</p>

                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">From (source month):</label>
                            <select id="copyMonthSelect" onchange="updateCopyMonthPreview()" style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #d1d5db; border-radius: 4px;">
                                <option value="">-- Select source month --</option>
                            </select>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">To (destination month):</label>
                            <select id="copyToMonthSelect" onchange="updateCopyMonthPreview()" style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #d1d5db; border-radius: 4px;">
                                <option value="">-- Select destination month --</option>
                            </select>
                        </div>

                        <div id="copyMonthPreview" style="margin-bottom: 20px; padding: 15px; background: #f3f4f6; border-radius: 4px; display: none;">
                            <p style="margin: 0; color: #374151;"><strong>Preview:</strong></p>
                            <p id="copyMonthPreviewText" style="margin: 10px 0 0 0; color: #6b7280;"></p>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeCopyMonthDialog()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Cancel</button>
                            <button id="executeCopyBtn" onclick="executeCopyMonth()" disabled style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Copy</button>
                        </div>
                    </div>
                </div>

                <!-- Add Line Dialog -->
                <div id="addLineDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 500px; width: 90%;">
                        <h3 style="margin-top: 0; color: #10b981;">‚ûï Add New Line</h3>
                        <p style="color: #6b7280; font-size: 13px; margin-bottom: 20px;">Select the month where you want to add the new line. The line will be added at the end of that month.</p>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Month:</label>
                            <select id="addLineMonthSelect" style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #d1d5db; border-radius: 4px;">
                                <option value="">-- Select month --</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeAddLineDialog()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Cancel</button>
                            <button id="executeAddLineBtn" onclick="executeAddLine()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Add Line</button>
                        </div>
                    </div>
                </div>

                <!-- Hide Month Dialog -->
                <div id="hideMonthDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin-top: 0; color: #1e40af;">üëÅÔ∏è Hide or Grey Out Months</h3>

                        <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
                            Choose to grey out (show as completed) or hide (completely hidden from view) each month.
                        </p>

                        <div id="hideMonthList" style="margin-bottom: 20px;">
                            <!-- Month list will be populated here -->
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeHideMonthDialog()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Close</button>
                        </div>
                    </div>
                </div>

                <!-- Export Data Dialog -->
                <div id="exportDataDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin-top: 0; color: #1e40af;">üì§ Export Labour Allocation Data</h3>

                        <p style="color: #6b7280; font-size: 13px; margin-bottom: 20px;">
                            Select the projects and months you want to include in your export. Only staff with allocations in the selected months/projects will be included.
                        </p>

                        <!-- Project Selection -->
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="margin: 0; color: #374151; font-size: 14px;">Select Projects:</h4>
                                <label style="cursor: pointer; font-size: 13px; color: #3b82f6;">
                                    <input type="checkbox" id="selectAllProjects" onchange="toggleAllProjects()" style="margin-right: 5px;">
                                    Select All
                                </label>
                            </div>
                            <div id="exportProjectList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px; padding: 10px; background: #f9fafb;">
                                <!-- Project checkboxes populated by showExportDialog() -->
                            </div>
                        </div>

                        <!-- Month Selection -->
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="margin: 0; color: #374151; font-size: 14px;">Select Months:</h4>
                                <label style="cursor: pointer; font-size: 13px; color: #3b82f6;">
                                    <input type="checkbox" id="selectAllMonths" onchange="toggleAllMonths()" style="margin-right: 5px;">
                                    Select All
                                </label>
                            </div>
                            <div id="exportMonthList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px; padding: 10px; background: #f9fafb;">
                                <!-- Month checkboxes populated by showExportDialog() -->
                            </div>
                        </div>

                        <!-- Format Selection -->
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #374151; font-size: 14px;">Export Format:</h4>
                            <div style="display: flex; gap: 15px;">
                                <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; transition: all 0.2s;">
                                    <input type="radio" name="exportFormat" value="xlsx" style="margin-right: 8px;">
                                    <span style="font-weight: 500; color: #374151;">üìä Excel (.xlsx)</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; transition: all 0.2s;">
                                    <input type="radio" name="exportFormat" value="pdf" checked style="margin-right: 8px;">
                                    <span style="font-weight: 500; color: #374151;">üìÑ PDF (Landscape)</span>
                                </label>
                            </div>
                        </div>

                        <!-- Export Preview -->
                        <div id="exportPreview" style="margin-bottom: 20px; padding: 12px; background: #eff6ff; border: 1px solid #93c5fd; border-radius: 4px; display: none;">
                            <p style="margin: 0; color: #1e40af; font-size: 13px; font-weight: 600;">Preview:</p>
                            <p id="exportPreviewText" style="margin: 8px 0 0 0; color: #3b82f6; font-size: 13px;"></p>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeExportDialog()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Cancel</button>
                            <button id="executeExportBtn" onclick="executeExport()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600;">üì§ Export</button>
                        </div>
                    </div>
                </div>

                <!-- Grant Link Modal -->
                <div id="grantLinkModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin-top: 0; color: #1e40af;">üîó Link Grant to Labour Allocation Project</h3>

                        <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
                            Select one grant from the left and one labour project from the right, then click "Link Selected"
                        </p>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <!-- Column 1: Grants from Database -->
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #374151; font-size: 14px;">üìä Grants (from Grants page)</h4>
                                <div id="grantListColumn" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px; background: #f9fafb;">
                                    <!-- Grants will be populated here -->
                                </div>
                                <p id="noGrantsMessage" style="text-align: center; color: #9ca3af; padding: 20px; font-size: 12px; display: none;">
                                    No grants found
                                </p>
                            </div>

                            <!-- Column 2: Labour Allocation Projects -->
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #374151; font-size: 14px;">üìã Labour Projects</h4>
                                <div id="labourProjectListColumn" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px; background: #f9fafb;">
                                    <!-- Labour projects will be populated here -->
                                </div>
                                <p id="noLabourProjectsMessage" style="text-align: center; color: #9ca3af; padding: 20px; font-size: 12px; display: none;">
                                    No labour projects found
                                </p>
                            </div>
                        </div>

                        <div style="padding: 15px; background: #f3f4f6; border-radius: 4px; margin-bottom: 20px;">
                            <div id="linkSelectionPreview" style="color: #6b7280; font-size: 13px;">
                                Please select one grant and one labour project
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeGrantLinkModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Cancel</button>
                            <button id="linkSelectedBtn" onclick="linkSelectedGrantAndProject()" disabled style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; opacity: 0.5;">Link Selected</button>
                        </div>
                    </div>
                </div>

                <!-- Labour Budget Summary Section (Collapsible) -->
                <div id="labourBudgetSection" style="display: none; margin-bottom: 20px; padding: 20px; background: #f8fafc; border: 2px solid #3b82f6; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #1e40af;" id="labourBudgetSectionTitle">Labour Budget Summary</h3>
                        <button onclick="closeLabourBudgetSection()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">Close</button>
                    </div>

                    <div id="labourBudgetSectionContent">
                        <!-- Step 1: Add Staff Member -->
                        <div id="addStaffSectionInline" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <h4 style="margin-top: 0; font-size: 14px;">Add Staff Member</h4>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="staffMemberSelectInline" style="flex: 1; padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;">
                                    <option value="">-- Select Staff Member --</option>
                                </select>
                                <button class="btn btn-primary" onclick="addStaffAllocationInline()" style="white-space: nowrap;">+ Add</button>
                            </div>
                        </div>

                        <!-- Staff Allocations List -->
                        <div id="staffAllocationsListInline" style="margin-bottom: 20px;">
                            <!-- Staff allocations will be added here dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Labour allocation table -->
                <div style="overflow-x: auto; max-height: 70vh; overflow-y: auto;">
                    <p style="font-size: 10px; color: #666; margin-bottom: 6px;">‚ìò Tip: Type = then click cells to add references. Hover cells for the drag handle (blue dot) to autofill formulas. All editable (yellow) cells support formulas!</p>
                    <table id="labourTable" style="border-collapse: collapse; font-size: 11px; width: 100%; min-width: 1400px;" tabindex="0">
                        <thead style="position: sticky; top: 0; z-index: 10; background: white;">
                            <tr id="columnLetterRow" style="background: #f5f5f5;">
                                <th style="border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; position: sticky; left: 0; z-index: 12; background: #f5f5f5; width: 24px; min-width: 24px;"></th>
                                <th style="border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; position: sticky; left: 24px; z-index: 12; background: #f5f5f5;">A</th>
                                <th style="border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; position: sticky; left: 74px; z-index: 12; background: #f5f5f5;">B</th>
                                <th style="border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; background: #f5f5f5;">C</th>
                                <th style="border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; background: #f5f5f5;">D</th>
                                <th style="border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; background: #f5f5f5;">E</th>
                                <th style="border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; background: #f5f5f5;">F</th>
                                <th style="border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; background: #f5f5f5;">G</th>
                                <th style="border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; background: #f5f5f5;">H</th>
                                <!-- Project column letters will be added dynamically here -->
                            </tr>
                            <tr id="projectHeaderRow">
                                <th rowspan="2" style="border: 1px solid #ddd; padding: 2px; background: #2B7A78; color: white; min-width: 24px; width: 24px; max-width: 24px; position: sticky; left: 0; z-index: 12; font-size: 16px; cursor: move; user-select: none;" title="Drag to reorder rows">‚†ø</th>
                                <th rowspan="2" style="border: 1px solid #ddd; padding: 2px; background: #2B7A78; color: white; min-width: 50px; width: 50px; max-width: 50px; position: sticky; left: 24px; z-index: 12; font-size: 10px;">Month</th>
                                <th rowspan="2" style="border: 1px solid #ddd; padding: 2px; background: #2B7A78; color: white; min-width: 80px; width: 80px; max-width: 80px; position: sticky; left: 74px; z-index: 12; font-size: 10px;">Staff</th>
                                <th colspan="6" style="border: 1px solid #ddd; padding: 4px; background: #3AAFA9; color: white;">Payslip</th>
                                <!-- Projects will be added dynamically here -->
                            </tr>
                            <tr id="columnHeaderRow">
                                <th style="border: 1px solid #ddd; padding: 4px; background: #5ec4be; color: white; font-size: 10px;">Gross</th>
                                <th style="border: 1px solid #ddd; padding: 4px; background: #5ec4be; color: white; font-size: 10px;">FTE</th>
                                <th style="border: 1px solid #ddd; padding: 2px; background: #5ec4be; color: white; font-size: 10px; max-width: 50px; width: 50px; overflow: hidden; text-overflow: clip;">¬£/yr (if full time)</th>
                                <th style="border: 1px solid #ddd; padding: 2px; background: #5ec4be; color: white; font-size: 10px; max-width: 50px; width: 50px; overflow: hidden; text-overflow: clip;">¬£/yr (as paid)</th>
                                <th onclick="configureDailyRate()" style="border: 1px solid #ddd; padding: 4px; background: #5ec4be; color: white; font-size: 10px; cursor: pointer; user-select: none;" title="Click to configure working days per year">¬£/day ‚öô</th>
                                <th onclick="configureHourlyRate()" style="border: 1px solid #ddd; padding: 4px; background: #5ec4be; color: white; font-size: 10px; cursor: pointer; user-select: none;" title="Click to configure hours per day">¬£/hr ‚öô</th>
                                <!-- Project columns will be added dynamically here -->
                            </tr>
                        </thead>
                        <tbody id="labourTableBody">
                            <!-- Rows will be added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


    <script>
        // API key from localStorage (user must set it)
        let API_KEY = localStorage.getItem('gemini_api_key') || '';

        // Prompt for API key if not set
        if (!API_KEY) {
            const key = prompt('Please enter your Gemini API key:\n(It will be saved in browser localStorage)');
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                API_KEY = key;
                console.log('‚úì Gemini API key saved to localStorage');
            }
        } else {
            console.log('‚úì Using existing Gemini API key from localStorage');
        }

        // Data storage
        let forecastData = [];

        // Update API key status display
        function updateTimesheetAPIStatus() {
            const statusDiv = document.getElementById('timesheetApiStatus');
            statusDiv.style.cursor = 'pointer';
            statusDiv.onclick = setTimesheetAPIKey;

            if (API_KEY && API_KEY.length > 0) {
                const maskedKey = API_KEY.substring(0, 7) + '...' + API_KEY.substring(API_KEY.length - 4);
                statusDiv.innerHTML = `<span style="color: #059669;">‚úÖ Gemini: ${maskedKey} (click to update)</span>`;
                statusDiv.style.borderColor = '#10b981';
                statusDiv.style.background = '#ecfdf5';
            } else {
                statusDiv.innerHTML = '<span style="color: #dc2626;">‚ùå Not configured (click to set)</span>';
                statusDiv.style.borderColor = '#ef4444';
                statusDiv.style.background = '#fee2e2';
            }
        }

        // Function to set/update API key (can be called from timesheet page too)
        function setTimesheetAPIKey() {
            const newKey = prompt('Enter your Gemini API Key:\n\n(Get one from: https://aistudio.google.com/app/apikey)\n\nNote: This key is shared across all pages.', API_KEY || '');
            if (newKey && newKey.trim() !== '') {
                API_KEY = newKey.trim();
                localStorage.setItem('gemini_api_key', API_KEY);
                updateTimesheetAPIStatus();
                showToast('‚úÖ Gemini API Key saved', 'success');
            }
        }

        // Test Gemini API connection
        async function testGeminiAPI() {
            if (!API_KEY) {
                showToast('No Gemini API key found. Please set your key first.', 'error');
                if (confirm('Would you like to set your Gemini API key now?')) {
                    setTimesheetAPIKey();
                    if (!API_KEY) return;
                } else {
                    return;
                }
            }

            log('Testing Gemini API connection...', 'info');
            log(`Using model: gemini-2.5-flash (latest stable)`, 'info');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: 'Say "Hello, API is working!" in exactly those words.' }]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API Test Error:', errorData);
                    const errorMsg = errorData.error?.message || JSON.stringify(errorData);
                    const errorCode = errorData.error?.code || response.status;
                    const errorStatus = errorData.error?.status || 'UNKNOWN';

                    log(`‚ùå API Test Failed (${errorCode}): ${errorMsg}`, 'error');
                    log(`Error status: ${errorStatus}`, 'error');
                    log(`Full error: ${JSON.stringify(errorData, null, 2)}`, 'error');
                    showToast(`API test failed: ${errorMsg}`, 'error');
                    return;
                }

                const data = await response.json();
                const responseText = data.candidates[0].content.parts[0].text;
                console.log('API Test Response:', data);
                log(`‚úì API Test Successful! Response: "${responseText}"`, 'success');
                showToast('Gemini API is working correctly!', 'success');
                updateTimesheetAPIStatus(); // Update status to show success

            } catch (error) {
                console.error('API Test Error:', error);
                log(`‚ùå API Test Error: ${error.message}`, 'error');
                showToast(`API test error: ${error.message}`, 'error');
            }
        }

        // Toggle system prompt visibility
        function toggleSystemPrompt() {
            const textarea = document.getElementById('systemPrompt');
            const toggle = document.getElementById('promptToggle');

            if (textarea.style.display === 'none') {
                textarea.style.display = 'block';
                toggle.textContent = '‚ñ≤';
            } else {
                textarea.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }

                // Processing log helper
        function log(message, type = 'info') {
            const logDiv = document.getElementById('processingLog');
            const colors = {
                info: '#00bfff',
                success: '#00ff00',
                warning: '#ffaa00',
                error: '#ff4444'
            };
            const color = colors[type] || colors.info;
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>
`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('processingLog').innerHTML = '';
        }

        // Parse month string to index (0-11)
        function parseMonthToIndex(monthStr) {
            const monthMap = {
                'jan': 0, 'january': 0,
                'feb': 1, 'february': 1,
                'mar': 2, 'march': 2,
                'apr': 3, 'april': 3,
                'may': 4,
                'jun': 5, 'june': 5,
                'jul': 7, 'july': 7,
                'aug': 8, 'august': 8,
                'sep': 9, 'september': 9,
                'oct': 10, 'october': 10,
                'nov': 11, 'november': 11,
                'dec': 12, 'december': 12
            };
            
            const lower = monthStr.toLowerCase().trim();
            
            // Check if it's already a month name
            if (monthMap[lower] !== undefined) {
                return monthMap[lower];
            }
            
            // Check if it's YYYY-MM format
            if (monthStr.includes('-')) {
                const parts = monthStr.split('-');
                return parseInt(parts[1]) - 1;
            }
            
            return -1;
        }

        // Get active tasks for a specific month
        function getActiveTasksForMonth(monthIndex) {
            if (!ganttData) return [];
            
            const activeTasks = [];
            ganttData.tasks.forEach((task, taskIndex) => {
                const key = `${taskIndex}-${monthIndex}`;
                if (ganttData.ganttData[key]) {
                    activeTasks.push(task);
                }
            });
            
            return activeTasks;
        }

        // Calculate proper In/Out times for weekly hours
        function calculateInOutTimes(weeklyHours) {
            const daysNeeded = Math.ceil(weeklyHours / 8);
            const result = [];
            
            let remainingHours = weeklyHours;
            
            for (let day = 0; day < daysNeeded && remainingHours > 0; day++) {
                const hoursThisDay = Math.min(8, remainingHours);
                
                // Calculate out time based on hours (8 hours = 9:00-17:00)
                const startHour = 9;
                const endHour = startHour + hoursThisDay;
                const inTime = `${startHour.toString().padStart(2, '0')}:00`;
                const outTime = `${endHour.toString().padStart(2, '0')}:00`;
                
                result.push({ in: inTime, out: outTime, hours: hoursThisDay });
                remainingHours -= hoursThisDay;
            }
            
            return result;
        }

        let ganttData = null;
        let timesheetData = [];
        let currentTimesheetProject = ''; // Store the project name for the current timesheet

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // Remove active from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            if (tabName === 'timesheets') {
                document.getElementById('timesheets-tab').classList.add('active');
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                // Populate the forecast project dropdown with labour projects
                populateForecastProjectDropdown();
            } else if (tabName === 'allocation') {
                document.getElementById('allocation-tab').classList.add('active');
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadGanttProjects();
            loadSystemPrompt();
            loadPayslipFolder();
            renderPayslipMembersTable(); // Render payslip members table
            updateTimesheetAPIStatus(); // Show API key status on load
        });

        // Save/Load system prompt from localStorage
        function loadSystemPrompt() {
            const saved = localStorage.getItem('timesheet_system_prompt');
            if (saved) {
                document.getElementById('systemPrompt').value = saved;
            }
        }

        function saveSystemPrompt() {
            const prompt = document.getElementById('systemPrompt').value;
            localStorage.setItem('timesheet_system_prompt', prompt);
        }

        // Populate forecast project dropdown from labourProjects
        function populateForecastProjectDropdown() {
            const dropdown = document.getElementById('forecastProjectSelect');
            if (!dropdown) return;

            dropdown.innerHTML = '<option value="">-- Select a project --</option>';

            if (labourProjects && labourProjects.length > 0) {
                labourProjects.forEach((project, idx) => {
                    // Skip hidden projects
                    if (hiddenProjects.has(project.name)) return;

                    const option = document.createElement('option');
                    option.value = idx;
                    option.textContent = project.name;
                    dropdown.appendChild(option);
                });
            }
        }

        // Handle project selection change
        function onForecastProjectChange() {
            // Clear the preview when project changes
            document.getElementById('forecastPreview').innerHTML = '';
            forecastData = [];
            updateCostEstimate();
        }

        // Toggle individual month button
        function toggleMonth(monthValue) {
            const checkbox = document.getElementById(`month-${monthValue}`);
            const button = document.querySelector(`.month-btn[data-month="${monthValue}"]`);

            // Toggle checkbox state
            checkbox.checked = !checkbox.checked;

            // Update button appearance
            updateMonthButtonStyle(button, checkbox.checked);
        }

        // Update button visual state
        function updateMonthButtonStyle(button, isSelected) {
            if (isSelected) {
                button.style.background = '#3b82f6';
                button.style.color = 'white';
                button.style.borderColor = '#2563eb';
                button.style.fontWeight = '600';
            } else {
                button.style.background = 'white';
                button.style.color = '#6b7280';
                button.style.borderColor = '#d1d5db';
                button.style.fontWeight = '500';
            }
        }

        // Select months for a specific quarter (1=Q1, 2=Q2, 3=Q3, 4=Q4)
        function selectQuarter(quarter) {
            const checkboxes = document.querySelectorAll('.month-checkbox');
            checkboxes.forEach(cb => {
                if (parseInt(cb.dataset.quarter) === quarter) {
                    cb.checked = true;
                    // Update corresponding button
                    const monthValue = cb.value;
                    const button = document.querySelector(`.month-btn[data-month="${monthValue}"]`);
                    if (button) updateMonthButtonStyle(button, true);
                }
            });
        }

        // Clear all month selections
        function clearMonthSelection() {
            const checkboxes = document.querySelectorAll('.month-checkbox');
            const buttons = document.querySelectorAll('.month-btn');

            checkboxes.forEach(cb => {
                cb.checked = false;
            });

            buttons.forEach(btn => {
                updateMonthButtonStyle(btn, false);
            });
        }

        // Month number to short name mapping (for forecast display)
        const monthShortNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        // Load allocation data from labourRows
        function loadAllocationData() {
            const projectIdx = parseInt(document.getElementById('forecastProjectSelect').value);
            const selectedYear = document.getElementById('forecastYearSelect').value;
            const selectedMonths = Array.from(document.querySelectorAll('.month-checkbox:checked')).map(cb => cb.value);

            if (isNaN(projectIdx)) {
                showToast('Please select a project first', 'error');
                return;
            }

            if (selectedMonths.length === 0) {
                showToast('Please select at least one month', 'error');
                return;
            }

            const projectName = labourProjects[projectIdx]?.name || '';
            forecastData = [];

            // Build list of YYYY-MM strings for filtering
            const targetMonths = selectedMonths.map(m => `${selectedYear}-${m}`);

            // Scan labourRows for matching entries
            labourRows.forEach(row => {
                // Check if row's month matches selected year-months
                if (!row.month || !targetMonths.includes(row.month)) return;

                // Check if this row has allocation for the selected project
                const projectAllocation = row.projects[projectIdx];
                if (!projectAllocation) return;

                const days = projectAllocation.days || 0;
                const rate = projectAllocation.rate || 0;
                const total = projectAllocation.total || (days * rate);

                // Only include rows with actual allocation (days > 0)
                if (days <= 0) return;

                // Calculate hours (days * hoursPerDay)
                const hours = days * hoursPerDay;

                // Parse month for display (YYYY-MM -> "Apr")
                const monthNum = parseInt(row.month.split('-')[1]);
                const monthShort = monthShortNames[monthNum] || row.month;

                forecastData.push({
                    month: monthShort,
                    staff: row.staff || '',
                    daysForecast: days,
                    ratePerDay: rate,
                    hrsForecast: hours,
                    hrsRemaining: 0, // Not applicable from allocation
                    hrsSpent: 0,     // Not applicable from allocation
                    ref: '',
                    costPerMonth: total
                });
            });

            if (forecastData.length === 0) {
                showToast(`No allocation data found for "${projectName}" in selected months`, 'warning');
                return;
            }

            // Sort by month then staff
            const monthOrder = {'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4, 'May': 5, 'Jun': 6, 'Jul': 7, 'Aug': 8, 'Sep': 9, 'Oct': 10, 'Nov': 11, 'Dec': 12};
            forecastData.sort((a, b) => {
                const monthDiff = (monthOrder[a.month] || 0) - (monthOrder[b.month] || 0);
                if (monthDiff !== 0) return monthDiff;
                return a.staff.localeCompare(b.staff);
            });

            displayForecastPreview();
            updateCostEstimate();
            showToast(`Loaded ${forecastData.length} allocation entries for "${projectName}"`, 'success');
        }

        // Legacy: Parse forecast data from textarea (kept for backwards compatibility)
        function parseForecastData() {
            const input = document.getElementById('forecastPasteArea')?.value?.trim();
            if (!input) {
                showToast('Please paste forecast data first', 'error');
                return;
            }

            const lines = input.split('\n').filter(line => line.trim() !== '');
            forecastData = [];

            lines.forEach(line => {
                const cols = line.split('\t');
                if (cols.length >= 5) {
                    forecastData.push({
                        month: cols[0].trim(),
                        staff: cols[1].trim(),
                        daysForecast: parseFloat(cols[2]) || 0,
                        ratePerDay: parseFloat(cols[3]) || 0,
                        hrsForecast: parseFloat(cols[4]) || 0,
                        hrsRemaining: parseFloat(cols[5]) || 0,
                        hrsSpent: parseFloat(cols[6]) || 0,
                        ref: cols[7] ? cols[7].trim() : '',
                        costPerMonth: parseFloat(cols[8]) || 0
                    });
                }
            });

            if (forecastData.length === 0) {
                showToast('No valid forecast data found. Check format.', 'error');
                return;
            }

            displayForecastPreview();
            updateCostEstimate();
            showToast(`Parsed ${forecastData.length} forecast entries`, 'success');
        }

        // Display forecast preview table
        function displayForecastPreview() {
            const preview = document.getElementById('forecastPreview');

            // Calculate totals
            let totalDays = 0;
            let totalHours = 0;
            let totalCost = 0;
            forecastData.forEach(item => {
                totalDays += item.daysForecast || 0;
                totalHours += item.hrsForecast || 0;
                totalCost += item.costPerMonth || 0;
            });

            let html = '<table class="preview-table" style="margin-top: 8px; font-size: 11px;">';
            html += '<thead><tr>';
            html += '<th style="padding: 6px;">Month</th>';
            html += '<th style="padding: 6px;">Staff</th>';
            html += '<th style="padding: 6px; text-align: right;">Days</th>';
            html += '<th style="padding: 6px; text-align: right;">Rate</th>';
            html += '<th style="padding: 6px; text-align: right; background: #e8f5e9;">Hrs</th>';
            html += '<th style="padding: 6px; text-align: right;">Cost</th>';
            html += '</tr></thead>';
            html += '<tbody>';

            forecastData.forEach(item => {
                html += `<tr>
                    <td style="padding: 4px 6px;">${item.month}</td>
                    <td style="padding: 4px 6px;">${item.staff}</td>
                    <td style="padding: 4px 6px; text-align: right;">${item.daysForecast.toFixed(2)}</td>
                    <td style="padding: 4px 6px; text-align: right;">¬£${item.ratePerDay.toFixed(2)}</td>
                    <td style="padding: 4px 6px; text-align: right; background-color: #c8e6c9; font-weight: bold;">${item.hrsForecast.toFixed(2)}</td>
                    <td style="padding: 4px 6px; text-align: right;">¬£${item.costPerMonth.toFixed(2)}</td>
                </tr>`;
            });

            // Add totals row
            html += `<tr style="font-weight: bold; background: #f5f5f5; border-top: 2px solid #333;">
                <td style="padding: 6px;" colspan="2">Total (${forecastData.length} entries)</td>
                <td style="padding: 6px; text-align: right;">${totalDays.toFixed(2)}</td>
                <td style="padding: 6px;"></td>
                <td style="padding: 6px; text-align: right; background-color: #a5d6a7;">${totalHours.toFixed(2)}</td>
                <td style="padding: 6px; text-align: right;">¬£${totalCost.toFixed(2)}</td>
            </tr>`;

            html += '</tbody></table>';
            preview.innerHTML = html;
        }

        // Load Gantt projects from localStorage
        function loadGanttProjects() {
            const dropdown = document.getElementById('ganttDropdown');
            dropdown.innerHTML = '<option value="">-- Select a Gantt project --</option>';

            // Try both possible localStorage keys
            const savedProjects = JSON.parse(localStorage.getItem('peblgen_gantt_projects') || localStorage.getItem('ganttProjects') || '{}');

            for (const [name, project] of Object.entries(savedProjects)) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                dropdown.appendChild(option);
            }
        }

        // Load selected Gantt project
        function loadGanttProject() {
            const dropdown = document.getElementById('ganttDropdown');
            const projectName = dropdown.value;

            if (!projectName) {
                showToast('Please select a Gantt project', 'error');
                return;
            }

            const savedProjects = JSON.parse(localStorage.getItem('peblgen_gantt_projects') || localStorage.getItem('ganttProjects') || '{}');
            ganttData = savedProjects[projectName];

            if (!ganttData) {
                showToast('Project not found', 'error');
                return;
            }

            displayGanttSummary();
            updateCostEstimate();
            showToast(`Loaded Gantt project: ${projectName}`, 'success');
        }


        // Load Gantt from file
        function loadGanttFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    ganttData = JSON.parse(e.target.result);
                    
                    // Display the file name
                    document.getElementById('selectedFileName').textContent = `Loaded: ${file.name}`;
                    
                    displayGanttSummary();
                    updateCostEstimate();
                    showToast(`Loaded Gantt from file: ${file.name}`, 'success');
                    log(`Gantt loaded from file: ${file.name}`, 'success');
                } catch (error) {
                    showToast('Error loading JSON file: ' + error.message, 'error');
                    log('Error loading JSON file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);

            // Reset input so same file can be loaded again
            event.target.value = '';
        }

                // Display Gantt summary
        function displayGanttSummary() {
            const summary = document.getElementById('ganttSummary');

            if (!ganttData) {
                summary.innerHTML = '';
                return;
            }

            const activeTasks = ganttData.tasks.filter(task => {
                // Check if task has any active weeks
                for (const key in ganttData.ganttData) {
                    if (ganttData.ganttData[key] && key.startsWith(ganttData.tasks.indexOf(task) + '-')) {
                        return true;
                    }
                }
                return false;
            });

            let html = '<div class="gantt-summary">';
            html += `<h3>Project: ${ganttData.name}</h3>`;
            html += `<p><strong>Date Range:</strong> ${ganttData.startDate} to ${ganttData.endDate}</p>`;
            html += `<p><strong>Total Tasks:</strong> ${ganttData.tasks.length}</p>`;
            html += `<p><strong>Active Tasks:</strong> ${activeTasks.length}</p>`;

            if (activeTasks.length > 0) {
                html += '<p><strong>Active Task List:</strong></p><ul style="margin-left: 20px; font-size: 13px;">';
                activeTasks.forEach(task => {
                    html += `<li>${task.number} ${task.name}</li>`;
                });
                html += '</ul>';
            }

            html += '</div>';
            summary.innerHTML = html;
        }

        // Update cost estimate
        function updateCostEstimate() {
            const costElement = document.getElementById('estimatedCost');

            if (forecastData.length === 0) {
                costElement.textContent = '0.00';
                return;
            }

            // Estimate: ~$0.002 per timesheet entry (conservative estimate for Gemini 2.5 Flash)
            const estimatedCost = forecastData.length * 0.002;
            costElement.textContent = estimatedCost.toFixed(2);
        }

        // Generate timesheet descriptions using Gemini API
        async function generateTimesheets() {
            if (forecastData.length === 0) {
                showToast('Please parse forecast data first', 'error');
                return;
            }

            if (!ganttData) {
                showToast('Please load a Gantt project first', 'error');
                return;
            }

            // Store the project name
            const projectSelect = document.getElementById('forecastProjectSelect');
            currentTimesheetProject = projectSelect.options[projectSelect.selectedIndex]?.text || 'Unknown Project';

            saveSystemPrompt();
            clearLog();
            log('=== Starting Timesheet Generation ===', 'info');
            log('Using Gemini API for intelligent description generation', 'info');

            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = 'Generating... <span class="spinner"></span>';

            timesheetData = [];
            let totalCost = 0;

            try {
                // STEP 1: Analyze entire project to understand context
                log('Step 1: Analyzing project structure...', 'info');
                const projectAnalysis = await analyzeProject();
                if (projectAnalysis.success) {
                    log(`‚úì Project analyzed: ${ganttData.tasks.length} tasks identified`, 'success');
                    log(`‚úì Project theme: ${projectAnalysis.theme}`, 'info');
                } else {
                    log('‚ö† Project analysis failed, continuing with basic generation', 'warning');
                }

                // STEP 2: Process forecast entries in PARALLEL batches for speed
                log('Step 2: Generating descriptions for each month/staff combination...', 'info');
                log(`Total entries to process: ${forecastData.length}`, 'info');

                // Process in batches of 3 for optimal speed vs rate limiting
                const BATCH_SIZE = 3;
                let processedCount = 0;
                let successCount = 0;
                let failureCount = 0;
                const costBreakdown = [];

                for (let i = 0; i < forecastData.length; i += BATCH_SIZE) {
                    const batch = forecastData.slice(i, i + BATCH_SIZE);
                    log(`Processing batch ${Math.floor(i / BATCH_SIZE) + 1} of ${Math.ceil(forecastData.length / BATCH_SIZE)} (${batch.length} entries in parallel)...`, 'info');

                    // Process batch in parallel
                    const batchPromises = batch.map(async (forecast) => {
                        const startTime = Date.now();

                        // Parse month to index
                        const monthIndex = parseMonthToIndex(forecast.month);
                        if (monthIndex === -1) {
                            log(`‚ö† Warning: Could not parse month "${forecast.month}"`, 'warning');
                            return { success: false, forecast };
                        }

                        // Get active tasks for this month
                        const activeTasks = getActiveTasksForMonth(monthIndex);

                        // Calculate weekly breakdown
                        const weeksInMonth = 4;
                        const hoursPerWeek = forecast.hrsForecast / weeksInMonth;

                        // Generate descriptions using Gemini API
                        const result = await generateWeekDescriptions(forecast, activeTasks, monthIndex, hoursPerWeek, projectAnalysis);

                        const duration = ((Date.now() - startTime) / 1000).toFixed(1);

                        if (result.success) {
                            const hourlyRate = forecast.ratePerDay ? forecast.ratePerDay / 8 : 0;

                            return {
                                success: true,
                                forecast,
                                timesheetEntry: {
                                    month: forecast.month,
                                    staff: forecast.staff,
                                    forecastHours: forecast.hrsForecast,
                                    dayRate: forecast.ratePerDay || 0,
                                    hourlyRate: hourlyRate,
                                    days: forecast.daysForecast || 0,
                                    hours: forecast.hrsForecast || 0,
                                    weeks: result.weeks
                                },
                                cost: result.cost,
                                duration: duration
                            };
                        } else {
                            return { success: false, forecast, error: result.error, duration: duration };
                        }
                    });

                    // Wait for batch to complete
                    const batchResults = await Promise.all(batchPromises);

                    // Process results
                    batchResults.forEach(result => {
                        processedCount++;
                        if (result.success) {
                            successCount++;
                            timesheetData.push(result.timesheetEntry);
                            totalCost += result.cost;
                            costBreakdown.push({
                                entry: `${result.forecast.month} - ${result.forecast.staff}`,
                                cost: result.cost,
                                duration: result.duration
                            });
                            log(`‚úì ${result.forecast.month} - ${result.forecast.staff} | $${result.cost.toFixed(4)} | ${result.duration}s`, 'success');
                        } else {
                            failureCount++;
                            log(`‚úó ${result.forecast.month} - ${result.forecast.staff} | ${result.error || 'Unknown error'}`, 'error');
                        }
                    });

                    log(`Progress: ${processedCount}/${forecastData.length} | Success: ${successCount} | Failed: ${failureCount} | Cost so far: $${totalCost.toFixed(4)}`, 'info');
                }

                // Final detailed cost breakdown
                log('', 'info');
                log('=== GENERATION COMPLETE ===', 'success');
                log('', 'info');
                log('üìä SUMMARY:', 'info');
                log(`  ‚Ä¢ Total entries processed: ${processedCount}`, 'info');
                log(`  ‚Ä¢ Successful: ${successCount}`, 'success');
                log(`  ‚Ä¢ Failed: ${failureCount}`, failureCount > 0 ? 'warning' : 'info');
                log('', 'info');

                if (costBreakdown.length > 0) {
                    log('üí∞ COST BREAKDOWN:', 'info');
                    costBreakdown.forEach(item => {
                        log(`  ‚Ä¢ ${item.entry}: $${item.cost.toFixed(4)} (${item.duration}s)`, 'info');
                    });
                    log('', 'info');

                    const avgDuration = costBreakdown.reduce((sum, item) => sum + parseFloat(item.duration), 0) / costBreakdown.length;
                    const avgCost = totalCost / costBreakdown.length;

                    log(`‚ö° Average time per entry: ${avgDuration.toFixed(1)}s`, 'info');
                    log(`üíµ Average cost per entry: $${avgCost.toFixed(4)}`, 'info');
                    log(`üí∞ TOTAL COST: $${totalCost.toFixed(4)}`, 'success');
                } else {
                    log(`üí∞ TOTAL COST: $${totalCost.toFixed(4)}`, 'success');
                }
                
                displayTimesheetOutput();
                saveToHistory();
                showToast(`Generated ${timesheetData.length} timesheets. Total cost: $${totalCost.toFixed(4)}`, 'success');

            } catch (error) {
                log(`Fatal error: ${error.message}`, 'error');
                showToast('Error generating timesheets: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Generate Timesheet Descriptions';
            }
        }

        // GEMINI 2.5 FLASH: Using latest stable Gemini 2.5 Flash for all generation tasks

        // Function 0: Analyze entire project to understand context (called once at start)
        async function analyzeProject() {
            try {
                const allTasks = ganttData.tasks.map(task =>
                    `${task.number}: ${task.name}${task.deliverableCode ? ' [DELIVERABLE]' : ''}`
                ).join('\n');

                const prompt = `Analyze this project based on its tasks and provide a brief summary.

PROJECT: ${currentTimesheetProject || ganttData.name}

ALL TASKS:
${allTasks}

Provide a 1-2 sentence summary of what this project is about and its main objectives. This will help generate accurate timesheet descriptions.`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API Error:', errorData);
                    throw new Error(`Project analysis failed: ${JSON.stringify(errorData)}`);
                }

                const data = await response.json();
                console.log('Project Analysis Response:', data);
                const theme = data.candidates[0].content.parts[0].text.trim();

                return {
                    success: true,
                    theme: theme,
                    allTasks: ganttData.tasks
                };
            } catch (error) {
                console.error('Project Analysis Error:', error);
                log(`Project analysis error: ${error.message}`, 'warning');
                return {
                    success: false,
                    theme: 'Project analysis unavailable',
                    allTasks: ganttData.tasks
                };
            }
        }

        // Function 1: Calculate In/Out times (local calculation - no API needed for simple math)
        function calculateInOutTimes(hoursPerWeek, weekNum) {
            // Simple calculation based on hours per week
            const days = Math.ceil(hoursPerWeek / 8);
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];

            let inOut;
            if (days >= 5 || hoursPerWeek >= 40) {
                inOut = 'Mon-Fri 9:00-17:00';
            } else if (days === 1) {
                inOut = `${dayNames[0]} 9:00-17:00`;
            } else if (days > 0) {
                inOut = `${dayNames[0]}-${dayNames[days-1]} 9:00-17:00`;
            } else {
                inOut = '';
            }

            return {
                success: true,
                inOut: inOut,
                cost: 0
            };
        }

        // Function 2: Generate descriptions using Gemini 2.5 Flash (intelligent, context-aware)
        async function generateDescriptions(forecast, activeTasks, monthIndex, projectAnalysis) {
            const systemPrompt = document.getElementById('systemPrompt').value;

            // Build task list with deliverables highlighted
            const taskDescriptions = activeTasks.map(task => {
                if (task.deliverableCode) {
                    return `${task.number}: ${task.name} **(DELIVERABLE DUE!)**`;
                }
                return `${task.number}: ${task.name}`;
            }).join('\n');

            // Streamlined prompt for faster, more reliable generation
            const userMessage = `Generate 4 weekly timesheet descriptions for a real project.

PROJECT CONTEXT: ${projectAnalysis.theme}

THIS MONTH:
Staff: ${forecast.staff} (${forecast.staff.split('/').pop().trim()})
Month: ${forecast.month}

TASKS:
${taskDescriptions || 'General project work'}

REQUIREMENTS:
- Be specific to these actual tasks
- Use technical terminology for the role
- Show realistic week-to-week progression
- Mention deliverables if applicable
- No generic phrases or corporate jargon
- CRITICAL: Do NOT use double quotes (") or apostrophes (') in descriptions. Use simple language without quoted terms.

OUTPUT FORMAT: Return ONLY valid JSON with no markdown blocks, no explanations:
{
  "weeks": [
    {"weekNum": 1, "description": "Short specific description without any quotes"},
    {"weekNum": 2, "description": "Short specific description without any quotes"},
    {"weekNum": 3, "description": "Short specific description without any quotes"},
    {"weekNum": 4, "description": "Short specific description without any quotes"}
  ]
}`;

            try {
                const fullPrompt = `${systemPrompt}\n\n${userMessage}`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: fullPrompt }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 4000  // Increased to 4000 to prevent truncation
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API Error (Descriptions):', errorData);
                    log(`Gemini API error: ${JSON.stringify(errorData)}`, 'error');
                    throw new Error(`Failed to generate descriptions: ${errorData.error?.message || JSON.stringify(errorData)}`);
                }

                const data = await response.json();

                // Check finish reason
                const finishReason = data.candidates[0].finishReason;

                const content = data.candidates[0].content.parts[0].text.trim();

                // Check if response was cut off
                if (finishReason === 'MAX_TOKENS') {
                    throw new Error('Response truncated (MAX_TOKENS) - increase maxOutputTokens');
                }

                if (!content || content.length < 20) {
                    throw new Error('Empty or very short response from API');
                }

                // Remove markdown code blocks and extra whitespace
                let jsonContent = content.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();

                // Try to extract JSON object from the response
                const jsonMatch = jsonContent.match(/\{[\s\S]*?\}\s*\]/);
                if (jsonMatch) {
                    jsonContent = jsonMatch[0];
                } else {
                    // Try simpler match
                    const simpleMatch = jsonContent.match(/\{[\s\S]+\}/);
                    if (simpleMatch) {
                        jsonContent = simpleMatch[0];
                    } else {
                        throw new Error('No valid JSON found in response');
                    }
                }

                let parsed;
                try {
                    parsed = JSON.parse(jsonContent);
                } catch (parseError) {
                    // JSON parsing failed - try manual extraction
                    console.log('JSON parse failed, attempting manual extraction...');

                    try {
                        // Manual extraction: Find all weekNum and description pairs
                        const weeks = [];
                        const weekMatches = jsonContent.matchAll(/"weekNum":\s*(\d+)[\s,]*"description":\s*"([^"]*(?:"[^"]*)*?)"\s*[,}]/g);

                        for (const match of weekMatches) {
                            weeks.push({
                                weekNum: parseInt(match[1]),
                                description: match[2].replace(/\\"/g, '"') // Unescape any escaped quotes
                            });
                        }

                        if (weeks.length === 4) {
                            parsed = { weeks };
                            console.log('Successfully extracted weeks manually');
                        } else {
                            // Try even more lenient extraction - just grab text between description quotes
                            const descriptions = [];
                            const descMatches = [...jsonContent.matchAll(/"description":\s*"([^"]+)"/g)];

                            if (descMatches.length >= 4) {
                                for (let i = 0; i < 4; i++) {
                                    weeks.push({
                                        weekNum: i + 1,
                                        description: descMatches[i][1]
                                    });
                                }
                                parsed = { weeks };
                                console.log('Successfully extracted descriptions with lenient match');
                            } else {
                                throw parseError;
                            }
                        }
                    } catch (extractError) {
                        console.error('Manual extraction also failed:', extractError);
                        throw parseError;
                    }
                }

                // Calculate cost (Gemini 2.5 Flash pricing - very cheap, approximate)
                const cost = 0.001;

                return {
                    success: true,
                    weeks: parsed.weeks || [],
                    cost: cost
                };

            } catch (error) {
                console.error('Description Generation Error:', error);
                // Only log error once, not in console
                return {
                    success: false,
                    error: error.message,
                    cost: 0
                };
            }
        }

        // Combined function: Generate descriptions with retry logic
        async function generateWeekDescriptions(forecast, activeTasks, monthIndex, hoursPerWeek, projectAnalysis) {
            try {
                // Generate descriptions (with retry on failure)
                let descriptionsResult = await generateDescriptions(forecast, activeTasks, monthIndex, projectAnalysis);

                // Retry up to 2 times if failed
                let retryCount = 0;
                while (!descriptionsResult.success && retryCount < 2) {
                    retryCount++;
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second between retries
                    descriptionsResult = await generateDescriptions(forecast, activeTasks, monthIndex, projectAnalysis);
                }

                if (!descriptionsResult.success) {
                    throw new Error(descriptionsResult.error);
                }

                // Calculate In/Out times locally (no API needed)
                const inOutResult = calculateInOutTimes(hoursPerWeek, 1);

                // Combine results
                const weeks = descriptionsResult.weeks.map((week) => {
                    return {
                        weekNum: week.weekNum,
                        inOut: inOutResult.inOut,
                        hours: hoursPerWeek,
                        description: week.description
                    };
                });

                return {
                    success: true,
                    weeks: weeks,
                    cost: descriptionsResult.cost
                };

            } catch (error) {
                console.error('Generation Error:', error);
                return {
                    success: false,
                    error: error.message,
                    cost: 0
                };
            }
        }

        // Display timesheet output table
        function displayTimesheetOutput() {
            const output = document.getElementById('timesheetOutput');

            if (timesheetData.length === 0) {
                output.innerHTML = '<p class="empty-state">No timesheet data to display.</p>';
                return;
            }

            let html = '<table class="timesheet-table">';
            html += '<thead><tr>';
            html += '<th>Day Rate</th><th>Hr Rate</th><th>Days</th><th>Hours</th>'; // Rate and time columns
            html += '<th>Month</th><th>Staff</th>';
            html += '<th>Week 1 In/Out</th><th>Week 1 Hrs</th><th>Week 1 Description</th>';
            html += '<th>Week 2 In/Out</th><th>Week 2 Hrs</th><th>Week 2 Description</th>';
            html += '<th>Week 3 In/Out</th><th>Week 3 Hrs</th><th>Week 3 Description</th>';
            html += '<th>Week 4 In/Out</th><th>Week 4 Hrs</th><th>Week 4 Description</th>';
            html += '<th>Week 5 In/Out</th><th>Week 5 Hrs</th><th>Week 5 Description</th>';
            html += '</tr></thead><tbody>';

            timesheetData.forEach((entry, entryIndex) => {
                html += '<tr>';

                // Rate and time columns
                const dayRate = entry.dayRate || 0;
                const hourlyRate = entry.hourlyRate || 0;
                const days = entry.days || 0;
                const hours = entry.hours || 0;

                html += `<td class="editable">¬£${dayRate.toFixed(2)}</td>`;
                html += `<td class="editable">¬£${hourlyRate.toFixed(2)}</td>`;
                html += `<td class="editable">${days.toFixed(2)}</td>`;
                html += `<td class="editable">${hours.toFixed(2)}</td>`;

                html += `<td class="editable">${entry.month}</td>`;
                html += `<td class="editable">${entry.staff}</td>`;

                // Create array of 5 weeks
                const weeks = Array(5).fill(null).map((_, i) => {
                    return entry.weeks.find(w => w.weekNum === i + 1) || { inOut: '', hours: '', description: '' };
                });

                weeks.forEach((week, weekIndex) => {
                    html += `<td class="editable week-group">${week.inOut || ''}</td>`;
                    // Format hours to 2 decimal places
                    const hoursDisplay = week.hours ? parseFloat(week.hours).toFixed(2) : '';
                    html += `<td class="editable week-group">${hoursDisplay}</td>`;
                    html += `<td class="editable week-group">${week.description || ''}</td>`;
                });

                html += '</tr>';
            });

            html += '</tbody></table>';
            output.innerHTML = html;
            
            // Add double-click event listeners to editable cells
            setTimeout(() => {
                const editableCells = document.querySelectorAll('.timesheet-table td.editable');
                editableCells.forEach(cell => {
                    cell.addEventListener('dblclick', function() {
                        this.contentEditable = true;
                        this.classList.add('editing');
                        this.focus();
                        
                        // Select all text
                        const range = document.createRange();
                        range.selectNodeContents(this);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    });
                    
                    cell.addEventListener('blur', function() {
                        this.contentEditable = false;
                        this.classList.remove('editing');
                    });
                    
                    cell.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.blur();
                        } else if (e.key === 'Escape') {
                            this.blur();
                        }
                    });
                });
            }, 0);

            // Update signature buttons after displaying output
            updateSignatureButtons();
        }

        // Validate timesheet hours against forecast
        function validateTimesheet() {
            const warnings = document.getElementById('validationWarnings');
            const warningList = [];

            timesheetData.forEach(entry => {
                const forecast = forecastData.find(f => f.month === entry.month && f.staff === entry.staff);
                if (!forecast) return;

                const totalHours = entry.weeks.reduce((sum, week) => sum + (parseFloat(week.hours) || 0), 0);
                const difference = Math.abs(totalHours - forecast.hrsForecast);
                const percentDiff = (difference / forecast.hrsForecast) * 100;

                if (percentDiff > 10) {
                    warningList.push({
                        staff: entry.staff,
                        month: entry.month,
                        forecast: forecast.hrsForecast,
                        actual: totalHours,
                        diff: percentDiff.toFixed(1)
                    });
                }
            });

            if (warningList.length > 0) {
                let html = '<div class="validation-warning">';
                html += '<strong>Warning: Hour Mismatch Detected</strong>';
                warningList.forEach(w => {
                    html += `<div>${w.staff} (${w.month}): Forecast ${w.forecast}hrs, Generated ${w.actual}hrs (${w.diff}% difference)</div>`;
                });
                html += '</div>';
                warnings.innerHTML = html;
            } else {
                warnings.innerHTML = '';
            }
        }

        // Copy to clipboard (tab-separated for Excel)
        function copyToClipboard() {
            if (timesheetData.length === 0) {
                showToast('No timesheet data to copy', 'error');
                return;
            }

            const table = document.querySelector('.timesheet-table');
            if (!table) return;

            let text = '';

            // Get headers
            const headers = table.querySelectorAll('thead th');
            headers.forEach((header, index) => {
                text += header.textContent;
                if (index < headers.length - 1) text += '\t';
            });
            text += '\n';

            // Get data rows
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                cells.forEach((cell, index) => {
                    text += cell.textContent;
                    if (index < cells.length - 1) text += '\t';
                });
                text += '\n';
            });

            navigator.clipboard.writeText(text).then(() => {
                showToast('Timesheet copied to clipboard (ready for Excel paste)', 'success');
            }).catch(err => {
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        // Download as CSV
        function downloadCSV() {
            if (timesheetData.length === 0) {
                showToast('No timesheet data to download', 'error');
                return;
            }

            const table = document.querySelector('.timesheet-table');
            if (!table) return;

            let csv = '';

            // Get headers
            const headers = table.querySelectorAll('thead th');
            headers.forEach((header, index) => {
                csv += '"' + header.textContent.replace(/"/g, '""') + '"';
                if (index < headers.length - 1) csv += ',';
            });
            csv += '\n';

            // Get data rows
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                cells.forEach((cell, index) => {
                    csv += '"' + cell.textContent.replace(/"/g, '""') + '"';
                    if (index < cells.length - 1) csv += ',';
                });
                csv += '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `timesheet_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);

            showToast('CSV downloaded successfully', 'success');
        }

        // Clear timesheet
        function clearTimesheet() {
            if (!confirm('Are you sure you want to clear all timesheet data?')) {
                return;
            }

            timesheetData = [];
            timesheetApproved = false;
            document.getElementById('timesheetOutput').innerHTML = '<p class="empty-state">Generate timesheet data to see output here.</p>';
            document.getElementById('validationWarnings').innerHTML = '';
            updateSignatureButtons();
            showToast('Timesheet cleared', 'success');
        }

        // ============================================
        // SIGNATURE & APPROVAL SYSTEM
        // ============================================

        // Store signatures in localStorage (keyed by staff name)
        let staffSignatures = JSON.parse(localStorage.getItem('timesheet_staff_signatures') || '{}');
        let timesheetApproved = false;

        // Save signatures to localStorage
        function saveSignatures() {
            localStorage.setItem('timesheet_staff_signatures', JSON.stringify(staffSignatures));
        }

        // Update signature button states
        function updateSignatureButtons() {
            const addSignaturesBtn = document.getElementById('addSignaturesBtn');
            const approveAllBtn = document.getElementById('approveAllBtn');
            const statusEl = document.getElementById('signatureStatus');

            if (timesheetData.length === 0) {
                addSignaturesBtn.disabled = true;
                approveAllBtn.disabled = true;
                statusEl.textContent = '';
                return;
            }

            addSignaturesBtn.disabled = false;

            // Get unique staff from timesheet
            const staffList = [...new Set(timesheetData.map(entry => entry.staff))];
            const missingSignatures = staffList.filter(staff => !staffSignatures[staff]);

            if (missingSignatures.length === 0) {
                approveAllBtn.disabled = false;
                statusEl.innerHTML = `<span style="color: #00c853;">‚úì All ${staffList.length} staff have signatures</span>`;
            } else {
                approveAllBtn.disabled = true;
                statusEl.innerHTML = `<span style="color: #ff9800;">‚ö† ${missingSignatures.length} of ${staffList.length} staff missing signatures</span>`;
            }
        }

        // Show signature management modal
        function showSignatureModal() {
            if (timesheetData.length === 0) {
                showToast('Generate timesheet first', 'error');
                return;
            }

            const staffList = [...new Set(timesheetData.map(entry => entry.staff))];
            const listEl = document.getElementById('signatureList');

            let html = '';
            staffList.forEach(staff => {
                const hasSignature = staffSignatures[staff];
                html += `
                <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 10px; background: ${hasSignature ? '#e8f5e9' : '#fff3e0'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="font-size: 13px;">${staff}</strong>
                        ${hasSignature ? '<span style="color: #00c853; font-size: 11px;">‚úì Signature saved</span>' : '<span style="color: #ff9800; font-size: 11px;">‚ö† No signature</span>'}
                    </div>

                    ${hasSignature ? `
                        <div style="background: white; border: 1px solid #ddd; border-radius: 4px; padding: 8px; margin-bottom: 8px; text-align: center;">
                            <img src="${staffSignatures[staff]}" style="max-height: 60px; max-width: 200px;" alt="Signature">
                        </div>
                        <button class="btn btn-danger" onclick="removeSignature('${staff}')" style="font-size: 11px; padding: 4px 10px;">Remove</button>
                    ` : `
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                            <input type="file" id="sigFile_${staff.replace(/[^a-zA-Z0-9]/g, '_')}" accept="image/png,image/jpeg" onchange="handleSignatureUpload('${staff}', this)" style="display: none;">
                            <button class="btn" onclick="document.getElementById('sigFile_${staff.replace(/[^a-zA-Z0-9]/g, '_')}').click()" style="background: #2196f3; color: white; font-size: 11px; padding: 4px 10px;">üìÅ Upload PNG</button>
                            <span style="color: #999; font-size: 11px;">or</span>
                            <button class="btn" onclick="showPasteArea('${staff}')" style="background: #9c27b0; color: white; font-size: 11px; padding: 4px 10px;">üìã Paste</button>
                        </div>
                        <div id="pasteArea_${staff.replace(/[^a-zA-Z0-9]/g, '_')}" style="display: none; margin-top: 8px;">
                            <div contenteditable="true" id="pasteBox_${staff.replace(/[^a-zA-Z0-9]/g, '_')}"
                                style="border: 2px dashed #9c27b0; border-radius: 4px; padding: 15px; min-height: 60px; background: #f3e5f5; text-align: center; font-size: 11px; color: #666;"
                                onpaste="handleSignaturePaste('${staff}', event)">
                                Click here and press Ctrl+V to paste signature image
                            </div>
                        </div>
                    `}
                </div>
                `;
            });

            listEl.innerHTML = html;
            document.getElementById('signatureModal').style.display = 'block';
        }

        // Close signature modal
        function closeSignatureModal() {
            document.getElementById('signatureModal').style.display = 'none';
            updateSignatureButtons();
        }

        // Show paste area for a staff member
        function showPasteArea(staff) {
            const safeId = staff.replace(/[^a-zA-Z0-9]/g, '_');
            const pasteArea = document.getElementById(`pasteArea_${safeId}`);
            pasteArea.style.display = 'block';
            document.getElementById(`pasteBox_${safeId}`).focus();
        }

        // Handle signature file upload
        function handleSignatureUpload(staff, input) {
            const file = input.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showToast('Please upload an image file', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                staffSignatures[staff] = e.target.result;
                saveSignatures();
                showToast(`Signature saved for ${staff}`, 'success');
                showSignatureModal(); // Refresh modal
            };
            reader.readAsDataURL(file);
        }

        // Handle signature paste
        function handleSignaturePaste(staff, event) {
            event.preventDefault();
            const items = event.clipboardData.items;

            for (let item of items) {
                if (item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        staffSignatures[staff] = e.target.result;
                        saveSignatures();
                        showToast(`Signature pasted for ${staff}`, 'success');
                        showSignatureModal(); // Refresh modal
                    };
                    reader.readAsDataURL(file);
                    return;
                }
            }

            showToast('No image found in clipboard. Try copying an image first.', 'error');
        }

        // Remove signature for a staff member
        function removeSignature(staff) {
            if (confirm(`Remove signature for ${staff}?`)) {
                delete staffSignatures[staff];
                saveSignatures();
                showToast(`Signature removed for ${staff}`, 'success');
                showSignatureModal(); // Refresh modal
            }
        }

        // Approve all timesheets (add signature columns)
        function approveAllTimesheets() {
            if (timesheetData.length === 0) {
                showToast('No timesheet data to approve', 'error');
                return;
            }

            const staffList = [...new Set(timesheetData.map(entry => entry.staff))];
            const missingSignatures = staffList.filter(staff => !staffSignatures[staff]);

            if (missingSignatures.length > 0) {
                showToast(`Missing signatures for: ${missingSignatures.join(', ')}`, 'error');
                return;
            }

            // Mark as approved with today's date
            const approvalDate = new Date().toLocaleDateString('en-GB');
            timesheetData.forEach(entry => {
                entry.signatureImage = staffSignatures[entry.staff];
                entry.signedOn = approvalDate;
            });

            timesheetApproved = true;
            displayTimesheetOutputWithSignatures();
            showToast('All timesheets approved with signatures!', 'success');
        }

        // Display timesheet with signature columns
        function displayTimesheetOutputWithSignatures() {
            const output = document.getElementById('timesheetOutput');

            if (timesheetData.length === 0) {
                output.innerHTML = '<p class="empty-state">No timesheet data to display.</p>';
                return;
            }

            // Check if any entry has Week 5 data
            const hasWeek5Data = timesheetData.some(entry => {
                const week5 = entry.weeks.find(w => w.weekNum === 5);
                return week5 && (week5.hours || week5.inOut || week5.description);
            });

            let html = '<table class="timesheet-table">';
            html += '<thead><tr>';
            html += '<th>Day Rate</th><th>Hr Rate</th><th>Days</th><th>Hours</th>'; // Rate and time columns
            html += '<th>Month</th><th>Staff</th>';
            html += '<th>Week 1 In/Out</th><th>Week 1 Hrs</th><th>Week 1 Description</th>';
            html += '<th>Week 2 In/Out</th><th>Week 2 Hrs</th><th>Week 2 Description</th>';
            html += '<th>Week 3 In/Out</th><th>Week 3 Hrs</th><th>Week 3 Description</th>';
            html += '<th>Week 4 In/Out</th><th>Week 4 Hrs</th><th>Week 4 Description</th>';
            if (hasWeek5Data) {
                html += '<th>Week 5 In/Out</th><th>Week 5 Hrs</th><th>Week 5 Description</th>';
            }
            html += '<th>Signature</th><th>Signed On</th>';
            html += '</tr></thead><tbody>';

            timesheetData.forEach((entry, entryIndex) => {
                html += '<tr>';

                // Rate and time columns
                const dayRate = entry.dayRate || 0;
                const hourlyRate = entry.hourlyRate || 0;
                const days = entry.days || 0;
                const hours = entry.hours || 0;

                html += `<td>¬£${dayRate.toFixed(2)}</td>`;
                html += `<td>¬£${hourlyRate.toFixed(2)}</td>`;
                html += `<td>${days.toFixed(2)}</td>`;
                html += `<td>${hours.toFixed(2)}</td>`;

                html += `<td>${entry.month}</td>`;
                html += `<td>${entry.staff}</td>`;

                // Determine how many weeks to show (4 or 5)
                const weeksToShow = hasWeek5Data ? 5 : 4;
                const weeks = Array(weeksToShow).fill(null).map((_, i) => {
                    return entry.weeks.find(w => w.weekNum === i + 1) || { inOut: '', hours: '', description: '' };
                });

                weeks.forEach((week) => {
                    html += `<td>${week.inOut || ''}</td>`;
                    const hoursDisplay = week.hours ? parseFloat(week.hours).toFixed(2) : '';
                    html += `<td>${hoursDisplay}</td>`;
                    html += `<td>${week.description || ''}</td>`;
                });

                // Signature columns - white background for clean signature display
                if (entry.signatureImage) {
                    html += `<td style="background: white; text-align: center;"><img src="${entry.signatureImage}" style="max-height: 40px; max-width: 100px;" alt="Signature"></td>`;
                } else {
                    html += '<td style="background: white;">-</td>';
                }
                html += `<td style="background: white;">${entry.signedOn || '-'}</td>`;

                html += '</tr>';
            });

            html += '</tbody></table>';
            output.innerHTML = html;

            // Update the approve section to show PDF download button
            updateApproveSection();
        }

        // Update approve section after approval
        function updateApproveSection() {
            const statusEl = document.getElementById('signatureStatus');
            if (timesheetApproved && timesheetData.length > 0) {
                statusEl.innerHTML = `
                    <span style="color: #00c853;">‚úì Timesheet approved</span>
                    <button class="btn" onclick="downloadTimesheetPDF()" style="background: #e91e63; color: white; margin-left: 10px; font-size: 11px; padding: 4px 12px;">üìÑ Download PDF</button>
                `;
            }
        }

        // Download timesheet as PDF
        async function downloadTimesheetPDF() {
            if (timesheetData.length === 0) {
                showToast('No timesheet data to download', 'error');
                return;
            }

            showToast('Generating PDF...', 'info');

            // Use stored project name, or fall back to dropdown
            const projectName = currentTimesheetProject ||
                (document.getElementById('forecastProjectSelect').options[document.getElementById('forecastProjectSelect').selectedIndex]?.text) ||
                'Unknown Project';

            // Get unique months from timesheet data
            const months = [...new Set(timesheetData.map(e => e.month))].sort();
            const monthsText = months.join(', ');

            // Check if any entry has Week 5 data
            const hasWeek5Data = timesheetData.some(entry => {
                const week5 = entry.weeks.find(w => w.weekNum === 5);
                return week5 && (week5.hours || week5.inOut || week5.description);
            });

            // Build HTML for PDF
            let pdfHtml = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Timesheet - ${projectName}</title>
                <style>
                    body { font-family: Arial, sans-serif; font-size: 9px; margin: 15px; }
                    h1 { font-size: 16px; margin-bottom: 5px; }
                    .subtitle { font-size: 11px; color: #666; margin-bottom: 15px; }
                    table { border-collapse: collapse; width: 100%; table-layout: fixed; }
                    th, td { border: 1px solid #ccc; padding: 3px 4px; text-align: left; white-space: normal; word-wrap: break-word; }
                    th { background: #c62828; color: white; font-weight: bold; font-size: 8px; }
                    .rate-col { width: 25px; text-align: right; font-size: 8px; }
                    .days-col { width: 20px; text-align: right; }
                    .hours-col { width: 23px; text-align: right; }
                    .month-col { width: 20px; }
                    .staff-col { width: 35px; }
                    .inout-col { width: 33px; font-size: 8px; }
                    .hrs-col { width: 20px; text-align: right; }
                    .desc-col { width: 59px; font-size: 8px; }
                    .sig-col { width: 35px; text-align: center; background: white; }
                    .date-col { width: 42px; background: white; }
                    .signature-img { max-height: 30px; max-width: 65px; }
                    .footer { margin-top: 15px; font-size: 8px; color: #666; }
                    @media print { body { margin: 10px; } }
                </style>
            </head>
            <body>
                <h1>Timesheet: ${projectName}</h1>
                <p class="subtitle">Months: ${monthsText}</p>
                <table>
                    <thead>
                        <tr>
                            <th class="rate-col">Day Rate</th><th class="rate-col">Hr Rate</th><th class="days-col">Days</th><th class="hours-col">Hours</th>
                            <th class="month-col">Mth</th><th class="staff-col">Staff</th>
                            <th class="inout-col">W1 In/Out</th><th class="hrs-col">W1</th><th class="desc-col">W1 Desc</th>
                            <th class="inout-col">W2 In/Out</th><th class="hrs-col">W2</th><th class="desc-col">W2 Desc</th>
                            <th class="inout-col">W3 In/Out</th><th class="hrs-col">W3</th><th class="desc-col">W3 Desc</th>
                            <th class="inout-col">W4 In/Out</th><th class="hrs-col">W4</th><th class="desc-col">W4 Desc</th>
                            ${hasWeek5Data ? '<th class="inout-col">W5 In/Out</th><th class="hrs-col">W5</th><th class="desc-col">W5 Desc</th>' : ''}
                            <th class="sig-col">Signature</th><th class="date-col">Signed On</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            timesheetData.forEach(entry => {
                const weeksToShow = hasWeek5Data ? 5 : 4;
                const weeks = Array(weeksToShow).fill(null).map((_, i) => {
                    return entry.weeks.find(w => w.weekNum === i + 1) || { inOut: '', hours: '', description: '' };
                });

                const dayRate = entry.dayRate || 0;
                const hourlyRate = entry.hourlyRate || 0;
                const days = entry.days || 0;
                const hours = entry.hours || 0;

                pdfHtml += `<tr>`;
                pdfHtml += `<td class="rate-col">¬£${dayRate.toFixed(2)}</td>`;
                pdfHtml += `<td class="rate-col">¬£${hourlyRate.toFixed(2)}</td>`;
                pdfHtml += `<td class="days-col">${days.toFixed(2)}</td>`;
                pdfHtml += `<td class="hours-col">${hours.toFixed(2)}</td>`;
                pdfHtml += `<td class="month-col">${entry.month}</td>`;
                pdfHtml += `<td class="staff-col">${entry.staff}</td>`;

                weeks.forEach(week => {
                    pdfHtml += `<td class="inout-col">${week.inOut || ''}</td>`;
                    pdfHtml += `<td class="hrs-col">${week.hours ? parseFloat(week.hours).toFixed(2) : ''}</td>`;
                    pdfHtml += `<td class="desc-col">${week.description || ''}</td>`;
                });

                if (entry.signatureImage) {
                    pdfHtml += `<td class="sig-col"><img src="${entry.signatureImage}" class="signature-img"></td>`;
                } else {
                    pdfHtml += `<td class="sig-col">-</td>`;
                }
                pdfHtml += `<td class="date-col">${entry.signedOn || '-'}</td>`;
                pdfHtml += `</tr>`;
            });

            pdfHtml += `
                    </tbody>
                </table>
                <div class="footer">
                    <p>Total entries: ${timesheetData.length} | Staff: ${[...new Set(timesheetData.map(e => e.staff))].length}</p>
                </div>
            </body>
            </html>
            `;

            // Open in new window for printing/saving as PDF
            const printWindow = window.open('', '_blank');
            printWindow.document.write(pdfHtml);
            printWindow.document.close();

            // Trigger print dialog (user can save as PDF)
            setTimeout(() => {
                printWindow.print();
            }, 500);

            showToast('PDF ready - use Print dialog to save', 'success');
        }

        // ============================================
        // SAVE / LOAD TIMESHEETS
        // ============================================

        // Save timesheet to database (Supabase)
        async function saveTimesheetToDatabase() {
            if (timesheetData.length === 0) {
                showToast('No timesheet data to save', 'error');
                return;
            }

            try {
                await ensureAuthenticated();

                // Use stored project name, or fall back to dropdown
                const projectName = currentTimesheetProject ||
                    (document.getElementById('forecastProjectSelect').options[document.getElementById('forecastProjectSelect').selectedIndex]?.text) ||
                    'Unknown Project';

                const saveData = {
                    user_id: currentUser.id,
                    project_name: projectName,
                    timesheet_data: timesheetData,
                    is_approved: timesheetApproved,
                    created_at: new Date().toISOString(),
                    metadata: {
                        staff_count: [...new Set(timesheetData.map(e => e.staff))].length,
                        total_entries: timesheetData.length,
                        total_hours: timesheetData.reduce((sum, e) => sum + e.weeks.reduce((s, w) => s + (parseFloat(w.hours) || 0), 0), 0)
                    }
                };

                const { data, error } = await supabaseClient
                    .from('saved_timesheets')
                    .insert([saveData])
                    .select();

                if (error) throw error;

                showToast('Timesheet saved to database!', 'success');
                console.log('Timesheet saved:', data);

            } catch (error) {
                console.error('Failed to save timesheet:', error);

                // Fallback to localStorage
                const saved = JSON.parse(localStorage.getItem('saved_timesheets') || '[]');

                // Use stored project name, or fall back to dropdown
                const projectName = currentTimesheetProject ||
                    (document.getElementById('forecastProjectSelect').options[document.getElementById('forecastProjectSelect').selectedIndex]?.text) ||
                    'Unknown Project';

                saved.push({
                    id: Date.now(),
                    project_name: projectName,
                    timesheet_data: timesheetData,
                    is_approved: timesheetApproved,
                    created_at: new Date().toISOString(),
                    metadata: {
                        staff_count: [...new Set(timesheetData.map(e => e.staff))].length,
                        total_entries: timesheetData.length
                    }
                });

                localStorage.setItem('saved_timesheets', JSON.stringify(saved));
                showToast('Timesheet saved locally (database unavailable)', 'warning');
            }
        }

        // Show load timesheet modal
        async function showLoadTimesheetModal() {
            const listEl = document.getElementById('savedTimesheetList');
            listEl.innerHTML = '<p style="color: #666;">Loading...</p>';
            document.getElementById('loadTimesheetModal').style.display = 'block';

            let savedTimesheets = [];

            try {
                await ensureAuthenticated();

                const { data, error } = await supabaseClient
                    .from('saved_timesheets')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (!error && data) {
                    savedTimesheets = data;
                }
            } catch (error) {
                console.error('Failed to load from database:', error);
            }

            // Also load from localStorage
            const localSaved = JSON.parse(localStorage.getItem('saved_timesheets') || '[]');
            savedTimesheets = [...savedTimesheets, ...localSaved];

            if (savedTimesheets.length === 0) {
                listEl.innerHTML = '<p style="color: #999; text-align: center;">No saved timesheets found.</p>';
                return;
            }

            let html = '';
            savedTimesheets.forEach((ts, idx) => {
                const date = new Date(ts.created_at).toLocaleString('en-GB');
                const meta = ts.metadata || {};
                html += `
                <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 10px; background: ${ts.is_approved ? '#e8f5e9' : '#fafafa'};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="font-size: 13px;">${ts.project_name || 'Unnamed'}</strong>
                            ${ts.is_approved ? '<span style="color: #00c853; font-size: 10px; margin-left: 8px;">‚úì APPROVED</span>' : ''}
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                                ${date} | ${meta.total_entries || '?'} entries | ${meta.staff_count || '?'} staff
                            </div>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button class="btn" onclick="loadSavedTimesheet(${idx}, ${ts.id ? `'db'` : `'local'`})" style="background: #2196f3; color: white; font-size: 11px; padding: 4px 10px;">Load</button>
                            <button class="btn" onclick="deleteSavedTimesheet(${ts.id || idx}, ${ts.id ? `'db'` : `'local'`})" style="background: #f44336; color: white; font-size: 11px; padding: 4px 10px;">Delete</button>
                        </div>
                    </div>
                </div>
                `;
            });

            listEl.innerHTML = html;

            // Store for loading
            window.savedTimesheetsCache = savedTimesheets;
        }

        // Close load timesheet modal
        function closeLoadTimesheetModal() {
            document.getElementById('loadTimesheetModal').style.display = 'none';
        }

        // Load a saved timesheet
        function loadSavedTimesheet(index, source) {
            const ts = window.savedTimesheetsCache[index];
            if (!ts) {
                showToast('Timesheet not found', 'error');
                return;
            }

            timesheetData = ts.timesheet_data;
            timesheetApproved = ts.is_approved;
            currentTimesheetProject = ts.project_name || 'Unknown Project'; // Restore project name

            if (timesheetApproved) {
                displayTimesheetOutputWithSignatures();
            } else {
                displayTimesheetOutput();
            }

            updateSignatureButtons();
            closeLoadTimesheetModal();
            showToast(`Loaded timesheet: ${ts.project_name}`, 'success');
        }

        // Delete a saved timesheet
        async function deleteSavedTimesheet(id, source) {
            if (!confirm('Delete this saved timesheet?')) return;

            if (source === 'db') {
                try {
                    await ensureAuthenticated();
                    const { error } = await supabaseClient
                        .from('saved_timesheets')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    showToast('Timesheet deleted', 'success');
                } catch (error) {
                    console.error('Failed to delete:', error);
                    showToast('Failed to delete timesheet', 'error');
                }
            } else {
                const saved = JSON.parse(localStorage.getItem('saved_timesheets') || '[]');
                saved.splice(id, 1);
                localStorage.setItem('saved_timesheets', JSON.stringify(saved));
                showToast('Timesheet deleted', 'success');
            }

            showLoadTimesheetModal(); // Refresh list
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Auto-save system prompt on change
        document.getElementById('systemPrompt').addEventListener('change', saveSystemPrompt);

        // Auto-save staff mappings on change

        // Copy for Excel (tab-separated)
        function copyForExcel() {
            if (timesheetData.length === 0) {
                showToast('No data to copy', 'error');
                return;
            }

            let text = '';

            timesheetData.forEach(entry => {
                const weeks = Array(5).fill(null).map((_, i) => {
                    return entry.weeks.find(w => w.weekNum === i + 1) || { inOut: '', hours: '', description: '' };
                });

                weeks.forEach((week, index) => {
                    text += week.inOut || '';
                    text += '\t';
                    text += week.hours || '';
                    text += '\t';
                    text += week.description || '';
                    if (index < weeks.length - 1) {
                        text += '\t';
                    }
                });

                text += '\n';
            });

            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied week data only', 'success');
            }).catch(err => {
                showToast('Copy failed: ' + err, 'error');
            });
        }

        // Save to history
        function saveToHistory() {
            const history = JSON.parse(localStorage.getItem('timesheetHistory') || '[]');
            const entry = {
                timestamp: new Date().toISOString(),
                data: timesheetData,
                forecastData: forecastData,
                ganttName: ganttData ? ganttData.name : 'Unknown'
            };
            
            history.unshift(entry);
            // Keep only last 10
            if (history.length > 10) {
                history.pop();
            }
            
            localStorage.setItem('timesheetHistory', JSON.stringify(history));
        }

        // Show history
        function showHistory() {
            const history = JSON.parse(localStorage.getItem('timesheetHistory') || '[]');
            const modal = document.getElementById('historyModal');
            const list = document.getElementById('historyList');

            if (history.length === 0) {
                list.innerHTML = '<p>No generation history found.</p>';
            } else {
                let html = '<table class="preview-table"><thead><tr><th>Date</th><th>Gantt</th><th>Entries</th><th>Actions</th></tr></thead><tbody>';
                
                history.forEach((entry, index) => {
                    const date = new Date(entry.timestamp).toLocaleString();
                    html += `<tr>
                        <td>${date}</td>
                        <td>${entry.ganttName}</td>
                        <td>${entry.data.length}</td>
                        <td>
                            <button class="btn btn-primary" onclick="loadHistory(${index})">Load</button>
                            <button class="btn btn-danger" onclick="deleteHistory(${index})">Delete</button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                list.innerHTML = html;
            }

            modal.style.display = 'block';
        }

        function closeHistory() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // ============================================
        // LABOUR BUDGET SUMMARY FUNCTIONALITY
        // ============================================

        let currentLabourBudgetProject = null;
        let staffAllocations = []; // Array to store staff allocations with their grant item assignments
        let labourBudgetStep = 1; // 1 = select project, 2 = select category, 3 = select item
        let selectedStaffMember = null;
        let selectedProjectForBudget = null;
        let selectedCategoryForBudget = null;

        function showLabourBudgetSummary(projectIdx) {
            try {
                console.log('üîµ showLabourBudgetSummary called! projectIdx:', projectIdx);
                console.log('üîµ labourProjects:', labourProjects);

                currentLabourBudgetProject = labourProjects[projectIdx];

                if (!currentLabourBudgetProject) {
                    console.error('‚ùå Project not found at index:', projectIdx);
                    alert('Project not found at index: ' + projectIdx);
                    return;
                }

                console.log('‚úÖ Found project:', currentLabourBudgetProject.name);
            } catch (error) {
                console.error('‚ùå‚ùå‚ùå ERROR in showLabourBudgetSummary (before steps):', error);
                alert('Error (1): ' + error.message);
                return;
            }

            try {

            // Close any existing budget panel
            console.log('üü° Step 1: Closing existing panel');
            closeInlineBudgetPanel();

            // Create or get the project's budget data
            console.log('üü° Step 2: Loading budget data');
            const projectKey = currentLabourBudgetProject.id || currentLabourBudgetProject.name;
            if (!currentLabourBudgetProject.budgetItems) {
                // Try to load from localStorage
                try {
                    const localData = localStorage.getItem(`project_budget_${projectKey}`);
                    currentLabourBudgetProject.budgetItems = localData ? JSON.parse(localData) : [];
                    console.log('Loaded budget items:', currentLabourBudgetProject.budgetItems);
                } catch (err) {
                    console.error('Error loading budget:', err);
                    currentLabourBudgetProject.budgetItems = [];
                }
            }

            // Calculate position above the project column
            console.log('üü° Step 3: Finding DOM elements');
            const projectHeaderRow = document.getElementById('projectHeaderRow');
            console.log('projectHeaderRow:', projectHeaderRow);

            const projectHeaders = projectHeaderRow.querySelectorAll('th[data-project-idx]');
            console.log('Found', projectHeaders.length, 'th elements with data-project-idx');

            const targetHeader = Array.from(projectHeaders).find(th =>
                parseInt(th.dataset.projectIdx) === projectIdx
            );
            console.log('targetHeader for idx', projectIdx, ':', targetHeader);

            if (!targetHeader) {
                console.error('‚ùå targetHeader not found!');
                alert('Could not find project header');
                return;
            }

            // Get position of the project header
            console.log('üü° Step 4: Calculating position');
            const rect = targetHeader.getBoundingClientRect();
            const tableContainer = document.querySelector('#labourTable').parentElement;
            const containerRect = tableContainer.getBoundingClientRect();
            const table = document.querySelector('#labourTable');
            const tableRect = table.getBoundingClientRect();
            console.log('rect:', rect);
            console.log('containerRect:', containerRect);
            console.log('tableRect:', tableRect);

            // Create inline budget panel - positioned above the table
            const panel = document.createElement('div');
            panel.id = 'inlineBudgetPanel';

            // Calculate position above the table, aligned with project column
            const topPosition = tableRect.top - containerRect.top + tableContainer.scrollTop - 220; // Above the table
            const leftPosition = rect.left - containerRect.left + tableContainer.scrollLeft;

            panel.style.cssText = `
                position: absolute;
                top: ${topPosition}px;
                left: ${leftPosition}px;
                width: 420px;
                background: white;
                border: 1.5px solid #3b82f6;
                border-radius: 4px;
                padding: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                z-index: 1000;
                font-size: 11px;
            `;

            // Build the panel content
            panel.innerHTML = `
                <div style="margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-weight: 600; color: #1e40af; font-size: 12px;">${currentLabourBudgetProject.name}</div>
                    <button onclick="closeInlineBudgetPanel()" style="background: #ef4444; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 11px; line-height: 1;">‚úï</button>
                </div>

                <table id="budgetItemsTable" style="width: 100%; border-collapse: collapse; margin-bottom: 6px; font-size: 11px;">
                    <thead>
                        <tr style="background: #f1f5f9;">
                            <th style="padding: 3px 4px; text-align: left; border: 1px solid #e2e8f0; font-size: 10px;">Role</th>
                            <th style="padding: 3px 4px; text-align: left; border: 1px solid #e2e8f0; font-size: 10px; width: 70px;">Rate (¬£)</th>
                            <th style="padding: 3px 4px; text-align: left; border: 1px solid #e2e8f0; font-size: 10px; width: 50px;">Days</th>
                            <th style="padding: 3px 4px; text-align: right; border: 1px solid #e2e8f0; font-size: 10px; width: 70px;">Total (¬£)</th>
                            <th style="padding: 3px 4px; text-align: center; border: 1px solid #e2e8f0; font-size: 10px; width: 24px;"></th>
                        </tr>
                    </thead>
                    <tbody id="budgetItemsBody">
                        ${renderBudgetItems(currentLabourBudgetProject.budgetItems)}
                    </tbody>
                </table>

                <div style="display: flex; gap: 6px;">
                    <button onclick="addBudgetRow()" style="background: #10b981; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">+ Row</button>
                    <button onclick="saveBudgetToDatabase()" style="background: #3b82f6; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">üíæ Save</button>
                </div>
            `;

            // Add to the table container (position relative)
            tableContainer.style.position = 'relative';
            tableContainer.appendChild(panel);

            // Store current project index
            window.currentBudgetProjectIdx = projectIdx;

            // Add click-outside-to-close functionality
            setTimeout(() => {
                document.addEventListener('click', handleOutsideClick);
            }, 100);

            console.log('‚úÖ‚úÖ‚úÖ Budget panel created successfully!');

            } catch (error) {
                console.error('‚ùå‚ùå‚ùå ERROR in showLabourBudgetSummary (main):', error);
                console.error('Error stack:', error.stack);
                alert('Error creating budget panel: ' + error.message);
            }
        }

        function handleOutsideClick(event) {
            const panel = document.getElementById('inlineBudgetPanel');
            if (panel && !panel.contains(event.target)) {
                // Check if the click was on a project header (to allow switching projects)
                const isProjectHeader = event.target.closest('[onclick*="showLabourBudgetSummary"]');
                if (!isProjectHeader) {
                    closeInlineBudgetPanel();
                    document.removeEventListener('click', handleOutsideClick);
                }
            }
        }

        function closeInlineBudgetPanel() {
            const existingPanel = document.getElementById('inlineBudgetPanel');
            if (existingPanel) {
                existingPanel.remove();
            }
            window.currentBudgetProjectIdx = null;
            document.removeEventListener('click', handleOutsideClick);
        }

        function renderBudgetItems(items) {
            if (!items || items.length === 0) {
                return '<tr><td colspan="5" style="text-align: center; padding: 8px; color: #999; font-size: 10px;">Click "+ Row"</td></tr>';
            }

            return items.map((item, idx) => {
                const total = (parseFloat(item.dayRate) || 0) * (parseFloat(item.days) || 0);
                return `
                    <tr>
                        <td style="padding: 2px 3px; border: 1px solid #e2e8f0;">
                            <input type="text" value="${item.role || ''}"
                                   onchange="updateBudgetItem(${idx}, 'role', this.value)"
                                   placeholder="Role"
                                   style="width: 100%; padding: 2px 3px; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 10px;">
                        </td>
                        <td style="padding: 2px 3px; border: 1px solid #e2e8f0;">
                            <input type="number" step="0.01" value="${item.dayRate || ''}"
                                   onchange="updateBudgetItem(${idx}, 'dayRate', this.value)"
                                   placeholder="0.00"
                                   style="width: 100%; padding: 2px 3px; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 10px;">
                        </td>
                        <td style="padding: 2px 3px; border: 1px solid #e2e8f0;">
                            <input type="number" step="0.1" value="${item.days || ''}"
                                   onchange="updateBudgetItem(${idx}, 'days', this.value)"
                                   placeholder="0"
                                   style="width: 100%; padding: 2px 3px; border: 1px solid #cbd5e1; border-radius: 2px; font-size: 10px;">
                        </td>
                        <td style="padding: 2px 4px; border: 1px solid #e2e8f0; text-align: right; font-weight: 600; font-size: 10px;">
                            ¬£${total.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </td>
                        <td style="padding: 2px; border: 1px solid #e2e8f0; text-align: center;">
                            <button onclick="removeBudgetItem(${idx})"
                                    style="background: #ef4444; color: white; border: none; padding: 2px 4px; border-radius: 2px; cursor: pointer; font-size: 10px; line-height: 1;">√ó</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function addBudgetRow() {
            if (!currentLabourBudgetProject.budgetItems) {
                currentLabourBudgetProject.budgetItems = [];
            }

            currentLabourBudgetProject.budgetItems.push({
                role: '',
                dayRate: 0,
                days: 0
            });

            // Refresh the table
            refreshBudgetTable();
        }

        function updateBudgetItem(idx, field, value) {
            if (!currentLabourBudgetProject.budgetItems[idx]) return;

            if (field === 'role') {
                currentLabourBudgetProject.budgetItems[idx][field] = value;
            } else {
                currentLabourBudgetProject.budgetItems[idx][field] = parseFloat(value) || 0;
            }

            // Refresh the table to update totals
            refreshBudgetTable();
        }

        function removeBudgetItem(idx) {
            if (!currentLabourBudgetProject.budgetItems) return;

            currentLabourBudgetProject.budgetItems.splice(idx, 1);
            refreshBudgetTable();
        }

        function refreshBudgetTable() {
            const tbody = document.getElementById('budgetItemsBody');
            if (tbody && currentLabourBudgetProject) {
                tbody.innerHTML = renderBudgetItems(currentLabourBudgetProject.budgetItems);
            }
        }

        async function loadProjectBudget(projectKey) {
            try {
                // Try to load from Supabase first
                await ensureAuthenticated();
                const { data, error } = await supabaseClient
                    .from('labour_allocation')
                    .select('allocation_data')
                    .eq('user_id', currentUser.id)
                    .single();

                if (!error && data && data.allocation_data) {
                    const allBudgets = data.allocation_data;
                    if (allBudgets[projectKey]) {
                        return allBudgets[projectKey];
                    }
                }
            } catch (err) {
                console.log('Supabase load failed, trying localStorage:', err);
            }

            // Fallback to localStorage
            const localData = localStorage.getItem(`project_budget_${projectKey}`);
            if (localData) {
                return JSON.parse(localData);
            }

            return null;
        }

        async function saveBudgetToDatabase() {
            if (!currentLabourBudgetProject) {
                alert('No project data to save');
                return;
            }

            const projectKey = currentLabourBudgetProject.id || currentLabourBudgetProject.name;

            try {
                showToast('Saving budget...', 'info');

                // Save to localStorage first
                localStorage.setItem(
                    `project_budget_${projectKey}`,
                    JSON.stringify(currentLabourBudgetProject.budgetItems)
                );

                // Save to Supabase
                await ensureAuthenticated();

                // Load existing allocation data
                let allBudgets = {};
                const { data: existingData } = await supabaseClient
                    .from('labour_allocation')
                    .select('allocation_data')
                    .eq('user_id', currentUser.id)
                    .single();

                if (existingData && existingData.allocation_data) {
                    allBudgets = existingData.allocation_data;
                }

                // Update this project's budget
                allBudgets[projectKey] = currentLabourBudgetProject.budgetItems;

                // Upsert to Supabase
                const { error } = await supabaseClient
                    .from('labour_allocation')
                    .upsert({
                        user_id: currentUser.id,
                        allocation_data: allBudgets
                    }, {
                        onConflict: 'user_id'
                    });

                if (error) {
                    console.error('Supabase save error:', error);
                    showToast('‚ö†Ô∏è Saved locally, but cloud sync failed', 'warning');
                } else {
                    showToast('‚úÖ Budget saved successfully', 'success');
                }

                // Update the project in labourProjects array
                if (window.currentBudgetProjectIdx !== null) {
                    labourProjects[window.currentBudgetProjectIdx].budgetItems = currentLabourBudgetProject.budgetItems;
                }

            } catch (error) {
                console.error('Error saving budget:', error);
                alert('Failed to save budget: ' + error.message);
            }
        }

        function closeLabourBudgetSection() {
            document.getElementById('labourBudgetSection').style.display = 'none';
            currentLabourBudgetProject = null;
            staffAllocations = [];
            labourBudgetStep = 1;
            selectedStaffMember = null;
            selectedProjectForBudget = null;
            selectedCategoryForBudget = null;
        }

        // ============================================
        // NEW LABOUR BUDGET FUNCTIONS
        // ============================================

        let currentBudgetProject = null;
        let currentBudgetItems = [];

        // Populate the project dropdown with grant projects from database
        async function populateBudgetProjectDropdown() {
            const select = document.getElementById('budgetProjectSelect');
            if (!select) return;

            select.innerHTML = '<option value="">-- Select a project --</option>';

            try {
                // Load from IndexedDB
                await initializeGrantsDB();
                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');
                const allProjects = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                db.close();

                console.log('‚úÖ Loaded grant projects for budget dropdown:', allProjects.length);

                if (allProjects && allProjects.length > 0) {
                    allProjects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.projectId;
                        option.textContent = project.projectName || project.projectNumber || `Project ${project.projectId}`;
                        select.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '-- No grant projects found --';
                    option.disabled = true;
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('Error loading grant projects:', error);
                showToast('Failed to load grant projects', 'error');
            }
        }

        // Toggle Labour Budget section collapse/expand
        function toggleLabourBudgetCollapse() {
            const content = document.getElementById('labourBudgetContent');
            const btn = document.getElementById('labourBudgetCollapseBtn');
            const isCollapsed = content.style.display === 'none';

            if (isCollapsed) {
                content.style.display = 'block';
                btn.textContent = '‚ñº';
                localStorage.setItem('labourBudgetCollapsed', 'false');
            } else {
                content.style.display = 'none';
                btn.textContent = '‚ñ∂';
                localStorage.setItem('labourBudgetCollapsed', 'true');
            }
        }

        // Initialize Labour Budget collapse state on page load
        function initializeLabourBudgetCollapseState() {
            const isCollapsed = localStorage.getItem('labourBudgetCollapsed') === 'true';
            if (isCollapsed) {
                document.getElementById('labourBudgetContent').style.display = 'none';
                document.getElementById('labourBudgetCollapseBtn').textContent = '‚ñ∂';
            }
        }

        // Load budget data for the selected project
        async function loadProjectBudgetData() {
            const select = document.getElementById('budgetProjectSelect');
            const projectId = select.value;

            console.log('üìÇ Loading budget for projectId:', projectId);

            if (!projectId) {
                document.getElementById('budgetTableContainer').style.display = 'none';
                currentBudgetProject = null;
                currentBudgetItems = [];
                // Clear notes display
                renderBudgetNotes();
                return;
            }

            try {
                // Load project from IndexedDB
                await initializeGrantsDB();
                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');
                const project = await new Promise((resolve, reject) => {
                    const request = store.get(projectId);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                db.close();

                console.log('üì¶ Retrieved from IndexedDB:', project);

                // If project not found, create a minimal object
                if (!project) {
                    console.warn('‚ö†Ô∏è Project not found in database, creating minimal object');
                    currentBudgetProject = {
                        projectId: projectId,
                        projectName: select.options[select.selectedIndex].text,
                        budgetItems: []
                    };
                } else {
                    currentBudgetProject = project;
                }

                currentBudgetItems = currentBudgetProject.budgetItems || [];

                console.log('‚úÖ currentBudgetProject:', currentBudgetProject);
                console.log('‚úÖ currentBudgetItems:', currentBudgetItems);

                // Show the table
                document.getElementById('budgetTableContainer').style.display = 'block';

                // Render the budget items
                renderBudgetTableNew();

                // Render budget notes
                renderBudgetNotes();

                // Calculate and display allocation breakdown
                calculateAllocationBreakdown(projectId);

            } catch (error) {
                console.error('‚ùå Error loading project budget:', error);
                showToast('Failed to load project budget', 'error');
            }
        }

        // Calculate allocation breakdown from labour table
        function calculateAllocationBreakdown(grantProjectId) {
            const breakdownContent = document.getElementById('allocationBreakdownContent');
            if (!breakdownContent) return;

            // Find which labour project is linked to this grant
            const linkedProjectIdx = labourProjects.findIndex(p => p.grantProjectId == grantProjectId);

            if (linkedProjectIdx === -1) {
                breakdownContent.innerHTML = `
                    <p style="color: #9ca3af; font-size: 11px; margin: 0;">
                        ‚ÑπÔ∏è No labour allocation project is linked to this grant. Use "üîó Link Grant" to connect them.
                    </p>
                `;
                // Still show quarterly breakdown info
                calculateQuarterlyBreakdown(grantProjectId, -1);
                return;
            }

            const linkedProject = labourProjects[linkedProjectIdx];

            // Scan all rows and collect allocations for this project
            const allocationsByRate = {};

            labourRows.forEach(row => {
                const projectAllocation = row.projects[linkedProjectIdx];
                if (!projectAllocation) return;

                const days = parseFloat(projectAllocation.days) || 0;
                const rate = parseFloat(projectAllocation.rate) || 0;

                if (days > 0 && rate > 0) {
                    const rateKey = rate.toFixed(2);
                    if (!allocationsByRate[rateKey]) {
                        allocationsByRate[rateKey] = {
                            rate: rate,
                            totalDays: 0,
                            totalCost: 0
                        };
                    }
                    allocationsByRate[rateKey].totalDays += days;
                    allocationsByRate[rateKey].totalCost += days * rate;
                }
            });

            // Get budget items from grant
            const budgetItems = currentBudgetItems || [];

            // Build the breakdown HTML
            if (Object.keys(allocationsByRate).length === 0) {
                breakdownContent.innerHTML = `
                    <p style="color: #9ca3af; font-size: 11px; margin: 0;">
                        No allocations found for "${linkedProject.name}" in the labour table.
                    </p>
                `;
                return;
            }

            let breakdownHTML = `
                <div style="margin-bottom: 6px; font-size: 12px;">
                    <strong style="color: #166534;">Linked Labour Project:</strong> ${linkedProject.name}
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                    <thead>
                        <tr style="background: #dcfce7;">
                            <th style="padding: 4px; text-align: left; border: 1px solid #86efac;">Rate (¬£/day)</th>
                            <th style="padding: 4px; text-align: right; border: 1px solid #86efac;">Allocated Days</th>
                            <th style="padding: 4px; text-align: right; border: 1px solid #86efac;">Allocated Cost</th>
                            <th style="padding: 4px; text-align: right; border: 1px solid #86efac;">Budgeted Days</th>
                            <th style="padding: 4px; text-align: right; border: 1px solid #86efac;">Budget Status</th>
                            <th style="padding: 4px; text-align: right; border: 1px solid #86efac;">% Remaining</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Sort by rate
            const sortedRates = Object.keys(allocationsByRate).sort((a, b) => parseFloat(b) - parseFloat(a));

            sortedRates.forEach(rateKey => {
                const allocation = allocationsByRate[rateKey];

                // Find matching budget item(s) with this rate
                const matchingBudgetItems = budgetItems.filter(item =>
                    Math.abs(parseFloat(item.dayRate) - allocation.rate) < 0.01
                );

                const budgetedDays = matchingBudgetItems.reduce((sum, item) =>
                    sum + (parseFloat(item.days) || 0), 0
                );

                const remaining = budgetedDays - allocation.totalDays;
                const percentUsed = budgetedDays > 0 ? (allocation.totalDays / budgetedDays * 100) : 0;

                let statusColor = '#16a34a'; // green
                let statusText = `${remaining.toFixed(1)} days remaining`;

                if (percentUsed > 100) {
                    statusColor = '#dc2626'; // red
                    statusText = `‚ö†Ô∏è ${Math.abs(remaining).toFixed(1)} days over budget!`;
                } else if (percentUsed > 80) {
                    statusColor = '#f59e0b'; // orange
                    statusText = `${remaining.toFixed(1)} days remaining (${percentUsed.toFixed(0)}% used)`;
                }

                breakdownHTML += `
                    <tr>
                        <td style="padding: 4px; border: 1px solid #86efac; font-weight: 600;">¬£${allocation.rate.toFixed(2)}</td>
                        <td style="padding: 4px; border: 1px solid #86efac; text-align: right;">${allocation.totalDays.toFixed(1)}</td>
                        <td style="padding: 4px; border: 1px solid #86efac; text-align: right;">¬£${allocation.totalCost.toLocaleString('en-GB', { minimumFractionDigits: 2 })}</td>
                        <td style="padding: 4px; border: 1px solid #86efac; text-align: right;">${budgetedDays > 0 ? budgetedDays.toFixed(1) : 'N/A'}</td>
                        <td style="padding: 4px; border: 1px solid #86efac; text-align: right; color: ${statusColor}; font-weight: 600;">${budgetedDays > 0 ? statusText : 'No budget set'}</td>
                        <td style="padding: 4px; border: 1px solid #86efac; text-align: right; color: ${statusColor}; font-weight: 600;">${budgetedDays > 0 ? (100 - percentUsed).toFixed(1) + '%' : 'N/A'}</td>
                    </tr>
                `;
            });

            // Calculate totals
            const totalAllocatedDays = sortedRates.reduce((sum, key) => sum + allocationsByRate[key].totalDays, 0);
            const totalAllocatedCost = sortedRates.reduce((sum, key) => sum + allocationsByRate[key].totalCost, 0);
            const totalBudgetedDays = budgetItems.reduce((sum, item) => sum + (parseFloat(item.days) || 0), 0);
            const totalBudgetedCost = budgetItems.reduce((sum, item) => sum + ((parseFloat(item.dayRate) || 0) * (parseFloat(item.days) || 0)), 0);

            breakdownHTML += `
                    <tr style="background: #d1fae5; font-weight: 600;">
                        <td style="padding: 4px; border: 1px solid #86efac;">TOTAL</td>
                        <td style="padding: 4px; border: 1px solid #86efac; text-align: right;">${totalAllocatedDays.toFixed(1)}</td>
                        <td style="padding: 4px; border: 1px solid #86efac; text-align: right;">¬£${totalAllocatedCost.toLocaleString('en-GB', { minimumFractionDigits: 2 })}</td>
                        <td style="padding: 4px; border: 1px solid #86efac; text-align: right;">${totalBudgetedDays.toFixed(1)}</td>
                        <td style="padding: 4px; border: 1px solid #86efac; text-align: right; color: ${totalAllocatedCost > totalBudgetedCost ? '#dc2626' : '#16a34a'};">
                            ${totalBudgetedCost > 0 ? `¬£${(totalBudgetedCost - totalAllocatedCost).toLocaleString('en-GB', { minimumFractionDigits: 2 })} remaining` : 'N/A'}
                        </td>
                        <td style="padding: 4px; border: 1px solid #86efac; text-align: right; color: ${totalAllocatedCost > totalBudgetedCost ? '#dc2626' : '#16a34a'};">
                            ${totalBudgetedDays > 0 ? ((totalBudgetedDays - totalAllocatedDays) / totalBudgetedDays * 100).toFixed(1) + '%' : 'N/A'}
                        </td>
                    </tr>
                </tbody>
                </table>
            `;

            breakdownContent.innerHTML = breakdownHTML;

            // Also calculate quarterly breakdown
            calculateQuarterlyBreakdown(grantProjectId, linkedProjectIdx);
        }

        // Calculate quarterly spend breakdown based on project duration
        async function calculateQuarterlyBreakdown(grantProjectId, linkedProjectIdx) {
            const quarterlyContent = document.getElementById('quarterlyBreakdownContent');
            if (!quarterlyContent) return;

            // Get the grant project data to get project duration
            let grantProject = null;
            try {
                const allProjects = await loadGrantsData();
                // Check both id and projectId fields for match
                grantProject = allProjects.find(p =>
                    p.id == grantProjectId || p.projectId == grantProjectId
                );
                console.log('[QUARTERLY] Found project:', grantProject?.projectName || 'not found',
                    'financeSummary:', grantProject?.financeSummary);
            } catch (error) {
                console.error('Error loading grant for quarterly breakdown:', error);
            }

            // Render the breakdown with the loaded project
            renderQuarterlyBreakdownTable(grantProject, linkedProjectIdx, grantProjectId);
        }

        // Render quarterly breakdown table (shared by calculateQuarterlyBreakdown and saveQuarterlyProjectDuration)
        function renderQuarterlyBreakdownTable(grantProject, linkedProjectIdx, grantProjectId) {
            const quarterlyContent = document.getElementById('quarterlyBreakdownContent');
            if (!quarterlyContent) return;

            // Get existing values or defaults
            const fs = grantProject?.financeSummary || {};
            const startMonth = fs.projectStartMonth || null;
            const startYear = fs.projectStartYear || null;
            const durationMonths = fs.projectDurationMonths || null;

            if (!startMonth || !startYear || !durationMonths) {
                // Show inline form to set project duration
                const currentYear = new Date().getFullYear();
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

                let monthOptions = '<option value="">Month</option>';
                months.forEach((m, i) => {
                    const selected = startMonth === (i + 1) ? 'selected' : '';
                    monthOptions += `<option value="${i + 1}" ${selected}>${m}</option>`;
                });

                let yearOptions = '<option value="">Year</option>';
                for (let y = currentYear - 3; y <= currentYear + 5; y++) {
                    const selected = startYear === y ? 'selected' : '';
                    yearOptions += `<option value="${y}" ${selected}>${y}</option>`;
                }

                const projectId = grantProjectId || grantProject?.id || 'null';

                quarterlyContent.innerHTML = `
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                        <span style="font-size: 11px; color: #64748b;">Project Start:</span>
                        <select id="qbStartMonth" style="padding: 4px 8px; border: 1px solid #93c5fd; border-radius: 4px; font-size: 11px;">
                            ${monthOptions}
                        </select>
                        <select id="qbStartYear" style="padding: 4px 8px; border: 1px solid #93c5fd; border-radius: 4px; font-size: 11px;">
                            ${yearOptions}
                        </select>
                        <span style="font-size: 11px; color: #64748b; margin-left: 10px;">Duration:</span>
                        <input type="number" id="qbDuration" value="${durationMonths || ''}" min="1" max="120" placeholder="12"
                               style="width: 60px; padding: 4px 8px; border: 1px solid #93c5fd; border-radius: 4px; font-size: 11px;">
                        <span style="font-size: 11px; color: #64748b;">months</span>
                        <button onclick="saveQuarterlyProjectDuration(${projectId})"
                                style="padding: 4px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            Set Duration
                        </button>
                    </div>
                `;
                return;
            }

            // Calculate quarters based on project start
            const quarters = [];
            const numQuarters = Math.ceil(durationMonths / 3);

            for (let q = 0; q < numQuarters; q++) {
                const qStartMonth = ((startMonth - 1) + (q * 3)) % 12 + 1;
                const qStartYear = startYear + Math.floor(((startMonth - 1) + (q * 3)) / 12);
                const qEndMonth = ((startMonth - 1) + (q * 3) + 2) % 12 + 1;
                const qEndYear = startYear + Math.floor(((startMonth - 1) + (q * 3) + 2) / 12);

                quarters.push({
                    index: q + 1,
                    startMonth: qStartMonth,
                    startYear: qStartYear,
                    endMonth: qEndMonth,
                    endYear: qEndYear,
                    totalCost: 0,
                    totalDays: 0
                });
            }

            // Scan labour rows and sum costs per quarter
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            // Only scan if there's a linked project
            if (linkedProjectIdx >= 0) {
                labourRows.forEach(row => {
                    const projectAllocation = row.projects[linkedProjectIdx];
                    if (!projectAllocation) return;

                    const days = parseFloat(projectAllocation.days) || 0;
                    const rate = parseFloat(projectAllocation.rate) || 0;
                    const cost = days * rate;

                    if (days <= 0 || rate <= 0) return;

                    // Parse row month (YYYY-MM format)
                    const monthStr = row.month;
                    if (!monthStr || typeof monthStr !== 'string') return;

                    const parts = monthStr.split('-');
                    if (parts.length !== 2) return;

                    const rowYear = parseInt(parts[0]);
                    const rowMonth = parseInt(parts[1]);

                    // Find which quarter this month belongs to
                    for (const quarter of quarters) {
                        // Calculate if this month falls within the quarter
                        const qStartDate = new Date(quarter.startYear, quarter.startMonth - 1, 1);
                        const qEndDate = new Date(quarter.endYear, quarter.endMonth - 1, 28); // End of quarter month
                        const rowDate = new Date(rowYear, rowMonth - 1, 15); // Middle of row month

                        if (rowDate >= qStartDate && rowDate <= qEndDate) {
                            quarter.totalCost += cost;
                            quarter.totalDays += days;
                            break;
                        }
                    }
                });
            }

            // Build quarterly breakdown HTML
            const projectId = grantProjectId || grantProject?.id || 'null';
            let quarterlyHTML = `
                <div style="margin-bottom: 6px; font-size: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <span>
                        <strong style="color: #1e40af;">Project Duration:</strong>
                        ${monthNames[startMonth - 1]} ${startYear} - ${durationMonths} months (${numQuarters} quarters)
                    </span>
                    <button onclick="editQuarterlyDuration(${projectId})"
                            style="padding: 2px 8px; background: #e0e7ff; color: #3730a3; border: 1px solid #93c5fd; border-radius: 4px; font-size: 10px; cursor: pointer;">
                        ‚úèÔ∏è Edit
                    </button>
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                    <thead>
                        <tr style="background: #dbeafe;">
                            <th style="padding: 4px; text-align: left; border: 1px solid #93c5fd;">Quarter</th>
                            <th style="padding: 4px; text-align: left; border: 1px solid #93c5fd;">Period</th>
                            <th style="padding: 4px; text-align: right; border: 1px solid #93c5fd;">Days</th>
                            <th style="padding: 4px; text-align: right; border: 1px solid #93c5fd;">Labour Spend</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let grandTotalCost = 0;
            let grandTotalDays = 0;

            quarters.forEach(quarter => {
                grandTotalCost += quarter.totalCost;
                grandTotalDays += quarter.totalDays;

                const periodStr = `${monthNames[quarter.startMonth - 1]} ${quarter.startYear} - ${monthNames[quarter.endMonth - 1]} ${quarter.endYear}`;

                quarterlyHTML += `
                    <tr>
                        <td style="padding: 4px; border: 1px solid #93c5fd; font-weight: 600;">Q${quarter.index}</td>
                        <td style="padding: 4px; border: 1px solid #93c5fd;">${periodStr}</td>
                        <td style="padding: 4px; border: 1px solid #93c5fd; text-align: right;">${quarter.totalDays.toFixed(1)}</td>
                        <td style="padding: 4px; border: 1px solid #93c5fd; text-align: right; font-weight: 600;">¬£${quarter.totalCost.toLocaleString('en-GB', { minimumFractionDigits: 2 })}</td>
                    </tr>
                `;
            });

            quarterlyHTML += `
                    <tr style="background: #bfdbfe; font-weight: 600;">
                        <td style="padding: 4px; border: 1px solid #93c5fd;" colspan="2">TOTAL</td>
                        <td style="padding: 4px; border: 1px solid #93c5fd; text-align: right;">${grandTotalDays.toFixed(1)}</td>
                        <td style="padding: 4px; border: 1px solid #93c5fd; text-align: right;">¬£${grandTotalCost.toLocaleString('en-GB', { minimumFractionDigits: 2 })}</td>
                    </tr>
                </tbody>
                </table>
            `;

            quarterlyContent.innerHTML = quarterlyHTML;
        }

        // Edit quarterly duration - show the form again
        function editQuarterlyDuration(grantProjectId) {
            const quarterlyContent = document.getElementById('quarterlyBreakdownContent');
            if (!quarterlyContent) return;

            const currentYear = new Date().getFullYear();
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

            // Get current values from currentBudgetProject
            const fs = currentBudgetProject?.financeSummary || {};
            const startMonth = fs.projectStartMonth || null;
            const startYear = fs.projectStartYear || null;
            const durationMonths = fs.projectDurationMonths || null;

            let monthOptions = '<option value="">Month</option>';
            months.forEach((m, i) => {
                const selected = startMonth === (i + 1) ? 'selected' : '';
                monthOptions += `<option value="${i + 1}" ${selected}>${m}</option>`;
            });

            let yearOptions = '<option value="">Year</option>';
            for (let y = currentYear - 3; y <= currentYear + 5; y++) {
                const selected = startYear === y ? 'selected' : '';
                yearOptions += `<option value="${y}" ${selected}>${y}</option>`;
            }

            quarterlyContent.innerHTML = `
                <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                    <span style="font-size: 11px; color: #64748b;">Project Start:</span>
                    <select id="qbStartMonth" style="padding: 4px 8px; border: 1px solid #93c5fd; border-radius: 4px; font-size: 11px;">
                        ${monthOptions}
                    </select>
                    <select id="qbStartYear" style="padding: 4px 8px; border: 1px solid #93c5fd; border-radius: 4px; font-size: 11px;">
                        ${yearOptions}
                    </select>
                    <span style="font-size: 11px; color: #64748b; margin-left: 10px;">Duration:</span>
                    <input type="number" id="qbDuration" value="${durationMonths || ''}" min="1" max="120" placeholder="12"
                           style="width: 60px; padding: 4px 8px; border: 1px solid #93c5fd; border-radius: 4px; font-size: 11px;">
                    <span style="font-size: 11px; color: #64748b;">months</span>
                    <button onclick="saveQuarterlyProjectDuration(${grantProjectId})"
                            style="padding: 4px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                        Save
                    </button>
                    <button onclick="cancelEditQuarterlyDuration(${grantProjectId})"
                            style="padding: 4px 12px; background: #6b7280; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            `;
        }

        // Cancel editing and show the table again
        function cancelEditQuarterlyDuration(grantProjectId) {
            const linkedProjectIdx = labourProjects.findIndex(p => p.grantProjectId == grantProjectId);
            renderQuarterlyBreakdownTable(currentBudgetProject, linkedProjectIdx, grantProjectId);
        }

        // Save project duration from quarterly breakdown inline form
        async function saveQuarterlyProjectDuration(grantProjectId) {
            const startMonth = parseInt(document.getElementById('qbStartMonth').value);
            const startYear = parseInt(document.getElementById('qbStartYear').value);
            const durationMonths = parseInt(document.getElementById('qbDuration').value);

            if (!startMonth || !startYear || !durationMonths) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            try {
                // Load the grant project
                const allProjects = await loadGrantsData();
                // Check both id and projectId fields for match
                let project = allProjects.find(p =>
                    p.id == grantProjectId || p.projectId == grantProjectId
                );

                // If project not found, try to create/update based on current budget project
                if (!project && currentBudgetProject) {
                    console.log('Project not found in grants, using currentBudgetProject');
                    project = { ...currentBudgetProject }; // Clone to avoid mutating original
                }

                if (!project) {
                    // Still no project - create a minimal one
                    console.log('Creating new project entry for quarterly breakdown');
                    const newId = grantProjectId || Date.now();
                    project = {
                        id: newId,
                        projectId: newId, // Ensure both fields are set
                        projectName: 'Labour Project',
                        financeSummary: {}
                    };
                }

                // Ensure project has both id and projectId for consistent lookups
                if (!project.projectId && project.id) {
                    project.projectId = project.id;
                }
                if (!project.id && project.projectId) {
                    project.id = project.projectId;
                }

                // Update finance summary
                if (!project.financeSummary) {
                    project.financeSummary = {};
                }
                project.financeSummary.projectStartMonth = startMonth;
                project.financeSummary.projectStartYear = startYear;
                project.financeSummary.projectDurationMonths = durationMonths;

                console.log('[QUARTERLY SAVE] Saving project:', project.projectName,
                    'id:', project.id, 'projectId:', project.projectId,
                    'financeSummary:', project.financeSummary);

                // Save to IndexedDB
                try {
                    const db = await openDB('GrantsDB', 2);
                    const tx = db.transaction('projects', 'readwrite');
                    const store = tx.objectStore('projects');
                    await store.put(project);
                    db.close();
                    console.log('Saved project duration to IndexedDB');
                } catch (dbError) {
                    console.warn('IndexedDB save error:', dbError);
                }

                // Also save to Supabase if logged in
                if (typeof supabaseClient !== 'undefined' && currentUser) {
                    try {
                        // Get the project ID - use projectId if available, fall back to id
                        const projectIdStr = String(project.projectId || project.id);

                        // Use proper upsert pattern (same as saveBudget function)
                        const { error } = await supabaseClient
                            .from('grants')
                            .upsert({
                                user_id: currentUser.id,
                                project_id: projectIdStr,
                                project_data: project,
                                updated_at: new Date().toISOString()
                            }, {
                                onConflict: 'user_id,project_id'
                            });

                        if (error) {
                            console.warn('Supabase save error:', error);
                        } else {
                            console.log('‚úÖ Project duration saved to Supabase');
                        }
                    } catch (e) {
                        console.warn('Cloud sync error:', e);
                    }
                }

                // Update currentBudgetProject reference
                if (currentBudgetProject) {
                    currentBudgetProject.financeSummary = project.financeSummary;
                }

                showToast('Project duration saved', 'success');

                // Recalculate the breakdown with the saved data directly
                const linkedProjectIdx = labourProjects.findIndex(p => p.grantProjectId == grantProjectId);
                renderQuarterlyBreakdownTable(project, linkedProjectIdx, grantProjectId);

            } catch (error) {
                console.error('Error saving project duration:', error);
                showToast('Failed to save: ' + error.message, 'error');
            }
        }

        // Render the budget table
        function renderBudgetTableNew() {
            const tbody = document.getElementById('labourBudgetTableBody');
            if (!tbody) return;

            if (!currentBudgetItems || currentBudgetItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">Click "+ Add Row" to get started</td></tr>';
                // Hide total box when empty
                const totalBox = document.getElementById('labourBudgetTotalBox');
                if (totalBox) totalBox.style.display = 'none';
                return;
            }

            tbody.innerHTML = currentBudgetItems.map((item, idx) => {
                const total = (parseFloat(item.dayRate) || 0) * (parseFloat(item.days) || 0);
                return `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">
                            <input type="text" value="${item.role || ''}"
                                   onchange="updateBudgetRowNew(${idx}, 'role', this.value)"
                                   placeholder="e.g., Project Manager"
                                   style="width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 13px;">
                        </td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">
                            <input type="number" step="0.01" value="${item.dayRate || ''}"
                                   onchange="updateBudgetRowNew(${idx}, 'dayRate', this.value)"
                                   placeholder="0.00"
                                   style="width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 13px;">
                        </td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <input type="number" step="0.5" value="${item.days || ''}"
                                       id="budgetDaysInput_${idx}"
                                       onchange="updateBudgetRowNew(${idx}, 'days', this.value); clearHoursCalculation(${idx});"
                                       placeholder="0"
                                       style="flex: 1; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 13px;">
                                <button onclick="toggleHoursCalculator(${idx})"
                                        title="Calculate days from hours"
                                        style="background: ${item.totalHours ? '#10b981' : '#3b82f6'}; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; white-space: nowrap;">
                                    ‚è±Ô∏è
                                </button>
                            </div>
                            ${item.totalHours ? `<div style="font-size: 10px; color: #059669; margin-top: 4px;">${item.totalHours}hrs √∑ ${item.hrsPerDay || 7.5}hrs/day</div>` : ''}
                            <div id="hoursCalculator_${idx}" style="display: none; margin-top: 8px; padding: 10px; background: #f1f5f9; border-radius: 6px; border: 1px solid #cbd5e1;">
                                <div style="font-size: 11px; font-weight: 600; color: #475569; margin-bottom: 6px;">Calculate Days from Hours</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px;">
                                    <div>
                                        <label style="font-size: 10px; color: #64748b;">Total Hours</label>
                                        <input type="number" step="0.5" id="totalHours_${idx}"
                                               oninput="calculateDaysFromHours(${idx})"
                                               placeholder="0"
                                               value="${item.totalHours || ''}"
                                               style="width: 100%; padding: 4px 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 10px; color: #64748b;">Hrs/Day</label>
                                        <input type="number" step="0.5" id="hrsPerDay_${idx}"
                                               oninput="calculateDaysFromHours(${idx})"
                                               placeholder="7.5"
                                               value="${item.hrsPerDay || 7.5}"
                                               style="width: 100%; padding: 4px 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px;">
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; justify-content: space-between; gap: 6px;">
                                    <span id="calculatedDays_${idx}" style="font-size: 12px; color: #059669; font-weight: 600;">= ${item.days || 0} days</span>
                                    <button onclick="applyCalculatedDays(${idx})"
                                            style="background: #10b981; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                        Apply
                                    </button>
                                </div>
                            </div>
                        </td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right; font-weight: 600; font-size: 14px;">
                            ¬£${total.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: center;">
                            <button onclick="removeBudgetRowNew(${idx})"
                                    style="background: #ef4444; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Calculate and display total labour budget
            updateLabourBudgetTotal();
        }

        // Update total labour budget display
        function updateLabourBudgetTotal() {
            const totalBox = document.getElementById('labourBudgetTotalBox');
            const totalValue = document.getElementById('labourBudgetTotalValue');

            if (!totalBox || !totalValue) return;

            if (!currentBudgetItems || currentBudgetItems.length === 0) {
                totalBox.style.display = 'none';
                return;
            }

            // Calculate total
            const total = currentBudgetItems.reduce((sum, item) => {
                const itemTotal = (parseFloat(item.dayRate) || 0) * (parseFloat(item.days) || 0);
                return sum + itemTotal;
            }, 0);

            // Update display
            totalValue.textContent = '¬£' + total.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            totalBox.style.display = 'block';
        }

        // Add a new budget row
        function addBudgetRowNew() {
            console.log('‚ûï addBudgetRowNew called');
            console.log('currentBudgetProject:', currentBudgetProject);
            console.log('currentBudgetItems:', currentBudgetItems);

            if (!currentBudgetProject) {
                console.error('‚ùå currentBudgetProject is null/undefined!');
                alert('Please select a project first');
                return;
            }

            currentBudgetItems.push({
                role: '',
                dayRate: 0,
                days: 0
            });

            console.log('‚úÖ Added new row, currentBudgetItems now:', currentBudgetItems);

            renderBudgetTableNew();
            showToast('Row added', 'info');
        }

        // Update a budget row
        function updateBudgetRowNew(idx, field, value) {
            if (!currentBudgetItems[idx]) return;

            if (field === 'role') {
                currentBudgetItems[idx][field] = value;
            } else {
                currentBudgetItems[idx][field] = parseFloat(value) || 0;
            }

            renderBudgetTableNew();
        }

        // Remove a budget row
        function removeBudgetRowNew(idx) {
            if (!currentBudgetItems) return;

            currentBudgetItems.splice(idx, 1);
            renderBudgetTableNew();
            showToast('Row removed', 'info');
        }

        // Toggle hours calculator visibility
        function toggleHoursCalculator(idx) {
            const calculator = document.getElementById(`hoursCalculator_${idx}`);
            if (calculator) {
                const isVisible = calculator.style.display !== 'none';
                calculator.style.display = isVisible ? 'none' : 'block';

                // Focus on the total hours input when opening
                if (!isVisible) {
                    const totalHoursInput = document.getElementById(`totalHours_${idx}`);
                    if (totalHoursInput) {
                        totalHoursInput.focus();
                    }
                }
            }
        }

        // Calculate days from total hours and hours per day
        function calculateDaysFromHours(idx) {
            const totalHoursInput = document.getElementById(`totalHours_${idx}`);
            const hrsPerDayInput = document.getElementById(`hrsPerDay_${idx}`);
            const calculatedDaysSpan = document.getElementById(`calculatedDays_${idx}`);

            if (!totalHoursInput || !hrsPerDayInput || !calculatedDaysSpan) return;

            const totalHours = parseFloat(totalHoursInput.value) || 0;
            const hrsPerDay = parseFloat(hrsPerDayInput.value) || 7.5;

            if (hrsPerDay === 0) {
                calculatedDaysSpan.textContent = '= Invalid (√∑0)';
                calculatedDaysSpan.style.color = '#ef4444';
                return;
            }

            const days = totalHours / hrsPerDay;
            const roundedDays = Math.round(days * 100) / 100; // Round to 2 decimal places

            calculatedDaysSpan.textContent = `= ${roundedDays} days`;
            calculatedDaysSpan.style.color = '#059669';
        }

        // Apply calculated days to the days input field
        function applyCalculatedDays(idx) {
            const totalHoursInput = document.getElementById(`totalHours_${idx}`);
            const hrsPerDayInput = document.getElementById(`hrsPerDay_${idx}`);
            const daysInput = document.getElementById(`budgetDaysInput_${idx}`);
            const calculator = document.getElementById(`hoursCalculator_${idx}`);

            if (!totalHoursInput || !hrsPerDayInput || !daysInput) return;

            const totalHours = parseFloat(totalHoursInput.value) || 0;
            const hrsPerDay = parseFloat(hrsPerDayInput.value) || 7.5;

            if (hrsPerDay === 0) {
                showToast('Hours per day cannot be zero', 'error');
                return;
            }

            const days = totalHours / hrsPerDay;
            const roundedDays = Math.round(days * 100) / 100; // Round to 2 decimal places

            // Update the input field
            daysInput.value = roundedDays;

            // Save the hours calculation data to the model
            if (currentBudgetItems[idx]) {
                currentBudgetItems[idx].days = roundedDays;
                currentBudgetItems[idx].totalHours = totalHours;
                currentBudgetItems[idx].hrsPerDay = hrsPerDay;
            }

            // Re-render to update the total
            renderBudgetTableNew();

            showToast(`Applied ${roundedDays} days (${totalHours}hrs √∑ ${hrsPerDay}hrs/day)`, 'success');
        }

        // Clear hours calculation data when user manually edits days
        function clearHoursCalculation(idx) {
            if (currentBudgetItems[idx]) {
                delete currentBudgetItems[idx].totalHours;
                delete currentBudgetItems[idx].hrsPerDay;
            }
        }

        // Toggle inline hours calculator visibility (for Labour Budget Summary Section)
        function toggleInlineHoursCalculator(idx) {
            const calculator = document.getElementById(`inlineHoursCalculator_${idx}`);
            if (calculator) {
                const isVisible = calculator.style.display !== 'none';
                calculator.style.display = isVisible ? 'none' : 'block';

                // Focus on the total hours input when opening
                if (!isVisible) {
                    const totalHoursInput = document.getElementById(`inlineTotalHours_${idx}`);
                    if (totalHoursInput) {
                        totalHoursInput.focus();
                    }
                }
            }
        }

        // Calculate days from hours for inline calculator
        function calculateInlineDaysFromHours(idx) {
            const totalHoursInput = document.getElementById(`inlineTotalHours_${idx}`);
            const hrsPerDayInput = document.getElementById(`inlineHrsPerDay_${idx}`);
            const calculatedDaysSpan = document.getElementById(`inlineCalculatedDays_${idx}`);

            if (!totalHoursInput || !hrsPerDayInput || !calculatedDaysSpan) return;

            const totalHours = parseFloat(totalHoursInput.value) || 0;
            const hrsPerDay = parseFloat(hrsPerDayInput.value) || 7.5;

            if (hrsPerDay === 0) {
                calculatedDaysSpan.textContent = '= Invalid (√∑0)';
                calculatedDaysSpan.style.color = '#ef4444';
                return;
            }

            const days = totalHours / hrsPerDay;
            const roundedDays = Math.round(days * 100) / 100;

            calculatedDaysSpan.textContent = `= ${roundedDays} days`;
            calculatedDaysSpan.style.color = '#059669';
        }

        // Apply calculated days for inline calculator
        function applyInlineCalculatedDays(idx) {
            const totalHoursInput = document.getElementById(`inlineTotalHours_${idx}`);
            const hrsPerDayInput = document.getElementById(`inlineHrsPerDay_${idx}`);

            if (!totalHoursInput || !hrsPerDayInput) return;

            const totalHours = parseFloat(totalHoursInput.value) || 0;
            const hrsPerDay = parseFloat(hrsPerDayInput.value) || 7.5;

            if (hrsPerDay === 0) {
                showToast('Hours per day cannot be zero', 'error');
                return;
            }

            const days = totalHours / hrsPerDay;
            const roundedDays = Math.round(days * 100) / 100;

            // Save the hours calculation data to the model
            if (window.currentEditingGrantProject && window.currentEditingGrantProject.labourBudgetItems[idx]) {
                window.currentEditingGrantProject.labourBudgetItems[idx].totalHours = totalHours;
                window.currentEditingGrantProject.labourBudgetItems[idx].hrsPerDay = hrsPerDay;
            }

            // Update using the existing updateLabourBudgetItem function (this will re-render)
            updateLabourBudgetItem(idx, 'days', roundedDays);

            showToast(`Applied ${roundedDays} days (${totalHours}hrs √∑ ${hrsPerDay}hrs/day)`, 'success');
        }

        // Clear hours calculation data for inline calculator
        function clearInlineHoursCalculation(idx) {
            if (window.currentEditingGrantProject && window.currentEditingGrantProject.labourBudgetItems[idx]) {
                delete window.currentEditingGrantProject.labourBudgetItems[idx].totalHours;
                delete window.currentEditingGrantProject.labourBudgetItems[idx].hrsPerDay;
            }
        }

        // Save budget data to database
        async function saveBudgetData() {
            if (!currentBudgetProject) {
                alert('No project selected');
                return;
            }

            try {
                showToast('Saving budget...', 'info');

                // Update the project with budget items (notes are already in currentBudgetProject.budgetNotes)
                currentBudgetProject.budgetItems = currentBudgetItems;

                // Save to IndexedDB
                await initializeGrantsDB();
                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readwrite');
                const store = tx.objectStore('projects');
                await new Promise((resolve, reject) => {
                    const request = store.put(currentBudgetProject);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
                db.close();

                // Also save to Supabase
                try {
                    await ensureAuthenticated();
                    const { error } = await supabaseClient
                        .from('grants')
                        .upsert({
                            user_id: currentUser.id,
                            project_id: String(currentBudgetProject.projectId),
                            project_data: currentBudgetProject
                        }, {
                            onConflict: 'user_id,project_id'
                        });

                    if (error) {
                        console.error('Supabase save error:', error);
                        showToast('‚ö†Ô∏è Saved locally, but cloud sync failed', 'warning');
                    } else {
                        showToast('‚úÖ Budget saved successfully', 'success');
                    }
                } catch (err) {
                    console.error('Supabase error:', err);
                    showToast('‚ö†Ô∏è Saved locally, but cloud sync failed', 'warning');
                }

            } catch (error) {
                console.error('Error saving budget:', error);
                alert('Failed to save budget: ' + error.message);
            }
        }

        // ============================================
        // BUDGET NOTES FUNCTIONS
        // ============================================

        // Toggle notes section visibility
        function toggleNotesSection() {
            const content = document.getElementById('budgetNotesContent');
            const toggle = document.getElementById('notesSectionToggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñ∂';
            }
        }

        // Add a new budget note
        async function addBudgetNote() {
            const input = document.getElementById('newBudgetNoteInput');
            const noteText = input.value.trim();

            if (!noteText) {
                showToast('Please enter a note', 'warning');
                return;
            }

            if (!currentBudgetProject) {
                showToast('Please select a project first', 'warning');
                return;
            }

            // Initialize notes array if it doesn't exist
            if (!currentBudgetProject.budgetNotes) {
                currentBudgetProject.budgetNotes = [];
            }

            // Create note object with timestamp
            const note = {
                id: Date.now(),
                text: noteText,
                createdAt: new Date().toISOString()
            };

            // Add to array
            currentBudgetProject.budgetNotes.push(note);

            // Clear input
            input.value = '';

            // Render notes
            renderBudgetNotes();

            // Auto-save
            await saveBudgetData();
        }

        // Delete a budget note
        async function deleteBudgetNote(noteId) {
            if (!currentBudgetProject || !currentBudgetProject.budgetNotes) return;

            // Remove note from array
            currentBudgetProject.budgetNotes = currentBudgetProject.budgetNotes.filter(n => n.id !== noteId);

            // Render notes
            renderBudgetNotes();

            // Auto-save
            await saveBudgetData();
        }

        // Render budget notes list
        function renderBudgetNotes() {
            const container = document.getElementById('budgetNotesList');
            if (!container) return;

            const notes = currentBudgetProject?.budgetNotes || [];

            if (notes.length === 0) {
                container.innerHTML = '<p style="color: #a16207; font-size: 12px; margin: 0; font-style: italic;">No notes yet. Add a note above.</p>';
                return;
            }

            let html = '';
            notes.forEach((note, index) => {
                const date = new Date(note.createdAt);
                const dateStr = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

                html += `
                    <div style="display: flex; align-items: flex-start; gap: 10px; padding: 8px; background: white; border: 1px solid #fde68a; border-radius: 4px; margin-bottom: 6px;">
                        <div style="flex: 1;">
                            <p style="margin: 0 0 4px 0; color: #374151; font-size: 13px;">${escapeHtml(note.text)}</p>
                            <span style="font-size: 11px; color: #9ca3af;">${dateStr} at ${timeStr}</span>
                        </div>
                        <button onclick="deleteBudgetNote(${note.id})"
                            style="background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;"
                            title="Delete this note">‚úï</button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize budget dropdown on page load
        document.addEventListener('DOMContentLoaded', () => {
            populateBudgetProjectDropdown();
            initializeLabourBudgetCollapseState();
        });

        // ============================================
        // END NEW LABOUR BUDGET FUNCTIONS
        // ============================================


        async function populateStaffDropdown() {
            const select = document.getElementById('staffMemberSelect');
            if (!select) return;
            select.innerHTML = '<option value="">-- Select Staff Member --</option>';

            // Load staff from database
            if (staffDatabase && staffDatabase.length > 0) {
                staffDatabase.forEach(staff => {
                    const option = document.createElement('option');

                    // Handle both object format {initials, name} and string format
                    if (typeof staff === 'string') {
                        // Staff is a simple string (e.g., "CW" or "Christian Abulhawa")
                        option.value = staff;
                        option.textContent = staff;
                    } else {
                        // Staff is an object with initials and name
                        option.value = staff.initials || staff.name;
                        option.textContent = `${staff.initials} - ${staff.name}`;
                    }

                    select.appendChild(option);
                });
            } else {
                // If no staff in database, show message
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '-- Add staff in labour allocation table first --';
                option.disabled = true;
                select.appendChild(option);
            }
        }

        async function populateStaffDropdownInline() {
            const select = document.getElementById('staffMemberSelectInline');
            if (!select) return;
            select.innerHTML = '<option value="">-- Select Staff Member --</option>';

            // Load staff from database
            if (staffDatabase && staffDatabase.length > 0) {
                staffDatabase.forEach(staff => {
                    const option = document.createElement('option');

                    // Handle both object format {initials, name} and string format
                    if (typeof staff === 'string') {
                        // Staff is a simple string (e.g., "CW" or "Christian Abulhawa")
                        option.value = staff;
                        option.textContent = staff;
                    } else {
                        // Staff is an object with initials and name
                        option.value = staff.initials || staff.name;
                        option.textContent = `${staff.initials} - ${staff.name}`;
                    }

                    select.appendChild(option);
                });
            } else {
                // If no staff in database, show message
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '-- Add staff in labour allocation table first --';
                option.disabled = true;
                select.appendChild(option);
            }
        }

        function addStaffAllocation() {
            const select = document.getElementById('staffMemberSelect');
            if (!select) return;
            const staffValue = select.value;

            if (!staffValue) {
                alert('Please select a staff member');
                return;
            }

            const staffName = select.options[select.selectedIndex].text;

            // Check if staff member already added
            const existing = staffAllocations.find(s => s.staffInitials === staffValue);
            if (existing) {
                alert('This staff member is already in the list. You can edit their grant allocation below.');
                return;
            }

            // Add new staff allocation
            const newAllocation = {
                staffInitials: staffValue,
                staffName: staffName,
                grantCategory: null,
                grantItemKey: null,
                grantItemName: null,
                grantProjectId: null,
                grantProjectName: null,
                budgetAllocated: 0,
                totalClaimed: 0
            };

            staffAllocations.push(newAllocation);
            saveStaffAllocations();
            renderStaffAllocations();

            // Reset dropdown
            select.value = '';
        }

        function addStaffAllocationInline() {
            const select = document.getElementById('staffMemberSelectInline');
            if (!select) return;
            const staffValue = select.value;

            if (!staffValue) {
                alert('Please select a staff member');
                return;
            }

            const staffName = select.options[select.selectedIndex].text;

            // Check if staff member already added
            const existing = staffAllocations.find(s => s.staffInitials === staffValue);
            if (existing) {
                alert('This staff member is already in the list. You can edit their grant allocation below.');
                return;
            }

            // Add new staff allocation
            const newAllocation = {
                staffInitials: staffValue,
                staffName: staffName,
                grantCategory: null,
                grantItemKey: null,
                grantItemName: null,
                grantProjectId: null,
                grantProjectName: null,
                budgetAllocated: 0,
                totalClaimed: 0
            };

            staffAllocations.push(newAllocation);
            saveStaffAllocations();
            renderStaffAllocationsInline();

            // Reset dropdown
            select.value = '';
        }

        function renderStaffAllocations() {
            const container = document.getElementById('staffAllocationsList');
            container.innerHTML = '';

            if (staffAllocations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No staff members added yet. Add one above to get started.</p>';
                return;
            }

            staffAllocations.forEach((allocation, idx) => {
                const allocDiv = document.createElement('div');
                allocDiv.style.cssText = 'border: 1px solid #ddd; border-radius: 6px; padding: 15px; margin-bottom: 15px; background: white;';

                // Calculate total claimed from labour allocation table
                const projectKey = currentLabourBudgetProject.id || currentLabourBudgetProject.name;
                const totalClaimed = calculateTotalClaimedForStaff(allocation.staffInitials, projectKey);
                allocation.totalClaimed = totalClaimed;

                const hasGrantAssignment = allocation.grantCategory && allocation.grantItemKey;
                const budgetRemaining = allocation.budgetAllocated - totalClaimed;
                const percentageUsed = allocation.budgetAllocated > 0 ? (totalClaimed / allocation.budgetAllocated * 100).toFixed(1) : 0;

                allocDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <h4 style="margin: 0; font-size: 16px;">${allocation.staffName}</h4>
                                ${hasGrantAssignment ? `
                                    <label style="display: flex; align-items: center; gap: 5px; font-size: 11px; color: #666; cursor: pointer;">
                                        <input type="checkbox" id="showQuarterly_${idx}" onchange="toggleQuarterlyBreakdown(${idx})" style="cursor: pointer;">
                                        Show quarterly breakdown
                                    </label>
                                ` : ''}
                            </div>
                            ${hasGrantAssignment ? `
                                <div style="font-size: 12px; color: #666;">
                                    <strong>Assigned to:</strong> ${allocation.grantProjectName || 'Unknown Project'}<br>
                                    ${allocation.grantCategory} ‚Üí ${allocation.grantItemName}
                                </div>
                            ` : `
                                <div style="font-size: 12px; color: #f59e0b;">
                                    ‚ö†Ô∏è No grant item assigned yet
                                </div>
                            `}
                        </div>
                        <button onclick="removeStaffAllocation(${idx})" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
                    </div>

                    ${hasGrantAssignment ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div style="background: #e0f2fe; padding: 10px; border-radius: 4px;">
                                <div style="font-size: 11px; color: #0284c7; font-weight: 600;">BUDGET ALLOCATED</div>
                                <div style="font-size: 18px; font-weight: bold; color: #0c4a6e;">¬£${allocation.budgetAllocated.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div style="background: #fef3c7; padding: 10px; border-radius: 4px;">
                                <div style="font-size: 11px; color: #d97706; font-weight: 600;">TOTAL CLAIMED</div>
                                <div style="font-size: 18px; font-weight: bold; color: #92400e;">¬£${totalClaimed.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div style="background: ${budgetRemaining >= 0 ? '#d1fae5' : '#fee2e2'}; padding: 10px; border-radius: 4px;">
                                <div style="font-size: 11px; color: ${budgetRemaining >= 0 ? '#059669' : '#dc2626'}; font-weight: 600;">REMAINING</div>
                                <div style="font-size: 18px; font-weight: bold; color: ${budgetRemaining >= 0 ? '#065f46' : '#991b1b'};">¬£${budgetRemaining.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <div style="background: #e5e7eb; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #3b82f6, #8b5cf6); height: 100%; width: ${Math.min(percentageUsed, 100)}%; transition: width 0.3s;"></div>
                            </div>
                            <div style="font-size: 11px; color: #666; margin-top: 4px; text-align: center;">
                                ${percentageUsed}% of budget claimed
                            </div>
                        </div>
                    ` : ''}

                    ${hasGrantAssignment ? `
                        <div id="quarterlyBreakdown_${idx}" style="display: none; margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <!-- Quarterly breakdown will be inserted here -->
                        </div>
                    ` : ''}

                    <button onclick="assignGrantItem(${idx})" class="btn btn-primary" style="width: 100%; margin-top: 5px;">
                        ${hasGrantAssignment ? '‚úèÔ∏è Change Grant Assignment' : '‚ûï Assign to Grant Item'}
                    </button>
                `;

                container.appendChild(allocDiv);
            });
        }

        function renderStaffAllocationsInline() {
            const container = document.getElementById('staffAllocationsListInline');
            if (!container) return;
            container.innerHTML = '';

            if (staffAllocations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No staff members added yet. Add one above to get started.</p>';
                return;
            }

            staffAllocations.forEach((allocation, idx) => {
                const allocDiv = document.createElement('div');
                allocDiv.style.cssText = 'border: 1px solid #ddd; border-radius: 6px; padding: 15px; margin-bottom: 15px; background: white;';

                // Calculate total claimed from labour allocation table
                const projectKey = currentLabourBudgetProject.id || currentLabourBudgetProject.name;
                const totalClaimed = calculateTotalClaimedForStaff(allocation.staffInitials, projectKey);
                allocation.totalClaimed = totalClaimed;

                const hasGrantAssignment = allocation.grantCategory && allocation.grantItemKey;
                const budgetRemaining = allocation.budgetAllocated - totalClaimed;
                const percentageUsed = allocation.budgetAllocated > 0 ? (totalClaimed / allocation.budgetAllocated * 100).toFixed(1) : 0;

                allocDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <h4 style="margin: 0; font-size: 16px;">${allocation.staffName}</h4>
                                ${hasGrantAssignment ? `
                                    <label style="display: flex; align-items: center; gap: 5px; font-size: 11px; color: #666; cursor: pointer;">
                                        <input type="checkbox" id="showQuarterlyInline_${idx}" onchange="toggleQuarterlyBreakdown(${idx})" style="cursor: pointer;">
                                        Show quarterly breakdown
                                    </label>
                                ` : ''}
                            </div>
                            ${hasGrantAssignment ? `
                                <div style="font-size: 12px; color: #666;">
                                    <strong>Assigned to:</strong> ${allocation.grantProjectName || 'Unknown Project'}<br>
                                    ${allocation.grantCategory} ‚Üí ${allocation.grantItemName}
                                </div>
                            ` : `
                                <div style="font-size: 12px; color: #f59e0b;">
                                    ‚ö†Ô∏è No grant item assigned yet
                                </div>
                            `}
                        </div>
                        <button onclick="removeStaffAllocationInline(${idx})" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
                    </div>

                    ${hasGrantAssignment ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div style="background: #e0f2fe; padding: 10px; border-radius: 4px;">
                                <div style="font-size: 11px; color: #0284c7; font-weight: 600;">BUDGET ALLOCATED</div>
                                <div style="font-size: 18px; font-weight: bold; color: #0c4a6e;">¬£${allocation.budgetAllocated.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div style="background: #fef3c7; padding: 10px; border-radius: 4px;">
                                <div style="font-size: 11px; color: #d97706; font-weight: 600;">TOTAL CLAIMED</div>
                                <div style="font-size: 18px; font-weight: bold; color: #92400e;">¬£${totalClaimed.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div style="background: ${budgetRemaining >= 0 ? '#d1fae5' : '#fee2e2'}; padding: 10px; border-radius: 4px;">
                                <div style="font-size: 11px; color: ${budgetRemaining >= 0 ? '#059669' : '#dc2626'}; font-weight: 600;">REMAINING</div>
                                <div style="font-size: 18px; font-weight: bold; color: ${budgetRemaining >= 0 ? '#065f46' : '#991b1b'};">¬£${budgetRemaining.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <div style="background: #e5e7eb; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #3b82f6, #8b5cf6); height: 100%; width: ${Math.min(percentageUsed, 100)}%; transition: width 0.3s;"></div>
                            </div>
                            <div style="font-size: 11px; color: #666; margin-top: 4px; text-align: center;">
                                ${percentageUsed}% of budget claimed
                            </div>
                        </div>
                    ` : ''}

                    ${hasGrantAssignment ? `
                        <div id="quarterlyBreakdownInline_${idx}" style="display: none; margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <!-- Quarterly breakdown will be inserted here -->
                        </div>
                    ` : ''}

                    <button onclick="assignGrantItem(${idx})" class="btn btn-primary" style="width: 100%; margin-top: 5px;">
                        ${hasGrantAssignment ? '‚úèÔ∏è Change Grant Assignment' : '‚ûï Assign to Grant Item'}
                    </button>
                `;

                container.appendChild(allocDiv);
            });
        }

        function removeStaffAllocationInline(idx) {
            if (confirm(`Remove ${staffAllocations[idx].staffName} from this budget summary?`)) {
                staffAllocations.splice(idx, 1);
                saveStaffAllocations();
                renderStaffAllocationsInline();
            }
        }

        function calculateTotalClaimedForStaff(staffInitials, projectKey) {
            // Calculate total claimed from labour allocation table
            let total = 0;

            labourRows.forEach(row => {
                // Find the project column for this project (match by ID or name)
                const projectIdx = labourProjects.findIndex(p => (p.id && p.id === projectKey) || p.name === projectKey);
                if (projectIdx === -1) return;

                const projectData = row.projects[projectIdx];
                if (!projectData) return;

                // Check if this row belongs to the staff member
                // Match by staff initials (e.g., "CW", "CA") or full staff value
                if (row.staff && (row.staff === staffInitials || row.staff.startsWith(staffInitials + ' ') || row.staff.startsWith(staffInitials + '-'))) {
                    total += projectData.total || 0;
                }
            });

            return total;
        }

        async function toggleQuarterlyBreakdown(staffIdx) {
            const checkbox = document.getElementById(`showQuarterly_${staffIdx}`);
            const breakdownDiv = document.getElementById(`quarterlyBreakdown_${staffIdx}`);

            if (!checkbox || !breakdownDiv) return;

            if (checkbox.checked) {
                // Show quarterly breakdown
                breakdownDiv.style.display = 'block';
                await renderQuarterlyBreakdown(staffIdx);
            } else {
                // Hide quarterly breakdown
                breakdownDiv.style.display = 'none';
            }
        }

        async function renderQuarterlyBreakdown(staffIdx) {
            const allocation = staffAllocations[staffIdx];
            const breakdownDiv = document.getElementById(`quarterlyBreakdown_${staffIdx}`);

            if (!allocation || !breakdownDiv) return;

            // Load project data to get start date
            try {
                // Ensure database is initialized
                await initializeGrantsDB();

                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');

                // Wrap getAll() in a promise
                const allProjects = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                db.close();

                const grantProject = allProjects.find(p => p.projectId == allocation.grantProjectId);

                if (!grantProject) {
                    breakdownDiv.innerHTML = '<p style="color: #ef4444; font-size: 12px;">‚ö†Ô∏è Grant project not found</p>';
                    return;
                }

                const startMonth = grantProject.projectStartMonth || grantProject.financeSummary?.projectStartMonth;
                const startYear = grantProject.projectStartYear || grantProject.financeSummary?.projectStartYear;

                if (!startMonth || !startYear) {
                    breakdownDiv.innerHTML = '<p style="color: #ef4444; font-size: 12px;">‚ö†Ô∏è Project start date not set in grants page</p>';
                    return;
                }

                // Calculate quarterly totals
                const projectKey = currentLabourBudgetProject.id || currentLabourBudgetProject.name;
                const quarterlyData = calculateQuarterlyTotals(allocation.staffInitials, projectKey, startMonth, startYear);

                // Render quarterly breakdown table
                let html = `
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #334155;">Quarterly Breakdown</h4>
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: #e2e8f0;">
                                <th style="padding: 8px; text-align: left; border: 1px solid #cbd5e1;">Quarter</th>
                                <th style="padding: 8px; text-align: left; border: 1px solid #cbd5e1;">Period</th>
                                <th style="padding: 8px; text-align: right; border: 1px solid #cbd5e1;">Claimed</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                if (quarterlyData.length === 0) {
                    html += `
                        <tr>
                            <td colspan="3" style="padding: 15px; text-align: center; color: #94a3b8; border: 1px solid #cbd5e1;">
                                No labour allocations found for this staff member
                            </td>
                        </tr>
                    `;
                } else {
                    quarterlyData.forEach(quarter => {
                        html += `
                            <tr style="background: white;">
                                <td style="padding: 8px; border: 1px solid #cbd5e1; font-weight: 600;">Q${quarter.quarter}</td>
                                <td style="padding: 8px; border: 1px solid #cbd5e1; color: #64748b;">${quarter.period}</td>
                                <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: right; font-weight: 600; color: #0c4a6e;">
                                    ¬£${quarter.total.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                </td>
                            </tr>
                        `;
                    });

                    // Add total row
                    const grandTotal = quarterlyData.reduce((sum, q) => sum + q.total, 0);
                    html += `
                        <tr style="background: #f1f5f9; font-weight: bold;">
                            <td colspan="2" style="padding: 8px; border: 1px solid #cbd5e1;">TOTAL</td>
                            <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: right; color: #0c4a6e;">
                                ¬£${grandTotal.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                            </td>
                        </tr>
                    `;
                }

                html += `
                        </tbody>
                    </table>
                `;

                breakdownDiv.innerHTML = html;
            } catch (error) {
                console.error('Error rendering quarterly breakdown:', error);
                breakdownDiv.innerHTML = '<p style="color: #ef4444; font-size: 12px;">‚ö†Ô∏è Failed to load quarterly breakdown</p>';
            }
        }

        function calculateQuarterlyTotals(staffInitials, projectKey, startMonth, startYear) {
            // Group labour allocations by quarter
            const quarterTotals = new Map();

            labourRows.forEach(row => {
                // Check if this row belongs to the staff member
                if (!row.staff || !(row.staff === staffInitials || row.staff.startsWith(staffInitials + ' ') || row.staff.startsWith(staffInitials + '-'))) {
                    return;
                }

                // Find the project column (match by ID or name)
                const projectIdx = labourProjects.findIndex(p => (p.id && p.id === projectKey) || p.name === projectKey);
                if (projectIdx === -1) return;

                const projectData = row.projects[projectIdx];
                if (!projectData || !projectData.total) return;

                // Parse the month (YYYY-MM format)
                const monthStr = row.month;
                if (!monthStr || typeof monthStr !== 'string') return;

                const [yearStr, monthNumStr] = monthStr.split('-');
                const year = parseInt(yearStr);
                const month = parseInt(monthNumStr);

                if (isNaN(year) || isNaN(month)) return;

                // Calculate months since project start
                const monthsSinceStart = (year - startYear) * 12 + (month - startMonth);

                // Skip if before project start
                if (monthsSinceStart < 0) return;

                // Calculate quarter (1-based)
                const quarter = Math.floor(monthsSinceStart / 3) + 1;

                // Add to quarter total
                if (!quarterTotals.has(quarter)) {
                    // Calculate quarter period string
                    const quarterStartMonth = startMonth + (quarter - 1) * 3;
                    const quarterEndMonth = quarterStartMonth + 2;

                    const qStartYear = startYear + Math.floor((quarterStartMonth - 1) / 12);
                    const qStartMonth = ((quarterStartMonth - 1) % 12) + 1;
                    const qEndYear = startYear + Math.floor((quarterEndMonth - 1) / 12);
                    const qEndMonth = ((quarterEndMonth - 1) % 12) + 1;

                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const periodStr = `${monthNames[qStartMonth - 1]} ${qStartYear} - ${monthNames[qEndMonth - 1]} ${qEndYear}`;

                    quarterTotals.set(quarter, {
                        quarter: quarter,
                        period: periodStr,
                        total: 0
                    });
                }

                quarterTotals.get(quarter).total += projectData.total;
            });

            // Convert map to sorted array
            return Array.from(quarterTotals.values()).sort((a, b) => a.quarter - b.quarter);
        }

        function removeStaffAllocation(idx) {
            if (confirm(`Remove ${staffAllocations[idx].staffName} from this budget summary?`)) {
                staffAllocations.splice(idx, 1);
                saveStaffAllocations();
                renderStaffAllocations();
            }
        }

        function saveStaffAllocations() {
            if (currentLabourBudgetProject) {
                // Use project ID if available, otherwise use project name (backward compatibility)
                const projectKey = currentLabourBudgetProject.id || currentLabourBudgetProject.name;
                localStorage.setItem(
                    `labour_budget_allocations_${projectKey}`,
                    JSON.stringify(staffAllocations)
                );
            }
        }

        // ============================================
        // GRANT ITEM SELECTION (Similar to Spend Assignment)
        // ============================================

        async function assignGrantItem(staffIdx) {
            selectedStaffMember = staffAllocations[staffIdx];
            labourBudgetStep = 1;

            showToast('Loading grants data...', 'info');

            // Try to load grants - auto-sync from Supabase if needed
            try {
                const allProjects = await loadGrantsData();

                if (!allProjects || allProjects.length === 0) {
                    alert('‚ö†Ô∏è No grants found.\n\nPlease add grant projects in grants.html first, or check your cloud sync.');
                    return;
                }

                // Show project selection
                showGrantProjectSelection(allProjects);
                showToast(`Loaded ${allProjects.length} grant project(s)`, 'success');
            } catch (error) {
                console.error('Error loading grants:', error);
                alert('‚ö†Ô∏è Failed to load grants data.\n\nError: ' + error.message + '\n\nPlease check your internet connection and try again.');
            }
        }

        // Centralized function to load grants from Supabase + IndexedDB
        async function loadGrantsData() {
            console.log('[GRANTS SYNC] Loading grants data...');

            // Step 1: Ensure database is initialized
            await initializeGrantsDB();

            // Step 2: Try IndexedDB first (fast local cache)
            try {
                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');

                // Wrap getAll() in a promise
                const localProjects = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                db.close();

                if (localProjects && localProjects.length > 0) {
                    console.log(`[GRANTS SYNC] Found ${localProjects.length} projects in IndexedDB`);

                    // Also sync from Supabase in background (don't wait)
                    syncGrantsFromSupabase().catch(err => console.warn('[GRANTS SYNC] Background sync failed:', err));

                    return localProjects;
                }
            } catch (error) {
                console.warn('[GRANTS SYNC] IndexedDB read failed:', error);
            }

            // Step 3: IndexedDB empty or failed - fetch from Supabase
            console.log('[GRANTS SYNC] IndexedDB empty, fetching from Supabase...');
            return await syncGrantsFromSupabase();
        }

        // Fetch grants from Supabase and populate IndexedDB
        async function syncGrantsFromSupabase() {
            console.log('[GRANTS SYNC] Syncing from Supabase...');

            try {
                await ensureAuthenticated();

                // Fetch all grants from Supabase
                const { data: grantsData, error } = await supabaseClient
                    .from('grants')
                    .select('*')
                    .eq('user_id', currentUser.id);

                if (error) {
                    console.error('[GRANTS SYNC] Supabase error:', error);
                    throw new Error('Failed to fetch grants from cloud: ' + error.message);
                }

                if (!grantsData || grantsData.length === 0) {
                    console.log('[GRANTS SYNC] No grants found in Supabase');
                    return [];
                }

                console.log(`[GRANTS SYNC] Found ${grantsData.length} grants in Supabase`);

                // Parse and populate IndexedDB
                const projects = grantsData.map(grant => grant.project_data);

                // Create/update IndexedDB
                const db = await initializeGrantsDB();
                const tx = db.transaction('projects', 'readwrite');
                const store = tx.objectStore('projects');

                // Clear existing data
                await store.clear();

                // Add all projects
                for (const project of projects) {
                    await store.put(project);
                }

                await tx.complete;
                db.close();
                console.log(`[GRANTS SYNC] ‚úÖ Synced ${projects.length} projects to IndexedDB`);

                // Refresh budget project dropdown
                populateBudgetProjectDropdown();

                return projects;

            } catch (error) {
                console.error('[GRANTS SYNC] Sync failed:', error);
                throw error;
            }
        }

        // Initialize GrantsDB if it doesn't exist
        async function initializeGrantsDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('GrantsDB', 2);

                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };

                request.onerror = function(event) {
                    reject(new Error('Failed to open GrantsDB: ' + event.target.error));
                };

                request.onupgradeneeded = function(event) {
                    const db = event.target.result;

                    // Create projects object store if it doesn't exist
                    if (!db.objectStoreNames.contains('projects')) {
                        const objectStore = db.createObjectStore('projects', { keyPath: 'projectId' });
                        objectStore.createIndex('projectName', 'projectName', { unique: false });
                        console.log('[GRANTS SYNC] Created projects object store');
                    }
                };
            });
        }

        // Helper function to check if GrantsDB exists
        async function checkGrantsDBExists() {
            return new Promise((resolve) => {
                const request = indexedDB.open('GrantsDB', 2);

                request.onsuccess = function(event) {
                    const db = event.target.result;
                    // Check if the 'projects' object store exists
                    const hasProjectsStore = db.objectStoreNames.contains('projects');
                    db.close();
                    resolve(hasProjectsStore);
                };

                request.onerror = function() {
                    resolve(false);
                };

                request.onupgradeneeded = function(event) {
                    // Database doesn't exist yet - create object store
                    const db = event.target.result;

                    if (!db.objectStoreNames.contains('projects')) {
                        const objectStore = db.createObjectStore('projects', { keyPath: 'projectId' });
                        objectStore.createIndex('projectName', 'projectName', { unique: false });
                        console.log('[GRANTS SYNC] Created projects object store in checkGrantsDBExists');
                    }
                    // Don't close here - let onsuccess handle it
                    // Will resolve false since we just created it (was empty before)
                };
            });
        }

        function showGrantProjectSelection(projects) {
            labourBudgetStep = 1;

            let content = `
                <div style="margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 16px;">Assigning: ${selectedStaffMember.staffName}</h3>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Step 1: Select Grant Project</div>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;

            projects.forEach(project => {
                const projectName = project.projectName || project.projectNumber || `Project ${project.projectId}`;
                content += `
                    <div onclick="selectGrantProject('${project.projectId}')"
                         style="padding: 12px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s;"
                         onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#3b82f6';"
                         onmouseout="this.style.background='white'; this.style.borderColor='#ddd';">
                        <div style="font-weight: 600; font-size: 14px; color: #1e293b;">${projectName}</div>
                        <div style="font-size: 12px; color: #64748b;">Project ID: ${project.projectId}</div>
                    </div>
                `;
            });

            content += '</div>';

            // Replace the staff allocations list with the grant selection UI
            document.getElementById('staffAllocationsListInline').innerHTML = `
                <div style="border: 1px solid #3b82f6; border-radius: 6px; padding: 15px; background: #f8fafc;">
                    <button onclick="cancelGrantSelection()" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 12px; margin-bottom: 15px;">‚Üê Back to Budget Summary</button>
                    ${content}
                </div>
            `;
        }

        async function selectGrantProject(projectId) {
            selectedProjectForBudget = projectId;
            labourBudgetStep = 2;

            // Load project data from IndexedDB
            try {
                // Ensure database is initialized
                await initializeGrantsDB();

                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');

                // Wrap getAll() in a promise
                const allProjects = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                db.close();

                const project = allProjects.find(p => p.projectId == projectId);

                if (!project) {
                    alert('Project not found');
                    return;
                }

                showLabourBudgetTable(project);
            } catch (error) {
                console.error('Error loading project:', error);
                alert('Failed to load project data');
            }
        }

        function showLabourBudgetTable(project, editMode = false) {
            const projectName = project.projectName || project.projectNumber || `Project ${project.projectId}`;

            // Get existing labour budget items (or initialize empty array)
            if (!project.labourBudgetItems) {
                project.labourBudgetItems = [];
            }

            // Determine if we should show display mode or edit mode
            const hasItems = project.labourBudgetItems.length > 0;
            const showDisplayMode = hasItems && !editMode;

            let content = '';

            if (showDisplayMode) {
                // DISPLAY MODE: Show saved budget items with assign buttons
                content = `
                    <div style="margin-bottom: 15px;">
                        <button onclick="assignGrantItem(${staffAllocations.indexOf(selectedStaffMember)})" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 12px;">‚Üê Back to Projects</button>
                        <h3 style="margin: 5px 0 0 0; font-size: 16px;">Labour Budget: ${projectName}</h3>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Saved labour budget items</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        ${project.labourBudgetItems.map((item, idx) => {
                            const hours = item.totalHours || (item.days || 0) * 8;
                            const hrsPerDay = item.hrsPerDay || 8;
                            const total = (item.dayRate || 0) * (item.days || 0);
                            const hoursSource = item.totalHours ? `(${item.totalHours}hrs √∑ ${hrsPerDay}hrs/day)` : '(estimated at 8hrs/day)';
                            return `
                                <div style="padding: 12px; margin-bottom: 10px; background: white; border: 1px solid #e2e8f0; border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-size: 14px; color: #1e293b; margin-bottom: 4px;">${item.role || 'Unnamed Role'}</div>
                                            <div style="font-size: 12px; color: #64748b; line-height: 1.5;">
                                                The application details show a total of <strong>${hours} Hours</strong> for the ${item.role || 'role'},
                                                calculated as <strong>${item.days} days</strong> ${hoursSource} at a rate of <strong>¬£${item.dayRate ? item.dayRate.toFixed(2) : '0.00'} per day</strong>
                                                (¬£${item.hourlyRate ? item.hourlyRate.toFixed(2) : '0.00'}/hr).
                                                Total budget: <strong>¬£${total.toLocaleString()}</strong>
                                            </div>
                                        </div>
                                        <button onclick="showStaffAssignmentForBudgetItem(${idx})"
                                                style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap; margin-left: 12px;">
                                            Assign
                                        </button>
                                    </div>
                                    <div id="staffAssignment_${idx}" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #e2e8f0;">
                                        <!-- Staff assignment dropdown will appear here -->
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button onclick="showLabourBudgetTable(window.currentEditingGrantProject, true)"
                                style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            ‚úèÔ∏è Edit Budget
                        </button>
                    </div>
                `;

            } else {
                // EDIT MODE: Show editable table
                let tableRows = '';
                project.labourBudgetItems.forEach((item, idx) => {
                    // Ensure hourlyRate is calculated if not set
                    if (!item.hourlyRate && item.dayRate) {
                        item.hourlyRate = item.dayRate / 8;
                    }

                    tableRows += `
                        <tr>
                            <td><input type="text" value="${item.role || ''}" onchange="updateLabourBudgetItem(${idx}, 'role', this.value)" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"></td>
                            <td><input type="number" step="0.01" value="${item.hourlyRate || ''}" onchange="updateLabourBudgetItem(${idx}, 'hourlyRate', this.value)" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"></td>
                            <td><input type="number" step="0.01" value="${item.dayRate || ''}" onchange="updateLabourBudgetItem(${idx}, 'dayRate', this.value)" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"></td>
                            <td style="padding: 8px; border: 1px solid #e2e8f0;">
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <input type="number" id="inlineBudgetDaysInput_${idx}" value="${item.days || ''}" onchange="updateLabourBudgetItem(${idx}, 'days', this.value); clearInlineHoursCalculation(${idx});" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                    <button onclick="toggleInlineHoursCalculator(${idx})"
                                            title="Calculate days from hours"
                                            style="background: ${item.totalHours ? '#10b981' : '#3b82f6'}; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                        ‚è±Ô∏è
                                    </button>
                                </div>
                                ${item.totalHours ? `<div style="font-size: 10px; color: #059669; margin-top: 4px;">${item.totalHours}hrs √∑ ${item.hrsPerDay || 7.5}hrs/day</div>` : ''}
                                <div id="inlineHoursCalculator_${idx}" style="display: none; margin-top: 8px; padding: 10px; background: #f1f5f9; border-radius: 6px; border: 1px solid #cbd5e1;">
                                    <div style="font-size: 11px; font-weight: 600; color: #475569; margin-bottom: 6px;">Calculate Days from Hours</div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px;">
                                        <div>
                                            <label style="font-size: 10px; color: #64748b;">Total Hours</label>
                                            <input type="number" step="0.5" id="inlineTotalHours_${idx}"
                                                   oninput="calculateInlineDaysFromHours(${idx})"
                                                   placeholder="0"
                                                   value="${item.totalHours || ''}"
                                                   style="width: 100%; padding: 4px 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px;">
                                        </div>
                                        <div>
                                            <label style="font-size: 10px; color: #64748b;">Hrs/Day</label>
                                            <input type="number" step="0.5" id="inlineHrsPerDay_${idx}"
                                                   oninput="calculateInlineDaysFromHours(${idx})"
                                                   placeholder="7.5"
                                                   value="${item.hrsPerDay || 7.5}"
                                                   style="width: 100%; padding: 4px 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px;">
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 6px;">
                                        <span id="inlineCalculatedDays_${idx}" style="font-size: 12px; color: #059669; font-weight: 600;">= ${item.days || 0} days</span>
                                        <button onclick="applyInlineCalculatedDays(${idx})"
                                                style="background: #10b981; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                            Apply
                                        </button>
                                    </div>
                                </div>
                            </td>
                            <td style="text-align: right; font-weight: 600;">¬£${((item.dayRate || 0) * (item.days || 0)).toLocaleString()}</td>
                            <td style="text-align: center;"><button onclick="removeLabourBudgetItem(${idx})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">√ó</button></td>
                        </tr>
                    `;
                });

                content = `
                    <div style="margin-bottom: 15px;">
                        <button onclick="assignGrantItem(${staffAllocations.indexOf(selectedStaffMember)})" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 12px;">‚Üê Back to Projects</button>
                        <h3 style="margin: 5px 0 0 0; font-size: 16px;">Labour Budget: ${projectName}</h3>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Define labour budget items for this project</div>
                    </div>

                    <div style="overflow-x: auto; margin-bottom: 15px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8fafc;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e2e8f0; font-size: 13px;">Role</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e2e8f0; font-size: 13px;">Hourly Rate (¬£/hr)</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e2e8f0; font-size: 13px;">Day Rate (¬£/day)</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e2e8f0; font-size: 13px;">Number of Days</th>
                                    <th style="padding: 8px; text-align: right; border: 1px solid #e2e8f0; font-size: 13px;">Total</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e2e8f0; font-size: 13px; width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody id="labourBudgetTableBody">
                                ${tableRows || '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">No budget items yet. Click "Add Row" below to get started.</td></tr>'}
                            </tbody>
                        </table>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button onclick="addLabourBudgetRow()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">+ Add Row</button>
                        <button onclick="saveLabourBudgetToProject()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">üíæ Save to Project</button>
                        ${hasItems ? '<button onclick="showLabourBudgetTable(window.currentEditingGrantProject, false)" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">Cancel</button>' : ''}
                    </div>
                `;
            }

            document.getElementById('staffAllocationsListInline').innerHTML = `
                <div style="border: 1px solid #3b82f6; border-radius: 6px; padding: 15px; background: #f8fafc;">
                    ${content}
                </div>
            `;

            // Store current project in memory for editing
            window.currentEditingGrantProject = project;
        }

        function addLabourBudgetRow() {
            if (!window.currentEditingGrantProject.labourBudgetItems) {
                window.currentEditingGrantProject.labourBudgetItems = [];
            }

            window.currentEditingGrantProject.labourBudgetItems.push({
                role: '',
                hourlyRate: 0,
                dayRate: 0,
                days: 0
            });

            showLabourBudgetTable(window.currentEditingGrantProject, true);
        }

        function updateLabourBudgetItem(idx, field, value) {
            if (window.currentEditingGrantProject && window.currentEditingGrantProject.labourBudgetItems[idx]) {
                const item = window.currentEditingGrantProject.labourBudgetItems[idx];

                if (field === 'role') {
                    item[field] = value;
                } else if (field === 'hourlyRate') {
                    // User changed hourly rate ‚Üí calculate day rate (8-hour workday)
                    item.hourlyRate = parseFloat(value) || 0;
                    item.dayRate = item.hourlyRate * 8;
                } else if (field === 'dayRate') {
                    // User changed day rate ‚Üí calculate hourly rate
                    item.dayRate = parseFloat(value) || 0;
                    item.hourlyRate = item.dayRate / 8;
                } else {
                    item[field] = parseFloat(value) || 0;
                }

                // Refresh the table in edit mode to update totals
                showLabourBudgetTable(window.currentEditingGrantProject, true);
            }
        }

        function removeLabourBudgetItem(idx) {
            if (window.currentEditingGrantProject && window.currentEditingGrantProject.labourBudgetItems) {
                window.currentEditingGrantProject.labourBudgetItems.splice(idx, 1);
                showLabourBudgetTable(window.currentEditingGrantProject, true);
            }
        }

        function showStaffAssignmentForBudgetItem(itemIdx) {
            const container = document.getElementById(`staffAssignment_${itemIdx}`);

            if (!container) return;

            // Toggle visibility
            if (container.style.display === 'none' || container.style.display === '') {
                // Show the staff assignment section
                const item = window.currentEditingGrantProject.labourBudgetItems[itemIdx];

                // Get available staff
                const availableStaff = window.staffDatabase || [];

                if (availableStaff.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 10px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 4px; font-size: 12px; color: #92400e;">
                            No staff members found. Please add staff in the labour allocation table first.
                        </div>
                    `;
                    container.style.display = 'block';
                    return;
                }

                container.innerHTML = `
                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px; color: #1e293b;">
                        Assign to Staff Member
                    </div>

                    ${availableStaff.map((staff, staffIdx) => {
                        const staffInitials = staff.initials || staff;
                        const staffName = staff.name || staff;

                        return `
                            <div style="display: flex; align-items: center; gap: 10px; padding: 8px; margin-bottom: 6px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 12px;">${staffInitials} - ${staffName}</div>
                                </div>
                                <input type="number"
                                       id="assignAmount_${itemIdx}_${staffIdx}"
                                       placeholder="Amount ¬£"
                                       step="0.01"
                                       style="width: 120px; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px;" />
                                <button onclick="confirmStaffAssignment(${itemIdx}, '${staffInitials}', '${staffName}')"
                                        style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">
                                    Assign
                                </button>
                            </div>
                        `;
                    }).join('')}

                    <button onclick="document.getElementById('staffAssignment_${itemIdx}').style.display='none'"
                            style="background: #64748b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 8px;">
                        Cancel
                    </button>
                `;

                container.style.display = 'block';
            } else {
                // Hide the section
                container.style.display = 'none';
            }
        }

        function confirmStaffAssignment(itemIdx, staffInitials, staffName) {
            const item = window.currentEditingGrantProject.labourBudgetItems[itemIdx];

            // Find the input for this staff member
            const inputs = document.querySelectorAll(`[id^="assignAmount_${itemIdx}_"]`);
            let assignedAmount = 0;

            for (let input of inputs) {
                if (input.value) {
                    assignedAmount = parseFloat(input.value);
                    break;
                }
            }

            if (!assignedAmount || assignedAmount <= 0) {
                alert('Please enter a valid amount to assign');
                return;
            }

            const budgetAllocated = assignedAmount;

            // Find the staff member in staffAllocations or create new one
            let staffMember = staffAllocations.find(s => s.staffInitials === staffInitials);

            if (!staffMember) {
                // Create new staff allocation entry
                staffMember = {
                    staffInitials: staffInitials,
                    staffName: staffName,
                    grantProjectId: window.currentEditingGrantProject.projectId,
                    grantProjectName: window.currentEditingGrantProject.projectName || window.currentEditingGrantProject.projectNumber || `Project ${window.currentEditingGrantProject.projectId}`,
                    grantRole: item.role,
                    grantHourlyRate: item.hourlyRate,
                    grantDayRate: item.dayRate,
                    grantDays: item.days,
                    budgetAllocated: budgetAllocated,
                    totalClaimed: 0
                };

                staffAllocations.push(staffMember);
            } else {
                // Update existing allocation
                staffMember.grantProjectId = window.currentEditingGrantProject.projectId;
                staffMember.grantProjectName = window.currentEditingGrantProject.projectName || window.currentEditingGrantProject.projectNumber || `Project ${window.currentEditingGrantProject.projectId}`;
                staffMember.grantRole = item.role;
                staffMember.grantHourlyRate = item.hourlyRate;
                staffMember.grantDayRate = item.dayRate;
                staffMember.grantDays = item.days;
                staffMember.budgetAllocated = budgetAllocated;
            }

            // Save allocations
            saveStaffAllocations();

            // Show success and hide assignment section
            showToast(`‚úÖ Assigned ¬£${budgetAllocated.toLocaleString()} to ${staffName} (${item.role})`, 'success');
            document.getElementById(`staffAssignment_${itemIdx}`).style.display = 'none';

            // Optionally refresh the display
            renderStaffAllocationsInline();
        }

        async function saveLabourBudgetToProject() {
            if (!window.currentEditingGrantProject) {
                alert('No project data to save');
                return;
            }

            try {
                showToast('Saving labour budget...', 'info');

                // Save to IndexedDB
                await initializeGrantsDB();
                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readwrite');
                const store = tx.objectStore('projects');

                await new Promise((resolve, reject) => {
                    const request = store.put(window.currentEditingGrantProject);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });

                db.close();

                // Also save to Supabase
                await ensureAuthenticated();
                const { error } = await supabaseClient
                    .from('grants')
                    .upsert({
                        user_id: currentUser.id,
                        project_id: String(window.currentEditingGrantProject.projectId),
                        project_data: window.currentEditingGrantProject
                    }, {
                        onConflict: 'user_id,project_id'
                    });

                if (error) {
                    console.error('Failed to save to Supabase:', error);
                    showToast('‚ö†Ô∏è Saved locally, but cloud sync failed', 'warning');
                } else {
                    showToast('‚úÖ Labour budget saved to project', 'success');
                }

                // Refresh the display
                showLabourBudgetTable(window.currentEditingGrantProject);

            } catch (error) {
                console.error('Error saving labour budget:', error);
                alert('Failed to save labour budget: ' + error.message);
            }
        }

        function assignLabourBudgetItemToEmployee(itemIdx) {
            const project = window.currentEditingGrantProject;
            const item = project.labourBudgetItems[itemIdx];

            if (!item || !item.role) {
                alert('Invalid budget item');
                return;
            }

            const budgetAllocated = (item.dayRate || 0) * (item.days || 0);

            // Update the staff member allocation
            selectedStaffMember.grantProjectId = project.projectId;
            selectedStaffMember.grantProjectName = project.projectName || project.projectNumber || `Project ${project.projectId}`;
            selectedStaffMember.grantRole = item.role;
            selectedStaffMember.grantHourlyRate = item.hourlyRate;
            selectedStaffMember.grantDayRate = item.dayRate;
            selectedStaffMember.grantDays = item.days;
            selectedStaffMember.budgetAllocated = budgetAllocated;

            // Calculate total claimed from labour table
            const projectKey = currentLabourBudgetProject.id || currentLabourBudgetProject.name;
            selectedStaffMember.totalClaimed = calculateTotalClaimedForStaff(selectedStaffMember.staffInitials, projectKey);

            // Save allocations
            saveStaffAllocations();

            // Show success and go back to budget summary
            showToast(`‚úÖ Assigned ${item.role} to ${selectedStaffMember.staffName}`, 'success');

            // Reset and show budget summary
            labourBudgetStep = 1;
            selectedProjectForBudget = null;
            window.currentEditingGrantProject = null;
            renderStaffAllocationsInline();
        }

        function showGrantCategorySelection(project) {
            const projectName = project.projectName || project.projectNumber || `Project ${project.projectId}`;

            let content = `
                <div style="margin-bottom: 15px;">
                    <button onclick="assignGrantItem(${staffAllocations.indexOf(selectedStaffMember)})" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 12px;">‚Üê Back to Projects</button>
                    <h3 style="margin: 5px 0 0 0; font-size: 16px;">Assigning: ${selectedStaffMember.staffName}</h3>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">${projectName} ‚Ä¢ Step 2: Select Category</div>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;

            // Get all categories from the project (same logic as spend.html)
            const categories = [];

            // IUK Categories
            if (project.labour) categories.push({ name: 'Labour', data: project.labour });
            if (project.materials) categories.push({ name: 'Materials', data: project.materials });
            if (project.capitalUsage) categories.push({ name: 'Capital Usage', data: project.capitalUsage });
            if (project.subcontracting) categories.push({ name: 'Subcontracting', data: project.subcontracting });
            if (project.travel) categories.push({ name: 'Travel', data: project.travel });
            if (project.otherCosts) categories.push({ name: 'Other Costs', data: project.otherCosts });

            // Welsh Gov Categories
            if (project.capitalNonStandard) categories.push({ name: 'Capital Non-Standard', data: project.capitalNonStandard });
            if (project.revenueNonStandard) categories.push({ name: 'Revenue Non-Standard', data: project.revenueNonStandard });
            if (project.revenueStandard) categories.push({ name: 'Revenue Standard', data: project.revenueStandard });
            if (project.itemBreakdownCapital) categories.push({ name: 'Item Breakdown Capital', data: project.itemBreakdownCapital });
            if (project.itemBreakdownRevenue) categories.push({ name: 'Item Breakdown Revenue', data: project.itemBreakdownRevenue });

            categories.forEach(cat => {
                content += `
                    <div onclick="selectGrantCategory('${cat.name}')"
                         style="padding: 12px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s;"
                         onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#3b82f6';"
                         onmouseout="this.style.background='white'; this.style.borderColor='#ddd';">
                        <div style="font-weight: 600; font-size: 14px; color: #1e293b;">${cat.name}</div>
                    </div>
                `;
            });

            content += '</div>';

            document.getElementById('staffAllocationsListInline').innerHTML = `
                <div style="border: 1px solid #3b82f6; border-radius: 6px; padding: 15px; background: #f8fafc;">
                    <button onclick="cancelGrantSelection()" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 12px; margin-bottom: 15px;">‚Üê Cancel</button>
                    ${content}
                </div>
            `;
        }

        async function selectGrantCategory(categoryName) {
            selectedCategoryForBudget = categoryName;
            labourBudgetStep = 3;

            // Load project data
            try {
                // Ensure database is initialized
                await initializeGrantsDB();

                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');

                // Wrap getAll() in a promise
                const allProjects = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                db.close();

                const project = allProjects.find(p => p.projectId == selectedProjectForBudget);

                if (!project) {
                    alert('Project not found');
                    return;
                }

                showGrantItemSelection(project, categoryName);
            } catch (error) {
                console.error('Error loading project:', error);
                alert('Failed to load project data');
            }
        }

        function showGrantItemSelection(project, categoryName) {
            const projectName = project.projectName || project.projectNumber || `Project ${project.projectId}`;
            const category = getCategoryObject(project, categoryName);

            if (!category) {
                alert('Category not found');
                return;
            }

            let content = `
                <div style="margin-bottom: 15px;">
                    <button onclick="selectGrantProject('${project.projectId}')" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 12px;">‚Üê Back to Categories</button>
                    <h3 style="margin: 5px 0 0 0; font-size: 16px;">Assigning: ${selectedStaffMember.staffName}</h3>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">${projectName} ‚Ä¢ ${categoryName} ‚Ä¢ Step 3: Select Item</div>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;

            // Get items based on category (same logic as spend.html)
            let items = [];
            let itemPrefix = '';

            // IUK Categories
            if (categoryName === 'Labour' && category.staff) {
                items = category.staff;
                itemPrefix = 'labour';
            } else if (categoryName === 'Materials' && category.items) {
                items = category.items;
                itemPrefix = 'materials';
            } else if (categoryName === 'Capital Usage' && category.items) {
                items = category.items;
                itemPrefix = 'capitalUsage';
            } else if (categoryName === 'Subcontracting' && category.contractors) {
                items = category.contractors;
                itemPrefix = 'subcontracting';
            } else if (categoryName === 'Travel' && category.trips) {
                items = category.trips;
                itemPrefix = 'travel';
            } else if (categoryName === 'Other Costs' && category.items) {
                items = category.items;
                itemPrefix = 'otherCosts';
            }
            // Welsh Gov Categories
            else if (categoryName === 'Capital Non-Standard' && category.items) {
                items = category.items;
                itemPrefix = 'capitalNonStandard';
            } else if (categoryName === 'Revenue Non-Standard' && category.items) {
                items = category.items;
                itemPrefix = 'revenueNonStandard';
            } else if (categoryName === 'Revenue Standard' && category.items) {
                items = category.items;
                itemPrefix = 'revenueStandard';
            } else if (categoryName === 'Item Breakdown Capital' && category.items) {
                items = category.items;
                itemPrefix = 'itemBreakdownCapital';
            } else if (categoryName === 'Item Breakdown Revenue' && category.items) {
                items = category.items;
                itemPrefix = 'itemBreakdownRevenue';
            }

            if (items && items.length > 0) {
                items.forEach((item, idx) => {
                    const itemKey = `${itemPrefix}-${idx}`;
                    let itemName = '';
                    let itemBudget = 0;

                    // Get item name and budget based on category type
                    if (categoryName === 'Labour') {
                        itemName = item.name;
                        itemBudget = item.salary || 0;
                    } else if (categoryName === 'Materials') {
                        itemName = item.item;
                        itemBudget = item.total || 0;
                    } else if (categoryName === 'Capital Usage') {
                        itemName = item.description;
                        itemBudget = item.netCost || 0;
                    } else if (categoryName === 'Subcontracting') {
                        itemName = item.name;
                        itemBudget = item.cost || 0;
                    } else if (categoryName === 'Travel') {
                        itemName = item.purpose;
                        itemBudget = item.total || 0;
                    } else if (categoryName === 'Other Costs') {
                        itemName = item.description;
                        itemBudget = item.estimatedCost || 0;
                    } else {
                        // Welsh Gov items
                        itemName = item.name || item.item || item.description || 'Unnamed Item';
                        itemBudget = item.total || item.cost || item.amount || 0;
                    }

                    content += `
                        <div onclick="selectGrantItem('${itemKey}', '${itemName.replace(/'/g, "\\'")}', ${itemBudget})"
                             style="padding: 12px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s;"
                             onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#3b82f6';"
                             onmouseout="this.style.background='white'; this.style.borderColor='#ddd';">
                            <div style="font-weight: 600; font-size: 14px; color: #1e293b;">${itemName}</div>
                            <div style="font-size: 12px; color: #64748b;">Budget: ¬£${itemBudget.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        </div>
                    `;
                });
            } else {
                content += '<p style="text-align: center; color: #999; padding: 20px;">No items found in this category</p>';
            }

            content += '</div>';

            document.getElementById('staffAllocationsListInline').innerHTML = `
                <div style="border: 1px solid #3b82f6; border-radius: 6px; padding: 15px; background: #f8fafc;">
                    <button onclick="cancelGrantSelection()" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 12px; margin-bottom: 15px;">‚Üê Cancel</button>
                    ${content}
                </div>
            `;
        }

        async function selectGrantItem(itemKey, itemName, itemBudget) {
            // Load project name for display
            try {
                // Ensure database is initialized
                await initializeGrantsDB();

                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');

                // Wrap getAll() in a promise
                const allProjects = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                db.close();

                const project = allProjects.find(p => p.projectId == selectedProjectForBudget);
                const projectName = project ? (project.projectName || project.projectNumber || `Project ${project.projectId}`) : 'Unknown Project';

                // Update the selected staff member's allocation
                selectedStaffMember.grantCategory = selectedCategoryForBudget;
                selectedStaffMember.grantItemKey = itemKey;
                selectedStaffMember.grantItemName = itemName;
                selectedStaffMember.grantProjectId = selectedProjectForBudget;
                selectedStaffMember.grantProjectName = projectName;
                selectedStaffMember.budgetAllocated = itemBudget;

                saveStaffAllocations();

                // Check which container is visible and render appropriately
                const inlineContainer = document.getElementById('staffAllocationsListInline');
                if (inlineContainer && inlineContainer.closest('#labourBudgetSection').style.display !== 'none') {
                    renderStaffAllocationsInline();
                } else {
                    renderStaffAllocations();
                }

                // Show success message
                showToast(`‚úÖ Assigned ${selectedStaffMember.staffName} to ${itemName} (Budget: ¬£${itemBudget.toLocaleString('en-GB')})`, 'success');
            } catch (error) {
                console.error('Error saving grant assignment:', error);
                alert('Failed to save grant assignment');
            }
        }

        function cancelGrantSelection() {
            labourBudgetStep = 1;
            selectedStaffMember = null;
            selectedProjectForBudget = null;
            selectedCategoryForBudget = null;

            // Check which container is visible and render appropriately
            const inlineContainer = document.getElementById('staffAllocationsListInline');
            const modalContainer = document.getElementById('staffAllocationsList');

            if (inlineContainer && inlineContainer.closest('#labourBudgetSection').style.display !== 'none') {
                renderStaffAllocationsInline();
            } else {
                renderStaffAllocations();
            }
        }

        function getCategoryObject(project, categoryName) {
            const categoryMap = {
                'Labour': 'labour',
                'Materials': 'materials',
                'Capital Usage': 'capitalUsage',
                'Subcontracting': 'subcontracting',
                'Travel': 'travel',
                'Other Costs': 'otherCosts',
                'Capital Non-Standard': 'capitalNonStandard',
                'Revenue Non-Standard': 'revenueNonStandard',
                'Revenue Standard': 'revenueStandard',
                'Item Breakdown Capital': 'itemBreakdownCapital',
                'Item Breakdown Revenue': 'itemBreakdownRevenue'
            };

            const key = categoryMap[categoryName];
            return key ? project[key] : null;
        }

        // Helper function to open IndexedDB
        function openDB(dbName, version) {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, version);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);

                // Handle database upgrade for GrantsDB
                request.onupgradeneeded = (event) => {
                    if (dbName === 'GrantsDB') {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('projects')) {
                            const objectStore = db.createObjectStore('projects', { keyPath: 'projectId' });
                            objectStore.createIndex('projectName', 'projectName', { unique: false });
                            console.log('[GRANTS SYNC] Created projects object store in openDB');
                        }
                    }
                };
            });
        }

        function loadHistory(index) {
            const history = JSON.parse(localStorage.getItem('timesheetHistory') || '[]');
            if (history[index]) {
                timesheetData = history[index].data;
                displayTimesheetOutput();
                closeHistory();
                showToast('Loaded generation from history', 'success');
            }
        }

        function deleteHistory(index) {
            const history = JSON.parse(localStorage.getItem('timesheetHistory') || '[]');
            history.splice(index, 1);
            localStorage.setItem('timesheetHistory', JSON.stringify(history));
            showHistory(); // Refresh
        }

        // ============================================
        // LABOUR ALLOCATION FUNCTIONALITY
        // ============================================

        let labourProjects = [];
        let labourRows = [];
        let hiddenProjects = new Set(); // Track which projects are hidden
        let staffDatabase = []; // Staff members list
        let workingDaysPerYear = 224; // Configurable days per year for ¬£/day calculation
        let hoursPerDay = 8; // Configurable hours per day for ¬£/hr calculation

        // Migrate old projects to add IDs and grant fields (backward compatibility)
        function migrateProjectIds() {
            let needsSave = false;
            labourProjects.forEach(project => {
                // Add ID if missing
                if (!project.id) {
                    project.id = Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);
                    needsSave = true;
                    console.log('[MIGRATION] Added ID to project:', project.name, '‚Üí', project.id);
                }

                // Add grant fields if missing (for backward compatibility)
                if (project.grantProjectId === undefined) {
                    project.grantProjectId = null;
                    project.grantProjectNumber = null;
                    project.linkedAt = null;
                    needsSave = true;
                    console.log('[MIGRATION] Added grant fields to project:', project.name);
                }
            });
            if (needsSave) {
                saveLabourData();
                console.log('[MIGRATION] Projects migrated and saved');
            }
        }

        // Initialize labour allocation on page load
        async function initLabourAllocation() {
            // Try to load from cloud/localStorage first
            try {
                await ensureAuthenticated();

                // Check if we have saved data in Supabase or localStorage
                const { data: supabaseData } = await supabaseClient
                    .from('labour_allocation')
                    .select('allocation_data')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                const hasSupabaseData = supabaseData && supabaseData.allocation_data;
                const hasLocalData = localStorage.getItem('labour_allocation_data');

                if (hasSupabaseData || hasLocalData) {
                    // Load existing data
                    await loadLabourData();
                    return;
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Error checking for saved data:', error);
            }

            // Initialize with empty projects (fresh start)
            labourProjects = [];

            renderLabourTable();
            console.log('‚ú® Initialized labour allocation with empty projects (use "Link Grant" to add projects)');
        }

        // Render the entire labour table
        function renderLabourTable() {
            renderProjectHeaders();
            renderLabourRows();
            applyMonthStates(); // Apply month visibility states
        }

        // Render project headers
        function renderProjectHeaders() {
            const columnLetterRow = document.getElementById('columnLetterRow');
            const projectHeaderRow = document.getElementById('projectHeaderRow');
            const columnHeaderRow = document.getElementById('columnHeaderRow');

            // Remove existing project headers
            // Keep: empty, A, B, C, D, E, F, G, H = 9 fixed column letters
            while (columnLetterRow.children.length > 9) {
                columnLetterRow.removeChild(columnLetterRow.lastChild);
            }
            // Keep: drag handle, Month, Staff, Payslip = 4 fixed project headers
            while (projectHeaderRow.children.length > 4) {
                projectHeaderRow.removeChild(projectHeaderRow.lastChild);
            }
            // Keep: Gross, FTE, ¬£/yr full time, ¬£/yr as paid, ¬£/day, ¬£/hr = 6 fixed column headers
            while (columnHeaderRow.children.length > 6) {
                columnHeaderRow.removeChild(columnHeaderRow.lastChild);
            }

            // Add project headers
            labourProjects.forEach((project, idx) => {
                const isHidden = hiddenProjects.has(idx);
                const baseColIndex = 8 + (idx * 4); // 8 fixed columns + 4 columns per project

                // Column letters (row 0) - with fixed widths to match data columns
                const colWidths = ['40px', '55px', '65px', '55px']; // Days, ¬£/rate, Total, Remain
                for (let i = 0; i < 4; i++) {
                    const letterTh = document.createElement('th');
                    const colLetter = columnIndexToLetter(baseColIndex + i);
                    letterTh.style.cssText = `border: 1px solid #ddd; padding: 2px; font-size: 9px; color: #666; background: #f5f5f5; width: ${colWidths[i]}; min-width: ${colWidths[i]}; max-width: ${colWidths[i]};`;
                    // Add visual separator to first column of each project
                    if (idx > 0 && i === 0) {
                        letterTh.style.borderLeft = '3px solid #90a4ae';
                    }
                    letterTh.textContent = colLetter;
                    letterTh.dataset.projectIdx = idx;

                    if (isHidden) {
                        letterTh.style.display = 'none';
                    }

                    columnLetterRow.appendChild(letterTh);
                }

                // Project name header (row 1)
                const projectTh = document.createElement('th');
                projectTh.colSpan = 4; // Days, Rate, Total, Remaining
                projectTh.style.cssText = `border: 1px solid #ddd; padding: 4px; background: ${project.color}; color: #333; position: relative;`;
                // Add visual separator between projects
                if (idx > 0) {
                    projectTh.style.borderLeft = '3px solid #90a4ae';
                }
                projectTh.dataset.projectIdx = idx;

                // Create the project name span with onclick handler
                const projectNameSpan = document.createElement('span');
                projectNameSpan.style.cssText = 'cursor: pointer; text-decoration: underline;';

                // Add grant link indicator and tooltip
                if (project.grantProjectId) {
                    const linkIcon = document.createElement('span');
                    linkIcon.textContent = 'üîó ';
                    linkIcon.style.cssText = 'font-size: 12px;';
                    projectNameSpan.appendChild(linkIcon);

                    const grantInfo = project.grantProjectNumber ?
                        `Grant-linked: ${project.name} (${project.grantProjectNumber})` :
                        `Grant-linked: ${project.name}`;
                    projectNameSpan.title = `${grantInfo}\nLinked: ${new Date(project.linkedAt).toLocaleDateString()}\nClick to view labour budget summary`;
                } else {
                    projectNameSpan.title = 'Manual project\nClick to view labour budget summary';
                }

                const nameText = document.createTextNode(project.name);
                projectNameSpan.appendChild(nameText);

                projectNameSpan.onclick = function(e) {
                    console.log('üü¢ SPAN CLICKED! Project index:', idx, 'Project:', project.name);
                    e.stopPropagation();
                    showLabourBudgetSummary(idx);
                };

                // Create the visibility toggle button
                const toggleBtn = document.createElement('button');
                toggleBtn.style.cssText = `float: right; background: ${isHidden ? '#4CAF50' : '#FF9800'}; color: white; border: none; padding: 2px 4px; cursor: pointer; border-radius: 2px; font-size: 10px; margin-left: 4px; line-height: 1; opacity: 0.7;`;
                toggleBtn.title = isHidden ? 'Show project' : 'Hide project';
                toggleBtn.textContent = isHidden ? '+' : '‚àí';
                toggleBtn.onclick = function(e) {
                    e.stopPropagation();
                    toggleProjectVisibility(idx);
                };

                projectTh.appendChild(projectNameSpan);
                projectTh.appendChild(toggleBtn);

                if (isHidden) {
                    projectTh.style.display = 'none';
                }

                projectHeaderRow.appendChild(projectTh);

                // Column headers (row 2) - with fixed widths to match data columns
                const headers = ['Days', '¬£/rate', 'Total', 'Remain'];
                const headerWidths = ['40px', '55px', '65px', '55px'];
                headers.forEach((header, headerIdx) => {
                    const th = document.createElement('th');
                    th.style.cssText = `border: 1px solid #ddd; padding: 2px 4px; background: ${project.color}; color: #333; font-size: 10px; opacity: 0.9; width: ${headerWidths[headerIdx]}; min-width: ${headerWidths[headerIdx]}; max-width: ${headerWidths[headerIdx]}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;`;
                    // Add visual separator to first column of each project
                    if (idx > 0 && headerIdx === 0) {
                        th.style.borderLeft = '3px solid #90a4ae';
                    }
                    th.textContent = header;
                    th.dataset.projectIdx = idx;

                    if (isHidden) {
                        th.style.display = 'none';
                    }

                    columnHeaderRow.appendChild(th);
                });
            });
        }

        // Drag-and-drop variables for row reordering
        let draggedRow = null;
        let draggedRowIndex = null;

        // Drag-and-drop event handlers for labour table rows
        function handleDragStart(e) {
            const row = e.target.closest('tr');
            draggedRow = row;
            draggedRowIndex = Array.from(row.parentNode.children).indexOf(row);
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', row.innerHTML);
            row.style.opacity = '0.4';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            const targetRow = e.target.closest('tr');
            if (targetRow && targetRow !== draggedRow && targetRow.parentNode.id === 'labourTableBody') {
                const tbody = targetRow.parentNode;
                const targetIndex = Array.from(tbody.children).indexOf(targetRow);

                // Visual feedback: add border to show where row will be dropped
                tbody.querySelectorAll('tr').forEach(tr => {
                    tr.style.borderTop = '';
                    tr.style.borderBottom = '';
                });

                if (draggedRowIndex < targetIndex) {
                    targetRow.style.borderBottom = '2px solid #2B7A78';
                } else {
                    targetRow.style.borderTop = '2px solid #2B7A78';
                }
            }

            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const targetRow = e.target.closest('tr');
            if (draggedRow && targetRow && draggedRow !== targetRow && targetRow.parentNode.id === 'labourTableBody') {
                const tbody = targetRow.parentNode;
                const targetIndex = Array.from(tbody.children).indexOf(targetRow);

                // Reorder the data array
                const [movedItem] = labourRows.splice(draggedRowIndex, 1);
                labourRows.splice(targetIndex, 0, movedItem);

                // Save and re-render
                saveLabourData();
                renderLabourRows();
            }

            return false;
        }

        function handleDragEnd(e) {
            const row = e.target.closest('tr');
            if (row) {
                row.style.opacity = '1';
            }

            // Clear visual feedback
            const tbody = document.getElementById('labourTableBody');
            if (tbody) {
                tbody.querySelectorAll('tr').forEach(tr => {
                    tr.style.borderTop = '';
                    tr.style.borderBottom = '';
                });
            }

            draggedRow = null;
            draggedRowIndex = null;
        }

        // Render labour rows
        function renderLabourRows() {
            const tbody = document.getElementById('labourTableBody');
            tbody.innerHTML = '';

            if (labourRows.length === 0) {
                // Add a default row
                labourRows.push(createDefaultRow());
            }

            // Track month changes for alternating background colors and borders
            let previousMonth = null;
            let monthGroupIndex = 0;
            const monthColors = ['#ffffff', '#f0f4ff']; // White alternating with light blue

            labourRows.forEach((row, rowIdx) => {
                const tr = document.createElement('tr');
                const displayRowNum = rowIdx + 1; // 1-indexed for display
                let colIdx = 0; // Track column index for cell references

                // Add row number as data attribute for cell references
                tr.dataset.rowNumber = displayRowNum;

                // Detect month change
                const isNewMonth = previousMonth !== null && previousMonth !== row.month;
                if (isNewMonth) {
                    monthGroupIndex = (monthGroupIndex + 1) % 2;
                }
                previousMonth = row.month;

                // Apply background color to entire row based on month group
                tr.style.backgroundColor = monthColors[monthGroupIndex];

                // Add thick border on top of first row of new month
                if (isNewMonth) {
                    tr.style.borderTop = '3px solid #2B7A78';
                }

                // Drag handle cell - STICKY at left edge
                const dragCell = document.createElement('td');
                dragCell.style.border = '1px solid #ddd';
                dragCell.style.padding = '2px';
                dragCell.style.textAlign = 'center';
                dragCell.style.cursor = 'move';
                dragCell.style.userSelect = 'none';
                dragCell.style.position = 'sticky';
                dragCell.style.left = '0';
                dragCell.style.zIndex = '5';
                dragCell.style.backgroundColor = monthColors[monthGroupIndex];
                dragCell.style.fontSize = '14px';
                dragCell.style.color = '#666';
                dragCell.style.minWidth = '24px';
                dragCell.style.width = '24px';
                dragCell.style.maxWidth = '24px';
                dragCell.innerHTML = '<span style="font-size: 8px; color: #999; display: block;">' + displayRowNum + '</span>‚†ø';
                dragCell.title = 'Drag to reorder ‚Ä¢ Double-click for options';
                dragCell.draggable = true;
                if (isNewMonth) {
                    dragCell.style.borderTop = '3px solid #2B7A78';
                }

                // Add drag event listeners
                dragCell.addEventListener('dragstart', handleDragStart);
                dragCell.addEventListener('dragover', handleDragOver);
                dragCell.addEventListener('drop', handleDrop);
                dragCell.addEventListener('dragend', handleDragEnd);

                // Double-click to show row options menu
                dragCell.addEventListener('dblclick', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Remove any existing menu
                    const existingMenu = document.querySelector('.row-options-menu');
                    if (existingMenu) {
                        existingMenu.remove();
                    }

                    // Create dropdown menu
                    const menu = document.createElement('div');
                    menu.className = 'row-options-menu';
                    menu.style.cssText = `
                        position: absolute;
                        background: white;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                        z-index: 1000;
                        min-width: 120px;
                        padding: 4px 0;
                    `;

                    // Delete row option
                    const deleteOption = document.createElement('div');
                    deleteOption.innerHTML = 'üóëÔ∏è Delete Row';
                    deleteOption.style.cssText = `
                        padding: 8px 12px;
                        cursor: pointer;
                        font-size: 12px;
                        color: #d32f2f;
                    `;
                    deleteOption.addEventListener('mouseenter', () => {
                        deleteOption.style.backgroundColor = '#ffebee';
                    });
                    deleteOption.addEventListener('mouseleave', () => {
                        deleteOption.style.backgroundColor = '';
                    });
                    deleteOption.addEventListener('click', function() {
                        menu.remove();
                        // Confirm deletion
                        if (confirm(`Delete row ${displayRowNum}? This cannot be undone.`)) {
                            labourRows.splice(rowIdx, 1);
                            saveLabourData();
                            renderLabourRows();
                        }
                    });
                    menu.appendChild(deleteOption);

                    // Position menu near the cell
                    const rect = dragCell.getBoundingClientRect();
                    menu.style.left = rect.left + 'px';
                    menu.style.top = (rect.bottom + 2) + 'px';
                    menu.style.position = 'fixed';

                    document.body.appendChild(menu);

                    // Close menu when clicking outside
                    const closeMenu = function(evt) {
                        if (!menu.contains(evt.target)) {
                            menu.remove();
                            document.removeEventListener('click', closeMenu);
                        }
                    };
                    setTimeout(() => {
                        document.addEventListener('click', closeMenu);
                    }, 0);
                });

                tr.appendChild(dragCell);

                // Month (dropdown) - STICKY with row number
                const monthCell = createMonthDropdownCell(row.month, (val) => {
                    labourRows[rowIdx].month = val;
                    saveLabourData();
                });
                monthCell.style.position = 'sticky';
                monthCell.style.left = '24px';
                monthCell.style.zIndex = '5';
                monthCell.style.backgroundColor = monthColors[monthGroupIndex];
                if (isNewMonth) {
                    monthCell.style.borderTop = '3px solid #2B7A78';
                }
                monthCell.dataset.colIdx = colIdx;
                monthCell.title = `Cell: ${columnIndexToLetter(colIdx)}${displayRowNum}`;
                colIdx++;
                tr.appendChild(monthCell);

                // Staff (dropdown with database) - STICKY
                const staffCell = createStaffDropdownCell(row.staff, (val) => {
                    labourRows[rowIdx].staff = val;
                    saveLabourData();
                });
                staffCell.style.position = 'sticky';
                staffCell.style.left = '74px';
                staffCell.style.zIndex = '5';
                staffCell.style.backgroundColor = monthColors[monthGroupIndex];
                if (isNewMonth) {
                    staffCell.style.borderTop = '3px solid #2B7A78';
                }
                staffCell.dataset.colIdx = colIdx++;
                tr.appendChild(staffCell);

                // Gross (calculated)
                const grossCell = createCalculatedCell(row.gross || 0);
                grossCell.dataset.colIdx = colIdx++;
                tr.appendChild(grossCell);

                // FTE (editable with formula support)
                const fteDisplayValue = row.fte ? row.fte.toFixed(2) : '1.00';
                const fteCell = createEditableCell(fteDisplayValue, 'number', (val, evaluated) => {
                    labourRows[rowIdx].fte = evaluated.value;
                    labourRows[rowIdx].fteFormula = evaluated.formula;
                    recalculateRow(rowIdx);
                    saveLabourData();
                }, row.fteFormula);
                fteCell.style.background = '#fffde7';
                fteCell.dataset.colIdx = colIdx;
                fteCell.title = `Cell: ${columnIndexToLetter(colIdx)}${displayRowNum}`;
                colIdx++;
                tr.appendChild(fteCell);

                // ¬£/yr (if full time) - editable with formula support
                const yearlyDisplayValue = row.yearlyPay ? Math.floor(row.yearlyPay).toString() : '0';
                const yearlyCell = createEditableCell(yearlyDisplayValue, 'number', (val, evaluated) => {
                    labourRows[rowIdx].yearlyPay = evaluated.value;
                    labourRows[rowIdx].yearlyPayFormula = evaluated.formula;
                    recalculateRow(rowIdx);
                    saveLabourData();
                }, row.yearlyPayFormula);
                yearlyCell.style.background = '#fffde7';
                yearlyCell.style.maxWidth = '50px';
                yearlyCell.style.width = '50px';
                yearlyCell.style.overflow = 'hidden';
                yearlyCell.style.textOverflow = 'clip';
                yearlyCell.style.whiteSpace = 'nowrap';
                yearlyCell.dataset.colIdx = colIdx;
                yearlyCell.title = `Cell: ${columnIndexToLetter(colIdx)}${displayRowNum}`;
                colIdx++;
                tr.appendChild(yearlyCell);

                // ¬£/yr (as paid) - calculated (accounts for FTE)
                const yearlyAsPaidCell = createCalculatedCell(row.yearlyAsPaid || 0, 0);
                yearlyAsPaidCell.style.maxWidth = '50px';
                yearlyAsPaidCell.style.width = '50px';
                yearlyAsPaidCell.style.overflow = 'hidden';
                yearlyAsPaidCell.style.textOverflow = 'clip';
                yearlyAsPaidCell.style.whiteSpace = 'nowrap';
                yearlyAsPaidCell.dataset.colIdx = colIdx++;
                tr.appendChild(yearlyAsPaidCell);

                // ¬£/day (calculated)
                const dailyCell = createCalculatedCell(row.dailyRate || 0);
                dailyCell.dataset.colIdx = colIdx++;
                tr.appendChild(dailyCell);

                // ¬£/hr (calculated)
                const hourlyCell = createCalculatedCell(row.hourlyRate || 0);
                hourlyCell.dataset.colIdx = colIdx++;
                tr.appendChild(hourlyCell);

                // Ensure formula fields exist for backward compatibility
                if (row.fteFormula === undefined) row.fteFormula = null;
                if (row.yearlyPayFormula === undefined) row.yearlyPayFormula = null;

                // Project allocations
                // Track if we've encountered a fully allocated project (remaining = 0)
                let foundFullyAllocated = false;

                labourProjects.forEach((project, projIdx) => {
                    if (!row.projects[projIdx]) {
                        row.projects[projIdx] = { days: 0, daysFormula: null, rate: 0, rateFormula: null, total: 0, remaining: 0 };
                    }
                    // Ensure formula fields exist for backward compatibility
                    if (row.projects[projIdx].daysFormula === undefined) {
                        row.projects[projIdx].daysFormula = null;
                    }
                    if (row.projects[projIdx].rateFormula === undefined) {
                        row.projects[projIdx].rateFormula = null;
                    }

                    const proj = row.projects[projIdx];
                    const isHidden = hiddenProjects.has(projIdx);

                    // Check if previous project was fully allocated
                    const shouldDimCells = foundFullyAllocated;

                    // Check if this project is fully allocated (within 0.01 tolerance)
                    const isFullyAllocated = Math.abs(proj.remaining) < 0.01;

                    // Days (with formula support)
                    const displayValue = proj.days ? proj.days.toFixed(2) : '0';
                    const daysCell = createEditableCell(displayValue, 'number', (val, evaluated) => {
                        labourRows[rowIdx].projects[projIdx].days = evaluated.value;
                        labourRows[rowIdx].projects[projIdx].daysFormula = evaluated.formula;
                        recalculateRow(rowIdx);
                        saveLabourData();
                    }, proj.daysFormula);
                    daysCell.style.background = '#fffde7';
                    daysCell.style.width = '40px';
                    daysCell.style.minWidth = '40px';
                    daysCell.style.maxWidth = '40px';
                    daysCell.style.overflow = 'hidden';
                    daysCell.style.textOverflow = 'ellipsis';
                    // Add visual separator between projects
                    if (projIdx > 0) {
                        daysCell.style.borderLeft = '3px solid #90a4ae';
                    }
                    // Apply dimming if project comes after a fully allocated one
                    if (shouldDimCells) {
                        daysCell.style.opacity = '0.25';
                    }
                    daysCell.dataset.projectIdx = projIdx;
                    daysCell.dataset.rowIdx = rowIdx;
                    daysCell.dataset.colIdx = colIdx;
                    daysCell.title = `Cell: ${columnIndexToLetter(colIdx)}${displayRowNum}`;
                    colIdx++;
                    if (isHidden) daysCell.style.display = 'none';
                    tr.appendChild(daysCell);

                    // Rate (editable with formula support)
                    const rateDisplayValue = proj.rate ? proj.rate.toFixed(2) : '0';
                    const rateCell = createEditableCell(rateDisplayValue, 'number', (val, evaluated) => {
                        labourRows[rowIdx].projects[projIdx].rate = evaluated.value;
                        labourRows[rowIdx].projects[projIdx].rateFormula = evaluated.formula;
                        recalculateRow(rowIdx);
                        saveLabourData();
                    }, proj.rateFormula);
                    rateCell.style.background = '#fffde7';
                    rateCell.style.width = '55px';
                    rateCell.style.minWidth = '55px';
                    rateCell.style.maxWidth = '55px';
                    rateCell.style.overflow = 'hidden';
                    rateCell.style.textOverflow = 'ellipsis';
                    // Apply dimming if project comes after a fully allocated one
                    if (shouldDimCells) {
                        rateCell.style.opacity = '0.25';
                    }
                    rateCell.dataset.projectIdx = projIdx;
                    rateCell.dataset.colIdx = colIdx;
                    rateCell.title = `Cell: ${columnIndexToLetter(colIdx)}${displayRowNum}`;
                    colIdx++;
                    if (isHidden) rateCell.style.display = 'none';
                    tr.appendChild(rateCell);

                    // Total (calculated)
                    const totalCell = createCalculatedCell(proj.total || 0);
                    totalCell.style.background = '#e8f5e9';
                    totalCell.style.width = '65px';
                    totalCell.style.minWidth = '65px';
                    totalCell.style.maxWidth = '65px';
                    totalCell.style.overflow = 'hidden';
                    totalCell.style.textOverflow = 'ellipsis';
                    // Apply dimming if project comes after a fully allocated one
                    if (shouldDimCells) {
                        totalCell.style.opacity = '0.25';
                    }
                    totalCell.dataset.projectIdx = projIdx;
                    totalCell.dataset.colIdx = colIdx++;
                    if (isHidden) totalCell.style.display = 'none';
                    tr.appendChild(totalCell);

                    // Remaining (calculated)
                    const remainCell = createCalculatedCell(proj.remaining || 0);
                    remainCell.style.width = '55px';
                    remainCell.style.minWidth = '55px';
                    remainCell.style.maxWidth = '55px';
                    remainCell.style.overflow = 'hidden';
                    remainCell.style.textOverflow = 'ellipsis';

                    // Special styling for fully allocated projects (remaining = 0)
                    if (isFullyAllocated) {
                        remainCell.style.background = '#4caf50';  // Bright green
                        remainCell.style.color = 'white';
                        remainCell.style.fontWeight = 'bold';
                        remainCell.style.position = 'relative';
                        // Add checkmark in top-right corner
                        const checkmark = document.createElement('span');
                        checkmark.textContent = '‚úì';
                        checkmark.style.cssText = 'position: absolute; top: 2px; right: 4px; font-size: 10px; color: white;';
                        remainCell.appendChild(checkmark);
                    } else {
                        remainCell.style.background = proj.remaining < 0 ? '#ffcdd2' : '#e8f5e9';
                    }

                    // Apply dimming if project comes after a fully allocated one
                    if (shouldDimCells) {
                        remainCell.style.opacity = '0.25';
                    }

                    remainCell.dataset.projectIdx = projIdx;
                    remainCell.dataset.colIdx = colIdx++;
                    if (isHidden) remainCell.style.display = 'none';
                    tr.appendChild(remainCell);

                    // Update flag for next iteration
                    if (isFullyAllocated) {
                        foundFullyAllocated = true;
                    }
                });

                // Delete row button
                const deleteCell = document.createElement('td');
                deleteCell.style.cssText = 'border: 1px solid #ddd; padding: 4px; text-align: center;';
                deleteCell.innerHTML = `<button onclick="deleteRow(${rowIdx})" style="background: #f44336; color: white; border: none; padding: 2px 8px; cursor: pointer; border-radius: 3px; font-size: 10px;">Delete</button>`;
                tr.appendChild(deleteCell);

                tbody.appendChild(tr);
            });
        }

        // Create month dropdown cell
        function createMonthDropdownCell(value, onchange) {
            const td = document.createElement('td');
            td.style.cssText = 'border: 1px solid #ddd; padding: 2px; cursor: pointer; max-width: 50px; width: 50px; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
            // Format "2025-07" to "25-07"
            const displayValue = value ? value.replace(/^(\d{4})-/, (match, year) => String(year).slice(-2) + '-') : '';
            td.textContent = displayValue;

            td.addEventListener('click', function() {
                // Prevent multiple dropdowns
                if (td.querySelector('select')) return;

                const select = document.createElement('select');
                select.style.cssText = 'width: 100%; border: 2px solid #2196F3; padding: 2px; font-size: 11px;';

                // Generate months (current year and next 2 years)
                const currentYear = new Date().getFullYear();
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                for (let year = currentYear - 1; year <= currentYear + 2; year++) {
                    for (let month = 0; month < 12; month++) {
                        const monthValue = `${year}-${String(month + 1).padStart(2, '0')}`;
                        const option = document.createElement('option');
                        option.value = monthValue;
                        option.textContent = `${String(year).slice(-2)}-${String(month + 1).padStart(2, '0')}`;
                        if (monthValue === value) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    }
                }

                let isChanging = false;

                select.addEventListener('change', function() {
                    isChanging = true;
                    const newValue = select.value;
                    const displayValue = newValue.replace(/^(\d{4})-/, (match, year) => String(year).slice(-2) + '-');
                    td.textContent = displayValue;
                    if (onchange) onchange(newValue);
                    setTimeout(() => isChanging = false, 100);
                });

                select.addEventListener('blur', function() {
                    if (!isChanging) {
                        // User closed without selecting, restore original value
                        const displayValue = value ? value.replace(/^(\d{4})-/, (match, year) => String(year).slice(-2) + '-') : '';
                        td.textContent = displayValue;
                    }
                });

                select.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        const newValue = select.value;
                        const displayValue = newValue.replace(/^(\d{4})-/, (match, year) => String(year).slice(-2) + '-');
                        td.textContent = displayValue;
                        if (onchange) onchange(newValue);
                        select.blur();
                    }
                    if (e.key === 'Escape') {
                        const displayValue = value ? value.replace(/^(\d{4})-/, (match, year) => String(year).slice(-2) + '-') : '';
                        td.textContent = displayValue;
                        select.blur();
                    }
                });

                td.textContent = '';
                td.appendChild(select);
                select.focus();

                // Open dropdown automatically
                setTimeout(() => {
                    if (select.showPicker) {
                        select.showPicker();
                    } else {
                        select.click();
                    }
                }, 50);
            });

            return td;
        }

        // Create staff dropdown cell with database
        function createStaffDropdownCell(value, onchange) {
            const td = document.createElement('td');
            td.style.cssText = 'border: 1px solid #ddd; padding: 2px; cursor: pointer; max-width: 80px; width: 80px; font-size: 9px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
            // Abbreviate long titles: "Electronic Eng" -> "E. Eng.", "Managing Director" -> "Man. Dir."
            let displayValue = value || '';
            displayValue = displayValue.replace(/Electronic Eng/gi, 'E. Eng.');
            displayValue = displayValue.replace(/Electrical Eng/gi, 'Elec. Eng.');
            displayValue = displayValue.replace(/Managing Director/gi, 'Man. Dir.');
            displayValue = displayValue.replace(/Technical Director/gi, 'Tech. Dir.');
            displayValue = displayValue.replace(/Data Analyst/gi, 'Data An.');
            td.textContent = displayValue;

            td.addEventListener('click', function() {
                // Prevent multiple dropdowns
                if (td.querySelector('select')) return;

                const select = document.createElement('select');
                select.style.cssText = 'width: 100%; border: 2px solid #2196F3; padding: 2px; font-size: 11px;';

                // Add empty option
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = '-- Select Staff --';
                select.appendChild(emptyOption);

                // Add existing staff from database
                staffDatabase.forEach(staff => {
                    const option = document.createElement('option');
                    option.value = staff;
                    option.textContent = staff;
                    if (staff === value) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                // Add "Add new staff" option
                const addNewOption = document.createElement('option');
                addNewOption.value = '__ADD_NEW__';
                addNewOption.textContent = '+ Add New Staff';
                addNewOption.style.fontWeight = 'bold';
                addNewOption.style.color = '#4CAF50';
                select.appendChild(addNewOption);

                let isChanging = false;

                select.addEventListener('change', function() {
                    isChanging = true;

                    if (select.value === '__ADD_NEW__') {
                        // Prompt for new staff name
                        const newStaff = prompt('Enter new staff member name / initials:');
                        if (newStaff && newStaff.trim()) {
                            const trimmedStaff = newStaff.trim();
                            // Add to database if not already exists
                            if (!staffDatabase.includes(trimmedStaff)) {
                                staffDatabase.push(trimmedStaff);
                                staffDatabase.sort(); // Keep alphabetically sorted
                                saveLabourData();
                            }
                            // Set the value
                            td.textContent = trimmedStaff;
                            if (onchange) onchange(trimmedStaff);
                        } else {
                            // User cancelled, restore original value
                            td.textContent = value || '';
                        }
                    } else {
                        // Regular selection
                        td.textContent = select.value;
                        if (onchange) onchange(select.value);
                    }

                    setTimeout(() => isChanging = false, 100);
                });

                select.addEventListener('blur', function() {
                    if (!isChanging) {
                        // User closed without selecting, restore original value
                        td.textContent = value || '';
                    }
                });

                select.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        select.dispatchEvent(new Event('change'));
                        select.blur();
                    }
                    if (e.key === 'Escape') {
                        td.textContent = value || '';
                        select.blur();
                    }
                });

                td.textContent = '';
                td.appendChild(select);
                select.focus();

                // Open dropdown automatically
                setTimeout(() => {
                    if (select.showPicker) {
                        select.showPicker();
                    } else {
                        select.click();
                    }
                }, 50);
            });

            return td;
        }

        // Convert column index to Excel-style letter (0=A, 25=Z, 26=AA, 27=AB, etc.)
        function columnIndexToLetter(index) {
            let letter = '';
            while (index >= 0) {
                letter = String.fromCharCode((index % 26) + 65) + letter;
                index = Math.floor(index / 26) - 1;
            }
            return letter;
        }

        // Get cell value by reference (e.g., "A1", "AF67")
        function getCellValue(cellRef) {
            // Parse cell reference (e.g., "AF67" -> column: AF, row: 67)
            const match = cellRef.match(/^([A-Z]+)(\d+)$/);
            if (!match) return 0;

            const colLetters = match[1];
            const rowNum = parseInt(match[2]) - 1; // Convert to 0-indexed

            // Convert column letters to index
            let colIndex = 0;
            for (let i = 0; i < colLetters.length; i++) {
                colIndex = colIndex * 26 + (colLetters.charCodeAt(i) - 64);
            }
            colIndex -= 1; // Convert to 0-indexed

            // Find the cell in the table using data attributes
            const tbody = document.getElementById('labourTableBody');
            if (!tbody || rowNum >= labourRows.length) return 0;

            const row = tbody.children[rowNum];
            if (!row) return 0;

            // Find cell with matching colIdx
            const cells = Array.from(row.children);
            const cell = cells.find(c => parseInt(c.dataset.colIdx) === colIndex);
            if (!cell) return 0;

            // Get the value from the cell's textContent
            // Remove any HTML tags and extract just the number
            const textContent = cell.textContent.replace(/[^\d.\-]/g, '');
            const value = parseFloat(textContent) || 0;
            return value;
        }

        // Evaluate formula (Excel-like: =86/12 or =AF67/AI67)
        function evaluateFormula(input) {
            if (typeof input !== 'string' || !input.startsWith('=')) {
                return { isFormula: false, value: parseFloat(input) || 0, formula: null };
            }

            try {
                let expression = input.substring(1).trim(); // Remove '='

                // Replace cell references with their values (e.g., AF67 -> 123.45)
                expression = expression.replace(/([A-Z]+\d+)/g, (match) => {
                    const cellValue = getCellValue(match);
                    return cellValue.toString();
                });

                // Security: Only allow numbers, basic operators, parentheses, and dots
                if (!/^[\d\s+\-*/(). ]+$/.test(expression)) {
                    throw new Error('Invalid characters in formula');
                }

                // Evaluate the expression safely
                const result = Function('"use strict"; return (' + expression + ')')();

                if (isNaN(result) || !isFinite(result)) {
                    throw new Error('Invalid result');
                }

                return { isFormula: true, value: result, formula: input };
            } catch (error) {
                console.error('Formula evaluation error:', error);
                return { isFormula: true, value: 0, formula: input, error: true };
            }
        }

        // Adjust cell references in formula based on offset (like Excel autofill)
        function adjustFormulaReferences(formula, rowOffset, colOffset) {
            if (!formula || !formula.startsWith('=')) return formula;

            // Match cell references like A1, AB23, etc.
            return formula.replace(/([A-Z]+)(\d+)/g, (match, colLetters, rowNum) => {
                // Convert column letters to index
                let colIndex = 0;
                for (let i = 0; i < colLetters.length; i++) {
                    colIndex = colIndex * 26 + (colLetters.charCodeAt(i) - 64);
                }
                colIndex -= 1; // Convert to 0-indexed

                // Apply offsets
                const newColIndex = colIndex + colOffset;
                const newRowNum = parseInt(rowNum) + rowOffset;

                // Convert back to letters
                const newColLetters = columnIndexToLetter(newColIndex);
                return newColLetters + newRowNum;
            });
        }

        // Highlight cells in drag range
        function highlightDragRange(startRow, startCol, endRow, endCol) {
            const tbody = document.getElementById('labourTableBody');
            if (!tbody) return;

            const minRow = Math.min(startRow, endRow);
            const maxRow = Math.max(startRow, endRow);
            const minCol = Math.min(startCol, endCol);
            const maxCol = Math.max(startCol, endCol);

            for (let r = minRow; r <= maxRow; r++) {
                const row = tbody.children[r];
                if (!row) continue;

                for (let c = minCol; c <= maxCol; c++) {
                    const cells = Array.from(row.children);
                    const cell = cells.find(td => parseInt(td.dataset.colIdx) === c);

                    if (cell && cell.dataset.cellType === 'editable') {
                        cell.classList.add('drag-highlight');
                        cell.dataset.originalBg = cell.style.background || '#fffde7';
                        cell.style.background = '#bbdefb';
                    }
                }
            }
        }

        // Fill cells in drag range with adjusted formulas
        function fillDragRange(startRow, startCol, endRow, endCol, sourceCell) {
            const tbody = document.getElementById('labourTableBody');
            if (!tbody) return;

            const sourceFormula = sourceCell.dataset.formula;
            const sourceValue = sourceCell.textContent;

            const minRow = Math.min(startRow, endRow);
            const maxRow = Math.max(startRow, endRow);
            const minCol = Math.min(startCol, endCol);
            const maxCol = Math.max(startCol, endCol);

            for (let r = minRow; r <= maxRow; r++) {
                for (let c = minCol; c <= maxCol; c++) {
                    // Skip the source cell
                    if (r === startRow && c === startCol) continue;

                    const rowOffset = r - startRow;
                    const colOffset = c - startCol;

                    // Adjust formula references
                    const adjustedFormula = adjustFormulaReferences(sourceFormula, rowOffset, colOffset);

                    // Find the target cell
                    const row = tbody.children[r];
                    if (!row) continue;

                    const cells = Array.from(row.children);
                    const targetCell = cells.find(td => parseInt(td.dataset.colIdx) === c);

                    if (targetCell && targetCell.dataset.cellType === 'editable') {
                        if (adjustedFormula && adjustedFormula.startsWith('=')) {
                            // Evaluate and apply formula
                            const evaluated = evaluateFormula(adjustedFormula);
                            targetCell.textContent = evaluated.error ? '#ERROR' : evaluated.value;
                            targetCell.dataset.formula = adjustedFormula;
                            targetCell.style.color = evaluated.error ? 'red' : '';

                            // Trigger onchange callback if we can find it
                            // This updates the underlying data
                            triggerCellUpdate(r, c, adjustedFormula, evaluated);
                        } else {
                            // No formula, just copy the value
                            targetCell.textContent = sourceValue;
                            targetCell.dataset.formula = '';

                            // Trigger update with plain value
                            const evaluated = { isFormula: false, value: parseFloat(sourceValue) || 0, formula: null };
                            triggerCellUpdate(r, c, sourceValue, evaluated);
                        }
                    }
                }
            }

            // Re-render the table to ensure all calculations are updated
            renderLabourRows();
            applyMonthStates();
        }

        // Trigger cell update to sync with underlying data
        function triggerCellUpdate(rowIdx, colIdx, value, evaluated) {
            if (rowIdx >= labourRows.length) return;

            const row = labourRows[rowIdx];

            // Map column index to field
            if (colIdx === 3) { // FTE
                row.fte = evaluated.value;
                row.fteFormula = evaluated.formula;
                recalculateRow(rowIdx);
            } else if (colIdx === 4) { // yearlyPay
                row.yearlyPay = evaluated.value;
                row.yearlyPayFormula = evaluated.formula;
                recalculateRow(rowIdx);
            } else if (colIdx >= 8) { // Project columns
                const projectColIdx = colIdx - 8;
                const projectIdx = Math.floor(projectColIdx / 4);
                const fieldInProject = projectColIdx % 4;

                if (projectIdx < labourProjects.length && row.projects[projectIdx]) {
                    if (fieldInProject === 0) { // Days
                        row.projects[projectIdx].days = evaluated.value;
                        row.projects[projectIdx].daysFormula = evaluated.formula;
                        recalculateRow(rowIdx);
                    } else if (fieldInProject === 1) { // Rate
                        row.projects[projectIdx].rate = evaluated.value;
                        row.projects[projectIdx].rateFormula = evaluated.formula;
                        recalculateRow(rowIdx);
                    }
                }
            }

            saveLabourData();
        }

        // Create editable cell (with formula support and drag handle)
        function createEditableCell(value, type, onchange, formulaValue = null) {
            const td = document.createElement('td');
            td.style.cssText = 'border: 1px solid #ddd; padding: 4px; cursor: pointer; position: relative;';
            td.textContent = value || '';

            // Store formula for copy/paste
            td.dataset.formula = formulaValue || '';
            td.dataset.cellType = 'editable';

            // Add drag handle (small square in bottom-right corner)
            const dragHandle = document.createElement('div');
            dragHandle.style.cssText = `
                position: absolute;
                bottom: 0;
                right: 0;
                width: 6px;
                height: 6px;
                background: #2196F3;
                cursor: crosshair;
                display: none;
                z-index: 10;
            `;
            dragHandle.className = 'cell-drag-handle';

            // Show drag handle on hover
            td.addEventListener('mouseenter', function() {
                dragHandle.style.display = 'block';
            });
            td.addEventListener('mouseleave', function() {
                if (!td.dataset.dragging) {
                    dragHandle.style.display = 'none';
                }
            });

            // Drag handle functionality
            let isDragging = false;
            let startCell = null;
            let startRowIdx = null;
            let startColIdx = null;

            dragHandle.addEventListener('mousedown', function(e) {
                e.stopPropagation();
                isDragging = true;
                td.dataset.dragging = 'true';
                startCell = td;

                // Get starting position
                const row = td.parentElement;
                startRowIdx = parseInt(row.dataset.rowNumber) - 1; // Convert to 0-indexed
                startColIdx = parseInt(td.dataset.colIdx);

                // Add visual feedback
                td.style.background = '#e3f2fd';

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            function onMouseMove(e) {
                if (!isDragging) return;

                // Find the cell we're hovering over
                const targetElement = document.elementFromPoint(e.clientX, e.clientY);
                const targetCell = targetElement?.closest('td');

                if (targetCell && targetCell.dataset.cellType === 'editable') {
                    // Highlight cells in the drag range
                    const targetRow = targetCell.parentElement;
                    const endRowIdx = parseInt(targetRow.dataset.rowNumber) - 1;
                    const endColIdx = parseInt(targetCell.dataset.colIdx);

                    // Clear previous highlights
                    document.querySelectorAll('.drag-highlight').forEach(cell => {
                        cell.classList.remove('drag-highlight');
                        const origBg = cell.dataset.originalBg || '#fffde7';
                        cell.style.background = origBg;
                    });

                    // Highlight cells in range
                    highlightDragRange(startRowIdx, startColIdx, endRowIdx, endColIdx);
                }
            }

            function onMouseUp(e) {
                if (!isDragging) return;

                isDragging = false;
                delete td.dataset.dragging;
                dragHandle.style.display = 'none';

                // Get end position
                const targetElement = document.elementFromPoint(e.clientX, e.clientY);
                const targetCell = targetElement?.closest('td');

                if (targetCell && targetCell.dataset.cellType === 'editable') {
                    const targetRow = targetCell.parentElement;
                    const endRowIdx = parseInt(targetRow.dataset.rowNumber) - 1;
                    const endColIdx = parseInt(targetCell.dataset.colIdx);

                    // Fill cells with adjusted formulas
                    fillDragRange(startRowIdx, startColIdx, endRowIdx, endColIdx, startCell);
                }

                // Clear highlights
                document.querySelectorAll('.drag-highlight').forEach(cell => {
                    cell.classList.remove('drag-highlight');
                    const origBg = cell.dataset.originalBg || '#fffde7';
                    cell.style.background = origBg;
                });

                // Restore original background
                const origBg = td.dataset.originalBg || '#fffde7';
                td.style.background = origBg;

                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }

            td.appendChild(dragHandle);

            td.addEventListener('click', function(e) {
                // Don't open editor if clicking drag handle
                if (e.target.classList.contains('cell-drag-handle')) return;

                // Capture cell dimensions before editing to prevent resize
                const cellWidth = td.offsetWidth;
                const cellHeight = td.offsetHeight;
                td.style.width = cellWidth + 'px';
                td.style.minWidth = cellWidth + 'px';
                td.style.maxWidth = cellWidth + 'px';
                td.style.height = cellHeight + 'px';
                td.style.overflow = 'hidden';

                const input = document.createElement('input');
                input.type = 'text'; // Always use text to allow formulas
                input.value = formulaValue || value || '';
                input.style.cssText = `width: ${cellWidth - 8}px; max-width: ${cellWidth - 8}px; border: 2px solid #2196F3; padding: 2px; font-size: 11px; box-sizing: border-box;`;
                input.dataset.isFormula = input.value.startsWith('=');

                // Enable cell click to add reference mode
                let cellClickHandler = null;

                // Track if we're clicking a cell for reference (to prevent blur)
                let isClickingForReference = false;

                input.addEventListener('input', function() {
                    const isFormula = input.value.startsWith('=');
                    if (isFormula && !cellClickHandler) {
                        // Add visual feedback for formula mode
                        input.style.borderColor = '#4CAF50';
                        input.style.boxShadow = '0 0 4px rgba(76, 175, 80, 0.5)';
                        input.placeholder = 'Click cells to add references...';

                        // Highlight all clickable cells
                        document.querySelectorAll('td[data-col-idx]').forEach(cell => {
                            if (cell !== td && cell.dataset.colIdx !== undefined) {
                                cell.classList.add('formula-mode-clickable');
                                cell.style.outline = '1px dashed #4CAF50';
                                cell.style.cursor = 'crosshair';
                            }
                        });

                        // Use mousedown to catch before blur fires
                        cellClickHandler = function(e) {
                            const clickedCell = e.target.closest('td');
                            if (clickedCell && clickedCell !== td && clickedCell.dataset.colIdx !== undefined) {
                                // Prevent blur from closing the editor
                                e.preventDefault();
                                isClickingForReference = true;

                                const row = clickedCell.parentElement;
                                const rowNum = row.dataset.rowNumber;
                                const colIdx = parseInt(clickedCell.dataset.colIdx);
                                const cellRef = columnIndexToLetter(colIdx) + rowNum;

                                // Flash the clicked cell
                                const originalBg = clickedCell.style.backgroundColor;
                                clickedCell.style.backgroundColor = '#C8E6C9';
                                setTimeout(() => {
                                    clickedCell.style.backgroundColor = originalBg;
                                }, 200);

                                // Insert cell reference at cursor position
                                const cursorPos = input.selectionStart;
                                const textBefore = input.value.substring(0, cursorPos);
                                const textAfter = input.value.substring(cursorPos);
                                input.value = textBefore + cellRef + textAfter;

                                // Move cursor after inserted reference
                                const newPos = cursorPos + cellRef.length;
                                setTimeout(() => {
                                    input.focus();
                                    input.setSelectionRange(newPos, newPos);
                                    isClickingForReference = false;
                                }, 0);

                                e.stopPropagation();
                            }
                        };
                        document.addEventListener('mousedown', cellClickHandler, true);
                    } else if (!isFormula && cellClickHandler) {
                        // Remove visual feedback
                        input.style.borderColor = '#2196F3';
                        input.style.boxShadow = '';
                        input.placeholder = '';

                        // Remove highlighting from cells
                        document.querySelectorAll('.formula-mode-clickable').forEach(cell => {
                            cell.classList.remove('formula-mode-clickable');
                            cell.style.outline = '';
                            cell.style.cursor = '';
                        });

                        // Remove cell click listener if formula is deleted
                        document.removeEventListener('mousedown', cellClickHandler, true);
                        cellClickHandler = null;
                    }
                });

                input.addEventListener('blur', function() {
                    // If clicking for reference, don't process blur yet
                    if (isClickingForReference) {
                        return;
                    }

                    // Clean up visual feedback
                    document.querySelectorAll('.formula-mode-clickable').forEach(cell => {
                        cell.classList.remove('formula-mode-clickable');
                        cell.style.outline = '';
                        cell.style.cursor = '';
                    });

                    // Clean up cell click listener
                    if (cellClickHandler) {
                        document.removeEventListener('mousedown', cellClickHandler, true);
                        cellClickHandler = null;
                    }

                    // Restore cell sizing (remove fixed constraints)
                    td.style.width = '';
                    td.style.minWidth = '';
                    td.style.maxWidth = '';
                    td.style.height = '';
                    td.style.overflow = '';

                    const newValue = input.value;

                    // Check if it's a formula
                    if (newValue.startsWith('=')) {
                        const evaluated = evaluateFormula(newValue);

                        if (!evaluated.error) {
                            td.textContent = evaluated.value;
                            td.dataset.formula = evaluated.formula;
                            td.style.color = '';
                            if (onchange) onchange(newValue, evaluated);
                        } else {
                            td.textContent = '#ERROR';
                            td.dataset.formula = evaluated.formula;
                            td.style.color = 'red';
                            if (onchange) onchange(newValue, evaluated);
                        }
                    } else {
                        // Not a formula, just plain value
                        td.textContent = newValue;
                        td.dataset.formula = '';
                        td.style.color = '';
                        if (onchange) onchange(newValue, { isFormula: false, value: parseFloat(newValue) || 0, formula: null });
                    }
                });

                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        input.blur();
                    }
                    if (e.key === 'Escape') {
                        // Clean up visual feedback
                        document.querySelectorAll('.formula-mode-clickable').forEach(cell => {
                            cell.classList.remove('formula-mode-clickable');
                            cell.style.outline = '';
                            cell.style.cursor = '';
                        });

                        // Clean up cell click listener
                        if (cellClickHandler) {
                            document.removeEventListener('mousedown', cellClickHandler, true);
                            cellClickHandler = null;
                        }

                        // Restore cell sizing
                        td.style.width = '';
                        td.style.minWidth = '';
                        td.style.maxWidth = '';
                        td.style.height = '';
                        td.style.overflow = '';

                        td.textContent = value || '';
                        input.blur();
                    }
                });

                // Enable cell click mode immediately if editing formula
                if (input.value.startsWith('=')) {
                    // Add visual feedback for formula mode
                    input.style.borderColor = '#4CAF50';
                    input.style.boxShadow = '0 0 4px rgba(76, 175, 80, 0.5)';
                    input.placeholder = 'Click cells to add references...';

                    // Highlight all clickable cells
                    document.querySelectorAll('td[data-col-idx]').forEach(cell => {
                        if (cell !== td && cell.dataset.colIdx !== undefined) {
                            cell.classList.add('formula-mode-clickable');
                            cell.style.outline = '1px dashed #4CAF50';
                            cell.style.cursor = 'crosshair';
                        }
                    });

                    cellClickHandler = function(e) {
                        const clickedCell = e.target.closest('td');
                        if (clickedCell && clickedCell !== td && clickedCell.dataset.colIdx !== undefined) {
                            // Prevent blur from closing the editor
                            e.preventDefault();
                            isClickingForReference = true;

                            const row = clickedCell.parentElement;
                            const rowNum = row.dataset.rowNumber;
                            const colIdx = parseInt(clickedCell.dataset.colIdx);
                            const cellRef = columnIndexToLetter(colIdx) + rowNum;

                            // Flash the clicked cell
                            const originalBg = clickedCell.style.backgroundColor;
                            clickedCell.style.backgroundColor = '#C8E6C9';
                            setTimeout(() => {
                                clickedCell.style.backgroundColor = originalBg;
                            }, 200);

                            // Insert cell reference at cursor position
                            const cursorPos = input.selectionStart;
                            const textBefore = input.value.substring(0, cursorPos);
                            const textAfter = input.value.substring(cursorPos);
                            input.value = textBefore + cellRef + textAfter;

                            // Move cursor after inserted reference
                            const newPos = cursorPos + cellRef.length;
                            setTimeout(() => {
                                input.focus();
                                input.setSelectionRange(newPos, newPos);
                                isClickingForReference = false;
                            }, 0);

                            e.stopPropagation();
                        }
                    };
                    document.addEventListener('mousedown', cellClickHandler, true);
                }

                td.textContent = '';
                td.appendChild(input);
                input.focus();
                input.select();
            });

            // Add copy/paste support
            td.addEventListener('copy', function(e) {
                e.preventDefault();
                const formula = td.dataset.formula || td.textContent;
                e.clipboardData.setData('text/plain', formula);
            });

            td.addEventListener('paste', function(e) {
                e.preventDefault();
                const pastedText = e.clipboardData.getData('text/plain');

                if (pastedText.startsWith('=')) {
                    const evaluated = evaluateFormula(pastedText);

                    if (!evaluated.error) {
                        td.textContent = evaluated.value;
                        td.dataset.formula = evaluated.formula;
                        td.style.color = '';
                        if (onchange) onchange(pastedText, evaluated);
                    } else {
                        td.textContent = '#ERROR';
                        td.dataset.formula = evaluated.formula;
                        td.style.color = 'red';
                        if (onchange) onchange(pastedText, evaluated);
                    }
                } else {
                    td.textContent = pastedText;
                    td.dataset.formula = '';
                    td.style.color = '';
                    if (onchange) onchange(pastedText, { isFormula: false, value: parseFloat(pastedText) || 0, formula: null });
                }
            });

            return td;
        }


        // Create calculated (read-only) cell
        function createCalculatedCell(value, decimals = 2) {
            const td = document.createElement('td');
            td.style.cssText = 'border: 1px solid #ddd; padding: 4px; background: #f5f5f5; color: #666; font-weight: 500;';
            const formatted = typeof value === 'number' ? value.toFixed(decimals) : value;
            td.textContent = formatted;
            return td;
        }

        // Create default row
        function createDefaultRow() {
            const projects = labourProjects.map(() => ({
                days: 0,
                daysFormula: null,
                rate: 0,
                rateFormula: null,
                total: 0,
                remaining: 0
            }));
            return {
                month: new Date().toISOString().split('T')[0].substring(0, 7), // YYYY-MM
                staff: '',
                net: 0,
                gross: 0,
                fte: 1.0,
                fteFormula: null,
                yearlyPay: 0,
                yearlyPayFormula: null,
                yearlyAsPaid: 0,
                dailyRate: 0,
                hourlyRate: 0,
                projects: projects
            };
        }

        // Recalculate row
        function recalculateRow(rowIdx) {
            const row = labourRows[rowIdx];

            // Calculate everything from yearlyPay (¬£/yr if full time) and FTE
            if (row.yearlyPay > 0 && row.fte > 0) {
                // Calculate actual paid amount (accounting for FTE)
                row.yearlyAsPaid = row.yearlyPay * row.fte;

                // Calculate monthly gross from yearly as paid
                row.gross = row.yearlyAsPaid / 12;

                // Calculate net (assuming 80% take-home after tax/NI)
                row.net = row.gross * 0.8;

                // Calculate daily rate (based on full-time rate and configurable working days)
                row.dailyRate = row.yearlyPay / workingDaysPerYear;

                // Calculate hourly rate (based on daily rate and configurable hours per day)
                row.hourlyRate = row.dailyRate / hoursPerDay;
            } else {
                // If either is 0, reset calculated fields
                row.yearlyAsPaid = 0;
                row.gross = 0;
                row.net = 0;
                row.dailyRate = 0;
                row.hourlyRate = 0;
            }

            // Calculate project totals
            let runningRemaining = row.gross;
            row.projects.forEach(proj => {
                proj.total = proj.days * proj.rate;
                runningRemaining -= proj.total;
                proj.remaining = runningRemaining;
            });

            renderLabourRows();
            applyMonthStates();
            saveLabourData();
        }

        // Show add line dialog
        function showAddLineDialog() {
            const monthSelect = document.getElementById('addLineMonthSelect');
            monthSelect.innerHTML = '<option value="">-- Select month --</option>';

            // Generate months from 12 months ago to 24 months in the future
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth() - 12, 1);
            const endDate = new Date(today.getFullYear(), today.getMonth() + 24, 1);

            const months = [];
            let current = new Date(startDate);
            while (current <= endDate) {
                const year = current.getFullYear();
                const month = String(current.getMonth() + 1).padStart(2, '0');
                const monthValue = `${year}-${month}`;
                const monthName = current.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                // Check if this month has existing data
                const hasData = labourRows.some(row => row.month === monthValue);
                const displayText = hasData ? `${monthName} (has data)` : monthName;

                months.push({ value: monthValue, text: displayText });
                current.setMonth(current.getMonth() + 1);
            }

            // Populate dropdown
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.text;
                monthSelect.appendChild(option);
            });

            // Set default to current month
            const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            monthSelect.value = currentMonth;

            // Show dialog
            document.getElementById('addLineDialog').style.display = 'flex';
        }

        // Execute add line
        function executeAddLine() {
            const selectedMonth = document.getElementById('addLineMonthSelect').value;

            if (!selectedMonth) {
                alert('Please select a month.');
                return;
            }

            // Create new row with the selected month
            const newRow = createDefaultRow();
            newRow.month = selectedMonth;

            // Find the last index of the selected month
            let insertIndex = labourRows.length; // Default to end
            for (let i = labourRows.length - 1; i >= 0; i--) {
                if (labourRows[i].month === selectedMonth) {
                    insertIndex = i + 1; // Insert after the last occurrence
                    break;
                }
            }

            // If no existing row with this month, find correct chronological position
            if (insertIndex === labourRows.length && labourRows.length > 0) {
                for (let i = 0; i < labourRows.length; i++) {
                    if (labourRows[i].month > selectedMonth) {
                        insertIndex = i;
                        break;
                    }
                }
            }

            // Insert at the calculated position
            labourRows.splice(insertIndex, 0, newRow);

            // Render and save
            renderLabourRows();
            applyMonthStates();
            saveLabourData();

            // Close dialog
            closeAddLineDialog();

            // Show success message
            const [year, monthNum] = selectedMonth.split('-');
            const monthName = new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            alert(`‚úÖ Line added to ${monthName}`);
        }

        // Close add line dialog
        function closeAddLineDialog() {
            document.getElementById('addLineDialog').style.display = 'none';
            document.getElementById('addLineMonthSelect').value = '';
        }

        // Add staff row (legacy function - keeping for backwards compatibility)
        function addStaffRow() {
            showAddLineDialog();
        }

        // Delete row
        function deleteRow(rowIdx) {
            if (confirm('Delete this row?')) {
                labourRows.splice(rowIdx, 1);
                renderLabourRows();
                applyMonthStates();
                saveLabourData();
            }
        }

        // Show copy month dialog
        function showCopyMonthDialog() {
            if (labourRows.length === 0) {
                alert('No data to copy. Please add some rows first.');
                return;
            }

            // Get unique months from the data, sorted
            const uniqueMonths = [...new Set(labourRows.map(row => row.month))].sort();

            if (uniqueMonths.length === 0) {
                alert('No valid month data found.');
                return;
            }

            // Populate the SOURCE month dropdown (only existing months)
            const sourceSelect = document.getElementById('copyMonthSelect');
            sourceSelect.innerHTML = '<option value="">-- Select source month --</option>';

            uniqueMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                const [year, monthNum] = month.split('-');
                const monthName = new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                option.textContent = monthName;
                sourceSelect.appendChild(option);
            });

            // Populate the DESTINATION month dropdown (wide range: 12 months back to 24 months forward)
            const destSelect = document.getElementById('copyToMonthSelect');
            destSelect.innerHTML = '<option value="">-- Select destination month --</option>';

            // Generate months from 12 months ago to 24 months in the future
            const today = new Date();
            const destMonths = [];

            for (let offset = -12; offset <= 24; offset++) {
                const d = new Date(today.getFullYear(), today.getMonth() + offset, 1);
                const monthStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                destMonths.push(monthStr);
            }

            destMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                const [year, monthNum] = month.split('-');
                const monthName = new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                // Mark if month already has data
                const hasData = uniqueMonths.includes(month);
                option.textContent = hasData ? `${monthName} (has data)` : monthName;
                destSelect.appendChild(option);
            });

            // Reset preview
            document.getElementById('copyMonthPreview').style.display = 'none';
            document.getElementById('executeCopyBtn').disabled = true;

            // Show dialog
            document.getElementById('copyMonthDialog').style.display = 'flex';
        }

        // Update preview when either month selector changes
        function updateCopyMonthPreview() {
            const sourceMonth = document.getElementById('copyMonthSelect').value;
            const destMonth = document.getElementById('copyToMonthSelect').value;
            const previewDiv = document.getElementById('copyMonthPreview');
            const previewText = document.getElementById('copyMonthPreviewText');
            const copyBtn = document.getElementById('executeCopyBtn');

            // Need both selections to show preview
            if (!sourceMonth || !destMonth) {
                previewDiv.style.display = 'none';
                copyBtn.disabled = true;
                return;
            }

            // Check if source and destination are the same
            if (sourceMonth === destMonth) {
                previewText.innerHTML = `<span style="color: #dc2626;">‚ö†Ô∏è Source and destination cannot be the same month.</span>`;
                previewDiv.style.display = 'block';
                copyBtn.disabled = true;
                return;
            }

            // Count rows for source month
            const rowsToCopy = labourRows.filter(row => row.month === sourceMonth);
            const rowCount = rowsToCopy.length;

            // Format destination month name
            const [destYear, destMonthNum] = destMonth.split('-');
            const destMonthName = new Date(destYear, destMonthNum - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Check if destination already has data
            const existingRows = labourRows.filter(row => row.month === destMonth);
            const hasExisting = existingRows.length > 0;

            // Determine if copying to past or future
            const sourceDate = new Date(sourceMonth + '-01');
            const destDate = new Date(destMonth + '-01');
            const direction = destDate < sourceDate ? '‚¨ÖÔ∏è (to past)' : destDate > sourceDate ? '‚û°Ô∏è (to future)' : '';

            // Show preview
            let previewHtml = `This will copy <strong>${rowCount} row(s)</strong> to <strong>${destMonthName}</strong> ${direction}`;
            if (hasExisting) {
                previewHtml += `<br><span style="color: #d97706;">‚ö†Ô∏è Note: ${destMonthName} already has ${existingRows.length} row(s). New rows will be added.</span>`;
            }
            previewText.innerHTML = previewHtml;
            previewDiv.style.display = 'block';
            copyBtn.disabled = false;
        }

        // Execute the copy operation
        function executeCopyMonth() {
            const sourceMonth = document.getElementById('copyMonthSelect').value;
            const destMonth = document.getElementById('copyToMonthSelect').value;

            if (!sourceMonth || !destMonth || sourceMonth === destMonth) {
                return;
            }

            // Find all rows from the source month
            const rowsToCopy = labourRows.filter(row => row.month === sourceMonth);

            if (rowsToCopy.length === 0) {
                alert(`No rows found for the selected source month.`);
                return;
            }

            // Create copies of the rows with the new month
            const newRows = rowsToCopy.map(row => {
                // Deep clone the row
                const newRow = JSON.parse(JSON.stringify(row));
                newRow.month = destMonth;
                return newRow;
            });

            // Add the new rows to labourRows
            labourRows.push(...newRows);

            // Sort all rows chronologically by month, then by staff name
            labourRows.sort((a, b) => {
                // First sort by month
                const monthCompare = a.month.localeCompare(b.month);
                if (monthCompare !== 0) return monthCompare;
                // Then by staff name
                return (a.staff || '').localeCompare(b.staff || '');
            });

            // Re-render and save
            renderLabourRows();
            applyMonthStates();
            saveLabourData();

            // Close dialog
            closeCopyMonthDialog();

            // Show success message
            const [destYear, destMonthNum] = destMonth.split('-');
            const destMonthName = new Date(destYear, destMonthNum - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            alert(`‚úÖ Copied ${newRows.length} row(s) to ${destMonthName}. Table has been re-sorted chronologically.`);
        }

        // Close copy month dialog
        function closeCopyMonthDialog() {
            document.getElementById('copyMonthDialog').style.display = 'none';
            document.getElementById('copyMonthSelect').value = '';
            document.getElementById('copyToMonthSelect').value = '';
            document.getElementById('copyMonthPreview').style.display = 'none';
        }

        // ============================================
        // HIDE MONTH FUNCTIONS
        // ============================================

        // Get month states from localStorage
        function getMonthStates() {
            const stored = localStorage.getItem('monthStates');
            return stored ? JSON.parse(stored) : {};
        }

        // Save month states to localStorage
        function saveMonthStates(states) {
            localStorage.setItem('monthStates', JSON.stringify(states));
        }

        // Show hide month dialog
        function showHideMonthDialog() {
            if (labourRows.length === 0) {
                alert('No data found. Please add some rows first.');
                return;
            }

            // Get unique months from the data, sorted
            const uniqueMonths = [...new Set(labourRows.map(row => row.month))].sort();

            if (uniqueMonths.length === 0) {
                alert('No valid month data found.');
                return;
            }

            // Get current month states
            const monthStates = getMonthStates();

            // Build the month list HTML
            const monthList = document.getElementById('hideMonthList');
            monthList.innerHTML = '';

            uniqueMonths.forEach(month => {
                // Format: "2025-09" -> "September 2025"
                const [year, monthNum] = month.split('-');
                const monthName = new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                // Get current state (normal, greyed, hidden)
                const currentState = monthStates[month] || 'normal';

                // Create month row
                const monthRow = document.createElement('div');
                monthRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 10px; background: #f9fafb;';

                // Month name and status
                const monthInfo = document.createElement('div');
                monthInfo.style.cssText = 'flex: 1;';

                const monthTitle = document.createElement('div');
                monthTitle.style.cssText = 'font-weight: 600; color: #1f2937; margin-bottom: 4px;';
                monthTitle.textContent = monthName;

                const statusBadge = document.createElement('div');
                statusBadge.style.cssText = 'font-size: 12px; display: inline-block; padding: 2px 8px; border-radius: 4px;';
                statusBadge.id = `status-${month}`;

                if (currentState === 'greyed') {
                    statusBadge.style.background = '#9ca3af';
                    statusBadge.style.color = 'white';
                    statusBadge.textContent = '‚úì Completed';
                } else if (currentState === 'hidden') {
                    statusBadge.style.background = '#dc2626';
                    statusBadge.style.color = 'white';
                    statusBadge.textContent = 'üëÅÔ∏è Hidden';
                } else {
                    statusBadge.style.background = '#10b981';
                    statusBadge.style.color = 'white';
                    statusBadge.textContent = '‚úì Active';
                }

                monthInfo.appendChild(monthTitle);
                monthInfo.appendChild(statusBadge);

                // Buttons container
                const buttonsDiv = document.createElement('div');
                buttonsDiv.style.cssText = 'display: flex; gap: 8px;';

                // Grey Out button
                const greyBtn = document.createElement('button');
                greyBtn.textContent = currentState === 'greyed' ? 'Undo Grey' : 'Grey Out';
                greyBtn.style.cssText = `padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; background: ${currentState === 'greyed' ? '#10b981' : '#9ca3af'}; color: white;`;
                greyBtn.onclick = () => toggleMonthGrey(month);

                // Hide button
                const hideBtn = document.createElement('button');
                hideBtn.textContent = currentState === 'hidden' ? 'Unhide' : 'Hide';
                hideBtn.style.cssText = `padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; background: ${currentState === 'hidden' ? '#10b981' : '#dc2626'}; color: white;`;
                hideBtn.onclick = () => toggleMonthHide(month);

                buttonsDiv.appendChild(greyBtn);
                buttonsDiv.appendChild(hideBtn);

                monthRow.appendChild(monthInfo);
                monthRow.appendChild(buttonsDiv);

                monthList.appendChild(monthRow);
            });

            // Show dialog
            document.getElementById('hideMonthDialog').style.display = 'flex';
        }

        // Toggle month grey state
        function toggleMonthGrey(month) {
            const monthStates = getMonthStates();
            const currentState = monthStates[month] || 'normal';

            if (currentState === 'greyed') {
                delete monthStates[month];
            } else {
                monthStates[month] = 'greyed';
            }

            saveMonthStates(monthStates);
            applyMonthStates();
            showHideMonthDialog(); // Refresh the dialog
        }

        // Toggle month hide state
        function toggleMonthHide(month) {
            const monthStates = getMonthStates();
            const currentState = monthStates[month] || 'normal';

            if (currentState === 'hidden') {
                delete monthStates[month];
            } else {
                monthStates[month] = 'hidden';
            }

            saveMonthStates(monthStates);
            applyMonthStates();
            showHideMonthDialog(); // Refresh the dialog
        }

        // Apply month states to the table
        function applyMonthStates() {
            const monthStates = getMonthStates();
            const table = document.getElementById('labourTable');
            if (!table) return;

            const tbody = table.querySelector('tbody');
            if (!tbody) return;

            // Get all rows
            const rows = tbody.querySelectorAll('tr');

            rows.forEach(row => {
                const monthCell = row.cells[0];
                if (!monthCell) return;

                const month = monthCell.textContent.trim();
                const state = monthStates[month] || 'normal';

                // Apply state styling
                if (state === 'hidden') {
                    row.style.display = 'none';
                } else if (state === 'greyed') {
                    row.style.display = '';
                    row.style.opacity = '0.4';
                    row.style.background = '#f3f4f6';
                    row.style.pointerEvents = 'none';
                } else {
                    row.style.display = '';
                    row.style.opacity = '';
                    row.style.background = '';
                    row.style.pointerEvents = '';
                }
            });
        }

        // Close hide month dialog
        function closeHideMonthDialog() {
            document.getElementById('hideMonthDialog').style.display = 'none';
        }

        // ============================================
        // END HIDE MONTH FUNCTIONS
        // ============================================

        // ============================================
        // EXPORT DATA FUNCTIONS
        // ============================================

        // Get all unique months from labour data (sorted chronologically)
        function getUniqueMonthsFromRows() {
            const uniqueMonths = [...new Set(labourRows.map(row => row.month))].sort();
            return uniqueMonths;
        }

        // Format month string for display (e.g., "2025-09" -> "September 2025")
        function formatMonthDisplay(monthString) {
            const [year, monthNum] = monthString.split('-');
            return new Date(year, parseInt(monthNum) - 1).toLocaleDateString('en-US', {
                month: 'long',
                year: 'numeric'
            });
        }

        // Filter labour data for export based on selected projects and months
        // Returns: { filteredRows: [...], selectedProjects: [...] }
        function filterLabourDataForExport(selectedProjectIndices, selectedMonths) {
            console.log('[Export] Filtering data...', { selectedProjectIndices, selectedMonths });

            // Filter rows by selected months
            const monthFilteredRows = labourRows.filter(row => selectedMonths.includes(row.month));

            // Further filter: only include staff who have allocations in selected projects
            const filteredRows = monthFilteredRows.filter(row => {
                // Check if this staff member has any non-zero days in selected projects
                return selectedProjectIndices.some(projectIdx => {
                    const project = row.projects[projectIdx];
                    return project && project.days > 0;
                });
            });

            // Get selected project objects
            const selectedProjects = selectedProjectIndices.map(idx => ({
                index: idx,
                name: labourProjects[idx].name,
                color: labourProjects[idx].color
            }));

            console.log('[Export] Filtered:', {
                totalRows: labourRows.length,
                filteredRows: filteredRows.length,
                selectedProjects: selectedProjects.length
            });

            return { filteredRows, selectedProjects };
        }

        // Build table data structure for export
        // Returns: { headers: [...], rows: [[...], [...]] }
        function buildExportTableData(filteredData) {
            const { filteredRows, selectedProjects } = filteredData;

            // Build header row
            const headers = [
                'Month',
                'Staff',
                'Gross (¬£)',
                'FTE',
                '¬£/yr (full time)',
                '¬£/yr (as paid)',
                'Daily Rate (¬£)',
                'Hourly Rate (¬£)'
            ];

            // Add project columns (Days, Rate, Total for each project)
            selectedProjects.forEach(project => {
                headers.push(`${project.name} - Days`);
                headers.push(`${project.name} - Rate (¬£)`);
                headers.push(`${project.name} - Total (¬£)`);
            });

            // Build data rows
            const rows = filteredRows.map(row => {
                const dataRow = [
                    formatMonthDisplay(row.month),
                    row.staff || '',
                    row.gross || 0,
                    row.fte || 0,
                    row.yearlyPay || 0,
                    row.yearlyAsPaid || 0,
                    row.dailyRate || 0,
                    row.hourlyRate || 0
                ];

                // Add project allocation data
                selectedProjects.forEach(project => {
                    const projectData = row.projects[project.index] || {};
                    dataRow.push(projectData.days || 0);
                    dataRow.push(projectData.rate || 0);
                    dataRow.push(projectData.total || 0);
                });

                return dataRow;
            });

            return { headers, rows };
        }

        // ============================================
        // END EXPORT DATA FUNCTIONS (HELPERS)
        // ============================================

        // Show the export data dialog
        function showExportDialog() {
            if (labourRows.length === 0) {
                alert('No labour allocation data to export. Please add some data first.');
                return;
            }

            if (labourProjects.length === 0) {
                alert('No projects found. Please add at least one project first.');
                return;
            }

            const dialog = document.getElementById('exportDataDialog');

            // Populate project list
            const projectList = document.getElementById('exportProjectList');
            projectList.innerHTML = '';

            labourProjects.forEach((project, idx) => {
                const isHidden = hiddenProjects.has(idx);

                const projectDiv = document.createElement('div');
                projectDiv.style.cssText = 'margin-bottom: 8px; padding: 8px; border-radius: 4px; background: white; border: 1px solid #e5e7eb;';

                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; cursor: pointer;';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'export-project-checkbox';
                checkbox.dataset.projectIndex = idx;
                checkbox.checked = false; // Default to unchecked
                checkbox.onchange = updateExportPreview;
                checkbox.style.marginRight = '10px';

                const colorBox = document.createElement('span');
                colorBox.style.cssText = `display: inline-block; width: 16px; height: 16px; background: ${project.color}; border-radius: 3px; margin-right: 8px; border: 1px solid #ddd;`;

                const nameSpan = document.createElement('span');
                nameSpan.textContent = project.name;
                nameSpan.style.cssText = 'font-size: 13px; color: #374151;';

                if (project.grantProjectId) {
                    const linkIcon = document.createElement('span');
                    linkIcon.textContent = ' üîó';
                    linkIcon.style.fontSize = '11px';
                    linkIcon.title = 'Linked to grant';
                    nameSpan.appendChild(linkIcon);
                }

                label.appendChild(checkbox);
                label.appendChild(colorBox);
                label.appendChild(nameSpan);
                projectDiv.appendChild(label);
                projectList.appendChild(projectDiv);
            });

            // Populate month list
            const monthList = document.getElementById('exportMonthList');
            monthList.innerHTML = '';

            const uniqueMonths = getUniqueMonthsFromRows();

            uniqueMonths.forEach(month => {
                const monthDiv = document.createElement('div');
                monthDiv.style.cssText = 'margin-bottom: 8px; padding: 8px; border-radius: 4px; background: white; border: 1px solid #e5e7eb;';

                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; cursor: pointer;';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'export-month-checkbox';
                checkbox.dataset.month = month;
                checkbox.checked = false; // Default to unchecked
                checkbox.onchange = updateExportPreview;
                checkbox.style.marginRight = '10px';

                const nameSpan = document.createElement('span');
                nameSpan.textContent = formatMonthDisplay(month);
                nameSpan.style.cssText = 'font-size: 13px; color: #374151;';

                label.appendChild(checkbox);
                label.appendChild(nameSpan);
                monthDiv.appendChild(label);
                monthList.appendChild(monthDiv);
            });

            // Initialize "Select All" checkboxes
            document.getElementById('selectAllProjects').checked = false;
            document.getElementById('selectAllMonths').checked = false;

            // Show initial preview
            updateExportPreview();

            // Show dialog
            dialog.style.display = 'flex';
        }

        // Close the export dialog
        function closeExportDialog() {
            const dialog = document.getElementById('exportDataDialog');
            dialog.style.display = 'none';
        }

        // Toggle all project checkboxes
        function toggleAllProjects() {
            const selectAll = document.getElementById('selectAllProjects').checked;
            const checkboxes = document.querySelectorAll('.export-project-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
            });
            updateExportPreview();
        }

        // Toggle all month checkboxes
        function toggleAllMonths() {
            const selectAll = document.getElementById('selectAllMonths').checked;
            const checkboxes = document.querySelectorAll('.export-month-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
            });
            updateExportPreview();
        }

        // Update the export preview based on current selections
        function updateExportPreview() {
            // Get selected projects
            const selectedProjectCheckboxes = Array.from(document.querySelectorAll('.export-project-checkbox:checked'));
            const selectedProjectCount = selectedProjectCheckboxes.length;

            // Get selected months
            const selectedMonthCheckboxes = Array.from(document.querySelectorAll('.export-month-checkbox:checked'));
            const selectedMonthCount = selectedMonthCheckboxes.length;

            // Update "Select All" checkboxes
            const totalProjects = document.querySelectorAll('.export-project-checkbox').length;
            const totalMonths = document.querySelectorAll('.export-month-checkbox').length;
            document.getElementById('selectAllProjects').checked = (selectedProjectCount === totalProjects);
            document.getElementById('selectAllMonths').checked = (selectedMonthCount === totalMonths);

            // Calculate filtered data
            if (selectedProjectCount > 0 && selectedMonthCount > 0) {
                const selectedProjectIndices = selectedProjectCheckboxes.map(cb => parseInt(cb.dataset.projectIndex));
                const selectedMonths = selectedMonthCheckboxes.map(cb => cb.dataset.month);

                const { filteredRows } = filterLabourDataForExport(selectedProjectIndices, selectedMonths);

                // Show preview
                const preview = document.getElementById('exportPreview');
                const previewText = document.getElementById('exportPreviewText');
                preview.style.display = 'block';
                previewText.textContent = `${filteredRows.length} staff rows √ó ${selectedProjectCount} projects √ó ${selectedMonthCount} months = ${filteredRows.length * selectedMonthCount} total entries`;

                // Enable export button
                document.getElementById('executeExportBtn').disabled = false;
            } else {
                // Hide preview and disable button
                document.getElementById('exportPreview').style.display = 'none';
                document.getElementById('executeExportBtn').disabled = true;
            }
        }

        // ============================================
        // END EXPORT DIALOG CONTROL FUNCTIONS
        // ============================================

        // Export labour allocation data to Excel (.xlsx)
        function exportToXLSX(tableData, filename) {
            console.log('[Export XLSX] Starting export...', { filename, rows: tableData.rows.length });

            try {
                // Create new workbook
                const wb = XLSX.utils.book_new();

                // Format all numbers in the table data to 2 decimal places
                const formattedRows = tableData.rows.map(row => {
                    return row.map(cell => {
                        if (typeof cell === 'number') {
                            return Number(cell.toFixed(2));
                        }
                        return cell;
                    });
                });

                // Build array of arrays (headers + data rows)
                const aoa = [tableData.headers, ...formattedRows];

                // Convert to worksheet
                const ws = XLSX.utils.aoa_to_sheet(aoa);

                // Set column widths for better readability
                const colWidths = [
                    { wch: 15 },  // Month
                    { wch: 20 },  // Staff
                    { wch: 10 },  // Gross
                    { wch: 8 },   // FTE
                    { wch: 12 },  // ¬£/yr full time
                    { wch: 12 },  // ¬£/yr as paid
                    { wch: 12 },  // Daily Rate
                    { wch: 12 }   // Hourly Rate
                ];

                // Add widths for project columns (Days, Rate, Total for each project)
                const projectCount = (tableData.headers.length - 8) / 3;
                for (let i = 0; i < projectCount; i++) {
                    colWidths.push({ wch: 10 }); // Days
                    colWidths.push({ wch: 10 }); // Rate
                    colWidths.push({ wch: 12 }); // Total
                }

                ws['!cols'] = colWidths;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Labour Allocation');

                // Write workbook to binary string
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });

                // Convert to blob (helper function)
                function s2ab(s) {
                    const buf = new ArrayBuffer(s.length);
                    const view = new Uint8Array(buf);
                    for (let i = 0; i < s.length; i++) {
                        view[i] = s.charCodeAt(i) & 0xFF;
                    }
                    return buf;
                }

                const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });

                // Create download link
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;

                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Cleanup
                setTimeout(() => URL.revokeObjectURL(url), 100);

                console.log('[Export XLSX] Successfully downloaded:', filename);
                showToast('Excel file downloaded successfully', 'success');

            } catch (error) {
                console.error('[Export XLSX] Export failed:', error);
                alert('Failed to export Excel file. See console for details.');
            }
        }

        // ============================================
        // END XLSX EXPORT FUNCTION
        // ============================================

        // Export labour allocation data to PDF (landscape orientation)
        function exportToPDF(tableData, filename, projectNames, selectedMonths) {
            console.log('[Export PDF] Starting export...', { filename, rows: tableData.rows.length });

            try {
                // Initialize jsPDF in landscape mode
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4'); // 'l' = landscape, A4 size (297mm x 210mm)

                // PEBL brand colors
                const peblTeal = [58, 175, 169];
                const peblDarkTeal = [43, 122, 120];

                // Title section
                doc.setFillColor(...peblTeal);
                doc.rect(0, 0, 297, 35, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Labour Allocation Export', 14, 10);

                // Project names
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                const projectText = projectNames.length > 3
                    ? `${projectNames.slice(0, 3).join(', ')} +${projectNames.length - 3} more`
                    : projectNames.join(', ');
                doc.text(projectText, 14, 19);

                // Generated date in smaller text
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                const exportDate = new Date().toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
                doc.text(`Generated on: ${exportDate}`, 14, 25);

                // Format and display months
                const monthsFormatted = selectedMonths.map(m => {
                    const [year, monthNum] = m.split('-');
                    return new Date(year, parseInt(monthNum) - 1).toLocaleDateString('en-US', { month: 'short' });
                });
                const uniqueYears = [...new Set(selectedMonths.map(m => m.split('-')[0]))];
                const monthsText = `${monthsFormatted.join(', ')} ${uniqueYears.join(', ')}`;
                doc.text(monthsText, 14, 30);

                // Calculate appropriate font size based on number of columns
                const columnCount = tableData.headers.length;
                let fontSize = 7;
                if (columnCount > 15) fontSize = 6;
                if (columnCount > 20) fontSize = 5;

                // Format all numbers in the table data to 2 decimal places
                const formattedRows = tableData.rows.map(row => {
                    return row.map(cell => {
                        if (typeof cell === 'number') {
                            return Number(cell.toFixed(2));
                        }
                        return cell;
                    });
                });

                // Generate table using autoTable plugin
                doc.autoTable({
                    startY: 40,
                    head: [tableData.headers],
                    body: formattedRows,
                    theme: 'grid',
                    headStyles: {
                        fillColor: peblTeal,
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: fontSize,
                        halign: 'center',
                        cellPadding: 2
                    },
                    bodyStyles: {
                        fontSize: fontSize - 1,
                        cellPadding: 2
                    },
                    alternateRowStyles: {
                        fillColor: [248, 249, 250]
                    },
                    columnStyles: {
                        0: { cellWidth: 25, halign: 'left' },   // Month
                        1: { cellWidth: 30, halign: 'left' },   // Staff
                        2: { cellWidth: 15, halign: 'right' },  // Gross
                        3: { cellWidth: 12, halign: 'center' }, // FTE
                        4: { cellWidth: 18, halign: 'right' },  // ¬£/yr full time
                        5: { cellWidth: 18, halign: 'right' },  // ¬£/yr as paid
                        6: { cellWidth: 15, halign: 'right' },  // Daily Rate
                        7: { cellWidth: 15, halign: 'right' }   // Hourly Rate
                        // Project columns auto-sized by autoTable
                    },
                    margin: { left: 10, right: 10 },
                    styles: {
                        overflow: 'linebreak',
                        cellWidth: 'wrap'
                    },
                    didDrawPage: function(data) {
                        // Footer with page numbers
                        const pageCount = doc.internal.getNumberOfPages();
                        const currentPage = doc.internal.getCurrentPageInfo().pageNumber;

                        doc.setFontSize(8);
                        doc.setTextColor(150);
                        doc.text(
                            `Page ${currentPage} of ${pageCount}`,
                            doc.internal.pageSize.getWidth() / 2,
                            doc.internal.pageSize.getHeight() - 10,
                            { align: 'center' }
                        );
                    }
                });

                // Save PDF
                doc.save(filename);

                console.log('[Export PDF] Successfully downloaded:', filename);
                showToast('PDF file downloaded successfully', 'success');

            } catch (error) {
                console.error('[Export PDF] Export failed:', error);
                alert('Failed to export PDF file. See console for details.');
            }
        }

        // ============================================
        // END PDF EXPORT FUNCTION
        // ============================================

        // Execute the export operation
        function executeExport() {
            console.log('[Export] Starting export...');

            // Get selected projects
            const selectedProjectCheckboxes = Array.from(document.querySelectorAll('.export-project-checkbox:checked'));
            const selectedProjectIndices = selectedProjectCheckboxes.map(cb => parseInt(cb.dataset.projectIndex));

            // Get selected months
            const selectedMonthCheckboxes = Array.from(document.querySelectorAll('.export-month-checkbox:checked'));
            const selectedMonths = selectedMonthCheckboxes.map(cb => cb.dataset.month);

            // Validation
            if (selectedProjectIndices.length === 0) {
                alert('Please select at least one project to export.');
                return;
            }

            if (selectedMonths.length === 0) {
                alert('Please select at least one month to export.');
                return;
            }

            // Get selected format
            const format = document.querySelector('input[name="exportFormat"]:checked').value;

            // Filter data
            const filteredData = filterLabourDataForExport(selectedProjectIndices, selectedMonths);

            if (filteredData.filteredRows.length === 0) {
                alert('No data matches your selection. Please ensure staff have allocations in the selected months/projects.');
                return;
            }

            // Build table data
            const tableData = buildExportTableData(filteredData);

            // Get project names for PDF header
            const projectNames = selectedProjectIndices.map(idx => labourProjects[idx].name);

            // Generate filename
            const timestamp = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            const filename = `labour_allocation_export_${timestamp}.${format === 'xlsx' ? 'xlsx' : 'pdf'}`;

            // Execute export based on format
            if (format === 'xlsx') {
                exportToXLSX(tableData, filename);
            } else if (format === 'pdf') {
                exportToPDF(tableData, filename, projectNames, selectedMonths);
            }

            // Close dialog
            closeExportDialog();
        }

        // ============================================
        // END EXPORT MAIN EXECUTION FUNCTION
        // ============================================

        // Add project (manual - not linked to grant)
        function addProject() {
            const name = prompt('Enter project name:');
            if (name) {
                const colors = ['#e3f2fd', '#f3e5f5', '#e8f5e9', '#fff3e0', '#fce4ec', '#e0f7fa'];
                const color = colors[labourProjects.length % colors.length];
                const id = Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9); // Generate unique ID

                // Create manual project (no grant link)
                labourProjects.push({
                    id,
                    name,
                    color,
                    grantProjectId: null,
                    grantProjectNumber: null,
                    linkedAt: null
                });

                // Add project to all existing rows
                labourRows.forEach(row => {
                    row.projects.push({ days: 0, daysFormula: null, rate: 0, rateFormula: null, total: 0, remaining: 0 });
                });

                renderLabourTable();
                saveLabourData();
            }
        }

        // Grant Linking Functions
        // ============================================

        let selectedGrantId = null;
        let selectedLabourProjectIdx = null;

        // Show grant link modal
        async function showGrantLinkModal() {
            const modal = document.getElementById('grantLinkModal');
            modal.style.display = 'flex';

            // Reset selections
            selectedGrantId = null;
            selectedLabourProjectIdx = null;

            // Populate both columns
            await populateGrantListColumn();
            populateLabourProjectListColumn();

            updateLinkPreview();
        }

        // Close grant link modal
        function closeGrantLinkModal() {
            const modal = document.getElementById('grantLinkModal');
            modal.style.display = 'none';
            selectedGrantId = null;
            selectedLabourProjectIdx = null;
        }

        // Populate grants column (left side)
        async function populateGrantListColumn() {
            try {
                // Sync grants from Supabase first
                await syncGrantsFromSupabase();

                // Get grants from IndexedDB
                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');

                // Wrap getAll() in a promise
                const allGrants = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                db.close();

                const grantListColumn = document.getElementById('grantListColumn');
                const noGrantsMessage = document.getElementById('noGrantsMessage');

                if (!allGrants || allGrants.length === 0) {
                    grantListColumn.innerHTML = '';
                    noGrantsMessage.style.display = 'block';
                    return;
                }

                noGrantsMessage.style.display = 'none';

                // Sort grants by name
                allGrants.sort((a, b) => (a.projectName || '').localeCompare(b.projectName || ''));

                // Debug: Log all grant IDs and types
                console.log('[GRANT LINK] All grants in database:');
                allGrants.forEach(grant => {
                    console.log('  - ID:', grant.projectId, 'Type:', typeof grant.projectId, 'Name:', grant.projectName);
                });

                // Render grant items with radio buttons
                grantListColumn.innerHTML = allGrants.map((grant, idx) => {
                    const labourBudget = grant.labour?.totalCost || 'N/A';
                    // Store grant reference for later lookup
                    const grantIdAttr = `data-grant-idx="${idx}"`;

                    return `
                        <label style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s;"
                               onmouseover="this.style.background='#eff6ff'"
                               onmouseout="this.style.background='white'">
                            <input type="radio" name="grantSelection" value="${idx}"
                                   onchange="selectGrantByIndex(${idx})"
                                   style="margin-right: 12px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1f2937; font-size: 13px; margin-bottom: 4px;">
                                    ${grant.projectName || 'Untitled Project'}
                                </div>
                                <div style="font-size: 11px; color: #6b7280;">
                                    ${grant.projectNumber || 'No number'} | Labour Budget: ¬£${labourBudget}
                                </div>
                            </div>
                        </label>
                    `;
                }).join('');

                // Store grants list for later reference
                window.cachedGrantsList = allGrants;

            } catch (error) {
                console.error('[GRANT LINK] Failed to populate grants:', error);
                showToast('Failed to load grants', 'error');
            }
        }

        // Populate labour projects column (right side)
        function populateLabourProjectListColumn() {
            const labourProjectListColumn = document.getElementById('labourProjectListColumn');
            const noLabourProjectsMessage = document.getElementById('noLabourProjectsMessage');

            if (!labourProjects || labourProjects.length === 0) {
                labourProjectListColumn.innerHTML = '';
                noLabourProjectsMessage.style.display = 'block';
                return;
            }

            noLabourProjectsMessage.style.display = 'none';

            // Render labour project items with radio buttons
            labourProjectListColumn.innerHTML = labourProjects.map((project, idx) => {
                const isLinked = project.grantProjectId !== null;
                const linkInfo = isLinked ? `üîó Linked to grant ${project.grantProjectNumber || project.grantProjectId}` : 'Not linked';

                return `
                    <label style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s;"
                           onmouseover="this.style.background='#eff6ff'"
                           onmouseout="this.style.background='white'">
                        <input type="radio" name="labourProjectSelection" value="${idx}"
                               onchange="selectLabourProject(${idx})"
                               style="margin-right: 12px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1f2937; font-size: 13px; margin-bottom: 4px;">
                                ${project.name}
                            </div>
                            <div style="font-size: 11px; color: ${isLinked ? '#059669' : '#9ca3af'};">
                                ${linkInfo}
                            </div>
                        </div>
                    </label>
                `;
            }).join('');
        }

        // Select grant by index (from cached list)
        function selectGrantByIndex(idx) {
            if (!window.cachedGrantsList || !window.cachedGrantsList[idx]) {
                console.error('[GRANT LINK] Invalid grant index:', idx);
                return;
            }

            const grant = window.cachedGrantsList[idx];
            selectedGrantId = grant.projectId;
            console.log('[GRANT LINK] Selected grant ID:', selectedGrantId, 'Type:', typeof selectedGrantId, 'Name:', grant.projectName);
            updateLinkPreview();
        }

        // Select labour project (right column)
        function selectLabourProject(projectIdx) {
            selectedLabourProjectIdx = projectIdx;
            updateLinkPreview();
        }

        // Update link preview and enable/disable button
        function updateLinkPreview() {
            const preview = document.getElementById('linkSelectionPreview');
            const linkBtn = document.getElementById('linkSelectedBtn');

            if (selectedGrantId !== null && selectedLabourProjectIdx !== null) {
                // Find grant in cached list
                const grant = window.cachedGrantsList?.find(g => g.projectId === selectedGrantId);
                const labourProject = labourProjects[selectedLabourProjectIdx];

                if (grant) {
                    preview.innerHTML = `
                        <strong style="color: #1f2937;">Ready to link:</strong><br>
                        üìä Grant: <strong>${grant.projectName || 'Unknown'}</strong> (${grant.projectNumber || 'No number'})<br>
                        üìã Labour Project: <strong>${labourProject.name}</strong>
                    `;
                    preview.style.color = '#059669';

                    linkBtn.disabled = false;
                    linkBtn.style.opacity = '1';
                } else {
                    preview.innerHTML = `
                        <strong style="color: #dc2626;">Error:</strong> Grant not found<br>
                        Grant ID: ${selectedGrantId}<br>
                        Labour Project: <strong>${labourProject.name}</strong>
                    `;
                    preview.style.color = '#dc2626';
                    linkBtn.disabled = true;
                    linkBtn.style.opacity = '0.5';
                }
            } else {
                preview.textContent = 'Please select one grant and one labour project';
                preview.style.color = '#6b7280';
                linkBtn.disabled = true;
                linkBtn.style.opacity = '0.5';
            }
        }

        // Link selected grant and labour project
        function linkSelectedGrantAndProject() {
            if (selectedGrantId === null || selectedLabourProjectIdx === null) {
                showToast('Please select both a grant and a labour project', 'warning');
                return;
            }

            try {
                // Find grant in cached list
                const grant = window.cachedGrantsList?.find(g => g.projectId === selectedGrantId);

                if (!grant) {
                    showToast('Grant not found in database', 'error');
                    console.error('[GRANT LINK] Grant not found for ID:', selectedGrantId);
                    return;
                }

                console.log('[GRANT LINK] Linking grant:', grant.projectName, 'ID:', grant.projectId, 'Type:', typeof grant.projectId);

                // Update the labour project with grant link
                const labourProject = labourProjects[selectedLabourProjectIdx];
                labourProject.grantProjectId = grant.projectId;
                labourProject.grantProjectNumber = grant.projectNumber || null;
                labourProject.linkedAt = new Date().toISOString();

                // Update table headers and save
                renderLabourTable();
                saveLabourData();

                closeGrantLinkModal();
                showToast(`‚úÖ Linked "${grant.projectName}" to "${labourProject.name}"`, 'success');
                console.log('[GRANT LINK] Successfully linked:', grant.projectName, '‚Üí', labourProject.name);

            } catch (error) {
                console.error('[GRANT LINK] Failed to link grant:', error);
                showToast('Failed to link grant', 'error');
            }
        }

        // Sync grant names with database (auto-update if grant name changed)
        async function syncGrantNamesWithDatabase() {
            try {
                // Get all grants from IndexedDB
                const db = await openDB('GrantsDB', 2);
                const tx = db.transaction('projects', 'readonly');
                const store = tx.objectStore('projects');

                // Wrap getAll() in a promise
                const allGrants = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                db.close();

                if (!allGrants || allGrants.length === 0) {
                    console.log('[GRANT SYNC] No grants found in database');
                    return;
                }

                // Create a map of grantProjectId -> grant for quick lookup
                const grantsMap = new Map();
                allGrants.forEach(grant => {
                    grantsMap.set(grant.projectId, grant);
                });

                // Check each labour project
                let hasChanges = false;
                labourProjects.forEach(project => {
                    if (project.grantProjectId) {
                        const grant = grantsMap.get(project.grantProjectId);

                        if (!grant) {
                            console.warn('[GRANT SYNC] ‚ö†Ô∏è Grant missing:', project.grantProjectId, '(Project:', project.name + ')');
                            // Don't auto-delete, just log warning
                        } else if (grant.projectName !== project.name) {
                            console.log(`[GRANT SYNC] üîÑ Updating project name: "${project.name}" ‚Üí "${grant.projectName}"`);
                            project.name = grant.projectName;
                            project.grantProjectNumber = grant.projectNumber || null;
                            hasChanges = true;
                        }
                    }
                });

                if (hasChanges) {
                    console.log('[GRANT SYNC] ‚úÖ Grant names synchronized');
                    saveLabourData(); // Auto-save updated names
                }

            } catch (error) {
                console.error('[GRANT SYNC] Failed to sync grant names:', error);
            }
        }

        // Unlink project from grant (convert to manual project)
        function unlinkProjectFromGrant(projIdx) {
            const project = labourProjects[projIdx];

            if (!project.grantProjectId) {
                showToast('This project is not linked to a grant', 'warning');
                return;
            }

            const confirmed = confirm(
                `Unlink "${project.name}" from grant?\n\n` +
                `This will convert it to a manual project.\n` +
                `The project name and allocations will be preserved.`
            );

            if (confirmed) {
                console.log('[GRANT LINK] Unlinking project:', project.name);

                // Remove grant link data
                project.grantProjectId = null;
                project.grantProjectNumber = null;
                project.linkedAt = null;

                renderLabourTable();
                saveLabourData();
                showToast(`‚úÖ "${project.name}" is now a manual project`, 'success');
            }
        }

        // Remove project
        function removeProject(projIdx) {
            if (confirm(`Remove project "${labourProjects[projIdx].name}"?`)) {
                labourProjects.splice(projIdx, 1);

                // Remove project from all rows
                labourRows.forEach(row => {
                    row.projects.splice(projIdx, 1);
                });

                // Update hidden projects set (shift indices)
                const newHidden = new Set();
                hiddenProjects.forEach(idx => {
                    if (idx < projIdx) {
                        newHidden.add(idx);
                    } else if (idx > projIdx) {
                        newHidden.add(idx - 1);
                    }
                });
                hiddenProjects = newHidden;

                renderLabourTable();
                saveLabourData();
            }
        }

        // Configure daily rate calculation (working days per year)
        function configureDailyRate() {
            const newValue = prompt(
                `Configure daily rate calculation:\n\nEnter working days per year (currently: ${workingDaysPerYear}):\n\nNote: Standard UK = 224 days (52 weeks √ó 5 days - 8 bank holidays - 28 days holiday)`,
                workingDaysPerYear
            );

            if (newValue !== null && newValue.trim() !== '') {
                const parsedValue = parseFloat(newValue);
                if (!isNaN(parsedValue) && parsedValue > 0 && parsedValue <= 365) {
                    workingDaysPerYear = parsedValue;

                    // Recalculate all rows
                    labourRows.forEach((row, idx) => recalculateRow(idx));

                    saveLabourData();
                    showToast(`Daily rate now calculated using ${workingDaysPerYear} working days per year`, 'success');
                } else {
                    alert('Please enter a valid number between 1 and 365');
                }
            }
        }

        // Configure hourly rate calculation (hours per day)
        function configureHourlyRate() {
            const newValue = prompt(
                `Configure hourly rate calculation:\n\nEnter hours per working day (currently: ${hoursPerDay}):\n\nNote: Standard = 8 hours per day`,
                hoursPerDay
            );

            if (newValue !== null && newValue.trim() !== '') {
                const parsedValue = parseFloat(newValue);
                if (!isNaN(parsedValue) && parsedValue > 0 && parsedValue <= 24) {
                    hoursPerDay = parsedValue;

                    // Recalculate all rows
                    labourRows.forEach((row, idx) => recalculateRow(idx));

                    saveLabourData();
                    showToast(`Hourly rate now calculated using ${hoursPerDay} hours per day`, 'success');
                } else {
                    alert('Please enter a valid number between 1 and 24');
                }
            }
        }

        // Toggle project visibility
        function toggleProjectVisibility(projIdx) {
            if (hiddenProjects.has(projIdx)) {
                hiddenProjects.delete(projIdx);
            } else {
                hiddenProjects.add(projIdx);
            }

            // Toggle visibility of header cells
            const projectHeaders = document.querySelectorAll(`[data-project-idx="${projIdx}"]`);
            projectHeaders.forEach(cell => {
                if (hiddenProjects.has(projIdx)) {
                    cell.style.display = 'none';
                } else {
                    cell.style.display = '';
                }
            });

            // Update button text/color
            renderProjectHeaders();
            saveLabourData();
        }

        // Show all projects (unhide all minimized projects)
        function showAllProjects() {
            if (hiddenProjects.size === 0) {
                showToast('All projects are already visible', 'info');
                return;
            }

            const hiddenCount = hiddenProjects.size;
            hiddenProjects.clear();

            renderProjectHeaders();
            renderLabourRows();
            applyMonthStates();
            saveLabourData();

            showToast(`Showing all ${hiddenCount} hidden project(s)`, 'success');
        }

        // Save labour data
        async function saveLabourData() {
            const data = {
                projects: labourProjects,
                rows: labourRows,
                hiddenProjects: Array.from(hiddenProjects), // Convert Set to Array for JSON
                staff: staffDatabase,
                workingDaysPerYear: workingDaysPerYear,
                hoursPerDay: hoursPerDay
            };

            // Save to localStorage as fallback
            localStorage.setItem('labour_allocation_data', JSON.stringify(data));
            console.log('‚úÖ Labour data saved to localStorage');

            // Save to Supabase cloud
            try {
                await ensureAuthenticated();

                // Check if user already has a record
                const { data: existing, error: fetchError } = await supabaseClient
                    .from('labour_allocation')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (fetchError && fetchError.code !== 'PGRST116') {
                    throw fetchError;
                }

                if (existing) {
                    // Update existing record
                    const { error: updateError } = await supabaseClient
                        .from('labour_allocation')
                        .update({ allocation_data: data })
                        .eq('user_id', currentUser.id);

                    if (updateError) throw updateError;
                    console.log('‚òÅÔ∏è Labour data updated in Supabase');
                } else {
                    // Insert new record
                    const { error: insertError } = await supabaseClient
                        .from('labour_allocation')
                        .insert({
                            user_id: currentUser.id,
                            allocation_data: data
                        });

                    if (insertError) throw insertError;
                    console.log('‚òÅÔ∏è Labour data saved to Supabase');
                }
            } catch (error) {
                console.error('‚ùå Failed to save to Supabase:', error);
                console.log('‚ö†Ô∏è Data saved to localStorage only');
            }
        }

        // Load labour data
        async function loadLabourData() {
            try {
                // Try to load from Supabase first
                await ensureAuthenticated();

                const { data: supabaseData, error } = await supabaseClient
                    .from('labour_allocation')
                    .select('allocation_data')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                if (supabaseData && supabaseData.allocation_data) {
                    const data = supabaseData.allocation_data;
                    labourProjects = data.projects || [];
                    labourRows = data.rows || [];
                    hiddenProjects = new Set(data.hiddenProjects || []); // Convert Array back to Set
                    staffDatabase = data.staff || staffDatabase;
                    workingDaysPerYear = data.workingDaysPerYear || workingDaysPerYear;
                    hoursPerDay = data.hoursPerDay || hoursPerDay;

                    // Migrate projects to add IDs if needed
                    migrateProjectIds();

                    // Sync grant names with database (auto-update if changed)
                    await syncGrantNamesWithDatabase();

                    // Recalculate all rows to ensure gross and other calculated fields are up-to-date
                    labourRows.forEach((row, idx) => {
                        if (row.yearlyPay > 0 && row.fte > 0) {
                            row.yearlyAsPaid = row.yearlyPay * row.fte;
                            row.gross = row.yearlyAsPaid / 12;
                            row.net = row.gross * 0.8;
                            row.dailyRate = row.yearlyPay / workingDaysPerYear;
                            row.hourlyRate = row.dailyRate / hoursPerDay;

                            // Recalculate project totals and remaining
                            let runningRemaining = row.gross;
                            row.projects.forEach(proj => {
                                proj.total = proj.days * proj.rate;
                                runningRemaining -= proj.total;
                                proj.remaining = runningRemaining;
                            });
                        }
                    });
                    console.log('‚úÖ Recalculated all labour rows');

                    renderLabourTable();
                    populateForecastProjectDropdown(); // Update timesheets forecast dropdown
                    showToast('‚òÅÔ∏è Labour data loaded from cloud', 'success');
                    console.log('‚òÅÔ∏è Labour data loaded from Supabase');
                    return;
                }
            } catch (error) {
                console.error('‚ùå Failed to load from Supabase:', error);
                console.log('‚ö†Ô∏è Trying localStorage fallback...');
            }

            // Fallback to localStorage
            const saved = localStorage.getItem('labour_allocation_data');
            if (saved) {
                const data = JSON.parse(saved);
                labourProjects = data.projects || [];
                labourRows = data.rows || [];
                hiddenProjects = new Set(data.hiddenProjects || []); // Convert Array back to Set
                staffDatabase = data.staff || staffDatabase;
                workingDaysPerYear = data.workingDaysPerYear || workingDaysPerYear;
                hoursPerDay = data.hoursPerDay || hoursPerDay;

                // Migrate projects to add IDs if needed
                migrateProjectIds();

                // Sync grant names with database (auto-update if changed)
                await syncGrantNamesWithDatabase();

                // Recalculate all rows to ensure gross and other calculated fields are up-to-date
                labourRows.forEach((row, idx) => {
                    if (row.yearlyPay > 0 && row.fte > 0) {
                        row.yearlyAsPaid = row.yearlyPay * row.fte;
                        row.gross = row.yearlyAsPaid / 12;
                        row.net = row.gross * 0.8;
                        row.dailyRate = row.yearlyPay / workingDaysPerYear;
                        row.hourlyRate = row.dailyRate / hoursPerDay;

                        // Recalculate project totals and remaining
                        let runningRemaining = row.gross;
                        row.projects.forEach(proj => {
                            proj.total = proj.days * proj.rate;
                            runningRemaining -= proj.total;
                            proj.remaining = runningRemaining;
                        });
                    }
                });
                console.log('‚úÖ Recalculated all labour rows');

                renderLabourTable();
                populateForecastProjectDropdown(); // Update timesheets forecast dropdown
                showToast('Labour data loaded from local storage', 'success');
                console.log('üíæ Labour data loaded from localStorage');
            } else {
                showToast('No saved data found', 'warning');
                console.log('‚ö†Ô∏è No saved data found');
            }
        }

        // Clear labour data
        async function clearLabourData() {
            if (confirm('Clear all labour allocation data? This will delete both local and cloud backups.')) {
                labourProjects = [];
                labourRows = [];
                hiddenProjects = new Set();

                // Clear localStorage
                localStorage.removeItem('labour_allocation_data');

                // Clear Supabase
                try {
                    await ensureAuthenticated();
                    const { error } = await supabaseClient
                        .from('labour_allocation')
                        .delete()
                        .eq('user_id', currentUser.id);

                    if (error) throw error;
                    console.log('‚òÅÔ∏è Labour data deleted from Supabase');
                } catch (error) {
                    console.error('‚ùå Failed to delete from Supabase:', error);
                }

                initLabourAllocation();
                showToast('Data cleared from local and cloud', 'success');
            }
        }

        // Handle paste from Excel
        let selectedCell = null;
        let selectedRowIdx = null;
        let selectedColIdx = null;

        function setupPasteHandler() {
            const table = document.getElementById('labourTable');
            const tbody = document.getElementById('labourTableBody');

            // Track which cell was clicked with visual highlight
            tbody.addEventListener('mousedown', function(e) {
                // Remove previous highlight
                const previousSelected = tbody.querySelector('.paste-selected');
                if (previousSelected) {
                    previousSelected.classList.remove('paste-selected');
                }

                const cell = e.target.closest('td');
                if (cell) {
                    // Don't select the delete button column
                    const cells = Array.from(cell.parentElement.children);
                    const cellIndex = cells.indexOf(cell);

                    // Skip if it's the last column (delete button)
                    if (cellIndex === cells.length - 1) {
                        return;
                    }

                    selectedCell = cell;
                    selectedRowIdx = Array.from(cell.parentElement.parentElement.children).indexOf(cell.parentElement);
                    selectedColIdx = cellIndex;

                    // Visual highlight
                    cell.classList.add('paste-selected');

                    console.log('Selected - Row:', selectedRowIdx, '(data row ' + selectedRowIdx + '), Col:', selectedColIdx);
                    console.log('Total rows in data:', labourRows.length);
                }
            });

            // Handle paste event
            document.addEventListener('paste', function(e) {
                // Only handle if we're in the labour allocation tab
                if (!document.getElementById('allocation-tab').classList.contains('active')) {
                    return;
                }

                // If pasting into an input element, allow default paste behavior
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    console.log('‚úÖ Allowing default paste into input/textarea element');
                    return; // Let the browser handle pasting into the input
                }

                e.preventDefault();

                const pasteData = e.clipboardData.getData('text');
                console.log('üìã RAW CLIPBOARD DATA:', JSON.stringify(pasteData));
                console.log('üìã Clipboard length:', pasteData ? pasteData.length : 0);

                if (!pasteData) {
                    console.log('‚ùå No paste data found in clipboard');
                    return;
                }

                // Parse tab-separated values (Excel format)
                const rows = pasteData.split('\n').filter(row => row.trim() !== '');
                console.log('üìã Parsed rows:', rows.length, ':', rows);

                let startRowIdx = selectedRowIdx !== null ? selectedRowIdx : 0;
                let startColIdx = selectedColIdx !== null ? selectedColIdx : 0;

                console.log('üìç Pasting at row:', startRowIdx, 'col:', startColIdx);

                // Column mapping for editable fields
                const editableColumns = {
                    0: 'month',     // Month
                    1: 'staff',     // Staff
                    3: 'fte',       // FTE (editable)
                    4: 'yearlyPay'  // ¬£/yr (if full time) (editable)
                    // Column 2 is calculated (Gross)
                    // Columns 5-7 are calculated (¬£/yr paid, ¬£/day, ¬£/hr)
                    // Project columns start at index 8
                };

                rows.forEach((row, rowOffset) => {
                    const rowIdx = startRowIdx + rowOffset;

                    console.log('üîÑ Processing paste row', rowOffset, '-> data row', rowIdx);

                    // Add new row if needed
                    while (rowIdx >= labourRows.length) {
                        console.log('‚ûï Creating new row at index', labourRows.length);
                        labourRows.push(createDefaultRow());
                    }

                    const cells = row.split('\t');
                    console.log('üìä Row has', cells.length, 'cells:', cells);

                    cells.forEach((value, colOffset) => {
                        const colIdx = startColIdx + colOffset;

                        // Handle editable columns (Month, Staff, FTE, ¬£/yr if full time)
                        if (editableColumns.hasOwnProperty(colIdx)) {
                            const field = editableColumns[colIdx];
                            console.log(`‚úèÔ∏è Setting row[${rowIdx}].${field} = "${value}" (col ${colIdx})`);

                            if (field === 'month' || field === 'staff') {
                                labourRows[rowIdx][field] = value.trim();
                                console.log(`‚úÖ Set to: "${labourRows[rowIdx][field]}"`);
                            } else if (field === 'fte') {
                                const evaluated = evaluateFormula(value);
                                labourRows[rowIdx].fte = evaluated.value;
                                labourRows[rowIdx].fteFormula = evaluated.formula;
                                console.log(`‚úÖ Set fte = ${evaluated.value} (formula: ${evaluated.formula || 'none'})`);
                            } else if (field === 'yearlyPay') {
                                const evaluated = evaluateFormula(value);
                                labourRows[rowIdx].yearlyPay = evaluated.value;
                                labourRows[rowIdx].yearlyPayFormula = evaluated.formula;
                                console.log(`‚úÖ Set yearlyPay = ${evaluated.value} (formula: ${evaluated.formula || 'none'})`);
                            }
                        }
                        // Skip calculated columns (Gross, etc.)
                        else if (colIdx >= 2 && colIdx <= 7) {
                            console.log(`‚ö†Ô∏è Column ${colIdx} is calculated - skipping`);
                        }
                        // Handle project allocation columns
                        // Column 8+ are project fields (Days, Rate repeating)
                        else if (colIdx >= 8) {
                            const projectColIdx = colIdx - 8; // Offset past the fixed columns (8 total now)
                            const projectIdx = Math.floor(projectColIdx / 4); // Each project has 4 columns
                            const fieldInProject = projectColIdx % 4; // 0=Days, 1=Rate, 2=Total, 3=Remaining

                            console.log(`üéØ Project column detected - col ${colIdx} -> project ${projectIdx}, field ${fieldInProject}`);

                            if (projectIdx < labourProjects.length) {
                                if (!labourRows[rowIdx].projects[projectIdx]) {
                                    labourRows[rowIdx].projects[projectIdx] = { days: 0, daysFormula: null, rate: 0, rateFormula: null, total: 0, remaining: 0 };
                                }

                                if (fieldInProject === 0) { // Days
                                    const evaluated = evaluateFormula(value);
                                    labourRows[rowIdx].projects[projectIdx].days = evaluated.value;
                                    labourRows[rowIdx].projects[projectIdx].daysFormula = evaluated.formula;
                                    console.log(`‚úÖ Set project[${projectIdx}].days = ${evaluated.value} (formula: ${evaluated.formula || 'none'})`);
                                } else if (fieldInProject === 1) { // Rate
                                    const evaluated = evaluateFormula(value);
                                    labourRows[rowIdx].projects[projectIdx].rate = evaluated.value;
                                    labourRows[rowIdx].projects[projectIdx].rateFormula = evaluated.formula;
                                    console.log(`‚úÖ Set project[${projectIdx}].rate = ${evaluated.value} (formula: ${evaluated.formula || 'none'})`);
                                }
                                // Total and Remaining are calculated, skip them
                            } else {
                                console.log(`‚ö†Ô∏è Project index ${projectIdx} out of range (max: ${labourProjects.length - 1})`);
                            }
                        } else {
                            console.log(`‚ö†Ô∏è Column ${colIdx} is in the calculated range (5-8) - skipping`);
                        }
                    });

                    // Recalculate this row
                    console.log(`üî¢ Recalculating row ${rowIdx}`);
                    recalculateRow(rowIdx);
                });

                // Re-render table
                console.log('üé® Re-rendering labour table');
                renderLabourRows();
                applyMonthStates();
                console.log('‚úÖ PASTE COMPLETE');
                showToast(`Pasted ${rows.length} row(s) successfully`, 'success');
            });
        }

        // Initialize labour allocation when switching to that tab
        document.addEventListener('DOMContentLoaded', function() {
            initLabourAllocation();
            setupPasteHandler();
        });


        // IndexedDB helper for folder handles
        function openPayslipDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('PEBLGenDB', 1);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('folderHandles')) {
                        db.createObjectStore('folderHandles', { keyPath: 'id' });
                    }
                };
            });
        }

        // PAYSLIP MERGER FUNCTIONALITY
        let payslipFolderHandle = null;
        let fetchedPayslips = [];

        // Load team members from localStorage or use defaults
        let teamMembers = JSON.parse(localStorage.getItem('payslip_team_members')) || {
            'CW':'Craig Williams',
            'CB':'Christian Berger',
            'JG':'Jack Green',
            'AK':'Anjali Cowan Krishna',
            'HM':'Huw Matthews',
            'DA':'Danielle Zahra Abulhawa'
        };

        let folderNameMap = JSON.parse(localStorage.getItem('payslip_folder_map')) || {
            'CW': ['Craig', 'PEBL Staff - Craig'],
            'CB': ['Christian', 'PEBL Staff - Christian'],
            'JG': ['Jack', 'PEBL Staff - Jack'],
            'AK': ['Anjali', 'PEBL Staff - Anjali'],
            'HM': ['Huw', 'PEBL Staff - Huw'],
            'DA': ['Dani', 'PEBL Staff - Dani']
        };

        const monthNames = {'01':'January','02':'February','03':'March','04':'April','05':'May','06':'June','07':'July','08':'August','09':'September','10':'October','11':'November','12':'December'};

        // Save team members to localStorage
        function savePayslipMembers() {
            localStorage.setItem('payslip_team_members', JSON.stringify(teamMembers));
            localStorage.setItem('payslip_folder_map', JSON.stringify(folderNameMap));
            console.log('Payslip members saved to localStorage');
        }

        // Render the payslip members table
        function renderPayslipMembersTable() {
            const tbody = document.getElementById('payslipMembersTableBody');
            if (!tbody) return;

            let html = '';

            for (const [code, fullName] of Object.entries(teamMembers)) {
                const displayName = code + ' - ' + fullName.split(' ')[0]; // e.g., "CW - Craig"

                html += '<tr>';
                html += `<td style="border: 1px solid #ddd; padding: 4px; font-weight: 500;">${displayName}</td>`;

                // Generate 12 checkboxes for each month
                for (let month = 1; month <= 12; month++) {
                    const monthStr = month.toString().padStart(2, '0');
                    html += `<td style="border: 1px solid #ddd; padding: 4px; text-align: center;">
                        <input type="checkbox" data-member="${code}" data-month="${monthStr}">
                    </td>`;
                }

                html += '</tr>';
            }

            tbody.innerHTML = html;
            console.log('Payslip members table rendered');
        }

        // Add new staff member
        function addPayslipMember() {
            const code = prompt('Enter staff code (e.g., CW, CB):');
            if (!code || code.trim() === '') return;

            const codeUpper = code.trim().toUpperCase();

            // Check if code already exists
            if (teamMembers[codeUpper]) {
                showToast('Staff code already exists', 'error');
                return;
            }

            const fullName = prompt('Enter full name (e.g., Craig Williams):');
            if (!fullName || fullName.trim() === '') return;

            const folderNames = prompt('Enter folder name(s), comma-separated (e.g., Craig, PEBL Staff - Craig):');
            if (!folderNames || folderNames.trim() === '') return;

            // Add to teamMembers
            teamMembers[codeUpper] = fullName.trim();

            // Add to folderNameMap
            folderNameMap[codeUpper] = folderNames.split(',').map(f => f.trim());

            // Save and re-render
            savePayslipMembers();
            renderPayslipMembersTable();

            showToast(`Added ${fullName}`, 'success');
        }

        // Manage (remove) staff members
        function managePayslipMembers() {
            if (Object.keys(teamMembers).length === 0) {
                showToast('No staff members to manage', 'info');
                return;
            }

            let message = 'Current staff members:\n\n';
            for (const [code, name] of Object.entries(teamMembers)) {
                message += `${code} - ${name}\n`;
            }
            message += '\nEnter staff code to REMOVE (or cancel):';

            const codeToRemove = prompt(message);
            if (!codeToRemove || codeToRemove.trim() === '') return;

            const codeUpper = codeToRemove.trim().toUpperCase();

            if (!teamMembers[codeUpper]) {
                showToast('Staff code not found', 'error');
                return;
            }

            const confirmRemove = confirm(`Remove ${teamMembers[codeUpper]}?`);
            if (!confirmRemove) return;

            // Remove from both objects
            delete teamMembers[codeUpper];
            delete folderNameMap[codeUpper];

            // Save and re-render
            savePayslipMembers();
            renderPayslipMembersTable();

            showToast('Staff member removed', 'success');
        }

        async function selectPayslipFolder() {
            console.log("[Payslip] selectPayslipFolder called");
            if (!('showDirectoryPicker' in window)) {
                showToast('Use Chrome or Edge', 'error');
                return;
            }
            try {
                const dirHandle = await window.showDirectoryPicker({mode: 'read'});
                console.log("[Payslip] Folder selected:", dirHandle.name);
                payslipFolderHandle = dirHandle;
                const db = await openPayslipDB();
                const tx = db.transaction(['folderHandles'], 'readwrite');
                tx.objectStore('folderHandles').put({id: 'payslipFolder', handle: dirHandle});
                updatePayslipFolderStatus(dirHandle.name);
                document.getElementById('fetchPayslipsBtn').disabled = false;
                showToast('Folder set', 'success');
            } catch (e) {
                if (e.name !== 'AbortError') { console.error('[Payslip] Error:', e.name, e.message, e.stack); showToast('Error selecting folder: ' + e.message, 'error'); }
            }
        }

        async function loadPayslipFolder() {
            console.log("[Payslip] loadPayslipFolder called");
            if (!('showDirectoryPicker' in window)) return;
            try {
                const db = await openPayslipDB();
                const tx = db.transaction(['folderHandles'], 'readonly');
                const request = tx.objectStore('folderHandles').get('payslipFolder');
                request.onsuccess = async () => {
                    if (request.result) {
                        payslipFolderHandle = request.result.handle;
                        const perm = await payslipFolderHandle.queryPermission({mode: 'read'});
                        if (perm === 'granted') {
                            updatePayslipFolderStatus(payslipFolderHandle.name);
                            document.getElementById('fetchPayslipsBtn').disabled = false;
                        }
                    }
                };
            } catch (e) {}
        }

        function updatePayslipFolderStatus(name) {
            const status = document.getElementById('payslipFolderStatus');
            if (status) {
                status.textContent = '‚úì ' + name;
                status.style.color = '#4caf50';
            }
        }

        async function fetchPayslips() {
            console.log("[Payslip] fetchPayslips called");
            if (!payslipFolderHandle) {
                showToast('Select folder first', 'error');
                return;
            }

            const memberMonths = {};
            for (const code in teamMembers) {
                const checkboxes = document.querySelectorAll('input[type="checkbox"][data-member="' + code + '"]:checked');
                if (checkboxes.length > 0) {
                    memberMonths[code] = Array.from(checkboxes).map(cb => cb.getAttribute('data-month'));
                }
            }

            if (Object.keys(memberMonths).length === 0) {
                showToast('Select at least one month for a member', 'error');
                return;
            }

            const year = document.getElementById('payslipYear').value;
            showToast('Searching subfolders...', 'info');
            fetchedPayslips = [];

            try {
                const perm = await payslipFolderHandle.queryPermission({mode: 'read'});
                if (perm !== 'granted') await payslipFolderHandle.requestPermission({mode: 'read'});

                console.log("[Payslip] Scanning subfolders in:", payslipFolderHandle.name);
                for await (const entry of payslipFolderHandle.values()) {
                    if (entry.kind === 'directory') {
                        console.log('[Payslip] Found subfolder:', entry.name);
                        const memberCode = matchFolderToMember(entry.name);
                        console.log("[Payslip] Match result for", entry.name, "->", memberCode);
                        if (memberCode && memberMonths[memberCode]) {
                            await searchSubfolderForPayslips(entry, memberCode, memberMonths[memberCode], year);
                        }
                    }
                }

                displayFetchedPayslips();

                if (fetchedPayslips.length > 0) {
                    showToast('Fetched ' + fetchedPayslips.length + ' payslips', 'success');
                    document.getElementById('mergePayslipsBtn').style.display = 'inline-block';
                    document.getElementById('payslipCount').textContent = fetchedPayslips.length + ' payslips found';
                } else {
                    showToast('No payslips found', 'warning');
                    document.getElementById('payslipCount').textContent = 'No payslips found';
                }
            } catch (e) {
                console.error('[Payslip] Error in fetchPayslips:', e);
                console.error('[Payslip] Error name:', e.name);
                console.error('[Payslip] Error message:', e.message);
                console.error('[Payslip] Stack:', e.stack);
                showToast('Error fetching: ' + e.message, 'error');
            }
        }

        function matchFolderToMember(folderName) {
            for (const code in folderNameMap) {
                const patterns = folderNameMap[code];
                for (const pattern of patterns) {
                    if (folderName.toLowerCase().includes(pattern.toLowerCase())) {
                        return code;
                    }
                }
            }
            return null;
        }

        async function searchSubfolderForPayslips(folderHandle, memberCode, months, year) {
            try {
                for await (const entry of folderHandle.values()) {
                    if (entry.kind === 'file' && entry.name.endsWith('.pdf')) {
                            console.log('[Payslip] Found PDF:', entry.name);
                        const match = matchPayslipFile(entry.name, memberCode, months, year);
                            console.log("[Payslip] Match result:", match ? "YES" : "NO");
                        if (match) {
                            const file = await entry.getFile();
                            fetchedPayslips.push({
                                name: entry.name,
                                file: file,
                                memberCode: match.memberCode,
                                memberName: match.memberName,
                                month: match.month,
                                year: match.year,
                                folderName: folderHandle.name
                            });
                        }
                    }
                }
            } catch (e) {
                console.error('Error searching subfolder:', folderHandle.name, e);
            }
        }

        function matchPayslipFile(filename, memberCode, months, year) {
            const memberName = teamMembers[memberCode];
            for (const month of months) {
                const lastDay = new Date(parseInt(year), parseInt(month), 0).getDate();
                const dateStr = lastDay.toString().padStart(2, '0') + '-' + month + '-' + year;
                const pattern = 'Payslip - ' + memberName + ' - Month Ending ' + dateStr;
                if (filename.includes(pattern)) {
                    return {memberCode, memberName, month, year};
                }
            }
            return null;
        }

        function displayFetchedPayslips() {
            const display = document.getElementById('fetchedPayslipsDisplay');
            const list = document.getElementById('fetchedPayslipsList');

            if (fetchedPayslips.length === 0) {
                display.style.display = 'none';
                return;
            }

            display.style.display = 'block';
            fetchedPayslips.sort((a, b) => {
                if (a.memberCode !== b.memberCode) return a.memberCode.localeCompare(b.memberCode);
                return a.month.localeCompare(b.month);
            });

            let html = '<table style="border-collapse:collapse;width:100%;"><thead><tr>';
            html += '<th style="border:1px solid #ddd;padding:4px;background:#4caf50;color:white;">Member</th>';
            html += '<th style="border:1px solid #ddd;padding:4px;background:#4caf50;color:white;">Month</th>';
            html += '<th style="border:1px solid #ddd;padding:4px;background:#4caf50;color:white;">Folder</th>';
            html += '<th style="border:1px solid #ddd;padding:4px;background:#4caf50;color:white;">Filename</th>';
            html += '</tr></thead><tbody>';

            fetchedPayslips.forEach(p => {
                html += '<tr>';
                html += '<td style="border:1px solid #ddd;padding:4px;">' + p.memberCode + '</td>';
                html += '<td style="border:1px solid #ddd;padding:4px;">' + monthNames[p.month] + ' ' + p.year + '</td>';
                html += '<td style="border:1px solid #ddd;padding:4px;">' + p.folderName + '</td>';
                html += '<td style="border:1px solid #ddd;padding:4px;font-size:10px;">' + p.name + '</td>';
                html += '</tr>';
            });

            html += '</tbody></table>';
            list.innerHTML = html;
        }

        async function mergePayslips() {
            if (fetchedPayslips.length === 0) {
                showToast('No payslips to merge', 'error');
                return;
            }

            showToast('Merging PDFs...', 'info');

            try {
                const PDFDocument = PDFLib.PDFDocument;
                const mergedPdf = await PDFDocument.create();

                for (const ps of fetchedPayslips) {
                    const arrayBuffer = await ps.file.arrayBuffer();
                    const pdf = await PDFDocument.load(arrayBuffer);
                    const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                    copiedPages.forEach(page => mergedPdf.addPage(page));
                }

                const mergedPdfBytes = await mergedPdf.save();
                const blob = new Blob([mergedPdfBytes], {type: 'application/pdf'});
                const url = URL.createObjectURL(blob);
                const year = document.getElementById('payslipYear').value;
                const filename = 'Merged_Payslips_' + year + '_' + new Date().toISOString().split('T')[0] + '.pdf';

                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(url);

                showToast('PDF downloaded: ' + filename, 'success');
            } catch (e) {
                console.error(e);
                showToast('Error merging PDFs: ' + e.message, 'error');
            }
        }


    </script>

    <!-- Split Screen Overlay -->
    <div id="splitScreenOverlay" class="split-screen-overlay">
        <div class="split-screen-header">
            <h2>Split Screen Mode</h2>
            <div class="split-screen-controls">
                <div class="split-pane-selector">
                    <label>Left:</label>
                    <select id="splitLeftPage" onchange="loadSplitPane('left', this.value)">
                        <option value="grants.html">Grants</option>
                        <option value="spend.html">Spend</option>
                        <option value="gantt.html">Gantt</option>
                        <option value="timesheet.html" selected>Labour</option>
                        <option value="index.html">Sketcher</option>
                        <option value="exploit.html">Exploit</option>
                        <option value="risks.html">Risks</option>
                        <option value="quote.html">Quote</option>
                    </select>
                </div>
                <div class="split-pane-selector">
                    <label>Right:</label>
                    <select id="splitRightPage" onchange="loadSplitPane('right', this.value)">
                        <option value="grants.html" selected>Grants</option>
                        <option value="spend.html">Spend</option>
                        <option value="gantt.html">Gantt</option>
                        <option value="timesheet.html">Labour</option>
                        <option value="index.html">Sketcher</option>
                        <option value="exploit.html">Exploit</option>
                        <option value="risks.html">Risks</option>
                        <option value="quote.html">Quote</option>
                    </select>
                </div>
                <button class="split-orientation-btn" onclick="toggleSplitOrientation()" title="Toggle horizontal/vertical split">
                    ‚áÑ Toggle Layout
                </button>
                <button class="split-orientation-btn" onclick="refreshSplitPanes()" title="Refresh both panes">
                    ‚Üª Refresh
                </button>
            </div>
            <button class="split-screen-close" onclick="closeSplitScreenMode()">‚úï Close Split View</button>
        </div>
        <div id="splitScreenContainer" class="split-screen-container">
            <div class="split-pane" id="splitPaneLeft">
                <div class="split-pane-header">
                    <span id="splitLeftTitle">Labour</span>
                    <button onclick="loadSplitPane('left', document.getElementById('splitLeftPage').value)" style="background: #3b82f6; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">‚Üª</button>
                </div>
                <div class="split-pane-content">
                    <iframe id="splitLeftFrame" src="about:blank"></iframe>
                </div>
            </div>
            <div class="split-divider" id="splitDivider"></div>
            <div class="split-pane" id="splitPaneRight">
                <div class="split-pane-header">
                    <span id="splitRightTitle">Grants</span>
                    <button onclick="loadSplitPane('right', document.getElementById('splitRightPage').value)" style="background: #3b82f6; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">‚Üª</button>
                </div>
                <div class="split-pane-content">
                    <iframe id="splitRightFrame" src="about:blank"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Split Screen Mode Functions
        const pageNames = {
            'grants.html': 'Grants',
            'spend.html': 'Spend',
            'gantt.html': 'Gantt',
            'timesheet.html': 'Labour',
            'index.html': 'Sketcher',
            'exploit.html': 'Exploit',
            'risks.html': 'Risks',
            'quote.html': 'Quote'
        };

        function openSplitScreenMode() {
            const overlay = document.getElementById('splitScreenOverlay');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Load default pages
            loadSplitPane('left', document.getElementById('splitLeftPage').value);
            loadSplitPane('right', document.getElementById('splitRightPage').value);

            // Initialize divider drag functionality
            initSplitDivider();

            showToast('Split Screen Mode activated', 'info');
        }

        function closeSplitScreenMode() {
            const overlay = document.getElementById('splitScreenOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';

            // Clear iframes to free memory
            document.getElementById('splitLeftFrame').src = 'about:blank';
            document.getElementById('splitRightFrame').src = 'about:blank';

            showToast('Split Screen Mode closed', 'info');
        }

        function loadSplitPane(pane, page) {
            const frameId = pane === 'left' ? 'splitLeftFrame' : 'splitRightFrame';
            const titleId = pane === 'left' ? 'splitLeftTitle' : 'splitRightTitle';
            const frame = document.getElementById(frameId);
            const title = document.getElementById(titleId);

            // Add splitMode parameter to URL so pages know they're in split mode
            const url = page + (page.includes('?') ? '&' : '?') + 'splitMode=true';
            frame.src = url;
            title.textContent = pageNames[page] || page;
        }

        function toggleSplitOrientation() {
            const container = document.getElementById('splitScreenContainer');
            container.classList.toggle('vertical');
            showToast(container.classList.contains('vertical') ? 'Vertical layout' : 'Horizontal layout', 'info');
        }

        function refreshSplitPanes() {
            loadSplitPane('left', document.getElementById('splitLeftPage').value);
            loadSplitPane('right', document.getElementById('splitRightPage').value);
            showToast('Both panes refreshed', 'info');
        }

        function initSplitDivider() {
            const divider = document.getElementById('splitDivider');
            const container = document.getElementById('splitScreenContainer');
            const leftPane = document.getElementById('splitPaneLeft');
            const rightPane = document.getElementById('splitPaneRight');

            let isDragging = false;

            divider.addEventListener('mousedown', (e) => {
                isDragging = true;
                document.body.style.cursor = container.classList.contains('vertical') ? 'row-resize' : 'col-resize';
                document.body.style.userSelect = 'none';

                // Disable pointer events on iframes during drag
                document.getElementById('splitLeftFrame').style.pointerEvents = 'none';
                document.getElementById('splitRightFrame').style.pointerEvents = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const containerRect = container.getBoundingClientRect();
                const isVertical = container.classList.contains('vertical');

                if (isVertical) {
                    const percentage = ((e.clientY - containerRect.top) / containerRect.height) * 100;
                    const clampedPercentage = Math.max(20, Math.min(80, percentage));
                    leftPane.style.flex = `0 0 ${clampedPercentage}%`;
                    rightPane.style.flex = `0 0 ${100 - clampedPercentage - 1}%`;
                } else {
                    const percentage = ((e.clientX - containerRect.left) / containerRect.width) * 100;
                    const clampedPercentage = Math.max(20, Math.min(80, percentage));
                    leftPane.style.flex = `0 0 ${clampedPercentage}%`;
                    rightPane.style.flex = `0 0 ${100 - clampedPercentage - 1}%`;
                }
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';

                    // Re-enable pointer events on iframes
                    document.getElementById('splitLeftFrame').style.pointerEvents = '';
                    document.getElementById('splitRightFrame').style.pointerEvents = '';
                }
            });
        }

        // Listen for Escape key to close split screen
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const overlay = document.getElementById('splitScreenOverlay');
                if (overlay.classList.contains('active')) {
                    closeSplitScreenMode();
                }
            }
        });
    </script>
</body>
</html>
